(function(){"use strict";var F;const i={SCRAPE_CREATORS_API_KEY:"scrapeCreatorsApiKey",OPENROUTER_API_KEY:"openRouterApiKey",SUMMARIZER_RECOMMENDED_MODEL:"summarizerRecommendedModel",SUMMARIZER_CUSTOM_MODEL:"summarizerCustomModel",REFINER_RECOMMENDED_MODEL:"refinerRecommendedModel",REFINER_CUSTOM_MODEL:"refinerCustomModel",AUTO_GENERATE:"autoGenerate",SHOW_SUBTITLES:"showSubtitles",CAPTION_FONT_SIZE:"captionFontSize",ANALYSIS_FONT_SIZE:"analysisFontSize",TARGET_LANGUAGE_RECOMMENDED:"targetLanguageRecommended",TARGET_LANGUAGE_CUSTOM:"targetLanguageCustom",FAST_MODE:"fastMode",QUALITY_MODEL:"qualityModel"},g={AUTO_GENERATION_DELAY_MS:2e3,INIT_RETRY_DELAY_MS:500,SUBTITLE_UPDATE_INTERVAL_MS:100,MAX_INIT_ATTEMPTS:5,CONTENT_SCRIPT_INIT_DELAY_MS:500},x={CLEANUP_BATCH_SIZE:10},k=[{value:"google/gemini-3-flash-preview",label:"Gemini 3 Flash"},{value:"google/gemini-3-pro-preview",label:"Gemini 3 Pro"},{value:"openai/gpt-5-mini",label:"GPT-5 Mini"},{value:"openai/gpt-5.2",label:"GPT-5.2"},{value:"x-ai/grok-4.1-fast",label:"Grok 4.1 Fast"}],V=[{value:"google/gemini-2.5-flash-lite-preview-09-2025",label:"Gemini 2.5 Flash Lite"},{value:"x-ai/grok-4.1-fast",label:"Grok 4.1 Fast"}],_={MODEL_SUMMARIZER:k[0].value,MODEL_REFINER:V[0].value,AUTO_GENERATE:!1,SHOW_SUBTITLES:!0,CAPTION_FONT_SIZE:"M",ANALYSIS_FONT_SIZE:"M",TARGET_LANGUAGE_RECOMMENDED:"auto",TARGET_LANGUAGE_CUSTOM:""},D={CAPTION:{S:{base:"1.4vw",max:"22px",min:"12px",fullscreen:"1.7vw",fullscreenMax:"28px"},M:{base:"1.8vw",max:"28px",min:"14px",fullscreen:"2.2vw",fullscreenMax:"36px"},L:{base:"2.2vw",max:"34px",min:"16px",fullscreen:"2.7vw",fullscreenMax:"44px"}}},p={VIDEO_ID_LENGTH:11,SELECTORS:{VIDEO_PLAYER:"video.html5-main-video",MOVIE_PLAYER:"#movie_player",VIDEO_CONTAINER:".html5-video-container"}},c={SCRAPE_VIDEO:"scrapeVideo",FETCH_SUBTITLES:"fetchSubtitles",GENERATE_SUBTITLES:"generateSubtitles",GENERATE_SUMMARY:"generateSummary",SUBTITLES_GENERATED:"subtitlesGenerated",TOGGLE_SUBTITLES:"toggleSubtitles",GET_VIDEO_TITLE:"getVideoTitle",UPDATE_CAPTION_FONT_SIZE:"updateCaptionFontSize"},m={SUBTITLE_CONTAINER:"youtube-gemini-subtitles-container",SUBTITLE_TEXT:"youtube-gemini-subtitles-text"},B={MIN_VIDEOS_TO_KEEP:5};function d(e){if(!e)return null;try{const t=new URL(e),n=t.hostname.replace(/^www\./,"");if(n.includes("youtube.com")){const o=t.searchParams.get("v");if(o)return o}if(n==="youtu.be"){const o=t.pathname.replace(/^\//,"");if(o)return o}}catch{const n=e.match(/(?:v=|youtu\.be\/)([\w-]+)/);if(n&&n[1])return n[1]}return null}const M=new Set;function O(){var e;try{return!!((e=chrome.runtime)!=null&&e.id)}catch{return!1}}function Y(e){return M.has(e)}function z(e){M.add(e)}function S(e){M.delete(e)}function K(e,t,n,o){return t[i.AUTO_GENERATE]!==!0?(console.log("Auto-gen skipped: setting disabled"),{isValid:!1,reason:"setting disabled"}):o&&!n?(console.log("Auto-gen skipped: captions disabled"),{isValid:!1,reason:"captions disabled"}):t[i.SCRAPE_CREATORS_API_KEY]?Y(e)?(console.log("Auto-gen skipped: already triggered for video",e),{isValid:!1,reason:"already triggered"}):{isValid:!0}:(console.log("Auto-gen skipped: missing Scrape Creators key"),{isValid:!1,reason:"missing api key"})}function Z(e){const t=d(window.location.href);return t!==e?(console.log("Auto-gen cancel: video ID changed",e,"->",t),S(e),!1):!0}function H(e){return new Promise(t=>{chrome.storage.local.get([i.SHOW_SUBTITLES],n=>{n[i.SHOW_SUBTITLES]!==!1?t(!0):(console.log("Auto-gen cancel: captions disabled"),S(e),t(!1))})})}async function q(e,t,n){Z(e)&&(n&&!await H(e)||t())}function W(e,t,n,o){z(e),console.log("Auto-gen enabled,",o?"waiting for page to load...":"triggering immediately...","videoId:",e);const r=()=>{q(e,t,n)};o?setTimeout(()=>{if(!O()){console.log("Context invalidated before auto-generation, aborting."),S(e);return}console.log("Auto-gen delay elapsed; triggering now for",e),r()},g.AUTO_GENERATION_DELAY_MS):r()}async function A(e,t){return new Promise((n,o)=>{chrome.runtime.sendMessage(e,r=>{chrome.runtime.lastError?o(new Error(chrome.runtime.lastError.message)):n(r)})})}function $(){if(!window.location.href.includes("youtube.com/watch"))return console.log("Not on a video page, skipping subtitle load."),{isValid:!1};const e=d(window.location.href);return e?{isValid:!0,videoId:e}:(console.warn("Could not extract video ID, skipping subtitle load."),{isValid:!1})}function j(){return[i.AUTO_GENERATE,i.SCRAPE_CREATORS_API_KEY,i.OPENROUTER_API_KEY,i.REFINER_RECOMMENDED_MODEL,i.REFINER_CUSTOM_MODEL,i.SUMMARIZER_RECOMMENDED_MODEL,i.SUMMARIZER_CUSTOM_MODEL,i.TARGET_LANGUAGE_RECOMMENDED,i.TARGET_LANGUAGE_CUSTOM,i.SHOW_SUBTITLES,i.FAST_MODE,i.QUALITY_MODEL]}function X(e){return e[i.REFINER_CUSTOM_MODEL]||e[i.REFINER_RECOMMENDED_MODEL]||_.MODEL_REFINER}function Q(e){const t=e[i.SUMMARIZER_CUSTOM_MODEL]||e[i.SUMMARIZER_RECOMMENDED_MODEL]||_.MODEL_SUMMARIZER;return{summarizerModel:t,qualityModel:e[i.QUALITY_MODEL]||t,targetLanguage:e[i.TARGET_LANGUAGE_CUSTOM]||e[i.TARGET_LANGUAGE_RECOMMENDED]||_.TARGET_LANGUAGE_RECOMMENDED,fastMode:e[i.FAST_MODE]===!0}}async function J(e,t){return console.log(`[Auto-gen] Step 1: Scraping video data for ${e}...`),(await A({action:c.SCRAPE_VIDEO,videoId:e,scrapeCreatorsApiKey:t}).catch(()=>({status:"error",hasTranscript:void 0}))).status!=="success"?(console.error(`[Auto-gen] Scrape failed for ${e}`),!1):(console.log("[Auto-gen] Step 2: Scrape complete. Starting refine + summarize..."),!0)}function ee(e,t,n,o,r){A({action:c.FETCH_SUBTITLES,videoId:e,scrapeCreatorsApiKey:t,openRouterApiKey:n,modelSelection:o}).then(s=>console.log("[Auto-gen] Subtitle refinement triggered:",s)).catch(s=>{console.error("Error triggering subtitle auto-gen:",s.message),r==null||r(e)})}function te(e,t,n,o){A({action:c.GENERATE_SUMMARY,videoId:e,scrapeCreatorsApiKey:t,openRouterApiKey:n,modelSelection:o.summarizerModel,qualityModel:o.qualityModel,targetLanguage:o.targetLanguage,fastMode:o.fastMode}).then(r=>console.log("[Auto-gen] Summary generation triggered:",r)).catch(r=>console.error("Error triggering summary auto-gen:",r.message))}function ne(e){const t=Object.prototype.hasOwnProperty.call(e,"showSubtitles"),n=Object.prototype.hasOwnProperty.call(e,"enabled");return t?e.showSubtitles!==!1:n?e.enabled!==!1:!0}function oe(){return[i.AUTO_GENERATE,i.SCRAPE_CREATORS_API_KEY,i.OPENROUTER_API_KEY,i.REFINER_RECOMMENDED_MODEL,i.REFINER_CUSTOM_MODEL]}const re={subtitles:e=>e,metadata:e=>`video_info_${e}`,analysis:e=>`analysis_${e}`},h=typeof chrome<"u"&&!!((F=chrome.storage)!=null&&F.local);async function G(e){if(!h){for(const[t,n]of Object.entries(e))localStorage.setItem(t,JSON.stringify(n));return}return new Promise((t,n)=>{chrome.storage.local.set(e,()=>{chrome.runtime.lastError?n(new Error(chrome.runtime.lastError.message)):t()})})}async function ie(e){if(!h){for(const t of e)localStorage.removeItem(t);return}return new Promise((t,n)=>{chrome.storage.local.remove(e,()=>{chrome.runtime.lastError?n(new Error(chrome.runtime.lastError.message)):t()})})}async function le(){if(!h){const e={};for(let t=0;t<localStorage.length;t++){const n=localStorage.key(t);if(n){const o=localStorage.getItem(n);o&&(e[n]=JSON.parse(o))}}return e}return new Promise((e,t)=>{chrome.storage.local.get(null,n=>{chrome.runtime.lastError?t(new Error(chrome.runtime.lastError.message)):e(n)})})}async function ae(e,t){var o;const n=re.subtitles(e);try{await G({[n]:t}),console.log(`Subtitles saved for video: ${e}`)}catch(r){if(r instanceof Error&&((o=r.message)!=null&&o.includes("QUOTA")))console.warn("Storage quota exceeded, cleaning up..."),await ce(x.CLEANUP_BATCH_SIZE),await G({[n]:t}),console.log(`Subtitles saved after cleanup: ${e}`);else throw r}}async function se(e){const t=[];for(const n of Object.keys(e))(n.length===p.VIDEO_ID_LENGTH&&Array.isArray(e[n])||n.startsWith("video_info_")||n.startsWith("analysis_"))&&t.push(n);return t}async function ce(e){const t=await le(),n=await se(t);if(n.length===0){console.log("No video data to clean up");return}const o=n.length<=e?Math.max(1,n.length-B.MIN_VIDEOS_TO_KEEP):e,r=n.slice(0,o);await ie(r),console.log(`Cleaned up ${r.length} video data entries`)}let l=null,u=null,a=null,T=null,I=null;function ue(){return a=document.querySelector(p.SELECTORS.VIDEO_PLAYER),a?(T=document.querySelector(p.SELECTORS.MOVIE_PLAYER)||document.querySelector(p.SELECTORS.VIDEO_CONTAINER)||a.parentElement,!!T):!1}function Ee(){if(document.getElementById(m.SUBTITLE_CONTAINER)){l=document.getElementById(m.SUBTITLE_CONTAINER),u=document.getElementById(m.SUBTITLE_TEXT);return}l=document.createElement("div"),l.id=m.SUBTITLE_CONTAINER,l.style.position="absolute",l.style.zIndex="9999",l.style.pointerEvents="none",l.style.display="none",u=document.createElement("div"),u.id=m.SUBTITLE_TEXT,l.appendChild(u),T?(getComputedStyle(T).position==="static"&&(T.style.position="relative"),T.appendChild(l),console.log("Subtitle container added to video container.")):console.error("Cannot add subtitle container, video container not found.")}function v(e){const t=D.CAPTION[e]||D.CAPTION.M;document.documentElement.style.setProperty("--caption-font-size-base",t.base),document.documentElement.style.setProperty("--caption-font-size-max",t.max),document.documentElement.style.setProperty("--caption-font-size-min",t.min),document.documentElement.style.setProperty("--caption-font-size-fullscreen",t.fullscreen),document.documentElement.style.setProperty("--caption-font-size-fullscreen-max",t.fullscreenMax),u&&(u.style.fontSize=`clamp(${t.min}, ${t.base}, ${t.max})`)}function de(e,t){let n=0,o=e.length-1;for(;n<=o;){const r=Math.floor((n+o)/2),s=e[r];if(t>=s.startTime&&t<s.endTime)return s;t<s.startTime?o=r-1:n=r+1}return null}function Se(e){if(!a||!u||!l||isNaN(a.currentTime))return;const t=a.currentTime*1e3,n=de(e,t);if(n){const o=(n.text||"").replace(/\r\n?/g,`
`).replace(/\n{2,}/g,`
`).trim();if(!o){y();return}u.textContent!==o&&(u.textContent=o),l.style.display="block"}else y()}function b(e){if(!a||!l){console.warn("Cannot start subtitle display: Player or container missing.");return}R(),console.log("Starting subtitle display interval.");const t=()=>Se(e);I=setInterval(t,g.SUBTITLE_UPDATE_INTERVAL_MS),a.addEventListener("play",t),a.addEventListener("seeked",t),a._subtitleUpdateFn=t}function R(){if(I&&(clearInterval(I),I=null,console.log("Stopped subtitle display interval.")),a){const e=a;e._subtitleUpdateFn&&(a.removeEventListener("play",e._subtitleUpdateFn),a.removeEventListener("seeked",e._subtitleUpdateFn),delete e._subtitleUpdateFn)}}function y(){l&&(l.style.display="none"),u&&(u.textContent="")}function N(){R(),y()}function fe(e,t){chrome.runtime.onMessage.addListener((n,o,r)=>{switch(n.action){case c.GET_VIDEO_TITLE:Te(r);break;case c.GENERATE_SUMMARY:ge(n,r);break;case c.GENERATE_SUBTITLES:_e(n,t.clearSubtitles,r);break;case c.SUBTITLES_GENERATED:me(n,e,r);break;case c.TOGGLE_SUBTITLES:Ae(n,e,t.checkAndTriggerAutoGeneration,r);break;case c.UPDATE_CAPTION_FONT_SIZE:Oe(n,r);break;default:return!1}return!0})}function Te(e){const t=document.querySelector("h1.ytd-watch-metadata yt-formatted-string"),n=t?t.textContent:null;e({title:n})}function ge(e,t){const n=e.videoId||d(window.location.href);if(!n){t({status:"error",message:"Could not extract video ID from URL."});return}A({action:c.GENERATE_SUMMARY,videoId:n,scrapeCreatorsApiKey:e.scrapeCreatorsApiKey,openRouterApiKey:e.openRouterApiKey,modelSelection:e.modelSelection,targetLanguage:e.targetLanguage,fastMode:e.fastMode,qualityModel:e.qualityModel}).catch(o=>{console.error("Error sending generate summary message:",o.message)}),t({status:"started"})}function _e(e,t,n){const o=e.videoId||d(window.location.href);if(!o){n({status:"error",message:"Could not extract video ID from URL."});return}t(),A({action:c.FETCH_SUBTITLES,videoId:o,scrapeCreatorsApiKey:e.scrapeCreatorsApiKey,openRouterApiKey:e.openRouterApiKey,modelSelection:e.modelSelection,forceRegenerate:e.forceRegenerate===!0}).then(r=>{(r==null?void 0:r.status)==="error"&&S(o)}).catch(r=>{console.error("Error communicating with background:",r.message)}),n({status:"started"})}function me(e,t,n){if(t.currentSubtitles=e.subtitles||[],t.currentSubtitles.length>0){t.showSubtitlesEnabled&&b(t.currentSubtitles);const o=e.videoId||d(window.location.href);o&&ae(o,t.currentSubtitles).catch(console.error),n({status:"success"})}else t.currentSubtitles=[],N(),n({status:"no_subtitles_found"})}function Ae(e,t,n,o){const r=ne(e),s=t.showSubtitlesEnabled;t.showSubtitlesEnabled=r,chrome.storage.local.set({[i.SHOW_SUBTITLES]:t.showSubtitlesEnabled}),t.showSubtitlesEnabled&&t.currentSubtitles.length>0?b(t.currentSubtitles):(R(),N()),t.showSubtitlesEnabled&&!s&&t.currentSubtitles.length===0&&pe(t,n),o({status:"success"})}function pe(e,t){const n=d(window.location.href);if(!n)return;const o=[n,...oe()];chrome.storage.local.get(o,r=>{r[n]&&r[n].length>0?(e.currentSubtitles=r[n],b(e.currentSubtitles)):t(n,r,!1,!1)})}function Oe(e,t){const n=e.fontSize||_.CAPTION_FONT_SIZE;v(n),t({status:"success"})}const f={currentSubtitles:[],showSubtitlesEnabled:!0};let C=0,L=window.location.href,E=null;async function P(e,t,n=!0,o=!1){return K(e,t,f.showSubtitlesEnabled,n).isValid?(W(e,()=>{be(e,t)},n,o),!0):!1}function Ie(){try{if(!O()){console.warn("Extension context invalidated, skipping subtitle load.");return}const e=$();if(!e.isValid||!e.videoId)return;const t=e.videoId,n=[t,...j()];chrome.storage.local.get(n,o=>{try{if(chrome.runtime.lastError){console.error("Error loading subtitles from storage:",chrome.runtime.lastError.message);return}f.showSubtitlesEnabled=o[i.SHOW_SUBTITLES]!==!1,o&&o[t]?(console.log("Found stored subtitles for this video."),f.currentSubtitles=o[t],f.showSubtitlesEnabled&&b(f.currentSubtitles)):(console.log("No stored subtitles found for this video."),P(t,o,!0,!0))}catch(r){console.error("Error processing stored subtitles:",r)}})}catch(e){console.error("Error in loadStoredSubtitles:",e)}}async function be(e,t){w();const n=t[i.SCRAPE_CREATORS_API_KEY],o=t[i.OPENROUTER_API_KEY];if(!await J(e,n)){S(e);return}const s=t[i.SHOW_SUBTITLES]!==!1,ye=Q(t);if(s){const Ne=X(t);ee(e,n,o,Ne,S)}else console.log("[Auto-gen] Skipping caption refinement (showSubtitles disabled)");te(e,n,o,ye)}function Me(){E&&(E.disconnect(),E=null),E=new MutationObserver(()=>{if(!O()){E&&(E.disconnect(),E=null);return}if(L!==window.location.href){console.log("URL changed (mutation).");const e=d(L);L=window.location.href,e&&S(e),he()}}),E.observe(document.body,{childList:!0,subtree:!0})}function he(){console.log("Reinitializing for new video..."),w(),C=0,U()}function U(){if(console.log("Initializing content script..."),!!window.location.href.includes("youtube.com/watch")){if(!ue()){C++,C<g.MAX_INIT_ATTEMPTS?setTimeout(U,g.INIT_RETRY_DELAY_MS):console.error("Video player or container not found after multiple attempts.");return}Ee(),Ie(),Re(),fe(f,{clearSubtitles:w,checkAndTriggerAutoGeneration:P})}}function Re(){try{if(!O())return;chrome.storage.local.get([i.CAPTION_FONT_SIZE],e=>{try{if(chrome.runtime.lastError)return;const t=(e==null?void 0:e[i.CAPTION_FONT_SIZE])||_.CAPTION_FONT_SIZE;v(t)}catch(t){console.error("Error applying caption font size:",t)}})}catch(e){console.error("Error in loadCaptionFontSize:",e)}}function w(){f.currentSubtitles=[],N(),console.log("Subtitles cleared.")}(function(){console.log("Content script loaded, readyState:",document.readyState);const e=()=>{U(),Me()};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",e):setTimeout(e,g.CONTENT_SCRIPT_INIT_DELAY_MS)})()})();

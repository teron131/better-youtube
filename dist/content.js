(function(){"use strict";var P;const r={SCRAPE_CREATORS_API_KEY:"scrapeCreatorsApiKey",OPENROUTER_API_KEY:"openRouterApiKey",SUMMARIZER_RECOMMENDED_MODEL:"summarizerRecommendedModel",SUMMARIZER_CUSTOM_MODEL:"summarizerCustomModel",REFINER_RECOMMENDED_MODEL:"refinerRecommendedModel",REFINER_CUSTOM_MODEL:"refinerCustomModel",AUTO_GENERATE:"autoGenerate",SHOW_SUBTITLES:"showSubtitles",CAPTION_FONT_SIZE:"captionFontSize",TARGET_LANGUAGE_RECOMMENDED:"targetLanguageRecommended",TARGET_LANGUAGE_CUSTOM:"targetLanguageCustom",FAST_MODE:"fastMode",QUALITY_MODEL:"qualityModel"},p={AUTO_GENERATION_DELAY_MS:2e3,INIT_RETRY_DELAY_MS:500,MAX_INIT_ATTEMPTS:5,CONTENT_SCRIPT_INIT_DELAY_MS:500},x={CLEANUP_BATCH_SIZE:10},k=[{value:"google/gemini-3-flash-preview",label:"Gemini 3 Flash"},{value:"google/gemini-3-pro-preview",label:"Gemini 3 Pro"},{value:"openai/gpt-5-mini",label:"GPT-5 Mini"},{value:"openai/gpt-5.2",label:"GPT-5.2"},{value:"x-ai/grok-4.1-fast",label:"Grok 4.1 Fast"}],V=[{value:"google/gemini-2.5-flash-lite-preview-09-2025",label:"Gemini 2.5 Flash Lite"},{value:"x-ai/grok-4.1-fast",label:"Grok 4.1 Fast"}],_={MODEL_SUMMARIZER:k[0].value,MODEL_REFINER:V[0].value,CAPTION_FONT_SIZE:"M",TARGET_LANGUAGE_RECOMMENDED:"auto"},D={CAPTION:{S:{base:"1.4vw",max:"22px",min:"12px",fullscreen:"1.7vw",fullscreenMax:"28px"},M:{base:"1.8vw",max:"28px",min:"14px",fullscreen:"2.2vw",fullscreenMax:"36px"},L:{base:"2.2vw",max:"34px",min:"16px",fullscreen:"2.7vw",fullscreenMax:"44px"}}},b={VIDEO_ID_LENGTH:11,SELECTORS:{VIDEO_PLAYER:"video.html5-main-video",MOVIE_PLAYER:"#movie_player",VIDEO_CONTAINER:".html5-video-container"}},c={SCRAPE_VIDEO:"scrapeVideo",FETCH_SUBTITLES:"fetchSubtitles",GENERATE_SUBTITLES:"generateSubtitles",GENERATE_SUMMARY:"generateSummary",SUBTITLES_GENERATED:"subtitlesGenerated",TOGGLE_SUBTITLES:"toggleSubtitles",GET_VIDEO_TITLE:"getVideoTitle",UPDATE_CAPTION_FONT_SIZE:"updateCaptionFontSize"},m={SUBTITLE_CONTAINER:"youtube-gemini-subtitles-container",SUBTITLE_TEXT:"youtube-gemini-subtitles-text"},Y={MIN_VIDEOS_TO_KEEP:5};function f(e){if(!e)return null;try{const t=new URL(e),n=t.hostname.replace(/^www\./,"");if(n.includes("youtube.com")){const o=t.searchParams.get("v");if(o)return o}if(n==="youtu.be"){const o=t.pathname.replace(/^\//,"");if(o)return o}}catch{const t=e.match(/(?:v=|youtu\.be\/)([\w-]+)/);if(t!=null&&t[1])return t[1]}return null}const I=new Set;function O(){var e;try{return!!((e=chrome.runtime)!=null&&e.id)}catch{return!1}}function B(e){return I.has(e)}function K(e){I.add(e)}function S(e){I.delete(e)}function z(e,t,n,o){return t[r.AUTO_GENERATE]!==!0?(console.log("Auto-gen skipped: setting disabled"),{isValid:!1,reason:"setting disabled"}):o&&!n?(console.log("Auto-gen skipped: captions disabled"),{isValid:!1,reason:"captions disabled"}):t[r.SCRAPE_CREATORS_API_KEY]?B(e)?(console.log("Auto-gen skipped: already triggered for video",e),{isValid:!1,reason:"already triggered"}):{isValid:!0}:(console.log("Auto-gen skipped: missing Scrape Creators key"),{isValid:!1,reason:"missing api key"})}function Z(e){const t=f(window.location.href);return t!==e?(console.log("Auto-gen cancel: video ID changed",e,"->",t),S(e),!1):!0}function H(e){return new Promise(t=>{chrome.storage.local.get([r.SHOW_SUBTITLES],n=>{n[r.SHOW_SUBTITLES]!==!1?t(!0):(console.log("Auto-gen cancel: captions disabled"),S(e),t(!1))})})}async function q(e,t,n){Z(e)&&(n&&!await H(e)||t())}function $(e,t,n,o){K(e),console.log("Auto-gen enabled,",o?"waiting for page to load...":"triggering immediately...","videoId:",e);const i=()=>{q(e,t,n)};o?setTimeout(()=>{if(!O()){console.log("Context invalidated before auto-generation, aborting."),S(e);return}console.log("Auto-gen delay elapsed; triggering now for",e),i()},p.AUTO_GENERATION_DELAY_MS):i()}async function A(e,t){return new Promise((n,o)=>{chrome.runtime.sendMessage(e,i=>{chrome.runtime.lastError?o(new Error(chrome.runtime.lastError.message)):n(i)})})}function W(){if(!window.location.href.includes("youtube.com/watch"))return console.log("Not on a video page, skipping subtitle load."),{isValid:!1};const e=f(window.location.href);return e?{isValid:!0,videoId:e}:(console.warn("Could not extract video ID, skipping subtitle load."),{isValid:!1})}function X(){return[r.AUTO_GENERATE,r.SCRAPE_CREATORS_API_KEY,r.OPENROUTER_API_KEY,r.REFINER_RECOMMENDED_MODEL,r.REFINER_CUSTOM_MODEL,r.SUMMARIZER_RECOMMENDED_MODEL,r.SUMMARIZER_CUSTOM_MODEL,r.TARGET_LANGUAGE_RECOMMENDED,r.TARGET_LANGUAGE_CUSTOM,r.SHOW_SUBTITLES,r.FAST_MODE,r.QUALITY_MODEL]}function Q(e){return e[r.REFINER_CUSTOM_MODEL]||e[r.REFINER_RECOMMENDED_MODEL]||_.MODEL_REFINER}function j(e){const t=e[r.SUMMARIZER_CUSTOM_MODEL]||e[r.SUMMARIZER_RECOMMENDED_MODEL]||_.MODEL_SUMMARIZER;return{summarizerModel:t,qualityModel:e[r.QUALITY_MODEL]||t,targetLanguage:e[r.TARGET_LANGUAGE_CUSTOM]||e[r.TARGET_LANGUAGE_RECOMMENDED]||_.TARGET_LANGUAGE_RECOMMENDED,fastMode:e[r.FAST_MODE]===!0}}async function J(e,t){return console.log(`[Auto-gen] Step 1: Scraping video data for ${e}...`),(await A({action:c.SCRAPE_VIDEO,videoId:e,scrapeCreatorsApiKey:t}).catch(()=>({status:"error"}))).status!=="success"?(console.error(`[Auto-gen] Scrape failed for ${e}`),!1):(console.log("[Auto-gen] Step 2: Scrape complete. Starting refine + summarize..."),!0)}function ee(e,t,n,o,i){A({action:c.FETCH_SUBTITLES,videoId:e,scrapeCreatorsApiKey:t,openRouterApiKey:n,modelSelection:o}).then(a=>console.log("[Auto-gen] Subtitle refinement triggered:",a)).catch(a=>{console.error("Error triggering subtitle auto-gen:",a.message),i==null||i(e)})}function te(e,t,n,o){A({action:c.GENERATE_SUMMARY,videoId:e,scrapeCreatorsApiKey:t,openRouterApiKey:n,modelSelection:o.summarizerModel,qualityModel:o.qualityModel,targetLanguage:o.targetLanguage,fastMode:o.fastMode}).then(i=>console.log("[Auto-gen] Summary generation triggered:",i)).catch(i=>console.error("Error triggering summary auto-gen:",i.message))}function ne(e){return"showSubtitles"in e?e.showSubtitles!==!1:"enabled"in e?e.enabled!==!1:!0}function oe(){return[r.AUTO_GENERATE,r.SCRAPE_CREATORS_API_KEY,r.OPENROUTER_API_KEY,r.REFINER_RECOMMENDED_MODEL,r.REFINER_CUSTOM_MODEL]}const ie={subtitles:e=>e,metadata:e=>`video_info_${e}`,analysis:e=>`analysis_${e}`},R=typeof chrome<"u"&&!!((P=chrome.storage)!=null&&P.local);async function G(e){if(!R){for(const[t,n]of Object.entries(e))localStorage.setItem(t,JSON.stringify(n));return}return new Promise((t,n)=>{chrome.storage.local.set(e,()=>{chrome.runtime.lastError?n(new Error(chrome.runtime.lastError.message)):t()})})}async function re(e){if(!R){e.forEach(t=>localStorage.removeItem(t));return}return new Promise((t,n)=>{chrome.storage.local.remove(e,()=>{chrome.runtime.lastError?n(new Error(chrome.runtime.lastError.message)):t()})})}async function le(){if(!R){const e={};for(let t=0;t<localStorage.length;t++){const n=localStorage.key(t);if(n){const o=localStorage.getItem(n);o&&(e[n]=JSON.parse(o))}}return e}return new Promise((e,t)=>{chrome.storage.local.get(null,n=>{chrome.runtime.lastError?t(new Error(chrome.runtime.lastError.message)):e(n)})})}async function ae(e,t){const n=ie.subtitles(e);try{await G({[n]:t}),console.log(`Subtitles saved for video: ${e}`)}catch(o){if(o instanceof Error&&o.message.includes("QUOTA"))console.warn("Storage quota exceeded, cleaning up..."),await ce(x.CLEANUP_BATCH_SIZE),await G({[n]:t}),console.log(`Subtitles saved after cleanup: ${e}`);else throw o}}async function se(e){const t=[];for(const n of Object.keys(e))(n.length===b.VIDEO_ID_LENGTH&&Array.isArray(e[n])||n.startsWith("video_info_")||n.startsWith("analysis_"))&&t.push(n);return t}async function ce(e){const t=await le(),n=await se(t);if(n.length===0){console.log("No video data to clean up");return}const o=n.length<=e?Math.max(1,n.length-Y.MIN_VIDEOS_TO_KEEP):e,i=n.slice(0,o);await re(i),console.log(`Cleaned up ${i.length} video data entries`)}let s=null,u=null,l=null,g=null,E=null;function ue(){return l=document.querySelector(b.SELECTORS.VIDEO_PLAYER),l?(g=document.querySelector(b.SELECTORS.MOVIE_PLAYER)||document.querySelector(b.SELECTORS.VIDEO_CONTAINER)||l.parentElement,!!g):!1}function Ee(){if(document.getElementById(m.SUBTITLE_CONTAINER)){s=document.getElementById(m.SUBTITLE_CONTAINER),u=document.getElementById(m.SUBTITLE_TEXT);return}s=document.createElement("div"),s.id=m.SUBTITLE_CONTAINER,s.style.position="absolute",s.style.zIndex="9999",s.style.pointerEvents="none",s.style.display="none",u=document.createElement("div"),u.id=m.SUBTITLE_TEXT,s.appendChild(u),g?(getComputedStyle(g).position==="static"&&(g.style.position="relative"),g.appendChild(s),console.log("Subtitle container added to video container.")):console.error("Cannot add subtitle container, video container not found.")}function v(e){const t=D.CAPTION[e]||D.CAPTION.M;document.documentElement.style.setProperty("--caption-font-size-base",t.base),document.documentElement.style.setProperty("--caption-font-size-max",t.max),document.documentElement.style.setProperty("--caption-font-size-min",t.min),document.documentElement.style.setProperty("--caption-font-size-fullscreen",t.fullscreen),document.documentElement.style.setProperty("--caption-font-size-fullscreen-max",t.fullscreenMax),u&&(u.style.fontSize=`clamp(${t.min}, ${t.base}, ${t.max})`)}function de(e,t){let n=0,o=e.length-1;for(;n<=o;){const i=Math.floor((n+o)/2),a=e[i];if(t>=a.startTime&&t<a.endTime)return a;t<a.startTime?o=i-1:n=i+1}return null}function fe(e){if(!l||!u||!s||isNaN(l.currentTime))return;const t=l.currentTime*1e3,n=de(e,t);if(n){const o=n.text.replace(/\r\n?/g,`
`).replace(/\n{2,}/g,`
`).trim();if(!o){L();return}u.textContent!==o&&(u.textContent=o),s.style.display="block"}else L()}function M(e){if(!l||!s){console.warn("Cannot start subtitle display: Player or container missing.");return}h(),console.log("Starting subtitle display interval.");const t=()=>fe(e),n=()=>{E!==null&&cancelAnimationFrame(E);const a=()=>{t(),l&&!l.paused&&!l.ended?E=requestAnimationFrame(a):E=null};E=requestAnimationFrame(a)},o=()=>{E!==null&&(cancelAnimationFrame(E),E=null)};t(),!l.paused&&!l.ended&&n(),l.addEventListener("play",n),l.addEventListener("pause",o),l.addEventListener("ended",o),l.addEventListener("seeked",()=>{t(),!(l!=null&&l.paused)&&!(l!=null&&l.ended)&&n()});const i=l;i._subtitleUpdateFn=t,i._subtitleStartLoopFn=n,i._subtitleStopLoopFn=o}function h(){if(l){const e=l;e._subtitleUpdateFn&&(e._subtitleStartLoopFn&&l.removeEventListener("play",e._subtitleStartLoopFn),e._subtitleStopLoopFn&&(l.removeEventListener("pause",e._subtitleStopLoopFn),l.removeEventListener("ended",e._subtitleStopLoopFn)),delete e._subtitleUpdateFn,delete e._subtitleStartLoopFn,delete e._subtitleStopLoopFn)}E!==null&&(cancelAnimationFrame(E),E=null)}function L(){s&&(s.style.display="none"),u&&(u.textContent="")}function y(){h(),L()}function Se(e,t){chrome.runtime.onMessage.addListener((n,o,i)=>{switch(n.action){case c.GET_VIDEO_TITLE:Te(i);break;case c.GENERATE_SUMMARY:ge(n,i);break;case c.GENERATE_SUBTITLES:_e(n,t.clearSubtitles,i);break;case c.SUBTITLES_GENERATED:me(n,e,i);break;case c.TOGGLE_SUBTITLES:Ae(n,e,t.checkAndTriggerAutoGeneration,i);break;case c.UPDATE_CAPTION_FONT_SIZE:be(n,i);break;default:return!1}return!0})}function Te(e){const t=document.querySelector("h1.ytd-watch-metadata yt-formatted-string");e({title:(t==null?void 0:t.textContent)??null})}function ge(e,t){const n=e.videoId||f(window.location.href);if(!n){t({status:"error",message:"Could not extract video ID from URL."});return}A({action:c.GENERATE_SUMMARY,videoId:n,scrapeCreatorsApiKey:e.scrapeCreatorsApiKey,openRouterApiKey:e.openRouterApiKey,modelSelection:e.modelSelection,targetLanguage:e.targetLanguage,fastMode:e.fastMode,qualityModel:e.qualityModel}).catch(o=>{console.error("Error sending generate summary message:",o.message)}),t({status:"started"})}function _e(e,t,n){const o=e.videoId||f(window.location.href);if(!o){n({status:"error",message:"Could not extract video ID from URL."});return}t(),A({action:c.FETCH_SUBTITLES,videoId:o,scrapeCreatorsApiKey:e.scrapeCreatorsApiKey,openRouterApiKey:e.openRouterApiKey,modelSelection:e.modelSelection,forceRegenerate:e.forceRegenerate===!0}).then(i=>{(i==null?void 0:i.status)==="error"&&S(o)}).catch(i=>{console.error("Error communicating with background:",i.message)}),n({status:"started"})}function me(e,t,n){if(t.currentSubtitles=e.subtitles||[],t.currentSubtitles.length>0){t.showSubtitlesEnabled&&M(t.currentSubtitles);const o=e.videoId||f(window.location.href);o&&ae(o,t.currentSubtitles).catch(console.error),n({status:"success"})}else t.currentSubtitles=[],y(),n({status:"no_subtitles_found"})}function Ae(e,t,n,o){const i=ne(e),a=t.showSubtitlesEnabled;t.showSubtitlesEnabled=i,chrome.storage.local.set({[r.SHOW_SUBTITLES]:t.showSubtitlesEnabled}),t.showSubtitlesEnabled&&t.currentSubtitles.length>0?M(t.currentSubtitles):(h(),y()),t.showSubtitlesEnabled&&!a&&t.currentSubtitles.length===0&&pe(t,n),o({status:"success"})}function pe(e,t){const n=f(window.location.href);if(!n)return;const o=[n,...oe()];chrome.storage.local.get(o,i=>{i[n]&&i[n].length>0?(e.currentSubtitles=i[n],M(e.currentSubtitles)):t(n,i,!1,!1)})}function be(e,t){v(e.fontSize||_.CAPTION_FONT_SIZE),t({status:"success"})}const T={currentSubtitles:[],showSubtitlesEnabled:!0};let C=0,N=window.location.href,d=null;async function F(e,t,n=!0,o=!1){return z(e,t,T.showSubtitlesEnabled,n).isValid?($(e,()=>{Me(e,t)},n,o),!0):!1}function Oe(){if(!O()){console.warn("Extension context invalidated, skipping subtitle load.");return}const e=W();if(!e.isValid||!e.videoId)return;const t=e.videoId,n=[t,...X()];chrome.storage.local.get(n,o=>{if(chrome.runtime.lastError){console.error("Error loading subtitles from storage:",chrome.runtime.lastError.message);return}T.showSubtitlesEnabled=o[r.SHOW_SUBTITLES]!==!1,o[t]?(console.log("Found stored subtitles for this video."),T.currentSubtitles=o[t],T.showSubtitlesEnabled&&M(T.currentSubtitles)):(console.log("No stored subtitles found for this video."),F(t,o,!0,!0))})}async function Me(e,t){w();const n=t[r.SCRAPE_CREATORS_API_KEY],o=t[r.OPENROUTER_API_KEY];if(!await J(e,n)){S(e);return}const a=t[r.SHOW_SUBTITLES]!==!1,Le=j(t);if(a){const ye=Q(t);ee(e,n,o,ye,S)}else console.log("[Auto-gen] Skipping caption refinement (showSubtitles disabled)");te(e,n,o,Le)}function Ie(){d&&(d.disconnect(),d=null),d=new MutationObserver(()=>{if(!O()){d&&(d.disconnect(),d=null);return}if(N!==window.location.href){console.log("URL changed (mutation).");const e=f(N);N=window.location.href,e&&S(e),Re()}}),d.observe(document.body,{childList:!0,subtree:!0})}function Re(){console.log("Reinitializing for new video..."),w(),C=0,U()}function U(){if(console.log("Initializing content script..."),!!window.location.href.includes("youtube.com/watch")){if(!ue()){C++,C<p.MAX_INIT_ATTEMPTS?setTimeout(U,p.INIT_RETRY_DELAY_MS):console.error("Video player or container not found after multiple attempts.");return}Ee(),Oe(),he(),Se(T,{clearSubtitles:w,checkAndTriggerAutoGeneration:F})}}function he(){O()&&chrome.storage.local.get([r.CAPTION_FONT_SIZE],e=>{if(chrome.runtime.lastError)return;const t=(e==null?void 0:e[r.CAPTION_FONT_SIZE])||_.CAPTION_FONT_SIZE;v(t)})}function w(){T.currentSubtitles=[],y(),console.log("Subtitles cleared.")}(function(){console.log("Content script loaded, readyState:",document.readyState);const e=()=>{U(),Ie()};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",e):setTimeout(e,p.CONTENT_SCRIPT_INIT_DELAY_MS)})()})();

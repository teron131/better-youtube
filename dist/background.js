var eI=Object.defineProperty;var Ag=t=>{throw TypeError(t)};var tI=(t,e,n)=>e in t?eI(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var p=(t,e,n)=>tI(t,typeof e!="symbol"?e+"":e,n),vd=(t,e,n)=>e.has(t)||Ag("Cannot "+n);var he=(t,e,n)=>(vd(t,e,"read from private field"),n?n.call(t):e.get(t)),rn=(t,e,n)=>e.has(t)?Ag("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,n),En=(t,e,n,r)=>(vd(t,e,"write to private field"),r?r.call(t,n):e.set(t,n),n),We=(t,e,n)=>(vd(t,e,"access private method"),n);import{g as bp,e as nI,D as Ll,f as Sc,A as Pw,h as rI,i as Mw,M as ss,j as sI,k as Lw,l as iI,E as yo,T as bd}from"./assets/storage-De_yrzrv.js";const jw={OPENROUTER_BASE_URL:"https://openrouter.ai/api/v1"},jl={MIN_QUALITY_SCORE:80,MAX_ITERATIONS:2,SCORE_MAP:{Fail:0,Refine:1,Pass:2},MAX_SCORE_PER_ASPECT:2};var aI=Object.defineProperty,Se=(t,e)=>{for(var n in e)aI(t,n,{get:e[n],enumerable:!0})};function Gr(t){return typeof t=="object"&&t!==null&&"type"in t&&typeof t.type=="string"&&"source_type"in t&&(t.source_type==="url"||t.source_type==="base64"||t.source_type==="text"||t.source_type==="id")}function Ep(t){return Gr(t)&&t.source_type==="url"&&"url"in t&&typeof t.url=="string"}function Tp(t){return Gr(t)&&t.source_type==="base64"&&"data"in t&&typeof t.data=="string"}function oI(t){return Gr(t)&&t.source_type==="text"&&"text"in t&&typeof t.text=="string"}function Dw(t){return Gr(t)&&t.source_type==="id"&&"id"in t&&typeof t.id=="string"}function Uw(t){if(Gr(t)){if(t.source_type==="url")return{type:"image_url",image_url:{url:t.url}};if(t.source_type==="base64"){if(!t.mime_type)throw new Error("mime_type key is required for base64 data.");return{type:"image_url",image_url:{url:`data:${t.mime_type};base64,${t.data}`}}}}throw new Error("Unsupported source type. Only 'url' and 'base64' are supported.")}function jh(t){const e=t.split(";")[0].split("/");if(e.length!==2)throw new Error(`Invalid mime type: "${t}" - does not match type/subtype format.`);const n=e[0].trim(),r=e[1].trim();if(n===""||r==="")throw new Error(`Invalid mime type: "${t}" - type or subtype is empty.`);const s={};for(const i of t.split(";").slice(1)){const a=i.split("=");if(a.length!==2)throw new Error(`Invalid parameter syntax in mime type: "${t}".`);const o=a[0].trim(),c=a[1].trim();if(o==="")throw new Error(`Invalid parameter syntax in mime type: "${t}".`);s[o]=c}return{type:n,subtype:r,parameters:s}}function _o({dataUrl:t,asTypedArray:e=!1}){const n=t.match(/^data:(\w+\/\w+);base64,([A-Za-z0-9+/]+=*)$/);let r;if(n){r=n[1].toLowerCase();const s=e?Uint8Array.from(atob(n[2]),i=>i.charCodeAt(0)):n[2];return{mime_type:r,data:s}}}function Sp(t,e){if(t.type==="text"){if(!e.fromStandardTextBlock)throw new Error(`Converter for ${e.providerName} does not implement \`fromStandardTextBlock\` method.`);return e.fromStandardTextBlock(t)}if(t.type==="image"){if(!e.fromStandardImageBlock)throw new Error(`Converter for ${e.providerName} does not implement \`fromStandardImageBlock\` method.`);return e.fromStandardImageBlock(t)}if(t.type==="audio"){if(!e.fromStandardAudioBlock)throw new Error(`Converter for ${e.providerName} does not implement \`fromStandardAudioBlock\` method.`);return e.fromStandardAudioBlock(t)}if(t.type==="file"){if(!e.fromStandardFileBlock)throw new Error(`Converter for ${e.providerName} does not implement \`fromStandardFileBlock\` method.`);return e.fromStandardFileBlock(t)}throw new Error(`Unable to convert content block type '${t.type}' to provider-specific format: not recognized.`)}function Fw(t){return typeof t=="object"&&t!==null&&"type"in t&&"content"in t&&(typeof t.content=="string"||Array.isArray(t.content))}var cI=function(t,e){if(typeof t!="string")throw new TypeError("Expected a string");return e=typeof e>"u"?"_":e,t.replace(/([a-z\d])([A-Z])/g,"$1"+e+"$2").replace(/([A-Z]+)([A-Z][a-z\d]+)/g,"$1"+e+"$2").toLowerCase()};const lI=bp(cI);var xp={exports:{}};const uI=/[\p{Lu}]/u,dI=/[\p{Ll}]/u,Cg=/^[\p{Lu}](?![\p{Lu}])/gu,Bw=/([\p{Alpha}\p{N}_]|$)/u,zw=/[_.\- ]+/,hI=new RegExp("^"+zw.source),Og=new RegExp(zw.source+Bw.source,"gu"),$g=new RegExp("\\d+"+Bw.source,"gu"),fI=(t,e,n)=>{let r=!1,s=!1,i=!1;for(let a=0;a<t.length;a++){const o=t[a];r&&uI.test(o)?(t=t.slice(0,a)+"-"+t.slice(a),r=!1,i=s,s=!0,a++):s&&i&&dI.test(o)?(t=t.slice(0,a-1)+"-"+t.slice(a-1),i=s,s=!1,r=!0):(r=e(o)===o&&n(o)!==o,i=s,s=n(o)===o&&e(o)!==o)}return t},pI=(t,e)=>(Cg.lastIndex=0,t.replace(Cg,n=>e(n))),mI=(t,e)=>(Og.lastIndex=0,$g.lastIndex=0,t.replace(Og,(n,r)=>e(r)).replace($g,n=>e(n))),Zw=(t,e)=>{if(!(typeof t=="string"||Array.isArray(t)))throw new TypeError("Expected the input to be `string | string[]`");if(e={pascalCase:!1,preserveConsecutiveUppercase:!1,...e},Array.isArray(t)?t=t.map(i=>i.trim()).filter(i=>i.length).join("-"):t=t.trim(),t.length===0)return"";const n=e.locale===!1?i=>i.toLowerCase():i=>i.toLocaleLowerCase(e.locale),r=e.locale===!1?i=>i.toUpperCase():i=>i.toLocaleUpperCase(e.locale);return t.length===1?e.pascalCase?r(t):n(t):(t!==n(t)&&(t=fI(t,n,r)),t=t.replace(hI,""),e.preserveConsecutiveUppercase?t=pI(t,n):t=n(t),e.pascalCase&&(t=r(t.charAt(0))+t.slice(1)),mI(t,r))};xp.exports=Zw;xp.exports.default=Zw;var gI=xp.exports;const yI=bp(gI);function _I(t,e){return(e==null?void 0:e[t])||lI(t)}function wI(t,e){return(e==null?void 0:e[t])||yI(t)}function Vw(t,e,n){const r={};for(const s in t)Object.hasOwn(t,s)&&(r[e(s,n)]=t[s]);return r}var Gw={};Se(Gw,{Serializable:()=>cr,get_lc_unique_name:()=>Au});function Rg(t){return Array.isArray(t)?[...t]:{...t}}function vI(t,e){const n=Rg(t);for(const[r,s]of Object.entries(e)){const[i,...a]=r.split(".").reverse();let o=n;for(const c of a.reverse()){if(o[c]===void 0)break;o[c]=Rg(o[c]),o=o[c]}o[i]!==void 0&&(o[i]={lc:1,type:"secret",id:[s]})}return n}function Au(t){const e=Object.getPrototypeOf(t);return typeof t.lc_name=="function"&&(typeof e.lc_name!="function"||t.lc_name()!==e.lc_name())?t.lc_name():t.name}var cr=class Ww{constructor(e,...n){p(this,"lc_serializable",!1);p(this,"lc_kwargs");this.lc_serializable_keys!==void 0?this.lc_kwargs=Object.fromEntries(Object.entries(e||{}).filter(([r])=>{var s;return(s=this.lc_serializable_keys)==null?void 0:s.includes(r)})):this.lc_kwargs=e??{}}static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,Au(this.constructor)]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}get lc_serializable_keys(){}toJSON(){if(!this.lc_serializable)return this.toJSONNotImplemented();if(this.lc_kwargs instanceof Ww||typeof this.lc_kwargs!="object"||Array.isArray(this.lc_kwargs))return this.toJSONNotImplemented();const e={},n={},r=Object.keys(this.lc_kwargs).reduce((s,i)=>(s[i]=i in this?this[i]:this.lc_kwargs[i],s),{});for(let s=Object.getPrototypeOf(this);s;s=Object.getPrototypeOf(s))Object.assign(e,Reflect.get(s,"lc_aliases",this)),Object.assign(n,Reflect.get(s,"lc_secrets",this)),Object.assign(r,Reflect.get(s,"lc_attributes",this));return Object.keys(n).forEach(s=>{let i=this,a=r;const[o,...c]=s.split(".").reverse();for(const l of c.reverse()){if(!(l in i)||i[l]===void 0)return;(!(l in a)||a[l]===void 0)&&(typeof i[l]=="object"&&i[l]!=null?a[l]={}:Array.isArray(i[l])&&(a[l]=[])),i=i[l],a=a[l]}o in i&&i[o]!==void 0&&(a[o]=a[o]||i[o])}),{lc:1,type:"constructor",id:this.lc_id,kwargs:Vw(Object.keys(n).length?vI(r,n):r,_I,e)}}toJSONNotImplemented(){return{lc:1,type:"not_implemented",id:this.lc_id}}};function Ee(t,e){return Re(t)&&t.type===e}function Re(t){return typeof t=="object"&&t!==null}function zr(t){return Array.isArray(t)}function ae(t){return typeof t=="string"}function yr(t){return typeof t=="number"}function kp(t){return t instanceof Uint8Array}function Ng(t){try{return JSON.parse(t)}catch{return}}const wo=t=>t();function bI(t){if(t.type==="char_location"&&ae(t.document_title)&&yr(t.start_char_index)&&yr(t.end_char_index)&&ae(t.cited_text)){const{document_title:e,start_char_index:n,end_char_index:r,cited_text:s,...i}=t;return{...i,type:"citation",source:"char",title:e??void 0,startIndex:n,endIndex:r,citedText:s}}if(t.type==="page_location"&&ae(t.document_title)&&yr(t.start_page_number)&&yr(t.end_page_number)&&ae(t.cited_text)){const{document_title:e,start_page_number:n,end_page_number:r,cited_text:s,...i}=t;return{...i,type:"citation",source:"page",title:e??void 0,startIndex:n,endIndex:r,citedText:s}}if(t.type==="content_block_location"&&ae(t.document_title)&&yr(t.start_block_index)&&yr(t.end_block_index)&&ae(t.cited_text)){const{document_title:e,start_block_index:n,end_block_index:r,cited_text:s,...i}=t;return{...i,type:"citation",source:"block",title:e??void 0,startIndex:n,endIndex:r,citedText:s}}if(t.type==="web_search_result_location"&&ae(t.url)&&ae(t.title)&&ae(t.encrypted_index)&&ae(t.cited_text)){const{url:e,title:n,encrypted_index:r,cited_text:s,...i}=t;return{...i,type:"citation",source:"url",url:e,title:n,startIndex:Number(r),endIndex:Number(r),citedText:s}}if(t.type==="search_result_location"&&ae(t.source)&&ae(t.title)&&yr(t.start_block_index)&&yr(t.end_block_index)&&ae(t.cited_text)){const{source:e,title:n,start_block_index:r,end_block_index:s,cited_text:i,...a}=t;return{...a,type:"citation",source:"search",url:e,title:n??void 0,startIndex:r,endIndex:s,citedText:i}}}function Hw(t){if(Ee(t,"document")&&Re(t.source)&&"type"in t.source){if(t.source.type==="base64"&&ae(t.source.media_type)&&ae(t.source.data))return{type:"file",mimeType:t.source.media_type,data:t.source.data};if(t.source.type==="url"&&ae(t.source.url))return{type:"file",url:t.source.url};if(t.source.type==="file"&&ae(t.source.file_id))return{type:"file",fileId:t.source.file_id};if(t.source.type==="text"&&ae(t.source.data))return{type:"file",mimeType:String(t.source.media_type??"text/plain"),data:t.source.data}}else if(Ee(t,"image")&&Re(t.source)&&"type"in t.source){if(t.source.type==="base64"&&ae(t.source.media_type)&&ae(t.source.data))return{type:"image",mimeType:t.source.media_type,data:t.source.data};if(t.source.type==="url"&&ae(t.source.url))return{type:"image",url:t.source.url};if(t.source.type==="file"&&ae(t.source.file_id))return{type:"image",fileId:t.source.file_id}}}function EI(t){function*e(){for(const n of t){const r=Hw(n);r?yield r:yield n}}return Array.from(e())}function Pg(t){function*e(){var r;const n=typeof t.content=="string"?[{type:"text",text:t.content}]:t.content;for(const s of n){if(Ee(s,"text")&&ae(s.text)){const{text:i,citations:a,...o}=s;if(zr(a)&&a.length){const c=a.reduce((l,u)=>{const d=bI(u);return d?[...l,d]:l},[]);yield{...o,type:"text",text:i,annotations:c};continue}else{yield{...o,type:"text",text:i};continue}}else if(Ee(s,"thinking")&&ae(s.thinking)){const{thinking:i,signature:a,...o}=s;yield{...o,type:"reasoning",reasoning:i,signature:a};continue}else if(Ee(s,"redacted_thinking")){yield{type:"non_standard",value:s};continue}else if(Ee(s,"tool_use")&&ae(s.name)&&ae(s.id)){yield{type:"tool_call",id:s.id,name:s.name,args:s.input};continue}else if(Ee(s,"input_json_delta")){if(SI(t)&&((r=t.tool_call_chunks)!=null&&r.length)){const i=t.tool_call_chunks[0];yield{type:"tool_call_chunk",id:i.id,name:i.name,args:i.args,index:i.index};continue}}else if(Ee(s,"server_tool_use")&&ae(s.name)&&ae(s.id)){const{name:i,id:a}=s;if(i==="web_search"){const o=wo(()=>{if(typeof s.input=="string")return s.input;if(Re(s.input)&&ae(s.input.query))return s.input.query;if(ae(s.partial_json)){const c=Ng(s.partial_json);if(c!=null&&c.query)return c.query}return""});yield{id:a,type:"server_tool_call",name:"web_search",args:{query:o}};continue}else if(s.name==="code_execution"){const o=wo(()=>{if(typeof s.input=="string")return s.input;if(Re(s.input)&&ae(s.input.code))return s.input.code;if(ae(s.partial_json)){const c=Ng(s.partial_json);if(c!=null&&c.code)return c.code}return""});yield{id:a,type:"server_tool_call",name:"code_execution",args:{code:o}};continue}}else if(Ee(s,"web_search_tool_result")&&ae(s.tool_use_id)&&zr(s.content)){const{content:i,tool_use_id:a}=s,o=i.reduce((c,l)=>Ee(l,"web_search_result")?[...c,l.url]:c,[]);yield{type:"server_tool_call_result",name:"web_search",toolCallId:a,status:"success",output:{urls:o}};continue}else if(Ee(s,"code_execution_tool_result")&&ae(s.tool_use_id)&&Re(s.content)){yield{type:"server_tool_call_result",name:"code_execution",toolCallId:s.tool_use_id,status:"success",output:s.content};continue}else if(Ee(s,"mcp_tool_use")){yield{id:s.id,type:"server_tool_call",name:"mcp_tool_use",args:s.input};continue}else if(Ee(s,"mcp_tool_result")&&ae(s.tool_use_id)&&Re(s.content)){yield{type:"server_tool_call_result",name:"mcp_tool_use",toolCallId:s.tool_use_id,status:"success",output:s.content};continue}else if(Ee(s,"container_upload")){yield{type:"server_tool_call",name:"container_upload",args:s.input};continue}else if(Ee(s,"search_result")){yield{id:s.id,type:"non_standard",value:s};continue}else if(Ee(s,"tool_result")){yield{id:s.id,type:"non_standard",value:s};continue}else{const i=Hw(s);if(i){yield i;continue}}yield{type:"non_standard",value:s}}}return Array.from(e())}const TI={translateContent:Pg,translateContentChunk:Pg};function SI(t){return typeof(t==null?void 0:t._getType)=="function"&&typeof t.concat=="function"&&t._getType()==="ai"}function xI(t){return Ep(t)?{type:t.type,mimeType:t.mime_type,url:t.url,metadata:t.metadata}:Tp(t)?{type:t.type,mimeType:t.mime_type??"application/octet-stream",data:t.data,metadata:t.metadata}:Dw(t)?{type:t.type,mimeType:t.mime_type,fileId:t.id,metadata:t.metadata}:t}function kI(t){return t.map(xI)}function II(t){return!!(Ee(t,"image_url")&&Re(t.image_url)||Ee(t,"input_audio")&&Re(t.input_audio)||Ee(t,"file")&&Re(t.file))}function AI(t){if(Ee(t,"image_url")&&Re(t.image_url)&&ae(t.image_url.url)){const e=_o({dataUrl:t.image_url.url});return e?{type:"image",mimeType:e.mime_type,data:e.data}:{type:"image",url:t.image_url.url}}else{if(Ee(t,"input_audio")&&Re(t.input_audio)&&ae(t.input_audio.data)&&ae(t.input_audio.format))return{type:"audio",data:t.input_audio.data,mimeType:`audio/${t.input_audio.format}`};if(Ee(t,"file")&&Re(t.file)&&ae(t.file.data)){const e=_o({dataUrl:t.file.data});if(e)return{type:"file",data:e.data,mimeType:e.mime_type};if(ae(t.file.file_id))return{type:"file",fileId:t.file.file_id}}}return t}function CI(t){const e=[];typeof t.content=="string"?e.push({type:"text",text:t.content}):e.push(...Ip(t.content));for(const n of t.tool_calls??[])e.push({type:"tool_call",id:n.id,name:n.name,args:n.args});return e}function OI(t){const e=[];typeof t.content=="string"?e.push({type:"text",text:t.content}):e.push(...Ip(t.content));for(const n of t.tool_calls??[])e.push({type:"tool_call",id:n.id,name:n.name,args:n.args});return e}function Ip(t){const e=[];for(const n of t)II(n)?e.push(AI(n)):e.push(n);return e}function $I(t){if(t.type==="url_citation"){const{url:e,title:n,start_index:r,end_index:s}=t;return{type:"citation",url:e,title:n,startIndex:r,endIndex:s}}if(t.type==="file_citation"){const{file_id:e,filename:n,index:r}=t;return{type:"citation",title:n,startIndex:r,endIndex:r,fileId:e}}return t}function qw(t){function*e(){var r;Re((r=t.additional_kwargs)==null?void 0:r.reasoning)&&zr(t.additional_kwargs.reasoning.summary)&&(yield{type:"reasoning",reasoning:t.additional_kwargs.reasoning.summary.reduce((i,a)=>Re(a)&&ae(a.text)?`${i}${a.text}`:i,"")});const n=typeof t.content=="string"?[{type:"text",text:t.content}]:t.content;for(const s of n)if(Ee(s,"text")){const{text:i,annotations:a,...o}=s;Array.isArray(a)?yield{...o,type:"text",text:String(i),annotations:a.map($I)}:yield{...o,type:"text",text:String(i)}}for(const s of t.tool_calls??[])yield{type:"tool_call",id:s.id,name:s.name,args:s.args};if(Re(t.additional_kwargs)&&zr(t.additional_kwargs.tool_outputs))for(const s of t.additional_kwargs.tool_outputs){if(Ee(s,"web_search_call")){yield{id:s.id,type:"server_tool_call",name:"web_search",args:{query:s.query}};continue}else if(Ee(s,"file_search_call")){yield{id:s.id,type:"server_tool_call",name:"file_search",args:{query:s.query}};continue}else if(Ee(s,"computer_call")){yield{type:"non_standard",value:s};continue}else if(Ee(s,"code_interpreter_call")){if(ae(s.code)&&(yield{id:s.id,type:"server_tool_call",name:"code_interpreter",args:{code:s.code}}),zr(s.outputs)){const i=wo(()=>{if(s.status!=="in_progress"){if(s.status==="completed")return 0;if(s.status==="incomplete")return 127;if(s.status!=="interpreting"&&s.status==="failed")return 1}});for(const a of s.outputs)if(Ee(a,"logs")){yield{type:"server_tool_call_result",toolCallId:s.id??"",status:"success",output:{type:"code_interpreter_output",returnCode:i??0,stderr:[0,void 0].includes(i)?void 0:String(a.logs),stdout:[0,void 0].includes(i)?String(a.logs):void 0}};continue}}continue}else if(Ee(s,"mcp_call")){yield{id:s.id,type:"server_tool_call",name:"mcp_call",args:s.input};continue}else if(Ee(s,"mcp_list_tools")){yield{id:s.id,type:"server_tool_call",name:"mcp_list_tools",args:s.input};continue}else if(Ee(s,"mcp_approval_request")){yield{type:"non_standard",value:s};continue}else if(Ee(s,"image_generation_call")){yield{type:"non_standard",value:s};continue}Re(s)&&(yield{type:"non_standard",value:s})}}return Array.from(e())}function RI(t){function*e(){yield*qw(t);for(const n of t.tool_call_chunks??[])yield{type:"tool_call_chunk",id:n.id,name:n.name,args:n.args}}return Array.from(e())}const NI={translateContent:t=>typeof t.content=="string"?CI(t):qw(t),translateContentChunk:t=>typeof t.content=="string"?OI(t):RI(t)};function PI(t,e="pretty"){return e==="pretty"?MI(t):JSON.stringify(t)}function MI(t){const e=[],n=` ${t.type.charAt(0).toUpperCase()+t.type.slice(1)} Message `,r=Math.floor((80-n.length)/2),s="=".repeat(r),i=n.length%2===0?s:`${s}=`;if(e.push(`${s}${n}${i}`),t.type==="ai"){const a=t;if(a.tool_calls&&a.tool_calls.length>0){e.push("Tool Calls:");for(const o of a.tool_calls){e.push(`  ${o.name} (${o.id})`),e.push(` Call ID: ${o.id}`),e.push("  Args:");for(const[c,l]of Object.entries(o.args))e.push(`    ${c}: ${typeof l=="object"?JSON.stringify(l):l}`)}}}if(t.type==="tool"){const a=t;a.name&&e.push(`Name: ${a.name}`)}return typeof t.content=="string"&&t.content.trim()&&(e.length>1&&e.push(""),e.push(t.content)),e.join(`
`)}const Ed=Symbol.for("langchain.message");function hs(t,e){return typeof t=="string"?t===""?e:typeof e=="string"?t+e:Array.isArray(e)&&e.length===0?t:Array.isArray(e)&&e.some(n=>Gr(n))?[{type:"text",source_type:"text",text:t},...e]:[{type:"text",text:t},...e]:Array.isArray(e)?Yo(t,e)??[...t,...e]:e===""?t:Array.isArray(t)&&t.some(n=>Gr(n))?[...t,{type:"file",source_type:"text",text:e}]:[...t,{type:"text",text:e}]}function Jw(t,e){return t==="error"||e==="error"?"error":"success"}function LI(t,e){function n(r,s){if(typeof r!="object"||r===null||r===void 0)return r;if(s>=e)return Array.isArray(r)?"[Array]":"[Object]";if(Array.isArray(r))return r.map(a=>n(a,s+1));const i={};for(const a of Object.keys(r))i[a]=n(r[a],s+1);return i}return JSON.stringify(n(t,0),null,2)}var xw,Cn=class extends cr{constructor(e){const n=typeof e=="string"||Array.isArray(e)?{content:e}:e;n.additional_kwargs||(n.additional_kwargs={}),n.response_metadata||(n.response_metadata={});super(n);p(this,"lc_namespace",["langchain_core","messages"]);p(this,"lc_serializable",!0);p(this,xw,!0);p(this,"id");p(this,"name");p(this,"content");p(this,"additional_kwargs");p(this,"response_metadata");this.name=n.name,n.content===void 0&&n.contentBlocks!==void 0?(this.content=n.contentBlocks,this.response_metadata={output_version:"v1",...n.response_metadata}):n.content!==void 0?(this.content=n.content??[],this.response_metadata=n.response_metadata):(this.content=[],this.response_metadata=n.response_metadata),this.additional_kwargs=n.additional_kwargs,this.id=n.id}get lc_aliases(){return{additional_kwargs:"additional_kwargs",response_metadata:"response_metadata"}}_getType(){return this.type}getType(){return this._getType()}get text(){return typeof this.content=="string"?this.content:Array.isArray(this.content)?this.content.map(e=>typeof e=="string"?e:e.type==="text"?e.text:"").join(""):""}get contentBlocks(){const e=typeof this.content=="string"?[{type:"text",text:this.content}]:this.content;return[kI,Ip,EI].reduce((s,i)=>i(s),e)}toDict(){return{type:this.getType(),data:this.toJSON().kwargs}}static lc_name(){return"BaseMessage"}get _printableFields(){return{id:this.id,content:this.content,name:this.name,additional_kwargs:this.additional_kwargs,response_metadata:this.response_metadata}}static isInstance(e){return typeof e=="object"&&e!==null&&Ed in e&&e[Ed]===!0&&Fw(e)}_updateId(e){this.id=e,this.lc_kwargs.id=e}get[(xw=Ed,Symbol.toStringTag)](){return this.constructor.lc_name()}[Symbol.for("nodejs.util.inspect.custom")](e){if(e===null)return this;const n=LI(this._printableFields,Math.max(4,e));return`${this.constructor.lc_name()} ${n}`}toFormattedString(e="pretty"){return PI(this,e)}};function jI(t){return Array.isArray(t)&&t.every(e=>typeof e.index=="number")}function un(t={},e={}){const n={...t};for(const[r,s]of Object.entries(e))if(n[r]==null)n[r]=s;else{if(s==null)continue;if(typeof n[r]!=typeof s||Array.isArray(n[r])!==Array.isArray(s))throw new Error(`field[${r}] already exists in the message chunk, but with a different type.`);if(typeof n[r]=="string"){if(r==="type")continue;["id","name","output_version","model_provider"].includes(r)?s&&(n[r]=s):n[r]+=s}else if(typeof n[r]=="object"&&!Array.isArray(n[r]))n[r]=un(n[r],s);else if(Array.isArray(n[r]))n[r]=Yo(n[r],s);else{if(n[r]===s)continue;console.warn(`field[${r}] already exists in this message chunk and value has unsupported type.`)}}return n}function Yo(t,e){if(!(t===void 0&&e===void 0)){if(t===void 0||e===void 0)return t||e;{const n=[...t];for(const r of e)if(typeof r=="object"&&r!==null&&"index"in r&&typeof r.index=="number"){const s=n.findIndex(i=>{const a=typeof i=="object",o="index"in i&&i.index===r.index,c="id"in i&&"id"in r&&(i==null?void 0:i.id)===(r==null?void 0:r.id),l=!("id"in i)||!(i!=null&&i.id)||!("id"in r)||!(r!=null&&r.id);return a&&o&&(c||l)});s!==-1&&typeof n[s]=="object"&&n[s]!==null?n[s]=un(n[s],r):n.push(r)}else{if(typeof r=="object"&&r!==null&&"text"in r&&r.text==="")continue;n.push(r)}return n}}}function Kw(t,e){if(!(t===void 0&&e===void 0)){if(t===void 0||e===void 0)return t??e;if(typeof t!=typeof e)throw new Error(`Cannot merge objects of different types.
Left ${typeof t}
Right ${typeof e}`);if(typeof t=="string"&&typeof e=="string")return t+e;if(Array.isArray(t)&&Array.isArray(e))return Yo(t,e);if(typeof t=="object"&&typeof e=="object")return un(t,e);if(t===e)return t;throw new Error(`Can not merge objects of different types.
Left ${t}
Right ${e}`)}}var ws=class Xw extends Cn{static isInstance(e){if(!super.isInstance(e))return!1;let n=Object.getPrototypeOf(e);for(;n!==null;){if(n===Xw.prototype)return!0;n=Object.getPrototypeOf(n)}return!1}};function Yw(t){return typeof t.role=="string"}function Yt(t){return typeof(t==null?void 0:t._getType)=="function"}function vo(t){return ws.isInstance(t)}function Qw(t,e){return un(t??{},e??{})}function ev(t,e){const n={};return((t==null?void 0:t.audio)!==void 0||(e==null?void 0:e.audio)!==void 0)&&(n.audio=((t==null?void 0:t.audio)??0)+((e==null?void 0:e.audio)??0)),((t==null?void 0:t.image)!==void 0||(e==null?void 0:e.image)!==void 0)&&(n.image=((t==null?void 0:t.image)??0)+((e==null?void 0:e.image)??0)),((t==null?void 0:t.video)!==void 0||(e==null?void 0:e.video)!==void 0)&&(n.video=((t==null?void 0:t.video)??0)+((e==null?void 0:e.video)??0)),((t==null?void 0:t.document)!==void 0||(e==null?void 0:e.document)!==void 0)&&(n.document=((t==null?void 0:t.document)??0)+((e==null?void 0:e.document)??0)),((t==null?void 0:t.text)!==void 0||(e==null?void 0:e.text)!==void 0)&&(n.text=((t==null?void 0:t.text)??0)+((e==null?void 0:e.text)??0)),n}function DI(t,e){const n={...ev(t,e)};return((t==null?void 0:t.cache_read)!==void 0||(e==null?void 0:e.cache_read)!==void 0)&&(n.cache_read=((t==null?void 0:t.cache_read)??0)+((e==null?void 0:e.cache_read)??0)),((t==null?void 0:t.cache_creation)!==void 0||(e==null?void 0:e.cache_creation)!==void 0)&&(n.cache_creation=((t==null?void 0:t.cache_creation)??0)+((e==null?void 0:e.cache_creation)??0)),n}function UI(t,e){const n={...ev(t,e)};return((t==null?void 0:t.reasoning)!==void 0||(e==null?void 0:e.reasoning)!==void 0)&&(n.reasoning=((t==null?void 0:t.reasoning)??0)+((e==null?void 0:e.reasoning)??0)),n}function Ap(t,e){return{input_tokens:((t==null?void 0:t.input_tokens)??0)+((e==null?void 0:e.input_tokens)??0),output_tokens:((t==null?void 0:t.output_tokens)??0)+((e==null?void 0:e.output_tokens)??0),total_tokens:((t==null?void 0:t.total_tokens)??0)+((e==null?void 0:e.total_tokens)??0),input_token_details:DI(t==null?void 0:t.input_token_details,e==null?void 0:e.input_token_details),output_token_details:UI(t==null?void 0:t.output_token_details,e==null?void 0:e.output_token_details)}}var tv={};Se(tv,{ToolMessage:()=>Pe,ToolMessageChunk:()=>Aa,defaultToolCallParser:()=>Op,isDirectToolOutput:()=>Cp,isToolMessage:()=>$p,isToolMessageChunk:()=>nv});function Cp(t){return t!=null&&typeof t=="object"&&"lc_direct_tool_output"in t&&t.lc_direct_tool_output===!0}var Pe=class extends Cn{constructor(e,n,r){const s=typeof e=="string"||Array.isArray(e)?{content:e,name:r,tool_call_id:n}:e;super(s);p(this,"lc_direct_tool_output",!0);p(this,"type","tool");p(this,"status");p(this,"tool_call_id");p(this,"metadata");p(this,"artifact");this.tool_call_id=s.tool_call_id,this.artifact=s.artifact,this.status=s.status,this.metadata=s.metadata}static lc_name(){return"ToolMessage"}get lc_aliases(){return{tool_call_id:"tool_call_id"}}static isInstance(e){return super.isInstance(e)&&e.type==="tool"}get _printableFields(){return{...super._printableFields,tool_call_id:this.tool_call_id,artifact:this.artifact}}},Aa=class extends ws{constructor(e){super(e);p(this,"type","tool");p(this,"tool_call_id");p(this,"status");p(this,"artifact");this.tool_call_id=e.tool_call_id,this.artifact=e.artifact,this.status=e.status}static lc_name(){return"ToolMessageChunk"}concat(e){const n=this.constructor;return new n({content:hs(this.content,e.content),additional_kwargs:un(this.additional_kwargs,e.additional_kwargs),response_metadata:un(this.response_metadata,e.response_metadata),artifact:Kw(this.artifact,e.artifact),tool_call_id:this.tool_call_id,id:this.id??e.id,status:Jw(this.status,e.status)})}get _printableFields(){return{...super._printableFields,tool_call_id:this.tool_call_id,artifact:this.artifact}}};function Op(t){const e=[],n=[];for(const r of t)if(r.function){const s=r.function.name;try{const i=JSON.parse(r.function.arguments);e.push({name:s||"",args:i||{},id:r.id})}catch{n.push({name:s,args:r.function.arguments,id:r.id,error:"Malformed args."})}}else continue;return[e,n]}function $p(t){return typeof t=="object"&&t!==null&&"getType"in t&&typeof t.getType=="function"&&t.getType()==="tool"}function nv(t){return t._getType()==="tool"}var vs=class rv extends Cn{constructor(n,r){(typeof n=="string"||Array.isArray(n))&&(n={content:n,role:r});super(n);p(this,"type","generic");p(this,"role");this.role=n.role}static lc_name(){return"ChatMessage"}static _chatMessageClass(){return rv}static isInstance(n){return super.isInstance(n)&&n.type==="generic"}get _printableFields(){return{...super._printableFields,role:this.role}}},Qo=class extends ws{constructor(e,n){(typeof e=="string"||Array.isArray(e))&&(e={content:e,role:n});super(e);p(this,"type","generic");p(this,"role");this.role=e.role}static lc_name(){return"ChatMessageChunk"}concat(e){const n=this.constructor;return new n({content:hs(this.content,e.content),additional_kwargs:un(this.additional_kwargs,e.additional_kwargs),response_metadata:un(this.response_metadata,e.response_metadata),role:this.role,id:this.id??e.id})}static isInstance(e){return super.isInstance(e)&&e.type==="generic"}get _printableFields(){return{...super._printableFields,role:this.role}}};function FI(t){return t._getType()==="generic"}function BI(t){return t._getType()==="generic"}var Cu=class extends Cn{constructor(e){super(e);p(this,"type","function");p(this,"name");this.name=e.name}static lc_name(){return"FunctionMessage"}},ec=class extends ws{constructor(){super(...arguments);p(this,"type","function")}static lc_name(){return"FunctionMessageChunk"}concat(e){const n=this.constructor;return new n({content:hs(this.content,e.content),additional_kwargs:un(this.additional_kwargs,e.additional_kwargs),response_metadata:un(this.response_metadata,e.response_metadata),name:this.name??"",id:this.id??e.id})}};function zI(t){return t._getType()==="function"}function ZI(t){return t._getType()==="function"}var ht=class extends Cn{constructor(e){super(e);p(this,"type","human")}static lc_name(){return"HumanMessage"}static isInstance(e){return super.isInstance(e)&&e.type==="human"}},Ca=class extends ws{constructor(e){super(e);p(this,"type","human")}static lc_name(){return"HumanMessageChunk"}concat(e){const n=this.constructor;return new n({content:hs(this.content,e.content),additional_kwargs:un(this.additional_kwargs,e.additional_kwargs),response_metadata:un(this.response_metadata,e.response_metadata),id:this.id??e.id})}static isInstance(e){return super.isInstance(e)&&e.type==="human"}};function VI(t){return t.getType()==="human"}function GI(t){return t.getType()==="human"}var Us=class extends Cn{constructor(e){super({...e,content:[]});p(this,"type","remove");p(this,"id");this.id=e.id}get _printableFields(){return{...super._printableFields,id:this.id}}static isInstance(e){return super.isInstance(e)&&e.type==="remove"}},kt=class rl extends Cn{constructor(n){super(n);p(this,"type","system")}static lc_name(){return"SystemMessage"}concat(n){if(typeof n=="string")return new rl({...this,content:hs(this.content,n)});if(rl.isInstance(n))return new rl({...this,additional_kwargs:{...this.additional_kwargs,...n.additional_kwargs},response_metadata:{...this.response_metadata,...n.response_metadata},content:hs(this.content,n.content)});throw new Error("Unexpected chunk type for system message")}static isInstance(n){return super.isInstance(n)&&n.type==="system"}},fs=class extends ws{constructor(e){super(e);p(this,"type","system")}static lc_name(){return"SystemMessageChunk"}concat(e){const n=this.constructor;return new n({content:hs(this.content,e.content),additional_kwargs:un(this.additional_kwargs,e.additional_kwargs),response_metadata:un(this.response_metadata,e.response_metadata),id:this.id??e.id})}static isInstance(e){return super.isInstance(e)&&e.type==="system"}};function WI(t){return t._getType()==="system"}function HI(t){return t._getType()==="system"}function Ou(t,e){return t.lc_error_code=e,t.message=`${t.message}

Troubleshooting URL: https://docs.langchain.com/oss/javascript/langchain/errors/${e}/
`,t}function so(t){return!!(t&&typeof t=="object"&&"type"in t&&t.type==="tool_call")}function qI(t){return!!(t&&typeof t=="object"&&"toolCall"in t&&t.toolCall!=null&&typeof t.toolCall=="object"&&"id"in t.toolCall&&typeof t.toolCall.id=="string")}var bo=class extends Error{constructor(e,n){super(e);p(this,"output");this.output=n}};function Dh(t,e=fa){t=t.trim();const n=t.indexOf("```");if(n===-1)return e(t);let r=t.substring(n+3);r.startsWith(`json
`)?r=r.substring(5):r.startsWith("json")?r=r.substring(4):r.startsWith(`
`)&&(r=r.substring(1));const s=r.indexOf("```");let i=r;return s!==-1&&(i=r.substring(0,s)),e(i.trim())}function JI(t){try{return JSON.parse(t)}catch{}const e=t.trim();if(e.length===0)throw new Error("Unexpected end of JSON input");let n=0;function r(){for(;n<e.length&&/\s/.test(e[n]);)n+=1}function s(){if(e[n]!=='"')throw new Error(`Expected '"' at position ${n}, got '${e[n]}'`);n+=1;let u="",d=!1;for(;n<e.length;){const h=e[n];if(d){if(h==="n")u+=`
`;else if(h==="t")u+="	";else if(h==="r")u+="\r";else if(h==="\\")u+="\\";else if(h==='"')u+='"';else if(h==="b")u+="\b";else if(h==="f")u+="\f";else if(h==="/")u+="/";else if(h==="u"){const f=e.substring(n+1,n+5);if(/^[0-9A-Fa-f]{0,4}$/.test(f))f.length===4?u+=String.fromCharCode(Number.parseInt(f,16)):u+=`u${f}`,n+=f.length;else throw new Error(`Invalid unicode escape sequence '\\u${f}' at position ${n}`)}else throw new Error(`Invalid escape sequence '\\${h}' at position ${n}`);d=!1}else if(h==="\\")d=!0;else{if(h==='"')return n+=1,u;u+=h}n+=1}return d&&(u+="\\"),u}function i(){const u=n;let d="";if(e[n]==="-"&&(d+="-",n+=1),n<e.length&&e[n]==="0"&&(d+="0",n+=1,e[n]>="0"&&e[n]<="9"))throw new Error(`Invalid number at position ${u}`);if(n<e.length&&e[n]>="1"&&e[n]<="9")for(;n<e.length&&e[n]>="0"&&e[n]<="9";)d+=e[n],n+=1;if(n<e.length&&e[n]===".")for(d+=".",n+=1;n<e.length&&e[n]>="0"&&e[n]<="9";)d+=e[n],n+=1;if(n<e.length&&(e[n]==="e"||e[n]==="E"))for(d+=e[n],n+=1,n<e.length&&(e[n]==="+"||e[n]==="-")&&(d+=e[n],n+=1);n<e.length&&e[n]>="0"&&e[n]<="9";)d+=e[n],n+=1;if(d==="-")return-0;const h=Number.parseFloat(d);if(Number.isNaN(h))throw n=u,new Error(`Invalid number '${d}' at position ${u}`);return h}function a(){if(r(),n>=e.length)throw new Error(`Unexpected end of input at position ${n}`);const u=e[n];if(u==="{")return c();if(u==="[")return o();if(u==='"')return s();if("null".startsWith(e.substring(n,n+4)))return n+=Math.min(4,e.length-n),null;if("true".startsWith(e.substring(n,n+4)))return n+=Math.min(4,e.length-n),!0;if("false".startsWith(e.substring(n,n+5)))return n+=Math.min(5,e.length-n),!1;if(u==="-"||u>="0"&&u<="9")return i();throw new Error(`Unexpected character '${u}' at position ${n}`)}function o(){if(e[n]!=="[")throw new Error(`Expected '[' at position ${n}, got '${e[n]}'`);const u=[];if(n+=1,r(),n>=e.length)return u;if(e[n]==="]")return n+=1,u;for(;n<e.length;){if(r(),n>=e.length||(u.push(a()),r(),n>=e.length))return u;if(e[n]==="]")return n+=1,u;if(e[n]===","){n+=1;continue}throw new Error(`Expected ',' or ']' at position ${n}, got '${e[n]}'`)}return u}function c(){if(e[n]!=="{")throw new Error(`Expected '{' at position ${n}, got '${e[n]}'`);const u={};if(n+=1,r(),n>=e.length)return u;if(e[n]==="}")return n+=1,u;for(;n<e.length;){if(r(),n>=e.length)return u;const d=s();if(r(),n>=e.length)return u;if(e[n]!==":")throw new Error(`Expected ':' at position ${n}, got '${e[n]}'`);if(n+=1,r(),n>=e.length||(u[d]=a(),r(),n>=e.length))return u;if(e[n]==="}")return n+=1,u;if(e[n]===","){n+=1;continue}throw new Error(`Expected ',' or '}' at position ${n}, got '${e[n]}'`)}return u}const l=a();if(r(),n<e.length)throw new Error(`Unexpected character '${e[n]}' at position ${n}`);return l}function fa(t){try{return typeof t>"u"?null:JI(t)}catch{return null}}var sv={},$u={};$u.byteLength=YI;$u.toByteArray=eA;$u.fromByteArray=rA;var Lr=[],er=[],KI=typeof Uint8Array<"u"?Uint8Array:Array,Td="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(var Di=0,XI=Td.length;Di<XI;++Di)Lr[Di]=Td[Di],er[Td.charCodeAt(Di)]=Di;er[45]=62;er[95]=63;function iv(t){var e=t.length;if(e%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var n=t.indexOf("=");n===-1&&(n=e);var r=n===e?0:4-n%4;return[n,r]}function YI(t){var e=iv(t),n=e[0],r=e[1];return(n+r)*3/4-r}function QI(t,e,n){return(e+n)*3/4-n}function eA(t){var e,n=iv(t),r=n[0],s=n[1],i=new KI(QI(t,r,s)),a=0,o=s>0?r-4:r,c;for(c=0;c<o;c+=4)e=er[t.charCodeAt(c)]<<18|er[t.charCodeAt(c+1)]<<12|er[t.charCodeAt(c+2)]<<6|er[t.charCodeAt(c+3)],i[a++]=e>>16&255,i[a++]=e>>8&255,i[a++]=e&255;return s===2&&(e=er[t.charCodeAt(c)]<<2|er[t.charCodeAt(c+1)]>>4,i[a++]=e&255),s===1&&(e=er[t.charCodeAt(c)]<<10|er[t.charCodeAt(c+1)]<<4|er[t.charCodeAt(c+2)]>>2,i[a++]=e>>8&255,i[a++]=e&255),i}function tA(t){return Lr[t>>18&63]+Lr[t>>12&63]+Lr[t>>6&63]+Lr[t&63]}function nA(t,e,n){for(var r,s=[],i=e;i<n;i+=3)r=(t[i]<<16&16711680)+(t[i+1]<<8&65280)+(t[i+2]&255),s.push(tA(r));return s.join("")}function rA(t){for(var e,n=t.length,r=n%3,s=[],i=16383,a=0,o=n-r;a<o;a+=i)s.push(nA(t,a,a+i>o?o:a+i));return r===1?(e=t[n-1],s.push(Lr[e>>2]+Lr[e<<4&63]+"==")):r===2&&(e=(t[n-2]<<8)+t[n-1],s.push(Lr[e>>10]+Lr[e>>4&63]+Lr[e<<2&63]+"=")),s.join("")}var Rp={};/*! ieee754. BSD-3-Clause License. Feross Aboukhadijeh <https://feross.org/opensource> */Rp.read=function(t,e,n,r,s){var i,a,o=s*8-r-1,c=(1<<o)-1,l=c>>1,u=-7,d=n?s-1:0,h=n?-1:1,f=t[e+d];for(d+=h,i=f&(1<<-u)-1,f>>=-u,u+=o;u>0;i=i*256+t[e+d],d+=h,u-=8);for(a=i&(1<<-u)-1,i>>=-u,u+=r;u>0;a=a*256+t[e+d],d+=h,u-=8);if(i===0)i=1-l;else{if(i===c)return a?NaN:(f?-1:1)*(1/0);a=a+Math.pow(2,r),i=i-l}return(f?-1:1)*a*Math.pow(2,i-r)};Rp.write=function(t,e,n,r,s,i){var a,o,c,l=i*8-s-1,u=(1<<l)-1,d=u>>1,h=s===23?Math.pow(2,-24)-Math.pow(2,-77):0,f=r?0:i-1,m=r?1:-1,g=e<0||e===0&&1/e<0?1:0;for(e=Math.abs(e),isNaN(e)||e===1/0?(o=isNaN(e)?1:0,a=u):(a=Math.floor(Math.log(e)/Math.LN2),e*(c=Math.pow(2,-a))<1&&(a--,c*=2),a+d>=1?e+=h/c:e+=h*Math.pow(2,1-d),e*c>=2&&(a++,c/=2),a+d>=u?(o=0,a=u):a+d>=1?(o=(e*c-1)*Math.pow(2,s),a=a+d):(o=e*Math.pow(2,d-1)*Math.pow(2,s),a=0));s>=8;t[n+f]=o&255,f+=m,o/=256,s-=8);for(a=a<<s|o,l+=s;l>0;t[n+f]=a&255,f+=m,a/=256,l-=8);t[n+f-m]|=g*128};/*!
 * The buffer module from node.js, for the browser.
 *
 * @author   Feross Aboukhadijeh <https://feross.org>
 * @license  MIT
 */(function(t){const e=$u,n=Rp,r=typeof Symbol=="function"&&typeof Symbol.for=="function"?Symbol.for("nodejs.util.inspect.custom"):null;t.Buffer=u,t.SlowBuffer=A,t.INSPECT_MAX_BYTES=50;const s=2147483647;t.kMaxLength=s;const{Uint8Array:i,ArrayBuffer:a,SharedArrayBuffer:o}=globalThis;u.TYPED_ARRAY_SUPPORT=c(),!u.TYPED_ARRAY_SUPPORT&&typeof console<"u"&&typeof console.error=="function"&&console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support.");function c(){try{const k=new i(1),_={foo:function(){return 42}};return Object.setPrototypeOf(_,i.prototype),Object.setPrototypeOf(k,_),k.foo()===42}catch{return!1}}Object.defineProperty(u.prototype,"parent",{enumerable:!0,get:function(){if(u.isBuffer(this))return this.buffer}}),Object.defineProperty(u.prototype,"offset",{enumerable:!0,get:function(){if(u.isBuffer(this))return this.byteOffset}});function l(k){if(k>s)throw new RangeError('The value "'+k+'" is invalid for option "size"');const _=new i(k);return Object.setPrototypeOf(_,u.prototype),_}function u(k,_,E){if(typeof k=="number"){if(typeof _=="string")throw new TypeError('The "string" argument must be of type string. Received type number');return m(k)}return d(k,_,E)}u.poolSize=8192;function d(k,_,E){if(typeof k=="string")return g(k,_);if(a.isView(k))return b(k);if(k==null)throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof k);if(ee(k,a)||k&&ee(k.buffer,a)||typeof o<"u"&&(ee(k,o)||k&&ee(k.buffer,o)))return y(k,_,E);if(typeof k=="number")throw new TypeError('The "value" argument must not be of type number. Received type number');const O=k.valueOf&&k.valueOf();if(O!=null&&O!==k)return u.from(O,_,E);const R=v(k);if(R)return R;if(typeof Symbol<"u"&&Symbol.toPrimitive!=null&&typeof k[Symbol.toPrimitive]=="function")return u.from(k[Symbol.toPrimitive]("string"),_,E);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof k)}u.from=function(k,_,E){return d(k,_,E)},Object.setPrototypeOf(u.prototype,i.prototype),Object.setPrototypeOf(u,i);function h(k){if(typeof k!="number")throw new TypeError('"size" argument must be of type number');if(k<0)throw new RangeError('The value "'+k+'" is invalid for option "size"')}function f(k,_,E){return h(k),k<=0?l(k):_!==void 0?typeof E=="string"?l(k).fill(_,E):l(k).fill(_):l(k)}u.alloc=function(k,_,E){return f(k,_,E)};function m(k){return h(k),l(k<0?0:T(k)|0)}u.allocUnsafe=function(k){return m(k)},u.allocUnsafeSlow=function(k){return m(k)};function g(k,_){if((typeof _!="string"||_==="")&&(_="utf8"),!u.isEncoding(_))throw new TypeError("Unknown encoding: "+_);const E=I(k,_)|0;let O=l(E);const R=O.write(k,_);return R!==E&&(O=O.slice(0,R)),O}function w(k){const _=k.length<0?0:T(k.length)|0,E=l(_);for(let O=0;O<_;O+=1)E[O]=k[O]&255;return E}function b(k){if(ee(k,i)){const _=new i(k);return y(_.buffer,_.byteOffset,_.byteLength)}return w(k)}function y(k,_,E){if(_<0||k.byteLength<_)throw new RangeError('"offset" is outside of buffer bounds');if(k.byteLength<_+(E||0))throw new RangeError('"length" is outside of buffer bounds');let O;return _===void 0&&E===void 0?O=new i(k):E===void 0?O=new i(k,_):O=new i(k,_,E),Object.setPrototypeOf(O,u.prototype),O}function v(k){if(u.isBuffer(k)){const _=T(k.length)|0,E=l(_);return E.length===0||k.copy(E,0,0,_),E}if(k.length!==void 0)return typeof k.length!="number"||Y(k.length)?l(0):w(k);if(k.type==="Buffer"&&Array.isArray(k.data))return w(k.data)}function T(k){if(k>=s)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+s.toString(16)+" bytes");return k|0}function A(k){return+k!=k&&(k=0),u.alloc(+k)}u.isBuffer=function(_){return _!=null&&_._isBuffer===!0&&_!==u.prototype},u.compare=function(_,E){if(ee(_,i)&&(_=u.from(_,_.offset,_.byteLength)),ee(E,i)&&(E=u.from(E,E.offset,E.byteLength)),!u.isBuffer(_)||!u.isBuffer(E))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(_===E)return 0;let O=_.length,R=E.length;for(let D=0,Z=Math.min(O,R);D<Z;++D)if(_[D]!==E[D]){O=_[D],R=E[D];break}return O<R?-1:R<O?1:0},u.isEncoding=function(_){switch(String(_).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},u.concat=function(_,E){if(!Array.isArray(_))throw new TypeError('"list" argument must be an Array of Buffers');if(_.length===0)return u.alloc(0);let O;if(E===void 0)for(E=0,O=0;O<_.length;++O)E+=_[O].length;const R=u.allocUnsafe(E);let D=0;for(O=0;O<_.length;++O){let Z=_[O];if(ee(Z,i))D+Z.length>R.length?(u.isBuffer(Z)||(Z=u.from(Z)),Z.copy(R,D)):i.prototype.set.call(R,Z,D);else if(u.isBuffer(Z))Z.copy(R,D);else throw new TypeError('"list" argument must be an Array of Buffers');D+=Z.length}return R};function I(k,_){if(u.isBuffer(k))return k.length;if(a.isView(k)||ee(k,a))return k.byteLength;if(typeof k!="string")throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof k);const E=k.length,O=arguments.length>2&&arguments[2]===!0;if(!O&&E===0)return 0;let R=!1;for(;;)switch(_){case"ascii":case"latin1":case"binary":return E;case"utf8":case"utf-8":return Q(k).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return E*2;case"hex":return E>>>1;case"base64":return me(k).length;default:if(R)return O?-1:Q(k).length;_=(""+_).toLowerCase(),R=!0}}u.byteLength=I;function $(k,_,E){let O=!1;if((_===void 0||_<0)&&(_=0),_>this.length||((E===void 0||E>this.length)&&(E=this.length),E<=0)||(E>>>=0,_>>>=0,E<=_))return"";for(k||(k="utf8");;)switch(k){case"hex":return K(this,_,E);case"utf8":case"utf-8":return oe(this,_,E);case"ascii":return ye(this,_,E);case"latin1":case"binary":return Ne(this,_,E);case"base64":return H(this,_,E);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return re(this,_,E);default:if(O)throw new TypeError("Unknown encoding: "+k);k=(k+"").toLowerCase(),O=!0}}u.prototype._isBuffer=!0;function S(k,_,E){const O=k[_];k[_]=k[E],k[E]=O}u.prototype.swap16=function(){const _=this.length;if(_%2!==0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(let E=0;E<_;E+=2)S(this,E,E+1);return this},u.prototype.swap32=function(){const _=this.length;if(_%4!==0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(let E=0;E<_;E+=4)S(this,E,E+3),S(this,E+1,E+2);return this},u.prototype.swap64=function(){const _=this.length;if(_%8!==0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(let E=0;E<_;E+=8)S(this,E,E+7),S(this,E+1,E+6),S(this,E+2,E+5),S(this,E+3,E+4);return this},u.prototype.toString=function(){const _=this.length;return _===0?"":arguments.length===0?oe(this,0,_):$.apply(this,arguments)},u.prototype.toLocaleString=u.prototype.toString,u.prototype.equals=function(_){if(!u.isBuffer(_))throw new TypeError("Argument must be a Buffer");return this===_?!0:u.compare(this,_)===0},u.prototype.inspect=function(){let _="";const E=t.INSPECT_MAX_BYTES;return _=this.toString("hex",0,E).replace(/(.{2})/g,"$1 ").trim(),this.length>E&&(_+=" ... "),"<Buffer "+_+">"},r&&(u.prototype[r]=u.prototype.inspect),u.prototype.compare=function(_,E,O,R,D){if(ee(_,i)&&(_=u.from(_,_.offset,_.byteLength)),!u.isBuffer(_))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof _);if(E===void 0&&(E=0),O===void 0&&(O=_?_.length:0),R===void 0&&(R=0),D===void 0&&(D=this.length),E<0||O>_.length||R<0||D>this.length)throw new RangeError("out of range index");if(R>=D&&E>=O)return 0;if(R>=D)return-1;if(E>=O)return 1;if(E>>>=0,O>>>=0,R>>>=0,D>>>=0,this===_)return 0;let Z=D-R,ze=O-E;const _t=Math.min(Z,ze),lt=this.slice(R,D),wt=_.slice(E,O);for(let st=0;st<_t;++st)if(lt[st]!==wt[st]){Z=lt[st],ze=wt[st];break}return Z<ze?-1:ze<Z?1:0};function M(k,_,E,O,R){if(k.length===0)return-1;if(typeof E=="string"?(O=E,E=0):E>2147483647?E=2147483647:E<-2147483648&&(E=-2147483648),E=+E,Y(E)&&(E=R?0:k.length-1),E<0&&(E=k.length+E),E>=k.length){if(R)return-1;E=k.length-1}else if(E<0)if(R)E=0;else return-1;if(typeof _=="string"&&(_=u.from(_,O)),u.isBuffer(_))return _.length===0?-1:j(k,_,E,O,R);if(typeof _=="number")return _=_&255,typeof i.prototype.indexOf=="function"?R?i.prototype.indexOf.call(k,_,E):i.prototype.lastIndexOf.call(k,_,E):j(k,[_],E,O,R);throw new TypeError("val must be string, number or Buffer")}function j(k,_,E,O,R){let D=1,Z=k.length,ze=_.length;if(O!==void 0&&(O=String(O).toLowerCase(),O==="ucs2"||O==="ucs-2"||O==="utf16le"||O==="utf-16le")){if(k.length<2||_.length<2)return-1;D=2,Z/=2,ze/=2,E/=2}function _t(wt,st){return D===1?wt[st]:wt.readUInt16BE(st*D)}let lt;if(R){let wt=-1;for(lt=E;lt<Z;lt++)if(_t(k,lt)===_t(_,wt===-1?0:lt-wt)){if(wt===-1&&(wt=lt),lt-wt+1===ze)return wt*D}else wt!==-1&&(lt-=lt-wt),wt=-1}else for(E+ze>Z&&(E=Z-ze),lt=E;lt>=0;lt--){let wt=!0;for(let st=0;st<ze;st++)if(_t(k,lt+st)!==_t(_,st)){wt=!1;break}if(wt)return lt}return-1}u.prototype.includes=function(_,E,O){return this.indexOf(_,E,O)!==-1},u.prototype.indexOf=function(_,E,O){return M(this,_,E,O,!0)},u.prototype.lastIndexOf=function(_,E,O){return M(this,_,E,O,!1)};function P(k,_,E,O){E=Number(E)||0;const R=k.length-E;O?(O=Number(O),O>R&&(O=R)):O=R;const D=_.length;O>D/2&&(O=D/2);let Z;for(Z=0;Z<O;++Z){const ze=parseInt(_.substr(Z*2,2),16);if(Y(ze))return Z;k[E+Z]=ze}return Z}function W(k,_,E,O){return xe(Q(_,k.length-E),k,E,O)}function ne(k,_,E,O){return xe(Jr(_),k,E,O)}function B(k,_,E,O){return xe(me(_),k,E,O)}function V(k,_,E,O){return xe(ke(_,k.length-E),k,E,O)}u.prototype.write=function(_,E,O,R){if(E===void 0)R="utf8",O=this.length,E=0;else if(O===void 0&&typeof E=="string")R=E,O=this.length,E=0;else if(isFinite(E))E=E>>>0,isFinite(O)?(O=O>>>0,R===void 0&&(R="utf8")):(R=O,O=void 0);else throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");const D=this.length-E;if((O===void 0||O>D)&&(O=D),_.length>0&&(O<0||E<0)||E>this.length)throw new RangeError("Attempt to write outside buffer bounds");R||(R="utf8");let Z=!1;for(;;)switch(R){case"hex":return P(this,_,E,O);case"utf8":case"utf-8":return W(this,_,E,O);case"ascii":case"latin1":case"binary":return ne(this,_,E,O);case"base64":return B(this,_,E,O);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return V(this,_,E,O);default:if(Z)throw new TypeError("Unknown encoding: "+R);R=(""+R).toLowerCase(),Z=!0}},u.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};function H(k,_,E){return _===0&&E===k.length?e.fromByteArray(k):e.fromByteArray(k.slice(_,E))}function oe(k,_,E){E=Math.min(k.length,E);const O=[];let R=_;for(;R<E;){const D=k[R];let Z=null,ze=D>239?4:D>223?3:D>191?2:1;if(R+ze<=E){let _t,lt,wt,st;switch(ze){case 1:D<128&&(Z=D);break;case 2:_t=k[R+1],(_t&192)===128&&(st=(D&31)<<6|_t&63,st>127&&(Z=st));break;case 3:_t=k[R+1],lt=k[R+2],(_t&192)===128&&(lt&192)===128&&(st=(D&15)<<12|(_t&63)<<6|lt&63,st>2047&&(st<55296||st>57343)&&(Z=st));break;case 4:_t=k[R+1],lt=k[R+2],wt=k[R+3],(_t&192)===128&&(lt&192)===128&&(wt&192)===128&&(st=(D&15)<<18|(_t&63)<<12|(lt&63)<<6|wt&63,st>65535&&st<1114112&&(Z=st))}}Z===null?(Z=65533,ze=1):Z>65535&&(Z-=65536,O.push(Z>>>10&1023|55296),Z=56320|Z&1023),O.push(Z),R+=ze}return se(O)}const fe=4096;function se(k){const _=k.length;if(_<=fe)return String.fromCharCode.apply(String,k);let E="",O=0;for(;O<_;)E+=String.fromCharCode.apply(String,k.slice(O,O+=fe));return E}function ye(k,_,E){let O="";E=Math.min(k.length,E);for(let R=_;R<E;++R)O+=String.fromCharCode(k[R]&127);return O}function Ne(k,_,E){let O="";E=Math.min(k.length,E);for(let R=_;R<E;++R)O+=String.fromCharCode(k[R]);return O}function K(k,_,E){const O=k.length;(!_||_<0)&&(_=0),(!E||E<0||E>O)&&(E=O);let R="";for(let D=_;D<E;++D)R+=Ie[k[D]];return R}function re(k,_,E){const O=k.slice(_,E);let R="";for(let D=0;D<O.length-1;D+=2)R+=String.fromCharCode(O[D]+O[D+1]*256);return R}u.prototype.slice=function(_,E){const O=this.length;_=~~_,E=E===void 0?O:~~E,_<0?(_+=O,_<0&&(_=0)):_>O&&(_=O),E<0?(E+=O,E<0&&(E=0)):E>O&&(E=O),E<_&&(E=_);const R=this.subarray(_,E);return Object.setPrototypeOf(R,u.prototype),R};function de(k,_,E){if(k%1!==0||k<0)throw new RangeError("offset is not uint");if(k+_>E)throw new RangeError("Trying to access beyond buffer length")}u.prototype.readUintLE=u.prototype.readUIntLE=function(_,E,O){_=_>>>0,E=E>>>0,O||de(_,E,this.length);let R=this[_],D=1,Z=0;for(;++Z<E&&(D*=256);)R+=this[_+Z]*D;return R},u.prototype.readUintBE=u.prototype.readUIntBE=function(_,E,O){_=_>>>0,E=E>>>0,O||de(_,E,this.length);let R=this[_+--E],D=1;for(;E>0&&(D*=256);)R+=this[_+--E]*D;return R},u.prototype.readUint8=u.prototype.readUInt8=function(_,E){return _=_>>>0,E||de(_,1,this.length),this[_]},u.prototype.readUint16LE=u.prototype.readUInt16LE=function(_,E){return _=_>>>0,E||de(_,2,this.length),this[_]|this[_+1]<<8},u.prototype.readUint16BE=u.prototype.readUInt16BE=function(_,E){return _=_>>>0,E||de(_,2,this.length),this[_]<<8|this[_+1]},u.prototype.readUint32LE=u.prototype.readUInt32LE=function(_,E){return _=_>>>0,E||de(_,4,this.length),(this[_]|this[_+1]<<8|this[_+2]<<16)+this[_+3]*16777216},u.prototype.readUint32BE=u.prototype.readUInt32BE=function(_,E){return _=_>>>0,E||de(_,4,this.length),this[_]*16777216+(this[_+1]<<16|this[_+2]<<8|this[_+3])},u.prototype.readBigUInt64LE=we(function(_){_=_>>>0,Qe(_,"offset");const E=this[_],O=this[_+7];(E===void 0||O===void 0)&&Bt(_,this.length-8);const R=E+this[++_]*2**8+this[++_]*2**16+this[++_]*2**24,D=this[++_]+this[++_]*2**8+this[++_]*2**16+O*2**24;return BigInt(R)+(BigInt(D)<<BigInt(32))}),u.prototype.readBigUInt64BE=we(function(_){_=_>>>0,Qe(_,"offset");const E=this[_],O=this[_+7];(E===void 0||O===void 0)&&Bt(_,this.length-8);const R=E*2**24+this[++_]*2**16+this[++_]*2**8+this[++_],D=this[++_]*2**24+this[++_]*2**16+this[++_]*2**8+O;return(BigInt(R)<<BigInt(32))+BigInt(D)}),u.prototype.readIntLE=function(_,E,O){_=_>>>0,E=E>>>0,O||de(_,E,this.length);let R=this[_],D=1,Z=0;for(;++Z<E&&(D*=256);)R+=this[_+Z]*D;return D*=128,R>=D&&(R-=Math.pow(2,8*E)),R},u.prototype.readIntBE=function(_,E,O){_=_>>>0,E=E>>>0,O||de(_,E,this.length);let R=E,D=1,Z=this[_+--R];for(;R>0&&(D*=256);)Z+=this[_+--R]*D;return D*=128,Z>=D&&(Z-=Math.pow(2,8*E)),Z},u.prototype.readInt8=function(_,E){return _=_>>>0,E||de(_,1,this.length),this[_]&128?(255-this[_]+1)*-1:this[_]},u.prototype.readInt16LE=function(_,E){_=_>>>0,E||de(_,2,this.length);const O=this[_]|this[_+1]<<8;return O&32768?O|4294901760:O},u.prototype.readInt16BE=function(_,E){_=_>>>0,E||de(_,2,this.length);const O=this[_+1]|this[_]<<8;return O&32768?O|4294901760:O},u.prototype.readInt32LE=function(_,E){return _=_>>>0,E||de(_,4,this.length),this[_]|this[_+1]<<8|this[_+2]<<16|this[_+3]<<24},u.prototype.readInt32BE=function(_,E){return _=_>>>0,E||de(_,4,this.length),this[_]<<24|this[_+1]<<16|this[_+2]<<8|this[_+3]},u.prototype.readBigInt64LE=we(function(_){_=_>>>0,Qe(_,"offset");const E=this[_],O=this[_+7];(E===void 0||O===void 0)&&Bt(_,this.length-8);const R=this[_+4]+this[_+5]*2**8+this[_+6]*2**16+(O<<24);return(BigInt(R)<<BigInt(32))+BigInt(E+this[++_]*2**8+this[++_]*2**16+this[++_]*2**24)}),u.prototype.readBigInt64BE=we(function(_){_=_>>>0,Qe(_,"offset");const E=this[_],O=this[_+7];(E===void 0||O===void 0)&&Bt(_,this.length-8);const R=(E<<24)+this[++_]*2**16+this[++_]*2**8+this[++_];return(BigInt(R)<<BigInt(32))+BigInt(this[++_]*2**24+this[++_]*2**16+this[++_]*2**8+O)}),u.prototype.readFloatLE=function(_,E){return _=_>>>0,E||de(_,4,this.length),n.read(this,_,!0,23,4)},u.prototype.readFloatBE=function(_,E){return _=_>>>0,E||de(_,4,this.length),n.read(this,_,!1,23,4)},u.prototype.readDoubleLE=function(_,E){return _=_>>>0,E||de(_,8,this.length),n.read(this,_,!0,52,8)},u.prototype.readDoubleBE=function(_,E){return _=_>>>0,E||de(_,8,this.length),n.read(this,_,!1,52,8)};function X(k,_,E,O,R,D){if(!u.isBuffer(k))throw new TypeError('"buffer" argument must be a Buffer instance');if(_>R||_<D)throw new RangeError('"value" argument is out of bounds');if(E+O>k.length)throw new RangeError("Index out of range")}u.prototype.writeUintLE=u.prototype.writeUIntLE=function(_,E,O,R){if(_=+_,E=E>>>0,O=O>>>0,!R){const ze=Math.pow(2,8*O)-1;X(this,_,E,O,ze,0)}let D=1,Z=0;for(this[E]=_&255;++Z<O&&(D*=256);)this[E+Z]=_/D&255;return E+O},u.prototype.writeUintBE=u.prototype.writeUIntBE=function(_,E,O,R){if(_=+_,E=E>>>0,O=O>>>0,!R){const ze=Math.pow(2,8*O)-1;X(this,_,E,O,ze,0)}let D=O-1,Z=1;for(this[E+D]=_&255;--D>=0&&(Z*=256);)this[E+D]=_/Z&255;return E+O},u.prototype.writeUint8=u.prototype.writeUInt8=function(_,E,O){return _=+_,E=E>>>0,O||X(this,_,E,1,255,0),this[E]=_&255,E+1},u.prototype.writeUint16LE=u.prototype.writeUInt16LE=function(_,E,O){return _=+_,E=E>>>0,O||X(this,_,E,2,65535,0),this[E]=_&255,this[E+1]=_>>>8,E+2},u.prototype.writeUint16BE=u.prototype.writeUInt16BE=function(_,E,O){return _=+_,E=E>>>0,O||X(this,_,E,2,65535,0),this[E]=_>>>8,this[E+1]=_&255,E+2},u.prototype.writeUint32LE=u.prototype.writeUInt32LE=function(_,E,O){return _=+_,E=E>>>0,O||X(this,_,E,4,4294967295,0),this[E+3]=_>>>24,this[E+2]=_>>>16,this[E+1]=_>>>8,this[E]=_&255,E+4},u.prototype.writeUint32BE=u.prototype.writeUInt32BE=function(_,E,O){return _=+_,E=E>>>0,O||X(this,_,E,4,4294967295,0),this[E]=_>>>24,this[E+1]=_>>>16,this[E+2]=_>>>8,this[E+3]=_&255,E+4};function C(k,_,E,O,R){qt(_,O,R,k,E,7);let D=Number(_&BigInt(4294967295));k[E++]=D,D=D>>8,k[E++]=D,D=D>>8,k[E++]=D,D=D>>8,k[E++]=D;let Z=Number(_>>BigInt(32)&BigInt(4294967295));return k[E++]=Z,Z=Z>>8,k[E++]=Z,Z=Z>>8,k[E++]=Z,Z=Z>>8,k[E++]=Z,E}function x(k,_,E,O,R){qt(_,O,R,k,E,7);let D=Number(_&BigInt(4294967295));k[E+7]=D,D=D>>8,k[E+6]=D,D=D>>8,k[E+5]=D,D=D>>8,k[E+4]=D;let Z=Number(_>>BigInt(32)&BigInt(4294967295));return k[E+3]=Z,Z=Z>>8,k[E+2]=Z,Z=Z>>8,k[E+1]=Z,Z=Z>>8,k[E]=Z,E+8}u.prototype.writeBigUInt64LE=we(function(_,E=0){return C(this,_,E,BigInt(0),BigInt("0xffffffffffffffff"))}),u.prototype.writeBigUInt64BE=we(function(_,E=0){return x(this,_,E,BigInt(0),BigInt("0xffffffffffffffff"))}),u.prototype.writeIntLE=function(_,E,O,R){if(_=+_,E=E>>>0,!R){const _t=Math.pow(2,8*O-1);X(this,_,E,O,_t-1,-_t)}let D=0,Z=1,ze=0;for(this[E]=_&255;++D<O&&(Z*=256);)_<0&&ze===0&&this[E+D-1]!==0&&(ze=1),this[E+D]=(_/Z>>0)-ze&255;return E+O},u.prototype.writeIntBE=function(_,E,O,R){if(_=+_,E=E>>>0,!R){const _t=Math.pow(2,8*O-1);X(this,_,E,O,_t-1,-_t)}let D=O-1,Z=1,ze=0;for(this[E+D]=_&255;--D>=0&&(Z*=256);)_<0&&ze===0&&this[E+D+1]!==0&&(ze=1),this[E+D]=(_/Z>>0)-ze&255;return E+O},u.prototype.writeInt8=function(_,E,O){return _=+_,E=E>>>0,O||X(this,_,E,1,127,-128),_<0&&(_=255+_+1),this[E]=_&255,E+1},u.prototype.writeInt16LE=function(_,E,O){return _=+_,E=E>>>0,O||X(this,_,E,2,32767,-32768),this[E]=_&255,this[E+1]=_>>>8,E+2},u.prototype.writeInt16BE=function(_,E,O){return _=+_,E=E>>>0,O||X(this,_,E,2,32767,-32768),this[E]=_>>>8,this[E+1]=_&255,E+2},u.prototype.writeInt32LE=function(_,E,O){return _=+_,E=E>>>0,O||X(this,_,E,4,2147483647,-2147483648),this[E]=_&255,this[E+1]=_>>>8,this[E+2]=_>>>16,this[E+3]=_>>>24,E+4},u.prototype.writeInt32BE=function(_,E,O){return _=+_,E=E>>>0,O||X(this,_,E,4,2147483647,-2147483648),_<0&&(_=4294967295+_+1),this[E]=_>>>24,this[E+1]=_>>>16,this[E+2]=_>>>8,this[E+3]=_&255,E+4},u.prototype.writeBigInt64LE=we(function(_,E=0){return C(this,_,E,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))}),u.prototype.writeBigInt64BE=we(function(_,E=0){return x(this,_,E,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))});function F(k,_,E,O,R,D){if(E+O>k.length)throw new RangeError("Index out of range");if(E<0)throw new RangeError("Index out of range")}function N(k,_,E,O,R){return _=+_,E=E>>>0,R||F(k,_,E,4),n.write(k,_,E,O,23,4),E+4}u.prototype.writeFloatLE=function(_,E,O){return N(this,_,E,!0,O)},u.prototype.writeFloatBE=function(_,E,O){return N(this,_,E,!1,O)};function Oe(k,_,E,O,R){return _=+_,E=E>>>0,R||F(k,_,E,8),n.write(k,_,E,O,52,8),E+8}u.prototype.writeDoubleLE=function(_,E,O){return Oe(this,_,E,!0,O)},u.prototype.writeDoubleBE=function(_,E,O){return Oe(this,_,E,!1,O)},u.prototype.copy=function(_,E,O,R){if(!u.isBuffer(_))throw new TypeError("argument should be a Buffer");if(O||(O=0),!R&&R!==0&&(R=this.length),E>=_.length&&(E=_.length),E||(E=0),R>0&&R<O&&(R=O),R===O||_.length===0||this.length===0)return 0;if(E<0)throw new RangeError("targetStart out of bounds");if(O<0||O>=this.length)throw new RangeError("Index out of range");if(R<0)throw new RangeError("sourceEnd out of bounds");R>this.length&&(R=this.length),_.length-E<R-O&&(R=_.length-E+O);const D=R-O;return this===_&&typeof i.prototype.copyWithin=="function"?this.copyWithin(E,O,R):i.prototype.set.call(_,this.subarray(O,R),E),D},u.prototype.fill=function(_,E,O,R){if(typeof _=="string"){if(typeof E=="string"?(R=E,E=0,O=this.length):typeof O=="string"&&(R=O,O=this.length),R!==void 0&&typeof R!="string")throw new TypeError("encoding must be a string");if(typeof R=="string"&&!u.isEncoding(R))throw new TypeError("Unknown encoding: "+R);if(_.length===1){const Z=_.charCodeAt(0);(R==="utf8"&&Z<128||R==="latin1")&&(_=Z)}}else typeof _=="number"?_=_&255:typeof _=="boolean"&&(_=Number(_));if(E<0||this.length<E||this.length<O)throw new RangeError("Out of range index");if(O<=E)return this;E=E>>>0,O=O===void 0?this.length:O>>>0,_||(_=0);let D;if(typeof _=="number")for(D=E;D<O;++D)this[D]=_;else{const Z=u.isBuffer(_)?_:u.from(_,R),ze=Z.length;if(ze===0)throw new TypeError('The value "'+_+'" is invalid for argument "value"');for(D=0;D<O-E;++D)this[D+E]=Z[D%ze]}return this};const Me={};function Ke(k,_,E){Me[k]=class extends E{constructor(){super(),Object.defineProperty(this,"message",{value:_.apply(this,arguments),writable:!0,configurable:!0}),this.name=`${this.name} [${k}]`,this.stack,delete this.name}get code(){return k}set code(R){Object.defineProperty(this,"code",{configurable:!0,enumerable:!0,value:R,writable:!0})}toString(){return`${this.name} [${k}]: ${this.message}`}}}Ke("ERR_BUFFER_OUT_OF_BOUNDS",function(k){return k?`${k} is outside of buffer bounds`:"Attempt to access memory outside buffer bounds"},RangeError),Ke("ERR_INVALID_ARG_TYPE",function(k,_){return`The "${k}" argument must be of type number. Received type ${typeof _}`},TypeError),Ke("ERR_OUT_OF_RANGE",function(k,_,E){let O=`The value of "${k}" is out of range.`,R=E;return Number.isInteger(E)&&Math.abs(E)>2**32?R=ot(String(E)):typeof E=="bigint"&&(R=String(E),(E>BigInt(2)**BigInt(32)||E<-(BigInt(2)**BigInt(32)))&&(R=ot(R)),R+="n"),O+=` It must be ${_}. Received ${R}`,O},RangeError);function ot(k){let _="",E=k.length;const O=k[0]==="-"?1:0;for(;E>=O+4;E-=3)_=`_${k.slice(E-3,E)}${_}`;return`${k.slice(0,E)}${_}`}function yt(k,_,E){Qe(_,"offset"),(k[_]===void 0||k[_+E]===void 0)&&Bt(_,k.length-(E+1))}function qt(k,_,E,O,R,D){if(k>E||k<_){const Z=typeof _=="bigint"?"n":"";let ze;throw _===0||_===BigInt(0)?ze=`>= 0${Z} and < 2${Z} ** ${(D+1)*8}${Z}`:ze=`>= -(2${Z} ** ${(D+1)*8-1}${Z}) and < 2 ** ${(D+1)*8-1}${Z}`,new Me.ERR_OUT_OF_RANGE("value",ze,k)}yt(O,R,D)}function Qe(k,_){if(typeof k!="number")throw new Me.ERR_INVALID_ARG_TYPE(_,"number",k)}function Bt(k,_,E){throw Math.floor(k)!==k?(Qe(k,E),new Me.ERR_OUT_OF_RANGE("offset","an integer",k)):_<0?new Me.ERR_BUFFER_OUT_OF_BOUNDS:new Me.ERR_OUT_OF_RANGE("offset",`>= 0 and <= ${_}`,k)}const Ts=/[^+/0-9A-Za-z-_]/g;function ji(k){if(k=k.split("=")[0],k=k.trim().replace(Ts,""),k.length<2)return"";for(;k.length%4!==0;)k=k+"=";return k}function Q(k,_){_=_||1/0;let E;const O=k.length;let R=null;const D=[];for(let Z=0;Z<O;++Z){if(E=k.charCodeAt(Z),E>55295&&E<57344){if(!R){if(E>56319){(_-=3)>-1&&D.push(239,191,189);continue}else if(Z+1===O){(_-=3)>-1&&D.push(239,191,189);continue}R=E;continue}if(E<56320){(_-=3)>-1&&D.push(239,191,189),R=E;continue}E=(R-55296<<10|E-56320)+65536}else R&&(_-=3)>-1&&D.push(239,191,189);if(R=null,E<128){if((_-=1)<0)break;D.push(E)}else if(E<2048){if((_-=2)<0)break;D.push(E>>6|192,E&63|128)}else if(E<65536){if((_-=3)<0)break;D.push(E>>12|224,E>>6&63|128,E&63|128)}else if(E<1114112){if((_-=4)<0)break;D.push(E>>18|240,E>>12&63|128,E>>6&63|128,E&63|128)}else throw new Error("Invalid code point")}return D}function Jr(k){const _=[];for(let E=0;E<k.length;++E)_.push(k.charCodeAt(E)&255);return _}function ke(k,_){let E,O,R;const D=[];for(let Z=0;Z<k.length&&!((_-=2)<0);++Z)E=k.charCodeAt(Z),O=E>>8,R=E%256,D.push(R),D.push(O);return D}function me(k){return e.toByteArray(ji(k))}function xe(k,_,E,O){let R;for(R=0;R<O&&!(R+E>=_.length||R>=k.length);++R)_[R+E]=k[R];return R}function ee(k,_){return k instanceof _||k!=null&&k.constructor!=null&&k.constructor.name!=null&&k.constructor.name===_.name}function Y(k){return k!==k}const Ie=function(){const k="0123456789abcdef",_=new Array(256);for(let E=0;E<16;++E){const O=E*16;for(let R=0;R<16;++R)_[O+R]=k[E]+k[R]}return _}();function we(k){return typeof BigInt>"u"?nn:k}function nn(){throw new Error("BigInt not supported")}})(sv);const Fs=sv.Buffer;function Np(t){switch(t){case"csv":return"text/csv";case"doc":return"application/vnd.openxmlformats-officedocument.wordprocessingml.document";case"docx":return"application/vnd.openxmlformats-officedocument.wordprocessingml.document";case"html":return"text/html";case"md":return"text/markdown";case"pdf":return"application/pdf";case"txt":return"text/plain";case"xls":return"application/vnd.ms-excel";case"xlsx":return"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet";case"gif":return"image/gif";case"jpeg":return"image/jpeg";case"jpg":return"image/jpeg";case"png":return"image/png";case"webp":return"image/webp";case"flv":return"video/flv";case"mkv":return"video/mkv";case"mov":return"video/mov";case"mp4":return"video/mp4";case"mpeg":return"video/mpeg";case"mpg":return"video/mpg";case"three_gp":return"video/three_gp";case"webm":return"video/webm";case"wmv":return"video/wmv";default:return"application/octet-stream"}}function sA(t){if(Re(t.document)&&Re(t.document.source)){const e=Re(t.document)&&ae(t.document.format)?t.document.format:"",n=Np(e);if(Re(t.document.source)){if(Re(t.document.source.s3Location)&&ae(t.document.source.s3Location.uri))return{type:"file",mimeType:n,fileId:t.document.source.s3Location.uri};if(kp(t.document.source.bytes))return{type:"file",mimeType:n,data:t.document.source.bytes};if(ae(t.document.source.text))return{type:"file",mimeType:n,data:Fs.from(t.document.source.text).toString("base64")};if(zr(t.document.source.content)){const r=t.document.source.content.reduce((s,i)=>Re(i)&&ae(i.text)?s+i.text:s,"");return{type:"file",mimeType:n,data:r}}}}return{type:"non_standard",value:t}}function iA(t){if(Ee(t,"image")&&Re(t.image)){const e=Re(t.image)&&ae(t.image.format)?t.image.format:"",n=Np(e);if(Re(t.image.source)){if(Re(t.image.source.s3Location)&&ae(t.image.source.s3Location.uri))return{type:"image",mimeType:n,fileId:t.image.source.s3Location.uri};if(kp(t.image.source.bytes))return{type:"image",mimeType:n,data:t.image.source.bytes}}}return{type:"non_standard",value:t}}function aA(t){if(Ee(t,"video")&&Re(t.video)){const e=Re(t.video)&&ae(t.video.format)?t.video.format:"",n=Np(e);if(Re(t.video.source)){if(Re(t.video.source.s3Location)&&ae(t.video.source.s3Location.uri))return{type:"video",mimeType:n,fileId:t.video.source.s3Location.uri};if(kp(t.video.source.bytes))return{type:"video",mimeType:n,data:t.video.source.bytes}}}return{type:"non_standard",value:t}}function Mg(t){function*e(){const n=typeof t.content=="string"?[{type:"text",text:t.content}]:t.content;for(const r of n){if(Ee(r,"cache_point")){yield{type:"non_standard",value:r};continue}else if(Ee(r,"citations_content")&&Re(r.citationsContent)){const s=zr(r.citationsContent.content)?r.citationsContent.content.reduce((a,o)=>Re(o)&&ae(o.text)?a+o.text:a,""):"",i=zr(r.citationsContent.citations)?r.citationsContent.citations.reduce((a,o)=>{if(Re(o)){const c=zr(o.sourceContent)?o.sourceContent.reduce((u,d)=>Re(d)&&ae(d.text)?u+d.text:u,""):"",l=wo(()=>{if(Re(o.location)){const u=o.location.documentChar||o.location.documentPage||o.location.documentChunk;if(Re(u))return{source:yr(u.documentIndex)?u.documentIndex.toString():void 0,startIndex:yr(u.start)?u.start:void 0,endIndex:yr(u.end)?u.end:void 0}}return{}});a.push({type:"citation",citedText:c,...l})}return a},[]):[];yield{type:"text",text:s,annotations:i};continue}else if(Ee(r,"document")&&Re(r.document)){yield sA(r);continue}else if(Ee(r,"guard_content")){yield{type:"non_standard",value:r};continue}else if(Ee(r,"image")&&Re(r.image)){yield iA(r);continue}else if(Ee(r,"reasoning_content")&&ae(r.reasoningText)){yield{type:"reasoning",reasoning:r.reasoningText};continue}else if(Ee(r,"text")&&ae(r.text)){yield{type:"text",text:r.text};continue}else if(Ee(r,"tool_result")){yield{type:"non_standard",value:r};continue}else{if(Ee(r,"tool_call"))continue;if(Ee(r,"video")&&Re(r.video)){yield aA(r);continue}}yield{type:"non_standard",value:r}}}return Array.from(e())}const oA={translateContent:Mg,translateContentChunk:Mg};function Lg(t){function*e(){const n=typeof t.content=="string"?[{type:"text",text:t.content}]:t.content;for(const r of n){if(Ee(r,"text")&&ae(r.text)){yield{type:"text",text:r.text};continue}else if(Ee(r,"inlineData")&&Re(r.inlineData)&&ae(r.inlineData.mimeType)&&ae(r.inlineData.data)){yield{type:"file",mimeType:r.inlineData.mimeType,data:r.inlineData.data};continue}else if(Ee(r,"functionCall")&&Re(r.functionCall)&&ae(r.functionCall.name)&&Re(r.functionCall.args)){yield{type:"tool_call",id:t.id,name:r.functionCall.name,args:r.functionCall.args};continue}else if(Ee(r,"functionResponse")){yield{type:"non_standard",value:r};continue}else if(Ee(r,"fileData")&&Re(r.fileData)&&ae(r.fileData.mimeType)&&ae(r.fileData.fileUri)){yield{type:"file",mimeType:r.fileData.mimeType,fileId:r.fileData.fileUri};continue}else if(Ee(r,"executableCode")){yield{type:"non_standard",value:r};continue}else if(Ee(r,"codeExecutionResult")){yield{type:"non_standard",value:r};continue}yield{type:"non_standard",value:r}}}return Array.from(e())}const cA={translateContent:Lg,translateContentChunk:Lg};function jg(t){function*e(){const n=typeof t.content=="string"?[{type:"text",text:t.content}]:t.content;for(const r of n){if(Ee(r,"reasoning")&&ae(r.reasoning)){const s=wo(()=>{var a;const i=n.indexOf(r);if(zr((a=t.additional_kwargs)==null?void 0:a.signatures)&&i>=0)return t.additional_kwargs.signatures.at(i)});ae(s)?yield{type:"reasoning",reasoning:r.reasoning,signature:s}:yield{type:"reasoning",reasoning:r.reasoning};continue}else if(Ee(r,"text")&&ae(r.text)){yield{type:"text",text:r.text};continue}else if(Ee(r,"image_url")){if(ae(r.image_url))if(r.image_url.startsWith("data:")){const s=/^data:([^;]+);base64,(.+)$/,i=r.image_url.match(s);i?yield{type:"image",data:i[2],mimeType:i[1]}:yield{type:"image",url:r.image_url}}else yield{type:"image",url:r.image_url};continue}else if(Ee(r,"media")&&ae(r.mimeType)&&ae(r.data)){yield{type:"file",mimeType:r.mimeType,data:r.data};continue}yield{type:"non_standard",value:r}}}return Array.from(e())}const lA={translateContent:jg,translateContentChunk:jg};globalThis.lc_block_translators_registry??(globalThis.lc_block_translators_registry=new Map([["anthropic",TI],["bedrock-converse",oA],["google-genai",cA],["google-vertexai",lA],["openai",NI]]));function av(t){return globalThis.lc_block_translators_registry.get(t)}var le=class extends Cn{constructor(e){var r;let n;if(typeof e=="string"||Array.isArray(e))n={content:e,tool_calls:[],invalid_tool_calls:[],additional_kwargs:{}};else{n=e;const s=(r=n.additional_kwargs)==null?void 0:r.tool_calls,i=n.tool_calls;s!=null&&s.length>0&&(i===void 0||i.length===0)&&console.warn(["New LangChain packages are available that more efficiently handle",`tool calling.

Please upgrade your packages to versions that set`,"message tool calls. e.g., `pnpm install @langchain/anthropic`,","pnpm install @langchain/openai`, etc."].join(" "));try{if(s!=null&&i===void 0){const[a,o]=Op(s);n.tool_calls=a??[],n.invalid_tool_calls=o??[]}else n.tool_calls=n.tool_calls??[],n.invalid_tool_calls=n.invalid_tool_calls??[]}catch{n.tool_calls=[],n.invalid_tool_calls=[]}if(n.response_metadata!==void 0&&"output_version"in n.response_metadata&&n.response_metadata.output_version==="v1"&&(n.contentBlocks=n.content,n.content=void 0),n.contentBlocks!==void 0){n.contentBlocks.push(...n.tool_calls.map(o=>({type:"tool_call",id:o.id,name:o.name,args:o.args})));const a=n.contentBlocks.filter(o=>o.type==="tool_call").filter(o=>{var c;return!((c=n.tool_calls)!=null&&c.some(l=>l.id===o.id&&l.name===o.name))});a.length>0&&(n.tool_calls=a.map(o=>({type:"tool_call",id:o.id,name:o.name,args:o.args})))}}super(n);p(this,"type","ai");p(this,"tool_calls",[]);p(this,"invalid_tool_calls",[]);p(this,"usage_metadata");typeof n!="string"&&(this.tool_calls=n.tool_calls??this.tool_calls,this.invalid_tool_calls=n.invalid_tool_calls??this.invalid_tool_calls),this.usage_metadata=n.usage_metadata}get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls"}}static lc_name(){return"AIMessage"}get contentBlocks(){if(this.response_metadata&&"output_version"in this.response_metadata&&this.response_metadata.output_version==="v1")return this.content;if(this.response_metadata&&"model_provider"in this.response_metadata&&typeof this.response_metadata.model_provider=="string"){const n=av(this.response_metadata.model_provider);if(n)return n.translateContent(this)}const e=super.contentBlocks;if(this.tool_calls){const n=this.tool_calls.filter(r=>!e.some(s=>s.id===r.id&&s.name===r.name));e.push(...n.map(r=>({...r,type:"tool_call",id:r.id,name:r.name,args:r.args})))}return e}get _printableFields(){return{...super._printableFields,tool_calls:this.tool_calls,invalid_tool_calls:this.invalid_tool_calls,usage_metadata:this.usage_metadata}}static isInstance(e){return super.isInstance(e)&&e.type==="ai"}};function Ru(t){return t._getType()==="ai"}function Uh(t){return t._getType()==="ai"}var dn=class extends ws{constructor(e){let n;typeof e=="string"||Array.isArray(e)?n={content:e,tool_calls:[],invalid_tool_calls:[],tool_call_chunks:[]}:e.tool_call_chunks===void 0||e.tool_call_chunks.length===0?n={...e,tool_calls:e.tool_calls??[],invalid_tool_calls:[],tool_call_chunks:[],usage_metadata:e.usage_metadata!==void 0?e.usage_metadata:void 0}:n={...e,...cv(e.tool_call_chunks??[]),usage_metadata:e.usage_metadata!==void 0?e.usage_metadata:void 0};super(n);p(this,"type","ai");p(this,"tool_calls",[]);p(this,"invalid_tool_calls",[]);p(this,"tool_call_chunks",[]);p(this,"usage_metadata");this.tool_call_chunks=n.tool_call_chunks??this.tool_call_chunks,this.tool_calls=n.tool_calls??this.tool_calls,this.invalid_tool_calls=n.invalid_tool_calls??this.invalid_tool_calls,this.usage_metadata=n.usage_metadata}get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls",tool_call_chunks:"tool_call_chunks"}}static lc_name(){return"AIMessageChunk"}get contentBlocks(){if(this.response_metadata&&"output_version"in this.response_metadata&&this.response_metadata.output_version==="v1")return this.content;if(this.response_metadata&&"model_provider"in this.response_metadata&&typeof this.response_metadata.model_provider=="string"){const n=av(this.response_metadata.model_provider);if(n)return n.translateContent(this)}const e=super.contentBlocks;if(this.tool_calls&&typeof this.content!="string"){const n=this.content.filter(r=>r.type==="tool_call").map(r=>r.id);for(const r of this.tool_calls)r.id&&!n.includes(r.id)&&e.push({...r,type:"tool_call",id:r.id,name:r.name,args:r.args})}return e}get _printableFields(){return{...super._printableFields,tool_calls:this.tool_calls,tool_call_chunks:this.tool_call_chunks,invalid_tool_calls:this.invalid_tool_calls,usage_metadata:this.usage_metadata}}concat(e){const n={content:hs(this.content,e.content),additional_kwargs:un(this.additional_kwargs,e.additional_kwargs),response_metadata:Qw(this.response_metadata,e.response_metadata),tool_call_chunks:[],id:this.id??e.id};if(this.tool_call_chunks!==void 0||e.tool_call_chunks!==void 0){const s=Yo(this.tool_call_chunks,e.tool_call_chunks);s!==void 0&&s.length>0&&(n.tool_call_chunks=s)}(this.usage_metadata!==void 0||e.usage_metadata!==void 0)&&(n.usage_metadata=Ap(this.usage_metadata,e.usage_metadata));const r=this.constructor;return new r(n)}static isInstance(e){return super.isInstance(e)&&e.type==="ai"}};const ov=t=>t();function uA(t){return so(t)?t:typeof t.id=="string"&&t.type==="function"&&typeof t.function=="object"&&t.function!==null&&"arguments"in t.function&&typeof t.function.arguments=="string"&&"name"in t.function&&typeof t.function.name=="string"?{id:t.id,args:JSON.parse(t.function.arguments),name:t.function.name,type:"tool_call"}:t}function dA(t){return typeof t=="object"&&t!=null&&t.lc===1&&Array.isArray(t.id)&&t.kwargs!=null&&typeof t.kwargs=="object"}function Sd(t){let e,n;if(dA(t)){const r=t.id.at(-1);r==="HumanMessage"||r==="HumanMessageChunk"?e="user":r==="AIMessage"||r==="AIMessageChunk"?e="assistant":r==="SystemMessage"||r==="SystemMessageChunk"?e="system":r==="FunctionMessage"||r==="FunctionMessageChunk"?e="function":r==="ToolMessage"||r==="ToolMessageChunk"?e="tool":e="unknown",n=t.kwargs}else{const{type:r,...s}=t;e=r,n=s}if(e==="human"||e==="user")return new ht(n);if(e==="ai"||e==="assistant"){const{tool_calls:r,...s}=n;if(!Array.isArray(r))return new le(n);const i=r.map(uA);return new le({...s,tool_calls:i})}else{if(e==="system")return new kt(n);if(e==="developer")return new kt({...n,additional_kwargs:{...n.additional_kwargs,__openai_role__:"developer"}});if(e==="tool"&&"tool_call_id"in n)return new Pe({...n,content:n.content,tool_call_id:n.tool_call_id,name:n.name});if(e==="remove"&&"id"in n&&typeof n.id=="string")return new Us({...n,id:n.id});throw Ou(new Error(`Unable to coerce message from array: only human, AI, system, developer, or tool message coercion is currently supported.

Received: ${JSON.stringify(t,null,2)}`),"MESSAGE_COERCION_FAILURE")}}function Zr(t){if(typeof t=="string")return new ht(t);if(Yt(t))return t;if(Array.isArray(t)){const[e,n]=t;return Sd({type:e,content:n})}else if(Yw(t)){const{role:e,...n}=t;return Sd({...n,type:e})}else return Sd(t)}function Pp(t,e="Human",n="AI"){const r=[];for(const s of t){let i;if(s._getType()==="human")i=e;else if(s._getType()==="ai")i=n;else if(s._getType()==="system")i="System";else if(s._getType()==="tool")i="Tool";else if(s._getType()==="generic")i=s.role;else throw new Error(`Got unsupported message type: ${s._getType()}`);const a=s.name?`${s.name}, `:"",o=typeof s.content=="string"?s.content:JSON.stringify(s.content,null,2);r.push(`${i}: ${a}${o}`)}return r.join(`
`)}function hA(t){if(t.data!==void 0)return t;{const e=t;return{type:e.type,data:{content:e.text,role:e.role,name:void 0,tool_call_id:void 0}}}}function Mp(t){const e=hA(t);switch(e.type){case"human":return new ht(e.data);case"ai":return new le(e.data);case"system":return new kt(e.data);case"function":if(e.data.name===void 0)throw new Error("Name must be defined for function messages");return new Cu(e.data);case"tool":if(e.data.tool_call_id===void 0)throw new Error("Tool call ID must be defined for tool messages");return new Pe(e.data);case"generic":if(e.data.role===void 0)throw new Error("Role must be defined for chat messages");return new vs(e.data);default:throw new Error(`Got unexpected type: ${e.type}`)}}function fA(t){return t.map(Mp)}function pA(t){return t.map(e=>e.toDict())}function Dl(t){var n;const e=t._getType();if(e==="human")return new Ca({...t});if(e==="ai"){let r={...t};return"tool_calls"in r&&(r={...r,tool_call_chunks:(n=r.tool_calls)==null?void 0:n.map(s=>({...s,type:"tool_call_chunk",index:void 0,args:JSON.stringify(s.args)}))}),new dn({...r})}else{if(e==="system")return new fs({...t});if(e==="function")return new ec({...t});if(vs.isInstance(t))return new Qo({...t});throw new Error("Unknown message type.")}}function cv(t){var s,i;const e=t.reduce((a,o)=>{const c=a.findIndex(([l])=>"id"in o&&o.id&&"index"in o&&o.index!==void 0?o.id===l.id&&o.index===l.index:"id"in o&&o.id?o.id===l.id:"index"in o&&o.index!==void 0?o.index===l.index:!1);return c!==-1?a[c].push(o):a.push([o]),a},[]),n=[],r=[];for(const a of e){let o=null;const c=((s=a[0])==null?void 0:s.name)??"",l=a.map(h=>h.args||"").join("").trim(),u=l.length?l:"{}",d=(i=a[0])==null?void 0:i.id;try{if(o=fa(u),!d||o===null||typeof o!="object"||Array.isArray(o))throw new Error("Malformed tool call chunk args.");n.push({name:c,args:o,id:d,type:"tool_call"})}catch{r.push({name:c,args:u,id:d,error:"Malformed args.",type:"invalid_tool_call"})}}return{tool_call_chunks:t,tool_calls:n,invalid_tool_calls:r}}const lv=Symbol.for("ls:tracing_async_local_storage"),io=Symbol.for("lc:context_variables"),mA=t=>{globalThis[lv]=t},Eo=()=>globalThis[lv];function gA(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var uv={exports:{}},At=uv.exports={},Rr,Nr;function Fh(){throw new Error("setTimeout has not been defined")}function Bh(){throw new Error("clearTimeout has not been defined")}(function(){try{typeof setTimeout=="function"?Rr=setTimeout:Rr=Fh}catch{Rr=Fh}try{typeof clearTimeout=="function"?Nr=clearTimeout:Nr=Bh}catch{Nr=Bh}})();function dv(t){if(Rr===setTimeout)return setTimeout(t,0);if((Rr===Fh||!Rr)&&setTimeout)return Rr=setTimeout,setTimeout(t,0);try{return Rr(t,0)}catch{try{return Rr.call(null,t,0)}catch{return Rr.call(this,t,0)}}}function yA(t){if(Nr===clearTimeout)return clearTimeout(t);if((Nr===Bh||!Nr)&&clearTimeout)return Nr=clearTimeout,clearTimeout(t);try{return Nr(t)}catch{try{return Nr.call(null,t)}catch{return Nr.call(this,t)}}}var is=[],aa=!1,di,sl=-1;function _A(){!aa||!di||(aa=!1,di.length?is=di.concat(is):sl=-1,is.length&&hv())}function hv(){if(!aa){var t=dv(_A);aa=!0;for(var e=is.length;e;){for(di=is,is=[];++sl<e;)di&&di[sl].run();sl=-1,e=is.length}di=null,aa=!1,yA(t)}}At.nextTick=function(t){var e=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)e[n-1]=arguments[n];is.push(new fv(t,e)),is.length===1&&!aa&&dv(hv)};function fv(t,e){this.fun=t,this.array=e}fv.prototype.run=function(){this.fun.apply(null,this.array)};At.title="browser";At.browser=!0;At.env={};At.argv=[];At.version="";At.versions={};function bs(){}At.on=bs;At.addListener=bs;At.once=bs;At.off=bs;At.removeListener=bs;At.removeAllListeners=bs;At.emit=bs;At.prependListener=bs;At.prependOnceListener=bs;At.listeners=function(t){return[]};At.binding=function(t){throw new Error("process.binding is not supported")};At.cwd=function(){return"/"};At.chdir=function(t){throw new Error("process.chdir is not supported")};At.umask=function(){return 0};var wA=uv.exports;const Gn=gA(wA);var xd={},pv={};Se(pv,{getEnv:()=>Lp,getEnvironmentVariable:()=>Sr,getRuntimeEnvironment:()=>wv,isBrowser:()=>mv,isDeno:()=>Nu,isJsDom:()=>yv,isNode:()=>_v,isWebWorker:()=>gv});const mv=()=>typeof window<"u"&&typeof window.document<"u",gv=()=>typeof globalThis=="object"&&globalThis.constructor&&globalThis.constructor.name==="DedicatedWorkerGlobalScope",yv=()=>typeof window<"u"&&window.name==="nodejs"||typeof navigator<"u"&&navigator.userAgent.includes("jsdom"),Nu=()=>typeof Deno<"u",_v=()=>typeof Gn<"u"&&typeof Gn.versions<"u"&&typeof Gn.versions.node<"u"&&!Nu(),Lp=()=>{let t;return mv()?t="browser":_v()?t="node":gv()?t="webworker":yv()?t="jsdom":Nu()?t="deno":t="other",t};let kd;function wv(){return kd===void 0&&(kd={library:"langchain-js",runtime:Lp()}),kd}function Sr(t){try{return typeof Gn<"u"?xd==null?void 0:xd[t]:Nu()?Deno==null?void 0:Deno.env.get(t):void 0}catch{return}}const vA=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i;function wi(t){return typeof t=="string"&&vA.test(t)}function vv(t){if(!wi(t))throw TypeError("Invalid UUID");var e,n=new Uint8Array(16);return n[0]=(e=parseInt(t.slice(0,8),16))>>>24,n[1]=e>>>16&255,n[2]=e>>>8&255,n[3]=e&255,n[4]=(e=parseInt(t.slice(9,13),16))>>>8,n[5]=e&255,n[6]=(e=parseInt(t.slice(14,18),16))>>>8,n[7]=e&255,n[8]=(e=parseInt(t.slice(19,23),16))>>>8,n[9]=e&255,n[10]=(e=parseInt(t.slice(24,36),16))/1099511627776&255,n[11]=e/4294967296&255,n[12]=e>>>24&255,n[13]=e>>>16&255,n[14]=e>>>8&255,n[15]=e&255,n}var Jt=[];for(var Id=0;Id<256;++Id)Jt.push((Id+256).toString(16).slice(1));function Oa(t,e=0){return(Jt[t[e+0]]+Jt[t[e+1]]+Jt[t[e+2]]+Jt[t[e+3]]+"-"+Jt[t[e+4]]+Jt[t[e+5]]+"-"+Jt[t[e+6]]+Jt[t[e+7]]+"-"+Jt[t[e+8]]+Jt[t[e+9]]+"-"+Jt[t[e+10]]+Jt[t[e+11]]+Jt[t[e+12]]+Jt[t[e+13]]+Jt[t[e+14]]+Jt[t[e+15]]).toLowerCase()}var xc,bA=new Uint8Array(16);function jp(){if(!xc&&(xc=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!xc))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return xc(bA)}var Ad,kc,Cd=0,Od=0;function EA(t,e,n){var r=0,s=e||new Array(16);t=t||{};var i=t.node,a=t.clockseq;if(t._v6||(i||(i=Ad),a==null&&(a=kc)),i==null||a==null){var o=t.random||(t.rng||jp)();i==null&&(i=[o[0],o[1],o[2],o[3],o[4],o[5]],!Ad&&!t._v6&&(i[0]|=1,Ad=i)),a==null&&(a=(o[6]<<8|o[7])&16383,kc===void 0&&!t._v6&&(kc=a))}var c=t.msecs!==void 0?t.msecs:Date.now(),l=t.nsecs!==void 0?t.nsecs:Od+1,u=c-Cd+(l-Od)/1e4;if(u<0&&t.clockseq===void 0&&(a=a+1&16383),(u<0||c>Cd)&&t.nsecs===void 0&&(l=0),l>=1e4)throw new Error("uuid.v1(): Can't create more than 10M uuids/sec");Cd=c,Od=l,kc=a,c+=122192928e5;var d=((c&268435455)*1e4+l)%4294967296;s[r++]=d>>>24&255,s[r++]=d>>>16&255,s[r++]=d>>>8&255,s[r++]=d&255;var h=c/4294967296*1e4&268435455;s[r++]=h>>>8&255,s[r++]=h&255,s[r++]=h>>>24&15|16,s[r++]=h>>>16&255,s[r++]=a>>>8|128,s[r++]=a&255;for(var f=0;f<6;++f)s[r+f]=i[f];return e||Oa(s)}function TA(t){var e=typeof t=="string"?vv(t):t,n=SA(e);return typeof t=="string"?Oa(n):n}function SA(t,e=!1){return Uint8Array.of((t[6]&15)<<4|t[7]>>4&15,(t[7]&15)<<4|(t[4]&240)>>4,(t[4]&15)<<4|(t[5]&240)>>4,(t[5]&15)<<4|(t[0]&240)>>4,(t[0]&15)<<4|(t[1]&240)>>4,(t[1]&15)<<4|(t[2]&240)>>4,96|t[2]&15,t[3],t[8],t[9],t[10],t[11],t[12],t[13],t[14],t[15])}function xA(t){t=unescape(encodeURIComponent(t));for(var e=[],n=0;n<t.length;++n)e.push(t.charCodeAt(n));return e}var kA="6ba7b810-9dad-11d1-80b4-00c04fd430c8",IA="6ba7b811-9dad-11d1-80b4-00c04fd430c8";function AA(t,e,n){function r(s,i,a,o){var c;if(typeof s=="string"&&(s=xA(s)),typeof i=="string"&&(i=vv(i)),((c=i)===null||c===void 0?void 0:c.length)!==16)throw TypeError("Namespace must be array-like (16 iterable integer values, 0-255)");var l=new Uint8Array(16+s.length);if(l.set(i),l.set(s,i.length),l=n(l),l[6]=l[6]&15|e,l[8]=l[8]&63|128,a){o=o||0;for(var u=0;u<16;++u)a[o+u]=l[u];return a}return Oa(l)}try{r.name=t}catch{}return r.DNS=kA,r.URL=IA,r}var CA=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto);const Dg={randomUUID:CA};function vr(t,e,n){if(Dg.randomUUID&&!t)return Dg.randomUUID();t=t||{};var r=t.random||(t.rng||jp)();return r[6]=r[6]&15|64,r[8]=r[8]&63|128,Oa(r)}function OA(t,e,n,r){switch(t){case 0:return e&n^~e&r;case 1:return e^n^r;case 2:return e&n^e&r^n&r;case 3:return e^n^r}}function $d(t,e){return t<<e|t>>>32-e}function $A(t){var e=[1518500249,1859775393,2400959708,3395469782],n=[1732584193,4023233417,2562383102,271733878,3285377520];if(typeof t=="string"){var r=unescape(encodeURIComponent(t));t=[];for(var s=0;s<r.length;++s)t.push(r.charCodeAt(s))}else Array.isArray(t)||(t=Array.prototype.slice.call(t));t.push(128);for(var i=t.length/4+2,a=Math.ceil(i/16),o=new Array(a),c=0;c<a;++c){for(var l=new Uint32Array(16),u=0;u<16;++u)l[u]=t[c*64+u*4]<<24|t[c*64+u*4+1]<<16|t[c*64+u*4+2]<<8|t[c*64+u*4+3];o[c]=l}o[a-1][14]=(t.length-1)*8/Math.pow(2,32),o[a-1][14]=Math.floor(o[a-1][14]),o[a-1][15]=(t.length-1)*8&4294967295;for(var d=0;d<a;++d){for(var h=new Uint32Array(80),f=0;f<16;++f)h[f]=o[d][f];for(var m=16;m<80;++m)h[m]=$d(h[m-3]^h[m-8]^h[m-14]^h[m-16],1);for(var g=n[0],w=n[1],b=n[2],y=n[3],v=n[4],T=0;T<80;++T){var A=Math.floor(T/20),I=$d(g,5)+OA(A,w,b,y)+v+e[A]+h[T]>>>0;v=y,y=b,b=$d(w,30)>>>0,w=g,g=I}n[0]=n[0]+g>>>0,n[1]=n[1]+w>>>0,n[2]=n[2]+b>>>0,n[3]=n[3]+y>>>0,n[4]=n[4]+v>>>0}return[n[0]>>24&255,n[0]>>16&255,n[0]>>8&255,n[0]&255,n[1]>>24&255,n[1]>>16&255,n[1]>>8&255,n[1]&255,n[2]>>24&255,n[2]>>16&255,n[2]>>8&255,n[2]&255,n[3]>>24&255,n[3]>>16&255,n[3]>>8&255,n[3]&255,n[4]>>24&255,n[4]>>16&255,n[4]>>8&255,n[4]&255]}var Ps=AA("v5",80,$A);function Ug(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(s){return Object.getOwnPropertyDescriptor(t,s).enumerable})),n.push.apply(n,r)}return n}function Fg(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?Ug(Object(n),!0).forEach(function(r){RA(t,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):Ug(Object(n)).forEach(function(r){Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(n,r))})}return t}function RA(t,e,n){return(e=NA(e))in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function NA(t){var e=PA(t,"string");return typeof e=="symbol"?e:e+""}function PA(t,e){if(typeof t!="object"||!t)return t;var n=t[Symbol.toPrimitive];if(n!==void 0){var r=n.call(t,e);if(typeof r!="object")return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(t)}function MA(t={},e,n=0){var r=EA(Fg(Fg({},t),{},{_v6:!0}),new Uint8Array(16));return r=TA(r),Oa(r)}var Bg=null,zg=null,lr=0;function Cs(t,e,n){t=t||{};var r=0,s=new Uint8Array(16),i=t.random||(t.rng||jp)(),a=t.msecs!==void 0?t.msecs:Date.now(),o=t.seq!==void 0?t.seq:null,c=zg,l=Bg;return a>lr&&t.msecs===void 0&&(lr=a,o!==null&&(c=null,l=null)),o!==null&&(o>2147483647&&(o=2147483647),c=o>>>19&4095,l=o&524287),(c===null||l===null)&&(c=i[6]&127,c=c<<8|i[7],l=i[8]&63,l=l<<8|i[9],l=l<<5|i[10]>>>3),a+1e4>lr&&o===null?++l>524287&&(l=0,++c>4095&&(c=0,lr++)):lr=a,zg=c,Bg=l,s[r++]=lr/1099511627776&255,s[r++]=lr/4294967296&255,s[r++]=lr/16777216&255,s[r++]=lr/65536&255,s[r++]=lr/256&255,s[r++]=lr&255,s[r++]=c>>>4&15|112,s[r++]=c&255,s[r++]=l>>>13&63|128,s[r++]=l>>>5&255,s[r++]=l<<3&255|i[10]&7,s[r++]=i[11],s[r++]=i[12],s[r++]=i[13],s[r++]=i[14],s[r++]=i[15],e||Oa(s)}var bv={};Se(bv,{BaseCallbackHandler:()=>$a,callbackHandlerPrefersStreaming:()=>Dp,isBaseCallbackHandler:()=>Ev});var LA=class{};function Dp(t){return"lc_prefer_streaming"in t&&t.lc_prefer_streaming}var $a=class extends LA{constructor(e){super();p(this,"lc_serializable",!1);p(this,"lc_kwargs");p(this,"ignoreLLM",!1);p(this,"ignoreChain",!1);p(this,"ignoreAgent",!1);p(this,"ignoreRetriever",!1);p(this,"ignoreCustomEvent",!1);p(this,"raiseError",!1);p(this,"awaitHandlers",Sr("LANGCHAIN_CALLBACKS_BACKGROUND")==="false");this.lc_kwargs=e||{},e&&(this.ignoreLLM=e.ignoreLLM??this.ignoreLLM,this.ignoreChain=e.ignoreChain??this.ignoreChain,this.ignoreAgent=e.ignoreAgent??this.ignoreAgent,this.ignoreRetriever=e.ignoreRetriever??this.ignoreRetriever,this.ignoreCustomEvent=e.ignoreCustomEvent??this.ignoreCustomEvent,this.raiseError=e.raiseError??this.raiseError,this.awaitHandlers=this.raiseError||(e._awaitHandler??this.awaitHandlers))}get lc_namespace(){return["langchain_core","callbacks",this.name]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}get lc_serializable_keys(){}static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,Au(this.constructor)]}copy(){return new this.constructor(this)}toJSON(){return cr.prototype.toJSON.call(this)}toJSONNotImplemented(){return cr.prototype.toJSONNotImplemented.call(this)}static fromMethods(e){class n extends $a{constructor(){super();p(this,"name",Cs());Object.assign(this,e)}}return new n}};const Ev=t=>{const e=t;return e!==void 0&&typeof e.copy=="function"&&typeof e.name=="string"&&typeof e.awaitHandlers=="boolean"},jA="gen_ai.operation.name",DA="gen_ai.system",Zg="gen_ai.request.model",UA="gen_ai.response.model",Vg="gen_ai.usage.input_tokens",Gg="gen_ai.usage.output_tokens",Wg="gen_ai.usage.total_tokens",FA="gen_ai.request.max_tokens",BA="gen_ai.request.temperature",zA="gen_ai.request.top_p",ZA="gen_ai.request.frequency_penalty",VA="gen_ai.request.presence_penalty",GA="gen_ai.response.finish_reasons",WA="gen_ai.prompt",HA="gen_ai.completion",qA="gen_ai.request.extra_query",JA="gen_ai.request.extra_body",KA="gen_ai.serialized.name",XA="gen_ai.serialized.signature",YA="gen_ai.serialized.doc",QA="gen_ai.response.id",eC="gen_ai.response.service_tier",tC="gen_ai.response.system_fingerprint",nC="gen_ai.usage.input_token_details",rC="gen_ai.usage.output_token_details",sC="langsmith.trace.session_id",iC="langsmith.trace.session_name",aC="langsmith.span.kind",oC="langsmith.trace.name",cC="langsmith.metadata",Hg="langsmith.span.tags",lC="langsmith.request.streaming",uC="langsmith.request.headers",dC=(...t)=>fetch(...t),Tv=Symbol.for("ls:fetch_implementation"),hC=()=>{const t=globalThis[Tv];return t?typeof t=="function"&&"Headers"in t&&"Request"in t&&"Response"in t:!1},fC=t=>async(...e)=>{if(t||kn("DEBUG")==="true"){const[r,s]=e;console.log(` ${(s==null?void 0:s.method)||"GET"} ${r}`)}const n=await(globalThis[Tv]??dC)(...e);return(t||kn("DEBUG")==="true")&&console.log(` ${n.status} ${n.statusText} ${n.url}`),n},Sv=()=>kn("PROJECT")??Wr("LANGCHAIN_SESSION")??"default",qg={};function xv(t){qg[t]||(console.warn(t),qg[t]=!0)}const pC=/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;function $e(t,e){if(!pC.test(t)){const n=e!==void 0?`Invalid UUID for ${e}: ${t}`:`Invalid UUID: ${t}`;throw new Error(n)}return t}function mC(t){const e=typeof t=="string"?Date.parse(t):t;return Cs({msecs:e,seq:0})}const kv="0.4.0";var ao={};let Ar;const gC=()=>typeof window<"u"&&typeof window.document<"u",yC=()=>typeof globalThis=="object"&&globalThis.constructor&&globalThis.constructor.name==="DedicatedWorkerGlobalScope",_C=()=>typeof window<"u"&&window.name==="nodejs"||typeof navigator<"u"&&navigator.userAgent.includes("jsdom"),Iv=()=>typeof Deno<"u",wC=()=>typeof Gn<"u"&&typeof Gn.versions<"u"&&typeof Gn.versions.node<"u"&&!Iv(),Av=()=>Ar||(typeof Bun<"u"?Ar="bun":gC()?Ar="browser":wC()?Ar="node":yC()?Ar="webworker":_C()?Ar="jsdom":Iv()?Ar="deno":Ar="other",Ar);let Rd;function Cv(){if(Rd===void 0){const t=Av(),e=bC();Rd={library:"langsmith",runtime:t,sdk:"langsmith-js",sdk_version:kv,...e}}return Rd}function Ov(){const t=vC(),e={},n=["LANGCHAIN_API_KEY","LANGCHAIN_ENDPOINT","LANGCHAIN_TRACING_V2","LANGCHAIN_PROJECT","LANGCHAIN_SESSION","LANGSMITH_API_KEY","LANGSMITH_ENDPOINT","LANGSMITH_TRACING_V2","LANGSMITH_PROJECT","LANGSMITH_SESSION"];for(const[r,s]of Object.entries(t))typeof s=="string"&&!n.includes(r)&&!r.toLowerCase().includes("key")&&!r.toLowerCase().includes("secret")&&!r.toLowerCase().includes("token")&&(r==="LANGCHAIN_REVISION_ID"?e.revision_id=s:e[r]=s);return e}function vC(){const t={};try{if(typeof Gn<"u"&&ao)for(const[e,n]of Object.entries(ao))(e.startsWith("LANGCHAIN_")||e.startsWith("LANGSMITH_"))&&n!=null&&((e.toLowerCase().includes("key")||e.toLowerCase().includes("secret")||e.toLowerCase().includes("token"))&&typeof n=="string"?t[e]=n.slice(0,2)+"*".repeat(n.length-4)+n.slice(-2):t[e]=n)}catch{}return t}function Wr(t){try{return typeof Gn<"u"?ao==null?void 0:ao[t]:void 0}catch{return}}function kn(t){return Wr(`LANGSMITH_${t}`)||Wr(`LANGCHAIN_${t}`)}let Nd;function bC(){if(Nd!==void 0)return Nd;const t=["VERCEL_GIT_COMMIT_SHA","NEXT_PUBLIC_VERCEL_GIT_COMMIT_SHA","COMMIT_REF","RENDER_GIT_COMMIT","CI_COMMIT_SHA","CIRCLE_SHA1","CF_PAGES_COMMIT_SHA","REACT_APP_GIT_SHA","SOURCE_VERSION","GITHUB_SHA","TRAVIS_COMMIT","GIT_COMMIT","BUILD_VCS_NUMBER","bamboo_planRepository_revision","Build.SourceVersion","BITBUCKET_COMMIT","DRONE_COMMIT_SHA","SEMAPHORE_GIT_SHA","BUILDKITE_COMMIT"],e={};for(const n of t){const r=Wr(n);r!==void 0&&(e[n]=r)}return Nd=e,e}function $v(){return Wr("OTEL_ENABLED")==="true"||kn("OTEL_ENABLED")==="true"}class EC{constructor(){Object.defineProperty(this,"hasWarned",{enumerable:!0,configurable:!0,writable:!0,value:!1})}startActiveSpan(e,...n){!this.hasWarned&&$v()&&(console.warn('You have enabled OTEL export via the `OTEL_ENABLED` or `LANGSMITH_OTEL_ENABLED` environment variable, but have not initialized the required OTEL instances. Please add:\n```\nimport { initializeOTEL } from "langsmith/experimental/otel/setup";\ninitializeOTEL();\n```\nat the beginning of your code.'),this.hasWarned=!0);let r;if(n.length===1&&typeof n[0]=="function"?r=n[0]:n.length===2&&typeof n[1]=="function"?r=n[1]:n.length===3&&typeof n[2]=="function"&&(r=n[2]),typeof r=="function")return r()}}class TC{constructor(){Object.defineProperty(this,"mockTracer",{enumerable:!0,configurable:!0,writable:!0,value:new EC})}getTracer(e,n){return this.mockTracer}getActiveSpan(){}setSpan(e,n){return e}getSpan(e){}setSpanContext(e,n){return e}getTracerProvider(){}setGlobalTracerProvider(e){return!1}}class SC{active(){return{}}with(e,n){return n()}}const Pd=Symbol.for("ls:otel_trace"),Md=Symbol.for("ls:otel_context"),Jg=Symbol.for("ls:otel_get_default_otlp_tracer_provider"),xC=new TC,kC=new SC;class IC{getTraceInstance(){return globalThis[Pd]??xC}getContextInstance(){return globalThis[Md]??kC}initializeGlobalInstances(e){globalThis[Pd]===void 0&&(globalThis[Pd]=e.trace),globalThis[Md]===void 0&&(globalThis[Md]=e.context)}setDefaultOTLPTracerComponents(e){globalThis[Jg]=e}getDefaultOTLPTracerComponents(){return globalThis[Jg]??void 0}}const Up=new IC;function Rv(){return Up.getTraceInstance()}function AC(){return Up.getContextInstance()}function CC(){return Up.getDefaultOTLPTracerComponents()}const OC={llm:"chat",tool:"execute_tool",retriever:"embeddings",embedding:"embeddings",prompt:"chat"};function $C(t){return OC[t]||t}class RC{constructor(){Object.defineProperty(this,"spans",{enumerable:!0,configurable:!0,writable:!0,value:new Map})}exportBatch(e,n){for(const r of e)try{if(!r.run)continue;if(r.operation==="post"){const s=this.createSpanForRun(r,r.run,n.get(r.id));s&&!r.run.end_time&&this.spans.set(r.id,s)}else this.updateSpanForRun(r,r.run)}catch(s){console.error(`Error processing operation ${r.id}:`,s)}}createSpanForRun(e,n,r){const s=r&&Rv().getSpan(r);if(s)try{return this.finishSpanSetup(s,n,e)}catch(i){console.error(`Failed to create span for run ${e.id}:`,i);return}}finishSpanSetup(e,n,r){return this.setSpanAttributes(e,n,r),n.error?(e.setStatus({code:2}),e.recordException(new Error(n.error))):e.setStatus({code:1}),n.end_time&&e.end(new Date(n.end_time)),e}updateSpanForRun(e,n){try{const r=this.spans.get(e.id);if(!r){console.debug(`No span found for run ${e.id} during update`);return}this.setSpanAttributes(r,n,e),n.error?(r.setStatus({code:2}),r.recordException(new Error(n.error))):r.setStatus({code:1});const s=n.end_time;s&&(r.end(new Date(s)),this.spans.delete(e.id))}catch(r){console.error(`Failed to update span for run ${e.id}:`,r)}}extractModelName(e){var n;if((n=e.extra)!=null&&n.metadata){const r=e.extra.metadata;if(r.ls_model_name)return r.ls_model_name;if(r.invocation_params){const s=r.invocation_params;if(s.model)return s.model;if(s.model_name)return s.model_name}}}setSpanAttributes(e,n,r){var o;if("run_type"in n&&n.run_type){e.setAttribute(aC,n.run_type);const c=$C(n.run_type||"chain");e.setAttribute(jA,c)}"name"in n&&n.name&&e.setAttribute(oC,n.name),"session_id"in n&&n.session_id&&e.setAttribute(sC,n.session_id),"session_name"in n&&n.session_name&&e.setAttribute(iC,n.session_name),this.setGenAiSystem(e,n);const s=this.extractModelName(n);s&&e.setAttribute(Zg,s),"prompt_tokens"in n&&typeof n.prompt_tokens=="number"&&e.setAttribute(Vg,n.prompt_tokens),"completion_tokens"in n&&typeof n.completion_tokens=="number"&&e.setAttribute(Gg,n.completion_tokens),"total_tokens"in n&&typeof n.total_tokens=="number"&&e.setAttribute(Wg,n.total_tokens),this.setInvocationParameters(e,n);const i=((o=n.extra)==null?void 0:o.metadata)||{};for(const[c,l]of Object.entries(i))l!=null&&e.setAttribute(`${cC}.${c}`,String(l));const a=n.tags;if(a&&Array.isArray(a)?e.setAttribute(Hg,a.join(", ")):a&&e.setAttribute(Hg,String(a)),"serialized"in n&&typeof n.serialized=="object"){const c=n.serialized;c.name&&e.setAttribute(KA,String(c.name)),c.signature&&e.setAttribute(XA,String(c.signature)),c.doc&&e.setAttribute(YA,String(c.doc))}this.setIOAttributes(e,r)}setGenAiSystem(e,n){let r="langchain";const s=this.extractModelName(n);if(s){const i=s.toLowerCase();i.includes("anthropic")||i.startsWith("claude")?r="anthropic":i.includes("bedrock")?r="aws.bedrock":i.includes("azure")&&i.includes("openai")?r="az.ai.openai":i.includes("azure")&&i.includes("inference")?r="az.ai.inference":i.includes("cohere")?r="cohere":i.includes("deepseek")?r="deepseek":i.includes("gemini")?r="gemini":i.includes("groq")?r="groq":i.includes("watson")||i.includes("ibm")?r="ibm.watsonx.ai":i.includes("mistral")?r="mistral_ai":i.includes("gpt")||i.includes("openai")?r="openai":i.includes("perplexity")||i.includes("sonar")?r="perplexity":i.includes("vertex")?r="vertex_ai":(i.includes("xai")||i.includes("grok"))&&(r="xai")}e.setAttribute(DA,r)}setInvocationParameters(e,n){var s,i;if(!((i=(s=n.extra)==null?void 0:s.metadata)!=null&&i.invocation_params))return;const r=n.extra.metadata.invocation_params;r.max_tokens!==void 0&&e.setAttribute(FA,r.max_tokens),r.temperature!==void 0&&e.setAttribute(BA,r.temperature),r.top_p!==void 0&&e.setAttribute(zA,r.top_p),r.frequency_penalty!==void 0&&e.setAttribute(ZA,r.frequency_penalty),r.presence_penalty!==void 0&&e.setAttribute(VA,r.presence_penalty)}setIOAttributes(e,n){if(n.run.inputs)try{const r=n.run.inputs;typeof r=="object"&&r!==null&&(r.model&&Array.isArray(r.messages)&&e.setAttribute(Zg,r.model),r.stream!==void 0&&e.setAttribute(lC,r.stream),r.extra_headers&&e.setAttribute(uC,JSON.stringify(r.extra_headers)),r.extra_query&&e.setAttribute(qA,JSON.stringify(r.extra_query)),r.extra_body&&e.setAttribute(JA,JSON.stringify(r.extra_body))),e.setAttribute(WA,JSON.stringify(r))}catch(r){console.debug(`Failed to process inputs for run ${n.id}`,r)}if(n.run.outputs)try{const r=n.run.outputs,s=this.getUnifiedRunTokens(r);if(s&&(e.setAttribute(Vg,s[0]),e.setAttribute(Gg,s[1]),e.setAttribute(Wg,s[0]+s[1])),r&&typeof r=="object"){if(r.model&&e.setAttribute(UA,String(r.model)),r.id&&e.setAttribute(QA,r.id),r.choices&&Array.isArray(r.choices)){const i=r.choices.map(a=>a.finish_reason).filter(a=>a).map(String);i.length>0&&e.setAttribute(GA,i.join(", "))}if(r.service_tier&&e.setAttribute(eC,r.service_tier),r.system_fingerprint&&e.setAttribute(tC,r.system_fingerprint),r.usage_metadata&&typeof r.usage_metadata=="object"){const i=r.usage_metadata;i.input_token_details&&e.setAttribute(nC,JSON.stringify(i.input_token_details)),i.output_token_details&&e.setAttribute(rC,JSON.stringify(i.output_token_details))}}e.setAttribute(HA,JSON.stringify(r))}catch(r){console.debug(`Failed to process outputs for run ${n.id}`,r)}}getUnifiedRunTokens(e){if(!e)return null;let n=this.extractUnifiedRunTokens(e.usage_metadata);if(n)return n;const r=Object.keys(e);for(const a of r){const o=e[a];if(!(!o||typeof o!="object")&&(n=this.extractUnifiedRunTokens(o.usage_metadata),n||o.lc===1&&o.kwargs&&typeof o.kwargs=="object"&&(n=this.extractUnifiedRunTokens(o.kwargs.usage_metadata),n)))return n}const s=e.generations||[];if(!Array.isArray(s))return null;const i=Array.isArray(s[0])?s.flat():s;for(const a of i)if(typeof a=="object"&&a.message&&typeof a.message=="object"&&a.message.kwargs&&typeof a.message.kwargs=="object"&&(n=this.extractUnifiedRunTokens(a.message.kwargs.usage_metadata),n))return n;return null}extractUnifiedRunTokens(e){return!e||typeof e!="object"||typeof e.input_tokens!="number"||typeof e.output_tokens!="number"?null:[e.input_tokens,e.output_tokens]}}const NC=Object.prototype.toString,PC=t=>NC.call(t)==="[object Error]",MC=new Set(["network error","Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed","fetch failed","terminated"," A network error occurred.","Network connection lost"]);function LC(t){if(!(t&&PC(t)&&t.name==="TypeError"&&typeof t.message=="string"))return!1;const{message:n,stack:r}=t;return n==="Load failed"?r===void 0||"__sentry_captured__"in t:n.startsWith("error sending request for url")?!0:MC.has(n)}function jC(t){if(typeof t=="number"){if(t<0)throw new TypeError("Expected `retries` to be a non-negative number.");if(Number.isNaN(t))throw new TypeError("Expected `retries` to be a valid number or Infinity, got NaN.")}else if(t!==void 0)throw new TypeError("Expected `retries` to be a number or Infinity.")}function Ic(t,e,{min:n=0,allowInfinity:r=!1}={}){if(e!==void 0){if(typeof e!="number"||Number.isNaN(e))throw new TypeError(`Expected \`${t}\` to be a number${r?" or Infinity":""}.`);if(!r&&!Number.isFinite(e))throw new TypeError(`Expected \`${t}\` to be a finite number.`);if(e<n)throw new TypeError(`Expected \`${t}\` to be  ${n}.`)}}let DC=class extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,{message:e}=e):(this.originalError=new Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}};function UC(t,e){const n=Math.max(1,t+1),r=e.randomize?Math.random()+1:1;let s=Math.round(r*e.minTimeout*e.factor**(n-1));return s=Math.min(s,e.maxTimeout),s}function Kg(t,e){return Number.isFinite(e)?e-(performance.now()-t):e}async function FC({error:t,attemptNumber:e,retriesConsumed:n,startTime:r,options:s}){var f,m,g;const i=t instanceof Error?t:new TypeError(`Non-error was thrown: "${t}". You should only throw errors.`);if(i instanceof DC)throw i.originalError;const a=Number.isFinite(s.retries)?Math.max(0,s.retries-n):s.retries,o=s.maxRetryTime??Number.POSITIVE_INFINITY,c=Object.freeze({error:i,attemptNumber:e,retriesLeft:a,retriesConsumed:n});if(await s.onFailedAttempt(c),Kg(r,o)<=0)throw i;const l=await s.shouldConsumeRetry(c),u=Kg(r,o);if(u<=0||a<=0)throw i;if(i instanceof TypeError&&!LC(i)){if(l)throw i;return(f=s.signal)==null||f.throwIfAborted(),!1}if(!await s.shouldRetry(c))throw i;if(!l)return(m=s.signal)==null||m.throwIfAborted(),!1;const d=UC(n,s),h=Math.min(d,u);return h>0&&await new Promise((w,b)=>{var T,A;const y=()=>{var I;clearTimeout(v),(I=s.signal)==null||I.removeEventListener("abort",y),b(s.signal.reason)},v=setTimeout(()=>{var I;(I=s.signal)==null||I.removeEventListener("abort",y),w()},h);s.unref&&((T=v.unref)==null||T.call(v)),(A=s.signal)==null||A.addEventListener("abort",y,{once:!0})}),(g=s.signal)==null||g.throwIfAborted(),!0}async function BC(t,e={}){var i,a,o;if(e={...e},jC(e.retries),Object.hasOwn(e,"forever"))throw new Error("The `forever` option is no longer supported. For many use-cases, you can set `retries: Infinity` instead.");e.retries??(e.retries=10),e.factor??(e.factor=2),e.minTimeout??(e.minTimeout=1e3),e.maxTimeout??(e.maxTimeout=Number.POSITIVE_INFINITY),e.maxRetryTime??(e.maxRetryTime=Number.POSITIVE_INFINITY),e.randomize??(e.randomize=!1),e.onFailedAttempt??(e.onFailedAttempt=()=>{}),e.shouldRetry??(e.shouldRetry=()=>!0),e.shouldConsumeRetry??(e.shouldConsumeRetry=()=>!0),Ic("factor",e.factor,{min:0,allowInfinity:!1}),Ic("minTimeout",e.minTimeout,{min:0,allowInfinity:!1}),Ic("maxTimeout",e.maxTimeout,{min:0,allowInfinity:!0}),Ic("maxRetryTime",e.maxRetryTime,{min:0,allowInfinity:!0}),e.factor>0||(e.factor=1),(i=e.signal)==null||i.throwIfAborted();let n=0,r=0;const s=performance.now();for(;!Number.isFinite(e.retries)||r<=e.retries;){n++;try{(a=e.signal)==null||a.throwIfAborted();const c=await t(n);return(o=e.signal)==null||o.throwIfAborted(),c}catch(c){await FC({error:c,attemptNumber:n,retriesConsumed:r,startTime:s,options:e})&&r++}}throw new Error("Retry attempts exhausted without throwing an error.")}var Nv={},Pv={exports:{}};(function(t){var e=Object.prototype.hasOwnProperty,n="~";function r(){}Object.create&&(r.prototype=Object.create(null),new r().__proto__||(n=!1));function s(c,l,u){this.fn=c,this.context=l,this.once=u||!1}function i(c,l,u,d,h){if(typeof u!="function")throw new TypeError("The listener must be a function");var f=new s(u,d||c,h),m=n?n+l:l;return c._events[m]?c._events[m].fn?c._events[m]=[c._events[m],f]:c._events[m].push(f):(c._events[m]=f,c._eventsCount++),c}function a(c,l){--c._eventsCount===0?c._events=new r:delete c._events[l]}function o(){this._events=new r,this._eventsCount=0}o.prototype.eventNames=function(){var l=[],u,d;if(this._eventsCount===0)return l;for(d in u=this._events)e.call(u,d)&&l.push(n?d.slice(1):d);return Object.getOwnPropertySymbols?l.concat(Object.getOwnPropertySymbols(u)):l},o.prototype.listeners=function(l){var u=n?n+l:l,d=this._events[u];if(!d)return[];if(d.fn)return[d.fn];for(var h=0,f=d.length,m=new Array(f);h<f;h++)m[h]=d[h].fn;return m},o.prototype.listenerCount=function(l){var u=n?n+l:l,d=this._events[u];return d?d.fn?1:d.length:0},o.prototype.emit=function(l,u,d,h,f,m){var g=n?n+l:l;if(!this._events[g])return!1;var w=this._events[g],b=arguments.length,y,v;if(w.fn){switch(w.once&&this.removeListener(l,w.fn,void 0,!0),b){case 1:return w.fn.call(w.context),!0;case 2:return w.fn.call(w.context,u),!0;case 3:return w.fn.call(w.context,u,d),!0;case 4:return w.fn.call(w.context,u,d,h),!0;case 5:return w.fn.call(w.context,u,d,h,f),!0;case 6:return w.fn.call(w.context,u,d,h,f,m),!0}for(v=1,y=new Array(b-1);v<b;v++)y[v-1]=arguments[v];w.fn.apply(w.context,y)}else{var T=w.length,A;for(v=0;v<T;v++)switch(w[v].once&&this.removeListener(l,w[v].fn,void 0,!0),b){case 1:w[v].fn.call(w[v].context);break;case 2:w[v].fn.call(w[v].context,u);break;case 3:w[v].fn.call(w[v].context,u,d);break;case 4:w[v].fn.call(w[v].context,u,d,h);break;default:if(!y)for(A=1,y=new Array(b-1);A<b;A++)y[A-1]=arguments[A];w[v].fn.apply(w[v].context,y)}}return!0},o.prototype.on=function(l,u,d){return i(this,l,u,d,!1)},o.prototype.once=function(l,u,d){return i(this,l,u,d,!0)},o.prototype.removeListener=function(l,u,d,h){var f=n?n+l:l;if(!this._events[f])return this;if(!u)return a(this,f),this;var m=this._events[f];if(m.fn)m.fn===u&&(!h||m.once)&&(!d||m.context===d)&&a(this,f);else{for(var g=0,w=[],b=m.length;g<b;g++)(m[g].fn!==u||h&&!m[g].once||d&&m[g].context!==d)&&w.push(m[g]);w.length?this._events[f]=w.length===1?w[0]:w:a(this,f)}return this},o.prototype.removeAllListeners=function(l){var u;return l?(u=n?n+l:l,this._events[u]&&a(this,u)):(this._events=new r,this._eventsCount=0),this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prefixed=n,o.EventEmitter=o,t.exports=o})(Pv);var zC=Pv.exports,Pu={exports:{}},ZC=(t,e)=>(e=e||(()=>{}),t.then(n=>new Promise(r=>{r(e())}).then(()=>n),n=>new Promise(r=>{r(e())}).then(()=>{throw n})));const VC=ZC;class Mv extends Error{constructor(e){super(e),this.name="TimeoutError"}}const Lv=(t,e,n)=>new Promise((r,s)=>{if(typeof e!="number"||e<0)throw new TypeError("Expected `milliseconds` to be a positive number");if(e===1/0){r(t);return}const i=setTimeout(()=>{if(typeof n=="function"){try{r(n())}catch(c){s(c)}return}const a=typeof n=="string"?n:`Promise timed out after ${e} milliseconds`,o=n instanceof Error?n:new Mv(a);typeof t.cancel=="function"&&t.cancel(),s(o)},e);VC(t.then(r,s),()=>{clearTimeout(i)})});Pu.exports=Lv;Pu.exports.default=Lv;Pu.exports.TimeoutError=Mv;var GC=Pu.exports,Fp={},Bp={};Object.defineProperty(Bp,"__esModule",{value:!0});function WC(t,e,n){let r=0,s=t.length;for(;s>0;){const i=s/2|0;let a=r+i;n(t[a],e)<=0?(r=++a,s-=i+1):s=i}return r}Bp.default=WC;Object.defineProperty(Fp,"__esModule",{value:!0});const HC=Bp;class qC{constructor(){this._queue=[]}enqueue(e,n){n=Object.assign({priority:0},n);const r={priority:n.priority,run:e};if(this.size&&this._queue[this.size-1].priority>=n.priority){this._queue.push(r);return}const s=HC.default(this._queue,r,(i,a)=>a.priority-i.priority);this._queue.splice(s,0,r)}dequeue(){const e=this._queue.shift();return e==null?void 0:e.run}filter(e){return this._queue.filter(n=>n.priority===e.priority).map(n=>n.run)}get size(){return this._queue.length}}Fp.default=qC;Object.defineProperty(Nv,"__esModule",{value:!0});const JC=zC,jv=GC,KC=Fp,Ac=()=>{},XC=new jv.TimeoutError;class YC extends JC{constructor(e){var n,r,s,i;if(super(),this._intervalCount=0,this._intervalEnd=0,this._pendingCount=0,this._resolveEmpty=Ac,this._resolveIdle=Ac,e=Object.assign({carryoverConcurrencyCount:!1,intervalCap:1/0,interval:0,concurrency:1/0,autoStart:!0,queueClass:KC.default},e),!(typeof e.intervalCap=="number"&&e.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${(r=(n=e.intervalCap)===null||n===void 0?void 0:n.toString())!==null&&r!==void 0?r:""}\` (${typeof e.intervalCap})`);if(e.interval===void 0||!(Number.isFinite(e.interval)&&e.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${(i=(s=e.interval)===null||s===void 0?void 0:s.toString())!==null&&i!==void 0?i:""}\` (${typeof e.interval})`);this._carryoverConcurrencyCount=e.carryoverConcurrencyCount,this._isIntervalIgnored=e.intervalCap===1/0||e.interval===0,this._intervalCap=e.intervalCap,this._interval=e.interval,this._queue=new e.queueClass,this._queueClass=e.queueClass,this.concurrency=e.concurrency,this._timeout=e.timeout,this._throwOnTimeout=e.throwOnTimeout===!0,this._isPaused=e.autoStart===!1}get _doesIntervalAllowAnother(){return this._isIntervalIgnored||this._intervalCount<this._intervalCap}get _doesConcurrentAllowAnother(){return this._pendingCount<this._concurrency}_next(){this._pendingCount--,this._tryToStartAnother(),this.emit("next")}_resolvePromises(){this._resolveEmpty(),this._resolveEmpty=Ac,this._pendingCount===0&&(this._resolveIdle(),this._resolveIdle=Ac,this.emit("idle"))}_onResumeInterval(){this._onInterval(),this._initializeIntervalIfNeeded(),this._timeoutId=void 0}_isIntervalPaused(){const e=Date.now();if(this._intervalId===void 0){const n=this._intervalEnd-e;if(n<0)this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0;else return this._timeoutId===void 0&&(this._timeoutId=setTimeout(()=>{this._onResumeInterval()},n)),!0}return!1}_tryToStartAnother(){if(this._queue.size===0)return this._intervalId&&clearInterval(this._intervalId),this._intervalId=void 0,this._resolvePromises(),!1;if(!this._isPaused){const e=!this._isIntervalPaused();if(this._doesIntervalAllowAnother&&this._doesConcurrentAllowAnother){const n=this._queue.dequeue();return n?(this.emit("active"),n(),e&&this._initializeIntervalIfNeeded(),!0):!1}}return!1}_initializeIntervalIfNeeded(){this._isIntervalIgnored||this._intervalId!==void 0||(this._intervalId=setInterval(()=>{this._onInterval()},this._interval),this._intervalEnd=Date.now()+this._interval)}_onInterval(){this._intervalCount===0&&this._pendingCount===0&&this._intervalId&&(clearInterval(this._intervalId),this._intervalId=void 0),this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0,this._processQueue()}_processQueue(){for(;this._tryToStartAnother(););}get concurrency(){return this._concurrency}set concurrency(e){if(!(typeof e=="number"&&e>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${e}\` (${typeof e})`);this._concurrency=e,this._processQueue()}async add(e,n={}){return new Promise((r,s)=>{const i=async()=>{this._pendingCount++,this._intervalCount++;try{const a=this._timeout===void 0&&n.timeout===void 0?e():jv.default(Promise.resolve(e()),n.timeout===void 0?this._timeout:n.timeout,()=>{(n.throwOnTimeout===void 0?this._throwOnTimeout:n.throwOnTimeout)&&s(XC)});r(await a)}catch(a){s(a)}this._next()};this._queue.enqueue(i,n),this._tryToStartAnother(),this.emit("add")})}async addAll(e,n){return Promise.all(e.map(async r=>this.add(r,n)))}start(){return this._isPaused?(this._isPaused=!1,this._processQueue(),this):this}pause(){this._isPaused=!0}clear(){this._queue=new this._queueClass}async onEmpty(){if(this._queue.size!==0)return new Promise(e=>{const n=this._resolveEmpty;this._resolveEmpty=()=>{n(),e()}})}async onIdle(){if(!(this._pendingCount===0&&this._queue.size===0))return new Promise(e=>{const n=this._resolveIdle;this._resolveIdle=()=>{n(),e()}})}get size(){return this._queue.size}sizeBy(e){return this._queue.filter(e).length}get pending(){return this._pendingCount}get isPaused(){return this._isPaused}get timeout(){return this._timeout}set timeout(e){this._timeout=e}}var os=Nv.default=YC;const QC=[408,425,429,500,502,503,504];let Xg=class{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxQueueSizeBytes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedResponseHook",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queueSizeBytes",{enumerable:!0,configurable:!0,writable:!0,value:0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,this.maxQueueSizeBytes=e.maxQueueSizeBytes,"default"in os?this.queue=new os.default({concurrency:this.maxConcurrency}):this.queue=new os({concurrency:this.maxConcurrency}),this.onFailedResponseHook=e==null?void 0:e.onFailedResponseHook}call(e,...n){return this.callWithOptions({},e,...n)}callWithOptions(e,n,...r){const s=e.sizeBytes??0;if(this.maxQueueSizeBytes!==void 0&&s>0&&this.queueSizeBytes+s>this.maxQueueSizeBytes)return Promise.reject(new Error(`Queue size limit (${this.maxQueueSizeBytes} bytes) exceeded. Current queue size: ${this.queueSizeBytes} bytes, attempted addition: ${s} bytes.`));s>0&&(this.queueSizeBytes+=s);const i=this.onFailedResponseHook;let a=this.queue.add(()=>BC(()=>n(...r).catch(o=>{throw o instanceof Error?o:new Error(o)}),{async onFailedAttempt({error:o}){if(o.message.startsWith("Cancel")||o.message.startsWith("TimeoutError")||o.name==="TimeoutError"||o.message.startsWith("AbortError")||(o==null?void 0:o.code)==="ECONNABORTED")throw o;const c=o==null?void 0:o.response;if(i&&await i(c))return;const l=(c==null?void 0:c.status)??(o==null?void 0:o.status);if(l&&!QC.includes(+l))throw o},retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0});return s>0&&(a=a.finally(()=>{this.queueSizeBytes-=s})),e.signal?Promise.race([a,new Promise((o,c)=>{var l;(l=e.signal)==null||l.addEventListener("abort",()=>{c(new Error("AbortError"))})})]):a}};function Yg(t){return typeof(t==null?void 0:t._getType)=="function"}function Qg(t){const e={type:t._getType(),data:{content:t.content}};return t!=null&&t.additional_kwargs&&Object.keys(t.additional_kwargs).length>0&&(e.data.additional_kwargs={...t.additional_kwargs}),e}var zh={exports:{}};const eO="2.0.0",Dv=256,tO=Number.MAX_SAFE_INTEGER||9007199254740991,nO=16,rO=Dv-6,sO=["major","premajor","minor","preminor","patch","prepatch","prerelease"];var Mu={MAX_LENGTH:Dv,MAX_SAFE_COMPONENT_LENGTH:nO,MAX_SAFE_BUILD_LENGTH:rO,MAX_SAFE_INTEGER:tO,RELEASE_TYPES:sO,SEMVER_SPEC_VERSION:eO,FLAG_INCLUDE_PRERELEASE:1,FLAG_LOOSE:2},Ld={};const iO=typeof Gn=="object"&&Ld&&Ld.NODE_DEBUG&&/\bsemver\b/i.test(Ld.NODE_DEBUG)?(...t)=>console.error("SEMVER",...t):()=>{};var Lu=iO;(function(t,e){const{MAX_SAFE_COMPONENT_LENGTH:n,MAX_SAFE_BUILD_LENGTH:r,MAX_LENGTH:s}=Mu,i=Lu;e=t.exports={};const a=e.re=[],o=e.safeRe=[],c=e.src=[],l=e.safeSrc=[],u=e.t={};let d=0;const h="[a-zA-Z0-9-]",f=[["\\s",1],["\\d",s],[h,r]],m=w=>{for(const[b,y]of f)w=w.split(`${b}*`).join(`${b}{0,${y}}`).split(`${b}+`).join(`${b}{1,${y}}`);return w},g=(w,b,y)=>{const v=m(b),T=d++;i(w,T,b),u[w]=T,c[T]=b,l[T]=v,a[T]=new RegExp(b,y?"g":void 0),o[T]=new RegExp(v,y?"g":void 0)};g("NUMERICIDENTIFIER","0|[1-9]\\d*"),g("NUMERICIDENTIFIERLOOSE","\\d+"),g("NONNUMERICIDENTIFIER",`\\d*[a-zA-Z-]${h}*`),g("MAINVERSION",`(${c[u.NUMERICIDENTIFIER]})\\.(${c[u.NUMERICIDENTIFIER]})\\.(${c[u.NUMERICIDENTIFIER]})`),g("MAINVERSIONLOOSE",`(${c[u.NUMERICIDENTIFIERLOOSE]})\\.(${c[u.NUMERICIDENTIFIERLOOSE]})\\.(${c[u.NUMERICIDENTIFIERLOOSE]})`),g("PRERELEASEIDENTIFIER",`(?:${c[u.NONNUMERICIDENTIFIER]}|${c[u.NUMERICIDENTIFIER]})`),g("PRERELEASEIDENTIFIERLOOSE",`(?:${c[u.NONNUMERICIDENTIFIER]}|${c[u.NUMERICIDENTIFIERLOOSE]})`),g("PRERELEASE",`(?:-(${c[u.PRERELEASEIDENTIFIER]}(?:\\.${c[u.PRERELEASEIDENTIFIER]})*))`),g("PRERELEASELOOSE",`(?:-?(${c[u.PRERELEASEIDENTIFIERLOOSE]}(?:\\.${c[u.PRERELEASEIDENTIFIERLOOSE]})*))`),g("BUILDIDENTIFIER",`${h}+`),g("BUILD",`(?:\\+(${c[u.BUILDIDENTIFIER]}(?:\\.${c[u.BUILDIDENTIFIER]})*))`),g("FULLPLAIN",`v?${c[u.MAINVERSION]}${c[u.PRERELEASE]}?${c[u.BUILD]}?`),g("FULL",`^${c[u.FULLPLAIN]}$`),g("LOOSEPLAIN",`[v=\\s]*${c[u.MAINVERSIONLOOSE]}${c[u.PRERELEASELOOSE]}?${c[u.BUILD]}?`),g("LOOSE",`^${c[u.LOOSEPLAIN]}$`),g("GTLT","((?:<|>)?=?)"),g("XRANGEIDENTIFIERLOOSE",`${c[u.NUMERICIDENTIFIERLOOSE]}|x|X|\\*`),g("XRANGEIDENTIFIER",`${c[u.NUMERICIDENTIFIER]}|x|X|\\*`),g("XRANGEPLAIN",`[v=\\s]*(${c[u.XRANGEIDENTIFIER]})(?:\\.(${c[u.XRANGEIDENTIFIER]})(?:\\.(${c[u.XRANGEIDENTIFIER]})(?:${c[u.PRERELEASE]})?${c[u.BUILD]}?)?)?`),g("XRANGEPLAINLOOSE",`[v=\\s]*(${c[u.XRANGEIDENTIFIERLOOSE]})(?:\\.(${c[u.XRANGEIDENTIFIERLOOSE]})(?:\\.(${c[u.XRANGEIDENTIFIERLOOSE]})(?:${c[u.PRERELEASELOOSE]})?${c[u.BUILD]}?)?)?`),g("XRANGE",`^${c[u.GTLT]}\\s*${c[u.XRANGEPLAIN]}$`),g("XRANGELOOSE",`^${c[u.GTLT]}\\s*${c[u.XRANGEPLAINLOOSE]}$`),g("COERCEPLAIN",`(^|[^\\d])(\\d{1,${n}})(?:\\.(\\d{1,${n}}))?(?:\\.(\\d{1,${n}}))?`),g("COERCE",`${c[u.COERCEPLAIN]}(?:$|[^\\d])`),g("COERCEFULL",c[u.COERCEPLAIN]+`(?:${c[u.PRERELEASE]})?(?:${c[u.BUILD]})?(?:$|[^\\d])`),g("COERCERTL",c[u.COERCE],!0),g("COERCERTLFULL",c[u.COERCEFULL],!0),g("LONETILDE","(?:~>?)"),g("TILDETRIM",`(\\s*)${c[u.LONETILDE]}\\s+`,!0),e.tildeTrimReplace="$1~",g("TILDE",`^${c[u.LONETILDE]}${c[u.XRANGEPLAIN]}$`),g("TILDELOOSE",`^${c[u.LONETILDE]}${c[u.XRANGEPLAINLOOSE]}$`),g("LONECARET","(?:\\^)"),g("CARETTRIM",`(\\s*)${c[u.LONECARET]}\\s+`,!0),e.caretTrimReplace="$1^",g("CARET",`^${c[u.LONECARET]}${c[u.XRANGEPLAIN]}$`),g("CARETLOOSE",`^${c[u.LONECARET]}${c[u.XRANGEPLAINLOOSE]}$`),g("COMPARATORLOOSE",`^${c[u.GTLT]}\\s*(${c[u.LOOSEPLAIN]})$|^$`),g("COMPARATOR",`^${c[u.GTLT]}\\s*(${c[u.FULLPLAIN]})$|^$`),g("COMPARATORTRIM",`(\\s*)${c[u.GTLT]}\\s*(${c[u.LOOSEPLAIN]}|${c[u.XRANGEPLAIN]})`,!0),e.comparatorTrimReplace="$1$2$3",g("HYPHENRANGE",`^\\s*(${c[u.XRANGEPLAIN]})\\s+-\\s+(${c[u.XRANGEPLAIN]})\\s*$`),g("HYPHENRANGELOOSE",`^\\s*(${c[u.XRANGEPLAINLOOSE]})\\s+-\\s+(${c[u.XRANGEPLAINLOOSE]})\\s*$`),g("STAR","(<|>)?=?\\s*\\*"),g("GTE0","^\\s*>=\\s*0\\.0\\.0\\s*$"),g("GTE0PRE","^\\s*>=\\s*0\\.0\\.0-0\\s*$")})(zh,zh.exports);var tc=zh.exports;const aO=Object.freeze({loose:!0}),oO=Object.freeze({}),cO=t=>t?typeof t!="object"?aO:t:oO;var zp=cO;const ey=/^[0-9]+$/,Uv=(t,e)=>{if(typeof t=="number"&&typeof e=="number")return t===e?0:t<e?-1:1;const n=ey.test(t),r=ey.test(e);return n&&r&&(t=+t,e=+e),t===e?0:n&&!r?-1:r&&!n?1:t<e?-1:1},lO=(t,e)=>Uv(e,t);var Fv={compareIdentifiers:Uv,rcompareIdentifiers:lO};const Cc=Lu,{MAX_LENGTH:ty,MAX_SAFE_INTEGER:Oc}=Mu,{safeRe:$c,t:Rc}=tc,uO=zp,{compareIdentifiers:jd}=Fv;let dO=class $r{constructor(e,n){if(n=uO(n),e instanceof $r){if(e.loose===!!n.loose&&e.includePrerelease===!!n.includePrerelease)return e;e=e.version}else if(typeof e!="string")throw new TypeError(`Invalid version. Must be a string. Got type "${typeof e}".`);if(e.length>ty)throw new TypeError(`version is longer than ${ty} characters`);Cc("SemVer",e,n),this.options=n,this.loose=!!n.loose,this.includePrerelease=!!n.includePrerelease;const r=e.trim().match(n.loose?$c[Rc.LOOSE]:$c[Rc.FULL]);if(!r)throw new TypeError(`Invalid Version: ${e}`);if(this.raw=e,this.major=+r[1],this.minor=+r[2],this.patch=+r[3],this.major>Oc||this.major<0)throw new TypeError("Invalid major version");if(this.minor>Oc||this.minor<0)throw new TypeError("Invalid minor version");if(this.patch>Oc||this.patch<0)throw new TypeError("Invalid patch version");r[4]?this.prerelease=r[4].split(".").map(s=>{if(/^[0-9]+$/.test(s)){const i=+s;if(i>=0&&i<Oc)return i}return s}):this.prerelease=[],this.build=r[5]?r[5].split("."):[],this.format()}format(){return this.version=`${this.major}.${this.minor}.${this.patch}`,this.prerelease.length&&(this.version+=`-${this.prerelease.join(".")}`),this.version}toString(){return this.version}compare(e){if(Cc("SemVer.compare",this.version,this.options,e),!(e instanceof $r)){if(typeof e=="string"&&e===this.version)return 0;e=new $r(e,this.options)}return e.version===this.version?0:this.compareMain(e)||this.comparePre(e)}compareMain(e){return e instanceof $r||(e=new $r(e,this.options)),this.major<e.major?-1:this.major>e.major?1:this.minor<e.minor?-1:this.minor>e.minor?1:this.patch<e.patch?-1:this.patch>e.patch?1:0}comparePre(e){if(e instanceof $r||(e=new $r(e,this.options)),this.prerelease.length&&!e.prerelease.length)return-1;if(!this.prerelease.length&&e.prerelease.length)return 1;if(!this.prerelease.length&&!e.prerelease.length)return 0;let n=0;do{const r=this.prerelease[n],s=e.prerelease[n];if(Cc("prerelease compare",n,r,s),r===void 0&&s===void 0)return 0;if(s===void 0)return 1;if(r===void 0)return-1;if(r===s)continue;return jd(r,s)}while(++n)}compareBuild(e){e instanceof $r||(e=new $r(e,this.options));let n=0;do{const r=this.build[n],s=e.build[n];if(Cc("build compare",n,r,s),r===void 0&&s===void 0)return 0;if(s===void 0)return 1;if(r===void 0)return-1;if(r===s)continue;return jd(r,s)}while(++n)}inc(e,n,r){if(e.startsWith("pre")){if(!n&&r===!1)throw new Error("invalid increment argument: identifier is empty");if(n){const s=`-${n}`.match(this.options.loose?$c[Rc.PRERELEASELOOSE]:$c[Rc.PRERELEASE]);if(!s||s[1]!==n)throw new Error(`invalid identifier: ${n}`)}}switch(e){case"premajor":this.prerelease.length=0,this.patch=0,this.minor=0,this.major++,this.inc("pre",n,r);break;case"preminor":this.prerelease.length=0,this.patch=0,this.minor++,this.inc("pre",n,r);break;case"prepatch":this.prerelease.length=0,this.inc("patch",n,r),this.inc("pre",n,r);break;case"prerelease":this.prerelease.length===0&&this.inc("patch",n,r),this.inc("pre",n,r);break;case"release":if(this.prerelease.length===0)throw new Error(`version ${this.raw} is not a prerelease`);this.prerelease.length=0;break;case"major":(this.minor!==0||this.patch!==0||this.prerelease.length===0)&&this.major++,this.minor=0,this.patch=0,this.prerelease=[];break;case"minor":(this.patch!==0||this.prerelease.length===0)&&this.minor++,this.patch=0,this.prerelease=[];break;case"patch":this.prerelease.length===0&&this.patch++,this.prerelease=[];break;case"pre":{const s=Number(r)?1:0;if(this.prerelease.length===0)this.prerelease=[s];else{let i=this.prerelease.length;for(;--i>=0;)typeof this.prerelease[i]=="number"&&(this.prerelease[i]++,i=-2);if(i===-1){if(n===this.prerelease.join(".")&&r===!1)throw new Error("invalid increment argument: identifier already exists");this.prerelease.push(s)}}if(n){let i=[n,s];r===!1&&(i=[n]),jd(this.prerelease[0],n)===0?isNaN(this.prerelease[1])&&(this.prerelease=i):this.prerelease=i}break}default:throw new Error(`invalid increment argument: ${e}`)}return this.raw=this.format(),this.build.length&&(this.raw+=`+${this.build.join(".")}`),this}};var Zp=dO;const ny=Zp,hO=(t,e,n)=>new ny(t,n).compare(new ny(e,n));var Ra=hO;const fO=Ra,pO=(t,e,n)=>fO(t,e,n)>0;var mO=pO;const gO=Ra,yO=(t,e,n)=>gO(t,e,n)<0;var _O=yO;const wO=Ra,vO=(t,e,n)=>wO(t,e,n)===0;var bO=vO;const EO=Ra,TO=(t,e,n)=>EO(t,e,n)!==0;var SO=TO;const xO=Ra,kO=(t,e,n)=>xO(t,e,n)>=0;var IO=kO;const AO=Ra,CO=(t,e,n)=>AO(t,e,n)<=0;var OO=CO;const $O=bO,RO=SO,NO=mO,PO=IO,MO=_O,LO=OO,jO=(t,e,n,r)=>{switch(e){case"===":return typeof t=="object"&&(t=t.version),typeof n=="object"&&(n=n.version),t===n;case"!==":return typeof t=="object"&&(t=t.version),typeof n=="object"&&(n=n.version),t!==n;case"":case"=":case"==":return $O(t,n,r);case"!=":return RO(t,n,r);case">":return NO(t,n,r);case">=":return PO(t,n,r);case"<":return MO(t,n,r);case"<=":return LO(t,n,r);default:throw new TypeError(`Invalid operator: ${e}`)}};var DO=jO;const{safeRe:Y9,t:Q9}=tc;class UO{constructor(){this.max=1e3,this.map=new Map}get(e){const n=this.map.get(e);if(n!==void 0)return this.map.delete(e),this.map.set(e,n),n}delete(e){return this.map.delete(e)}set(e,n){if(!this.delete(e)&&n!==void 0){if(this.map.size>=this.max){const s=this.map.keys().next().value;this.delete(s)}this.map.set(e,n)}return this}}var FO=UO,Dd,ry;function Ir(){if(ry)return Dd;ry=1;const t=/\s+/g;class e{constructor(V,H){if(H=s(H),V instanceof e)return V.loose===!!H.loose&&V.includePrerelease===!!H.includePrerelease?V:new e(V.raw,H);if(V instanceof i)return this.raw=V.value,this.set=[[V]],this.formatted=void 0,this;if(this.options=H,this.loose=!!H.loose,this.includePrerelease=!!H.includePrerelease,this.raw=V.trim().replace(t," "),this.set=this.raw.split("||").map(oe=>this.parseRange(oe.trim())).filter(oe=>oe.length),!this.set.length)throw new TypeError(`Invalid SemVer Range: ${this.raw}`);if(this.set.length>1){const oe=this.set[0];if(this.set=this.set.filter(fe=>!g(fe[0])),this.set.length===0)this.set=[oe];else if(this.set.length>1){for(const fe of this.set)if(fe.length===1&&w(fe[0])){this.set=[fe];break}}}this.formatted=void 0}get range(){if(this.formatted===void 0){this.formatted="";for(let V=0;V<this.set.length;V++){V>0&&(this.formatted+="||");const H=this.set[V];for(let oe=0;oe<H.length;oe++)oe>0&&(this.formatted+=" "),this.formatted+=H[oe].toString().trim()}}return this.formatted}format(){return this.range}toString(){return this.range}parseRange(V){const oe=((this.options.includePrerelease&&f)|(this.options.loose&&m))+":"+V,fe=r.get(oe);if(fe)return fe;const se=this.options.loose,ye=se?c[l.HYPHENRANGELOOSE]:c[l.HYPHENRANGE];V=V.replace(ye,W(this.options.includePrerelease)),a("hyphen replace",V),V=V.replace(c[l.COMPARATORTRIM],u),a("comparator trim",V),V=V.replace(c[l.TILDETRIM],d),a("tilde trim",V),V=V.replace(c[l.CARETTRIM],h),a("caret trim",V);let Ne=V.split(" ").map(X=>y(X,this.options)).join(" ").split(/\s+/).map(X=>P(X,this.options));se&&(Ne=Ne.filter(X=>(a("loose invalid filter",X,this.options),!!X.match(c[l.COMPARATORLOOSE])))),a("range list",Ne);const K=new Map,re=Ne.map(X=>new i(X,this.options));for(const X of re){if(g(X))return[X];K.set(X.value,X)}K.size>1&&K.has("")&&K.delete("");const de=[...K.values()];return r.set(oe,de),de}intersects(V,H){if(!(V instanceof e))throw new TypeError("a Range is required");return this.set.some(oe=>b(oe,H)&&V.set.some(fe=>b(fe,H)&&oe.every(se=>fe.every(ye=>se.intersects(ye,H)))))}test(V){if(!V)return!1;if(typeof V=="string")try{V=new o(V,this.options)}catch{return!1}for(let H=0;H<this.set.length;H++)if(ne(this.set[H],V,this.options))return!0;return!1}}Dd=e;const n=FO,r=new n,s=zp,i=ju(),a=Lu,o=Zp,{safeRe:c,t:l,comparatorTrimReplace:u,tildeTrimReplace:d,caretTrimReplace:h}=tc,{FLAG_INCLUDE_PRERELEASE:f,FLAG_LOOSE:m}=Mu,g=B=>B.value==="<0.0.0-0",w=B=>B.value==="",b=(B,V)=>{let H=!0;const oe=B.slice();let fe=oe.pop();for(;H&&oe.length;)H=oe.every(se=>fe.intersects(se,V)),fe=oe.pop();return H},y=(B,V)=>(B=B.replace(c[l.BUILD],""),a("comp",B,V),B=I(B,V),a("caret",B),B=T(B,V),a("tildes",B),B=S(B,V),a("xrange",B),B=j(B,V),a("stars",B),B),v=B=>!B||B.toLowerCase()==="x"||B==="*",T=(B,V)=>B.trim().split(/\s+/).map(H=>A(H,V)).join(" "),A=(B,V)=>{const H=V.loose?c[l.TILDELOOSE]:c[l.TILDE];return B.replace(H,(oe,fe,se,ye,Ne)=>{a("tilde",B,oe,fe,se,ye,Ne);let K;return v(fe)?K="":v(se)?K=`>=${fe}.0.0 <${+fe+1}.0.0-0`:v(ye)?K=`>=${fe}.${se}.0 <${fe}.${+se+1}.0-0`:Ne?(a("replaceTilde pr",Ne),K=`>=${fe}.${se}.${ye}-${Ne} <${fe}.${+se+1}.0-0`):K=`>=${fe}.${se}.${ye} <${fe}.${+se+1}.0-0`,a("tilde return",K),K})},I=(B,V)=>B.trim().split(/\s+/).map(H=>$(H,V)).join(" "),$=(B,V)=>{a("caret",B,V);const H=V.loose?c[l.CARETLOOSE]:c[l.CARET],oe=V.includePrerelease?"-0":"";return B.replace(H,(fe,se,ye,Ne,K)=>{a("caret",B,fe,se,ye,Ne,K);let re;return v(se)?re="":v(ye)?re=`>=${se}.0.0${oe} <${+se+1}.0.0-0`:v(Ne)?se==="0"?re=`>=${se}.${ye}.0${oe} <${se}.${+ye+1}.0-0`:re=`>=${se}.${ye}.0${oe} <${+se+1}.0.0-0`:K?(a("replaceCaret pr",K),se==="0"?ye==="0"?re=`>=${se}.${ye}.${Ne}-${K} <${se}.${ye}.${+Ne+1}-0`:re=`>=${se}.${ye}.${Ne}-${K} <${se}.${+ye+1}.0-0`:re=`>=${se}.${ye}.${Ne}-${K} <${+se+1}.0.0-0`):(a("no pr"),se==="0"?ye==="0"?re=`>=${se}.${ye}.${Ne}${oe} <${se}.${ye}.${+Ne+1}-0`:re=`>=${se}.${ye}.${Ne}${oe} <${se}.${+ye+1}.0-0`:re=`>=${se}.${ye}.${Ne} <${+se+1}.0.0-0`),a("caret return",re),re})},S=(B,V)=>(a("replaceXRanges",B,V),B.split(/\s+/).map(H=>M(H,V)).join(" ")),M=(B,V)=>{B=B.trim();const H=V.loose?c[l.XRANGELOOSE]:c[l.XRANGE];return B.replace(H,(oe,fe,se,ye,Ne,K)=>{a("xRange",B,oe,fe,se,ye,Ne,K);const re=v(se),de=re||v(ye),X=de||v(Ne),C=X;return fe==="="&&C&&(fe=""),K=V.includePrerelease?"-0":"",re?fe===">"||fe==="<"?oe="<0.0.0-0":oe="*":fe&&C?(de&&(ye=0),Ne=0,fe===">"?(fe=">=",de?(se=+se+1,ye=0,Ne=0):(ye=+ye+1,Ne=0)):fe==="<="&&(fe="<",de?se=+se+1:ye=+ye+1),fe==="<"&&(K="-0"),oe=`${fe+se}.${ye}.${Ne}${K}`):de?oe=`>=${se}.0.0${K} <${+se+1}.0.0-0`:X&&(oe=`>=${se}.${ye}.0${K} <${se}.${+ye+1}.0-0`),a("xRange return",oe),oe})},j=(B,V)=>(a("replaceStars",B,V),B.trim().replace(c[l.STAR],"")),P=(B,V)=>(a("replaceGTE0",B,V),B.trim().replace(c[V.includePrerelease?l.GTE0PRE:l.GTE0],"")),W=B=>(V,H,oe,fe,se,ye,Ne,K,re,de,X,C)=>(v(oe)?H="":v(fe)?H=`>=${oe}.0.0${B?"-0":""}`:v(se)?H=`>=${oe}.${fe}.0${B?"-0":""}`:ye?H=`>=${H}`:H=`>=${H}${B?"-0":""}`,v(re)?K="":v(de)?K=`<${+re+1}.0.0-0`:v(X)?K=`<${re}.${+de+1}.0-0`:C?K=`<=${re}.${de}.${X}-${C}`:B?K=`<${re}.${de}.${+X+1}-0`:K=`<=${K}`,`${H} ${K}`.trim()),ne=(B,V,H)=>{for(let oe=0;oe<B.length;oe++)if(!B[oe].test(V))return!1;if(V.prerelease.length&&!H.includePrerelease){for(let oe=0;oe<B.length;oe++)if(a(B[oe].semver),B[oe].semver!==i.ANY&&B[oe].semver.prerelease.length>0){const fe=B[oe].semver;if(fe.major===V.major&&fe.minor===V.minor&&fe.patch===V.patch)return!0}return!1}return!0};return Dd}var Ud,sy;function ju(){if(sy)return Ud;sy=1;const t=Symbol("SemVer ANY");class e{static get ANY(){return t}constructor(u,d){if(d=n(d),u instanceof e){if(u.loose===!!d.loose)return u;u=u.value}u=u.trim().split(/\s+/).join(" "),a("comparator",u,d),this.options=d,this.loose=!!d.loose,this.parse(u),this.semver===t?this.value="":this.value=this.operator+this.semver.version,a("comp",this)}parse(u){const d=this.options.loose?r[s.COMPARATORLOOSE]:r[s.COMPARATOR],h=u.match(d);if(!h)throw new TypeError(`Invalid comparator: ${u}`);this.operator=h[1]!==void 0?h[1]:"",this.operator==="="&&(this.operator=""),h[2]?this.semver=new o(h[2],this.options.loose):this.semver=t}toString(){return this.value}test(u){if(a("Comparator.test",u,this.options.loose),this.semver===t||u===t)return!0;if(typeof u=="string")try{u=new o(u,this.options)}catch{return!1}return i(u,this.operator,this.semver,this.options)}intersects(u,d){if(!(u instanceof e))throw new TypeError("a Comparator is required");return this.operator===""?this.value===""?!0:new c(u.value,d).test(this.value):u.operator===""?u.value===""?!0:new c(this.value,d).test(u.semver):(d=n(d),d.includePrerelease&&(this.value==="<0.0.0-0"||u.value==="<0.0.0-0")||!d.includePrerelease&&(this.value.startsWith("<0.0.0")||u.value.startsWith("<0.0.0"))?!1:!!(this.operator.startsWith(">")&&u.operator.startsWith(">")||this.operator.startsWith("<")&&u.operator.startsWith("<")||this.semver.version===u.semver.version&&this.operator.includes("=")&&u.operator.includes("=")||i(this.semver,"<",u.semver,d)&&this.operator.startsWith(">")&&u.operator.startsWith("<")||i(this.semver,">",u.semver,d)&&this.operator.startsWith("<")&&u.operator.startsWith(">")))}}Ud=e;const n=zp,{safeRe:r,t:s}=tc,i=DO,a=Lu,o=Zp,c=Ir();return Ud}Ir();Ir();Ir();Ir();Ir();Ir();const BO=ju(),{ANY:e6}=BO;Ir();Ir();Ir();const Vp=ju(),{ANY:t6}=Vp;new Vp(">=0.0.0-0");new Vp(">=0.0.0");const Fd=tc,iy=Mu,ay=Fv;ju();Ir();Fd.re,Fd.src,Fd.t,iy.SEMVER_SPEC_VERSION,iy.RELEASE_TYPES,ay.compareIdentifiers,ay.rcompareIdentifiers;function Ss(t){if(!t||t.split("/").length>2||t.startsWith("/")||t.endsWith("/")||t.split(":").length>2)throw new Error(`Invalid identifier format: ${t}`);const[e,n]=t.split(":"),r=n||"latest";if(e.includes("/")){const[s,i]=e.split("/",2);if(!s||!i)throw new Error(`Invalid identifier format: ${t}`);return[s,i,r]}else{if(!e)throw new Error(`Invalid identifier format: ${t}`);return["-",e,r]}}class zO extends Error{constructor(e){super(e),Object.defineProperty(this,"status",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name="LangSmithConflictError",this.status=409}}class ZO extends Error{constructor(e){super(e),Object.defineProperty(this,"status",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name="LangSmithNotFoundError",this.status=404}}function oy(t){return t!=null&&typeof t=="object"&&"name"in t&&(t==null?void 0:t.name)==="LangSmithNotFoundError"}async function ge(t,e,n){let r;if(t.ok){n&&(r=await t.text());return}if(t.status===403)try{const a=await t.json();(a==null?void 0:a.error)==="org_scoped_key_requires_workspace"&&(r="This API key is org-scoped and requires workspace specification. Please provide 'workspaceId' parameter, or set LANGSMITH_WORKSPACE_ID environment variable.")}catch{const o=new Error(`${t.status} ${t.statusText}`);throw o.status=t==null?void 0:t.status,o}if(r===void 0)try{r=await t.text()}catch{r=""}const s=`Failed to ${e}. Received status [${t.status}]: ${t.statusText}. Message: ${r}`;if(t.status===404)throw new ZO(s);if(t.status===409)throw new zO(s);const i=new Error(s);throw i.status=t.status,i}const Bv="ERR_CONFLICTING_ENDPOINTS";class VO extends Error{constructor(){super("You cannot provide both LANGSMITH_ENDPOINT / LANGCHAIN_ENDPOINT and LANGSMITH_RUNS_ENDPOINTS."),Object.defineProperty(this,"code",{enumerable:!0,configurable:!0,writable:!0,value:Bv}),this.name="ConflictingEndpointsError"}}function GO(t){return typeof t=="object"&&t!==null&&t.code===Bv}var cy="[...]",WO={result:"[Circular]"},Ul=[],Yi=[];const HO=new TextEncoder;function qO(){return{depthLimit:Number.MAX_SAFE_INTEGER,edgesLimit:Number.MAX_SAFE_INTEGER}}function Nc(t){return HO.encode(t)}function zv(t){if(t&&typeof t=="object"&&t!==null){if(t instanceof Map)return Object.fromEntries(t);if(t instanceof Set)return Array.from(t);if(t instanceof Date)return t.toISOString();if(t instanceof RegExp)return t.toString();if(t instanceof Error)return{name:t.name,message:t.message}}else if(typeof t=="bigint")return t.toString();return t}function JO(t){return function(e,n){return zv(n)}}function Ln(t,e,n,r,s){var i;try{const a=JSON.stringify(t,JO(n),r);return Nc(a)}catch(a){if(!((i=a.message)!=null&&i.includes("Converting circular structure to JSON")))return console.warn(`[WARNING]: LangSmith received unserializable value.${e?`
Context: ${e}`:""}`),Nc("[Unserializable]");kn("SUPPRESS_CIRCULAR_JSON_WARNINGS")!=="true"&&console.warn(`[WARNING]: LangSmith received circular JSON. This will decrease tracer performance. ${e?`
Context: ${e}`:""}`),typeof s>"u"&&(s=qO()),Zh(t,"",0,[],void 0,0,s);let o;try{Yi.length===0?o=JSON.stringify(t,n,r):o=JSON.stringify(t,KO(n),r)}catch{return Nc("[unable to serialize, circular reference is too complex to analyze]")}finally{for(;Ul.length!==0;){const c=Ul.pop();c.length===4?Object.defineProperty(c[0],c[1],c[3]):c[0][c[1]]=c[2]}}return Nc(o)}}function Bd(t,e,n,r){var s=Object.getOwnPropertyDescriptor(r,n);s.get!==void 0?s.configurable?(Object.defineProperty(r,n,{value:t}),Ul.push([r,n,e,s])):Yi.push([e,n,t]):(r[n]=t,Ul.push([r,n,e]))}function Zh(t,e,n,r,s,i,a){i+=1;var o;if(typeof t=="object"&&t!==null){for(o=0;o<r.length;o++)if(r[o]===t){Bd(WO,t,e,s);return}if(typeof a.depthLimit<"u"&&i>a.depthLimit){Bd(cy,t,e,s);return}if(typeof a.edgesLimit<"u"&&n+1>a.edgesLimit){Bd(cy,t,e,s);return}if(r.push(t),Array.isArray(t))for(o=0;o<t.length;o++)Zh(t[o],o,o,r,t,i,a);else{t=zv(t);var c=Object.keys(t);for(o=0;o<c.length;o++){var l=c[o];Zh(t[l],l,o,r,t,i,a)}}r.pop()}}function KO(t){return t=typeof t<"u"?t:function(e,n){return n},function(e,n){if(Yi.length>0)for(var r=0;r<Yi.length;r++){var s=Yi[r];if(s[1]===e&&s[0]===n){n=s[2],Yi.splice(r,1);break}}return t.call(this,e,n)}}function ly(t,e,n){if(n)return t;const r=Cv(),s=e??Ov(),i=t.extra??{},a=i.metadata;return t.extra={...i,runtime:{...r,...i==null?void 0:i.runtime},metadata:{...s,...s.revision_id||"revision_id"in t&&t.revision_id?{revision_id:("revision_id"in t?t.revision_id:void 0)??s.revision_id}:{},...a}},t}const XO=t=>{const e=(t==null?void 0:t.toString())??kn("TRACING_SAMPLING_RATE");if(e===void 0)return;const n=parseFloat(e);if(n<0||n>1)throw new Error(`LANGSMITH_TRACING_SAMPLING_RATE must be between 0 and 1 if set. Got: ${n}`);return n},YO=t=>{const n=t.replace("http://","").replace("https://","").split("/")[0].split(":")[0];return n==="localhost"||n==="127.0.0.1"||n==="::1"};async function QO(t){const e=[];for await(const n of t)e.push(n);return e}function Pc(t){if(t!==void 0)return t.trim().replace(/^"(.*)"$/,"$1").replace(/^'(.*)'$/,"$1")}const e1=async t=>{if((t==null?void 0:t.status)===429){const e=parseInt(t.headers.get("retry-after")??"10",10)*1e3;if(e>0)return await new Promise(n=>setTimeout(n,e)),!0}return!1};function uy(t){return typeof t=="number"?Number(t.toFixed(4)):t}const t1=24*1024*1024,Zv=1024*1024*1024,n1=1e4,r1=100,dy="https://api.smith.langchain.com";class s1{constructor(e){Object.defineProperty(this,"items",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"sizeBytes",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"maxSizeBytes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxSizeBytes=e??Zv}peek(){return this.items[0]}push(e){let n;const r=new Promise(i=>{n=i}),s=Ln(e.item,`Serializing run with id: ${e.item.id}`).length;return this.sizeBytes+s>this.maxSizeBytes&&this.items.length>0?(console.warn(`AutoBatchQueue size limit (${this.maxSizeBytes} bytes) exceeded. Dropping run with id: ${e.item.id}. Current queue size: ${this.sizeBytes} bytes, attempted addition: ${s} bytes.`),n(),r):(this.items.push({action:e.action,payload:e.item,otelContext:e.otelContext,apiKey:e.apiKey,apiUrl:e.apiUrl,itemPromiseResolve:n,itemPromise:r,size:s}),this.sizeBytes+=s,r)}pop({upToSizeBytes:e,upToSize:n}){var i;if(e<1)throw new Error("Number of bytes to pop off may not be less than 1.");const r=[];let s=0;for(;s+(((i=this.peek())==null?void 0:i.size)??0)<e&&this.items.length>0&&r.length<n;){const a=this.items.shift();a&&(r.push(a),s+=a.size,this.sizeBytes-=a.size)}if(r.length===0&&this.items.length>0){const a=this.items.shift();r.push(a),s+=a.size,this.sizeBytes-=a.size}return[r.map(a=>({action:a.action,item:a.payload,otelContext:a.otelContext,apiKey:a.apiKey,apiUrl:a.apiUrl,size:a.size})),()=>r.forEach(a=>a.itemPromiseResolve())]}}class pa{get _fetch(){return this.fetchImplementation||fC(this.debug)}constructor(e={}){var s;Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"webUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"workspaceId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"batchIngestCaller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout_ms",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_tenantId",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"hideInputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"hideOutputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"omitTracedRuntimeInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracingSampleRate",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"filteredPostUuids",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"autoBatchTracing",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"autoBatchQueue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"autoBatchTimeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"autoBatchAggregationDelayMs",{enumerable:!0,configurable:!0,writable:!0,value:250}),Object.defineProperty(this,"batchSizeBytesLimit",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"batchSizeLimit",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fetchOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"settings",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"blockOnRootRunFinalization",{enumerable:!0,configurable:!0,writable:!0,value:Wr("LANGSMITH_TRACING_BACKGROUND")==="false"}),Object.defineProperty(this,"traceBatchConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:5}),Object.defineProperty(this,"_serverInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_getServerInfoPromise",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"manualFlushMode",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"langSmithToOTELTranslator",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fetchImplementation",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"cachedLSEnvVarsForMetadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"multipartStreamingDisabled",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"_multipartDisabled",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"debug",{enumerable:!0,configurable:!0,writable:!0,value:Wr("LANGSMITH_DEBUG")==="true"});const n=pa.getDefaultClientConfig();if(this.tracingSampleRate=XO(e.tracingSamplingRate),this.apiUrl=Pc(e.apiUrl??n.apiUrl)??"",this.apiUrl.endsWith("/")&&(this.apiUrl=this.apiUrl.slice(0,-1)),this.apiKey=Pc(e.apiKey??n.apiKey),this.webUrl=Pc(e.webUrl??n.webUrl),(s=this.webUrl)!=null&&s.endsWith("/")&&(this.webUrl=this.webUrl.slice(0,-1)),this.workspaceId=Pc(e.workspaceId??kn("WORKSPACE_ID")),this.timeout_ms=e.timeout_ms??9e4,this.caller=new Xg({...e.callerOptions??{},maxRetries:4,debug:e.debug??this.debug}),this.traceBatchConcurrency=e.traceBatchConcurrency??this.traceBatchConcurrency,this.traceBatchConcurrency<1)throw new Error("Trace batch concurrency must be positive.");this.debug=e.debug??this.debug,this.fetchImplementation=e.fetchImplementation;const r=e.maxIngestMemoryBytes??Zv;this.batchIngestCaller=new Xg({maxRetries:4,maxConcurrency:this.traceBatchConcurrency,maxQueueSizeBytes:r,...e.callerOptions??{},onFailedResponseHook:e1,debug:e.debug??this.debug}),this.hideInputs=e.hideInputs??e.anonymizer??n.hideInputs,this.hideOutputs=e.hideOutputs??e.anonymizer??n.hideOutputs,this.omitTracedRuntimeInfo=e.omitTracedRuntimeInfo??!1,this.autoBatchTracing=e.autoBatchTracing??this.autoBatchTracing,this.autoBatchQueue=new s1(r),this.blockOnRootRunFinalization=e.blockOnRootRunFinalization??this.blockOnRootRunFinalization,this.batchSizeBytesLimit=e.batchSizeBytesLimit,this.batchSizeLimit=e.batchSizeLimit,this.fetchOptions=e.fetchOptions||{},this.manualFlushMode=e.manualFlushMode??this.manualFlushMode,$v()&&(this.langSmithToOTELTranslator=new RC),this.cachedLSEnvVarsForMetadata=Ov()}static getDefaultClientConfig(){const e=kn("API_KEY"),n=kn("ENDPOINT")??dy,r=kn("HIDE_INPUTS")==="true",s=kn("HIDE_OUTPUTS")==="true";return{apiUrl:n,apiKey:e,webUrl:void 0,hideInputs:r,hideOutputs:s}}getHostUrl(){return this.webUrl?this.webUrl:YO(this.apiUrl)?(this.webUrl="http://localhost:3000",this.webUrl):this.apiUrl.endsWith("/api/v1")?(this.webUrl=this.apiUrl.replace("/api/v1",""),this.webUrl):this.apiUrl.includes("/api")&&!this.apiUrl.split(".",1)[0].endsWith("api")?(this.webUrl=this.apiUrl.replace("/api",""),this.webUrl):this.apiUrl.split(".",1)[0].includes("dev")?(this.webUrl="https://dev.smith.langchain.com",this.webUrl):this.apiUrl.split(".",1)[0].includes("eu")?(this.webUrl="https://eu.smith.langchain.com",this.webUrl):this.apiUrl.split(".",1)[0].includes("beta")?(this.webUrl="https://beta.smith.langchain.com",this.webUrl):(this.webUrl="https://smith.langchain.com",this.webUrl)}get headers(){const e={"User-Agent":`langsmith-js/${kv}`};return this.apiKey&&(e["x-api-key"]=`${this.apiKey}`),this.workspaceId&&(e["x-tenant-id"]=this.workspaceId),e}_getPlatformEndpointPath(e){return this.apiUrl.slice(-3)!=="/v1"&&this.apiUrl.slice(-4)!=="/v1/"?`/v1/platform/${e}`:`/platform/${e}`}async processInputs(e){return this.hideInputs===!1?e:this.hideInputs===!0?{}:typeof this.hideInputs=="function"?this.hideInputs(e):e}async processOutputs(e){return this.hideOutputs===!1?e:this.hideOutputs===!0?{}:typeof this.hideOutputs=="function"?this.hideOutputs(e):e}async prepareRunCreateOrUpdateInputs(e){const n={...e};return n.inputs!==void 0&&(n.inputs=await this.processInputs(n.inputs)),n.outputs!==void 0&&(n.outputs=await this.processOutputs(n.outputs)),n}async _getResponse(e,n){const r=(n==null?void 0:n.toString())??"",s=`${this.apiUrl}${e}?${r}`;return await this.caller.call(async()=>{const a=await this._fetch(s,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await ge(a,`fetch ${e}`),a})}async _get(e,n){return(await this._getResponse(e,n)).json()}async*_getPaginated(e,n=new URLSearchParams,r){let s=Number(n.get("offset"))||0;const i=Number(n.get("limit"))||100;for(;;){n.set("offset",String(s)),n.set("limit",String(i));const a=`${this.apiUrl}${e}?${n}`,o=await this.caller.call(async()=>{const l=await this._fetch(a,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await ge(l,`fetch ${e}`),l}),c=r?r(await o.json()):await o.json();if(c.length===0||(yield c,c.length<i))break;s+=c.length}}async*_getCursorPaginatedList(e,n=null,r="POST",s="runs"){const i=n?{...n}:{};for(;;){const a=JSON.stringify(i),c=await(await this.caller.call(async()=>{const u=await this._fetch(`${this.apiUrl}${e}`,{method:r,headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:a});return await ge(u,`fetch ${e}`),u})).json();if(!c||!c[s])break;yield c[s];const l=c.cursors;if(!l||!l.next)break;i.cursor=l.next}}_shouldSample(){return this.tracingSampleRate===void 0?!0:Math.random()<this.tracingSampleRate}_filterForSampling(e,n=!1){if(this.tracingSampleRate===void 0)return e;if(n){const r=[];for(const s of e)this.filteredPostUuids.has(s.trace_id)?s.id===s.trace_id&&this.filteredPostUuids.delete(s.trace_id):r.push(s);return r}else{const r=[];for(const s of e){const i=s.trace_id??s.id;this.filteredPostUuids.has(i)||(s.id===i?this._shouldSample()?r.push(s):this.filteredPostUuids.add(i):r.push(s))}return r}}async _getBatchSizeLimitBytes(){var n;const e=await this._ensureServerInfo();return this.batchSizeBytesLimit??((n=e==null?void 0:e.batch_ingest_config)==null?void 0:n.size_limit_bytes)??t1}async _getBatchSizeLimit(){var n;const e=await this._ensureServerInfo();return this.batchSizeLimit??((n=e==null?void 0:e.batch_ingest_config)==null?void 0:n.size_limit)??r1}async _getDatasetExamplesMultiPartSupport(){var n;return((n=(await this._ensureServerInfo()).instance_flags)==null?void 0:n.dataset_examples_multipart_enabled)??!1}drainAutoBatchQueue({batchSizeLimitBytes:e,batchSizeLimit:n}){const r=[];for(;this.autoBatchQueue.items.length>0;){const[s,i]=this.autoBatchQueue.pop({upToSizeBytes:e,upToSize:n});if(!s.length){i();break}const a=s.reduce((l,u)=>{const d=u.apiUrl??this.apiUrl,h=u.apiKey??this.apiKey,m=u.apiKey===this.apiKey&&u.apiUrl===this.apiUrl?"default":`${d}|${h}`;return l[m]||(l[m]=[]),l[m].push(u),l},{}),o=[];for(const[l,u]of Object.entries(a)){const d=this._processBatch(u,{apiUrl:l==="default"?void 0:l.split("|")[0],apiKey:l==="default"?void 0:l.split("|")[1]});o.push(d)}const c=Promise.all(o).finally(i);r.push(c)}return Promise.all(r)}async _processBatch(e,n){var s,i;if(!e.length)return;const r=e.reduce((a,o)=>a+(o.size??0),0);try{if(this.langSmithToOTELTranslator!==void 0)this._sendBatchToOTELTranslator(e);else{const a={runCreates:e.filter(l=>l.action==="create").map(l=>l.item),runUpdates:e.filter(l=>l.action==="update").map(l=>l.item)},o=await this._ensureServerInfo();if(!this._multipartDisabled&&(((s=o==null?void 0:o.batch_ingest_config)==null?void 0:s.use_multipart_endpoint)??!0)){const l=(i=o==null?void 0:o.instance_flags)==null?void 0:i.gzip_body_enabled;try{await this.multipartIngestRuns(a,{...n,useGzip:l,sizeBytes:r})}catch(u){if(oy(u))this._multipartDisabled=!0,await this.batchIngestRuns(a,{...n,sizeBytes:r});else throw u}}else await this.batchIngestRuns(a,{...n,sizeBytes:r})}}catch(a){console.error("Error exporting batch:",a)}}_sendBatchToOTELTranslator(e){if(this.langSmithToOTELTranslator!==void 0){const n=new Map,r=[];for(const s of e)s.item.id&&s.otelContext&&(n.set(s.item.id,s.otelContext),s.action==="create"?r.push({operation:"post",id:s.item.id,trace_id:s.item.trace_id??s.item.id,run:s.item}):r.push({operation:"patch",id:s.item.id,trace_id:s.item.trace_id??s.item.id,run:s.item}));this.langSmithToOTELTranslator.exportBatch(r,n)}}async processRunOperation(e){clearTimeout(this.autoBatchTimeout),this.autoBatchTimeout=void 0,e.item=ly(e.item,this.cachedLSEnvVarsForMetadata,this.omitTracedRuntimeInfo);const n=this.autoBatchQueue.push(e);if(this.manualFlushMode)return n;const r=await this._getBatchSizeLimitBytes(),s=await this._getBatchSizeLimit();return(this.autoBatchQueue.sizeBytes>r||this.autoBatchQueue.items.length>s)&&this.drainAutoBatchQueue({batchSizeLimitBytes:r,batchSizeLimit:s}),this.autoBatchQueue.items.length>0&&(this.autoBatchTimeout=setTimeout(()=>{this.autoBatchTimeout=void 0,this.drainAutoBatchQueue({batchSizeLimitBytes:r,batchSizeLimit:s})},this.autoBatchAggregationDelayMs)),n}async _getServerInfo(){const n=await(await this.caller.call(async()=>{const r=await this._fetch(`${this.apiUrl}/info`,{method:"GET",headers:{Accept:"application/json"},signal:AbortSignal.timeout(n1),...this.fetchOptions});return await ge(r,"get server info"),r})).json();return this.debug&&console.log(`
=== LangSmith Server Configuration ===
`+JSON.stringify(n,null,2)+`
`),n}async _ensureServerInfo(){return this._getServerInfoPromise===void 0&&(this._getServerInfoPromise=(async()=>{if(this._serverInfo===void 0)try{this._serverInfo=await this._getServerInfo()}catch(e){console.warn(`[LANGSMITH]: Failed to fetch info on supported operations. Falling back to batch operations and default limits. Info: ${e.status??"Unspecified status code"} ${e.message}`)}return this._serverInfo??{}})()),this._getServerInfoPromise.then(e=>(this._serverInfo===void 0&&(this._getServerInfoPromise=void 0),e))}async _getSettings(){return this.settings||(this.settings=this._get("/settings")),await this.settings}async flush(){const e=await this._getBatchSizeLimitBytes(),n=await this._getBatchSizeLimit();await this.drainAutoBatchQueue({batchSizeLimitBytes:e,batchSizeLimit:n})}_cloneCurrentOTELContext(){const e=Rv(),n=AC();if(this.langSmithToOTELTranslator!==void 0){const r=e.getActiveSpan();if(r)return e.setSpan(n.active(),r)}}async createRun(e,n){if(!this._filterForSampling([e]).length)return;const r={...this.headers,"Content-Type":"application/json"},s=e.project_name;delete e.project_name;const i=await this.prepareRunCreateOrUpdateInputs({session_name:s,...e,start_time:e.start_time??Date.now()});if(this.autoBatchTracing&&i.trace_id!==void 0&&i.dotted_order!==void 0){const c=this._cloneCurrentOTELContext();this.processRunOperation({action:"create",item:i,otelContext:c,apiKey:n==null?void 0:n.apiKey,apiUrl:n==null?void 0:n.apiUrl}).catch(console.error);return}const a=ly(i,this.cachedLSEnvVarsForMetadata,this.omitTracedRuntimeInfo);(n==null?void 0:n.apiKey)!==void 0&&(r["x-api-key"]=n.apiKey),(n==null?void 0:n.workspaceId)!==void 0&&(r["x-tenant-id"]=n.workspaceId);const o=Ln(a,`Creating run with id: ${a.id}`);await this.caller.call(async()=>{const c=await this._fetch(`${(n==null?void 0:n.apiUrl)??this.apiUrl}/runs`,{method:"POST",headers:r,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:o});return await ge(c,"create run",!0),c})}async batchIngestRuns({runCreates:e,runUpdates:n},r){if(e===void 0&&n===void 0)return;let s=await Promise.all((e==null?void 0:e.map(c=>this.prepareRunCreateOrUpdateInputs(c)))??[]),i=await Promise.all((n==null?void 0:n.map(c=>this.prepareRunCreateOrUpdateInputs(c)))??[]);if(s.length>0&&i.length>0){const c=s.reduce((u,d)=>(d.id&&(u[d.id]=d),u),{}),l=[];for(const u of i)u.id!==void 0&&c[u.id]?c[u.id]={...c[u.id],...u}:l.push(u);s=Object.values(c),i=l}const a={post:s,patch:i};if(!a.post.length&&!a.patch.length)return;const o={post:[],patch:[]};for(const c of["post","patch"]){const l=c,u=a[l].reverse();let d=u.pop();for(;d!==void 0;)o[l].push(d),d=u.pop()}if(o.post.length>0||o.patch.length>0){const c=o.post.map(l=>l.id).concat(o.patch.map(l=>l.id)).join(",");await this._postBatchIngestRuns(Ln(o,`Ingesting runs with ids: ${c}`),r)}}async _postBatchIngestRuns(e,n){const r={...this.headers,"Content-Type":"application/json",Accept:"application/json"};(n==null?void 0:n.apiKey)!==void 0&&(r["x-api-key"]=n.apiKey),await this.batchIngestCaller.callWithOptions({sizeBytes:n==null?void 0:n.sizeBytes},async()=>{const s=await this._fetch(`${(n==null?void 0:n.apiUrl)??this.apiUrl}/runs/batch`,{method:"POST",headers:r,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:e});return await ge(s,"batch create run",!0),s})}async multipartIngestRuns({runCreates:e,runUpdates:n},r){if(e===void 0&&n===void 0)return;const s={};let i=[];for(const d of e??[]){const h=await this.prepareRunCreateOrUpdateInputs(d);h.id!==void 0&&h.attachments!==void 0&&(s[h.id]=h.attachments),delete h.attachments,i.push(h)}let a=[];for(const d of n??[])a.push(await this.prepareRunCreateOrUpdateInputs(d));if(i.find(d=>d.trace_id===void 0||d.dotted_order===void 0)!==void 0)throw new Error('Multipart ingest requires "trace_id" and "dotted_order" to be set when creating a run');if(a.find(d=>d.trace_id===void 0||d.dotted_order===void 0)!==void 0)throw new Error('Multipart ingest requires "trace_id" and "dotted_order" to be set when updating a run');if(i.length>0&&a.length>0){const d=i.reduce((f,m)=>(m.id&&(f[m.id]=m),f),{}),h=[];for(const f of a)f.id!==void 0&&d[f.id]?d[f.id]={...d[f.id],...f}:h.push(f);i=Object.values(d),a=h}if(i.length===0&&a.length===0)return;const l=[],u=[];for(const[d,h]of[["post",i],["patch",a]])for(const f of h){const{inputs:m,outputs:g,events:w,extra:b,error:y,serialized:v,attachments:T,...A}=f,I={inputs:m,outputs:g,events:w,extra:b,error:y,serialized:v},$=Ln(A,`Serializing for multipart ingestion of run with id: ${A.id}`);u.push({name:`${d}.${A.id}`,payload:new Blob([$],{type:`application/json; length=${$.length}`})});for(const[S,M]of Object.entries(I)){if(M===void 0)continue;const j=Ln(M,`Serializing ${S} for multipart ingestion of run with id: ${A.id}`);u.push({name:`${d}.${A.id}.${S}`,payload:new Blob([j],{type:`application/json; length=${j.length}`})})}if(A.id!==void 0){const S=s[A.id];if(S){delete s[A.id];for(const[M,j]of Object.entries(S)){let P,W;if(Array.isArray(j)?[P,W]=j:(P=j.mimeType,W=j.data),M.includes(".")){console.warn(`Skipping attachment '${M}' for run ${A.id}: Invalid attachment name. Attachment names must not contain periods ('.'). Please rename the attachment and try again.`);continue}u.push({name:`attachment.${A.id}.${M}`,payload:new Blob([W],{type:`${P}; length=${W.byteLength}`})})}}}l.push(`trace=${A.trace_id},id=${A.id}`)}await this._sendMultipartRequest(u,l.join("; "),r)}async _createNodeFetchBody(e,n){const r=[];for(const a of e)r.push(new Blob([`--${n}\r
`])),r.push(new Blob([`Content-Disposition: form-data; name="${a.name}"\r
`,`Content-Type: ${a.payload.type}\r
\r
`])),r.push(a.payload),r.push(new Blob([`\r
`]));return r.push(new Blob([`--${n}--\r
`])),await new Blob(r).arrayBuffer()}async _createMultipartStream(e,n){const r=new TextEncoder;return new ReadableStream({async start(i){const a=async o=>{typeof o=="string"?i.enqueue(r.encode(o)):i.enqueue(o)};for(const o of e){await a(`--${n}\r
`),await a(`Content-Disposition: form-data; name="${o.name}"\r
`),await a(`Content-Type: ${o.payload.type}\r
\r
`);const l=o.payload.stream().getReader();try{let u;for(;!(u=await l.read()).done;)i.enqueue(u.value)}finally{l.releaseLock()}await a(`\r
`)}await a(`--${n}--\r
`),i.close()}})}async _sendMultipartRequest(e,n,r){const s="----LangSmithFormBoundary"+Math.random().toString(36).slice(2),i=hC(),a=()=>this._createNodeFetchBody(e,s),o=()=>this._createMultipartStream(e,s),c=async l=>this.batchIngestCaller.callWithOptions({sizeBytes:r==null?void 0:r.sizeBytes},async()=>{const u=await l(),d={...this.headers,"Content-Type":`multipart/form-data; boundary=${s}`};(r==null?void 0:r.apiKey)!==void 0&&(d["x-api-key"]=r.apiKey);let h=u;r!=null&&r.useGzip&&typeof u=="object"&&"pipeThrough"in u&&(h=u.pipeThrough(new CompressionStream("gzip")),d["Content-Encoding"]="gzip");const f=await this._fetch(`${(r==null?void 0:r.apiUrl)??this.apiUrl}/runs/multipart`,{method:"POST",headers:d,body:h,duplex:"half",signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await ge(f,"Failed to send multipart request",!0),f});try{let l,u=!1;!i&&!this.multipartStreamingDisabled&&Av()!=="bun"?(u=!0,l=await c(o)):l=await c(a),(!this.multipartStreamingDisabled||u)&&l.status===422&&((r==null?void 0:r.apiUrl)??this.apiUrl)!==dy&&(console.warn(`Streaming multipart upload to ${(r==null?void 0:r.apiUrl)??this.apiUrl}/runs/multipart failed. This usually means the host does not support chunked uploads. Retrying with a buffered upload for operation "${n}".`),this.multipartStreamingDisabled=!0,l=await c(a))}catch(l){if(oy(l))throw l;console.warn(`${l.message.trim()}

Context: ${n}`)}}async updateRun(e,n,r){$e(e),n.inputs&&(n.inputs=await this.processInputs(n.inputs)),n.outputs&&(n.outputs=await this.processOutputs(n.outputs));const s={...n,id:e};if(!this._filterForSampling([s],!0).length)return;if(this.autoBatchTracing&&s.trace_id!==void 0&&s.dotted_order!==void 0){const o=this._cloneCurrentOTELContext();if(n.end_time!==void 0&&s.parent_run_id===void 0&&this.blockOnRootRunFinalization&&!this.manualFlushMode){await this.processRunOperation({action:"update",item:s,otelContext:o,apiKey:r==null?void 0:r.apiKey,apiUrl:r==null?void 0:r.apiUrl}).catch(console.error);return}else this.processRunOperation({action:"update",item:s,otelContext:o,apiKey:r==null?void 0:r.apiKey,apiUrl:r==null?void 0:r.apiUrl}).catch(console.error);return}const i={...this.headers,"Content-Type":"application/json"};(r==null?void 0:r.apiKey)!==void 0&&(i["x-api-key"]=r.apiKey),(r==null?void 0:r.workspaceId)!==void 0&&(i["x-tenant-id"]=r.workspaceId);const a=Ln(n,`Serializing payload to update run with id: ${e}`);await this.caller.call(async()=>{const o=await this._fetch(`${(r==null?void 0:r.apiUrl)??this.apiUrl}/runs/${e}`,{method:"PATCH",headers:i,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:a});return await ge(o,"update run",!0),o})}async readRun(e,{loadChildRuns:n}={loadChildRuns:!1}){$e(e);let r=await this._get(`/runs/${e}`);return n&&(r=await this._loadChildRuns(r)),r}async getRunUrl({runId:e,run:n,projectOpts:r}){if(n!==void 0){let s;n.session_id?s=n.session_id:r!=null&&r.projectName?s=(await this.readProject({projectName:r==null?void 0:r.projectName})).id:r!=null&&r.projectId?s=r==null?void 0:r.projectId:s=(await this.readProject({projectName:kn("PROJECT")||"default"})).id;const i=await this._getTenantId();return`${this.getHostUrl()}/o/${i}/projects/p/${s}/r/${n.id}?poll=true`}else if(e!==void 0){const s=await this.readRun(e);if(!s.app_path)throw new Error(`Run ${e} has no app_path`);return`${this.getHostUrl()}${s.app_path}`}else throw new Error("Must provide either runId or run")}async _loadChildRuns(e){var i;const n=await QO(this.listRuns({isRoot:!1,projectId:e.session_id,traceId:e.trace_id})),r={},s={};n.sort((a,o)=>((a==null?void 0:a.dotted_order)??"").localeCompare((o==null?void 0:o.dotted_order)??""));for(const a of n){if(a.parent_run_id===null||a.parent_run_id===void 0)throw new Error(`Child run ${a.id} has no parent`);(i=a.dotted_order)!=null&&i.startsWith(e.dotted_order??"")&&a.id!==e.id&&(a.parent_run_id in r||(r[a.parent_run_id]=[]),r[a.parent_run_id].push(a),s[a.id]=a)}e.child_runs=r[e.id]||[];for(const a in r)a!==e.id&&(s[a].child_runs=r[a]);return e}async*listRuns(e){const{projectId:n,projectName:r,parentRunId:s,traceId:i,referenceExampleId:a,startTime:o,executionOrder:c,isRoot:l,runType:u,error:d,id:h,query:f,filter:m,traceFilter:g,treeFilter:w,limit:b,select:y,order:v}=e;let T=[];if(n&&(T=Array.isArray(n)?n:[n]),r){const S=Array.isArray(r)?r:[r],M=await Promise.all(S.map(j=>this.readProject({projectName:j}).then(P=>P.id)));T.push(...M)}const A=["app_path","completion_cost","completion_tokens","dotted_order","end_time","error","events","extra","feedback_stats","first_token_time","id","inputs","name","outputs","parent_run_id","parent_run_ids","prompt_cost","prompt_tokens","reference_example_id","run_type","session_id","start_time","status","tags","total_cost","total_tokens","trace_id"],I={session:T.length?T:null,run_type:u,reference_example:a,query:f,filter:m,trace_filter:g,tree_filter:w,execution_order:c,parent_run:s,start_time:o?o.toISOString():null,error:d,id:h,limit:b,trace:i,select:y||A,is_root:l,order:v};I.select.includes("child_run_ids")&&xv("Deprecated: 'child_run_ids' in the listRuns select parameter is deprecated and will be removed in a future version.");let $=0;for await(const S of this._getCursorPaginatedList("/runs/query",I))if(b){if($>=b)break;if(S.length+$>b){yield*S.slice(0,b-$);break}$+=S.length,yield*S}else yield*S}async*listGroupRuns(e){const{projectId:n,projectName:r,groupBy:s,filter:i,startTime:a,endTime:o,limit:c,offset:l}=e,d={session_id:n||(await this.readProject({projectName:r})).id,group_by:s,filter:i,start_time:a?a.toISOString():null,end_time:o?o.toISOString():null,limit:Number(c)||100};let h=Number(l)||0;const f="/runs/group",m=`${this.apiUrl}${f}`;for(;;){const g={...d,offset:h},w=Object.fromEntries(Object.entries(g).filter(([I,$])=>$!==void 0)),b=JSON.stringify(w),v=await(await this.caller.call(async()=>{const I=await this._fetch(m,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:b});return await ge(I,`Failed to fetch ${f}`),I})).json(),{groups:T,total:A}=v;if(T.length===0)break;for(const I of T)yield I;if(h+=T.length,h>=A)break}}async getRunStats({id:e,trace:n,parentRun:r,runType:s,projectNames:i,projectIds:a,referenceExampleIds:o,startTime:c,endTime:l,error:u,query:d,filter:h,traceFilter:f,treeFilter:m,isRoot:g,dataSourceType:w}){let b=a||[];i&&(b=[...a||[],...await Promise.all(i.map($=>this.readProject({projectName:$}).then(S=>S.id)))]);const v=Object.fromEntries(Object.entries({id:e,trace:n,parent_run:r,run_type:s,session:b,reference_example:o,start_time:c,end_time:l,error:u,query:d,filter:h,trace_filter:f,tree_filter:m,is_root:g,data_source_type:w}).filter(([$,S])=>S!==void 0)),T=JSON.stringify(v);return await(await this.caller.call(async()=>{const $=await this._fetch(`${this.apiUrl}/runs/stats`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:T});return await ge($,"get run stats"),$})).json()}async shareRun(e,{shareId:n}={}){const r={run_id:e,share_token:n||vr()};$e(e);const s=JSON.stringify(r),a=await(await this.caller.call(async()=>{const o=await this._fetch(`${this.apiUrl}/runs/${e}/share`,{method:"PUT",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:s});return await ge(o,"share run"),o})).json();if(a===null||!("share_token"in a))throw new Error("Invalid response from server");return`${this.getHostUrl()}/public/${a.share_token}/r`}async unshareRun(e){$e(e),await this.caller.call(async()=>{const n=await this._fetch(`${this.apiUrl}/runs/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await ge(n,"unshare run",!0),n})}async readRunSharedLink(e){$e(e);const r=await(await this.caller.call(async()=>{const s=await this._fetch(`${this.apiUrl}/runs/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await ge(s,"read run shared link"),s})).json();if(!(r===null||!("share_token"in r)))return`${this.getHostUrl()}/public/${r.share_token}/r`}async listSharedRuns(e,{runIds:n}={}){const r=new URLSearchParams({share_token:e});if(n!==void 0)for(const a of n)r.append("id",a);return $e(e),await(await this.caller.call(async()=>{const a=await this._fetch(`${this.apiUrl}/public/${e}/runs${r}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await ge(a,"list shared runs"),a})).json()}async readDatasetSharedSchema(e,n){if(!e&&!n)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:n})).id),$e(e);const s=await(await this.caller.call(async()=>{const i=await this._fetch(`${this.apiUrl}/datasets/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await ge(i,"read dataset shared schema"),i})).json();return s.url=`${this.getHostUrl()}/public/${s.share_token}/d`,s}async shareDataset(e,n){if(!e&&!n)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:n})).id);const r={dataset_id:e};$e(e);const s=JSON.stringify(r),a=await(await this.caller.call(async()=>{const o=await this._fetch(`${this.apiUrl}/datasets/${e}/share`,{method:"PUT",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:s});return await ge(o,"share dataset"),o})).json();return a.url=`${this.getHostUrl()}/public/${a.share_token}/d`,a}async unshareDataset(e){$e(e),await this.caller.call(async()=>{const n=await this._fetch(`${this.apiUrl}/datasets/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await ge(n,"unshare dataset",!0),n})}async readSharedDataset(e){return $e(e),await(await this.caller.call(async()=>{const s=await this._fetch(`${this.apiUrl}/public/${e}/datasets`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await ge(s,"read shared dataset"),s})).json()}async listSharedExamples(e,n){const r={};n!=null&&n.exampleIds&&(r.id=n.exampleIds);const s=new URLSearchParams;Object.entries(r).forEach(([o,c])=>{Array.isArray(c)?c.forEach(l=>s.append(o,l)):s.append(o,c)});const i=await this.caller.call(async()=>{const o=await this._fetch(`${this.apiUrl}/public/${e}/examples?${s.toString()}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await ge(o,"list shared examples"),o}),a=await i.json();if(!i.ok)throw"detail"in a?new Error(`Failed to list shared examples.
Status: ${i.status}
Message: ${Array.isArray(a.detail)?a.detail.join(`
`):"Unspecified error"}`):new Error(`Failed to list shared examples: ${i.status} ${i.statusText}`);return a.map(o=>({...o,_hostUrl:this.getHostUrl()}))}async createProject({projectName:e,description:n=null,metadata:r=null,upsert:s=!1,projectExtra:i=null,referenceDatasetId:a=null}){const o=s?"?upsert=true":"",c=`${this.apiUrl}/sessions${o}`,l=i||{};r&&(l.metadata=r);const u={name:e,extra:l,description:n};a!==null&&(u.reference_dataset_id=a);const d=JSON.stringify(u);return await(await this.caller.call(async()=>{const m=await this._fetch(c,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:d});return await ge(m,"create project"),m})).json()}async updateProject(e,{name:n=null,description:r=null,metadata:s=null,projectExtra:i=null,endTime:a=null}){const o=`${this.apiUrl}/sessions/${e}`;let c=i;s&&(c={...c||{},metadata:s});const l=JSON.stringify({name:n,extra:c,description:r,end_time:a?new Date(a).toISOString():null});return await(await this.caller.call(async()=>{const h=await this._fetch(o,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:l});return await ge(h,"update project"),h})).json()}async hasProject({projectId:e,projectName:n}){let r="/sessions";const s=new URLSearchParams;if(e!==void 0&&n!==void 0)throw new Error("Must provide either projectName or projectId, not both");if(e!==void 0)$e(e),r+=`/${e}`;else if(n!==void 0)s.append("name",n);else throw new Error("Must provide projectName or projectId");const i=await this.caller.call(async()=>{const a=await this._fetch(`${this.apiUrl}${r}?${s}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await ge(a,"has project"),a});try{const a=await i.json();return i.ok?Array.isArray(a)?a.length>0:!0:!1}catch{return!1}}async readProject({projectId:e,projectName:n,includeStats:r}){let s="/sessions";const i=new URLSearchParams;if(e!==void 0&&n!==void 0)throw new Error("Must provide either projectName or projectId, not both");if(e!==void 0)$e(e),s+=`/${e}`;else if(n!==void 0)i.append("name",n);else throw new Error("Must provide projectName or projectId");r!==void 0&&i.append("include_stats",r.toString());const a=await this._get(s,i);let o;if(Array.isArray(a)){if(a.length===0)throw new Error(`Project[id=${e}, name=${n}] not found`);o=a[0]}else o=a;return o}async getProjectUrl({projectId:e,projectName:n}){if(e===void 0&&n===void 0)throw new Error("Must provide either projectName or projectId");const r=await this.readProject({projectId:e,projectName:n}),s=await this._getTenantId();return`${this.getHostUrl()}/o/${s}/projects/p/${r.id}`}async getDatasetUrl({datasetId:e,datasetName:n}){if(e===void 0&&n===void 0)throw new Error("Must provide either datasetName or datasetId");const r=await this.readDataset({datasetId:e,datasetName:n}),s=await this._getTenantId();return`${this.getHostUrl()}/o/${s}/datasets/${r.id}`}async _getTenantId(){if(this._tenantId!==null)return this._tenantId;const e=new URLSearchParams({limit:"1"});for await(const n of this._getPaginated("/sessions",e))return this._tenantId=n[0].tenant_id,n[0].tenant_id;throw new Error("No projects found to resolve tenant.")}async*listProjects({projectIds:e,name:n,nameContains:r,referenceDatasetId:s,referenceDatasetName:i,includeStats:a,datasetVersion:o,referenceFree:c,metadata:l}={}){const u=new URLSearchParams;if(e!==void 0)for(const d of e)u.append("id",d);if(n!==void 0&&u.append("name",n),r!==void 0&&u.append("name_contains",r),s!==void 0)u.append("reference_dataset",s);else if(i!==void 0){const d=await this.readDataset({datasetName:i});u.append("reference_dataset",d.id)}a!==void 0&&u.append("include_stats",a.toString()),o!==void 0&&u.append("dataset_version",o),c!==void 0&&u.append("reference_free",c.toString()),l!==void 0&&u.append("metadata",JSON.stringify(l));for await(const d of this._getPaginated("/sessions",u))yield*d}async deleteProject({projectId:e,projectName:n}){let r;if(e===void 0&&n===void 0)throw new Error("Must provide projectName or projectId");if(e!==void 0&&n!==void 0)throw new Error("Must provide either projectName or projectId, not both");e===void 0?r=(await this.readProject({projectName:n})).id:r=e,$e(r),await this.caller.call(async()=>{const s=await this._fetch(`${this.apiUrl}/sessions/${r}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await ge(s,`delete session ${r} (${n})`,!0),s})}async uploadCsv({csvFile:e,fileName:n,inputKeys:r,outputKeys:s,description:i,dataType:a,name:o}){const c=`${this.apiUrl}/datasets/upload`,l=new FormData;return l.append("file",e,n),r.forEach(h=>{l.append("input_keys",h)}),s.forEach(h=>{l.append("output_keys",h)}),i&&l.append("description",i),a&&l.append("data_type",a),o&&l.append("name",o),await(await this.caller.call(async()=>{const h=await this._fetch(c,{method:"POST",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:l});return await ge(h,"upload CSV"),h})).json()}async createDataset(e,{description:n,dataType:r,inputsSchema:s,outputsSchema:i,metadata:a}={}){const o={name:e,description:n,extra:a?{metadata:a}:void 0};r&&(o.data_type=r),s&&(o.inputs_schema_definition=s),i&&(o.outputs_schema_definition=i);const c=JSON.stringify(o);return await(await this.caller.call(async()=>{const d=await this._fetch(`${this.apiUrl}/datasets`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:c});return await ge(d,"create dataset"),d})).json()}async readDataset({datasetId:e,datasetName:n}){let r="/datasets";const s=new URLSearchParams({limit:"1"});if(e&&n)throw new Error("Must provide either datasetName or datasetId, not both");if(e)$e(e),r+=`/${e}`;else if(n)s.append("name",n);else throw new Error("Must provide datasetName or datasetId");const i=await this._get(r,s);let a;if(Array.isArray(i)){if(i.length===0)throw new Error(`Dataset[id=${e}, name=${n}] not found`);a=i[0]}else a=i;return a}async hasDataset({datasetId:e,datasetName:n}){try{return await this.readDataset({datasetId:e,datasetName:n}),!0}catch(r){if(r instanceof Error&&r.message.toLocaleLowerCase().includes("not found"))return!1;throw r}}async diffDatasetVersions({datasetId:e,datasetName:n,fromVersion:r,toVersion:s}){let i=e;if(i===void 0&&n===void 0)throw new Error("Must provide either datasetName or datasetId");if(i!==void 0&&n!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");i===void 0&&(i=(await this.readDataset({datasetName:n})).id);const a=new URLSearchParams({from_version:typeof r=="string"?r:r.toISOString(),to_version:typeof s=="string"?s:s.toISOString()});return await this._get(`/datasets/${i}/versions/diff`,a)}async readDatasetOpenaiFinetuning({datasetId:e,datasetName:n}){const r="/datasets";if(e===void 0)if(n!==void 0)e=(await this.readDataset({datasetName:n})).id;else throw new Error("Must provide either datasetName or datasetId");return(await(await this._getResponse(`${r}/${e}/openai_ft`)).text()).trim().split(`
`).map(o=>JSON.parse(o))}async*listDatasets({limit:e=100,offset:n=0,datasetIds:r,datasetName:s,datasetNameContains:i,metadata:a}={}){const o="/datasets",c=new URLSearchParams({limit:e.toString(),offset:n.toString()});if(r!==void 0)for(const l of r)c.append("id",l);s!==void 0&&c.append("name",s),i!==void 0&&c.append("name_contains",i),a!==void 0&&c.append("metadata",JSON.stringify(a));for await(const l of this._getPaginated(o,c))yield*l}async updateDataset(e){const{datasetId:n,datasetName:r,...s}=e;if(!n&&!r)throw new Error("Must provide either datasetName or datasetId");const i=n??(await this.readDataset({datasetName:r})).id;$e(i);const a=JSON.stringify(s);return await(await this.caller.call(async()=>{const c=await this._fetch(`${this.apiUrl}/datasets/${i}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:a});return await ge(c,"update dataset"),c})).json()}async updateDatasetTag(e){const{datasetId:n,datasetName:r,asOf:s,tag:i}=e;if(!n&&!r)throw new Error("Must provide either datasetName or datasetId");const a=n??(await this.readDataset({datasetName:r})).id;$e(a);const o=JSON.stringify({as_of:typeof s=="string"?s:s.toISOString(),tag:i});await this.caller.call(async()=>{const c=await this._fetch(`${this.apiUrl}/datasets/${a}/tags`,{method:"PUT",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:o});return await ge(c,"update dataset tags",!0),c})}async deleteDataset({datasetId:e,datasetName:n}){let r="/datasets",s=e;if(e!==void 0&&n!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(n!==void 0&&(s=(await this.readDataset({datasetName:n})).id),s!==void 0)$e(s),r+=`/${s}`;else throw new Error("Must provide datasetName or datasetId");await this.caller.call(async()=>{const i=await this._fetch(this.apiUrl+r,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await ge(i,`delete ${r}`,!0),i})}async indexDataset({datasetId:e,datasetName:n,tag:r}){let s=e;if(!s&&!n)throw new Error("Must provide either datasetName or datasetId");if(s&&n)throw new Error("Must provide either datasetName or datasetId, not both");s||(s=(await this.readDataset({datasetName:n})).id),$e(s);const a=JSON.stringify({tag:r});await(await this.caller.call(async()=>{const c=await this._fetch(`${this.apiUrl}/datasets/${s}/index`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:a});return await ge(c,"index dataset"),c})).json()}async similarExamples(e,n,r,{filter:s}={}){const i={limit:r,inputs:e};s!==void 0&&(i.filter=s),$e(n);const a=JSON.stringify(i);return(await(await this.caller.call(async()=>{const l=await this._fetch(`${this.apiUrl}/datasets/${n}/search`,{headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,method:"POST",body:a});return await ge(l,"fetch similar examples"),l})).json()).examples}async createExample(e,n,r){var u;if(hy(e)&&(n!==void 0||r!==void 0))throw new Error("Cannot provide outputs or options when using ExampleCreate object");let s=n?r==null?void 0:r.datasetId:e.dataset_id;const i=n?r==null?void 0:r.datasetName:e.dataset_name;if(s===void 0&&i===void 0)throw new Error("Must provide either datasetName or datasetId");if(s!==void 0&&i!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");s===void 0&&(s=(await this.readDataset({datasetName:i})).id);const a=(n?r==null?void 0:r.createdAt:e.created_at)||new Date;let o;hy(e)?o=e:o={inputs:e,outputs:n,created_at:a==null?void 0:a.toISOString(),id:r==null?void 0:r.exampleId,metadata:r==null?void 0:r.metadata,split:r==null?void 0:r.split,source_run_id:r==null?void 0:r.sourceRunId,use_source_run_io:r==null?void 0:r.useSourceRunIO,use_source_run_attachments:r==null?void 0:r.useSourceRunAttachments,attachments:r==null?void 0:r.attachments};const c=await this._uploadExamplesMultipart(s,[o]);return await this.readExample(((u=c.example_ids)==null?void 0:u[0])??vr())}async createExamples(e){if(Array.isArray(e)){if(e.length===0)return[];const y=e;let v=y[0].dataset_id;const T=y[0].dataset_name;if(v===void 0&&T===void 0)throw new Error("Must provide either datasetName or datasetId");if(v!==void 0&&T!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");v===void 0&&(v=(await this.readDataset({datasetName:T})).id);const A=await this._uploadExamplesMultipart(v,y);return await Promise.all(A.example_ids.map($=>this.readExample($)))}const{inputs:n,outputs:r,metadata:s,splits:i,sourceRunIds:a,useSourceRunIOs:o,useSourceRunAttachments:c,attachments:l,exampleIds:u,datasetId:d,datasetName:h}=e;if(n===void 0)throw new Error("Must provide inputs when using legacy parameters");let f=d;const m=h;if(f===void 0&&m===void 0)throw new Error("Must provide either datasetName or datasetId");if(f!==void 0&&m!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");f===void 0&&(f=(await this.readDataset({datasetName:m})).id);const g=n.map((y,v)=>({dataset_id:f,inputs:y,outputs:r==null?void 0:r[v],metadata:s==null?void 0:s[v],split:i==null?void 0:i[v],id:u==null?void 0:u[v],attachments:l==null?void 0:l[v],source_run_id:a==null?void 0:a[v],use_source_run_io:o==null?void 0:o[v],use_source_run_attachments:c==null?void 0:c[v]})),w=await this._uploadExamplesMultipart(f,g);return await Promise.all(w.example_ids.map(y=>this.readExample(y)))}async createLLMExample(e,n,r){return this.createExample({input:e},{output:n},r)}async createChatExample(e,n,r){const s=e.map(a=>Yg(a)?Qg(a):a),i=Yg(n)?Qg(n):n;return this.createExample({input:s},{output:i},r)}async readExample(e){$e(e);const n=`/examples/${e}`,r=await this._get(n),{attachment_urls:s,...i}=r,a=i;return s&&(a.attachments=Object.entries(s).reduce((o,[c,l])=>(o[c.slice(11)]={presigned_url:l.presigned_url,mime_type:l.mime_type},o),{})),a}async*listExamples({datasetId:e,datasetName:n,exampleIds:r,asOf:s,splits:i,inlineS3Urls:a,metadata:o,limit:c,offset:l,filter:u,includeAttachments:d}={}){let h;if(e!==void 0&&n!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(e!==void 0)h=e;else if(n!==void 0)h=(await this.readDataset({datasetName:n})).id;else throw new Error("Must provide a datasetName or datasetId");const f=new URLSearchParams({dataset:h}),m=s?typeof s=="string"?s:s==null?void 0:s.toISOString():void 0;m&&f.append("as_of",m);const g=a??!0;if(f.append("inline_s3_urls",g.toString()),r!==void 0)for(const b of r)f.append("id",b);if(i!==void 0)for(const b of i)f.append("splits",b);if(o!==void 0){const b=JSON.stringify(o);f.append("metadata",b)}c!==void 0&&f.append("limit",c.toString()),l!==void 0&&f.append("offset",l.toString()),u!==void 0&&f.append("filter",u),d===!0&&["attachment_urls","outputs","metadata"].forEach(b=>f.append("select",b));let w=0;for await(const b of this._getPaginated("/examples",f)){for(const y of b){const{attachment_urls:v,...T}=y,A=T;v&&(A.attachments=Object.entries(v).reduce((I,[$,S])=>(I[$.slice(11)]={presigned_url:S.presigned_url,mime_type:S.mime_type||void 0},I),{})),yield A,w++}if(c!==void 0&&w>=c)break}}async deleteExample(e){$e(e);const n=`/examples/${e}`;await this.caller.call(async()=>{const r=await this._fetch(this.apiUrl+n,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await ge(r,`delete ${n}`,!0),r})}async deleteExamples(e,n){if(e.forEach(r=>$e(r)),n!=null&&n.hardDelete){const r=this._getPlatformEndpointPath("datasets/examples/delete");await this.caller.call(async()=>{const s=await this._fetch(`${this.apiUrl}${r}`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify({example_ids:e,hard_delete:!0}),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await ge(s,"hard delete examples",!0),s})}else{const r=new URLSearchParams;e.forEach(s=>r.append("example_ids",s)),await this.caller.call(async()=>{const s=await this._fetch(`${this.apiUrl}/examples?${r.toString()}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await ge(s,"delete examples",!0),s})}}async updateExample(e,n){let r;n?r=e:r=e.id,$e(r);let s;n?s={id:r,...n}:s=e;let i;return s.dataset_id!==void 0?i=s.dataset_id:i=(await this.readExample(r)).dataset_id,this._updateExamplesMultipart(i,[s])}async updateExamples(e){let n;return e[0].dataset_id===void 0?n=(await this.readExample(e[0].id)).dataset_id:n=e[0].dataset_id,this._updateExamplesMultipart(n,e)}async readDatasetVersion({datasetId:e,datasetName:n,asOf:r,tag:s}){let i;if(e?i=e:i=(await this.readDataset({datasetName:n})).id,$e(i),r&&s||!r&&!s)throw new Error("Exactly one of asOf and tag must be specified.");const a=new URLSearchParams;return r!==void 0&&a.append("as_of",typeof r=="string"?r:r.toISOString()),s!==void 0&&a.append("tag",s),await(await this.caller.call(async()=>{const c=await this._fetch(`${this.apiUrl}/datasets/${i}/version?${a.toString()}`,{method:"GET",headers:{...this.headers},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await ge(c,"read dataset version"),c})).json()}async listDatasetSplits({datasetId:e,datasetName:n,asOf:r}){let s;if(e===void 0&&n===void 0)throw new Error("Must provide dataset name or ID");if(e!==void 0&&n!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");e===void 0?s=(await this.readDataset({datasetName:n})).id:s=e,$e(s);const i=new URLSearchParams,a=r?typeof r=="string"?r:r==null?void 0:r.toISOString():void 0;return a&&i.append("as_of",a),await this._get(`/datasets/${s}/splits`,i)}async updateDatasetSplits({datasetId:e,datasetName:n,splitName:r,exampleIds:s,remove:i=!1}){let a;if(e===void 0&&n===void 0)throw new Error("Must provide dataset name or ID");if(e!==void 0&&n!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");e===void 0?a=(await this.readDataset({datasetName:n})).id:a=e,$e(a);const o={split_name:r,examples:s.map(l=>($e(l),l)),remove:i},c=JSON.stringify(o);await this.caller.call(async()=>{const l=await this._fetch(`${this.apiUrl}/datasets/${a}/splits`,{method:"PUT",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:c});return await ge(l,"update dataset splits",!0),l})}async createFeedback(e,n,{score:r,value:s,correction:i,comment:a,sourceInfo:o,feedbackSourceType:c="api",sourceRunId:l,feedbackId:u,feedbackConfig:d,projectId:h,comparativeExperimentId:f}){var y;if(!e&&!h)throw new Error("One of runId or projectId must be provided");if(e&&h)throw new Error("Only one of runId or projectId can be provided");const m={type:c??"api",metadata:o??{}};l!==void 0&&(m==null?void 0:m.metadata)!==void 0&&!m.metadata.__run&&(m.metadata.__run={run_id:l}),(m==null?void 0:m.metadata)!==void 0&&((y=m.metadata.__run)==null?void 0:y.run_id)!==void 0&&$e(m.metadata.__run.run_id);const g={id:u??vr(),run_id:e,key:n,score:uy(r),value:s,correction:i,comment:a,feedback_source:m,comparative_experiment_id:f,feedbackConfig:d,session_id:h},w=JSON.stringify(g),b=`${this.apiUrl}/feedback`;return await this.caller.call(async()=>{const v=await this._fetch(b,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:w});return await ge(v,"create feedback",!0),v}),g}async updateFeedback(e,{score:n,value:r,correction:s,comment:i}){const a={};n!=null&&(a.score=uy(n)),r!=null&&(a.value=r),s!=null&&(a.correction=s),i!=null&&(a.comment=i),$e(e);const o=JSON.stringify(a);await this.caller.call(async()=>{const c=await this._fetch(`${this.apiUrl}/feedback/${e}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:o});return await ge(c,"update feedback",!0),c})}async readFeedback(e){$e(e);const n=`/feedback/${e}`;return await this._get(n)}async deleteFeedback(e){$e(e);const n=`/feedback/${e}`;await this.caller.call(async()=>{const r=await this._fetch(this.apiUrl+n,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await ge(r,`delete ${n}`,!0),r})}async*listFeedback({runIds:e,feedbackKeys:n,feedbackSourceTypes:r}={}){const s=new URLSearchParams;if(e)for(const i of e)$e(i),s.append("run",i);if(n)for(const i of n)s.append("key",i);if(r)for(const i of r)s.append("source",i);for await(const i of this._getPaginated("/feedback",s))yield*i}async createPresignedFeedbackToken(e,n,{expiration:r,feedbackConfig:s}={}){const i={run_id:e,feedback_key:n,feedback_config:s};r?typeof r=="string"?i.expires_at=r:(r!=null&&r.hours||r!=null&&r.minutes||r!=null&&r.days)&&(i.expires_in=r):i.expires_in={hours:3};const a=JSON.stringify(i);return await(await this.caller.call(async()=>{const c=await this._fetch(`${this.apiUrl}/feedback/tokens`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:a});return await ge(c,"create presigned feedback token"),c})).json()}async createComparativeExperiment({name:e,experimentIds:n,referenceDatasetId:r,createdAt:s,description:i,metadata:a,id:o}){var d;if(n.length===0)throw new Error("At least one experiment is required");if(r||(r=(await this.readProject({projectId:n[0]})).reference_dataset_id),!r==null)throw new Error("A reference dataset is required");const c={id:o,name:e,experiment_ids:n,reference_dataset_id:r,description:i,created_at:(d=s??new Date)==null?void 0:d.toISOString(),extra:{}};a&&(c.extra.metadata=a);const l=JSON.stringify(c);return(await this.caller.call(async()=>{const h=await this._fetch(`${this.apiUrl}/datasets/comparative`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:l});return await ge(h,"create comparative experiment"),h})).json()}async*listPresignedFeedbackTokens(e){$e(e);const n=new URLSearchParams({run_id:e});for await(const r of this._getPaginated("/feedback/tokens",n))yield*r}_selectEvalResults(e){let n;return"results"in e?n=e.results:Array.isArray(e)?n=e:n=[e],n}async _logEvaluationFeedback(e,n,r){const s=this._selectEvalResults(e),i=[];for(const a of s){let o=r||{};a.evaluatorInfo&&(o={...a.evaluatorInfo,...o});let c=null;a.targetRunId?c=a.targetRunId:n&&(c=n.id),i.push(await this.createFeedback(c,a.key,{score:a.score,value:a.value,comment:a.comment,correction:a.correction,sourceInfo:o,sourceRunId:a.sourceRunId,feedbackConfig:a.feedbackConfig,feedbackSourceType:"model"}))}return[s,i]}async logEvaluationFeedback(e,n,r){const[s]=await this._logEvaluationFeedback(e,n,r);return s}async*listAnnotationQueues(e={}){const{queueIds:n,name:r,nameContains:s,limit:i}=e,a=new URLSearchParams;n&&n.forEach((c,l)=>{$e(c,`queueIds[${l}]`),a.append("ids",c)}),r&&a.append("name",r),s&&a.append("name_contains",s),a.append("limit",(i!==void 0?Math.min(i,100):100).toString());let o=0;for await(const c of this._getPaginated("/annotation-queues",a))if(yield*c,o++,i!==void 0&&o>=i)break}async createAnnotationQueue(e){const{name:n,description:r,queueId:s,rubricInstructions:i}=e,a={name:n,description:r,id:s||vr(),rubric_instructions:i},o=JSON.stringify(Object.fromEntries(Object.entries(a).filter(([l,u])=>u!==void 0)));return(await this.caller.call(async()=>{const l=await this._fetch(`${this.apiUrl}/annotation-queues`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:o});return await ge(l,"create annotation queue"),l})).json()}async readAnnotationQueue(e){return(await this.caller.call(async()=>{const r=await this._fetch(`${this.apiUrl}/annotation-queues/${$e(e,"queueId")}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await ge(r,"read annotation queue"),r})).json()}async updateAnnotationQueue(e,n){const{name:r,description:s,rubricInstructions:i}=n,a=JSON.stringify({name:r,description:s,rubric_instructions:i});await this.caller.call(async()=>{const o=await this._fetch(`${this.apiUrl}/annotation-queues/${$e(e,"queueId")}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:a});return await ge(o,"update annotation queue",!0),o})}async deleteAnnotationQueue(e){await this.caller.call(async()=>{const n=await this._fetch(`${this.apiUrl}/annotation-queues/${$e(e,"queueId")}`,{method:"DELETE",headers:{...this.headers,Accept:"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await ge(n,"delete annotation queue",!0),n})}async addRunsToAnnotationQueue(e,n){const r=JSON.stringify(n.map((s,i)=>$e(s,`runIds[${i}]`).toString()));await this.caller.call(async()=>{const s=await this._fetch(`${this.apiUrl}/annotation-queues/${$e(e,"queueId")}/runs`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:r});return await ge(s,"add runs to annotation queue",!0),s})}async getRunFromAnnotationQueue(e,n){const r=`/annotation-queues/${$e(e,"queueId")}/run`;return(await this.caller.call(async()=>{const i=await this._fetch(`${this.apiUrl}${r}/${n}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await ge(i,"get run from annotation queue"),i})).json()}async deleteRunFromAnnotationQueue(e,n){await this.caller.call(async()=>{const r=await this._fetch(`${this.apiUrl}/annotation-queues/${$e(e,"queueId")}/runs/${$e(n,"queueRunId")}`,{method:"DELETE",headers:{...this.headers,Accept:"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await ge(r,"delete run from annotation queue",!0),r})}async getSizeFromAnnotationQueue(e){return(await this.caller.call(async()=>{const r=await this._fetch(`${this.apiUrl}/annotation-queues/${$e(e,"queueId")}/size`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await ge(r,"get size from annotation queue"),r})).json()}async _currentTenantIsOwner(e){const n=await this._getSettings();return e=="-"||n.tenant_handle===e}async _ownerConflictError(e,n){const r=await this._getSettings();return new Error(`Cannot ${e} for another tenant.

      Current tenant: ${r.tenant_handle}

      Requested tenant: ${n}`)}async _getLatestCommitHash(e){const r=await(await this.caller.call(async()=>{const s=await this._fetch(`${this.apiUrl}/commits/${e}/?limit=1&offset=0`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await ge(s,"get latest commit hash"),s})).json();if(r.commits.length!==0)return r.commits[0].commit_hash}async _likeOrUnlikePrompt(e,n){const[r,s,i]=Ss(e),a=JSON.stringify({like:n});return(await this.caller.call(async()=>{const c=await this._fetch(`${this.apiUrl}/likes/${r}/${s}`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:a});return await ge(c,`${n?"like":"unlike"} prompt`),c})).json()}async _getPromptUrl(e){const[n,r,s]=Ss(e);if(await this._currentTenantIsOwner(n)){const i=await this._getSettings();return s!=="latest"?`${this.getHostUrl()}/prompts/${r}/${s.substring(0,8)}?organizationId=${i.id}`:`${this.getHostUrl()}/prompts/${r}?organizationId=${i.id}`}else return s!=="latest"?`${this.getHostUrl()}/hub/${n}/${r}/${s.substring(0,8)}`:`${this.getHostUrl()}/hub/${n}/${r}`}async promptExists(e){return!!await this.getPrompt(e)}async likePrompt(e){return this._likeOrUnlikePrompt(e,!0)}async unlikePrompt(e){return this._likeOrUnlikePrompt(e,!1)}async*listCommits(e){for await(const n of this._getPaginated(`/commits/${e}/`,new URLSearchParams,r=>r.commits))yield*n}async*listPrompts(e){const n=new URLSearchParams;n.append("sort_field",(e==null?void 0:e.sortField)??"updated_at"),n.append("sort_direction","desc"),n.append("is_archived",(!!(e!=null&&e.isArchived)).toString()),(e==null?void 0:e.isPublic)!==void 0&&n.append("is_public",e.isPublic.toString()),e!=null&&e.query&&n.append("query",e.query);for await(const r of this._getPaginated("/repos",n,s=>s.repos))yield*r}async getPrompt(e){const[n,r,s]=Ss(e),i=await this.caller.call(async()=>{const o=await this._fetch(`${this.apiUrl}/repos/${n}/${r}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return(o==null?void 0:o.status)===404?null:(await ge(o,"get prompt"),o)}),a=await(i==null?void 0:i.json());return a!=null&&a.repo?a.repo:null}async createPrompt(e,n){const r=await this._getSettings();if(n!=null&&n.isPublic&&!r.tenant_handle)throw new Error(`Cannot create a public prompt without first

        creating a LangChain Hub handle.
        You can add a handle by creating a public prompt at:

        https://smith.langchain.com/prompts`);const[s,i,a]=Ss(e);if(!await this._currentTenantIsOwner(s))throw await this._ownerConflictError("create a prompt",s);const o={repo_handle:i,...(n==null?void 0:n.description)&&{description:n.description},...(n==null?void 0:n.readme)&&{readme:n.readme},...(n==null?void 0:n.tags)&&{tags:n.tags},is_public:!!(n!=null&&n.isPublic)},c=JSON.stringify(o),l=await this.caller.call(async()=>{const d=await this._fetch(`${this.apiUrl}/repos/`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:c});return await ge(d,"create prompt"),d}),{repo:u}=await l.json();return u}async createCommit(e,n,r){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");const[s,i,a]=Ss(e),o=(r==null?void 0:r.parentCommitHash)==="latest"||!(r!=null&&r.parentCommitHash)?await this._getLatestCommitHash(`${s}/${i}`):r==null?void 0:r.parentCommitHash,c={manifest:JSON.parse(JSON.stringify(n)),parent_commit:o},l=JSON.stringify(c),d=await(await this.caller.call(async()=>{const h=await this._fetch(`${this.apiUrl}/commits/${s}/${i}`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:l});return await ge(h,"create commit"),h})).json();return this._getPromptUrl(`${s}/${i}${d.commit_hash?`:${d.commit_hash}`:""}`)}async updateExamplesMultipart(e,n=[]){return this._updateExamplesMultipart(e,n)}async _updateExamplesMultipart(e,n=[]){var a;if(!await this._getDatasetExamplesMultiPartSupport())throw new Error("Your LangSmith deployment does not allow using the multipart examples endpoint, please upgrade your deployment to the latest version.");const r=new FormData;for(const o of n){const c=o.id,l={...o.metadata&&{metadata:o.metadata},...o.split&&{split:o.split}},u=Ln(l,`Serializing body for example with id: ${c}`),d=new Blob([u],{type:"application/json"});if(r.append(c,d),o.inputs){const h=Ln(o.inputs,`Serializing inputs for example with id: ${c}`),f=new Blob([h],{type:"application/json"});r.append(`${c}.inputs`,f)}if(o.outputs){const h=Ln(o.outputs,`Serializing outputs whle updating example with id: ${c}`),f=new Blob([h],{type:"application/json"});r.append(`${c}.outputs`,f)}if(o.attachments)for(const[h,f]of Object.entries(o.attachments)){let m,g;Array.isArray(f)?[m,g]=f:(m=f.mimeType,g=f.data);const w=new Blob([g],{type:`${m}; length=${g.byteLength}`});r.append(`${c}.attachment.${h}`,w)}if(o.attachments_operations){const h=Ln(o.attachments_operations,`Serializing attachments while updating example with id: ${c}`),f=new Blob([h],{type:"application/json"});r.append(`${c}.attachments_operations`,f)}}const s=e??((a=n[0])==null?void 0:a.dataset_id);return(await this.caller.call(async()=>{const o=await this._fetch(`${this.apiUrl}${this._getPlatformEndpointPath(`datasets/${s}/examples`)}`,{method:"PATCH",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:r});return await ge(o,"update examples"),o})).json()}async uploadExamplesMultipart(e,n=[]){return this._uploadExamplesMultipart(e,n)}async _uploadExamplesMultipart(e,n=[]){if(!await this._getDatasetExamplesMultiPartSupport())throw new Error("Your LangSmith deployment does not allow using the multipart examples endpoint, please upgrade your deployment to the latest version.");const r=new FormData;for(const i of n){const a=(i.id??vr()).toString(),o={created_at:i.created_at,...i.metadata&&{metadata:i.metadata},...i.split&&{split:i.split},...i.source_run_id&&{source_run_id:i.source_run_id},...i.use_source_run_io&&{use_source_run_io:i.use_source_run_io},...i.use_source_run_attachments&&{use_source_run_attachments:i.use_source_run_attachments}},c=Ln(o,`Serializing body for uploaded example with id: ${a}`),l=new Blob([c],{type:"application/json"});if(r.append(a,l),i.inputs){const u=Ln(i.inputs,`Serializing inputs for uploaded example with id: ${a}`),d=new Blob([u],{type:"application/json"});r.append(`${a}.inputs`,d)}if(i.outputs){const u=Ln(i.outputs,`Serializing outputs for uploaded example with id: ${a}`),d=new Blob([u],{type:"application/json"});r.append(`${a}.outputs`,d)}if(i.attachments)for(const[u,d]of Object.entries(i.attachments)){let h,f;Array.isArray(d)?[h,f]=d:(h=d.mimeType,f=d.data);const m=new Blob([f],{type:`${h}; length=${f.byteLength}`});r.append(`${a}.attachment.${u}`,m)}}return(await this.caller.call(async()=>{const i=await this._fetch(`${this.apiUrl}${this._getPlatformEndpointPath(`datasets/${e}/examples`)}`,{method:"POST",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:r});return await ge(i,"upload examples"),i})).json()}async updatePrompt(e,n){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");const[r,s]=Ss(e);if(!await this._currentTenantIsOwner(r))throw await this._ownerConflictError("update a prompt",r);const i={};if((n==null?void 0:n.description)!==void 0&&(i.description=n.description),(n==null?void 0:n.readme)!==void 0&&(i.readme=n.readme),(n==null?void 0:n.tags)!==void 0&&(i.tags=n.tags),(n==null?void 0:n.isPublic)!==void 0&&(i.is_public=n.isPublic),(n==null?void 0:n.isArchived)!==void 0&&(i.is_archived=n.isArchived),Object.keys(i).length===0)throw new Error("No valid update options provided");const a=JSON.stringify(i);return(await this.caller.call(async()=>{const c=await this._fetch(`${this.apiUrl}/repos/${r}/${s}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:a});return await ge(c,"update prompt"),c})).json()}async deletePrompt(e){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");const[n,r,s]=Ss(e);if(!await this._currentTenantIsOwner(n))throw await this._ownerConflictError("delete a prompt",n);return(await this.caller.call(async()=>{const a=await this._fetch(`${this.apiUrl}/repos/${n}/${r}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await ge(a,"delete prompt"),a})).json()}async pullPromptCommit(e,n){const[r,s,i]=Ss(e),o=await(await this.caller.call(async()=>{const c=await this._fetch(`${this.apiUrl}/commits/${r}/${s}/${i}${n!=null&&n.includeModel?"?include_model=true":""}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await ge(c,"pull prompt commit"),c})).json();return{owner:r,repo:s,commit_hash:o.commit_hash,manifest:o.manifest,examples:o.examples}}async _pullPrompt(e,n){const r=await this.pullPromptCommit(e,{includeModel:n==null?void 0:n.includeModel});return JSON.stringify(r.manifest)}async pushPrompt(e,n){return await this.promptExists(e)?n&&Object.keys(n).some(s=>s!=="object")&&await this.updatePrompt(e,{description:n==null?void 0:n.description,readme:n==null?void 0:n.readme,tags:n==null?void 0:n.tags,isPublic:n==null?void 0:n.isPublic}):await this.createPrompt(e,{description:n==null?void 0:n.description,readme:n==null?void 0:n.readme,tags:n==null?void 0:n.tags,isPublic:n==null?void 0:n.isPublic}),n!=null&&n.object?await this.createCommit(e,n==null?void 0:n.object,{parentCommitHash:n==null?void 0:n.parentCommitHash}):await this._getPromptUrl(e)}async clonePublicDataset(e,n={}){const{sourceApiUrl:r=this.apiUrl,datasetName:s}=n,[i,a]=this.parseTokenOrUrl(e,r),o=new pa({apiUrl:i,apiKey:"placeholder"}),c=await o.readSharedDataset(a),l=s||c.name;try{if(await this.hasDataset({datasetId:l})){console.log(`Dataset ${l} already exists in your tenant. Skipping.`);return}}catch{}const u=await o.listSharedExamples(a),d=await this.createDataset(l,{description:c.description,dataType:c.data_type||"kv",inputsSchema:c.inputs_schema_definition??void 0,outputsSchema:c.outputs_schema_definition??void 0});try{await this.createExamples({inputs:u.map(h=>h.inputs),outputs:u.flatMap(h=>h.outputs?[h.outputs]:[]),datasetId:d.id})}catch(h){throw console.error(`An error occurred while creating dataset ${l}. You should delete it manually.`),h}}parseTokenOrUrl(e,n,r=2,s="dataset"){try{return $e(e),[n,e]}catch{}try{const a=new URL(e).pathname.split("/").filter(o=>o!=="");if(a.length>=r){const o=a[a.length-r];return[n,o]}else throw new Error(`Invalid public ${s} URL: ${e}`)}catch{throw new Error(`Invalid public ${s} URL or token: ${e}`)}}async awaitPendingTraceBatches(){var e,n;if(this.manualFlushMode)return console.warn("[WARNING]: When tracing in manual flush mode, you must call `await client.flush()` manually to submit trace batches."),Promise.resolve();await new Promise(r=>setTimeout(r,1)),await Promise.all([...this.autoBatchQueue.items.map(({itemPromise:r})=>r),this.batchIngestCaller.queue.onIdle()]),this.langSmithToOTELTranslator!==void 0&&await((n=(e=CC())==null?void 0:e.DEFAULT_LANGSMITH_SPAN_PROCESSOR)==null?void 0:n.forceFlush())}}function hy(t){return"dataset_id"in t||"dataset_name"in t}const i1=t=>!!["TRACING_V2","TRACING"].find(n=>kn(n)==="true"),Bs=Symbol.for("lc:context_variables"),zd=Symbol.for("langsmith:replica_trace_roots");function fy(t,e){if(Bs in t)return t[Bs][e]}function a1(t,e,n){const r=Bs in t?t[Bs]:{};r[e]=n,t[Bs]=r}const Fa="6ba7b810-9dad-11d1-80b4-00c04fd430c8";function py(t){const n=Object.keys(t).sort().map(r=>`${r}:${t[r]??""}`).join("|");return Ps(n,Fa)}function o1(t){return t.replace(/[-:.]/g,"")}function Vv(t,e=1){const n=e.toFixed(0).slice(0,3).padStart(3,"0");return`${new Date(t).toISOString().slice(0,-1)}${n}Z`}function Gv(t,e,n=1){const r=Vv(t,n);return{dottedOrder:o1(r)+e,microsecondPrecisionDatestring:r}}class Fl{constructor(e,n,r,s){Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"project_name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"replicas",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.metadata=e,this.tags=n,this.project_name=r,this.replicas=s}static fromHeader(e){const n=e.split(",");let r={},s=[],i,a;for(const o of n){const[c,l]=o.split("="),u=decodeURIComponent(l);c==="langsmith-metadata"?r=JSON.parse(u):c==="langsmith-tags"?s=u.split(","):c==="langsmith-project"?i=u:c==="langsmith-replicas"&&(a=JSON.parse(u))}return new Fl(r,s,i,a)}toHeader(){const e=[];return this.metadata&&Object.keys(this.metadata).length>0&&e.push(`langsmith-metadata=${encodeURIComponent(JSON.stringify(this.metadata))}`),this.tags&&this.tags.length>0&&e.push(`langsmith-tags=${encodeURIComponent(this.tags.join(","))}`),this.project_name&&e.push(`langsmith-project=${encodeURIComponent(this.project_name)}`),e.join(",")}}class Sn{constructor(e){var o;if(Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"run_type",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"project_name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"parent_run",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"parent_run_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"child_runs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"start_time",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"end_time",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"extra",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"error",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"serialized",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"reference_example_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"events",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"trace_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"dotted_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracingEnabled",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"execution_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"child_execution_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"attachments",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"replicas",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"distributedParentId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_serialized_start_time",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),c1(e)){Object.assign(this,{...e});return}const n=Sn.getDefaultConfig(),{metadata:r,...s}=e,i=s.client??Sn.getSharedClient(),a={...r,...(o=s==null?void 0:s.extra)==null?void 0:o.metadata};if(s.extra={...s.extra,metadata:a},"id"in s&&s.id==null&&delete s.id,Object.assign(this,{...n,...s,client:i}),this.execution_order??(this.execution_order=1),this.child_execution_order??(this.child_execution_order=1),this.dotted_order||(this._serialized_start_time=Vv(this.start_time,this.execution_order)),this.id||(this.id=mC(this._serialized_start_time??this.start_time)),this.trace_id||(this.parent_run?this.trace_id=this.parent_run.trace_id??this.id:this.trace_id=this.id),this.replicas=h1(this.replicas),!this.dotted_order){const{dottedOrder:c}=Gv(this.start_time,this.id,this.execution_order);this.parent_run?this.dotted_order=this.parent_run.dotted_order+"."+c:this.dotted_order=c}}set metadata(e){var n;this.extra={...this.extra,metadata:{...(n=this.extra)==null?void 0:n.metadata,...e}}}get metadata(){var e;return(e=this.extra)==null?void 0:e.metadata}static getDefaultConfig(){const e=Date.now();return{run_type:"chain",project_name:Sv(),child_runs:[],api_url:Wr("LANGCHAIN_ENDPOINT")??"http://localhost:1984",api_key:Wr("LANGCHAIN_API_KEY"),caller_options:{},start_time:e,serialized:{},inputs:{},extra:{}}}static getSharedClient(){return Sn.sharedClient||(Sn.sharedClient=new pa),Sn.sharedClient}createChild(e){var u,d,h,f,m,g,w;const n=this.child_execution_order+1,r=(u=this.replicas)==null?void 0:u.map(b=>{const{reroot:y,...v}=b;return v}),s=e.replicas??r,i=new Sn({...e,parent_run:this,project_name:this.project_name,replicas:s,client:this.client,tracingEnabled:this.tracingEnabled,execution_order:n,child_execution_order:n});Bs in this&&(i[Bs]=this[Bs]);const a=Symbol.for("lc:child_config"),o=((d=e.extra)==null?void 0:d[a])??this.extra[a];if(u1(o)){const b={...o},y=l1(b.callbacks)?(f=(h=b.callbacks).copy)==null?void 0:f.call(h):void 0;y&&(Object.assign(y,{_parentRunId:i.id}),(w=(g=(m=y.handlers)==null?void 0:m.find(Wv))==null?void 0:g.updateFromRunTree)==null||w.call(g,i),b.callbacks=y),i.extra[a]=b}const c=new Set;let l=this;for(;l!=null&&!c.has(l.id);)c.add(l.id),l.child_execution_order=Math.max(l.child_execution_order,n),l=l.parent_run;return this.child_runs.push(i),i}async end(e,n,r=Date.now(),s){this.outputs=this.outputs??e,this.error=this.error??n,this.end_time=this.end_time??r,s&&Object.keys(s).length>0&&(this.extra=this.extra?{...this.extra,metadata:{...this.extra.metadata,...s}}:{metadata:s})}_convertToCreate(e,n,r=!0){var o,c;const s=e.extra??{};if(((o=s==null?void 0:s.runtime)==null?void 0:o.library)===void 0&&(s.runtime||(s.runtime={}),n))for(const[l,u]of Object.entries(n))s.runtime[l]||(s.runtime[l]=u);let i,a;return r?(a=((c=e.parent_run)==null?void 0:c.id)??e.parent_run_id,i=[]):(i=e.child_runs.map(l=>this._convertToCreate(l,n,r)),a=void 0),{id:e.id,name:e.name,start_time:e._serialized_start_time??e.start_time,end_time:e.end_time,run_type:e.run_type,reference_example_id:e.reference_example_id,extra:s,serialized:e.serialized,error:e.error,inputs:e.inputs,outputs:e.outputs,session_name:e.project_name,child_runs:i,parent_run_id:a,trace_id:e.trace_id,dotted_order:e.dotted_order,tags:e.tags,attachments:e.attachments,events:e.events}}_sliceParentId(e,n){if(n.dotted_order){const r=n.dotted_order.split(".");let s=null;for(let i=0;i<r.length;i++)if(r[i].slice(-36)===e){s=i;break}if(s!==null){const i=r.slice(s+1);n.dotted_order=i.join("."),i.length>0?n.trace_id=i[0].slice(-36):n.trace_id=n.id}}n.parent_run_id===e&&(n.parent_run_id=void 0)}_setReplicaTraceRoot(e,n){const r=fy(this,zd)??{};r[e]=n,a1(this,zd,r);for(const s of this.child_runs)s._setReplicaTraceRoot(e,n)}_remapForProject(e){const{projectName:n,runtimeEnv:r,excludeChildRuns:s=!0,reroot:i=!1,distributedParentId:a,apiUrl:o,apiKey:c,workspaceId:l}=e,u=this._convertToCreate(this,r,s);if(n===this.project_name)return{...u,session_name:n};if(i){if(a)this._sliceParentId(a,u);else if(u.parent_run_id=void 0,u.dotted_order){const y=u.dotted_order.split(".");y.length>0&&(u.dotted_order=y[y.length-1],u.trace_id=u.id)}const b=py({projectName:n,apiUrl:o,apiKey:c,workspaceId:l});this._setReplicaTraceRoot(b,u.id)}let d;if(!i){const b=fy(this,zd)??{},y=py({projectName:n,apiUrl:o,apiKey:c,workspaceId:l});if(d=b[y],d&&(u.trace_id=d,u.dotted_order)){const v=u.dotted_order.split(".");let T=null;for(let A=0;A<v.length;A++)if(v[A].slice(-36)===d){T=A;break}if(T!==null){const A=v.slice(T);u.dotted_order=A.join(".")}}}const h=u.id,f=Ps(`${h}:${n}`,Fa);let m;u.trace_id?m=Ps(`${u.trace_id}:${n}`,Fa):m=f;let g;u.parent_run_id&&(g=Ps(`${u.parent_run_id}:${n}`,Fa));let w;return u.dotted_order&&(w=u.dotted_order.split(".").map(v=>{const T=v.slice(-36),A=Ps(`${T}:${n}`,Fa);return v.slice(0,-36)+A}).join(".")),{...u,id:f,trace_id:m,parent_run_id:g,dotted_order:w,session_name:n}}async postRun(e=!0){try{const n=Cv();if(this.replicas&&this.replicas.length>0)for(const{projectName:r,apiKey:s,apiUrl:i,workspaceId:a,reroot:o}of this.replicas){const c=this._remapForProject({projectName:r??this.project_name,runtimeEnv:n,excludeChildRuns:!0,reroot:o,distributedParentId:this.distributedParentId,apiUrl:i,apiKey:s,workspaceId:a});await this.client.createRun(c,{apiKey:s,apiUrl:i,workspaceId:a})}else{const r=this._convertToCreate(this,n,e);await this.client.createRun(r)}if(!e){xv("Posting with excludeChildRuns=false is deprecated and will be removed in a future version.");for(const r of this.child_runs)await r.postRun(!1)}}catch(n){console.error(`Error in postRun for run ${this.id}:`,n)}}async patchRun(e){var n;if(this.replicas&&this.replicas.length>0)for(const{projectName:r,apiKey:s,apiUrl:i,workspaceId:a,updates:o,reroot:c}of this.replicas){const l=this._remapForProject({projectName:r??this.project_name,runtimeEnv:void 0,excludeChildRuns:!0,reroot:c,distributedParentId:this.distributedParentId,apiUrl:i,apiKey:s,workspaceId:a}),u={id:l.id,name:l.name,run_type:l.run_type,start_time:l.start_time,outputs:l.outputs,error:l.error,parent_run_id:l.parent_run_id,session_name:l.session_name,reference_example_id:l.reference_example_id,end_time:l.end_time,dotted_order:l.dotted_order,trace_id:l.trace_id,events:l.events,tags:l.tags,extra:l.extra,attachments:this.attachments,...o};e!=null&&e.excludeInputs||(u.inputs=l.inputs),await this.client.updateRun(l.id,u,{apiKey:s,apiUrl:i,workspaceId:a})}else try{const r={name:this.name,run_type:this.run_type,start_time:this._serialized_start_time??this.start_time,end_time:this.end_time,error:this.error,outputs:this.outputs,parent_run_id:((n=this.parent_run)==null?void 0:n.id)??this.parent_run_id,reference_example_id:this.reference_example_id,extra:this.extra,events:this.events,dotted_order:this.dotted_order,trace_id:this.trace_id,tags:this.tags,attachments:this.attachments,session_name:this.project_name};e!=null&&e.excludeInputs||(r.inputs=this.inputs),await this.client.updateRun(this.id,r)}catch(r){console.error(`Error in patchRun for run ${this.id}`,r)}}toJSON(){return this._convertToCreate(this,void 0,!1)}addEvent(e){this.events||(this.events=[]),typeof e=="string"?this.events.push({name:"event",time:new Date().toISOString(),message:e}):this.events.push({...e,time:e.time??new Date().toISOString()})}static fromRunnableConfig(e,n){var l,u,d,h;const r=e==null?void 0:e.callbacks;let s,i,a,o=i1();if(r){const f=((l=r==null?void 0:r.getParentRunId)==null?void 0:l.call(r))??"",m=(u=r==null?void 0:r.handlers)==null?void 0:u.find(g=>(g==null?void 0:g.name)=="langchain_tracer");s=(d=m==null?void 0:m.getRun)==null?void 0:d.call(m,f),i=m==null?void 0:m.projectName,a=m==null?void 0:m.client,o=o||!!m}return s?new Sn({name:s.name,id:s.id,trace_id:s.trace_id,dotted_order:s.dotted_order,client:a,tracingEnabled:o,project_name:i,tags:[...new Set(((s==null?void 0:s.tags)??[]).concat((e==null?void 0:e.tags)??[]))],extra:{metadata:{...(h=s==null?void 0:s.extra)==null?void 0:h.metadata,...e==null?void 0:e.metadata}}}).createChild(n):new Sn({...n,client:a,tracingEnabled:o,project_name:i})}static fromDottedOrder(e){return this.fromHeaders({"langsmith-trace":e})}static fromHeaders(e,n){var u;const r="get"in e&&typeof e.get=="function"?{"langsmith-trace":e.get("langsmith-trace"),baggage:e.get("baggage")}:e,s=r["langsmith-trace"];if(!s||typeof s!="string")return;const i=s.trim(),a=i.split(".").map(d=>{const[h,f]=d.split("Z");return{strTime:h,time:Date.parse(h+"Z"),uuid:f}}),o=a[0].uuid,c={...n,name:(n==null?void 0:n.name)??"parent",run_type:(n==null?void 0:n.run_type)??"chain",start_time:(n==null?void 0:n.start_time)??Date.now(),id:(u=a.at(-1))==null?void 0:u.uuid,trace_id:o,dotted_order:i};if(r.baggage&&typeof r.baggage=="string"){const d=Fl.fromHeader(r.baggage);c.metadata=d.metadata,c.tags=d.tags,c.project_name=d.project_name,c.replicas=d.replicas}const l=new Sn(c);return l.distributedParentId=l.id,l}toHeaders(e){var r;const n={"langsmith-trace":this.dotted_order,baggage:new Fl((r=this.extra)==null?void 0:r.metadata,this.tags,this.project_name,this.replicas).toHeader()};if(e)for(const[s,i]of Object.entries(n))e.set(s,i);return n}}Object.defineProperty(Sn,"sharedClient",{enumerable:!0,configurable:!0,writable:!0,value:null});function c1(t){return t!=null&&typeof t.createChild=="function"&&typeof t.postRun=="function"}function Wv(t){return typeof t=="object"&&t!=null&&typeof t.name=="string"&&t.name==="langchain_tracer"}function my(t){return Array.isArray(t)&&t.some(e=>Wv(e))}function l1(t){return typeof t=="object"&&t!=null&&Array.isArray(t.handlers)}function u1(t){const e=t==null?void 0:t.callbacks;return t!=null&&typeof e=="object"&&(my(e==null?void 0:e.handlers)||my(e))}function d1(){const t=Wr("LANGSMITH_RUNS_ENDPOINTS");if(!t)return[];try{const e=JSON.parse(t);if(Array.isArray(e)){const n=[];for(const r of e){if(typeof r!="object"||r===null){console.warn(`Invalid item type in LANGSMITH_RUNS_ENDPOINTS: expected object, got ${typeof r}`);continue}if(typeof r.api_url!="string"){console.warn(`Invalid api_url type in LANGSMITH_RUNS_ENDPOINTS: expected string, got ${typeof r.api_url}`);continue}if(typeof r.api_key!="string"){console.warn(`Invalid api_key type in LANGSMITH_RUNS_ENDPOINTS: expected string, got ${typeof r.api_key}`);continue}n.push({apiUrl:r.api_url.replace(/\/$/,""),apiKey:r.api_key})}return n}else if(typeof e=="object"&&e!==null){f1(e);const n=[];for(const[r,s]of Object.entries(e)){const i=r.replace(/\/$/,"");if(typeof s=="string")n.push({apiUrl:i,apiKey:s});else{console.warn(`Invalid value type in LANGSMITH_RUNS_ENDPOINTS for URL ${r}: expected string, got ${typeof s}`);continue}}return n}else return console.warn(`Invalid LANGSMITH_RUNS_ENDPOINTS  must be valid JSON array of objects with api_url and api_key properties, or object mapping url->apiKey, got ${typeof e}`),[]}catch(e){if(GO(e))throw e;return console.warn("Invalid LANGSMITH_RUNS_ENDPOINTS  must be valid JSON array of objects with api_url and api_key properties, or object mapping url->apiKey"),[]}}function h1(t){return t?t.map(e=>Array.isArray(e)?{projectName:e[0],updates:e[1]}:e):d1()}function f1(t){if(Object.keys(t).length>0&&kn("ENDPOINT"))throw new VO}var Hv={};Se(Hv,{BaseTracer:()=>Es,isBaseTracer:()=>Hi});const p1=t=>{if(t)return t.events=t.events??[],t.child_runs=t.child_runs??[],t};function Vh(t,e){if(t)return new Sn({...t,start_time:t._serialized_start_time??t.start_time,parent_run:Vh(e),child_runs:t.child_runs.map(n=>Vh(n)).filter(n=>n!==void 0),extra:{...t.extra,runtime:wv()},tracingEnabled:!1})}function Zd(t,e){return t&&!Array.isArray(t)&&typeof t=="object"?t:{[e]:t}}function Hi(t){return typeof t._addRunToRunMap=="function"}var Es=class extends $a{constructor(e){super(...arguments);p(this,"runMap",new Map);p(this,"runTreeMap",new Map);p(this,"usesRunTreeMap",!1)}copy(){return this}getRunById(e){if(e!==void 0)return this.usesRunTreeMap?p1(this.runTreeMap.get(e)):this.runMap.get(e)}stringifyError(e){return e instanceof Error?e.message+(e!=null&&e.stack?`

${e.stack}`:""):typeof e=="string"?e:`${e}`}_addChildRun(e,n){e.child_runs.push(n)}_addRunToRunMap(e){const{dottedOrder:n,microsecondPrecisionDatestring:r}=Gv(new Date(e.start_time).getTime(),e.id,e.execution_order),s={...e},i=this.getRunById(s.parent_run_id);if(s.parent_run_id!==void 0?i?(this._addChildRun(i,s),i.child_execution_order=Math.max(i.child_execution_order,s.child_execution_order),s.trace_id=i.trace_id,i.dotted_order!==void 0&&(s.dotted_order=[i.dotted_order,n].join("."),s._serialized_start_time=r)):s.parent_run_id=void 0:(s.trace_id=s.id,s.dotted_order=n,s._serialized_start_time=r),this.usesRunTreeMap){const a=Vh(s,i);a!==void 0&&this.runTreeMap.set(s.id,a)}else this.runMap.set(s.id,s);return s}async _endTrace(e){var r;const n=e.parent_run_id!==void 0&&this.getRunById(e.parent_run_id);n?n.child_execution_order=Math.max(n.child_execution_order,e.child_execution_order):await this.persistRun(e),await((r=this.onRunUpdate)==null?void 0:r.call(this,e)),this.usesRunTreeMap?this.runTreeMap.delete(e.id):this.runMap.delete(e.id)}_getExecutionOrder(e){const n=e!==void 0&&this.getRunById(e);return n?n.child_execution_order+1:1}_createRunForLLMStart(e,n,r,s,i,a,o,c){const l=this._getExecutionOrder(s),u=Date.now(),d=o?{...i,metadata:o}:i,h={id:r,name:c??e.id[e.id.length-1],parent_run_id:s,start_time:u,serialized:e,events:[{name:"start",time:new Date(u).toISOString()}],inputs:{prompts:n},execution_order:l,child_runs:[],child_execution_order:l,run_type:"llm",extra:d??{},tags:a||[]};return this._addRunToRunMap(h)}async handleLLMStart(e,n,r,s,i,a,o,c){var u,d;const l=this.getRunById(r)??this._createRunForLLMStart(e,n,r,s,i,a,o,c);return await((u=this.onRunCreate)==null?void 0:u.call(this,l)),await((d=this.onLLMStart)==null?void 0:d.call(this,l)),l}_createRunForChatModelStart(e,n,r,s,i,a,o,c){const l=this._getExecutionOrder(s),u=Date.now(),d=o?{...i,metadata:o}:i,h={id:r,name:c??e.id[e.id.length-1],parent_run_id:s,start_time:u,serialized:e,events:[{name:"start",time:new Date(u).toISOString()}],inputs:{messages:n},execution_order:l,child_runs:[],child_execution_order:l,run_type:"llm",extra:d??{},tags:a||[]};return this._addRunToRunMap(h)}async handleChatModelStart(e,n,r,s,i,a,o,c){var u,d;const l=this.getRunById(r)??this._createRunForChatModelStart(e,n,r,s,i,a,o,c);return await((u=this.onRunCreate)==null?void 0:u.call(this,l)),await((d=this.onLLMStart)==null?void 0:d.call(this,l)),l}async handleLLMEnd(e,n,r,s,i){var o;const a=this.getRunById(n);if(!a||(a==null?void 0:a.run_type)!=="llm")throw new Error("No LLM run to end.");return a.end_time=Date.now(),a.outputs=e,a.events.push({name:"end",time:new Date(a.end_time).toISOString()}),a.extra={...a.extra,...i},await((o=this.onLLMEnd)==null?void 0:o.call(this,a)),await this._endTrace(a),a}async handleLLMError(e,n,r,s,i){var o;const a=this.getRunById(n);if(!a||(a==null?void 0:a.run_type)!=="llm")throw new Error("No LLM run to end.");return a.end_time=Date.now(),a.error=this.stringifyError(e),a.events.push({name:"error",time:new Date(a.end_time).toISOString()}),a.extra={...a.extra,...i},await((o=this.onLLMError)==null?void 0:o.call(this,a)),await this._endTrace(a),a}_createRunForChainStart(e,n,r,s,i,a,o,c,l){const u=this._getExecutionOrder(s),d=Date.now(),h={id:r,name:c??e.id[e.id.length-1],parent_run_id:s,start_time:d,serialized:e,events:[{name:"start",time:new Date(d).toISOString()}],inputs:n,execution_order:u,child_execution_order:u,run_type:o??"chain",child_runs:[],extra:a?{...l,metadata:a}:{...l},tags:i||[]};return this._addRunToRunMap(h)}async handleChainStart(e,n,r,s,i,a,o,c){var u,d;const l=this.getRunById(r)??this._createRunForChainStart(e,n,r,s,i,a,o,c);return await((u=this.onRunCreate)==null?void 0:u.call(this,l)),await((d=this.onChainStart)==null?void 0:d.call(this,l)),l}async handleChainEnd(e,n,r,s,i){var o;const a=this.getRunById(n);if(!a)throw new Error("No chain run to end.");return a.end_time=Date.now(),a.outputs=Zd(e,"output"),a.events.push({name:"end",time:new Date(a.end_time).toISOString()}),(i==null?void 0:i.inputs)!==void 0&&(a.inputs=Zd(i.inputs,"input")),await((o=this.onChainEnd)==null?void 0:o.call(this,a)),await this._endTrace(a),a}async handleChainError(e,n,r,s,i){var o;const a=this.getRunById(n);if(!a)throw new Error("No chain run to end.");return a.end_time=Date.now(),a.error=this.stringifyError(e),a.events.push({name:"error",time:new Date(a.end_time).toISOString()}),(i==null?void 0:i.inputs)!==void 0&&(a.inputs=Zd(i.inputs,"input")),await((o=this.onChainError)==null?void 0:o.call(this,a)),await this._endTrace(a),a}_createRunForToolStart(e,n,r,s,i,a,o){const c=this._getExecutionOrder(s),l=Date.now(),u={id:r,name:o??e.id[e.id.length-1],parent_run_id:s,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{input:n},execution_order:c,child_execution_order:c,run_type:"tool",child_runs:[],extra:a?{metadata:a}:{},tags:i||[]};return this._addRunToRunMap(u)}async handleToolStart(e,n,r,s,i,a,o){var l,u;const c=this.getRunById(r)??this._createRunForToolStart(e,n,r,s,i,a,o);return await((l=this.onRunCreate)==null?void 0:l.call(this,c)),await((u=this.onToolStart)==null?void 0:u.call(this,c)),c}async handleToolEnd(e,n){var s;const r=this.getRunById(n);if(!r||(r==null?void 0:r.run_type)!=="tool")throw new Error("No tool run to end");return r.end_time=Date.now(),r.outputs={output:e},r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await((s=this.onToolEnd)==null?void 0:s.call(this,r)),await this._endTrace(r),r}async handleToolError(e,n){var s;const r=this.getRunById(n);if(!r||(r==null?void 0:r.run_type)!=="tool")throw new Error("No tool run to end");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await((s=this.onToolError)==null?void 0:s.call(this,r)),await this._endTrace(r),r}async handleAgentAction(e,n){var i;const r=this.getRunById(n);if(!r||(r==null?void 0:r.run_type)!=="chain")return;const s=r;s.actions=s.actions||[],s.actions.push(e),s.events.push({name:"agent_action",time:new Date().toISOString(),kwargs:{action:e}}),await((i=this.onAgentAction)==null?void 0:i.call(this,r))}async handleAgentEnd(e,n){var s;const r=this.getRunById(n);!r||(r==null?void 0:r.run_type)!=="chain"||(r.events.push({name:"agent_end",time:new Date().toISOString(),kwargs:{action:e}}),await((s=this.onAgentEnd)==null?void 0:s.call(this,r)))}_createRunForRetrieverStart(e,n,r,s,i,a,o){const c=this._getExecutionOrder(s),l=Date.now(),u={id:r,name:o??e.id[e.id.length-1],parent_run_id:s,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{query:n},execution_order:c,child_execution_order:c,run_type:"retriever",child_runs:[],extra:a?{metadata:a}:{},tags:i||[]};return this._addRunToRunMap(u)}async handleRetrieverStart(e,n,r,s,i,a,o){var l,u;const c=this.getRunById(r)??this._createRunForRetrieverStart(e,n,r,s,i,a,o);return await((l=this.onRunCreate)==null?void 0:l.call(this,c)),await((u=this.onRetrieverStart)==null?void 0:u.call(this,c)),c}async handleRetrieverEnd(e,n){var s;const r=this.getRunById(n);if(!r||(r==null?void 0:r.run_type)!=="retriever")throw new Error("No retriever run to end");return r.end_time=Date.now(),r.outputs={documents:e},r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await((s=this.onRetrieverEnd)==null?void 0:s.call(this,r)),await this._endTrace(r),r}async handleRetrieverError(e,n){var s;const r=this.getRunById(n);if(!r||(r==null?void 0:r.run_type)!=="retriever")throw new Error("No retriever run to end");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await((s=this.onRetrieverError)==null?void 0:s.call(this,r)),await this._endTrace(r),r}async handleText(e,n){var s;const r=this.getRunById(n);!r||(r==null?void 0:r.run_type)!=="chain"||(r.events.push({name:"text",time:new Date().toISOString(),kwargs:{text:e}}),await((s=this.onText)==null?void 0:s.call(this,r)))}async handleLLMNewToken(e,n,r,s,i,a){var c;const o=this.getRunById(r);if(!o||(o==null?void 0:o.run_type)!=="llm")throw new Error('Invalid "runId" provided to "handleLLMNewToken" callback.');return o.events.push({name:"new_token",time:new Date().toISOString(),kwargs:{token:e,idx:n,chunk:a==null?void 0:a.chunk}}),await((c=this.onLLMNewToken)==null?void 0:c.call(this,o,e,{chunk:a==null?void 0:a.chunk})),o}},Gp={exports:{}};Gp.exports;(function(t){const n=(i=0)=>a=>`\x1B[${38+i};5;${a}m`,r=(i=0)=>(a,o,c)=>`\x1B[${38+i};2;${a};${o};${c}m`;function s(){const i=new Map,a={modifier:{reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],overline:[53,55],inverse:[7,27],hidden:[8,28],strikethrough:[9,29]},color:{black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],blackBright:[90,39],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39]},bgColor:{bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgBlackBright:[100,49],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49]}};a.color.gray=a.color.blackBright,a.bgColor.bgGray=a.bgColor.bgBlackBright,a.color.grey=a.color.blackBright,a.bgColor.bgGrey=a.bgColor.bgBlackBright;for(const[o,c]of Object.entries(a)){for(const[l,u]of Object.entries(c))a[l]={open:`\x1B[${u[0]}m`,close:`\x1B[${u[1]}m`},c[l]=a[l],i.set(u[0],u[1]);Object.defineProperty(a,o,{value:c,enumerable:!1})}return Object.defineProperty(a,"codes",{value:i,enumerable:!1}),a.color.close="\x1B[39m",a.bgColor.close="\x1B[49m",a.color.ansi256=n(),a.color.ansi16m=r(),a.bgColor.ansi256=n(10),a.bgColor.ansi16m=r(10),Object.defineProperties(a,{rgbToAnsi256:{value:(o,c,l)=>o===c&&c===l?o<8?16:o>248?231:Math.round((o-8)/247*24)+232:16+36*Math.round(o/255*5)+6*Math.round(c/255*5)+Math.round(l/255*5),enumerable:!1},hexToRgb:{value:o=>{const c=/(?<colorString>[a-f\d]{6}|[a-f\d]{3})/i.exec(o.toString(16));if(!c)return[0,0,0];let{colorString:l}=c.groups;l.length===3&&(l=l.split("").map(d=>d+d).join(""));const u=Number.parseInt(l,16);return[u>>16&255,u>>8&255,u&255]},enumerable:!1},hexToAnsi256:{value:o=>a.rgbToAnsi256(...a.hexToRgb(o)),enumerable:!1}}),a}Object.defineProperty(t,"exports",{enumerable:!0,get:s})})(Gp);var m1=Gp.exports;const qv=bp(m1);var Jv={};Se(Jv,{ConsoleCallbackHandler:()=>Gh});function pn(t,e){return`${t.open}${e}${t.close}`}function Qn(t,e){try{return JSON.stringify(t,null,2)}catch{return e}}function gy(t){return typeof t=="string"?t.trim():t==null?t:Qn(t,t.toString())}function xs(t){if(!t.end_time)return"";const e=t.end_time-t.start_time;return e<1e3?`${e}ms`:`${(e/1e3).toFixed(2)}s`}const{color:Tn}=qv;var Gh=class extends Es{constructor(){super(...arguments);p(this,"name","console_callback_handler")}persistRun(e){return Promise.resolve()}getParents(e){const n=[];let r=e;for(;r.parent_run_id;){const s=this.runMap.get(r.parent_run_id);if(s)n.push(s),r=s;else break}return n}getBreadcrumbs(e){const r=[...this.getParents(e).reverse(),e].map((s,i,a)=>{const o=`${s.execution_order}:${s.run_type}:${s.name}`;return i===a.length-1?pn(qv.bold,o):o}).join(" > ");return pn(Tn.grey,r)}onChainStart(e){const n=this.getBreadcrumbs(e);console.log(`${pn(Tn.green,"[chain/start]")} [${n}] Entering Chain run with input: ${Qn(e.inputs,"[inputs]")}`)}onChainEnd(e){const n=this.getBreadcrumbs(e);console.log(`${pn(Tn.cyan,"[chain/end]")} [${n}] [${xs(e)}] Exiting Chain run with output: ${Qn(e.outputs,"[outputs]")}`)}onChainError(e){const n=this.getBreadcrumbs(e);console.log(`${pn(Tn.red,"[chain/error]")} [${n}] [${xs(e)}] Chain run errored with error: ${Qn(e.error,"[error]")}`)}onLLMStart(e){const n=this.getBreadcrumbs(e),r="prompts"in e.inputs?{prompts:e.inputs.prompts.map(s=>s.trim())}:e.inputs;console.log(`${pn(Tn.green,"[llm/start]")} [${n}] Entering LLM run with input: ${Qn(r,"[inputs]")}`)}onLLMEnd(e){const n=this.getBreadcrumbs(e);console.log(`${pn(Tn.cyan,"[llm/end]")} [${n}] [${xs(e)}] Exiting LLM run with output: ${Qn(e.outputs,"[response]")}`)}onLLMError(e){const n=this.getBreadcrumbs(e);console.log(`${pn(Tn.red,"[llm/error]")} [${n}] [${xs(e)}] LLM run errored with error: ${Qn(e.error,"[error]")}`)}onToolStart(e){const n=this.getBreadcrumbs(e);console.log(`${pn(Tn.green,"[tool/start]")} [${n}] Entering Tool run with input: "${gy(e.inputs.input)}"`)}onToolEnd(e){var r;const n=this.getBreadcrumbs(e);console.log(`${pn(Tn.cyan,"[tool/end]")} [${n}] [${xs(e)}] Exiting Tool run with output: "${gy((r=e.outputs)==null?void 0:r.output)}"`)}onToolError(e){const n=this.getBreadcrumbs(e);console.log(`${pn(Tn.red,"[tool/error]")} [${n}] [${xs(e)}] Tool run errored with error: ${Qn(e.error,"[error]")}`)}onRetrieverStart(e){const n=this.getBreadcrumbs(e);console.log(`${pn(Tn.green,"[retriever/start]")} [${n}] Entering Retriever run with input: ${Qn(e.inputs,"[inputs]")}`)}onRetrieverEnd(e){const n=this.getBreadcrumbs(e);console.log(`${pn(Tn.cyan,"[retriever/end]")} [${n}] [${xs(e)}] Exiting Retriever run with output: ${Qn(e.outputs,"[outputs]")}`)}onRetrieverError(e){const n=this.getBreadcrumbs(e);console.log(`${pn(Tn.red,"[retriever/error]")} [${n}] [${xs(e)}] Retriever run errored with error: ${Qn(e.error,"[error]")}`)}onAgentAction(e){const n=e,r=this.getBreadcrumbs(e);console.log(`${pn(Tn.blue,"[agent/action]")} [${r}] Agent selected action: ${Qn(n.actions[n.actions.length-1],"[action]")}`)}};let Vd;const Kv=()=>{if(Vd===void 0){const t=Sr("LANGCHAIN_CALLBACKS_BACKGROUND")==="false"?{blockOnRootRunFinalization:!0}:{};Vd=new pa(t)}return Vd};let g1=class{getStore(){}run(e,n){return n()}};const Gd=Symbol.for("ls:tracing_async_local_storage"),y1=new g1;let _1=class{getInstance(){return globalThis[Gd]??y1}initializeGlobalInstance(e){globalThis[Gd]===void 0&&(globalThis[Gd]=e)}};const w1=new _1;function v1(t=!1){const e=w1.getInstance().getStore();if(!t&&e===void 0)throw new Error(`Could not get the current run tree.

Please make sure you are calling this method within a traceable function and that tracing is enabled.`);return e}function Wp(t){return typeof t=="function"&&"langsmith:traceable"in t}var Xv={};Se(Xv,{LangChainTracer:()=>il});function b1(t){let e;for(const n of t)for(const r of n)le.isInstance(r.message)&&r.message.usage_metadata!==void 0&&(e=Ap(e,r.message.usage_metadata));return e}var il=class Yv extends Es{constructor(n={}){super(n);p(this,"name","langchain_tracer");p(this,"projectName");p(this,"exampleId");p(this,"client");p(this,"replicas");p(this,"usesRunTreeMap",!0);const{exampleId:r,projectName:s,client:i,replicas:a}=n;this.projectName=s??Sv(),this.replicas=a,this.exampleId=r,this.client=i??Kv();const o=Yv.getTraceableRunTree();o&&this.updateFromRunTree(o)}async persistRun(n){}async onRunCreate(n){var r;if(!((r=n.extra)!=null&&r.lc_defers_inputs)){const s=this.getRunTreeWithTracingConfig(n.id);await(s==null?void 0:s.postRun())}}async onRunUpdate(n){var s;const r=this.getRunTreeWithTracingConfig(n.id);(s=n.extra)!=null&&s.lc_defers_inputs?await(r==null?void 0:r.postRun()):await(r==null?void 0:r.patchRun())}onLLMEnd(n){const r=n.outputs;if(r!=null&&r.generations){const s=b1(r.generations);if(s!==void 0){n.extra=n.extra??{};const i=n.extra.metadata??{};i.usage_metadata=s,n.extra.metadata=i}}}getRun(n){return this.runTreeMap.get(n)}updateFromRunTree(n){this.runTreeMap.set(n.id,n);let r=n;const s=new Set;for(;r.parent_run&&!(s.has(r.id)||(s.add(r.id),!r.parent_run));)r=r.parent_run;s.clear();const i=[r];for(;i.length>0;){const a=i.shift();!a||s.has(a.id)||(s.add(a.id),this.runTreeMap.set(a.id,a),a.child_runs&&i.push(...a.child_runs))}this.client=n.client??this.client,this.replicas=n.replicas??this.replicas,this.projectName=n.project_name??this.projectName,this.exampleId=n.reference_example_id??this.exampleId}getRunTreeWithTracingConfig(n){const r=this.runTreeMap.get(n);if(r)return new Sn({...r,client:this.client,project_name:this.projectName,replicas:this.replicas,reference_example_id:this.exampleId,tracingEnabled:!0})}static getTraceableRunTree(){try{return v1(!0)}catch{return}}};let vi;function E1(){const t="default"in os?os.default:os;return new t({autoStart:!0,concurrency:1})}function T1(){return typeof vi>"u"&&(vi=E1()),vi}async function Rt(t,e){if(e===!0){const n=Eo();n!==void 0?await n.run(void 0,async()=>t()):await t()}else vi=T1(),vi.add(async()=>{const n=Eo();n!==void 0?await n.run(void 0,async()=>t()):await t()})}async function S1(){const t=Kv();await Promise.allSettled([typeof vi<"u"?vi.onIdle():Promise.resolve(),t.awaitPendingTraceBatches()])}var Qv={};Se(Qv,{awaitAllCallbacks:()=>S1,consumeCallback:()=>Rt});const x1=t=>!!["LANGSMITH_TRACING_V2","LANGCHAIN_TRACING_V2","LANGSMITH_TRACING","LANGCHAIN_TRACING"].find(n=>Sr(n)==="true");function eb(t){var r;const e=Eo();if(e===void 0)return;const n=e.getStore();return(r=n==null?void 0:n[io])==null?void 0:r[t]}const k1=Symbol("lc:configure_hooks"),I1=()=>eb(k1)||[];var tb={};Se(tb,{BaseCallbackManager:()=>nb,BaseRunManager:()=>rc,CallbackManager:()=>wn,CallbackManagerForChainRun:()=>sb,CallbackManagerForLLMRun:()=>Wh,CallbackManagerForRetrieverRun:()=>rb,CallbackManagerForToolRun:()=>ib,ensureHandler:()=>To,parseCallbackConfigArg:()=>nc});function nc(t){return t?Array.isArray(t)||"name"in t?{callbacks:t}:t:{}}var nb=class{setHandler(t){return this.setHandlers([t])}},rc=class{constructor(t,e,n,r,s,i,a,o){this.runId=t,this.handlers=e,this.inheritableHandlers=n,this.tags=r,this.inheritableTags=s,this.metadata=i,this.inheritableMetadata=a,this._parentRunId=o}get parentRunId(){return this._parentRunId}async handleText(t){await Promise.all(this.handlers.map(e=>Rt(async()=>{var n;try{await((n=e.handleText)==null?void 0:n.call(e,t,this.runId,this._parentRunId,this.tags))}catch(r){if((e.raiseError?console.error:console.warn)(`Error in handler ${e.constructor.name}, handleText: ${r}`),e.raiseError)throw r}},e.awaitHandlers)))}async handleCustomEvent(t,e,n,r,s){await Promise.all(this.handlers.map(i=>Rt(async()=>{var a;try{await((a=i.handleCustomEvent)==null?void 0:a.call(i,t,e,this.runId,this.tags,this.metadata))}catch(o){if((i.raiseError?console.error:console.warn)(`Error in handler ${i.constructor.name}, handleCustomEvent: ${o}`),i.raiseError)throw o}},i.awaitHandlers)))}},rb=class extends rc{getChild(t){const e=new wn(this.runId);return e.setHandlers(this.inheritableHandlers),e.addTags(this.inheritableTags),e.addMetadata(this.inheritableMetadata),t&&e.addTags([t],!1),e}async handleRetrieverEnd(t){await Promise.all(this.handlers.map(e=>Rt(async()=>{var n;if(!e.ignoreRetriever)try{await((n=e.handleRetrieverEnd)==null?void 0:n.call(e,t,this.runId,this._parentRunId,this.tags))}catch(r){if((e.raiseError?console.error:console.warn)(`Error in handler ${e.constructor.name}, handleRetriever`),e.raiseError)throw r}},e.awaitHandlers)))}async handleRetrieverError(t){await Promise.all(this.handlers.map(e=>Rt(async()=>{var n;if(!e.ignoreRetriever)try{await((n=e.handleRetrieverError)==null?void 0:n.call(e,t,this.runId,this._parentRunId,this.tags))}catch(r){if((e.raiseError?console.error:console.warn)(`Error in handler ${e.constructor.name}, handleRetrieverError: ${r}`),e.raiseError)throw t}},e.awaitHandlers)))}},Wh=class extends rc{async handleLLMNewToken(t,e,n,r,s,i){await Promise.all(this.handlers.map(a=>Rt(async()=>{var o;if(!a.ignoreLLM)try{await((o=a.handleLLMNewToken)==null?void 0:o.call(a,t,e??{prompt:0,completion:0},this.runId,this._parentRunId,this.tags,i))}catch(c){if((a.raiseError?console.error:console.warn)(`Error in handler ${a.constructor.name}, handleLLMNewToken: ${c}`),a.raiseError)throw c}},a.awaitHandlers)))}async handleLLMError(t,e,n,r,s){await Promise.all(this.handlers.map(i=>Rt(async()=>{var a;if(!i.ignoreLLM)try{await((a=i.handleLLMError)==null?void 0:a.call(i,t,this.runId,this._parentRunId,this.tags,s))}catch(o){if((i.raiseError?console.error:console.warn)(`Error in handler ${i.constructor.name}, handleLLMError: ${o}`),i.raiseError)throw o}},i.awaitHandlers)))}async handleLLMEnd(t,e,n,r,s){await Promise.all(this.handlers.map(i=>Rt(async()=>{var a;if(!i.ignoreLLM)try{await((a=i.handleLLMEnd)==null?void 0:a.call(i,t,this.runId,this._parentRunId,this.tags,s))}catch(o){if((i.raiseError?console.error:console.warn)(`Error in handler ${i.constructor.name}, handleLLMEnd: ${o}`),i.raiseError)throw o}},i.awaitHandlers)))}},sb=class extends rc{getChild(t){const e=new wn(this.runId);return e.setHandlers(this.inheritableHandlers),e.addTags(this.inheritableTags),e.addMetadata(this.inheritableMetadata),t&&e.addTags([t],!1),e}async handleChainError(t,e,n,r,s){await Promise.all(this.handlers.map(i=>Rt(async()=>{var a;if(!i.ignoreChain)try{await((a=i.handleChainError)==null?void 0:a.call(i,t,this.runId,this._parentRunId,this.tags,s))}catch(o){if((i.raiseError?console.error:console.warn)(`Error in handler ${i.constructor.name}, handleChainError: ${o}`),i.raiseError)throw o}},i.awaitHandlers)))}async handleChainEnd(t,e,n,r,s){await Promise.all(this.handlers.map(i=>Rt(async()=>{var a;if(!i.ignoreChain)try{await((a=i.handleChainEnd)==null?void 0:a.call(i,t,this.runId,this._parentRunId,this.tags,s))}catch(o){if((i.raiseError?console.error:console.warn)(`Error in handler ${i.constructor.name}, handleChainEnd: ${o}`),i.raiseError)throw o}},i.awaitHandlers)))}async handleAgentAction(t){await Promise.all(this.handlers.map(e=>Rt(async()=>{var n;if(!e.ignoreAgent)try{await((n=e.handleAgentAction)==null?void 0:n.call(e,t,this.runId,this._parentRunId,this.tags))}catch(r){if((e.raiseError?console.error:console.warn)(`Error in handler ${e.constructor.name}, handleAgentAction: ${r}`),e.raiseError)throw r}},e.awaitHandlers)))}async handleAgentEnd(t){await Promise.all(this.handlers.map(e=>Rt(async()=>{var n;if(!e.ignoreAgent)try{await((n=e.handleAgentEnd)==null?void 0:n.call(e,t,this.runId,this._parentRunId,this.tags))}catch(r){if((e.raiseError?console.error:console.warn)(`Error in handler ${e.constructor.name}, handleAgentEnd: ${r}`),e.raiseError)throw r}},e.awaitHandlers)))}},ib=class extends rc{getChild(t){const e=new wn(this.runId);return e.setHandlers(this.inheritableHandlers),e.addTags(this.inheritableTags),e.addMetadata(this.inheritableMetadata),t&&e.addTags([t],!1),e}async handleToolError(t){await Promise.all(this.handlers.map(e=>Rt(async()=>{var n;if(!e.ignoreAgent)try{await((n=e.handleToolError)==null?void 0:n.call(e,t,this.runId,this._parentRunId,this.tags))}catch(r){if((e.raiseError?console.error:console.warn)(`Error in handler ${e.constructor.name}, handleToolError: ${r}`),e.raiseError)throw r}},e.awaitHandlers)))}async handleToolEnd(t){await Promise.all(this.handlers.map(e=>Rt(async()=>{var n;if(!e.ignoreAgent)try{await((n=e.handleToolEnd)==null?void 0:n.call(e,t,this.runId,this._parentRunId,this.tags))}catch(r){if((e.raiseError?console.error:console.warn)(`Error in handler ${e.constructor.name}, handleToolEnd: ${r}`),e.raiseError)throw r}},e.awaitHandlers)))}},wn=class Ba extends nb{constructor(n,r){super();p(this,"handlers",[]);p(this,"inheritableHandlers",[]);p(this,"tags",[]);p(this,"inheritableTags",[]);p(this,"metadata",{});p(this,"inheritableMetadata",{});p(this,"name","callback_manager");p(this,"_parentRunId");this.handlers=(r==null?void 0:r.handlers)??this.handlers,this.inheritableHandlers=(r==null?void 0:r.inheritableHandlers)??this.inheritableHandlers,this.tags=(r==null?void 0:r.tags)??this.tags,this.inheritableTags=(r==null?void 0:r.inheritableTags)??this.inheritableTags,this.metadata=(r==null?void 0:r.metadata)??this.metadata,this.inheritableMetadata=(r==null?void 0:r.inheritableMetadata)??this.inheritableMetadata,this._parentRunId=n}getParentRunId(){return this._parentRunId}async handleLLMStart(n,r,s=void 0,i=void 0,a=void 0,o=void 0,c=void 0,l=void 0){return Promise.all(r.map(async(u,d)=>{const h=d===0&&s?s:Cs();return await Promise.all(this.handlers.map(f=>{if(!f.ignoreLLM)return Hi(f)&&f._createRunForLLMStart(n,[u],h,this._parentRunId,a,this.tags,this.metadata,l),Rt(async()=>{var m;try{await((m=f.handleLLMStart)==null?void 0:m.call(f,n,[u],h,this._parentRunId,a,this.tags,this.metadata,l))}catch(g){if((f.raiseError?console.error:console.warn)(`Error in handler ${f.constructor.name}, handleLLMStart: ${g}`),f.raiseError)throw g}},f.awaitHandlers)})),new Wh(h,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChatModelStart(n,r,s=void 0,i=void 0,a=void 0,o=void 0,c=void 0,l=void 0){return Promise.all(r.map(async(u,d)=>{const h=d===0&&s?s:Cs();return await Promise.all(this.handlers.map(f=>{if(!f.ignoreLLM)return Hi(f)&&f._createRunForChatModelStart(n,[u],h,this._parentRunId,a,this.tags,this.metadata,l),Rt(async()=>{var m,g;try{if(f.handleChatModelStart)await((m=f.handleChatModelStart)==null?void 0:m.call(f,n,[u],h,this._parentRunId,a,this.tags,this.metadata,l));else if(f.handleLLMStart){const w=Pp(u);await((g=f.handleLLMStart)==null?void 0:g.call(f,n,[w],h,this._parentRunId,a,this.tags,this.metadata,l))}}catch(w){if((f.raiseError?console.error:console.warn)(`Error in handler ${f.constructor.name}, handleLLMStart: ${w}`),f.raiseError)throw w}},f.awaitHandlers)})),new Wh(h,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChainStart(n,r,s=Cs(),i=void 0,a=void 0,o=void 0,c=void 0,l=void 0,u=void 0){return await Promise.all(this.handlers.map(d=>{if(!d.ignoreChain)return Hi(d)&&d._createRunForChainStart(n,r,s,this._parentRunId,this.tags,this.metadata,i,c,u),Rt(async()=>{var h;try{await((h=d.handleChainStart)==null?void 0:h.call(d,n,r,s,this._parentRunId,this.tags,this.metadata,i,c,u))}catch(f){if((d.raiseError?console.error:console.warn)(`Error in handler ${d.constructor.name}, handleChainStart: ${f}`),d.raiseError)throw f}},d.awaitHandlers)})),new sb(s,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleToolStart(n,r,s=Cs(),i=void 0,a=void 0,o=void 0,c=void 0){return await Promise.all(this.handlers.map(l=>{if(!l.ignoreAgent)return Hi(l)&&l._createRunForToolStart(n,r,s,this._parentRunId,this.tags,this.metadata,c),Rt(async()=>{var u;try{await((u=l.handleToolStart)==null?void 0:u.call(l,n,r,s,this._parentRunId,this.tags,this.metadata,c))}catch(d){if((l.raiseError?console.error:console.warn)(`Error in handler ${l.constructor.name}, handleToolStart: ${d}`),l.raiseError)throw d}},l.awaitHandlers)})),new ib(s,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleRetrieverStart(n,r,s=Cs(),i=void 0,a=void 0,o=void 0,c=void 0){return await Promise.all(this.handlers.map(l=>{if(!l.ignoreRetriever)return Hi(l)&&l._createRunForRetrieverStart(n,r,s,this._parentRunId,this.tags,this.metadata,c),Rt(async()=>{var u;try{await((u=l.handleRetrieverStart)==null?void 0:u.call(l,n,r,s,this._parentRunId,this.tags,this.metadata,c))}catch(d){if((l.raiseError?console.error:console.warn)(`Error in handler ${l.constructor.name}, handleRetrieverStart: ${d}`),l.raiseError)throw d}},l.awaitHandlers)})),new rb(s,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleCustomEvent(n,r,s,i,a){await Promise.all(this.handlers.map(o=>Rt(async()=>{var c;if(!o.ignoreCustomEvent)try{await((c=o.handleCustomEvent)==null?void 0:c.call(o,n,r,s,this.tags,this.metadata))}catch(l){if((o.raiseError?console.error:console.warn)(`Error in handler ${o.constructor.name}, handleCustomEvent: ${l}`),o.raiseError)throw l}},o.awaitHandlers)))}addHandler(n,r=!0){this.handlers.push(n),r&&this.inheritableHandlers.push(n)}removeHandler(n){this.handlers=this.handlers.filter(r=>r!==n),this.inheritableHandlers=this.inheritableHandlers.filter(r=>r!==n)}setHandlers(n,r=!0){this.handlers=[],this.inheritableHandlers=[];for(const s of n)this.addHandler(s,r)}addTags(n,r=!0){this.removeTags(n),this.tags.push(...n),r&&this.inheritableTags.push(...n)}removeTags(n){this.tags=this.tags.filter(r=>!n.includes(r)),this.inheritableTags=this.inheritableTags.filter(r=>!n.includes(r))}addMetadata(n,r=!0){this.metadata={...this.metadata,...n},r&&(this.inheritableMetadata={...this.inheritableMetadata,...n})}removeMetadata(n){for(const r of Object.keys(n))delete this.metadata[r],delete this.inheritableMetadata[r]}copy(n=[],r=!0){const s=new Ba(this._parentRunId);for(const i of this.handlers){const a=this.inheritableHandlers.includes(i);s.addHandler(i,a)}for(const i of this.tags){const a=this.inheritableTags.includes(i);s.addTags([i],a)}for(const i of Object.keys(this.metadata)){const a=Object.keys(this.inheritableMetadata).includes(i);s.addMetadata({[i]:this.metadata[i]},a)}for(const i of n)s.handlers.filter(a=>a.name==="console_callback_handler").some(a=>a.name===i.name)||s.addHandler(i,r);return s}static fromHandlers(n){class r extends $a{constructor(){super();p(this,"name",Cs());Object.assign(this,n)}}const s=new this;return s.addHandler(new r),s}static configure(n,r,s,i,a,o,c){return this._configureSync(n,r,s,i,a,o,c)}static _configureSync(n,r,s,i,a,o,c){var f;let l;(n||r)&&(Array.isArray(n)||!n?(l=new Ba,l.setHandlers((n==null?void 0:n.map(To))??[],!0)):l=n,l=l.copy(Array.isArray(r)?r.map(To):r==null?void 0:r.handlers,!1));const u=Sr("LANGCHAIN_VERBOSE")==="true"||(c==null?void 0:c.verbose),d=((f=il.getTraceableRunTree())==null?void 0:f.tracingEnabled)||x1(),h=d||(Sr("LANGCHAIN_TRACING")??!1);if(u||h){if(l||(l=new Ba),u&&!l.handlers.some(m=>m.name===Gh.prototype.name)){const m=new Gh;l.addHandler(m,!0)}if(h&&!l.handlers.some(m=>m.name==="langchain_tracer")&&d){const m=new il;l.addHandler(m,!0)}if(d){const m=il.getTraceableRunTree();if(m&&l._parentRunId===void 0){l._parentRunId=m.id;const g=l.handlers.find(w=>w.name==="langchain_tracer");g==null||g.updateFromRunTree(m)}}}for(const{contextVar:m,inheritable:g=!0,handlerClass:w,envVar:b}of I1()){const y=b&&Sr(b)==="true"&&w;let v;const T=m!==void 0?eb(m):void 0;T&&Ev(T)?v=T:y&&(v=new w({})),v!==void 0&&(l||(l=new Ba),l.handlers.some(A=>A.name===v.name)||l.addHandler(v,g))}return(s||i)&&l&&(l.addTags(s??[]),l.addTags(i??[],!1)),(a||o)&&l&&(l.addMetadata(a??{}),l.addMetadata(o??{},!1)),l}};function To(t){return"name"in t?t:$a.fromMethods(t)}var ab=class{getStore(){}run(t,e){return e()}enterWith(t){}};const A1=new ab,yy=Symbol.for("lc:child_config");var C1=class{getInstance(){return Eo()??A1}getRunnableConfig(){var e,n;return(n=(e=this.getInstance().getStore())==null?void 0:e.extra)==null?void 0:n[yy]}runWithConfig(t,e,n){var l;const r=wn._configureSync(t==null?void 0:t.callbacks,void 0,t==null?void 0:t.tags,void 0,t==null?void 0:t.metadata),s=this.getInstance(),i=s.getStore(),a=r==null?void 0:r.getParentRunId(),o=(l=r==null?void 0:r.handlers)==null?void 0:l.find(u=>(u==null?void 0:u.name)==="langchain_tracer");let c;return o&&a?c=o.getRunTreeWithTracingConfig(a):n||(c=new Sn({name:"<runnable_lambda>",tracingEnabled:!1})),c&&(c.extra={...c.extra,[yy]:t}),i!==void 0&&i[io]!==void 0&&(c===void 0&&(c={}),c[io]=i[io]),s.run(c,e)}initializeGlobalInstance(t){Eo()===void 0&&mA(t)}};const Ft=new C1;var ob={};Se(ob,{AsyncLocalStorageProviderSingleton:()=>Ft,MockAsyncLocalStorage:()=>ab,_CONTEXT_VARIABLES_KEY:()=>io});const Wd=25;async function On(t){return wn._configureSync(t==null?void 0:t.callbacks,void 0,t==null?void 0:t.tags,void 0,t==null?void 0:t.metadata)}function Zn(...t){const e={};for(const n of t.filter(r=>!!r))for(const r of Object.keys(n))if(r==="metadata")e[r]={...e[r],...n[r]};else if(r==="tags"){const s=e[r]??[];e[r]=[...new Set(s.concat(n[r]??[]))]}else if(r==="configurable")e[r]={...e[r],...n[r]};else if(r==="timeout")e.timeout===void 0?e.timeout=n.timeout:n.timeout!==void 0&&(e.timeout=Math.min(e.timeout,n.timeout));else if(r==="signal")e.signal===void 0?e.signal=n.signal:n.signal!==void 0&&("any"in AbortSignal?e.signal=AbortSignal.any([e.signal,n.signal]):e.signal=n.signal);else if(r==="callbacks"){const s=e.callbacks,i=n.callbacks;if(Array.isArray(i))if(!s)e.callbacks=i;else if(Array.isArray(s))e.callbacks=s.concat(i);else{const a=s.copy();for(const o of i)a.addHandler(To(o),!0);e.callbacks=a}else if(i)if(!s)e.callbacks=i;else if(Array.isArray(s)){const a=i.copy();for(const o of s)a.addHandler(To(o),!0);e.callbacks=a}else e.callbacks=new wn(i._parentRunId,{handlers:s.handlers.concat(i.handlers),inheritableHandlers:s.inheritableHandlers.concat(i.inheritableHandlers),tags:Array.from(new Set(s.tags.concat(i.tags))),inheritableTags:Array.from(new Set(s.inheritableTags.concat(i.inheritableTags))),metadata:{...s.metadata,...i.metadata}})}else{const s=r;e[s]=n[s]??e[s]}return e}const O1=new Set(["string","number","boolean"]);function Ze(t){var r;const e=Ft.getRunnableConfig();let n={tags:[],metadata:{},recursionLimit:25,runId:void 0};if(e){const{runId:s,runName:i,...a}=e;n=Object.entries(a).reduce((o,[c,l])=>(l!==void 0&&(o[c]=l),o),n)}if(t&&(n=Object.entries(t).reduce((s,[i,a])=>(a!==void 0&&(s[i]=a),s),n)),n!=null&&n.configurable)for(const s of Object.keys(n.configurable))O1.has(typeof n.configurable[s])&&!((r=n.metadata)!=null&&r[s])&&(n.metadata||(n.metadata={}),n.metadata[s]=n.configurable[s]);if(n.timeout!==void 0){if(n.timeout<=0)throw new Error("Timeout must be a positive number");const s=n.timeout,i=AbortSignal.timeout(s);n.metadata||(n.metadata={}),n.metadata.timeoutMs===void 0&&(n.metadata.timeoutMs=s),n.signal!==void 0?"any"in AbortSignal&&(n.signal=AbortSignal.any([n.signal,i])):n.signal=i,delete n.timeout}return n}function Xe(t={},{callbacks:e,maxConcurrency:n,recursionLimit:r,runName:s,configurable:i,runId:a}={}){const o=Ze(t);return e!==void 0&&(delete o.runName,o.callbacks=e),r!==void 0&&(o.recursionLimit=r),n!==void 0&&(o.maxConcurrency=n),s!==void 0&&(o.runName=s),i!==void 0&&(o.configurable={...o.configurable,...i}),a!==void 0&&delete o.runId,o}function ps(t){if(t)return{configurable:t.configurable,recursionLimit:t.recursionLimit,callbacks:t.callbacks,tags:t.tags,metadata:t.metadata,maxConcurrency:t.maxConcurrency,timeout:t.timeout,signal:t.signal,store:t.store}}async function Hr(t,e){if(e===void 0)return t;let n;return Promise.race([t.catch(r=>{if(!(e!=null&&e.aborted))throw r}),new Promise((r,s)=>{n=()=>{s(So(e))},e.addEventListener("abort",n),e.aborted&&s(So(e))})]).finally(()=>e.removeEventListener("abort",n))}function So(t){return(t==null?void 0:t.reason)instanceof Error?t.reason:typeof(t==null?void 0:t.reason)=="string"?new Error(t.reason):new Error("Aborted")}var cb={};Se(cb,{AsyncGeneratorWithSetup:()=>Ys,IterableReadableStream:()=>hn,atee:()=>Hp,concat:()=>Hs,pipeGeneratorWithSetup:()=>lb});var hn=class Hh extends ReadableStream{constructor(){super(...arguments);p(this,"reader")}ensureReader(){this.reader||(this.reader=this.getReader())}async next(){this.ensureReader();try{const n=await this.reader.read();return n.done?(this.reader.releaseLock(),{done:!0,value:void 0}):{done:!1,value:n.value}}catch(n){throw this.reader.releaseLock(),n}}async return(){if(this.ensureReader(),this.locked){const n=this.reader.cancel();this.reader.releaseLock(),await n}return{done:!0,value:void 0}}async throw(n){if(this.ensureReader(),this.locked){const r=this.reader.cancel();this.reader.releaseLock(),await r}throw n}[Symbol.asyncIterator](){return this}async[Symbol.asyncDispose](){await this.return()}static fromReadableStream(n){const r=n.getReader();return new Hh({start(s){return i();function i(){return r.read().then(({done:a,value:o})=>{if(a){s.close();return}return s.enqueue(o),i()})}},cancel(){r.releaseLock()}})}static fromAsyncGenerator(n){return new Hh({async pull(r){const{value:s,done:i}=await n.next();i&&r.close(),r.enqueue(s)},async cancel(r){await n.return(r)}})}};function Hp(t,e=2){const n=Array.from({length:e},()=>[]);return n.map(async function*(s){for(;;)if(s.length===0){const i=await t.next();for(const a of n)a.push(i)}else{if(s[0].done)return;yield s.shift().value}})}function Hs(t,e){if(Array.isArray(t)&&Array.isArray(e))return t.concat(e);if(typeof t=="string"&&typeof e=="string")return t+e;if(typeof t=="number"&&typeof e=="number")return t+e;if("concat"in t&&typeof t.concat=="function")return t.concat(e);if(typeof t=="object"&&typeof e=="object"){const n={...t};for(const[r,s]of Object.entries(e))r in n&&!Array.isArray(n[r])?n[r]=Hs(n[r],s):n[r]=s;return n}else throw new Error(`Cannot concat ${typeof t} and ${typeof e}`)}var Ys=class{constructor(t){p(this,"generator");p(this,"setup");p(this,"config");p(this,"signal");p(this,"firstResult");p(this,"firstResultUsed",!1);var e;this.generator=t.generator,this.config=t.config,this.signal=t.signal??((e=this.config)==null?void 0:e.signal),this.setup=new Promise((n,r)=>{Ft.runWithConfig(ps(t.config),async()=>{this.firstResult=t.generator.next(),t.startSetup?this.firstResult.then(t.startSetup).then(n,r):this.firstResult.then(s=>n(void 0),r)},!0)})}async next(...t){var e;return(e=this.signal)==null||e.throwIfAborted(),this.firstResultUsed?Ft.runWithConfig(ps(this.config),this.signal?async()=>Hr(this.generator.next(...t),this.signal):async()=>this.generator.next(...t),!0):(this.firstResultUsed=!0,this.firstResult)}async return(t){return this.generator.return(t)}async throw(t){return this.generator.throw(t)}[Symbol.asyncIterator](){return this}async[Symbol.asyncDispose](){await this.return()}};async function lb(t,e,n,r,...s){const i=new Ys({generator:e,startSetup:n,signal:r}),a=await i.setup;return{output:t(i,a,...s),setup:a}}/*!
* https://github.com/Starcounter-Jack/JSON-Patch
* (c) 2017-2022 Joachim Wester
* MIT licensed
*/const $1=Object.prototype.hasOwnProperty;function qh(t,e){return $1.call(t,e)}function Jh(t){if(Array.isArray(t)){const n=new Array(t.length);for(let r=0;r<n.length;r++)n[r]=""+r;return n}if(Object.keys)return Object.keys(t);let e=[];for(let n in t)qh(t,n)&&e.push(n);return e}function Er(t){switch(typeof t){case"object":return JSON.parse(JSON.stringify(t));case"undefined":return null;default:return t}}function Kh(t){let e=0;const n=t.length;let r;for(;e<n;){if(r=t.charCodeAt(e),r>=48&&r<=57){e++;continue}return!1}return!0}function Ui(t){return t.indexOf("/")===-1&&t.indexOf("~")===-1?t:t.replace(/~/g,"~0").replace(/\//g,"~1")}function R1(t){return t.replace(/~1/g,"/").replace(/~0/g,"~")}function Xh(t){if(t===void 0)return!0;if(t){if(Array.isArray(t)){for(let n=0,r=t.length;n<r;n++)if(Xh(t[n]))return!0}else if(typeof t=="object"){const n=Jh(t),r=n.length;for(var e=0;e<r;e++)if(Xh(t[n[e]]))return!0}}return!1}function _y(t,e){const n=[t];for(const r in e){const s=typeof e[r]=="object"?JSON.stringify(e[r],null,2):e[r];typeof s<"u"&&n.push(`${r}: ${s}`)}return n.join(`
`)}var N1=class extends Error{constructor(t,e,n,r,s){super(_y(t,{name:e,index:n,operation:r,tree:s})),this.name=e,this.index=n,this.operation=r,this.tree=s,Object.setPrototypeOf(this,new.target.prototype),this.message=_y(t,{name:e,index:n,operation:r,tree:s})}},ub={};Se(ub,{JsonPatchError:()=>vt,_areEquals:()=>xo,applyOperation:()=>bi,applyPatch:()=>ma,applyReducer:()=>L1,deepClone:()=>P1,getValueByPointer:()=>Bl,validate:()=>db,validator:()=>zl});const vt=N1,P1=Er;function Hd(t){return Object.getOwnPropertyNames(Object.prototype).includes(t)}const Qi={add:function(t,e,n){if(Hd(e))throw new TypeError("JSON-Patch: modifying `__proto__`, `constructor`, or `prototype` prop is banned for security reasons");return t[e]=this.value,{newDocument:n}},remove:function(t,e,n){if(Hd(e))throw new TypeError("JSON-Patch: modifying `__proto__`, `constructor`, or `prototype` prop is banned for security reasons");var r=t[e];return delete t[e],{newDocument:n,removed:r}},replace:function(t,e,n){if(Hd(e))throw new TypeError("JSON-Patch: modifying `__proto__`, `constructor`, or `prototype` prop is banned for security reasons");var r=t[e];return t[e]=this.value,{newDocument:n,removed:r}},move:function(t,e,n){let r=Bl(n,this.path);r&&(r=Er(r));const s=bi(n,{op:"remove",path:this.from}).removed;return bi(n,{op:"add",path:this.path,value:s}),{newDocument:n,removed:r}},copy:function(t,e,n){const r=Bl(n,this.from);return bi(n,{op:"add",path:this.path,value:Er(r)}),{newDocument:n}},test:function(t,e,n){return{newDocument:n,test:xo(t[e],this.value)}},_get:function(t,e,n){return this.value=t[e],{newDocument:n}}};var M1={add:function(t,e,n){return Kh(e)?t.splice(e,0,this.value):t[e]=this.value,{newDocument:n,index:e}},remove:function(t,e,n){var r=t.splice(e,1);return{newDocument:n,removed:r[0]}},replace:function(t,e,n){var r=t[e];return t[e]=this.value,{newDocument:n,removed:r}},move:Qi.move,copy:Qi.copy,test:Qi.test,_get:Qi._get};function Bl(t,e){if(e=="")return t;var n={op:"_get",path:e};return bi(t,n),n.value}function bi(t,e,n=!1,r=!0,s=!0,i=0){if(n&&(typeof n=="function"?n(e,0,t,e.path):zl(e,0)),e.path===""){let a={newDocument:t};if(e.op==="add")return a.newDocument=e.value,a;if(e.op==="replace")return a.newDocument=e.value,a.removed=t,a;if(e.op==="move"||e.op==="copy")return a.newDocument=Bl(t,e.from),e.op==="move"&&(a.removed=t),a;if(e.op==="test"){if(a.test=xo(t,e.value),a.test===!1)throw new vt("Test operation failed","TEST_OPERATION_FAILED",i,e,t);return a.newDocument=t,a}else{if(e.op==="remove")return a.removed=t,a.newDocument=null,a;if(e.op==="_get")return e.value=t,a;if(n)throw new vt("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",i,e,t);return a}}else{r||(t=Er(t));const o=(e.path||"").split("/");let c=t,l=1,u=o.length,d,h,f;for(typeof n=="function"?f=n:f=zl;;){if(h=o[l],h&&h.indexOf("~")!=-1&&(h=R1(h)),s&&(h=="__proto__"||h=="prototype"&&l>0&&o[l-1]=="constructor"))throw new TypeError("JSON-Patch: modifying `__proto__` or `constructor/prototype` prop is banned for security reasons, if this was on purpose, please set `banPrototypeModifications` flag false and pass it to this function. More info in fast-json-patch README");if(n&&d===void 0&&(c[h]===void 0?d=o.slice(0,l).join("/"):l==u-1&&(d=e.path),d!==void 0&&f(e,0,t,d)),l++,Array.isArray(c)){if(h==="-")h=c.length;else{if(n&&!Kh(h))throw new vt("Expected an unsigned base-10 integer value, making the new referenced value the array element with the zero-based index","OPERATION_PATH_ILLEGAL_ARRAY_INDEX",i,e,t);Kh(h)&&(h=~~h)}if(l>=u){if(n&&e.op==="add"&&h>c.length)throw new vt("The specified index MUST NOT be greater than the number of elements in the array","OPERATION_VALUE_OUT_OF_BOUNDS",i,e,t);const m=M1[e.op].call(e,c,h,t);if(m.test===!1)throw new vt("Test operation failed","TEST_OPERATION_FAILED",i,e,t);return m}}else if(l>=u){const m=Qi[e.op].call(e,c,h,t);if(m.test===!1)throw new vt("Test operation failed","TEST_OPERATION_FAILED",i,e,t);return m}if(c=c[h],n&&l<u&&(!c||typeof c!="object"))throw new vt("Cannot perform operation at the desired path","OPERATION_PATH_UNRESOLVABLE",i,e,t)}}}function ma(t,e,n,r=!0,s=!0){if(n&&!Array.isArray(e))throw new vt("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");r||(t=Er(t));const i=new Array(e.length);for(let a=0,o=e.length;a<o;a++)i[a]=bi(t,e[a],n,!0,s,a),t=i[a].newDocument;return i.newDocument=t,i}function L1(t,e,n){const r=bi(t,e);if(r.test===!1)throw new vt("Test operation failed","TEST_OPERATION_FAILED",n,e,t);return r.newDocument}function zl(t,e,n,r){if(typeof t!="object"||t===null||Array.isArray(t))throw new vt("Operation is not an object","OPERATION_NOT_AN_OBJECT",e,t,n);if(Qi[t.op]){if(typeof t.path!="string")throw new vt("Operation `path` property is not a string","OPERATION_PATH_INVALID",e,t,n);if(t.path.indexOf("/")!==0&&t.path.length>0)throw new vt('Operation `path` property must start with "/"',"OPERATION_PATH_INVALID",e,t,n);if((t.op==="move"||t.op==="copy")&&typeof t.from!="string")throw new vt("Operation `from` property is not present (applicable in `move` and `copy` operations)","OPERATION_FROM_REQUIRED",e,t,n);if((t.op==="add"||t.op==="replace"||t.op==="test")&&t.value===void 0)throw new vt("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_REQUIRED",e,t,n);if((t.op==="add"||t.op==="replace"||t.op==="test")&&Xh(t.value))throw new vt("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_CANNOT_CONTAIN_UNDEFINED",e,t,n);if(n){if(t.op=="add"){var s=t.path.split("/").length,i=r.split("/").length;if(s!==i+1&&s!==i)throw new vt("Cannot perform an `add` operation at the desired path","OPERATION_PATH_CANNOT_ADD",e,t,n)}else if(t.op==="replace"||t.op==="remove"||t.op==="_get"){if(t.path!==r)throw new vt("Cannot perform the operation at a path that does not exist","OPERATION_PATH_UNRESOLVABLE",e,t,n)}else if(t.op==="move"||t.op==="copy"){var a={op:"_get",path:t.from,value:void 0},o=db([a],n);if(o&&o.name==="OPERATION_PATH_UNRESOLVABLE")throw new vt("Cannot perform the operation from a path that does not exist","OPERATION_FROM_UNRESOLVABLE",e,t,n)}}}else throw new vt("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",e,t,n)}function db(t,e,n){try{if(!Array.isArray(t))throw new vt("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");if(e)ma(Er(e),Er(t),n||!0);else{n=n||zl;for(var r=0;r<t.length;r++)n(t[r],r,e,void 0)}}catch(s){if(s instanceof vt)return s;throw s}}function xo(t,e){if(t===e)return!0;if(t&&e&&typeof t=="object"&&typeof e=="object"){var n=Array.isArray(t),r=Array.isArray(e),s,i,a;if(n&&r){if(i=t.length,i!=e.length)return!1;for(s=i;s--!==0;)if(!xo(t[s],e[s]))return!1;return!0}if(n!=r)return!1;var o=Object.keys(t);if(i=o.length,i!==Object.keys(e).length)return!1;for(s=i;s--!==0;)if(!e.hasOwnProperty(o[s]))return!1;for(s=i;s--!==0;)if(a=o[s],!xo(t[a],e[a]))return!1;return!0}return t!==t&&e!==e}function hb(t,e,n,r,s){if(e!==t){typeof e.toJSON=="function"&&(e=e.toJSON());for(var i=Jh(e),a=Jh(t),o=!1,c=a.length-1;c>=0;c--){var l=a[c],u=t[l];if(qh(e,l)&&!(e[l]===void 0&&u!==void 0&&Array.isArray(e)===!1)){var d=e[l];typeof u=="object"&&u!=null&&typeof d=="object"&&d!=null&&Array.isArray(u)===Array.isArray(d)?hb(u,d,n,r+"/"+Ui(l),s):u!==d&&(s&&n.push({op:"test",path:r+"/"+Ui(l),value:Er(u)}),n.push({op:"replace",path:r+"/"+Ui(l),value:Er(d)}))}else Array.isArray(t)===Array.isArray(e)?(s&&n.push({op:"test",path:r+"/"+Ui(l),value:Er(u)}),n.push({op:"remove",path:r+"/"+Ui(l)}),o=!0):(s&&n.push({op:"test",path:r,value:t}),n.push({op:"replace",path:r,value:e}))}if(!(!o&&i.length==a.length))for(var c=0;c<i.length;c++){var l=i[c];!qh(t,l)&&e[l]!==void 0&&n.push({op:"add",path:r+"/"+Ui(l),value:Er(e[l])})}}}function Du(t,e,n=!1){var r=[];return hb(t,e,r,"",n),r}({...ub});var fb={};Se(fb,{LogStreamCallbackHandler:()=>Qh,RunLog:()=>qp,RunLogPatch:()=>ts,isLogStreamHandler:()=>pb});var ts=class{constructor(t){p(this,"ops");this.ops=t.ops??[]}concat(t){const e=this.ops.concat(t.ops),n=ma({},e);return new qp({ops:e,state:n[n.length-1].newDocument})}},qp=class Yh extends ts{constructor(n){super(n);p(this,"state");this.state=n.state}concat(n){const r=this.ops.concat(n.ops),s=ma(this.state,n.ops);return new Yh({ops:r,state:s[s.length-1].newDocument})}static fromRunLogPatch(n){const r=ma({},n.ops);return new Yh({ops:n.ops,state:r[r.length-1].newDocument})}};const pb=t=>t.name==="log_stream_tracer";async function wy(t,e){if(e==="original")throw new Error("Do not assign inputs with original schema drop the key for now. When inputs are added to streamLog they should be added with standardized schema for streaming events.");const{inputs:n}=t;if(["retriever","llm","prompt"].includes(t.run_type))return n;if(!(Object.keys(n).length===1&&(n==null?void 0:n.input)===""))return n.input}async function vy(t,e){const{outputs:n}=t;return e==="original"||["retriever","llm","prompt"].includes(t.run_type)?n:n!==void 0&&Object.keys(n).length===1&&(n==null?void 0:n.output)!==void 0?n.output:n}function j1(t){return t!==void 0&&t.message!==void 0}var Qh=class extends Es{constructor(e){super({_awaitHandler:!0,...e});p(this,"autoClose",!0);p(this,"includeNames");p(this,"includeTypes");p(this,"includeTags");p(this,"excludeNames");p(this,"excludeTypes");p(this,"excludeTags");p(this,"_schemaFormat","original");p(this,"rootId");p(this,"keyMapByRunId",{});p(this,"counterMapByRunName",{});p(this,"transformStream");p(this,"writer");p(this,"receiveStream");p(this,"name","log_stream_tracer");p(this,"lc_prefer_streaming",!0);this.autoClose=(e==null?void 0:e.autoClose)??!0,this.includeNames=e==null?void 0:e.includeNames,this.includeTypes=e==null?void 0:e.includeTypes,this.includeTags=e==null?void 0:e.includeTags,this.excludeNames=e==null?void 0:e.excludeNames,this.excludeTypes=e==null?void 0:e.excludeTypes,this.excludeTags=e==null?void 0:e.excludeTags,this._schemaFormat=(e==null?void 0:e._schemaFormat)??this._schemaFormat,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=hn.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){if(e.id===this.rootId)return!1;const n=e.tags??[];let r=this.includeNames===void 0&&this.includeTags===void 0&&this.includeTypes===void 0;return this.includeNames!==void 0&&(r=r||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(r=r||this.includeTypes.includes(e.run_type)),this.includeTags!==void 0&&(r=r||n.find(s=>{var i;return(i=this.includeTags)==null?void 0:i.includes(s)})!==void 0),this.excludeNames!==void 0&&(r=r&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(r=r&&!this.excludeTypes.includes(e.run_type)),this.excludeTags!==void 0&&(r=r&&n.every(s=>{var i;return!((i=this.excludeTags)!=null&&i.includes(s))})),r}async*tapOutputIterable(e,n){for await(const r of n){if(e!==this.rootId){const s=this.keyMapByRunId[e];s&&await this.writer.write(new ts({ops:[{op:"add",path:`/logs/${s}/streamed_output/-`,value:r}]}))}yield r}}async onRunCreate(e){var s;if(this.rootId===void 0&&(this.rootId=e.id,await this.writer.write(new ts({ops:[{op:"replace",path:"",value:{id:e.id,name:e.name,type:e.run_type,streamed_output:[],final_output:void 0,logs:{}}}]}))),!this._includeRun(e))return;this.counterMapByRunName[e.name]===void 0&&(this.counterMapByRunName[e.name]=0),this.counterMapByRunName[e.name]+=1;const n=this.counterMapByRunName[e.name];this.keyMapByRunId[e.id]=n===1?e.name:`${e.name}:${n}`;const r={id:e.id,name:e.name,type:e.run_type,tags:e.tags??[],metadata:((s=e.extra)==null?void 0:s.metadata)??{},start_time:new Date(e.start_time).toISOString(),streamed_output:[],streamed_output_str:[],final_output:void 0,end_time:void 0};this._schemaFormat==="streaming_events"&&(r.inputs=await wy(e,this._schemaFormat)),await this.writer.write(new ts({ops:[{op:"add",path:`/logs/${this.keyMapByRunId[e.id]}`,value:r}]}))}async onRunUpdate(e){try{const n=this.keyMapByRunId[e.id];if(n===void 0)return;const r=[];this._schemaFormat==="streaming_events"&&r.push({op:"replace",path:`/logs/${n}/inputs`,value:await wy(e,this._schemaFormat)}),r.push({op:"add",path:`/logs/${n}/final_output`,value:await vy(e,this._schemaFormat)}),e.end_time!==void 0&&r.push({op:"add",path:`/logs/${n}/end_time`,value:new Date(e.end_time).toISOString()});const s=new ts({ops:r});await this.writer.write(s)}finally{if(e.id===this.rootId){const n=new ts({ops:[{op:"replace",path:"/final_output",value:await vy(e,this._schemaFormat)}]});await this.writer.write(n),this.autoClose&&await this.writer.close()}}}async onLLMNewToken(e,n,r){const s=this.keyMapByRunId[e.id];if(s===void 0)return;const i=e.inputs.messages!==void 0;let a;i?j1(r==null?void 0:r.chunk)?a=r==null?void 0:r.chunk:a=new dn({id:`run-${e.id}`,content:n}):a=n;const o=new ts({ops:[{op:"add",path:`/logs/${s}/streamed_output_str/-`,value:n},{op:"add",path:`/logs/${s}/streamed_output/-`,value:a}]});await this.writer.write(o)}},mb={};Se(mb,{ChatGenerationChunk:()=>ms,GenerationChunk:()=>ga,RUN_KEY:()=>ko});const ko="__run";var ga=class gb{constructor(e){p(this,"text");p(this,"generationInfo");this.text=e.text,this.generationInfo=e.generationInfo}concat(e){return new gb({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo}})}},ms=class yb extends ga{constructor(n){super(n);p(this,"message");this.message=n.message}concat(n){return new yb({text:this.text+n.text,generationInfo:{...this.generationInfo,...n.generationInfo},message:this.message.concat(n.message)})}};function Mc({name:t,serialized:e}){return t!==void 0?t:(e==null?void 0:e.name)!==void 0?e.name:(e==null?void 0:e.id)!==void 0&&Array.isArray(e==null?void 0:e.id)?e.id[e.id.length-1]:"Unnamed"}const D1=t=>t.name==="event_stream_tracer";var U1=class extends Es{constructor(e){super({_awaitHandler:!0,...e});p(this,"autoClose",!0);p(this,"includeNames");p(this,"includeTypes");p(this,"includeTags");p(this,"excludeNames");p(this,"excludeTypes");p(this,"excludeTags");p(this,"runInfoMap",new Map);p(this,"tappedPromises",new Map);p(this,"transformStream");p(this,"writer");p(this,"receiveStream");p(this,"readableStreamClosed",!1);p(this,"name","event_stream_tracer");p(this,"lc_prefer_streaming",!0);this.autoClose=(e==null?void 0:e.autoClose)??!0,this.includeNames=e==null?void 0:e.includeNames,this.includeTypes=e==null?void 0:e.includeTypes,this.includeTags=e==null?void 0:e.includeTags,this.excludeNames=e==null?void 0:e.excludeNames,this.excludeTypes=e==null?void 0:e.excludeTypes,this.excludeTags=e==null?void 0:e.excludeTags,this.transformStream=new TransformStream({flush:()=>{this.readableStreamClosed=!0}}),this.writer=this.transformStream.writable.getWriter(),this.receiveStream=hn.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){const n=e.tags??[];let r=this.includeNames===void 0&&this.includeTags===void 0&&this.includeTypes===void 0;return this.includeNames!==void 0&&(r=r||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(r=r||this.includeTypes.includes(e.runType)),this.includeTags!==void 0&&(r=r||n.find(s=>{var i;return(i=this.includeTags)==null?void 0:i.includes(s)})!==void 0),this.excludeNames!==void 0&&(r=r&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(r=r&&!this.excludeTypes.includes(e.runType)),this.excludeTags!==void 0&&(r=r&&n.every(s=>{var i;return!((i=this.excludeTags)!=null&&i.includes(s))})),r}async*tapOutputIterable(e,n){const r=await n.next();if(r.done)return;const s=this.runInfoMap.get(e);if(s===void 0){yield r.value;return}function i(o,c){return o==="llm"&&typeof c=="string"?new ga({text:c}):c}let a=this.tappedPromises.get(e);if(a===void 0){let o;a=new Promise(c=>{o=c}),this.tappedPromises.set(e,a);try{const c={event:`on_${s.runType}_stream`,run_id:e,name:s.name,tags:s.tags,metadata:s.metadata,data:{}};await this.send({...c,data:{chunk:i(s.runType,r.value)}},s),yield r.value;for await(const l of n)s.runType!=="tool"&&s.runType!=="retriever"&&await this.send({...c,data:{chunk:i(s.runType,l)}},s),yield l}finally{o==null||o()}}else{yield r.value;for await(const o of n)yield o}}async send(e,n){this.readableStreamClosed||this._includeRun(n)&&await this.writer.write(e)}async sendEndEvent(e,n){const r=this.tappedPromises.get(e.run_id);r!==void 0?r.then(()=>{this.send(e,n)}):await this.send(e,n)}async onLLMStart(e){var a,o;const n=Mc(e),r=e.inputs.messages!==void 0?"chat_model":"llm",s={tags:e.tags??[],metadata:((a=e.extra)==null?void 0:a.metadata)??{},name:n,runType:r,inputs:e.inputs};this.runInfoMap.set(e.id,s);const i=`on_${r}_start`;await this.send({event:i,data:{input:e.inputs},name:n,tags:e.tags??[],run_id:e.id,metadata:((o=e.extra)==null?void 0:o.metadata)??{}},s)}async onLLMNewToken(e,n,r){const s=this.runInfoMap.get(e.id);let i,a;if(s===void 0)throw new Error(`onLLMNewToken: Run ID ${e.id} not found in run map.`);if(this.runInfoMap.size!==1){if(s.runType==="chat_model")a="on_chat_model_stream",(r==null?void 0:r.chunk)===void 0?i=new dn({content:n,id:`run-${e.id}`}):i=r.chunk.message;else if(s.runType==="llm")a="on_llm_stream",(r==null?void 0:r.chunk)===void 0?i=new ga({text:n}):i=r.chunk;else throw new Error(`Unexpected run type ${s.runType}`);await this.send({event:a,data:{chunk:i},run_id:e.id,name:s.name,tags:s.tags,metadata:s.metadata},s)}}async onLLMEnd(e){var a,o,c;const n=this.runInfoMap.get(e.id);this.runInfoMap.delete(e.id);let r;if(n===void 0)throw new Error(`onLLMEnd: Run ID ${e.id} not found in run map.`);const s=(a=e.outputs)==null?void 0:a.generations;let i;if(n.runType==="chat_model"){for(const l of s??[]){if(i!==void 0)break;i=(o=l[0])==null?void 0:o.message}r="on_chat_model_end"}else if(n.runType==="llm")i={generations:s==null?void 0:s.map(l=>l.map(u=>({text:u.text,generationInfo:u.generationInfo}))),llmOutput:((c=e.outputs)==null?void 0:c.llmOutput)??{}},r="on_llm_end";else throw new Error(`onLLMEnd: Unexpected run type: ${n.runType}`);await this.sendEndEvent({event:r,data:{output:i,input:n.inputs},run_id:e.id,name:n.name,tags:n.tags,metadata:n.metadata},n)}async onChainStart(e){var a,o;const n=Mc(e),r=e.run_type??"chain",s={tags:e.tags??[],metadata:((a=e.extra)==null?void 0:a.metadata)??{},name:n,runType:e.run_type};let i={};e.inputs.input===""&&Object.keys(e.inputs).length===1?(i={},s.inputs={}):e.inputs.input!==void 0?(i.input=e.inputs.input,s.inputs=e.inputs.input):(i.input=e.inputs,s.inputs=e.inputs),this.runInfoMap.set(e.id,s),await this.send({event:`on_${r}_start`,data:i,name:n,tags:e.tags??[],run_id:e.id,metadata:((o=e.extra)==null?void 0:o.metadata)??{}},s)}async onChainEnd(e){var o;const n=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),n===void 0)throw new Error(`onChainEnd: Run ID ${e.id} not found in run map.`);const r=`on_${e.run_type}_end`,s=e.inputs??n.inputs??{},a={output:((o=e.outputs)==null?void 0:o.output)??e.outputs,input:s};s.input&&Object.keys(s).length===1&&(a.input=s.input,n.inputs=s.input),await this.sendEndEvent({event:r,data:a,run_id:e.id,name:n.name,tags:n.tags,metadata:n.metadata??{}},n)}async onToolStart(e){var s,i;const n=Mc(e),r={tags:e.tags??[],metadata:((s=e.extra)==null?void 0:s.metadata)??{},name:n,runType:"tool",inputs:e.inputs??{}};this.runInfoMap.set(e.id,r),await this.send({event:"on_tool_start",data:{input:e.inputs??{}},name:n,run_id:e.id,tags:e.tags??[],metadata:((i=e.extra)==null?void 0:i.metadata)??{}},r)}async onToolEnd(e){var s;const n=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),n===void 0)throw new Error(`onToolEnd: Run ID ${e.id} not found in run map.`);if(n.inputs===void 0)throw new Error(`onToolEnd: Run ID ${e.id} is a tool call, and is expected to have traced inputs.`);const r=((s=e.outputs)==null?void 0:s.output)===void 0?e.outputs:e.outputs.output;await this.sendEndEvent({event:"on_tool_end",data:{output:r,input:n.inputs},run_id:e.id,name:n.name,tags:n.tags,metadata:n.metadata},n)}async onRetrieverStart(e){var i,a;const n=Mc(e),s={tags:e.tags??[],metadata:((i=e.extra)==null?void 0:i.metadata)??{},name:n,runType:"retriever",inputs:{query:e.inputs.query}};this.runInfoMap.set(e.id,s),await this.send({event:"on_retriever_start",data:{input:{query:e.inputs.query}},name:n,tags:e.tags??[],run_id:e.id,metadata:((a=e.extra)==null?void 0:a.metadata)??{}},s)}async onRetrieverEnd(e){var r;const n=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),n===void 0)throw new Error(`onRetrieverEnd: Run ID ${e.id} not found in run map.`);await this.sendEndEvent({event:"on_retriever_end",data:{output:((r=e.outputs)==null?void 0:r.documents)??e.outputs,input:n.inputs},run_id:e.id,name:n.name,tags:n.tags,metadata:n.metadata},n)}async handleCustomEvent(e,n,r){const s=this.runInfoMap.get(r);if(s===void 0)throw new Error(`handleCustomEvent: Run ID ${r} not found in run map.`);await this.send({event:"on_custom_event",run_id:r,name:e,tags:s.tags,metadata:s.metadata,data:n},s)}async finish(){const e=[...this.tappedPromises.values()];Promise.all(e).finally(()=>{this.writer.close()})}};const F1=Object.prototype.toString,B1=t=>F1.call(t)==="[object Error]",z1=new Set(["network error","Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed","fetch failed","terminated"," A network error occurred.","Network connection lost"]);function Z1(t){if(!(t&&B1(t)&&t.name==="TypeError"&&typeof t.message=="string"))return!1;const{message:n,stack:r}=t;return n==="Load failed"?r===void 0||"__sentry_captured__"in t:n.startsWith("error sending request for url")?!0:z1.has(n)}function V1(t){if(typeof t=="number"){if(t<0)throw new TypeError("Expected `retries` to be a non-negative number.");if(Number.isNaN(t))throw new TypeError("Expected `retries` to be a valid number or Infinity, got NaN.")}else if(t!==void 0)throw new TypeError("Expected `retries` to be a number or Infinity.")}function Lc(t,e,{min:n=0,allowInfinity:r=!1}={}){if(e!==void 0){if(typeof e!="number"||Number.isNaN(e))throw new TypeError(`Expected \`${t}\` to be a number${r?" or Infinity":""}.`);if(!r&&!Number.isFinite(e))throw new TypeError(`Expected \`${t}\` to be a finite number.`);if(e<n)throw new TypeError(`Expected \`${t}\` to be  ${n}.`)}}var G1=class extends Error{constructor(t){super(),t instanceof Error?(this.originalError=t,{message:t}=t):(this.originalError=new Error(t),this.originalError.stack=this.stack),this.name="AbortError",this.message=t}};function W1(t,e){const n=Math.max(1,t+1),r=e.randomize?Math.random()+1:1;let s=Math.round(r*e.minTimeout*e.factor**(n-1));return s=Math.min(s,e.maxTimeout),s}function by(t,e){return Number.isFinite(e)?e-(performance.now()-t):e}async function H1({error:t,attemptNumber:e,retriesConsumed:n,startTime:r,options:s}){var f,m,g;const i=t instanceof Error?t:new TypeError(`Non-error was thrown: "${t}". You should only throw errors.`);if(i instanceof G1)throw i.originalError;const a=Number.isFinite(s.retries)?Math.max(0,s.retries-n):s.retries,o=s.maxRetryTime??Number.POSITIVE_INFINITY,c=Object.freeze({error:i,attemptNumber:e,retriesLeft:a,retriesConsumed:n});if(await s.onFailedAttempt(c),by(r,o)<=0)throw i;const l=await s.shouldConsumeRetry(c),u=by(r,o);if(u<=0||a<=0)throw i;if(i instanceof TypeError&&!Z1(i)){if(l)throw i;return(f=s.signal)==null||f.throwIfAborted(),!1}if(!await s.shouldRetry(c))throw i;if(!l)return(m=s.signal)==null||m.throwIfAborted(),!1;const d=W1(n,s),h=Math.min(d,u);return h>0&&await new Promise((w,b)=>{var T,A;const y=()=>{var I;clearTimeout(v),(I=s.signal)==null||I.removeEventListener("abort",y),b(s.signal.reason)},v=setTimeout(()=>{var I;(I=s.signal)==null||I.removeEventListener("abort",y),w()},h);s.unref&&((T=v.unref)==null||T.call(v)),(A=s.signal)==null||A.addEventListener("abort",y,{once:!0})}),(g=s.signal)==null||g.throwIfAborted(),!0}async function ef(t,e={}){var i,a,o;if(e={...e},V1(e.retries),Object.hasOwn(e,"forever"))throw new Error("The `forever` option is no longer supported. For many use-cases, you can set `retries: Infinity` instead.");e.retries??(e.retries=10),e.factor??(e.factor=2),e.minTimeout??(e.minTimeout=1e3),e.maxTimeout??(e.maxTimeout=Number.POSITIVE_INFINITY),e.maxRetryTime??(e.maxRetryTime=Number.POSITIVE_INFINITY),e.randomize??(e.randomize=!1),e.onFailedAttempt??(e.onFailedAttempt=()=>{}),e.shouldRetry??(e.shouldRetry=()=>!0),e.shouldConsumeRetry??(e.shouldConsumeRetry=()=>!0),Lc("factor",e.factor,{min:0,allowInfinity:!1}),Lc("minTimeout",e.minTimeout,{min:0,allowInfinity:!1}),Lc("maxTimeout",e.maxTimeout,{min:0,allowInfinity:!0}),Lc("maxRetryTime",e.maxRetryTime,{min:0,allowInfinity:!0}),e.factor>0||(e.factor=1),(i=e.signal)==null||i.throwIfAborted();let n=0,r=0;const s=performance.now();for(;!Number.isFinite(e.retries)||r<=e.retries;){n++;try{(a=e.signal)==null||a.throwIfAborted();const c=await t(n);return(o=e.signal)==null||o.throwIfAborted(),c}catch(c){await H1({error:c,attemptNumber:n,retriesConsumed:r,startTime:s,options:e})&&r++}}throw new Error("Retry attempts exhausted without throwing an error.")}var _b={};Se(_b,{AsyncCaller:()=>sc});const q1=[400,401,402,403,404,405,406,407,409],J1=t=>{var n,r;if(t.message.startsWith("Cancel")||t.message.startsWith("AbortError")||t.name==="AbortError"||(t==null?void 0:t.code)==="ECONNABORTED")throw t;const e=((n=t==null?void 0:t.response)==null?void 0:n.status)??(t==null?void 0:t.status);if(e&&q1.includes(+e))throw t;if(((r=t==null?void 0:t.error)==null?void 0:r.code)==="insufficient_quota"){const s=new Error(t==null?void 0:t.message);throw s.name="InsufficientQuotaError",s}};var sc=class{constructor(t){p(this,"maxConcurrency");p(this,"maxRetries");p(this,"onFailedAttempt");p(this,"queue");this.maxConcurrency=t.maxConcurrency??1/0,this.maxRetries=t.maxRetries??6,this.onFailedAttempt=t.onFailedAttempt??J1;const e="default"in os?os.default:os;this.queue=new e({concurrency:this.maxConcurrency})}async call(t,...e){return this.queue.add(()=>ef(()=>t(...e).catch(n=>{throw n instanceof Error?n:new Error(n)}),{onFailedAttempt:({error:n})=>{var r;return(r=this.onFailedAttempt)==null?void 0:r.call(this,n)},retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(t,e,...n){if(t.signal){let r;return Promise.race([this.call(e,...n),new Promise((s,i)=>{var a;r=()=>{i(So(t.signal))},(a=t.signal)==null||a.addEventListener("abort",r)})]).finally(()=>{t.signal&&r&&t.signal.removeEventListener("abort",r)})}return this.call(e,...n)}fetch(...t){return this.call(()=>fetch(...t).then(e=>e.ok?e:Promise.reject(e)))}},wb=class extends Es{constructor({config:e,onStart:n,onEnd:r,onError:s}){super({_awaitHandler:!0});p(this,"name","RootListenersTracer");p(this,"rootId");p(this,"config");p(this,"argOnStart");p(this,"argOnEnd");p(this,"argOnError");this.config=e,this.argOnStart=n,this.argOnEnd=r,this.argOnError=s}persistRun(e){return Promise.resolve()}async onRunCreate(e){this.rootId||(this.rootId=e.id,this.argOnStart&&await this.argOnStart(e,this.config))}async onRunUpdate(e){e.id===this.rootId&&(e.error?this.argOnError&&await this.argOnError(e,this.config):this.argOnEnd&&await this.argOnEnd(e,this.config))}};function Jp(t){return t?t.lc_runnable:!1}var K1=class{constructor(t){p(this,"includeNames");p(this,"includeTypes");p(this,"includeTags");p(this,"excludeNames");p(this,"excludeTypes");p(this,"excludeTags");this.includeNames=t.includeNames,this.includeTypes=t.includeTypes,this.includeTags=t.includeTags,this.excludeNames=t.excludeNames,this.excludeTypes=t.excludeTypes,this.excludeTags=t.excludeTags}includeEvent(t,e){let n=this.includeNames===void 0&&this.includeTypes===void 0&&this.includeTags===void 0;const r=t.tags??[];return this.includeNames!==void 0&&(n=n||this.includeNames.includes(t.name)),this.includeTypes!==void 0&&(n=n||this.includeTypes.includes(e)),this.includeTags!==void 0&&(n=n||r.some(s=>{var i;return(i=this.includeTags)==null?void 0:i.includes(s)})),this.excludeNames!==void 0&&(n=n&&!this.excludeNames.includes(t.name)),this.excludeTypes!==void 0&&(n=n&&!this.excludeTypes.includes(e)),this.excludeTags!==void 0&&(n=n&&r.every(s=>{var i;return!((i=this.excludeTags)!=null&&i.includes(s))})),n}};const X1=t=>btoa(t).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"");function z(t,e,n){function r(o,c){var l;Object.defineProperty(o,"_zod",{value:o._zod??{},enumerable:!1}),(l=o._zod).traits??(l.traits=new Set),o._zod.traits.add(t),e(o,c);for(const u in a.prototype)u in o||Object.defineProperty(o,u,{value:a.prototype[u].bind(o)});o._zod.constr=a,o._zod.def=c}const s=(n==null?void 0:n.Parent)??Object;class i extends s{}Object.defineProperty(i,"name",{value:t});function a(o){var c;const l=n!=null&&n.Parent?new i:this;r(l,o),(c=l._zod).deferred??(c.deferred=[]);for(const u of l._zod.deferred)u();return l}return Object.defineProperty(a,"init",{value:r}),Object.defineProperty(a,Symbol.hasInstance,{value:o=>{var c,l;return n!=null&&n.Parent&&o instanceof n.Parent?!0:(l=(c=o==null?void 0:o._zod)==null?void 0:c.traits)==null?void 0:l.has(t)}}),Object.defineProperty(a,"name",{value:t}),a}class Io extends Error{constructor(){super("Encountered Promise during synchronous parse. Use .parseAsync() instead.")}}const vb={};function qs(t){return vb}function bb(t){const e=Object.values(t).filter(r=>typeof r=="number");return Object.entries(t).filter(([r,s])=>e.indexOf(+r)===-1).map(([r,s])=>s)}function Y1(t,e){return typeof e=="bigint"?e.toString():e}function Kp(t){return{get value(){{const e=t();return Object.defineProperty(this,"value",{value:e}),e}}}}function Xp(t){return t==null}function Yp(t){const e=t.startsWith("^")?1:0,n=t.endsWith("$")?t.length-1:t.length;return t.slice(e,n)}function Q1(t,e){const n=(t.toString().split(".")[1]||"").length,r=(e.toString().split(".")[1]||"").length,s=n>r?n:r,i=Number.parseInt(t.toFixed(s).replace(".","")),a=Number.parseInt(e.toFixed(s).replace(".",""));return i%a/10**s}function ct(t,e,n){Object.defineProperty(t,e,{get(){{const r=n();return t[e]=r,r}},set(r){Object.defineProperty(t,e,{value:r})},configurable:!0})}function Qp(t,e,n){Object.defineProperty(t,e,{value:n,writable:!0,enumerable:!0,configurable:!0})}function ja(t){return JSON.stringify(t)}const Eb=Error.captureStackTrace?Error.captureStackTrace:(...t)=>{};function Zl(t){return typeof t=="object"&&t!==null&&!Array.isArray(t)}const e$=Kp(()=>{var t;if(typeof navigator<"u"&&((t=navigator==null?void 0:navigator.userAgent)!=null&&t.includes("Cloudflare")))return!1;try{const e=Function;return new e(""),!0}catch{return!1}});function Vl(t){if(Zl(t)===!1)return!1;const e=t.constructor;if(e===void 0)return!0;const n=e.prototype;return!(Zl(n)===!1||Object.prototype.hasOwnProperty.call(n,"isPrototypeOf")===!1)}const t$=new Set(["string","number","symbol"]);function ic(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function on(t,e,n){const r=new t._zod.constr(e??t._zod.def);return(!e||n!=null&&n.parent)&&(r._zod.parent=t),r}function Te(t){const e=t;if(!e)return{};if(typeof e=="string")return{error:()=>e};if((e==null?void 0:e.message)!==void 0){if((e==null?void 0:e.error)!==void 0)throw new Error("Cannot specify both `message` and `error` params");e.error=e.message}return delete e.message,typeof e.error=="string"?{...e,error:()=>e.error}:e}function n$(t){return Object.keys(t).filter(e=>t[e]._zod.optin==="optional"&&t[e]._zod.optout==="optional")}const r$={safeint:[Number.MIN_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],int32:[-2147483648,2147483647],uint32:[0,4294967295],float32:[-34028234663852886e22,34028234663852886e22],float64:[-Number.MAX_VALUE,Number.MAX_VALUE]};function s$(t,e){const n={},r=t._zod.def;for(const s in e){if(!(s in r.shape))throw new Error(`Unrecognized key: "${s}"`);e[s]&&(n[s]=r.shape[s])}return on(t,{...t._zod.def,shape:n,checks:[]})}function i$(t,e){const n={...t._zod.def.shape},r=t._zod.def;for(const s in e){if(!(s in r.shape))throw new Error(`Unrecognized key: "${s}"`);e[s]&&delete n[s]}return on(t,{...t._zod.def,shape:n,checks:[]})}function Tb(t,e){if(!Vl(e))throw new Error("Invalid input to extend: expected a plain object");const n={...t._zod.def,get shape(){const r={...t._zod.def.shape,...e};return Qp(this,"shape",r),r},checks:[]};return on(t,n)}function a$(t,e){return on(t,{...t._zod.def,get shape(){const n={...t._zod.def.shape,...e._zod.def.shape};return Qp(this,"shape",n),n},catchall:e._zod.def.catchall,checks:[]})}function Sb(t,e,n){const r=e._zod.def.shape,s={...r};if(n)for(const i in n){if(!(i in r))throw new Error(`Unrecognized key: "${i}"`);n[i]&&(s[i]=t?new t({type:"optional",innerType:r[i]}):r[i])}else for(const i in r)s[i]=t?new t({type:"optional",innerType:r[i]}):r[i];return on(e,{...e._zod.def,shape:s,checks:[]})}function o$(t,e,n){const r=e._zod.def.shape,s={...r};if(n)for(const i in n){if(!(i in s))throw new Error(`Unrecognized key: "${i}"`);n[i]&&(s[i]=new t({type:"nonoptional",innerType:r[i]}))}else for(const i in r)s[i]=new t({type:"nonoptional",innerType:r[i]});return on(e,{...e._zod.def,shape:s,checks:[]})}function oo(t,e=0){var n;for(let r=e;r<t.issues.length;r++)if(((n=t.issues[r])==null?void 0:n.continue)!==!0)return!0;return!1}function hi(t,e){return e.map(n=>{var r;return(r=n).path??(r.path=[]),n.path.unshift(t),n})}function jc(t){return typeof t=="string"?t:t==null?void 0:t.message}function Js(t,e,n){var s,i,a,o,c,l;const r={...t,path:t.path??[]};if(!t.message){const u=jc((a=(i=(s=t.inst)==null?void 0:s._zod.def)==null?void 0:i.error)==null?void 0:a.call(i,t))??jc((o=e==null?void 0:e.error)==null?void 0:o.call(e,t))??jc((c=n.customError)==null?void 0:c.call(n,t))??jc((l=n.localeError)==null?void 0:l.call(n,t))??"Invalid input";r.message=u}return delete r.inst,delete r.continue,e!=null&&e.reportInput||delete r.input,r}function em(t){return Array.isArray(t)?"array":typeof t=="string"?"string":"unknown"}function Ao(...t){const[e,n,r]=t;return typeof e=="string"?{message:e,code:"custom",input:n,inst:r}:{...e}}const xb=(t,e)=>{t.name="$ZodError",Object.defineProperty(t,"_zod",{value:t._zod,enumerable:!1}),Object.defineProperty(t,"issues",{value:e,enumerable:!1}),Object.defineProperty(t,"message",{get(){return JSON.stringify(e,Y1,2)},enumerable:!0}),Object.defineProperty(t,"toString",{value:()=>t.message,enumerable:!1})},kb=z("$ZodError",xb),Uu=z("$ZodError",xb,{Parent:Error});function c$(t,e=n=>n.message){const n={},r=[];for(const s of t.issues)s.path.length>0?(n[s.path[0]]=n[s.path[0]]||[],n[s.path[0]].push(e(s))):r.push(e(s));return{formErrors:r,fieldErrors:n}}function l$(t,e){const n=e||function(i){return i.message},r={_errors:[]},s=i=>{for(const a of i.issues)if(a.code==="invalid_union"&&a.errors.length)a.errors.map(o=>s({issues:o}));else if(a.code==="invalid_key")s({issues:a.issues});else if(a.code==="invalid_element")s({issues:a.issues});else if(a.path.length===0)r._errors.push(n(a));else{let o=r,c=0;for(;c<a.path.length;){const l=a.path[c];c===a.path.length-1?(o[l]=o[l]||{_errors:[]},o[l]._errors.push(n(a))):o[l]=o[l]||{_errors:[]},o=o[l],c++}}};return s(t),r}function u$(t){const e=[];for(const n of t)typeof n=="number"?e.push(`[${n}]`):typeof n=="symbol"?e.push(`[${JSON.stringify(String(n))}]`):/[^\w$]/.test(n)?e.push(`[${JSON.stringify(n)}]`):(e.length&&e.push("."),e.push(n));return e.join("")}function Fu(t){var r;const e=[],n=[...t.issues].sort((s,i)=>s.path.length-i.path.length);for(const s of n)e.push(` ${s.message}`),(r=s.path)!=null&&r.length&&e.push(`   at ${u$(s.path)}`);return e.join(`
`)}const Ib=t=>(e,n,r,s)=>{const i=r?Object.assign(r,{async:!1}):{async:!1},a=e._zod.run({value:n,issues:[]},i);if(a instanceof Promise)throw new Io;if(a.issues.length){const o=new((s==null?void 0:s.Err)??t)(a.issues.map(c=>Js(c,i,qs())));throw Eb(o,s==null?void 0:s.callee),o}return a.value},Bu=Ib(Uu),Ab=t=>async(e,n,r,s)=>{const i=r?Object.assign(r,{async:!0}):{async:!0};let a=e._zod.run({value:n,issues:[]},i);if(a instanceof Promise&&(a=await a),a.issues.length){const o=new((s==null?void 0:s.Err)??t)(a.issues.map(c=>Js(c,i,qs())));throw Eb(o,s==null?void 0:s.callee),o}return a.value},Cb=Ab(Uu),Ob=t=>(e,n,r)=>{const s=r?{...r,async:!1}:{async:!1},i=e._zod.run({value:n,issues:[]},s);if(i instanceof Promise)throw new Io;return i.issues.length?{success:!1,error:new(t??kb)(i.issues.map(a=>Js(a,s,qs())))}:{success:!0,data:i.value}},d$=Ob(Uu),$b=t=>async(e,n,r)=>{const s=r?Object.assign(r,{async:!0}):{async:!0};let i=e._zod.run({value:n,issues:[]},s);return i instanceof Promise&&(i=await i),i.issues.length?{success:!1,error:new t(i.issues.map(a=>Js(a,s,qs())))}:{success:!0,data:i.value}},h$=$b(Uu),f$=/^[cC][^\s-]{8,}$/,p$=/^[0-9a-z]+$/,m$=/^[0-9A-HJKMNP-TV-Za-hjkmnp-tv-z]{26}$/,g$=/^[0-9a-vA-V]{20}$/,y$=/^[A-Za-z0-9]{27}$/,_$=/^[a-zA-Z0-9_-]{21}$/,w$=/^P(?:(\d+W)|(?!.*W)(?=\d|T\d)(\d+Y)?(\d+M)?(\d+D)?(T(?=\d)(\d+H)?(\d+M)?(\d+([.,]\d+)?S)?)?)$/,v$=/^([0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12})$/,Ey=t=>t?new RegExp(`^([0-9a-fA-F]{8}-[0-9a-fA-F]{4}-${t}[0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12})$`):/^([0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[1-8][0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12}|00000000-0000-0000-0000-000000000000)$/,b$=/^(?!\.)(?!.*\.\.)([A-Za-z0-9_'+\-\.]*)[A-Za-z0-9_+-]@([A-Za-z0-9][A-Za-z0-9\-]*\.)+[A-Za-z]{2,}$/,E$="^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$";function T$(){return new RegExp(E$,"u")}const S$=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,x$=/^(([0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}|::|([0-9a-fA-F]{1,4})?::([0-9a-fA-F]{1,4}:?){0,6})$/,k$=/^((25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/([0-9]|[1-2][0-9]|3[0-2])$/,I$=/^(([0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}|::|([0-9a-fA-F]{1,4})?::([0-9a-fA-F]{1,4}:?){0,6})\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,A$=/^$|^(?:[0-9a-zA-Z+/]{4})*(?:(?:[0-9a-zA-Z+/]{2}==)|(?:[0-9a-zA-Z+/]{3}=))?$/,Rb=/^[A-Za-z0-9_-]*$/,C$=/^([a-zA-Z0-9-]+\.)*[a-zA-Z0-9-]+$/,O$=/^\+(?:[0-9]){6,14}[0-9]$/,Nb="(?:(?:\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-(?:(?:0[13578]|1[02])-(?:0[1-9]|[12]\\d|3[01])|(?:0[469]|11)-(?:0[1-9]|[12]\\d|30)|(?:02)-(?:0[1-9]|1\\d|2[0-8])))",$$=new RegExp(`^${Nb}$`);function Pb(t){const e="(?:[01]\\d|2[0-3]):[0-5]\\d";return typeof t.precision=="number"?t.precision===-1?`${e}`:t.precision===0?`${e}:[0-5]\\d`:`${e}:[0-5]\\d\\.\\d{${t.precision}}`:`${e}(?::[0-5]\\d(?:\\.\\d+)?)?`}function R$(t){return new RegExp(`^${Pb(t)}$`)}function N$(t){const e=Pb({precision:t.precision}),n=["Z"];t.local&&n.push(""),t.offset&&n.push("([+-]\\d{2}:\\d{2})");const r=`${e}(?:${n.join("|")})`;return new RegExp(`^${Nb}T(?:${r})$`)}const P$=t=>{const e=t?`[\\s\\S]{${(t==null?void 0:t.minimum)??0},${(t==null?void 0:t.maximum)??""}}`:"[\\s\\S]*";return new RegExp(`^${e}$`)},M$=/^\d+$/,L$=/^-?\d+(?:\.\d+)?/i,j$=/^[^A-Z]*$/,D$=/^[^a-z]*$/,Mn=z("$ZodCheck",(t,e)=>{var n;t._zod??(t._zod={}),t._zod.def=e,(n=t._zod).onattach??(n.onattach=[])}),Mb={number:"number",bigint:"bigint",object:"date"},Lb=z("$ZodCheckLessThan",(t,e)=>{Mn.init(t,e);const n=Mb[typeof e.value];t._zod.onattach.push(r=>{const s=r._zod.bag,i=(e.inclusive?s.maximum:s.exclusiveMaximum)??Number.POSITIVE_INFINITY;e.value<i&&(e.inclusive?s.maximum=e.value:s.exclusiveMaximum=e.value)}),t._zod.check=r=>{(e.inclusive?r.value<=e.value:r.value<e.value)||r.issues.push({origin:n,code:"too_big",maximum:e.value,input:r.value,inclusive:e.inclusive,inst:t,continue:!e.abort})}}),jb=z("$ZodCheckGreaterThan",(t,e)=>{Mn.init(t,e);const n=Mb[typeof e.value];t._zod.onattach.push(r=>{const s=r._zod.bag,i=(e.inclusive?s.minimum:s.exclusiveMinimum)??Number.NEGATIVE_INFINITY;e.value>i&&(e.inclusive?s.minimum=e.value:s.exclusiveMinimum=e.value)}),t._zod.check=r=>{(e.inclusive?r.value>=e.value:r.value>e.value)||r.issues.push({origin:n,code:"too_small",minimum:e.value,input:r.value,inclusive:e.inclusive,inst:t,continue:!e.abort})}}),U$=z("$ZodCheckMultipleOf",(t,e)=>{Mn.init(t,e),t._zod.onattach.push(n=>{var r;(r=n._zod.bag).multipleOf??(r.multipleOf=e.value)}),t._zod.check=n=>{if(typeof n.value!=typeof e.value)throw new Error("Cannot mix number and bigint in multiple_of check.");(typeof n.value=="bigint"?n.value%e.value===BigInt(0):Q1(n.value,e.value)===0)||n.issues.push({origin:typeof n.value,code:"not_multiple_of",divisor:e.value,input:n.value,inst:t,continue:!e.abort})}}),F$=z("$ZodCheckNumberFormat",(t,e)=>{var a;Mn.init(t,e),e.format=e.format||"float64";const n=(a=e.format)==null?void 0:a.includes("int"),r=n?"int":"number",[s,i]=r$[e.format];t._zod.onattach.push(o=>{const c=o._zod.bag;c.format=e.format,c.minimum=s,c.maximum=i,n&&(c.pattern=M$)}),t._zod.check=o=>{const c=o.value;if(n){if(!Number.isInteger(c)){o.issues.push({expected:r,format:e.format,code:"invalid_type",input:c,inst:t});return}if(!Number.isSafeInteger(c)){c>0?o.issues.push({input:c,code:"too_big",maximum:Number.MAX_SAFE_INTEGER,note:"Integers must be within the safe integer range.",inst:t,origin:r,continue:!e.abort}):o.issues.push({input:c,code:"too_small",minimum:Number.MIN_SAFE_INTEGER,note:"Integers must be within the safe integer range.",inst:t,origin:r,continue:!e.abort});return}}c<s&&o.issues.push({origin:"number",input:c,code:"too_small",minimum:s,inclusive:!0,inst:t,continue:!e.abort}),c>i&&o.issues.push({origin:"number",input:c,code:"too_big",maximum:i,inst:t})}}),B$=z("$ZodCheckMaxLength",(t,e)=>{var n;Mn.init(t,e),(n=t._zod.def).when??(n.when=r=>{const s=r.value;return!Xp(s)&&s.length!==void 0}),t._zod.onattach.push(r=>{const s=r._zod.bag.maximum??Number.POSITIVE_INFINITY;e.maximum<s&&(r._zod.bag.maximum=e.maximum)}),t._zod.check=r=>{const s=r.value;if(s.length<=e.maximum)return;const a=em(s);r.issues.push({origin:a,code:"too_big",maximum:e.maximum,inclusive:!0,input:s,inst:t,continue:!e.abort})}}),z$=z("$ZodCheckMinLength",(t,e)=>{var n;Mn.init(t,e),(n=t._zod.def).when??(n.when=r=>{const s=r.value;return!Xp(s)&&s.length!==void 0}),t._zod.onattach.push(r=>{const s=r._zod.bag.minimum??Number.NEGATIVE_INFINITY;e.minimum>s&&(r._zod.bag.minimum=e.minimum)}),t._zod.check=r=>{const s=r.value;if(s.length>=e.minimum)return;const a=em(s);r.issues.push({origin:a,code:"too_small",minimum:e.minimum,inclusive:!0,input:s,inst:t,continue:!e.abort})}}),Z$=z("$ZodCheckLengthEquals",(t,e)=>{var n;Mn.init(t,e),(n=t._zod.def).when??(n.when=r=>{const s=r.value;return!Xp(s)&&s.length!==void 0}),t._zod.onattach.push(r=>{const s=r._zod.bag;s.minimum=e.length,s.maximum=e.length,s.length=e.length}),t._zod.check=r=>{const s=r.value,i=s.length;if(i===e.length)return;const a=em(s),o=i>e.length;r.issues.push({origin:a,...o?{code:"too_big",maximum:e.length}:{code:"too_small",minimum:e.length},inclusive:!0,exact:!0,input:r.value,inst:t,continue:!e.abort})}}),zu=z("$ZodCheckStringFormat",(t,e)=>{var n,r;Mn.init(t,e),t._zod.onattach.push(s=>{const i=s._zod.bag;i.format=e.format,e.pattern&&(i.patterns??(i.patterns=new Set),i.patterns.add(e.pattern))}),e.pattern?(n=t._zod).check??(n.check=s=>{e.pattern.lastIndex=0,!e.pattern.test(s.value)&&s.issues.push({origin:"string",code:"invalid_format",format:e.format,input:s.value,...e.pattern?{pattern:e.pattern.toString()}:{},inst:t,continue:!e.abort})}):(r=t._zod).check??(r.check=()=>{})}),V$=z("$ZodCheckRegex",(t,e)=>{zu.init(t,e),t._zod.check=n=>{e.pattern.lastIndex=0,!e.pattern.test(n.value)&&n.issues.push({origin:"string",code:"invalid_format",format:"regex",input:n.value,pattern:e.pattern.toString(),inst:t,continue:!e.abort})}}),G$=z("$ZodCheckLowerCase",(t,e)=>{e.pattern??(e.pattern=j$),zu.init(t,e)}),W$=z("$ZodCheckUpperCase",(t,e)=>{e.pattern??(e.pattern=D$),zu.init(t,e)}),H$=z("$ZodCheckIncludes",(t,e)=>{Mn.init(t,e);const n=ic(e.includes),r=new RegExp(typeof e.position=="number"?`^.{${e.position}}${n}`:n);e.pattern=r,t._zod.onattach.push(s=>{const i=s._zod.bag;i.patterns??(i.patterns=new Set),i.patterns.add(r)}),t._zod.check=s=>{s.value.includes(e.includes,e.position)||s.issues.push({origin:"string",code:"invalid_format",format:"includes",includes:e.includes,input:s.value,inst:t,continue:!e.abort})}}),q$=z("$ZodCheckStartsWith",(t,e)=>{Mn.init(t,e);const n=new RegExp(`^${ic(e.prefix)}.*`);e.pattern??(e.pattern=n),t._zod.onattach.push(r=>{const s=r._zod.bag;s.patterns??(s.patterns=new Set),s.patterns.add(n)}),t._zod.check=r=>{r.value.startsWith(e.prefix)||r.issues.push({origin:"string",code:"invalid_format",format:"starts_with",prefix:e.prefix,input:r.value,inst:t,continue:!e.abort})}}),J$=z("$ZodCheckEndsWith",(t,e)=>{Mn.init(t,e);const n=new RegExp(`.*${ic(e.suffix)}$`);e.pattern??(e.pattern=n),t._zod.onattach.push(r=>{const s=r._zod.bag;s.patterns??(s.patterns=new Set),s.patterns.add(n)}),t._zod.check=r=>{r.value.endsWith(e.suffix)||r.issues.push({origin:"string",code:"invalid_format",format:"ends_with",suffix:e.suffix,input:r.value,inst:t,continue:!e.abort})}}),K$=z("$ZodCheckOverwrite",(t,e)=>{Mn.init(t,e),t._zod.check=n=>{n.value=e.tx(n.value)}});class X${constructor(e=[]){this.content=[],this.indent=0,this&&(this.args=e)}indented(e){this.indent+=1,e(this),this.indent-=1}write(e){if(typeof e=="function"){e(this,{execution:"sync"}),e(this,{execution:"async"});return}const r=e.split(`
`).filter(a=>a),s=Math.min(...r.map(a=>a.length-a.trimStart().length)),i=r.map(a=>a.slice(s)).map(a=>" ".repeat(this.indent*2)+a);for(const a of i)this.content.push(a)}compile(){const e=Function,n=this==null?void 0:this.args,s=[...((this==null?void 0:this.content)??[""]).map(i=>`  ${i}`)];return new e(...n,s.join(`
`))}}const Y$={major:4,minor:0,patch:0},ft=z("$ZodType",(t,e)=>{var s;var n;t??(t={}),t._zod.def=e,t._zod.bag=t._zod.bag||{},t._zod.version=Y$;const r=[...t._zod.def.checks??[]];t._zod.traits.has("$ZodCheck")&&r.unshift(t);for(const i of r)for(const a of i._zod.onattach)a(t);if(r.length===0)(n=t._zod).deferred??(n.deferred=[]),(s=t._zod.deferred)==null||s.push(()=>{t._zod.run=t._zod.parse});else{const i=(a,o,c)=>{let l=oo(a),u;for(const d of o){if(d._zod.def.when){if(!d._zod.def.when(a))continue}else if(l)continue;const h=a.issues.length,f=d._zod.check(a);if(f instanceof Promise&&(c==null?void 0:c.async)===!1)throw new Io;if(u||f instanceof Promise)u=(u??Promise.resolve()).then(async()=>{await f,a.issues.length!==h&&(l||(l=oo(a,h)))});else{if(a.issues.length===h)continue;l||(l=oo(a,h))}}return u?u.then(()=>a):a};t._zod.run=(a,o)=>{const c=t._zod.parse(a,o);if(c instanceof Promise){if(o.async===!1)throw new Io;return c.then(l=>i(l,r,o))}return i(c,r,o)}}t["~standard"]={validate:i=>{var a;try{const o=d$(t,i);return o.success?{value:o.data}:{issues:(a=o.error)==null?void 0:a.issues}}catch{return h$(t,i).then(c=>{var l;return c.success?{value:c.data}:{issues:(l=c.error)==null?void 0:l.issues}})}},vendor:"zod",version:1}}),tm=z("$ZodString",(t,e)=>{var n;ft.init(t,e),t._zod.pattern=[...((n=t==null?void 0:t._zod.bag)==null?void 0:n.patterns)??[]].pop()??P$(t._zod.bag),t._zod.parse=(r,s)=>{if(e.coerce)try{r.value=String(r.value)}catch{}return typeof r.value=="string"||r.issues.push({expected:"string",code:"invalid_type",input:r.value,inst:t}),r}}),pt=z("$ZodStringFormat",(t,e)=>{zu.init(t,e),tm.init(t,e)}),Q$=z("$ZodGUID",(t,e)=>{e.pattern??(e.pattern=v$),pt.init(t,e)}),eR=z("$ZodUUID",(t,e)=>{if(e.version){const r={v1:1,v2:2,v3:3,v4:4,v5:5,v6:6,v7:7,v8:8}[e.version];if(r===void 0)throw new Error(`Invalid UUID version: "${e.version}"`);e.pattern??(e.pattern=Ey(r))}else e.pattern??(e.pattern=Ey());pt.init(t,e)}),tR=z("$ZodEmail",(t,e)=>{e.pattern??(e.pattern=b$),pt.init(t,e)}),nR=z("$ZodURL",(t,e)=>{pt.init(t,e),t._zod.check=n=>{try{const r=n.value,s=new URL(r),i=s.href;e.hostname&&(e.hostname.lastIndex=0,e.hostname.test(s.hostname)||n.issues.push({code:"invalid_format",format:"url",note:"Invalid hostname",pattern:C$.source,input:n.value,inst:t,continue:!e.abort})),e.protocol&&(e.protocol.lastIndex=0,e.protocol.test(s.protocol.endsWith(":")?s.protocol.slice(0,-1):s.protocol)||n.issues.push({code:"invalid_format",format:"url",note:"Invalid protocol",pattern:e.protocol.source,input:n.value,inst:t,continue:!e.abort})),!r.endsWith("/")&&i.endsWith("/")?n.value=i.slice(0,-1):n.value=i;return}catch{n.issues.push({code:"invalid_format",format:"url",input:n.value,inst:t,continue:!e.abort})}}}),rR=z("$ZodEmoji",(t,e)=>{e.pattern??(e.pattern=T$()),pt.init(t,e)}),sR=z("$ZodNanoID",(t,e)=>{e.pattern??(e.pattern=_$),pt.init(t,e)}),iR=z("$ZodCUID",(t,e)=>{e.pattern??(e.pattern=f$),pt.init(t,e)}),aR=z("$ZodCUID2",(t,e)=>{e.pattern??(e.pattern=p$),pt.init(t,e)}),oR=z("$ZodULID",(t,e)=>{e.pattern??(e.pattern=m$),pt.init(t,e)}),cR=z("$ZodXID",(t,e)=>{e.pattern??(e.pattern=g$),pt.init(t,e)}),lR=z("$ZodKSUID",(t,e)=>{e.pattern??(e.pattern=y$),pt.init(t,e)}),uR=z("$ZodISODateTime",(t,e)=>{e.pattern??(e.pattern=N$(e)),pt.init(t,e)}),dR=z("$ZodISODate",(t,e)=>{e.pattern??(e.pattern=$$),pt.init(t,e)}),hR=z("$ZodISOTime",(t,e)=>{e.pattern??(e.pattern=R$(e)),pt.init(t,e)}),fR=z("$ZodISODuration",(t,e)=>{e.pattern??(e.pattern=w$),pt.init(t,e)}),pR=z("$ZodIPv4",(t,e)=>{e.pattern??(e.pattern=S$),pt.init(t,e),t._zod.onattach.push(n=>{const r=n._zod.bag;r.format="ipv4"})}),mR=z("$ZodIPv6",(t,e)=>{e.pattern??(e.pattern=x$),pt.init(t,e),t._zod.onattach.push(n=>{const r=n._zod.bag;r.format="ipv6"}),t._zod.check=n=>{try{new URL(`http://[${n.value}]`)}catch{n.issues.push({code:"invalid_format",format:"ipv6",input:n.value,inst:t,continue:!e.abort})}}}),gR=z("$ZodCIDRv4",(t,e)=>{e.pattern??(e.pattern=k$),pt.init(t,e)}),yR=z("$ZodCIDRv6",(t,e)=>{e.pattern??(e.pattern=I$),pt.init(t,e),t._zod.check=n=>{const[r,s]=n.value.split("/");try{if(!s)throw new Error;const i=Number(s);if(`${i}`!==s)throw new Error;if(i<0||i>128)throw new Error;new URL(`http://[${r}]`)}catch{n.issues.push({code:"invalid_format",format:"cidrv6",input:n.value,inst:t,continue:!e.abort})}}});function Db(t){if(t==="")return!0;if(t.length%4!==0)return!1;try{return atob(t),!0}catch{return!1}}const _R=z("$ZodBase64",(t,e)=>{e.pattern??(e.pattern=A$),pt.init(t,e),t._zod.onattach.push(n=>{n._zod.bag.contentEncoding="base64"}),t._zod.check=n=>{Db(n.value)||n.issues.push({code:"invalid_format",format:"base64",input:n.value,inst:t,continue:!e.abort})}});function wR(t){if(!Rb.test(t))return!1;const e=t.replace(/[-_]/g,r=>r==="-"?"+":"/"),n=e.padEnd(Math.ceil(e.length/4)*4,"=");return Db(n)}const vR=z("$ZodBase64URL",(t,e)=>{e.pattern??(e.pattern=Rb),pt.init(t,e),t._zod.onattach.push(n=>{n._zod.bag.contentEncoding="base64url"}),t._zod.check=n=>{wR(n.value)||n.issues.push({code:"invalid_format",format:"base64url",input:n.value,inst:t,continue:!e.abort})}}),bR=z("$ZodE164",(t,e)=>{e.pattern??(e.pattern=O$),pt.init(t,e)});function ER(t,e=null){try{const n=t.split(".");if(n.length!==3)return!1;const[r]=n;if(!r)return!1;const s=JSON.parse(atob(r));return!("typ"in s&&(s==null?void 0:s.typ)!=="JWT"||!s.alg||e&&(!("alg"in s)||s.alg!==e))}catch{return!1}}const TR=z("$ZodJWT",(t,e)=>{pt.init(t,e),t._zod.check=n=>{ER(n.value,e.alg)||n.issues.push({code:"invalid_format",format:"jwt",input:n.value,inst:t,continue:!e.abort})}}),Ub=z("$ZodNumber",(t,e)=>{ft.init(t,e),t._zod.pattern=t._zod.bag.pattern??L$,t._zod.parse=(n,r)=>{if(e.coerce)try{n.value=Number(n.value)}catch{}const s=n.value;if(typeof s=="number"&&!Number.isNaN(s)&&Number.isFinite(s))return n;const i=typeof s=="number"?Number.isNaN(s)?"NaN":Number.isFinite(s)?void 0:"Infinity":void 0;return n.issues.push({expected:"number",code:"invalid_type",input:s,inst:t,...i?{received:i}:{}}),n}}),SR=z("$ZodNumber",(t,e)=>{F$.init(t,e),Ub.init(t,e)}),xR=z("$ZodAny",(t,e)=>{ft.init(t,e),t._zod.parse=n=>n}),Fb=z("$ZodUnknown",(t,e)=>{ft.init(t,e),t._zod.parse=n=>n}),Bb=z("$ZodNever",(t,e)=>{ft.init(t,e),t._zod.parse=(n,r)=>(n.issues.push({expected:"never",code:"invalid_type",input:n.value,inst:t}),n)});function Ty(t,e,n){t.issues.length&&e.issues.push(...hi(n,t.issues)),e.value[n]=t.value}const kR=z("$ZodArray",(t,e)=>{ft.init(t,e),t._zod.parse=(n,r)=>{const s=n.value;if(!Array.isArray(s))return n.issues.push({expected:"array",code:"invalid_type",input:s,inst:t}),n;n.value=Array(s.length);const i=[];for(let a=0;a<s.length;a++){const o=s[a],c=e.element._zod.run({value:o,issues:[]},r);c instanceof Promise?i.push(c.then(l=>Ty(l,n,a))):Ty(c,n,a)}return i.length?Promise.all(i).then(()=>n):n}});function Dc(t,e,n){t.issues.length&&e.issues.push(...hi(n,t.issues)),e.value[n]=t.value}function Sy(t,e,n,r){t.issues.length?r[n]===void 0?n in r?e.value[n]=void 0:e.value[n]=t.value:e.issues.push(...hi(n,t.issues)):t.value===void 0?n in r&&(e.value[n]=void 0):e.value[n]=t.value}const IR=z("$ZodObject",(t,e)=>{ft.init(t,e);const n=Kp(()=>{const d=Object.keys(e.shape);for(const f of d)if(!(e.shape[f]instanceof ft))throw new Error(`Invalid element at key "${f}": expected a Zod schema`);const h=n$(e.shape);return{shape:e.shape,keys:d,keySet:new Set(d),numKeys:d.length,optionalKeys:new Set(h)}});ct(t._zod,"propValues",()=>{const d=e.shape,h={};for(const f in d){const m=d[f]._zod;if(m.values){h[f]??(h[f]=new Set);for(const g of m.values)h[f].add(g)}}return h});const r=d=>{const h=new X$(["shape","payload","ctx"]),f=n.value,m=y=>{const v=ja(y);return`shape[${v}]._zod.run({ value: input[${v}], issues: [] }, ctx)`};h.write("const input = payload.value;");const g=Object.create(null);let w=0;for(const y of f.keys)g[y]=`key_${w++}`;h.write("const newResult = {}");for(const y of f.keys)if(f.optionalKeys.has(y)){const v=g[y];h.write(`const ${v} = ${m(y)};`);const T=ja(y);h.write(`
        if (${v}.issues.length) {
          if (input[${T}] === undefined) {
            if (${T} in input) {
              newResult[${T}] = undefined;
            }
          } else {
            payload.issues = payload.issues.concat(
              ${v}.issues.map((iss) => ({
                ...iss,
                path: iss.path ? [${T}, ...iss.path] : [${T}],
              }))
            );
          }
        } else if (${v}.value === undefined) {
          if (${T} in input) newResult[${T}] = undefined;
        } else {
          newResult[${T}] = ${v}.value;
        }
        `)}else{const v=g[y];h.write(`const ${v} = ${m(y)};`),h.write(`
          if (${v}.issues.length) payload.issues = payload.issues.concat(${v}.issues.map(iss => ({
            ...iss,
            path: iss.path ? [${ja(y)}, ...iss.path] : [${ja(y)}]
          })));`),h.write(`newResult[${ja(y)}] = ${v}.value`)}h.write("payload.value = newResult;"),h.write("return payload;");const b=h.compile();return(y,v)=>b(d,y,v)};let s;const i=Zl,a=!vb.jitless,c=a&&e$.value,l=e.catchall;let u;t._zod.parse=(d,h)=>{u??(u=n.value);const f=d.value;if(!i(f))return d.issues.push({expected:"object",code:"invalid_type",input:f,inst:t}),d;const m=[];if(a&&c&&(h==null?void 0:h.async)===!1&&h.jitless!==!0)s||(s=r(e.shape)),d=s(d,h);else{d.value={};const v=u.shape;for(const T of u.keys){const A=v[T],I=A._zod.run({value:f[T],issues:[]},h),$=A._zod.optin==="optional"&&A._zod.optout==="optional";I instanceof Promise?m.push(I.then(S=>$?Sy(S,d,T,f):Dc(S,d,T))):$?Sy(I,d,T,f):Dc(I,d,T)}}if(!l)return m.length?Promise.all(m).then(()=>d):d;const g=[],w=u.keySet,b=l._zod,y=b.def.type;for(const v of Object.keys(f)){if(w.has(v))continue;if(y==="never"){g.push(v);continue}const T=b.run({value:f[v],issues:[]},h);T instanceof Promise?m.push(T.then(A=>Dc(A,d,v))):Dc(T,d,v)}return g.length&&d.issues.push({code:"unrecognized_keys",keys:g,input:f,inst:t}),m.length?Promise.all(m).then(()=>d):d}});function xy(t,e,n,r){for(const s of t)if(s.issues.length===0)return e.value=s.value,e;return e.issues.push({code:"invalid_union",input:e.value,inst:n,errors:t.map(s=>s.issues.map(i=>Js(i,r,qs())))}),e}const zb=z("$ZodUnion",(t,e)=>{ft.init(t,e),ct(t._zod,"optin",()=>e.options.some(n=>n._zod.optin==="optional")?"optional":void 0),ct(t._zod,"optout",()=>e.options.some(n=>n._zod.optout==="optional")?"optional":void 0),ct(t._zod,"values",()=>{if(e.options.every(n=>n._zod.values))return new Set(e.options.flatMap(n=>Array.from(n._zod.values)))}),ct(t._zod,"pattern",()=>{if(e.options.every(n=>n._zod.pattern)){const n=e.options.map(r=>r._zod.pattern);return new RegExp(`^(${n.map(r=>Yp(r.source)).join("|")})$`)}}),t._zod.parse=(n,r)=>{let s=!1;const i=[];for(const a of e.options){const o=a._zod.run({value:n.value,issues:[]},r);if(o instanceof Promise)i.push(o),s=!0;else{if(o.issues.length===0)return o;i.push(o)}}return s?Promise.all(i).then(a=>xy(a,n,t,r)):xy(i,n,t,r)}}),AR=z("$ZodDiscriminatedUnion",(t,e)=>{zb.init(t,e);const n=t._zod.parse;ct(t._zod,"propValues",()=>{const s={};for(const i of e.options){const a=i._zod.propValues;if(!a||Object.keys(a).length===0)throw new Error(`Invalid discriminated union option at index "${e.options.indexOf(i)}"`);for(const[o,c]of Object.entries(a)){s[o]||(s[o]=new Set);for(const l of c)s[o].add(l)}}return s});const r=Kp(()=>{const s=e.options,i=new Map;for(const a of s){const o=a._zod.propValues[e.discriminator];if(!o||o.size===0)throw new Error(`Invalid discriminated union option at index "${e.options.indexOf(a)}"`);for(const c of o){if(i.has(c))throw new Error(`Duplicate discriminator value "${String(c)}"`);i.set(c,a)}}return i});t._zod.parse=(s,i)=>{const a=s.value;if(!Zl(a))return s.issues.push({code:"invalid_type",expected:"object",input:a,inst:t}),s;const o=r.value.get(a==null?void 0:a[e.discriminator]);return o?o._zod.run(s,i):e.unionFallback?n(s,i):(s.issues.push({code:"invalid_union",errors:[],note:"No matching discriminator",input:a,path:[e.discriminator],inst:t}),s)}}),CR=z("$ZodIntersection",(t,e)=>{ft.init(t,e),t._zod.parse=(n,r)=>{const s=n.value,i=e.left._zod.run({value:s,issues:[]},r),a=e.right._zod.run({value:s,issues:[]},r);return i instanceof Promise||a instanceof Promise?Promise.all([i,a]).then(([c,l])=>ky(n,c,l)):ky(n,i,a)}});function tf(t,e){if(t===e)return{valid:!0,data:t};if(t instanceof Date&&e instanceof Date&&+t==+e)return{valid:!0,data:t};if(Vl(t)&&Vl(e)){const n=Object.keys(e),r=Object.keys(t).filter(i=>n.indexOf(i)!==-1),s={...t,...e};for(const i of r){const a=tf(t[i],e[i]);if(!a.valid)return{valid:!1,mergeErrorPath:[i,...a.mergeErrorPath]};s[i]=a.data}return{valid:!0,data:s}}if(Array.isArray(t)&&Array.isArray(e)){if(t.length!==e.length)return{valid:!1,mergeErrorPath:[]};const n=[];for(let r=0;r<t.length;r++){const s=t[r],i=e[r],a=tf(s,i);if(!a.valid)return{valid:!1,mergeErrorPath:[r,...a.mergeErrorPath]};n.push(a.data)}return{valid:!0,data:n}}return{valid:!1,mergeErrorPath:[]}}function ky(t,e,n){if(e.issues.length&&t.issues.push(...e.issues),n.issues.length&&t.issues.push(...n.issues),oo(t))return t;const r=tf(e.value,n.value);if(!r.valid)throw new Error(`Unmergable intersection. Error path: ${JSON.stringify(r.mergeErrorPath)}`);return t.value=r.data,t}const OR=z("$ZodRecord",(t,e)=>{ft.init(t,e),t._zod.parse=(n,r)=>{const s=n.value;if(!Vl(s))return n.issues.push({expected:"record",code:"invalid_type",input:s,inst:t}),n;const i=[];if(e.keyType._zod.values){const a=e.keyType._zod.values;n.value={};for(const c of a)if(typeof c=="string"||typeof c=="number"||typeof c=="symbol"){const l=e.valueType._zod.run({value:s[c],issues:[]},r);l instanceof Promise?i.push(l.then(u=>{u.issues.length&&n.issues.push(...hi(c,u.issues)),n.value[c]=u.value})):(l.issues.length&&n.issues.push(...hi(c,l.issues)),n.value[c]=l.value)}let o;for(const c in s)a.has(c)||(o=o??[],o.push(c));o&&o.length>0&&n.issues.push({code:"unrecognized_keys",input:s,inst:t,keys:o})}else{n.value={};for(const a of Reflect.ownKeys(s)){if(a==="__proto__")continue;const o=e.keyType._zod.run({value:a,issues:[]},r);if(o instanceof Promise)throw new Error("Async schemas not supported in object keys currently");if(o.issues.length){n.issues.push({origin:"record",code:"invalid_key",issues:o.issues.map(l=>Js(l,r,qs())),input:a,path:[a],inst:t}),n.value[o.value]=o.value;continue}const c=e.valueType._zod.run({value:s[a],issues:[]},r);c instanceof Promise?i.push(c.then(l=>{l.issues.length&&n.issues.push(...hi(a,l.issues)),n.value[o.value]=l.value})):(c.issues.length&&n.issues.push(...hi(a,c.issues)),n.value[o.value]=c.value)}}return i.length?Promise.all(i).then(()=>n):n}}),$R=z("$ZodEnum",(t,e)=>{ft.init(t,e);const n=bb(e.entries);t._zod.values=new Set(n),t._zod.pattern=new RegExp(`^(${n.filter(r=>t$.has(typeof r)).map(r=>typeof r=="string"?ic(r):r.toString()).join("|")})$`),t._zod.parse=(r,s)=>{const i=r.value;return t._zod.values.has(i)||r.issues.push({code:"invalid_value",values:n,input:i,inst:t}),r}}),RR=z("$ZodLiteral",(t,e)=>{ft.init(t,e),t._zod.values=new Set(e.values),t._zod.pattern=new RegExp(`^(${e.values.map(n=>typeof n=="string"?ic(n):n?n.toString():String(n)).join("|")})$`),t._zod.parse=(n,r)=>{const s=n.value;return t._zod.values.has(s)||n.issues.push({code:"invalid_value",values:e.values,input:s,inst:t}),n}}),NR=z("$ZodTransform",(t,e)=>{ft.init(t,e),t._zod.parse=(n,r)=>{const s=e.transform(n.value,n);if(r.async)return(s instanceof Promise?s:Promise.resolve(s)).then(a=>(n.value=a,n));if(s instanceof Promise)throw new Io;return n.value=s,n}}),nm=z("$ZodOptional",(t,e)=>{ft.init(t,e),t._zod.optin="optional",t._zod.optout="optional",ct(t._zod,"values",()=>e.innerType._zod.values?new Set([...e.innerType._zod.values,void 0]):void 0),ct(t._zod,"pattern",()=>{const n=e.innerType._zod.pattern;return n?new RegExp(`^(${Yp(n.source)})?$`):void 0}),t._zod.parse=(n,r)=>e.innerType._zod.optin==="optional"?e.innerType._zod.run(n,r):n.value===void 0?n:e.innerType._zod.run(n,r)}),PR=z("$ZodNullable",(t,e)=>{ft.init(t,e),ct(t._zod,"optin",()=>e.innerType._zod.optin),ct(t._zod,"optout",()=>e.innerType._zod.optout),ct(t._zod,"pattern",()=>{const n=e.innerType._zod.pattern;return n?new RegExp(`^(${Yp(n.source)}|null)$`):void 0}),ct(t._zod,"values",()=>e.innerType._zod.values?new Set([...e.innerType._zod.values,null]):void 0),t._zod.parse=(n,r)=>n.value===null?n:e.innerType._zod.run(n,r)}),MR=z("$ZodDefault",(t,e)=>{ft.init(t,e),t._zod.optin="optional",ct(t._zod,"values",()=>e.innerType._zod.values),t._zod.parse=(n,r)=>{if(n.value===void 0)return n.value=e.defaultValue,n;const s=e.innerType._zod.run(n,r);return s instanceof Promise?s.then(i=>Iy(i,e)):Iy(s,e)}});function Iy(t,e){return t.value===void 0&&(t.value=e.defaultValue),t}const LR=z("$ZodPrefault",(t,e)=>{ft.init(t,e),t._zod.optin="optional",ct(t._zod,"values",()=>e.innerType._zod.values),t._zod.parse=(n,r)=>(n.value===void 0&&(n.value=e.defaultValue),e.innerType._zod.run(n,r))}),jR=z("$ZodNonOptional",(t,e)=>{ft.init(t,e),ct(t._zod,"values",()=>{const n=e.innerType._zod.values;return n?new Set([...n].filter(r=>r!==void 0)):void 0}),t._zod.parse=(n,r)=>{const s=e.innerType._zod.run(n,r);return s instanceof Promise?s.then(i=>Ay(i,t)):Ay(s,t)}});function Ay(t,e){return!t.issues.length&&t.value===void 0&&t.issues.push({code:"invalid_type",expected:"nonoptional",input:t.value,inst:e}),t}const DR=z("$ZodCatch",(t,e)=>{ft.init(t,e),t._zod.optin="optional",ct(t._zod,"optout",()=>e.innerType._zod.optout),ct(t._zod,"values",()=>e.innerType._zod.values),t._zod.parse=(n,r)=>{const s=e.innerType._zod.run(n,r);return s instanceof Promise?s.then(i=>(n.value=i.value,i.issues.length&&(n.value=e.catchValue({...n,error:{issues:i.issues.map(a=>Js(a,r,qs()))},input:n.value}),n.issues=[]),n)):(n.value=s.value,s.issues.length&&(n.value=e.catchValue({...n,error:{issues:s.issues.map(i=>Js(i,r,qs()))},input:n.value}),n.issues=[]),n)}}),UR=z("$ZodPipe",(t,e)=>{ft.init(t,e),ct(t._zod,"values",()=>e.in._zod.values),ct(t._zod,"optin",()=>e.in._zod.optin),ct(t._zod,"optout",()=>e.out._zod.optout),t._zod.parse=(n,r)=>{const s=e.in._zod.run(n,r);return s instanceof Promise?s.then(i=>Cy(i,e,r)):Cy(s,e,r)}});function Cy(t,e,n){return oo(t)?t:e.out._zod.run({value:t.value,issues:t.issues},n)}const FR=z("$ZodReadonly",(t,e)=>{ft.init(t,e),ct(t._zod,"propValues",()=>e.innerType._zod.propValues),ct(t._zod,"values",()=>e.innerType._zod.values),ct(t._zod,"optin",()=>e.innerType._zod.optin),ct(t._zod,"optout",()=>e.innerType._zod.optout),t._zod.parse=(n,r)=>{const s=e.innerType._zod.run(n,r);return s instanceof Promise?s.then(Oy):Oy(s)}});function Oy(t){return t.value=Object.freeze(t.value),t}const BR=z("$ZodCustom",(t,e)=>{Mn.init(t,e),ft.init(t,e),t._zod.parse=(n,r)=>n,t._zod.check=n=>{const r=n.value,s=e.fn(r);if(s instanceof Promise)return s.then(i=>$y(i,n,r,t));$y(s,n,r,t)}});function $y(t,e,n,r){if(!t){const s={code:"custom",input:n,inst:r,path:[...r._zod.def.path??[]],continue:!r._zod.def.abort};r._zod.def.params&&(s.params=r._zod.def.params),e.issues.push(Ao(s))}}class rm{constructor(){this._map=new Map,this._idmap=new Map}add(e,...n){const r=n[0];if(this._map.set(e,r),r&&typeof r=="object"&&"id"in r){if(this._idmap.has(r.id))throw new Error(`ID ${r.id} already exists in the registry`);this._idmap.set(r.id,e)}return this}clear(){return this._map=new Map,this._idmap=new Map,this}remove(e){const n=this._map.get(e);return n&&typeof n=="object"&&"id"in n&&this._idmap.delete(n.id),this._map.delete(e),this}get(e){const n=e._zod.parent;if(n){const r={...this.get(n)??{}};return delete r.id,{...r,...this._map.get(e)}}return this._map.get(e)}has(e){return this._map.has(e)}}function zR(){return new rm}const Wt=zR();function ZR(t,e){return new t({type:"string",...Te(e)})}function VR(t,e){return new t({type:"string",format:"email",check:"string_format",abort:!1,...Te(e)})}function Ry(t,e){return new t({type:"string",format:"guid",check:"string_format",abort:!1,...Te(e)})}function GR(t,e){return new t({type:"string",format:"uuid",check:"string_format",abort:!1,...Te(e)})}function WR(t,e){return new t({type:"string",format:"uuid",check:"string_format",abort:!1,version:"v4",...Te(e)})}function HR(t,e){return new t({type:"string",format:"uuid",check:"string_format",abort:!1,version:"v6",...Te(e)})}function qR(t,e){return new t({type:"string",format:"uuid",check:"string_format",abort:!1,version:"v7",...Te(e)})}function JR(t,e){return new t({type:"string",format:"url",check:"string_format",abort:!1,...Te(e)})}function KR(t,e){return new t({type:"string",format:"emoji",check:"string_format",abort:!1,...Te(e)})}function XR(t,e){return new t({type:"string",format:"nanoid",check:"string_format",abort:!1,...Te(e)})}function YR(t,e){return new t({type:"string",format:"cuid",check:"string_format",abort:!1,...Te(e)})}function QR(t,e){return new t({type:"string",format:"cuid2",check:"string_format",abort:!1,...Te(e)})}function eN(t,e){return new t({type:"string",format:"ulid",check:"string_format",abort:!1,...Te(e)})}function tN(t,e){return new t({type:"string",format:"xid",check:"string_format",abort:!1,...Te(e)})}function nN(t,e){return new t({type:"string",format:"ksuid",check:"string_format",abort:!1,...Te(e)})}function rN(t,e){return new t({type:"string",format:"ipv4",check:"string_format",abort:!1,...Te(e)})}function sN(t,e){return new t({type:"string",format:"ipv6",check:"string_format",abort:!1,...Te(e)})}function iN(t,e){return new t({type:"string",format:"cidrv4",check:"string_format",abort:!1,...Te(e)})}function aN(t,e){return new t({type:"string",format:"cidrv6",check:"string_format",abort:!1,...Te(e)})}function oN(t,e){return new t({type:"string",format:"base64",check:"string_format",abort:!1,...Te(e)})}function cN(t,e){return new t({type:"string",format:"base64url",check:"string_format",abort:!1,...Te(e)})}function lN(t,e){return new t({type:"string",format:"e164",check:"string_format",abort:!1,...Te(e)})}function uN(t,e){return new t({type:"string",format:"jwt",check:"string_format",abort:!1,...Te(e)})}function dN(t,e){return new t({type:"string",format:"datetime",check:"string_format",offset:!1,local:!1,precision:null,...Te(e)})}function hN(t,e){return new t({type:"string",format:"date",check:"string_format",...Te(e)})}function fN(t,e){return new t({type:"string",format:"time",check:"string_format",precision:null,...Te(e)})}function pN(t,e){return new t({type:"string",format:"duration",check:"string_format",...Te(e)})}function mN(t,e){return new t({type:"number",checks:[],...Te(e)})}function gN(t,e){return new t({type:"number",check:"number_format",abort:!1,format:"safeint",...Te(e)})}function yN(t){return new t({type:"any"})}function Zb(t){return new t({type:"unknown"})}function Vb(t,e){return new t({type:"never",...Te(e)})}function Ny(t,e){return new Lb({check:"less_than",...Te(e),value:t,inclusive:!1})}function qd(t,e){return new Lb({check:"less_than",...Te(e),value:t,inclusive:!0})}function Py(t,e){return new jb({check:"greater_than",...Te(e),value:t,inclusive:!1})}function Jd(t,e){return new jb({check:"greater_than",...Te(e),value:t,inclusive:!0})}function My(t,e){return new U$({check:"multiple_of",...Te(e),value:t})}function Gb(t,e){return new B$({check:"max_length",...Te(e),maximum:t})}function Gl(t,e){return new z$({check:"min_length",...Te(e),minimum:t})}function Wb(t,e){return new Z$({check:"length_equals",...Te(e),length:t})}function _N(t,e){return new V$({check:"string_format",format:"regex",...Te(e),pattern:t})}function wN(t){return new G$({check:"string_format",format:"lowercase",...Te(t)})}function vN(t){return new W$({check:"string_format",format:"uppercase",...Te(t)})}function bN(t,e){return new H$({check:"string_format",format:"includes",...Te(e),includes:t})}function EN(t,e){return new q$({check:"string_format",format:"starts_with",...Te(e),prefix:t})}function TN(t,e){return new J$({check:"string_format",format:"ends_with",...Te(e),suffix:t})}function ac(t){return new K$({check:"overwrite",tx:t})}function SN(t){return ac(e=>e.normalize(t))}function xN(){return ac(t=>t.trim())}function kN(){return ac(t=>t.toLowerCase())}function IN(){return ac(t=>t.toUpperCase())}function AN(t,e,n){return new t({type:"array",element:e,...Te(n)})}function CN(t,e,n){return new t({type:"custom",check:"custom",fn:e,...Te(n)})}class Ly{constructor(e){this.counter=0,this.metadataRegistry=(e==null?void 0:e.metadata)??Wt,this.target=(e==null?void 0:e.target)??"draft-2020-12",this.unrepresentable=(e==null?void 0:e.unrepresentable)??"throw",this.override=(e==null?void 0:e.override)??(()=>{}),this.io=(e==null?void 0:e.io)??"output",this.seen=new Map}process(e,n={path:[],schemaPath:[]}){var d,h,f;var r;const s=e._zod.def,i={guid:"uuid",url:"uri",datetime:"date-time",json_string:"json-string",regex:""},a=this.seen.get(e);if(a)return a.count++,n.schemaPath.includes(e)&&(a.cycle=n.path),a.schema;const o={schema:{},count:1,cycle:void 0,path:n.path};this.seen.set(e,o);const c=(h=(d=e._zod).toJSONSchema)==null?void 0:h.call(d);if(c)o.schema=c;else{const m={...n,schemaPath:[...n.schemaPath,e],path:n.path},g=e._zod.parent;if(g)o.ref=g,this.process(g,m),this.seen.get(g).isParent=!0;else{const w=o.schema;switch(s.type){case"string":{const b=w;b.type="string";const{minimum:y,maximum:v,format:T,patterns:A,contentEncoding:I}=e._zod.bag;if(typeof y=="number"&&(b.minLength=y),typeof v=="number"&&(b.maxLength=v),T&&(b.format=i[T]??T,b.format===""&&delete b.format),I&&(b.contentEncoding=I),A&&A.size>0){const $=[...A];$.length===1?b.pattern=$[0].source:$.length>1&&(o.schema.allOf=[...$.map(S=>({...this.target==="draft-7"?{type:"string"}:{},pattern:S.source}))])}break}case"number":{const b=w,{minimum:y,maximum:v,format:T,multipleOf:A,exclusiveMaximum:I,exclusiveMinimum:$}=e._zod.bag;typeof T=="string"&&T.includes("int")?b.type="integer":b.type="number",typeof $=="number"&&(b.exclusiveMinimum=$),typeof y=="number"&&(b.minimum=y,typeof $=="number"&&($>=y?delete b.minimum:delete b.exclusiveMinimum)),typeof I=="number"&&(b.exclusiveMaximum=I),typeof v=="number"&&(b.maximum=v,typeof I=="number"&&(I<=v?delete b.maximum:delete b.exclusiveMaximum)),typeof A=="number"&&(b.multipleOf=A);break}case"boolean":{const b=w;b.type="boolean";break}case"bigint":{if(this.unrepresentable==="throw")throw new Error("BigInt cannot be represented in JSON Schema");break}case"symbol":{if(this.unrepresentable==="throw")throw new Error("Symbols cannot be represented in JSON Schema");break}case"null":{w.type="null";break}case"any":break;case"unknown":break;case"undefined":{if(this.unrepresentable==="throw")throw new Error("Undefined cannot be represented in JSON Schema");break}case"void":{if(this.unrepresentable==="throw")throw new Error("Void cannot be represented in JSON Schema");break}case"never":{w.not={};break}case"date":{if(this.unrepresentable==="throw")throw new Error("Date cannot be represented in JSON Schema");break}case"array":{const b=w,{minimum:y,maximum:v}=e._zod.bag;typeof y=="number"&&(b.minItems=y),typeof v=="number"&&(b.maxItems=v),b.type="array",b.items=this.process(s.element,{...m,path:[...m.path,"items"]});break}case"object":{const b=w;b.type="object",b.properties={};const y=s.shape;for(const A in y)b.properties[A]=this.process(y[A],{...m,path:[...m.path,"properties",A]});const v=new Set(Object.keys(y)),T=new Set([...v].filter(A=>{const I=s.shape[A]._zod;return this.io==="input"?I.optin===void 0:I.optout===void 0}));T.size>0&&(b.required=Array.from(T)),((f=s.catchall)==null?void 0:f._zod.def.type)==="never"?b.additionalProperties=!1:s.catchall?s.catchall&&(b.additionalProperties=this.process(s.catchall,{...m,path:[...m.path,"additionalProperties"]})):this.io==="output"&&(b.additionalProperties=!1);break}case"union":{const b=w;b.anyOf=s.options.map((y,v)=>this.process(y,{...m,path:[...m.path,"anyOf",v]}));break}case"intersection":{const b=w,y=this.process(s.left,{...m,path:[...m.path,"allOf",0]}),v=this.process(s.right,{...m,path:[...m.path,"allOf",1]}),T=I=>"allOf"in I&&Object.keys(I).length===1,A=[...T(y)?y.allOf:[y],...T(v)?v.allOf:[v]];b.allOf=A;break}case"tuple":{const b=w;b.type="array";const y=s.items.map((A,I)=>this.process(A,{...m,path:[...m.path,"prefixItems",I]}));if(this.target==="draft-2020-12"?b.prefixItems=y:b.items=y,s.rest){const A=this.process(s.rest,{...m,path:[...m.path,"items"]});this.target==="draft-2020-12"?b.items=A:b.additionalItems=A}s.rest&&(b.items=this.process(s.rest,{...m,path:[...m.path,"items"]}));const{minimum:v,maximum:T}=e._zod.bag;typeof v=="number"&&(b.minItems=v),typeof T=="number"&&(b.maxItems=T);break}case"record":{const b=w;b.type="object",b.propertyNames=this.process(s.keyType,{...m,path:[...m.path,"propertyNames"]}),b.additionalProperties=this.process(s.valueType,{...m,path:[...m.path,"additionalProperties"]});break}case"map":{if(this.unrepresentable==="throw")throw new Error("Map cannot be represented in JSON Schema");break}case"set":{if(this.unrepresentable==="throw")throw new Error("Set cannot be represented in JSON Schema");break}case"enum":{const b=w,y=bb(s.entries);y.every(v=>typeof v=="number")&&(b.type="number"),y.every(v=>typeof v=="string")&&(b.type="string"),b.enum=y;break}case"literal":{const b=w,y=[];for(const v of s.values)if(v===void 0){if(this.unrepresentable==="throw")throw new Error("Literal `undefined` cannot be represented in JSON Schema")}else if(typeof v=="bigint"){if(this.unrepresentable==="throw")throw new Error("BigInt literals cannot be represented in JSON Schema");y.push(Number(v))}else y.push(v);if(y.length!==0)if(y.length===1){const v=y[0];b.type=v===null?"null":typeof v,b.const=v}else y.every(v=>typeof v=="number")&&(b.type="number"),y.every(v=>typeof v=="string")&&(b.type="string"),y.every(v=>typeof v=="boolean")&&(b.type="string"),y.every(v=>v===null)&&(b.type="null"),b.enum=y;break}case"file":{const b=w,y={type:"string",format:"binary",contentEncoding:"binary"},{minimum:v,maximum:T,mime:A}=e._zod.bag;v!==void 0&&(y.minLength=v),T!==void 0&&(y.maxLength=T),A?A.length===1?(y.contentMediaType=A[0],Object.assign(b,y)):b.anyOf=A.map(I=>({...y,contentMediaType:I})):Object.assign(b,y);break}case"transform":{if(this.unrepresentable==="throw")throw new Error("Transforms cannot be represented in JSON Schema");break}case"nullable":{const b=this.process(s.innerType,m);w.anyOf=[b,{type:"null"}];break}case"nonoptional":{this.process(s.innerType,m),o.ref=s.innerType;break}case"success":{const b=w;b.type="boolean";break}case"default":{this.process(s.innerType,m),o.ref=s.innerType,w.default=JSON.parse(JSON.stringify(s.defaultValue));break}case"prefault":{this.process(s.innerType,m),o.ref=s.innerType,this.io==="input"&&(w._prefault=JSON.parse(JSON.stringify(s.defaultValue)));break}case"catch":{this.process(s.innerType,m),o.ref=s.innerType;let b;try{b=s.catchValue(void 0)}catch{throw new Error("Dynamic catch values are not supported in JSON Schema")}w.default=b;break}case"nan":{if(this.unrepresentable==="throw")throw new Error("NaN cannot be represented in JSON Schema");break}case"template_literal":{const b=w,y=e._zod.pattern;if(!y)throw new Error("Pattern not found in template literal");b.type="string",b.pattern=y.source;break}case"pipe":{const b=this.io==="input"?s.in._zod.def.type==="transform"?s.out:s.in:s.out;this.process(b,m),o.ref=b;break}case"readonly":{this.process(s.innerType,m),o.ref=s.innerType,w.readOnly=!0;break}case"promise":{this.process(s.innerType,m),o.ref=s.innerType;break}case"optional":{this.process(s.innerType,m),o.ref=s.innerType;break}case"lazy":{const b=e._zod.innerType;this.process(b,m),o.ref=b;break}case"custom":{if(this.unrepresentable==="throw")throw new Error("Custom types cannot be represented in JSON Schema");break}}}}const l=this.metadataRegistry.get(e);return l&&Object.assign(o.schema,l),this.io==="input"&&Lt(e)&&(delete o.schema.examples,delete o.schema.default),this.io==="input"&&o.schema._prefault&&((r=o.schema).default??(r.default=o.schema._prefault)),delete o.schema._prefault,this.seen.get(e).schema}emit(e,n){var u,d,h,f,m,g;const r={cycles:(n==null?void 0:n.cycles)??"ref",reused:(n==null?void 0:n.reused)??"inline",external:(n==null?void 0:n.external)??void 0},s=this.seen.get(e);if(!s)throw new Error("Unprocessed schema. This is a bug in Zod.");const i=w=>{var A;const b=this.target==="draft-2020-12"?"$defs":"definitions";if(r.external){const I=(A=r.external.registry.get(w[0]))==null?void 0:A.id,$=r.external.uri??(M=>M);if(I)return{ref:$(I)};const S=w[1].defId??w[1].schema.id??`schema${this.counter++}`;return w[1].defId=S,{defId:S,ref:`${$("__shared")}#/${b}/${S}`}}if(w[1]===s)return{ref:"#"};const v=`#/${b}/`,T=w[1].schema.id??`__schema${this.counter++}`;return{defId:T,ref:v+T}},a=w=>{if(w[1].schema.$ref)return;const b=w[1],{ref:y,defId:v}=i(w);b.def={...b.schema},v&&(b.defId=v);const T=b.schema;for(const A in T)delete T[A];T.$ref=y};if(r.cycles==="throw")for(const w of this.seen.entries()){const b=w[1];if(b.cycle)throw new Error(`Cycle detected: #/${(u=b.cycle)==null?void 0:u.join("/")}/<root>

Set the \`cycles\` parameter to \`"ref"\` to resolve cyclical schemas with defs.`)}for(const w of this.seen.entries()){const b=w[1];if(e===w[0]){a(w);continue}if(r.external){const v=(d=r.external.registry.get(w[0]))==null?void 0:d.id;if(e!==w[0]&&v){a(w);continue}}if((h=this.metadataRegistry.get(w[0]))==null?void 0:h.id){a(w);continue}if(b.cycle){a(w);continue}if(b.count>1&&r.reused==="ref"){a(w);continue}}const o=(w,b)=>{const y=this.seen.get(w),v=y.def??y.schema,T={...v};if(y.ref===null)return;const A=y.ref;if(y.ref=null,A){o(A,b);const I=this.seen.get(A).schema;I.$ref&&b.target==="draft-7"?(v.allOf=v.allOf??[],v.allOf.push(I)):(Object.assign(v,I),Object.assign(v,T))}y.isParent||this.override({zodSchema:w,jsonSchema:v,path:y.path??[]})};for(const w of[...this.seen.entries()].reverse())o(w[0],{target:this.target});const c={};if(this.target==="draft-2020-12"?c.$schema="https://json-schema.org/draft/2020-12/schema":this.target==="draft-7"?c.$schema="http://json-schema.org/draft-07/schema#":console.warn(`Invalid target: ${this.target}`),(f=r.external)!=null&&f.uri){const w=(m=r.external.registry.get(e))==null?void 0:m.id;if(!w)throw new Error("Schema is missing an `id` property");c.$id=r.external.uri(w)}Object.assign(c,s.def);const l=((g=r.external)==null?void 0:g.defs)??{};for(const w of this.seen.entries()){const b=w[1];b.def&&b.defId&&(l[b.defId]=b.def)}r.external||Object.keys(l).length>0&&(this.target==="draft-2020-12"?c.$defs=l:c.definitions=l);try{return JSON.parse(JSON.stringify(c))}catch{throw new Error("Error converting schema to JSON.")}}}function nf(t,e){if(t instanceof rm){const r=new Ly(e),s={};for(const o of t._idmap.entries()){const[c,l]=o;r.process(l)}const i={},a={registry:t,uri:e==null?void 0:e.uri,defs:s};for(const o of t._idmap.entries()){const[c,l]=o;i[c]=r.emit(l,{...e,external:a})}if(Object.keys(s).length>0){const o=r.target==="draft-2020-12"?"$defs":"definitions";i.__shared={[o]:s}}return{schemas:i}}const n=new Ly(e);return n.process(t),n.emit(t,e)}function Lt(t,e){const n=e??{seen:new Set};if(n.seen.has(t))return!1;n.seen.add(t);const s=t._zod.def;switch(s.type){case"string":case"number":case"bigint":case"boolean":case"date":case"symbol":case"undefined":case"null":case"any":case"unknown":case"never":case"void":case"literal":case"enum":case"nan":case"file":case"template_literal":return!1;case"array":return Lt(s.element,n);case"object":{for(const i in s.shape)if(Lt(s.shape[i],n))return!0;return!1}case"union":{for(const i of s.options)if(Lt(i,n))return!0;return!1}case"intersection":return Lt(s.left,n)||Lt(s.right,n);case"tuple":{for(const i of s.items)if(Lt(i,n))return!0;return!!(s.rest&&Lt(s.rest,n))}case"record":return Lt(s.keyType,n)||Lt(s.valueType,n);case"map":return Lt(s.keyType,n)||Lt(s.valueType,n);case"set":return Lt(s.valueType,n);case"promise":case"optional":case"nonoptional":case"nullable":case"readonly":return Lt(s.innerType,n);case"lazy":return Lt(s.getter(),n);case"default":return Lt(s.innerType,n);case"prefault":return Lt(s.innerType,n);case"custom":return!1;case"transform":return!0;case"pipe":return Lt(s.in,n)||Lt(s.out,n);case"success":return!1;case"catch":return!1}throw new Error(`Unknown schema type: ${s.type}`)}function it(t){if(typeof t!="object"||t===null)return!1;const e=t;if(!("_zod"in e))return!1;const n=e._zod;return typeof n=="object"&&n!==null&&"def"in n}function Ct(t){if(typeof t!="object"||t===null)return!1;const e=t;if(!("_def"in e)||"_zod"in e)return!1;const n=e._def;return typeof n=="object"&&n!=null&&"typeName"in n}function ON(t){return it(t)&&console.warn("[WARNING] Attempting to use Zod 4 schema in a context where Zod 3 schema is expected. This may cause unexpected behavior."),Ct(t)}function ar(t){return!t||typeof t!="object"||Array.isArray(t)?!1:!!(it(t)||Ct(t))}function Hb(t){return typeof t=="object"&&t!==null&&"_def"in t&&typeof t._def=="object"&&t._def!==null&&"typeName"in t._def&&t._def.typeName==="ZodLiteral"}function qb(t){return it(t)?typeof t=="object"&&t!==null&&"_zod"in t&&typeof t._zod=="object"&&t._zod!==null&&"def"in t._zod&&typeof t._zod.def=="object"&&t._zod.def!==null&&"type"in t._zod.def&&t._zod.def.type==="literal":!1}function $N(t){return!!(Hb(t)||qb(t))}async function sm(t,e){if(it(t))try{return{success:!0,data:await Cb(t,e)}}catch(n){return{success:!1,error:n}}if(Ct(t))return await t.safeParseAsync(e);throw new Error("Schema must be an instance of z3.ZodType or z4.$ZodType")}async function Zu(t,e){if(it(t))return await Cb(t,e);if(Ct(t))return await t.parseAsync(e);throw new Error("Schema must be an instance of z3.ZodType or z4.$ZodType")}function Jb(t,e){if(it(t))try{return{success:!0,data:Bu(t,e)}}catch(n){return{success:!1,error:n}}if(Ct(t))return t.safeParse(e);throw new Error("Schema must be an instance of z3.ZodType or z4.$ZodType")}function cs(t,e){if(it(t))return Bu(t,e);if(Ct(t))return t.parse(e);throw new Error("Schema must be an instance of z3.ZodType or z4.$ZodType")}function ki(t){var e;if(it(t))return(e=Wt.get(t))==null?void 0:e.description;if(Ct(t)||"description"in t&&typeof t.description=="string")return t.description}function RN(t){if(!ar(t))return!1;if(Ct(t)){const e=t._def;if(e.typeName==="ZodObject"){const n=t;return!n.shape||Object.keys(n.shape).length===0}if(e.typeName==="ZodRecord")return!0}if(it(t)){const e=t._zod.def;if(e.type==="object"){const n=t;return!n.shape||Object.keys(n.shape).length===0}if(e.type==="record")return!0}return typeof t=="object"&&t!==null&&!("shape"in t)}function im(t){return ar(t)?Ct(t)?t._def.typeName==="ZodString":it(t)?t._zod.def.type==="string":!1:!1}function am(t){return typeof t=="object"&&t!==null&&"_def"in t&&typeof t._def=="object"&&t._def!==null&&"typeName"in t._def&&t._def.typeName==="ZodObject"}function Vr(t){return it(t)?typeof t=="object"&&t!==null&&"_zod"in t&&typeof t._zod=="object"&&t._zod!==null&&"def"in t._zod&&typeof t._zod.def=="object"&&t._zod.def!==null&&"type"in t._zod.def&&t._zod.def.type==="object":!1}function Vu(t){return it(t)?typeof t=="object"&&t!==null&&"_zod"in t&&typeof t._zod=="object"&&t._zod!==null&&"def"in t._zod&&typeof t._zod.def=="object"&&t._zod.def!==null&&"type"in t._zod.def&&t._zod.def.type==="array":!1}function Kb(t){return it(t)?typeof t=="object"&&t!==null&&"_zod"in t&&typeof t._zod=="object"&&t._zod!==null&&"def"in t._zod&&typeof t._zod.def=="object"&&t._zod.def!==null&&"type"in t._zod.def&&t._zod.def.type==="optional":!1}function Xb(t){return it(t)?typeof t=="object"&&t!==null&&"_zod"in t&&typeof t._zod=="object"&&t._zod!==null&&"def"in t._zod&&typeof t._zod.def=="object"&&t._zod.def!==null&&"type"in t._zod.def&&t._zod.def.type==="nullable":!1}function In(t){return!!(am(t)||Vr(t))}function ya(t){if(Ct(t))return t.shape;if(it(t))return t._zod.def.shape;throw new Error("Schema must be an instance of z3.ZodObject or z4.$ZodObject")}function Yb(t,e){if(Ct(t))return t.extend(e);if(it(t))return Tb(t,e);throw new Error("Schema must be an instance of z3.ZodObject or z4.$ZodObject")}function Gu(t){if(Ct(t))return t.partial();if(it(t))return Sb(nm,t,void 0);throw new Error("Schema must be an instance of z3.ZodObject or z4.$ZodObject")}function Wl(t,e=!1){if(Ct(t))return t.strict();if(Vr(t)){const n=t._zod.def.shape;if(e)for(const[i,a]of Object.entries(t._zod.def.shape)){if(Vr(a)){const c=Wl(a,e);n[i]=c}else if(Vu(a)){let c=a._zod.def.element;Vr(c)&&(c=Wl(c,e)),n[i]=on(a,{...a._zod.def,element:c})}else n[i]=a;const o=Wt.get(a);o&&Wt.add(n[i],o)}const r=on(t,{...t._zod.def,shape:n,catchall:Vb(Bb)}),s=Wt.get(t);return s&&Wt.add(r,s),r}throw new Error("Schema must be an instance of z3.ZodObject or z4.$ZodObject")}function rf(t,e=!1){if(am(t))return t.passthrough();if(Vr(t)){const n=t._zod.def.shape;if(e)for(const[i,a]of Object.entries(t._zod.def.shape)){if(Vr(a)){const c=rf(a,e);n[i]=c}else if(Vu(a)){let c=a._zod.def.element;Vr(c)&&(c=rf(c,e)),n[i]=on(a,{...a._zod.def,element:c})}else n[i]=a;const o=Wt.get(a);o&&Wt.add(n[i],o)}const r=on(t,{...t._zod.def,shape:n,catchall:Zb(Fb)}),s=Wt.get(t);return s&&Wt.add(r,s),r}throw new Error("Schema must be an instance of z3.ZodObject or z4.$ZodObject")}function Wu(t){if(Ct(t))try{const e=t.parse(void 0);return()=>e}catch{return}if(it(t))try{const e=Bu(t,void 0);return()=>e}catch{return}}function NN(t){return Ct(t)&&"typeName"in t._def&&t._def.typeName==="ZodEffects"}function PN(t){return it(t)&&t._zod.def.type==="pipe"}function ri(t,e,n){const r=n.get(t);if(r!==void 0)return r;if(Ct(t))return NN(t)?ri(t._def.schema,e,n):t;if(it(t)){let s=t;if(PN(t)&&(s=ri(t._zod.def.in,e,n)),e){if(Vr(s)){const a={};for(const[o,c]of Object.entries(s._zod.def.shape))a[o]=ri(c,e,n);s=on(s,{...s._zod.def,shape:a})}else if(Vu(s)){const a=ri(s._zod.def.element,e,n);s=on(s,{...s._zod.def,element:a})}else if(Kb(s)){const a=ri(s._zod.def.innerType,e,n);s=on(s,{...s._zod.def,innerType:a})}else if(Xb(s)){const a=ri(s._zod.def.innerType,e,n);s=on(s,{...s._zod.def,innerType:a})}}const i=Wt.get(t);return i&&Wt.add(s,i),n.set(t,s),s}throw new Error("Schema must be an instance of z3.ZodType or z4.$ZodType")}function Qb(t,e=!1){return ri(t,e,new WeakMap)}function e0(t,e){if(Ct(t)){const n=ya(t),r={};for(const[s,i]of Object.entries(n))e(s,i)?r[s]=i.optional():r[s]=i;return t.extend(r)}if(it(t)){const n=ya(t),r={...t._zod.def.shape};for(const[a,o]of Object.entries(n))e(a,o)&&(r[a]=new nm({type:"optional",innerType:o}));const s=on(t,{...t._zod.def,shape:r}),i=Wt.get(t);return i&&Wt.add(s,i),s}throw new Error("Schema must be an instance of z3.ZodObject or z4.$ZodObject")}function t0(t){return t instanceof Error&&(t.constructor.name==="ZodError"||t.constructor.name==="$ZodError")}function Kd(t){return t.replace(/[^a-zA-Z-_0-9]/g,"_")}const MN=["*","_","`"];function LN(t){let e="";for(const[n,r]of Object.entries(t))e+=`	classDef ${n} ${r};
`;return e}function jN(t,e,n){const{firstNode:r,lastNode:s,nodeColors:i,withStyles:a=!0,curveStyle:o="linear",wrapLabelNWords:c=9}=n??{};let l=a?`%%{init: {'flowchart': {'curve': '${o}'}}}%%
graph TD;
`:`graph TD;
`;if(a){const m="default",g={[m]:"{0}({1})"};r!==void 0&&(g[r]="{0}([{1}]):::first"),s!==void 0&&(g[s]="{0}([{1}]):::last");for(const[w,b]of Object.entries(t)){const y=b.name.split(":").pop()??"";let T=MN.some(I=>y.startsWith(I)&&y.endsWith(I))?`<p>${y}</p>`:y;Object.keys(b.metadata??{}).length&&(T+=`<hr/><small><em>${Object.entries(b.metadata??{}).map(([I,$])=>`${I} = ${$}`).join(`
`)}</em></small>`);const A=(g[w]??g[m]).replace("{0}",Kd(w)).replace("{1}",T);l+=`	${A}
`}}const u={};for(const m of e){const g=m.source.split(":"),w=m.target.split(":"),b=g.filter((y,v)=>y===w[v]).join(":");u[b]||(u[b]=[]),u[b].push(m)}const d=new Set;function h(m){return[...m].sort((g,w)=>g.split(":").length-w.split(":").length)}function f(m,g){const w=m.length===1&&m[0].source===m[0].target;if(g&&!w){const y=g.split(":").pop();if(d.has(g))throw new Error(`Found duplicate subgraph '${y}' at '${g} -- this likely means that you're reusing a subgraph node with the same name. Please adjust your graph to have subgraph nodes with unique names.`);d.add(g),l+=`	subgraph ${y}
`}const b=h(Object.keys(u).filter(y=>y.startsWith(`${g}:`)&&y!==g&&y.split(":").length===g.split(":").length+1));for(const y of b)f(u[y],y);for(const y of m){const{source:v,target:T,data:A,conditional:I}=y;let $="";if(A!==void 0){let S=A;const M=S.split(" ");M.length>c&&(S=Array.from({length:Math.ceil(M.length/c)},(j,P)=>M.slice(P*c,(P+1)*c).join(" ")).join("&nbsp;<br>&nbsp;")),$=I?` -. &nbsp;${S}&nbsp; .-> `:` -- &nbsp;${S}&nbsp; --> `}else $=I?" -.-> ":" --> ";l+=`	${Kd(v)}${$}${Kd(T)};
`}g&&!w&&(l+=`	end
`)}f(u[""]??[],"");for(const m in u)!m.includes(":")&&m!==""&&f(u[m],m);return a&&(l+=LN(i??{})),l}async function DN(t,e){let n=(e==null?void 0:e.backgroundColor)??"white";const r=(e==null?void 0:e.imageType)??"png",s=X1(t);n!==void 0&&(/^#(?:[0-9a-fA-F]{3}){1,2}$/.test(n)||(n=`!${n}`));const i=`https://mermaid.ink/img/${s}?bgColor=${n}&type=${r}`,a=await fetch(i);if(!a.ok)throw new Error(["Failed to render the graph using the Mermaid.INK API.",`Status code: ${a.status}`,`Status text: ${a.statusText}`].join(`
`));return await a.blob()}const UN=Symbol("Let zodToJsonSchema decide on which parser to use"),FN={name:void 0,$refStrategy:"root",basePath:["#"],effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",removeAdditionalStrategy:"passthrough",allowedAdditionalProperties:!0,rejectedAdditionalProperties:!1,definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,definitions:{},errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref",openAiAnyTypeName:"OpenAiAnyType"},BN=t=>({...FN,...t}),zN=t=>{const e=BN(t),n=e.name!==void 0?[...e.basePath,e.definitionPath,e.name]:e.basePath;return{...e,flags:{hasReferencedOpenAiAnyType:!1},currentPath:n,propertyPath:void 0,seen:new Map(Object.entries(e.definitions).map(([r,s])=>[s._def,{def:s._def,path:[...e.basePath,e.definitionPath,r],jsonSchema:void 0}]))}},n0=(t,e)=>{let n=0;for(;n<t.length&&n<e.length&&t[n]===e[n];n++);return[(t.length-n).toString(),...e.slice(n)].join("/")};function qn(t){if(t.target!=="openAi")return{};const e=[...t.basePath,t.definitionPath,t.openAiAnyTypeName];return t.flags.hasReferencedOpenAiAnyType=!0,{$ref:t.$refStrategy==="relative"?n0(e,t.currentPath):e.join("/")}}function r0(t,e,n,r){r!=null&&r.errorMessages&&n&&(t.errorMessage={...t.errorMessage,[e]:n})}function tt(t,e,n,r,s){t[e]=n,r0(t,e,r,s)}var qe;(function(t){t.assertEqual=s=>{};function e(s){}t.assertIs=e;function n(s){throw new Error}t.assertNever=n,t.arrayToEnum=s=>{const i={};for(const a of s)i[a]=a;return i},t.getValidEnumValues=s=>{const i=t.objectKeys(s).filter(o=>typeof s[s[o]]!="number"),a={};for(const o of i)a[o]=s[o];return t.objectValues(a)},t.objectValues=s=>t.objectKeys(s).map(function(i){return s[i]}),t.objectKeys=typeof Object.keys=="function"?s=>Object.keys(s):s=>{const i=[];for(const a in s)Object.prototype.hasOwnProperty.call(s,a)&&i.push(a);return i},t.find=(s,i)=>{for(const a of s)if(i(a))return a},t.isInteger=typeof Number.isInteger=="function"?s=>Number.isInteger(s):s=>typeof s=="number"&&Number.isFinite(s)&&Math.floor(s)===s;function r(s,i=" | "){return s.map(a=>typeof a=="string"?`'${a}'`:a).join(i)}t.joinValues=r,t.jsonStringifyReplacer=(s,i)=>typeof i=="bigint"?i.toString():i})(qe||(qe={}));var jy;(function(t){t.mergeShapes=(e,n)=>({...e,...n})})(jy||(jy={}));const ie=qe.arrayToEnum(["string","nan","number","integer","float","boolean","date","bigint","symbol","function","undefined","null","array","object","unknown","promise","void","never","map","set"]),Os=t=>{switch(typeof t){case"undefined":return ie.undefined;case"string":return ie.string;case"number":return Number.isNaN(t)?ie.nan:ie.number;case"boolean":return ie.boolean;case"function":return ie.function;case"bigint":return ie.bigint;case"symbol":return ie.symbol;case"object":return Array.isArray(t)?ie.array:t===null?ie.null:t.then&&typeof t.then=="function"&&t.catch&&typeof t.catch=="function"?ie.promise:typeof Map<"u"&&t instanceof Map?ie.map:typeof Set<"u"&&t instanceof Set?ie.set:typeof Date<"u"&&t instanceof Date?ie.date:ie.object;default:return ie.unknown}},q=qe.arrayToEnum(["invalid_type","invalid_literal","custom","invalid_union","invalid_union_discriminator","invalid_enum_value","unrecognized_keys","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite"]);class or extends Error{get errors(){return this.issues}constructor(e){super(),this.issues=[],this.addIssue=r=>{this.issues=[...this.issues,r]},this.addIssues=(r=[])=>{this.issues=[...this.issues,...r]};const n=new.target.prototype;Object.setPrototypeOf?Object.setPrototypeOf(this,n):this.__proto__=n,this.name="ZodError",this.issues=e}format(e){const n=e||function(i){return i.message},r={_errors:[]},s=i=>{for(const a of i.issues)if(a.code==="invalid_union")a.unionErrors.map(s);else if(a.code==="invalid_return_type")s(a.returnTypeError);else if(a.code==="invalid_arguments")s(a.argumentsError);else if(a.path.length===0)r._errors.push(n(a));else{let o=r,c=0;for(;c<a.path.length;){const l=a.path[c];c===a.path.length-1?(o[l]=o[l]||{_errors:[]},o[l]._errors.push(n(a))):o[l]=o[l]||{_errors:[]},o=o[l],c++}}};return s(this),r}static assert(e){if(!(e instanceof or))throw new Error(`Not a ZodError: ${e}`)}toString(){return this.message}get message(){return JSON.stringify(this.issues,qe.jsonStringifyReplacer,2)}get isEmpty(){return this.issues.length===0}flatten(e=n=>n.message){const n={},r=[];for(const s of this.issues)if(s.path.length>0){const i=s.path[0];n[i]=n[i]||[],n[i].push(e(s))}else r.push(e(s));return{formErrors:r,fieldErrors:n}}get formErrors(){return this.flatten()}}or.create=t=>new or(t);const Co=(t,e)=>{let n;switch(t.code){case q.invalid_type:t.received===ie.undefined?n="Required":n=`Expected ${t.expected}, received ${t.received}`;break;case q.invalid_literal:n=`Invalid literal value, expected ${JSON.stringify(t.expected,qe.jsonStringifyReplacer)}`;break;case q.unrecognized_keys:n=`Unrecognized key(s) in object: ${qe.joinValues(t.keys,", ")}`;break;case q.invalid_union:n="Invalid input";break;case q.invalid_union_discriminator:n=`Invalid discriminator value. Expected ${qe.joinValues(t.options)}`;break;case q.invalid_enum_value:n=`Invalid enum value. Expected ${qe.joinValues(t.options)}, received '${t.received}'`;break;case q.invalid_arguments:n="Invalid function arguments";break;case q.invalid_return_type:n="Invalid function return type";break;case q.invalid_date:n="Invalid date";break;case q.invalid_string:typeof t.validation=="object"?"includes"in t.validation?(n=`Invalid input: must include "${t.validation.includes}"`,typeof t.validation.position=="number"&&(n=`${n} at one or more positions greater than or equal to ${t.validation.position}`)):"startsWith"in t.validation?n=`Invalid input: must start with "${t.validation.startsWith}"`:"endsWith"in t.validation?n=`Invalid input: must end with "${t.validation.endsWith}"`:qe.assertNever(t.validation):t.validation!=="regex"?n=`Invalid ${t.validation}`:n="Invalid";break;case q.too_small:t.type==="array"?n=`Array must contain ${t.exact?"exactly":t.inclusive?"at least":"more than"} ${t.minimum} element(s)`:t.type==="string"?n=`String must contain ${t.exact?"exactly":t.inclusive?"at least":"over"} ${t.minimum} character(s)`:t.type==="number"?n=`Number must be ${t.exact?"exactly equal to ":t.inclusive?"greater than or equal to ":"greater than "}${t.minimum}`:t.type==="bigint"?n=`Number must be ${t.exact?"exactly equal to ":t.inclusive?"greater than or equal to ":"greater than "}${t.minimum}`:t.type==="date"?n=`Date must be ${t.exact?"exactly equal to ":t.inclusive?"greater than or equal to ":"greater than "}${new Date(Number(t.minimum))}`:n="Invalid input";break;case q.too_big:t.type==="array"?n=`Array must contain ${t.exact?"exactly":t.inclusive?"at most":"less than"} ${t.maximum} element(s)`:t.type==="string"?n=`String must contain ${t.exact?"exactly":t.inclusive?"at most":"under"} ${t.maximum} character(s)`:t.type==="number"?n=`Number must be ${t.exact?"exactly":t.inclusive?"less than or equal to":"less than"} ${t.maximum}`:t.type==="bigint"?n=`BigInt must be ${t.exact?"exactly":t.inclusive?"less than or equal to":"less than"} ${t.maximum}`:t.type==="date"?n=`Date must be ${t.exact?"exactly":t.inclusive?"smaller than or equal to":"smaller than"} ${new Date(Number(t.maximum))}`:n="Invalid input";break;case q.custom:n="Invalid input";break;case q.invalid_intersection_types:n="Intersection results could not be merged";break;case q.not_multiple_of:n=`Number must be a multiple of ${t.multipleOf}`;break;case q.not_finite:n="Number must be finite";break;default:n=e.defaultError,qe.assertNever(t)}return{message:n}};let ZN=Co;function sf(){return ZN}const af=t=>{const{data:e,path:n,errorMaps:r,issueData:s}=t,i=[...n,...s.path||[]],a={...s,path:i};if(s.message!==void 0)return{...s,path:i,message:s.message};let o="";const c=r.filter(l=>!!l).slice().reverse();for(const l of c)o=l(a,{data:e,defaultError:o}).message;return{...s,path:i,message:o}};function te(t,e){const n=sf(),r=af({issueData:e,data:t.data,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,n,n===Co?void 0:Co].filter(s=>!!s)});t.common.issues.push(r)}class vn{constructor(){this.value="valid"}dirty(){this.value==="valid"&&(this.value="dirty")}abort(){this.value!=="aborted"&&(this.value="aborted")}static mergeArray(e,n){const r=[];for(const s of n){if(s.status==="aborted")return Ce;s.status==="dirty"&&e.dirty(),r.push(s.value)}return{status:e.value,value:r}}static async mergeObjectAsync(e,n){const r=[];for(const s of n){const i=await s.key,a=await s.value;r.push({key:i,value:a})}return vn.mergeObjectSync(e,r)}static mergeObjectSync(e,n){const r={};for(const s of n){const{key:i,value:a}=s;if(i.status==="aborted"||a.status==="aborted")return Ce;i.status==="dirty"&&e.dirty(),a.status==="dirty"&&e.dirty(),i.value!=="__proto__"&&(typeof a.value<"u"||s.alwaysSet)&&(r[i.value]=a.value)}return{status:e.value,value:r}}}const Ce=Object.freeze({status:"aborted"}),za=t=>({status:"dirty",value:t}),Nn=t=>({status:"valid",value:t}),Dy=t=>t.status==="aborted",Uy=t=>t.status==="dirty",_a=t=>t.status==="valid",Hl=t=>typeof Promise<"u"&&t instanceof Promise;var pe;(function(t){t.errToObj=e=>typeof e=="string"?{message:e}:e||{},t.toString=e=>typeof e=="string"?e:e==null?void 0:e.message})(pe||(pe={}));class qr{constructor(e,n,r,s){this._cachedPath=[],this.parent=e,this.data=n,this._path=r,this._key=s}get path(){return this._cachedPath.length||(Array.isArray(this._key)?this._cachedPath.push(...this._path,...this._key):this._cachedPath.push(...this._path,this._key)),this._cachedPath}}const Fy=(t,e)=>{if(_a(e))return{success:!0,data:e.value};if(!t.common.issues.length)throw new Error("Validation failed but no issues detected.");return{success:!1,get error(){if(this._error)return this._error;const n=new or(t.common.issues);return this._error=n,this._error}}};function Le(t){if(!t)return{};const{errorMap:e,invalid_type_error:n,required_error:r,description:s}=t;if(e&&(n||r))throw new Error(`Can't use "invalid_type_error" or "required_error" in conjunction with custom error map.`);return e?{errorMap:e,description:s}:{errorMap:(a,o)=>{const{message:c}=t;return a.code==="invalid_enum_value"?{message:c??o.defaultError}:typeof o.data>"u"?{message:c??r??o.defaultError}:a.code!=="invalid_type"?{message:o.defaultError}:{message:c??n??o.defaultError}},description:s}}let Be=class{get description(){return this._def.description}_getType(e){return Os(e.data)}_getOrReturnCtx(e,n){return n||{common:e.parent.common,data:e.data,parsedType:Os(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}_processInputParams(e){return{status:new vn,ctx:{common:e.parent.common,data:e.data,parsedType:Os(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}}_parseSync(e){const n=this._parse(e);if(Hl(n))throw new Error("Synchronous parse encountered promise.");return n}_parseAsync(e){const n=this._parse(e);return Promise.resolve(n)}parse(e,n){const r=this.safeParse(e,n);if(r.success)return r.data;throw r.error}safeParse(e,n){const r={common:{issues:[],async:(n==null?void 0:n.async)??!1,contextualErrorMap:n==null?void 0:n.errorMap},path:(n==null?void 0:n.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:Os(e)},s=this._parseSync({data:e,path:r.path,parent:r});return Fy(r,s)}"~validate"(e){var r,s;const n={common:{issues:[],async:!!this["~standard"].async},path:[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:Os(e)};if(!this["~standard"].async)try{const i=this._parseSync({data:e,path:[],parent:n});return _a(i)?{value:i.value}:{issues:n.common.issues}}catch(i){(s=(r=i==null?void 0:i.message)==null?void 0:r.toLowerCase())!=null&&s.includes("encountered")&&(this["~standard"].async=!0),n.common={issues:[],async:!0}}return this._parseAsync({data:e,path:[],parent:n}).then(i=>_a(i)?{value:i.value}:{issues:n.common.issues})}async parseAsync(e,n){const r=await this.safeParseAsync(e,n);if(r.success)return r.data;throw r.error}async safeParseAsync(e,n){const r={common:{issues:[],contextualErrorMap:n==null?void 0:n.errorMap,async:!0},path:(n==null?void 0:n.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:Os(e)},s=this._parse({data:e,path:r.path,parent:r}),i=await(Hl(s)?s:Promise.resolve(s));return Fy(r,i)}refine(e,n){const r=s=>typeof n=="string"||typeof n>"u"?{message:n}:typeof n=="function"?n(s):n;return this._refinement((s,i)=>{const a=e(s),o=()=>i.addIssue({code:q.custom,...r(s)});return typeof Promise<"u"&&a instanceof Promise?a.then(c=>c?!0:(o(),!1)):a?!0:(o(),!1)})}refinement(e,n){return this._refinement((r,s)=>e(r)?!0:(s.addIssue(typeof n=="function"?n(r,s):n),!1))}_refinement(e){return new va({schema:this,typeName:U.ZodEffects,effect:{type:"refinement",refinement:e}})}superRefine(e){return this._refinement(e)}constructor(e){this.spa=this.safeParseAsync,this._def=e,this.parse=this.parse.bind(this),this.safeParse=this.safeParse.bind(this),this.parseAsync=this.parseAsync.bind(this),this.safeParseAsync=this.safeParseAsync.bind(this),this.spa=this.spa.bind(this),this.refine=this.refine.bind(this),this.refinement=this.refinement.bind(this),this.superRefine=this.superRefine.bind(this),this.optional=this.optional.bind(this),this.nullable=this.nullable.bind(this),this.nullish=this.nullish.bind(this),this.array=this.array.bind(this),this.promise=this.promise.bind(this),this.or=this.or.bind(this),this.and=this.and.bind(this),this.transform=this.transform.bind(this),this.brand=this.brand.bind(this),this.default=this.default.bind(this),this.catch=this.catch.bind(this),this.describe=this.describe.bind(this),this.pipe=this.pipe.bind(this),this.readonly=this.readonly.bind(this),this.isNullable=this.isNullable.bind(this),this.isOptional=this.isOptional.bind(this),this["~standard"]={version:1,vendor:"zod",validate:n=>this["~validate"](n)}}optional(){return zs.create(this,this._def)}nullable(){return ba.create(this,this._def)}nullish(){return this.nullable().optional()}array(){return wa.create(this)}promise(){return No.create(this,this._def)}or(e){return Kl.create([this,e],this._def)}and(e){return Xl.create(this,e,this._def)}transform(e){return new va({...Le(this._def),schema:this,typeName:U.ZodEffects,effect:{type:"transform",transform:e}})}default(e){const n=typeof e=="function"?e:()=>e;return new mf({...Le(this._def),innerType:this,defaultValue:n,typeName:U.ZodDefault})}brand(){return new fP({typeName:U.ZodBranded,type:this,...Le(this._def)})}catch(e){const n=typeof e=="function"?e:()=>e;return new gf({...Le(this._def),innerType:this,catchValue:n,typeName:U.ZodCatch})}describe(e){const n=this.constructor;return new n({...this._def,description:e})}pipe(e){return cm.create(this,e)}readonly(){return yf.create(this)}isOptional(){return this.safeParse(void 0).success}isNullable(){return this.safeParse(null).success}};const VN=/^c[^\s-]{8,}$/i,GN=/^[0-9a-z]+$/,WN=/^[0-9A-HJKMNP-TV-Z]{26}$/i,HN=/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/i,qN=/^[a-z0-9_-]{21}$/i,JN=/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/,KN=/^[-+]?P(?!$)(?:(?:[-+]?\d+Y)|(?:[-+]?\d+[.,]\d+Y$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:(?:[-+]?\d+W)|(?:[-+]?\d+[.,]\d+W$))?(?:(?:[-+]?\d+D)|(?:[-+]?\d+[.,]\d+D$))?(?:T(?=[\d+-])(?:(?:[-+]?\d+H)|(?:[-+]?\d+[.,]\d+H$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:[-+]?\d+(?:[.,]\d+)?S)?)??$/,XN=/^(?!\.)(?!.*\.\.)([A-Z0-9_'+\-\.]*)[A-Z0-9_+-]@([A-Z0-9][A-Z0-9\-]*\.)+[A-Z]{2,}$/i,YN="^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$";let Xd;const QN=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,eP=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,tP=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))$/,nP=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,rP=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,sP=/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,s0="((\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-((0[13578]|1[02])-(0[1-9]|[12]\\d|3[01])|(0[469]|11)-(0[1-9]|[12]\\d|30)|(02)-(0[1-9]|1\\d|2[0-8])))",iP=new RegExp(`^${s0}$`);function i0(t){let e="[0-5]\\d";t.precision?e=`${e}\\.\\d{${t.precision}}`:t.precision==null&&(e=`${e}(\\.\\d+)?`);const n=t.precision?"+":"?";return`([01]\\d|2[0-3]):[0-5]\\d(:${e})${n}`}function aP(t){return new RegExp(`^${i0(t)}$`)}function oP(t){let e=`${s0}T${i0(t)}`;const n=[];return n.push(t.local?"Z?":"Z"),t.offset&&n.push("([+-]\\d{2}:?\\d{2})"),e=`${e}(${n.join("|")})`,new RegExp(`^${e}$`)}function cP(t,e){return!!((e==="v4"||!e)&&QN.test(t)||(e==="v6"||!e)&&tP.test(t))}function lP(t,e){if(!JN.test(t))return!1;try{const[n]=t.split(".");if(!n)return!1;const r=n.replace(/-/g,"+").replace(/_/g,"/").padEnd(n.length+(4-n.length%4)%4,"="),s=JSON.parse(atob(r));return!(typeof s!="object"||s===null||"typ"in s&&(s==null?void 0:s.typ)!=="JWT"||!s.alg||e&&s.alg!==e)}catch{return!1}}function uP(t,e){return!!((e==="v4"||!e)&&eP.test(t)||(e==="v6"||!e)&&nP.test(t))}let ql=class Za extends Be{_parse(e){if(this._def.coerce&&(e.data=String(e.data)),this._getType(e)!==ie.string){const i=this._getOrReturnCtx(e);return te(i,{code:q.invalid_type,expected:ie.string,received:i.parsedType}),Ce}const r=new vn;let s;for(const i of this._def.checks)if(i.kind==="min")e.data.length<i.value&&(s=this._getOrReturnCtx(e,s),te(s,{code:q.too_small,minimum:i.value,type:"string",inclusive:!0,exact:!1,message:i.message}),r.dirty());else if(i.kind==="max")e.data.length>i.value&&(s=this._getOrReturnCtx(e,s),te(s,{code:q.too_big,maximum:i.value,type:"string",inclusive:!0,exact:!1,message:i.message}),r.dirty());else if(i.kind==="length"){const a=e.data.length>i.value,o=e.data.length<i.value;(a||o)&&(s=this._getOrReturnCtx(e,s),a?te(s,{code:q.too_big,maximum:i.value,type:"string",inclusive:!0,exact:!0,message:i.message}):o&&te(s,{code:q.too_small,minimum:i.value,type:"string",inclusive:!0,exact:!0,message:i.message}),r.dirty())}else if(i.kind==="email")XN.test(e.data)||(s=this._getOrReturnCtx(e,s),te(s,{validation:"email",code:q.invalid_string,message:i.message}),r.dirty());else if(i.kind==="emoji")Xd||(Xd=new RegExp(YN,"u")),Xd.test(e.data)||(s=this._getOrReturnCtx(e,s),te(s,{validation:"emoji",code:q.invalid_string,message:i.message}),r.dirty());else if(i.kind==="uuid")HN.test(e.data)||(s=this._getOrReturnCtx(e,s),te(s,{validation:"uuid",code:q.invalid_string,message:i.message}),r.dirty());else if(i.kind==="nanoid")qN.test(e.data)||(s=this._getOrReturnCtx(e,s),te(s,{validation:"nanoid",code:q.invalid_string,message:i.message}),r.dirty());else if(i.kind==="cuid")VN.test(e.data)||(s=this._getOrReturnCtx(e,s),te(s,{validation:"cuid",code:q.invalid_string,message:i.message}),r.dirty());else if(i.kind==="cuid2")GN.test(e.data)||(s=this._getOrReturnCtx(e,s),te(s,{validation:"cuid2",code:q.invalid_string,message:i.message}),r.dirty());else if(i.kind==="ulid")WN.test(e.data)||(s=this._getOrReturnCtx(e,s),te(s,{validation:"ulid",code:q.invalid_string,message:i.message}),r.dirty());else if(i.kind==="url")try{new URL(e.data)}catch{s=this._getOrReturnCtx(e,s),te(s,{validation:"url",code:q.invalid_string,message:i.message}),r.dirty()}else i.kind==="regex"?(i.regex.lastIndex=0,i.regex.test(e.data)||(s=this._getOrReturnCtx(e,s),te(s,{validation:"regex",code:q.invalid_string,message:i.message}),r.dirty())):i.kind==="trim"?e.data=e.data.trim():i.kind==="includes"?e.data.includes(i.value,i.position)||(s=this._getOrReturnCtx(e,s),te(s,{code:q.invalid_string,validation:{includes:i.value,position:i.position},message:i.message}),r.dirty()):i.kind==="toLowerCase"?e.data=e.data.toLowerCase():i.kind==="toUpperCase"?e.data=e.data.toUpperCase():i.kind==="startsWith"?e.data.startsWith(i.value)||(s=this._getOrReturnCtx(e,s),te(s,{code:q.invalid_string,validation:{startsWith:i.value},message:i.message}),r.dirty()):i.kind==="endsWith"?e.data.endsWith(i.value)||(s=this._getOrReturnCtx(e,s),te(s,{code:q.invalid_string,validation:{endsWith:i.value},message:i.message}),r.dirty()):i.kind==="datetime"?oP(i).test(e.data)||(s=this._getOrReturnCtx(e,s),te(s,{code:q.invalid_string,validation:"datetime",message:i.message}),r.dirty()):i.kind==="date"?iP.test(e.data)||(s=this._getOrReturnCtx(e,s),te(s,{code:q.invalid_string,validation:"date",message:i.message}),r.dirty()):i.kind==="time"?aP(i).test(e.data)||(s=this._getOrReturnCtx(e,s),te(s,{code:q.invalid_string,validation:"time",message:i.message}),r.dirty()):i.kind==="duration"?KN.test(e.data)||(s=this._getOrReturnCtx(e,s),te(s,{validation:"duration",code:q.invalid_string,message:i.message}),r.dirty()):i.kind==="ip"?cP(e.data,i.version)||(s=this._getOrReturnCtx(e,s),te(s,{validation:"ip",code:q.invalid_string,message:i.message}),r.dirty()):i.kind==="jwt"?lP(e.data,i.alg)||(s=this._getOrReturnCtx(e,s),te(s,{validation:"jwt",code:q.invalid_string,message:i.message}),r.dirty()):i.kind==="cidr"?uP(e.data,i.version)||(s=this._getOrReturnCtx(e,s),te(s,{validation:"cidr",code:q.invalid_string,message:i.message}),r.dirty()):i.kind==="base64"?rP.test(e.data)||(s=this._getOrReturnCtx(e,s),te(s,{validation:"base64",code:q.invalid_string,message:i.message}),r.dirty()):i.kind==="base64url"?sP.test(e.data)||(s=this._getOrReturnCtx(e,s),te(s,{validation:"base64url",code:q.invalid_string,message:i.message}),r.dirty()):qe.assertNever(i);return{status:r.value,value:e.data}}_regex(e,n,r){return this.refinement(s=>e.test(s),{validation:n,code:q.invalid_string,...pe.errToObj(r)})}_addCheck(e){return new Za({...this._def,checks:[...this._def.checks,e]})}email(e){return this._addCheck({kind:"email",...pe.errToObj(e)})}url(e){return this._addCheck({kind:"url",...pe.errToObj(e)})}emoji(e){return this._addCheck({kind:"emoji",...pe.errToObj(e)})}uuid(e){return this._addCheck({kind:"uuid",...pe.errToObj(e)})}nanoid(e){return this._addCheck({kind:"nanoid",...pe.errToObj(e)})}cuid(e){return this._addCheck({kind:"cuid",...pe.errToObj(e)})}cuid2(e){return this._addCheck({kind:"cuid2",...pe.errToObj(e)})}ulid(e){return this._addCheck({kind:"ulid",...pe.errToObj(e)})}base64(e){return this._addCheck({kind:"base64",...pe.errToObj(e)})}base64url(e){return this._addCheck({kind:"base64url",...pe.errToObj(e)})}jwt(e){return this._addCheck({kind:"jwt",...pe.errToObj(e)})}ip(e){return this._addCheck({kind:"ip",...pe.errToObj(e)})}cidr(e){return this._addCheck({kind:"cidr",...pe.errToObj(e)})}datetime(e){return typeof e=="string"?this._addCheck({kind:"datetime",precision:null,offset:!1,local:!1,message:e}):this._addCheck({kind:"datetime",precision:typeof(e==null?void 0:e.precision)>"u"?null:e==null?void 0:e.precision,offset:(e==null?void 0:e.offset)??!1,local:(e==null?void 0:e.local)??!1,...pe.errToObj(e==null?void 0:e.message)})}date(e){return this._addCheck({kind:"date",message:e})}time(e){return typeof e=="string"?this._addCheck({kind:"time",precision:null,message:e}):this._addCheck({kind:"time",precision:typeof(e==null?void 0:e.precision)>"u"?null:e==null?void 0:e.precision,...pe.errToObj(e==null?void 0:e.message)})}duration(e){return this._addCheck({kind:"duration",...pe.errToObj(e)})}regex(e,n){return this._addCheck({kind:"regex",regex:e,...pe.errToObj(n)})}includes(e,n){return this._addCheck({kind:"includes",value:e,position:n==null?void 0:n.position,...pe.errToObj(n==null?void 0:n.message)})}startsWith(e,n){return this._addCheck({kind:"startsWith",value:e,...pe.errToObj(n)})}endsWith(e,n){return this._addCheck({kind:"endsWith",value:e,...pe.errToObj(n)})}min(e,n){return this._addCheck({kind:"min",value:e,...pe.errToObj(n)})}max(e,n){return this._addCheck({kind:"max",value:e,...pe.errToObj(n)})}length(e,n){return this._addCheck({kind:"length",value:e,...pe.errToObj(n)})}nonempty(e){return this.min(1,pe.errToObj(e))}trim(){return new Za({...this._def,checks:[...this._def.checks,{kind:"trim"}]})}toLowerCase(){return new Za({...this._def,checks:[...this._def.checks,{kind:"toLowerCase"}]})}toUpperCase(){return new Za({...this._def,checks:[...this._def.checks,{kind:"toUpperCase"}]})}get isDatetime(){return!!this._def.checks.find(e=>e.kind==="datetime")}get isDate(){return!!this._def.checks.find(e=>e.kind==="date")}get isTime(){return!!this._def.checks.find(e=>e.kind==="time")}get isDuration(){return!!this._def.checks.find(e=>e.kind==="duration")}get isEmail(){return!!this._def.checks.find(e=>e.kind==="email")}get isURL(){return!!this._def.checks.find(e=>e.kind==="url")}get isEmoji(){return!!this._def.checks.find(e=>e.kind==="emoji")}get isUUID(){return!!this._def.checks.find(e=>e.kind==="uuid")}get isNANOID(){return!!this._def.checks.find(e=>e.kind==="nanoid")}get isCUID(){return!!this._def.checks.find(e=>e.kind==="cuid")}get isCUID2(){return!!this._def.checks.find(e=>e.kind==="cuid2")}get isULID(){return!!this._def.checks.find(e=>e.kind==="ulid")}get isIP(){return!!this._def.checks.find(e=>e.kind==="ip")}get isCIDR(){return!!this._def.checks.find(e=>e.kind==="cidr")}get isBase64(){return!!this._def.checks.find(e=>e.kind==="base64")}get isBase64url(){return!!this._def.checks.find(e=>e.kind==="base64url")}get minLength(){let e=null;for(const n of this._def.checks)n.kind==="min"&&(e===null||n.value>e)&&(e=n.value);return e}get maxLength(){let e=null;for(const n of this._def.checks)n.kind==="max"&&(e===null||n.value<e)&&(e=n.value);return e}};ql.create=t=>new ql({checks:[],typeName:U.ZodString,coerce:(t==null?void 0:t.coerce)??!1,...Le(t)});function dP(t,e){const n=(t.toString().split(".")[1]||"").length,r=(e.toString().split(".")[1]||"").length,s=n>r?n:r,i=Number.parseInt(t.toFixed(s).replace(".","")),a=Number.parseInt(e.toFixed(s).replace(".",""));return i%a/10**s}let of=class cf extends Be{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte,this.step=this.multipleOf}_parse(e){if(this._def.coerce&&(e.data=Number(e.data)),this._getType(e)!==ie.number){const i=this._getOrReturnCtx(e);return te(i,{code:q.invalid_type,expected:ie.number,received:i.parsedType}),Ce}let r;const s=new vn;for(const i of this._def.checks)i.kind==="int"?qe.isInteger(e.data)||(r=this._getOrReturnCtx(e,r),te(r,{code:q.invalid_type,expected:"integer",received:"float",message:i.message}),s.dirty()):i.kind==="min"?(i.inclusive?e.data<i.value:e.data<=i.value)&&(r=this._getOrReturnCtx(e,r),te(r,{code:q.too_small,minimum:i.value,type:"number",inclusive:i.inclusive,exact:!1,message:i.message}),s.dirty()):i.kind==="max"?(i.inclusive?e.data>i.value:e.data>=i.value)&&(r=this._getOrReturnCtx(e,r),te(r,{code:q.too_big,maximum:i.value,type:"number",inclusive:i.inclusive,exact:!1,message:i.message}),s.dirty()):i.kind==="multipleOf"?dP(e.data,i.value)!==0&&(r=this._getOrReturnCtx(e,r),te(r,{code:q.not_multiple_of,multipleOf:i.value,message:i.message}),s.dirty()):i.kind==="finite"?Number.isFinite(e.data)||(r=this._getOrReturnCtx(e,r),te(r,{code:q.not_finite,message:i.message}),s.dirty()):qe.assertNever(i);return{status:s.value,value:e.data}}gte(e,n){return this.setLimit("min",e,!0,pe.toString(n))}gt(e,n){return this.setLimit("min",e,!1,pe.toString(n))}lte(e,n){return this.setLimit("max",e,!0,pe.toString(n))}lt(e,n){return this.setLimit("max",e,!1,pe.toString(n))}setLimit(e,n,r,s){return new cf({...this._def,checks:[...this._def.checks,{kind:e,value:n,inclusive:r,message:pe.toString(s)}]})}_addCheck(e){return new cf({...this._def,checks:[...this._def.checks,e]})}int(e){return this._addCheck({kind:"int",message:pe.toString(e)})}positive(e){return this._addCheck({kind:"min",value:0,inclusive:!1,message:pe.toString(e)})}negative(e){return this._addCheck({kind:"max",value:0,inclusive:!1,message:pe.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:0,inclusive:!0,message:pe.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:0,inclusive:!0,message:pe.toString(e)})}multipleOf(e,n){return this._addCheck({kind:"multipleOf",value:e,message:pe.toString(n)})}finite(e){return this._addCheck({kind:"finite",message:pe.toString(e)})}safe(e){return this._addCheck({kind:"min",inclusive:!0,value:Number.MIN_SAFE_INTEGER,message:pe.toString(e)})._addCheck({kind:"max",inclusive:!0,value:Number.MAX_SAFE_INTEGER,message:pe.toString(e)})}get minValue(){let e=null;for(const n of this._def.checks)n.kind==="min"&&(e===null||n.value>e)&&(e=n.value);return e}get maxValue(){let e=null;for(const n of this._def.checks)n.kind==="max"&&(e===null||n.value<e)&&(e=n.value);return e}get isInt(){return!!this._def.checks.find(e=>e.kind==="int"||e.kind==="multipleOf"&&qe.isInteger(e.value))}get isFinite(){let e=null,n=null;for(const r of this._def.checks){if(r.kind==="finite"||r.kind==="int"||r.kind==="multipleOf")return!0;r.kind==="min"?(n===null||r.value>n)&&(n=r.value):r.kind==="max"&&(e===null||r.value<e)&&(e=r.value)}return Number.isFinite(n)&&Number.isFinite(e)}};of.create=t=>new of({checks:[],typeName:U.ZodNumber,coerce:(t==null?void 0:t.coerce)||!1,...Le(t)});class Oo extends Be{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte}_parse(e){if(this._def.coerce)try{e.data=BigInt(e.data)}catch{return this._getInvalidInput(e)}if(this._getType(e)!==ie.bigint)return this._getInvalidInput(e);let r;const s=new vn;for(const i of this._def.checks)i.kind==="min"?(i.inclusive?e.data<i.value:e.data<=i.value)&&(r=this._getOrReturnCtx(e,r),te(r,{code:q.too_small,type:"bigint",minimum:i.value,inclusive:i.inclusive,message:i.message}),s.dirty()):i.kind==="max"?(i.inclusive?e.data>i.value:e.data>=i.value)&&(r=this._getOrReturnCtx(e,r),te(r,{code:q.too_big,type:"bigint",maximum:i.value,inclusive:i.inclusive,message:i.message}),s.dirty()):i.kind==="multipleOf"?e.data%i.value!==BigInt(0)&&(r=this._getOrReturnCtx(e,r),te(r,{code:q.not_multiple_of,multipleOf:i.value,message:i.message}),s.dirty()):qe.assertNever(i);return{status:s.value,value:e.data}}_getInvalidInput(e){const n=this._getOrReturnCtx(e);return te(n,{code:q.invalid_type,expected:ie.bigint,received:n.parsedType}),Ce}gte(e,n){return this.setLimit("min",e,!0,pe.toString(n))}gt(e,n){return this.setLimit("min",e,!1,pe.toString(n))}lte(e,n){return this.setLimit("max",e,!0,pe.toString(n))}lt(e,n){return this.setLimit("max",e,!1,pe.toString(n))}setLimit(e,n,r,s){return new Oo({...this._def,checks:[...this._def.checks,{kind:e,value:n,inclusive:r,message:pe.toString(s)}]})}_addCheck(e){return new Oo({...this._def,checks:[...this._def.checks,e]})}positive(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!1,message:pe.toString(e)})}negative(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!1,message:pe.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!0,message:pe.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!0,message:pe.toString(e)})}multipleOf(e,n){return this._addCheck({kind:"multipleOf",value:e,message:pe.toString(n)})}get minValue(){let e=null;for(const n of this._def.checks)n.kind==="min"&&(e===null||n.value>e)&&(e=n.value);return e}get maxValue(){let e=null;for(const n of this._def.checks)n.kind==="max"&&(e===null||n.value<e)&&(e=n.value);return e}}Oo.create=t=>new Oo({checks:[],typeName:U.ZodBigInt,coerce:(t==null?void 0:t.coerce)??!1,...Le(t)});class lf extends Be{_parse(e){if(this._def.coerce&&(e.data=!!e.data),this._getType(e)!==ie.boolean){const r=this._getOrReturnCtx(e);return te(r,{code:q.invalid_type,expected:ie.boolean,received:r.parsedType}),Ce}return Nn(e.data)}}lf.create=t=>new lf({typeName:U.ZodBoolean,coerce:(t==null?void 0:t.coerce)||!1,...Le(t)});class Jl extends Be{_parse(e){if(this._def.coerce&&(e.data=new Date(e.data)),this._getType(e)!==ie.date){const i=this._getOrReturnCtx(e);return te(i,{code:q.invalid_type,expected:ie.date,received:i.parsedType}),Ce}if(Number.isNaN(e.data.getTime())){const i=this._getOrReturnCtx(e);return te(i,{code:q.invalid_date}),Ce}const r=new vn;let s;for(const i of this._def.checks)i.kind==="min"?e.data.getTime()<i.value&&(s=this._getOrReturnCtx(e,s),te(s,{code:q.too_small,message:i.message,inclusive:!0,exact:!1,minimum:i.value,type:"date"}),r.dirty()):i.kind==="max"?e.data.getTime()>i.value&&(s=this._getOrReturnCtx(e,s),te(s,{code:q.too_big,message:i.message,inclusive:!0,exact:!1,maximum:i.value,type:"date"}),r.dirty()):qe.assertNever(i);return{status:r.value,value:new Date(e.data.getTime())}}_addCheck(e){return new Jl({...this._def,checks:[...this._def.checks,e]})}min(e,n){return this._addCheck({kind:"min",value:e.getTime(),message:pe.toString(n)})}max(e,n){return this._addCheck({kind:"max",value:e.getTime(),message:pe.toString(n)})}get minDate(){let e=null;for(const n of this._def.checks)n.kind==="min"&&(e===null||n.value>e)&&(e=n.value);return e!=null?new Date(e):null}get maxDate(){let e=null;for(const n of this._def.checks)n.kind==="max"&&(e===null||n.value<e)&&(e=n.value);return e!=null?new Date(e):null}}Jl.create=t=>new Jl({checks:[],coerce:(t==null?void 0:t.coerce)||!1,typeName:U.ZodDate,...Le(t)});class By extends Be{_parse(e){if(this._getType(e)!==ie.symbol){const r=this._getOrReturnCtx(e);return te(r,{code:q.invalid_type,expected:ie.symbol,received:r.parsedType}),Ce}return Nn(e.data)}}By.create=t=>new By({typeName:U.ZodSymbol,...Le(t)});class uf extends Be{_parse(e){if(this._getType(e)!==ie.undefined){const r=this._getOrReturnCtx(e);return te(r,{code:q.invalid_type,expected:ie.undefined,received:r.parsedType}),Ce}return Nn(e.data)}}uf.create=t=>new uf({typeName:U.ZodUndefined,...Le(t)});class zy extends Be{_parse(e){if(this._getType(e)!==ie.null){const r=this._getOrReturnCtx(e);return te(r,{code:q.invalid_type,expected:ie.null,received:r.parsedType}),Ce}return Nn(e.data)}}zy.create=t=>new zy({typeName:U.ZodNull,...Le(t)});let $o=class extends Be{constructor(){super(...arguments),this._any=!0}_parse(e){return Nn(e.data)}};$o.create=t=>new $o({typeName:U.ZodAny,...Le(t)});let oa=class extends Be{constructor(){super(...arguments),this._unknown=!0}_parse(e){return Nn(e.data)}};oa.create=t=>new oa({typeName:U.ZodUnknown,...Le(t)});let Ks=class extends Be{_parse(e){const n=this._getOrReturnCtx(e);return te(n,{code:q.invalid_type,expected:ie.never,received:n.parsedType}),Ce}};Ks.create=t=>new Ks({typeName:U.ZodNever,...Le(t)});class Zy extends Be{_parse(e){if(this._getType(e)!==ie.undefined){const r=this._getOrReturnCtx(e);return te(r,{code:q.invalid_type,expected:ie.void,received:r.parsedType}),Ce}return Nn(e.data)}}Zy.create=t=>new Zy({typeName:U.ZodVoid,...Le(t)});let wa=class al extends Be{_parse(e){const{ctx:n,status:r}=this._processInputParams(e),s=this._def;if(n.parsedType!==ie.array)return te(n,{code:q.invalid_type,expected:ie.array,received:n.parsedType}),Ce;if(s.exactLength!==null){const a=n.data.length>s.exactLength.value,o=n.data.length<s.exactLength.value;(a||o)&&(te(n,{code:a?q.too_big:q.too_small,minimum:o?s.exactLength.value:void 0,maximum:a?s.exactLength.value:void 0,type:"array",inclusive:!0,exact:!0,message:s.exactLength.message}),r.dirty())}if(s.minLength!==null&&n.data.length<s.minLength.value&&(te(n,{code:q.too_small,minimum:s.minLength.value,type:"array",inclusive:!0,exact:!1,message:s.minLength.message}),r.dirty()),s.maxLength!==null&&n.data.length>s.maxLength.value&&(te(n,{code:q.too_big,maximum:s.maxLength.value,type:"array",inclusive:!0,exact:!1,message:s.maxLength.message}),r.dirty()),n.common.async)return Promise.all([...n.data].map((a,o)=>s.type._parseAsync(new qr(n,a,n.path,o)))).then(a=>vn.mergeArray(r,a));const i=[...n.data].map((a,o)=>s.type._parseSync(new qr(n,a,n.path,o)));return vn.mergeArray(r,i)}get element(){return this._def.type}min(e,n){return new al({...this._def,minLength:{value:e,message:pe.toString(n)}})}max(e,n){return new al({...this._def,maxLength:{value:e,message:pe.toString(n)}})}length(e,n){return new al({...this._def,exactLength:{value:e,message:pe.toString(n)}})}nonempty(e){return this.min(1,e)}};wa.create=(t,e)=>new wa({type:t,minLength:null,maxLength:null,exactLength:null,typeName:U.ZodArray,...Le(e)});function qi(t){if(t instanceof gs){const e={};for(const n in t.shape){const r=t.shape[n];e[n]=zs.create(qi(r))}return new gs({...t._def,shape:()=>e})}else return t instanceof wa?new wa({...t._def,type:qi(t.element)}):t instanceof zs?zs.create(qi(t.unwrap())):t instanceof ba?ba.create(qi(t.unwrap())):t instanceof ys?ys.create(t.items.map(e=>qi(e))):t}let gs=class mr extends Be{constructor(){super(...arguments),this._cached=null,this.nonstrict=this.passthrough,this.augment=this.extend}_getCached(){if(this._cached!==null)return this._cached;const e=this._def.shape(),n=qe.objectKeys(e);return this._cached={shape:e,keys:n},this._cached}_parse(e){if(this._getType(e)!==ie.object){const l=this._getOrReturnCtx(e);return te(l,{code:q.invalid_type,expected:ie.object,received:l.parsedType}),Ce}const{status:r,ctx:s}=this._processInputParams(e),{shape:i,keys:a}=this._getCached(),o=[];if(!(this._def.catchall instanceof Ks&&this._def.unknownKeys==="strip"))for(const l in s.data)a.includes(l)||o.push(l);const c=[];for(const l of a){const u=i[l],d=s.data[l];c.push({key:{status:"valid",value:l},value:u._parse(new qr(s,d,s.path,l)),alwaysSet:l in s.data})}if(this._def.catchall instanceof Ks){const l=this._def.unknownKeys;if(l==="passthrough")for(const u of o)c.push({key:{status:"valid",value:u},value:{status:"valid",value:s.data[u]}});else if(l==="strict")o.length>0&&(te(s,{code:q.unrecognized_keys,keys:o}),r.dirty());else if(l!=="strip")throw new Error("Internal ZodObject error: invalid unknownKeys value.")}else{const l=this._def.catchall;for(const u of o){const d=s.data[u];c.push({key:{status:"valid",value:u},value:l._parse(new qr(s,d,s.path,u)),alwaysSet:u in s.data})}}return s.common.async?Promise.resolve().then(async()=>{const l=[];for(const u of c){const d=await u.key,h=await u.value;l.push({key:d,value:h,alwaysSet:u.alwaysSet})}return l}).then(l=>vn.mergeObjectSync(r,l)):vn.mergeObjectSync(r,c)}get shape(){return this._def.shape()}strict(e){return pe.errToObj,new mr({...this._def,unknownKeys:"strict",...e!==void 0?{errorMap:(n,r)=>{var i,a;const s=((a=(i=this._def).errorMap)==null?void 0:a.call(i,n,r).message)??r.defaultError;return n.code==="unrecognized_keys"?{message:pe.errToObj(e).message??s}:{message:s}}}:{}})}strip(){return new mr({...this._def,unknownKeys:"strip"})}passthrough(){return new mr({...this._def,unknownKeys:"passthrough"})}extend(e){return new mr({...this._def,shape:()=>({...this._def.shape(),...e})})}merge(e){return new mr({unknownKeys:e._def.unknownKeys,catchall:e._def.catchall,shape:()=>({...this._def.shape(),...e._def.shape()}),typeName:U.ZodObject})}setKey(e,n){return this.augment({[e]:n})}catchall(e){return new mr({...this._def,catchall:e})}pick(e){const n={};for(const r of qe.objectKeys(e))e[r]&&this.shape[r]&&(n[r]=this.shape[r]);return new mr({...this._def,shape:()=>n})}omit(e){const n={};for(const r of qe.objectKeys(this.shape))e[r]||(n[r]=this.shape[r]);return new mr({...this._def,shape:()=>n})}deepPartial(){return qi(this)}partial(e){const n={};for(const r of qe.objectKeys(this.shape)){const s=this.shape[r];e&&!e[r]?n[r]=s:n[r]=s.optional()}return new mr({...this._def,shape:()=>n})}required(e){const n={};for(const r of qe.objectKeys(this.shape))if(e&&!e[r])n[r]=this.shape[r];else{let i=this.shape[r];for(;i instanceof zs;)i=i._def.innerType;n[r]=i}return new mr({...this._def,shape:()=>n})}keyof(){return a0(qe.objectKeys(this.shape))}};gs.create=(t,e)=>new gs({shape:()=>t,unknownKeys:"strip",catchall:Ks.create(),typeName:U.ZodObject,...Le(e)});gs.strictCreate=(t,e)=>new gs({shape:()=>t,unknownKeys:"strict",catchall:Ks.create(),typeName:U.ZodObject,...Le(e)});gs.lazycreate=(t,e)=>new gs({shape:t,unknownKeys:"strip",catchall:Ks.create(),typeName:U.ZodObject,...Le(e)});let Kl=class extends Be{_parse(e){const{ctx:n}=this._processInputParams(e),r=this._def.options;function s(i){for(const o of i)if(o.result.status==="valid")return o.result;for(const o of i)if(o.result.status==="dirty")return n.common.issues.push(...o.ctx.common.issues),o.result;const a=i.map(o=>new or(o.ctx.common.issues));return te(n,{code:q.invalid_union,unionErrors:a}),Ce}if(n.common.async)return Promise.all(r.map(async i=>{const a={...n,common:{...n.common,issues:[]},parent:null};return{result:await i._parseAsync({data:n.data,path:n.path,parent:a}),ctx:a}})).then(s);{let i;const a=[];for(const c of r){const l={...n,common:{...n.common,issues:[]},parent:null},u=c._parseSync({data:n.data,path:n.path,parent:l});if(u.status==="valid")return u;u.status==="dirty"&&!i&&(i={result:u,ctx:l}),l.common.issues.length&&a.push(l.common.issues)}if(i)return n.common.issues.push(...i.ctx.common.issues),i.result;const o=a.map(c=>new or(c));return te(n,{code:q.invalid_union,unionErrors:o}),Ce}}get options(){return this._def.options}};Kl.create=(t,e)=>new Kl({options:t,typeName:U.ZodUnion,...Le(e)});function df(t,e){const n=Os(t),r=Os(e);if(t===e)return{valid:!0,data:t};if(n===ie.object&&r===ie.object){const s=qe.objectKeys(e),i=qe.objectKeys(t).filter(o=>s.indexOf(o)!==-1),a={...t,...e};for(const o of i){const c=df(t[o],e[o]);if(!c.valid)return{valid:!1};a[o]=c.data}return{valid:!0,data:a}}else if(n===ie.array&&r===ie.array){if(t.length!==e.length)return{valid:!1};const s=[];for(let i=0;i<t.length;i++){const a=t[i],o=e[i],c=df(a,o);if(!c.valid)return{valid:!1};s.push(c.data)}return{valid:!0,data:s}}else return n===ie.date&&r===ie.date&&+t==+e?{valid:!0,data:t}:{valid:!1}}let Xl=class extends Be{_parse(e){const{status:n,ctx:r}=this._processInputParams(e),s=(i,a)=>{if(Dy(i)||Dy(a))return Ce;const o=df(i.value,a.value);return o.valid?((Uy(i)||Uy(a))&&n.dirty(),{status:n.value,value:o.data}):(te(r,{code:q.invalid_intersection_types}),Ce)};return r.common.async?Promise.all([this._def.left._parseAsync({data:r.data,path:r.path,parent:r}),this._def.right._parseAsync({data:r.data,path:r.path,parent:r})]).then(([i,a])=>s(i,a)):s(this._def.left._parseSync({data:r.data,path:r.path,parent:r}),this._def.right._parseSync({data:r.data,path:r.path,parent:r}))}};Xl.create=(t,e,n)=>new Xl({left:t,right:e,typeName:U.ZodIntersection,...Le(n)});class ys extends Be{_parse(e){const{status:n,ctx:r}=this._processInputParams(e);if(r.parsedType!==ie.array)return te(r,{code:q.invalid_type,expected:ie.array,received:r.parsedType}),Ce;if(r.data.length<this._def.items.length)return te(r,{code:q.too_small,minimum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),Ce;!this._def.rest&&r.data.length>this._def.items.length&&(te(r,{code:q.too_big,maximum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),n.dirty());const i=[...r.data].map((a,o)=>{const c=this._def.items[o]||this._def.rest;return c?c._parse(new qr(r,a,r.path,o)):null}).filter(a=>!!a);return r.common.async?Promise.all(i).then(a=>vn.mergeArray(n,a)):vn.mergeArray(n,i)}get items(){return this._def.items}rest(e){return new ys({...this._def,rest:e})}}ys.create=(t,e)=>{if(!Array.isArray(t))throw new Error("You must pass an array of schemas to z.tuple([ ... ])");return new ys({items:t,typeName:U.ZodTuple,rest:null,...Le(e)})};let hP=class hf extends Be{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:n,ctx:r}=this._processInputParams(e);if(r.parsedType!==ie.object)return te(r,{code:q.invalid_type,expected:ie.object,received:r.parsedType}),Ce;const s=[],i=this._def.keyType,a=this._def.valueType;for(const o in r.data)s.push({key:i._parse(new qr(r,o,r.path,o)),value:a._parse(new qr(r,r.data[o],r.path,o)),alwaysSet:o in r.data});return r.common.async?vn.mergeObjectAsync(n,s):vn.mergeObjectSync(n,s)}get element(){return this._def.valueType}static create(e,n,r){return n instanceof Be?new hf({keyType:e,valueType:n,typeName:U.ZodRecord,...Le(r)}):new hf({keyType:ql.create(),valueType:e,typeName:U.ZodRecord,...Le(n)})}};class Vy extends Be{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:n,ctx:r}=this._processInputParams(e);if(r.parsedType!==ie.map)return te(r,{code:q.invalid_type,expected:ie.map,received:r.parsedType}),Ce;const s=this._def.keyType,i=this._def.valueType,a=[...r.data.entries()].map(([o,c],l)=>({key:s._parse(new qr(r,o,r.path,[l,"key"])),value:i._parse(new qr(r,c,r.path,[l,"value"]))}));if(r.common.async){const o=new Map;return Promise.resolve().then(async()=>{for(const c of a){const l=await c.key,u=await c.value;if(l.status==="aborted"||u.status==="aborted")return Ce;(l.status==="dirty"||u.status==="dirty")&&n.dirty(),o.set(l.value,u.value)}return{status:n.value,value:o}})}else{const o=new Map;for(const c of a){const l=c.key,u=c.value;if(l.status==="aborted"||u.status==="aborted")return Ce;(l.status==="dirty"||u.status==="dirty")&&n.dirty(),o.set(l.value,u.value)}return{status:n.value,value:o}}}}Vy.create=(t,e,n)=>new Vy({valueType:e,keyType:t,typeName:U.ZodMap,...Le(n)});class Ro extends Be{_parse(e){const{status:n,ctx:r}=this._processInputParams(e);if(r.parsedType!==ie.set)return te(r,{code:q.invalid_type,expected:ie.set,received:r.parsedType}),Ce;const s=this._def;s.minSize!==null&&r.data.size<s.minSize.value&&(te(r,{code:q.too_small,minimum:s.minSize.value,type:"set",inclusive:!0,exact:!1,message:s.minSize.message}),n.dirty()),s.maxSize!==null&&r.data.size>s.maxSize.value&&(te(r,{code:q.too_big,maximum:s.maxSize.value,type:"set",inclusive:!0,exact:!1,message:s.maxSize.message}),n.dirty());const i=this._def.valueType;function a(c){const l=new Set;for(const u of c){if(u.status==="aborted")return Ce;u.status==="dirty"&&n.dirty(),l.add(u.value)}return{status:n.value,value:l}}const o=[...r.data.values()].map((c,l)=>i._parse(new qr(r,c,r.path,l)));return r.common.async?Promise.all(o).then(c=>a(c)):a(o)}min(e,n){return new Ro({...this._def,minSize:{value:e,message:pe.toString(n)}})}max(e,n){return new Ro({...this._def,maxSize:{value:e,message:pe.toString(n)}})}size(e,n){return this.min(e,n).max(e,n)}nonempty(e){return this.min(1,e)}}Ro.create=(t,e)=>new Ro({valueType:t,minSize:null,maxSize:null,typeName:U.ZodSet,...Le(e)});class co extends Be{constructor(){super(...arguments),this.validate=this.implement}_parse(e){const{ctx:n}=this._processInputParams(e);if(n.parsedType!==ie.function)return te(n,{code:q.invalid_type,expected:ie.function,received:n.parsedType}),Ce;function r(o,c){return af({data:o,path:n.path,errorMaps:[n.common.contextualErrorMap,n.schemaErrorMap,sf(),Co].filter(l=>!!l),issueData:{code:q.invalid_arguments,argumentsError:c}})}function s(o,c){return af({data:o,path:n.path,errorMaps:[n.common.contextualErrorMap,n.schemaErrorMap,sf(),Co].filter(l=>!!l),issueData:{code:q.invalid_return_type,returnTypeError:c}})}const i={errorMap:n.common.contextualErrorMap},a=n.data;if(this._def.returns instanceof No){const o=this;return Nn(async function(...c){const l=new or([]),u=await o._def.args.parseAsync(c,i).catch(f=>{throw l.addIssue(r(c,f)),l}),d=await Reflect.apply(a,this,u);return await o._def.returns._def.type.parseAsync(d,i).catch(f=>{throw l.addIssue(s(d,f)),l})})}else{const o=this;return Nn(function(...c){const l=o._def.args.safeParse(c,i);if(!l.success)throw new or([r(c,l.error)]);const u=Reflect.apply(a,this,l.data),d=o._def.returns.safeParse(u,i);if(!d.success)throw new or([s(u,d.error)]);return d.data})}}parameters(){return this._def.args}returnType(){return this._def.returns}args(...e){return new co({...this._def,args:ys.create(e).rest(oa.create())})}returns(e){return new co({...this._def,returns:e})}implement(e){return this.parse(e)}strictImplement(e){return this.parse(e)}static create(e,n,r){return new co({args:e||ys.create([]).rest(oa.create()),returns:n||oa.create(),typeName:U.ZodFunction,...Le(r)})}}class Gy extends Be{get schema(){return this._def.getter()}_parse(e){const{ctx:n}=this._processInputParams(e);return this._def.getter()._parse({data:n.data,path:n.path,parent:n})}}Gy.create=(t,e)=>new Gy({getter:t,typeName:U.ZodLazy,...Le(e)});let ff=class extends Be{_parse(e){if(e.data!==this._def.value){const n=this._getOrReturnCtx(e);return te(n,{received:n.data,code:q.invalid_literal,expected:this._def.value}),Ce}return{status:"valid",value:e.data}}get value(){return this._def.value}};ff.create=(t,e)=>new ff({value:t,typeName:U.ZodLiteral,...Le(e)});function a0(t,e){return new om({values:t,typeName:U.ZodEnum,...Le(e)})}let om=class pf extends Be{_parse(e){if(typeof e.data!="string"){const n=this._getOrReturnCtx(e),r=this._def.values;return te(n,{expected:qe.joinValues(r),received:n.parsedType,code:q.invalid_type}),Ce}if(this._cache||(this._cache=new Set(this._def.values)),!this._cache.has(e.data)){const n=this._getOrReturnCtx(e),r=this._def.values;return te(n,{received:n.data,code:q.invalid_enum_value,options:r}),Ce}return Nn(e.data)}get options(){return this._def.values}get enum(){const e={};for(const n of this._def.values)e[n]=n;return e}get Values(){const e={};for(const n of this._def.values)e[n]=n;return e}get Enum(){const e={};for(const n of this._def.values)e[n]=n;return e}extract(e,n=this._def){return pf.create(e,{...this._def,...n})}exclude(e,n=this._def){return pf.create(this.options.filter(r=>!e.includes(r)),{...this._def,...n})}};om.create=a0;class Wy extends Be{_parse(e){const n=qe.getValidEnumValues(this._def.values),r=this._getOrReturnCtx(e);if(r.parsedType!==ie.string&&r.parsedType!==ie.number){const s=qe.objectValues(n);return te(r,{expected:qe.joinValues(s),received:r.parsedType,code:q.invalid_type}),Ce}if(this._cache||(this._cache=new Set(qe.getValidEnumValues(this._def.values))),!this._cache.has(e.data)){const s=qe.objectValues(n);return te(r,{received:r.data,code:q.invalid_enum_value,options:s}),Ce}return Nn(e.data)}get enum(){return this._def.values}}Wy.create=(t,e)=>new Wy({values:t,typeName:U.ZodNativeEnum,...Le(e)});class No extends Be{unwrap(){return this._def.type}_parse(e){const{ctx:n}=this._processInputParams(e);if(n.parsedType!==ie.promise&&n.common.async===!1)return te(n,{code:q.invalid_type,expected:ie.promise,received:n.parsedType}),Ce;const r=n.parsedType===ie.promise?n.data:Promise.resolve(n.data);return Nn(r.then(s=>this._def.type.parseAsync(s,{path:n.path,errorMap:n.common.contextualErrorMap})))}}No.create=(t,e)=>new No({type:t,typeName:U.ZodPromise,...Le(e)});class va extends Be{innerType(){return this._def.schema}sourceType(){return this._def.schema._def.typeName===U.ZodEffects?this._def.schema.sourceType():this._def.schema}_parse(e){const{status:n,ctx:r}=this._processInputParams(e),s=this._def.effect||null,i={addIssue:a=>{te(r,a),a.fatal?n.abort():n.dirty()},get path(){return r.path}};if(i.addIssue=i.addIssue.bind(i),s.type==="preprocess"){const a=s.transform(r.data,i);if(r.common.async)return Promise.resolve(a).then(async o=>{if(n.value==="aborted")return Ce;const c=await this._def.schema._parseAsync({data:o,path:r.path,parent:r});return c.status==="aborted"?Ce:c.status==="dirty"||n.value==="dirty"?za(c.value):c});{if(n.value==="aborted")return Ce;const o=this._def.schema._parseSync({data:a,path:r.path,parent:r});return o.status==="aborted"?Ce:o.status==="dirty"||n.value==="dirty"?za(o.value):o}}if(s.type==="refinement"){const a=o=>{const c=s.refinement(o,i);if(r.common.async)return Promise.resolve(c);if(c instanceof Promise)throw new Error("Async refinement encountered during synchronous parse operation. Use .parseAsync instead.");return o};if(r.common.async===!1){const o=this._def.schema._parseSync({data:r.data,path:r.path,parent:r});return o.status==="aborted"?Ce:(o.status==="dirty"&&n.dirty(),a(o.value),{status:n.value,value:o.value})}else return this._def.schema._parseAsync({data:r.data,path:r.path,parent:r}).then(o=>o.status==="aborted"?Ce:(o.status==="dirty"&&n.dirty(),a(o.value).then(()=>({status:n.value,value:o.value}))))}if(s.type==="transform")if(r.common.async===!1){const a=this._def.schema._parseSync({data:r.data,path:r.path,parent:r});if(!_a(a))return Ce;const o=s.transform(a.value,i);if(o instanceof Promise)throw new Error("Asynchronous transform encountered during synchronous parse operation. Use .parseAsync instead.");return{status:n.value,value:o}}else return this._def.schema._parseAsync({data:r.data,path:r.path,parent:r}).then(a=>_a(a)?Promise.resolve(s.transform(a.value,i)).then(o=>({status:n.value,value:o})):Ce);qe.assertNever(s)}}va.create=(t,e,n)=>new va({schema:t,typeName:U.ZodEffects,effect:e,...Le(n)});va.createWithPreprocess=(t,e,n)=>new va({schema:e,effect:{type:"preprocess",transform:t},typeName:U.ZodEffects,...Le(n)});let zs=class extends Be{_parse(e){return this._getType(e)===ie.undefined?Nn(void 0):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}};zs.create=(t,e)=>new zs({innerType:t,typeName:U.ZodOptional,...Le(e)});let ba=class extends Be{_parse(e){return this._getType(e)===ie.null?Nn(null):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}};ba.create=(t,e)=>new ba({innerType:t,typeName:U.ZodNullable,...Le(e)});let mf=class extends Be{_parse(e){const{ctx:n}=this._processInputParams(e);let r=n.data;return n.parsedType===ie.undefined&&(r=this._def.defaultValue()),this._def.innerType._parse({data:r,path:n.path,parent:n})}removeDefault(){return this._def.innerType}};mf.create=(t,e)=>new mf({innerType:t,typeName:U.ZodDefault,defaultValue:typeof e.default=="function"?e.default:()=>e.default,...Le(e)});let gf=class extends Be{_parse(e){const{ctx:n}=this._processInputParams(e),r={...n,common:{...n.common,issues:[]}},s=this._def.innerType._parse({data:r.data,path:r.path,parent:{...r}});return Hl(s)?s.then(i=>({status:"valid",value:i.status==="valid"?i.value:this._def.catchValue({get error(){return new or(r.common.issues)},input:r.data})})):{status:"valid",value:s.status==="valid"?s.value:this._def.catchValue({get error(){return new or(r.common.issues)},input:r.data})}}removeCatch(){return this._def.innerType}};gf.create=(t,e)=>new gf({innerType:t,typeName:U.ZodCatch,catchValue:typeof e.catch=="function"?e.catch:()=>e.catch,...Le(e)});class Hy extends Be{_parse(e){if(this._getType(e)!==ie.nan){const r=this._getOrReturnCtx(e);return te(r,{code:q.invalid_type,expected:ie.nan,received:r.parsedType}),Ce}return{status:"valid",value:e.data}}}Hy.create=t=>new Hy({typeName:U.ZodNaN,...Le(t)});class fP extends Be{_parse(e){const{ctx:n}=this._processInputParams(e),r=n.data;return this._def.type._parse({data:r,path:n.path,parent:n})}unwrap(){return this._def.type}}class cm extends Be{_parse(e){const{status:n,ctx:r}=this._processInputParams(e);if(r.common.async)return(async()=>{const i=await this._def.in._parseAsync({data:r.data,path:r.path,parent:r});return i.status==="aborted"?Ce:i.status==="dirty"?(n.dirty(),za(i.value)):this._def.out._parseAsync({data:i.value,path:r.path,parent:r})})();{const s=this._def.in._parseSync({data:r.data,path:r.path,parent:r});return s.status==="aborted"?Ce:s.status==="dirty"?(n.dirty(),{status:"dirty",value:s.value}):this._def.out._parseSync({data:s.value,path:r.path,parent:r})}}static create(e,n){return new cm({in:e,out:n,typeName:U.ZodPipeline})}}let yf=class extends Be{_parse(e){const n=this._def.innerType._parse(e),r=s=>(_a(s)&&(s.value=Object.freeze(s.value)),s);return Hl(n)?n.then(s=>r(s)):r(n)}unwrap(){return this._def.innerType}};yf.create=(t,e)=>new yf({innerType:t,typeName:U.ZodReadonly,...Le(e)});function qy(t,e){const n=typeof t=="function"?t(e):typeof t=="string"?{message:t}:t;return typeof n=="string"?{message:n}:n}function Wn(t,e={},n){return t?$o.create().superRefine((r,s)=>{const i=t(r);if(i instanceof Promise)return i.then(a=>{if(!a){const o=qy(e,r),c=o.fatal??n??!0;s.addIssue({code:"custom",...o,fatal:c})}});if(!i){const a=qy(e,r),o=a.fatal??n??!0;s.addIssue({code:"custom",...a,fatal:o})}}):$o.create()}var U;(function(t){t.ZodString="ZodString",t.ZodNumber="ZodNumber",t.ZodNaN="ZodNaN",t.ZodBigInt="ZodBigInt",t.ZodBoolean="ZodBoolean",t.ZodDate="ZodDate",t.ZodSymbol="ZodSymbol",t.ZodUndefined="ZodUndefined",t.ZodNull="ZodNull",t.ZodAny="ZodAny",t.ZodUnknown="ZodUnknown",t.ZodNever="ZodNever",t.ZodVoid="ZodVoid",t.ZodArray="ZodArray",t.ZodObject="ZodObject",t.ZodUnion="ZodUnion",t.ZodDiscriminatedUnion="ZodDiscriminatedUnion",t.ZodIntersection="ZodIntersection",t.ZodTuple="ZodTuple",t.ZodRecord="ZodRecord",t.ZodMap="ZodMap",t.ZodSet="ZodSet",t.ZodFunction="ZodFunction",t.ZodLazy="ZodLazy",t.ZodLiteral="ZodLiteral",t.ZodEnum="ZodEnum",t.ZodEffects="ZodEffects",t.ZodNativeEnum="ZodNativeEnum",t.ZodOptional="ZodOptional",t.ZodNullable="ZodNullable",t.ZodDefault="ZodDefault",t.ZodCatch="ZodCatch",t.ZodPromise="ZodPromise",t.ZodBranded="ZodBranded",t.ZodPipeline="ZodPipeline",t.ZodReadonly="ZodReadonly"})(U||(U={}));const oc=(t,e={message:`Input not instance of ${t.name}`})=>Wn(n=>n instanceof t,e),Ue=ql.create,at=of.create,Zs=lf.create,pP=uf.create,Ea=$o.create;oa.create;Ks.create;const $n=wa.create,Ve=gs.create,xr=Kl.create;Xl.create;ys.create;const Po=hP.create,cc=co.create,Ur=ff.create,Ii=om.create,o0=No.create;zs.create;ba.create;function mP(t,e){var r,s,i;const n={type:"array"};return(r=t.type)!=null&&r._def&&((i=(s=t.type)==null?void 0:s._def)==null?void 0:i.typeName)!==U.ZodAny&&(n.items=Ye(t.type._def,{...e,currentPath:[...e.currentPath,"items"]})),t.minLength&&tt(n,"minItems",t.minLength.value,t.minLength.message,e),t.maxLength&&tt(n,"maxItems",t.maxLength.value,t.maxLength.message,e),t.exactLength&&(tt(n,"minItems",t.exactLength.value,t.exactLength.message,e),tt(n,"maxItems",t.exactLength.value,t.exactLength.message,e)),n}function gP(t,e){const n={type:"integer",format:"int64"};if(!t.checks)return n;for(const r of t.checks)switch(r.kind){case"min":e.target==="jsonSchema7"?r.inclusive?tt(n,"minimum",r.value,r.message,e):tt(n,"exclusiveMinimum",r.value,r.message,e):(r.inclusive||(n.exclusiveMinimum=!0),tt(n,"minimum",r.value,r.message,e));break;case"max":e.target==="jsonSchema7"?r.inclusive?tt(n,"maximum",r.value,r.message,e):tt(n,"exclusiveMaximum",r.value,r.message,e):(r.inclusive||(n.exclusiveMaximum=!0),tt(n,"maximum",r.value,r.message,e));break;case"multipleOf":tt(n,"multipleOf",r.value,r.message,e);break}return n}function yP(){return{type:"boolean"}}function c0(t,e){return Ye(t.type._def,e)}const _P=(t,e)=>Ye(t.innerType._def,e);function l0(t,e,n){const r=n??e.dateStrategy;if(Array.isArray(r))return{anyOf:r.map(s=>l0(t,e,s))};switch(r){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":return wP(t,e)}}const wP=(t,e)=>{const n={type:"integer",format:"unix-time"};if(e.target==="openApi3")return n;for(const r of t.checks)switch(r.kind){case"min":tt(n,"minimum",r.value,r.message,e);break;case"max":tt(n,"maximum",r.value,r.message,e);break}return n};function vP(t,e){return{...Ye(t.innerType._def,e),default:t.defaultValue()}}function bP(t,e){return e.effectStrategy==="input"?Ye(t.schema._def,e):qn(e)}function EP(t){return{type:"string",enum:Array.from(t.values)}}const TP=t=>"type"in t&&t.type==="string"?!1:"allOf"in t;function SP(t,e){const n=[Ye(t.left._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),Ye(t.right._def,{...e,currentPath:[...e.currentPath,"allOf","1"]})].filter(i=>!!i);let r=e.target==="jsonSchema2019-09"?{unevaluatedProperties:!1}:void 0;const s=[];return n.forEach(i=>{if(TP(i))s.push(...i.allOf),i.unevaluatedProperties===void 0&&(r=void 0);else{let a=i;if("additionalProperties"in i&&i.additionalProperties===!1){const{additionalProperties:o,...c}=i;a=c}else r=void 0;s.push(a)}}),s.length?{allOf:s,...r}:void 0}function xP(t,e){const n=typeof t.value;return n!=="bigint"&&n!=="number"&&n!=="boolean"&&n!=="string"?{type:Array.isArray(t.value)?"array":"object"}:e.target==="openApi3"?{type:n==="bigint"?"integer":n,enum:[t.value]}:{type:n==="bigint"?"integer":n,const:t.value}}let Yd;const ur={cuid:/^[cC][^\s-]{8,}$/,cuid2:/^[0-9a-z]+$/,ulid:/^[0-9A-HJKMNP-TV-Z]{26}$/,email:/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,emoji:()=>(Yd===void 0&&(Yd=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),Yd),uuid:/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/,ipv4:/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,ipv4Cidr:/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,ipv6:/^(([a-f0-9]{1,4}:){7}|::([a-f0-9]{1,4}:){0,6}|([a-f0-9]{1,4}:){1}:([a-f0-9]{1,4}:){0,5}|([a-f0-9]{1,4}:){2}:([a-f0-9]{1,4}:){0,4}|([a-f0-9]{1,4}:){3}:([a-f0-9]{1,4}:){0,3}|([a-f0-9]{1,4}:){4}:([a-f0-9]{1,4}:){0,2}|([a-f0-9]{1,4}:){5}:([a-f0-9]{1,4}:){0,1})([a-f0-9]{1,4}|(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2})))$/,ipv6Cidr:/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,base64:/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,base64url:/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,nanoid:/^[a-zA-Z0-9_-]{21}$/,jwt:/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/};function u0(t,e){const n={type:"string"};if(t.checks)for(const r of t.checks)switch(r.kind){case"min":tt(n,"minLength",typeof n.minLength=="number"?Math.max(n.minLength,r.value):r.value,r.message,e);break;case"max":tt(n,"maxLength",typeof n.maxLength=="number"?Math.min(n.maxLength,r.value):r.value,r.message,e);break;case"email":switch(e.emailStrategy){case"format:email":dr(n,"email",r.message,e);break;case"format:idn-email":dr(n,"idn-email",r.message,e);break;case"pattern:zod":mn(n,ur.email,r.message,e);break}break;case"url":dr(n,"uri",r.message,e);break;case"uuid":dr(n,"uuid",r.message,e);break;case"regex":mn(n,r.regex,r.message,e);break;case"cuid":mn(n,ur.cuid,r.message,e);break;case"cuid2":mn(n,ur.cuid2,r.message,e);break;case"startsWith":mn(n,RegExp(`^${Qd(r.value,e)}`),r.message,e);break;case"endsWith":mn(n,RegExp(`${Qd(r.value,e)}$`),r.message,e);break;case"datetime":dr(n,"date-time",r.message,e);break;case"date":dr(n,"date",r.message,e);break;case"time":dr(n,"time",r.message,e);break;case"duration":dr(n,"duration",r.message,e);break;case"length":tt(n,"minLength",typeof n.minLength=="number"?Math.max(n.minLength,r.value):r.value,r.message,e),tt(n,"maxLength",typeof n.maxLength=="number"?Math.min(n.maxLength,r.value):r.value,r.message,e);break;case"includes":mn(n,RegExp(Qd(r.value,e)),r.message,e);break;case"ip":r.version!=="v6"&&dr(n,"ipv4",r.message,e),r.version!=="v4"&&dr(n,"ipv6",r.message,e);break;case"base64url":mn(n,ur.base64url,r.message,e);break;case"jwt":mn(n,ur.jwt,r.message,e);break;case"cidr":r.version!=="v6"&&mn(n,ur.ipv4Cidr,r.message,e),r.version!=="v4"&&mn(n,ur.ipv6Cidr,r.message,e);break;case"emoji":mn(n,ur.emoji(),r.message,e);break;case"ulid":mn(n,ur.ulid,r.message,e);break;case"base64":switch(e.base64Strategy){case"format:binary":dr(n,"binary",r.message,e);break;case"contentEncoding:base64":tt(n,"contentEncoding","base64",r.message,e);break;case"pattern:zod":mn(n,ur.base64,r.message,e);break}break;case"nanoid":mn(n,ur.nanoid,r.message,e);break}return n}function Qd(t,e){return e.patternStrategy==="escape"?IP(t):t}const kP=new Set("ABCDEFGHIJKLMNOPQRSTUVXYZabcdefghijklmnopqrstuvxyz0123456789");function IP(t){let e="";for(let n=0;n<t.length;n++)kP.has(t[n])||(e+="\\"),e+=t[n];return e}function dr(t,e,n,r){var s;t.format||(s=t.anyOf)!=null&&s.some(i=>i.format)?(t.anyOf||(t.anyOf=[]),t.format&&(t.anyOf.push({format:t.format,...t.errorMessage&&r.errorMessages&&{errorMessage:{format:t.errorMessage.format}}}),delete t.format,t.errorMessage&&(delete t.errorMessage.format,Object.keys(t.errorMessage).length===0&&delete t.errorMessage)),t.anyOf.push({format:e,...n&&r.errorMessages&&{errorMessage:{format:n}}})):tt(t,"format",e,n,r)}function mn(t,e,n,r){var s;t.pattern||(s=t.allOf)!=null&&s.some(i=>i.pattern)?(t.allOf||(t.allOf=[]),t.pattern&&(t.allOf.push({pattern:t.pattern,...t.errorMessage&&r.errorMessages&&{errorMessage:{pattern:t.errorMessage.pattern}}}),delete t.pattern,t.errorMessage&&(delete t.errorMessage.pattern,Object.keys(t.errorMessage).length===0&&delete t.errorMessage)),t.allOf.push({pattern:Jy(e,r),...n&&r.errorMessages&&{errorMessage:{pattern:n}}})):tt(t,"pattern",Jy(e,r),n,r)}function Jy(t,e){var c;if(!e.applyRegexFlags||!t.flags)return t.source;const n={i:t.flags.includes("i"),m:t.flags.includes("m"),s:t.flags.includes("s")},r=n.i?t.source.toLowerCase():t.source;let s="",i=!1,a=!1,o=!1;for(let l=0;l<r.length;l++){if(i){s+=r[l],i=!1;continue}if(n.i){if(a){if(r[l].match(/[a-z]/)){o?(s+=r[l],s+=`${r[l-2]}-${r[l]}`.toUpperCase(),o=!1):r[l+1]==="-"&&((c=r[l+2])!=null&&c.match(/[a-z]/))?(s+=r[l],o=!0):s+=`${r[l]}${r[l].toUpperCase()}`;continue}}else if(r[l].match(/[a-z]/)){s+=`[${r[l]}${r[l].toUpperCase()}]`;continue}}if(n.m){if(r[l]==="^"){s+=`(^|(?<=[\r
]))`;continue}else if(r[l]==="$"){s+=`($|(?=[\r
]))`;continue}}if(n.s&&r[l]==="."){s+=a?`${r[l]}\r
`:`[${r[l]}\r
]`;continue}s+=r[l],r[l]==="\\"?i=!0:a&&r[l]==="]"?a=!1:!a&&r[l]==="["&&(a=!0)}try{new RegExp(s)}catch{return console.warn(`Could not convert regex pattern at ${e.currentPath.join("/")} to a flag-independent form! Falling back to the flag-ignorant source`),t.source}return s}function d0(t,e){var r,s,i,a,o,c;if(e.target==="openAi"&&console.warn("Warning: OpenAI may not support records in schemas! Try an array of key-value pairs instead."),e.target==="openApi3"&&((r=t.keyType)==null?void 0:r._def.typeName)===U.ZodEnum)return{type:"object",required:t.keyType._def.values,properties:t.keyType._def.values.reduce((l,u)=>({...l,[u]:Ye(t.valueType._def,{...e,currentPath:[...e.currentPath,"properties",u]})??qn(e)}),{}),additionalProperties:e.rejectedAdditionalProperties};const n={type:"object",additionalProperties:Ye(t.valueType._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??e.allowedAdditionalProperties};if(e.target==="openApi3")return n;if(((s=t.keyType)==null?void 0:s._def.typeName)===U.ZodString&&((i=t.keyType._def.checks)!=null&&i.length)){const{type:l,...u}=u0(t.keyType._def,e);return{...n,propertyNames:u}}else{if(((a=t.keyType)==null?void 0:a._def.typeName)===U.ZodEnum)return{...n,propertyNames:{enum:t.keyType._def.values}};if(((o=t.keyType)==null?void 0:o._def.typeName)===U.ZodBranded&&t.keyType._def.type._def.typeName===U.ZodString&&((c=t.keyType._def.type._def.checks)!=null&&c.length)){const{type:l,...u}=c0(t.keyType._def,e);return{...n,propertyNames:u}}}return n}function AP(t,e){if(e.mapStrategy==="record")return d0(t,e);const n=Ye(t.keyType._def,{...e,currentPath:[...e.currentPath,"items","items","0"]})||qn(e),r=Ye(t.valueType._def,{...e,currentPath:[...e.currentPath,"items","items","1"]})||qn(e);return{type:"array",maxItems:125,items:{type:"array",items:[n,r],minItems:2,maxItems:2}}}function CP(t){const e=t.values,r=Object.keys(t.values).filter(i=>typeof e[e[i]]!="number").map(i=>e[i]),s=Array.from(new Set(r.map(i=>typeof i)));return{type:s.length===1?s[0]==="string"?"string":"number":["string","number"],enum:r}}function OP(t){return t.target==="openAi"?void 0:{not:qn({...t,currentPath:[...t.currentPath,"not"]})}}function $P(t){return t.target==="openApi3"?{enum:["null"],nullable:!0}:{type:"null"}}const Yl={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"};function RP(t,e){if(e.target==="openApi3")return Ky(t,e);const n=t.options instanceof Map?Array.from(t.options.values()):t.options;if(n.every(r=>r._def.typeName in Yl&&(!r._def.checks||!r._def.checks.length))){const r=n.reduce((s,i)=>{const a=Yl[i._def.typeName];return a&&!s.includes(a)?[...s,a]:s},[]);return{type:r.length>1?r:r[0]}}else if(n.every(r=>r._def.typeName==="ZodLiteral"&&!r.description)){const r=n.reduce((s,i)=>{const a=typeof i._def.value;switch(a){case"string":case"number":case"boolean":return[...s,a];case"bigint":return[...s,"integer"];case"object":return i._def.value===null?[...s,"null"]:s;case"symbol":case"undefined":case"function":default:return s}},[]);if(r.length===n.length){const s=r.filter((i,a,o)=>o.indexOf(i)===a);return{type:s.length>1?s:s[0],enum:n.reduce((i,a)=>i.includes(a._def.value)?i:[...i,a._def.value],[])}}}else if(n.every(r=>r._def.typeName==="ZodEnum"))return{type:"string",enum:n.reduce((r,s)=>[...r,...s._def.values.filter(i=>!r.includes(i))],[])};return Ky(t,e)}const Ky=(t,e)=>{const n=(t.options instanceof Map?Array.from(t.options.values()):t.options).map((r,s)=>Ye(r._def,{...e,currentPath:[...e.currentPath,"anyOf",`${s}`]})).filter(r=>!!r&&(!e.strictUnions||typeof r=="object"&&Object.keys(r).length>0));return n.length?{anyOf:n}:void 0};function NP(t,e){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(t.innerType._def.typeName)&&(!t.innerType._def.checks||!t.innerType._def.checks.length))return e.target==="openApi3"?{type:Yl[t.innerType._def.typeName],nullable:!0}:{type:[Yl[t.innerType._def.typeName],"null"]};if(e.target==="openApi3"){const r=Ye(t.innerType._def,{...e,currentPath:[...e.currentPath]});return r&&"$ref"in r?{allOf:[r],nullable:!0}:r&&{...r,nullable:!0}}const n=Ye(t.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","0"]});return n&&{anyOf:[n,{type:"null"}]}}function PP(t,e){const n={type:"number"};if(!t.checks)return n;for(const r of t.checks)switch(r.kind){case"int":n.type="integer",r0(n,"type",r.message,e);break;case"min":e.target==="jsonSchema7"?r.inclusive?tt(n,"minimum",r.value,r.message,e):tt(n,"exclusiveMinimum",r.value,r.message,e):(r.inclusive||(n.exclusiveMinimum=!0),tt(n,"minimum",r.value,r.message,e));break;case"max":e.target==="jsonSchema7"?r.inclusive?tt(n,"maximum",r.value,r.message,e):tt(n,"exclusiveMaximum",r.value,r.message,e):(r.inclusive||(n.exclusiveMaximum=!0),tt(n,"maximum",r.value,r.message,e));break;case"multipleOf":tt(n,"multipleOf",r.value,r.message,e);break}return n}function MP(t,e){const n=e.target==="openAi",r={type:"object",properties:{}},s=[],i=t.shape();for(const o in i){let c=i[o];if(c===void 0||c._def===void 0)continue;let l=jP(c);l&&n&&(c._def.typeName==="ZodOptional"&&(c=c._def.innerType),c.isNullable()||(c=c.nullable()),l=!1);const u=Ye(c._def,{...e,currentPath:[...e.currentPath,"properties",o],propertyPath:[...e.currentPath,"properties",o]});u!==void 0&&(r.properties[o]=u,l||s.push(o))}s.length&&(r.required=s);const a=LP(t,e);return a!==void 0&&(r.additionalProperties=a),r}function LP(t,e){if(t.catchall._def.typeName!=="ZodNever")return Ye(t.catchall._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]});switch(t.unknownKeys){case"passthrough":return e.allowedAdditionalProperties;case"strict":return e.rejectedAdditionalProperties;case"strip":return e.removeAdditionalStrategy==="strict"?e.allowedAdditionalProperties:e.rejectedAdditionalProperties}}function jP(t){try{return t.isOptional()}catch{return!0}}const DP=(t,e)=>{var r;if(e.currentPath.toString()===((r=e.propertyPath)==null?void 0:r.toString()))return Ye(t.innerType._def,e);const n=Ye(t.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","1"]});return n?{anyOf:[{not:qn(e)},n]}:qn(e)},UP=(t,e)=>{if(e.pipeStrategy==="input")return Ye(t.in._def,e);if(e.pipeStrategy==="output")return Ye(t.out._def,e);const n=Ye(t.in._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),r=Ye(t.out._def,{...e,currentPath:[...e.currentPath,"allOf",n?"1":"0"]});return{allOf:[n,r].filter(s=>s!==void 0)}};function FP(t,e){return Ye(t.type._def,e)}function BP(t,e){const r={type:"array",uniqueItems:!0,items:Ye(t.valueType._def,{...e,currentPath:[...e.currentPath,"items"]})};return t.minSize&&tt(r,"minItems",t.minSize.value,t.minSize.message,e),t.maxSize&&tt(r,"maxItems",t.maxSize.value,t.maxSize.message,e),r}function zP(t,e){return t.rest?{type:"array",minItems:t.items.length,items:t.items.map((n,r)=>Ye(n._def,{...e,currentPath:[...e.currentPath,"items",`${r}`]})).reduce((n,r)=>r===void 0?n:[...n,r],[]),additionalItems:Ye(t.rest._def,{...e,currentPath:[...e.currentPath,"additionalItems"]})}:{type:"array",minItems:t.items.length,maxItems:t.items.length,items:t.items.map((n,r)=>Ye(n._def,{...e,currentPath:[...e.currentPath,"items",`${r}`]})).reduce((n,r)=>r===void 0?n:[...n,r],[])}}function ZP(t){return{not:qn(t)}}function VP(t){return qn(t)}const GP=(t,e)=>Ye(t.innerType._def,e),WP=(t,e,n)=>{switch(e){case U.ZodString:return u0(t,n);case U.ZodNumber:return PP(t,n);case U.ZodObject:return MP(t,n);case U.ZodBigInt:return gP(t,n);case U.ZodBoolean:return yP();case U.ZodDate:return l0(t,n);case U.ZodUndefined:return ZP(n);case U.ZodNull:return $P(n);case U.ZodArray:return mP(t,n);case U.ZodUnion:case U.ZodDiscriminatedUnion:return RP(t,n);case U.ZodIntersection:return SP(t,n);case U.ZodTuple:return zP(t,n);case U.ZodRecord:return d0(t,n);case U.ZodLiteral:return xP(t,n);case U.ZodEnum:return EP(t);case U.ZodNativeEnum:return CP(t);case U.ZodNullable:return NP(t,n);case U.ZodOptional:return DP(t,n);case U.ZodMap:return AP(t,n);case U.ZodSet:return BP(t,n);case U.ZodLazy:return()=>t.getter()._def;case U.ZodPromise:return FP(t,n);case U.ZodNaN:case U.ZodNever:return OP(n);case U.ZodEffects:return bP(t,n);case U.ZodAny:return qn(n);case U.ZodUnknown:return VP(n);case U.ZodDefault:return vP(t,n);case U.ZodBranded:return c0(t,n);case U.ZodReadonly:return GP(t,n);case U.ZodCatch:return _P(t,n);case U.ZodPipeline:return UP(t,n);case U.ZodFunction:case U.ZodVoid:case U.ZodSymbol:return;default:return(r=>{})()}};function Ye(t,e,n=!1){var o;const r=e.seen.get(t);if(e.override){const c=(o=e.override)==null?void 0:o.call(e,t,e,r,n);if(c!==UN)return c}if(r&&!n){const c=HP(r,e);if(c!==void 0)return c}const s={def:t,path:e.currentPath,jsonSchema:void 0};e.seen.set(t,s);const i=WP(t,t.typeName,e),a=typeof i=="function"?Ye(i(),e):i;if(a&&qP(t,e,a),e.postProcess){const c=e.postProcess(a,t,e);return s.jsonSchema=a,c}return s.jsonSchema=a,a}const HP=(t,e)=>{switch(e.$refStrategy){case"root":return{$ref:t.path.join("/")};case"relative":return{$ref:n0(e.currentPath,t.path)};case"none":case"seen":return t.path.length<e.currentPath.length&&t.path.every((n,r)=>e.currentPath[r]===n)?(console.warn(`Recursive reference detected at ${e.currentPath.join("/")}! Defaulting to any`),qn(e)):e.$refStrategy==="seen"?qn(e):void 0}},qP=(t,e,n)=>(t.description&&(n.description=t.description,e.markdownDescription&&(n.markdownDescription=t.description)),n),JP=(t,e)=>{const n=zN(e);let r;const s=Ye(t._def,n,!1)??qn(n);n.flags.hasReferencedOpenAiAnyType&&(r||(r={}),r[n.openAiAnyTypeName]||(r[n.openAiAnyTypeName]={type:["string","number","integer","boolean","array","null"],items:{$ref:n.$refStrategy==="relative"?"1":[...n.basePath,n.definitionPath,n.openAiAnyTypeName].join("/")}}));const i=r?{...s,[n.definitionPath]:r}:s;return n.target==="jsonSchema7"?i.$schema="http://json-schema.org/draft-07/schema#":(n.target==="jsonSchema2019-09"||n.target==="openAi")&&(i.$schema="https://json-schema.org/draft/2019-09/schema#"),n.target==="openAi"&&("anyOf"in i||"oneOf"in i||"allOf"in i||"type"in i&&Array.isArray(i.type))&&console.warn("Warning: OpenAI may not support schemas with unions as roots! Try wrapping it in an object property."),i};function Ei(t,e){const n=typeof t;if(n!==typeof e)return!1;if(Array.isArray(t)){if(!Array.isArray(e))return!1;const r=t.length;if(r!==e.length)return!1;for(let s=0;s<r;s++)if(!Ei(t[s],e[s]))return!1;return!0}if(n==="object"){if(!t||!e)return t===e;const r=Object.keys(t),s=Object.keys(e);if(r.length!==s.length)return!1;for(const a of r)if(!Ei(t[a],e[a]))return!1;return!0}return t===e}function gr(t){return encodeURI(KP(t))}function KP(t){return t.replace(/~/g,"~0").replace(/\//g,"~1")}const XP={prefixItems:!0,items:!0,allOf:!0,anyOf:!0,oneOf:!0},YP={$defs:!0,definitions:!0,properties:!0,patternProperties:!0,dependentSchemas:!0},QP={id:!0,$id:!0,$ref:!0,$schema:!0,$anchor:!0,$vocabulary:!0,$comment:!0,default:!0,enum:!0,const:!0,required:!0,type:!0,maximum:!0,minimum:!0,exclusiveMaximum:!0,exclusiveMinimum:!0,multipleOf:!0,maxLength:!0,minLength:!0,pattern:!0,format:!0,maxItems:!0,minItems:!0,uniqueItems:!0,maxProperties:!0,minProperties:!0};let eM=typeof self<"u"&&self.location&&self.location.origin!=="null"?new URL(self.location.origin+self.location.pathname+location.search):new URL("https://github.com/cfworker");function Ms(t,e=Object.create(null),n=eM,r=""){if(t&&typeof t=="object"&&!Array.isArray(t)){const i=t.$id||t.id;if(i){const a=new URL(i,n.href);a.hash.length>1?e[a.href]=t:(a.hash="",r===""?n=a:Ms(t,e,n))}}else if(t!==!0&&t!==!1)return e;const s=n.href+(r?"#"+r:"");if(e[s]!==void 0)throw new Error(`Duplicate schema URI "${s}".`);if(e[s]=t,t===!0||t===!1)return e;if(t.__absolute_uri__===void 0&&Object.defineProperty(t,"__absolute_uri__",{enumerable:!1,value:s}),t.$ref&&t.__absolute_ref__===void 0){const i=new URL(t.$ref,n.href);i.hash=i.hash,Object.defineProperty(t,"__absolute_ref__",{enumerable:!1,value:i.href})}if(t.$recursiveRef&&t.__absolute_recursive_ref__===void 0){const i=new URL(t.$recursiveRef,n.href);i.hash=i.hash,Object.defineProperty(t,"__absolute_recursive_ref__",{enumerable:!1,value:i.href})}if(t.$anchor){const i=new URL("#"+t.$anchor,n.href);e[i.href]=t}for(let i in t){if(QP[i])continue;const a=`${r}/${gr(i)}`,o=t[i];if(Array.isArray(o)){if(XP[i]){const c=o.length;for(let l=0;l<c;l++)Ms(o[l],e,n,`${a}/${l}`)}}else if(YP[i])for(let c in o)Ms(o[c],e,n,`${a}/${gr(c)}`);else Ms(o,e,n,a)}return e}const tM=/^(\d\d\d\d)-(\d\d)-(\d\d)$/,nM=[0,31,28,31,30,31,30,31,31,30,31,30,31],rM=/^(\d\d):(\d\d):(\d\d)(\.\d+)?(z|[+-]\d\d(?::?\d\d)?)?$/i,sM=/^(?=.{1,253}\.?$)[a-z0-9](?:[a-z0-9-]{0,61}[a-z0-9])?(?:\.[a-z0-9](?:[-0-9a-z]{0,61}[0-9a-z])?)*\.?$/i,iM=/^(?:[a-z][a-z0-9+\-.]*:)?(?:\/?\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:]|%[0-9a-f]{2})*@)?(?:\[(?:(?:(?:(?:[0-9a-f]{1,4}:){6}|::(?:[0-9a-f]{1,4}:){5}|(?:[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){4}|(?:(?:[0-9a-f]{1,4}:){0,1}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){3}|(?:(?:[0-9a-f]{1,4}:){0,2}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){2}|(?:(?:[0-9a-f]{1,4}:){0,3}[0-9a-f]{1,4})?::[0-9a-f]{1,4}:|(?:(?:[0-9a-f]{1,4}:){0,4}[0-9a-f]{1,4})?::)(?:[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?))|(?:(?:[0-9a-f]{1,4}:){0,5}[0-9a-f]{1,4})?::[0-9a-f]{1,4}|(?:(?:[0-9a-f]{1,4}:){0,6}[0-9a-f]{1,4})?::)|[Vv][0-9a-f]+\.[a-z0-9\-._~!$&'()*+,;=:]+)\]|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)|(?:[a-z0-9\-._~!$&'"()*+,;=]|%[0-9a-f]{2})*)(?::\d*)?(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*|\/(?:(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*)?|(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*)?(?:\?(?:[a-z0-9\-._~!$&'"()*+,;=:@/?]|%[0-9a-f]{2})*)?(?:#(?:[a-z0-9\-._~!$&'"()*+,;=:@/?]|%[0-9a-f]{2})*)?$/i,aM=/^(?:(?:[^\x00-\x20"'<>%\\^`{|}]|%[0-9a-f]{2})|\{[+#./;?&=,!@|]?(?:[a-z0-9_]|%[0-9a-f]{2})+(?::[1-9][0-9]{0,3}|\*)?(?:,(?:[a-z0-9_]|%[0-9a-f]{2})+(?::[1-9][0-9]{0,3}|\*)?)*\})*$/i,oM=/^(?:(?:https?|ftp):\/\/)(?:\S+(?::\S*)?@)?(?:(?!10(?:\.\d{1,3}){3})(?!127(?:\.\d{1,3}){3})(?!169\.254(?:\.\d{1,3}){2})(?!192\.168(?:\.\d{1,3}){2})(?!172\.(?:1[6-9]|2\d|3[0-1])(?:\.\d{1,3}){2})(?:[1-9]\d?|1\d\d|2[01]\d|22[0-3])(?:\.(?:1?\d{1,2}|2[0-4]\d|25[0-5])){2}(?:\.(?:[1-9]\d?|1\d\d|2[0-4]\d|25[0-4]))|(?:(?:[a-z\u{00a1}-\u{ffff}0-9]+-?)*[a-z\u{00a1}-\u{ffff}0-9]+)(?:\.(?:[a-z\u{00a1}-\u{ffff}0-9]+-?)*[a-z\u{00a1}-\u{ffff}0-9]+)*(?:\.(?:[a-z\u{00a1}-\u{ffff}]{2,})))(?::\d{2,5})?(?:\/[^\s]*)?$/iu,cM=/^(?:urn:uuid:)?[0-9a-f]{8}-(?:[0-9a-f]{4}-){3}[0-9a-f]{12}$/i,lM=/^(?:\/(?:[^~/]|~0|~1)*)*$/,uM=/^#(?:\/(?:[a-z0-9_\-.!$&'()*+,;:=@]|%[0-9a-f]{2}|~0|~1)*)*$/i,dM=/^(?:0|[1-9][0-9]*)(?:#|(?:\/(?:[^~/]|~0|~1)*)*)$/,hM=t=>{if(t[0]==='"')return!1;const[e,n,...r]=t.split("@");return!e||!n||r.length!==0||e.length>64||n.length>253||e[0]==="."||e.endsWith(".")||e.includes("..")||!/^[a-z0-9.-]+$/i.test(n)||!/^[a-z0-9.!#$%&'*+/=?^_`{|}~-]+$/i.test(e)?!1:n.split(".").every(s=>/^[a-z0-9]([a-z0-9-]{0,61}[a-z0-9])?$/i.test(s))},fM=/^(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)$/,pM=/^((([0-9a-f]{1,4}:){7}([0-9a-f]{1,4}|:))|(([0-9a-f]{1,4}:){6}(:[0-9a-f]{1,4}|((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9a-f]{1,4}:){5}(((:[0-9a-f]{1,4}){1,2})|:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9a-f]{1,4}:){4}(((:[0-9a-f]{1,4}){1,3})|((:[0-9a-f]{1,4})?:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){3}(((:[0-9a-f]{1,4}){1,4})|((:[0-9a-f]{1,4}){0,2}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){2}(((:[0-9a-f]{1,4}){1,5})|((:[0-9a-f]{1,4}){0,3}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){1}(((:[0-9a-f]{1,4}){1,6})|((:[0-9a-f]{1,4}){0,4}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(:(((:[0-9a-f]{1,4}){1,7})|((:[0-9a-f]{1,4}){0,5}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:)))$/i,mM=t=>t.length>1&&t.length<80&&(/^P\d+([.,]\d+)?W$/.test(t)||/^P[\dYMDTHS]*(\d[.,]\d+)?[YMDHS]$/.test(t)&&/^P([.,\d]+Y)?([.,\d]+M)?([.,\d]+D)?(T([.,\d]+H)?([.,\d]+M)?([.,\d]+S)?)?$/.test(t));function Cr(t){return t.test.bind(t)}const Xy={date:h0,time:f0.bind(void 0,!1),"date-time":_M,duration:mM,uri:bM,"uri-reference":Cr(iM),"uri-template":Cr(aM),url:Cr(oM),email:hM,hostname:Cr(sM),ipv4:Cr(fM),ipv6:Cr(pM),regex:TM,uuid:Cr(cM),"json-pointer":Cr(lM),"json-pointer-uri-fragment":Cr(uM),"relative-json-pointer":Cr(dM)};function gM(t){return t%4===0&&(t%100!==0||t%400===0)}function h0(t){const e=t.match(tM);if(!e)return!1;const n=+e[1],r=+e[2],s=+e[3];return r>=1&&r<=12&&s>=1&&s<=(r==2&&gM(n)?29:nM[r])}function f0(t,e){const n=e.match(rM);if(!n)return!1;const r=+n[1],s=+n[2],i=+n[3],a=!!n[5];return(r<=23&&s<=59&&i<=59||r==23&&s==59&&i==60)&&(!t||a)}const yM=/t|\s/i;function _M(t){const e=t.split(yM);return e.length==2&&h0(e[0])&&f0(!0,e[1])}const wM=/\/|:/,vM=/^(?:[a-z][a-z0-9+\-.]*:)(?:\/?\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:]|%[0-9a-f]{2})*@)?(?:\[(?:(?:(?:(?:[0-9a-f]{1,4}:){6}|::(?:[0-9a-f]{1,4}:){5}|(?:[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){4}|(?:(?:[0-9a-f]{1,4}:){0,1}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){3}|(?:(?:[0-9a-f]{1,4}:){0,2}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){2}|(?:(?:[0-9a-f]{1,4}:){0,3}[0-9a-f]{1,4})?::[0-9a-f]{1,4}:|(?:(?:[0-9a-f]{1,4}:){0,4}[0-9a-f]{1,4})?::)(?:[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?))|(?:(?:[0-9a-f]{1,4}:){0,5}[0-9a-f]{1,4})?::[0-9a-f]{1,4}|(?:(?:[0-9a-f]{1,4}:){0,6}[0-9a-f]{1,4})?::)|[Vv][0-9a-f]+\.[a-z0-9\-._~!$&'()*+,;=:]+)\]|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)|(?:[a-z0-9\-._~!$&'()*+,;=]|%[0-9a-f]{2})*)(?::\d*)?(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*|\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*)?|(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*)(?:\?(?:[a-z0-9\-._~!$&'()*+,;=:@/?]|%[0-9a-f]{2})*)?(?:#(?:[a-z0-9\-._~!$&'()*+,;=:@/?]|%[0-9a-f]{2})*)?$/i;function bM(t){return wM.test(t)&&vM.test(t)}const EM=/[^\\]\\Z/;function TM(t){if(EM.test(t))return!1;try{return new RegExp(t,"u"),!0}catch{return!1}}function SM(t){let e=0,n=t.length,r=0,s;for(;r<n;)e++,s=t.charCodeAt(r++),s>=55296&&s<=56319&&r<n&&(s=t.charCodeAt(r),(s&64512)==56320&&r++);return e}function ut(t,e,n="2019-09",r=Ms(e),s=!0,i=null,a="#",o="#",c=Object.create(null)){if(e===!0)return{valid:!0,errors:[]};if(e===!1)return{valid:!1,errors:[{instanceLocation:a,keyword:"false",keywordLocation:a,error:"False boolean schema."}]};const l=typeof t;let u;switch(l){case"boolean":case"number":case"string":u=l;break;case"object":t===null?u="null":Array.isArray(t)?u="array":u="object";break;default:throw new Error(`Instances of "${l}" type are not supported.`)}const{$ref:d,$recursiveRef:h,$recursiveAnchor:f,type:m,const:g,enum:w,required:b,not:y,anyOf:v,allOf:T,oneOf:A,if:I,then:$,else:S,format:M,properties:j,patternProperties:P,additionalProperties:W,unevaluatedProperties:ne,minProperties:B,maxProperties:V,propertyNames:H,dependentRequired:oe,dependentSchemas:fe,dependencies:se,prefixItems:ye,items:Ne,additionalItems:K,unevaluatedItems:re,contains:de,minContains:X,maxContains:C,minItems:x,maxItems:F,uniqueItems:N,minimum:Oe,maximum:Me,exclusiveMinimum:Ke,exclusiveMaximum:ot,multipleOf:yt,minLength:qt,maxLength:Qe,pattern:Bt,__absolute_ref__:Ts,__absolute_recursive_ref__:ji}=e,Q=[];if(f===!0&&i===null&&(i=e),h==="#"){const ke=i===null?r[ji]:i,me=`${o}/$recursiveRef`,xe=ut(t,i===null?e:i,n,r,s,ke,a,me,c);xe.valid||Q.push({instanceLocation:a,keyword:"$recursiveRef",keywordLocation:me,error:"A subschema had errors."},...xe.errors)}if(d!==void 0){const me=r[Ts||d];if(me===void 0){let Y=`Unresolved $ref "${d}".`;throw Ts&&Ts!==d&&(Y+=`  Absolute URI "${Ts}".`),Y+=`
Known schemas:
- ${Object.keys(r).join(`
- `)}`,new Error(Y)}const xe=`${o}/$ref`,ee=ut(t,me,n,r,s,i,a,xe,c);if(ee.valid||Q.push({instanceLocation:a,keyword:"$ref",keywordLocation:xe,error:"A subschema had errors."},...ee.errors),n==="4"||n==="7")return{valid:Q.length===0,errors:Q}}if(Array.isArray(m)){let ke=m.length,me=!1;for(let xe=0;xe<ke;xe++)if(u===m[xe]||m[xe]==="integer"&&u==="number"&&t%1===0&&t===t){me=!0;break}me||Q.push({instanceLocation:a,keyword:"type",keywordLocation:`${o}/type`,error:`Instance type "${u}" is invalid. Expected "${m.join('", "')}".`})}else m==="integer"?(u!=="number"||t%1||t!==t)&&Q.push({instanceLocation:a,keyword:"type",keywordLocation:`${o}/type`,error:`Instance type "${u}" is invalid. Expected "${m}".`}):m!==void 0&&u!==m&&Q.push({instanceLocation:a,keyword:"type",keywordLocation:`${o}/type`,error:`Instance type "${u}" is invalid. Expected "${m}".`});if(g!==void 0&&(u==="object"||u==="array"?Ei(t,g)||Q.push({instanceLocation:a,keyword:"const",keywordLocation:`${o}/const`,error:`Instance does not match ${JSON.stringify(g)}.`}):t!==g&&Q.push({instanceLocation:a,keyword:"const",keywordLocation:`${o}/const`,error:`Instance does not match ${JSON.stringify(g)}.`})),w!==void 0&&(u==="object"||u==="array"?w.some(ke=>Ei(t,ke))||Q.push({instanceLocation:a,keyword:"enum",keywordLocation:`${o}/enum`,error:`Instance does not match any of ${JSON.stringify(w)}.`}):w.some(ke=>t===ke)||Q.push({instanceLocation:a,keyword:"enum",keywordLocation:`${o}/enum`,error:`Instance does not match any of ${JSON.stringify(w)}.`})),y!==void 0){const ke=`${o}/not`;ut(t,y,n,r,s,i,a,ke).valid&&Q.push({instanceLocation:a,keyword:"not",keywordLocation:ke,error:'Instance matched "not" schema.'})}let Jr=[];if(v!==void 0){const ke=`${o}/anyOf`,me=Q.length;let xe=!1;for(let ee=0;ee<v.length;ee++){const Y=v[ee],Ie=Object.create(c),we=ut(t,Y,n,r,s,f===!0?i:null,a,`${ke}/${ee}`,Ie);Q.push(...we.errors),xe=xe||we.valid,we.valid&&Jr.push(Ie)}xe?Q.length=me:Q.splice(me,0,{instanceLocation:a,keyword:"anyOf",keywordLocation:ke,error:"Instance does not match any subschemas."})}if(T!==void 0){const ke=`${o}/allOf`,me=Q.length;let xe=!0;for(let ee=0;ee<T.length;ee++){const Y=T[ee],Ie=Object.create(c),we=ut(t,Y,n,r,s,f===!0?i:null,a,`${ke}/${ee}`,Ie);Q.push(...we.errors),xe=xe&&we.valid,we.valid&&Jr.push(Ie)}xe?Q.length=me:Q.splice(me,0,{instanceLocation:a,keyword:"allOf",keywordLocation:ke,error:"Instance does not match every subschema."})}if(A!==void 0){const ke=`${o}/oneOf`,me=Q.length,xe=A.filter((ee,Y)=>{const Ie=Object.create(c),we=ut(t,ee,n,r,s,f===!0?i:null,a,`${ke}/${Y}`,Ie);return Q.push(...we.errors),we.valid&&Jr.push(Ie),we.valid}).length;xe===1?Q.length=me:Q.splice(me,0,{instanceLocation:a,keyword:"oneOf",keywordLocation:ke,error:`Instance does not match exactly one subschema (${xe} matches).`})}if((u==="object"||u==="array")&&Object.assign(c,...Jr),I!==void 0){const ke=`${o}/if`;if(ut(t,I,n,r,s,i,a,ke,c).valid){if($!==void 0){const xe=ut(t,$,n,r,s,i,a,`${o}/then`,c);xe.valid||Q.push({instanceLocation:a,keyword:"if",keywordLocation:ke,error:'Instance does not match "then" schema.'},...xe.errors)}}else if(S!==void 0){const xe=ut(t,S,n,r,s,i,a,`${o}/else`,c);xe.valid||Q.push({instanceLocation:a,keyword:"if",keywordLocation:ke,error:'Instance does not match "else" schema.'},...xe.errors)}}if(u==="object"){if(b!==void 0)for(const ee of b)ee in t||Q.push({instanceLocation:a,keyword:"required",keywordLocation:`${o}/required`,error:`Instance does not have required property "${ee}".`});const ke=Object.keys(t);if(B!==void 0&&ke.length<B&&Q.push({instanceLocation:a,keyword:"minProperties",keywordLocation:`${o}/minProperties`,error:`Instance does not have at least ${B} properties.`}),V!==void 0&&ke.length>V&&Q.push({instanceLocation:a,keyword:"maxProperties",keywordLocation:`${o}/maxProperties`,error:`Instance does not have at least ${V} properties.`}),H!==void 0){const ee=`${o}/propertyNames`;for(const Y in t){const Ie=`${a}/${gr(Y)}`,we=ut(Y,H,n,r,s,i,Ie,ee);we.valid||Q.push({instanceLocation:a,keyword:"propertyNames",keywordLocation:ee,error:`Property name "${Y}" does not match schema.`},...we.errors)}}if(oe!==void 0){const ee=`${o}/dependantRequired`;for(const Y in oe)if(Y in t){const Ie=oe[Y];for(const we of Ie)we in t||Q.push({instanceLocation:a,keyword:"dependentRequired",keywordLocation:ee,error:`Instance has "${Y}" but does not have "${we}".`})}}if(fe!==void 0)for(const ee in fe){const Y=`${o}/dependentSchemas`;if(ee in t){const Ie=ut(t,fe[ee],n,r,s,i,a,`${Y}/${gr(ee)}`,c);Ie.valid||Q.push({instanceLocation:a,keyword:"dependentSchemas",keywordLocation:Y,error:`Instance has "${ee}" but does not match dependant schema.`},...Ie.errors)}}if(se!==void 0){const ee=`${o}/dependencies`;for(const Y in se)if(Y in t){const Ie=se[Y];if(Array.isArray(Ie))for(const we of Ie)we in t||Q.push({instanceLocation:a,keyword:"dependencies",keywordLocation:ee,error:`Instance has "${Y}" but does not have "${we}".`});else{const we=ut(t,Ie,n,r,s,i,a,`${ee}/${gr(Y)}`);we.valid||Q.push({instanceLocation:a,keyword:"dependencies",keywordLocation:ee,error:`Instance has "${Y}" but does not match dependant schema.`},...we.errors)}}}const me=Object.create(null);let xe=!1;if(j!==void 0){const ee=`${o}/properties`;for(const Y in j){if(!(Y in t))continue;const Ie=`${a}/${gr(Y)}`,we=ut(t[Y],j[Y],n,r,s,i,Ie,`${ee}/${gr(Y)}`);if(we.valid)c[Y]=me[Y]=!0;else if(xe=s,Q.push({instanceLocation:a,keyword:"properties",keywordLocation:ee,error:`Property "${Y}" does not match schema.`},...we.errors),xe)break}}if(!xe&&P!==void 0){const ee=`${o}/patternProperties`;for(const Y in P){const Ie=new RegExp(Y,"u"),we=P[Y];for(const nn in t){if(!Ie.test(nn))continue;const k=`${a}/${gr(nn)}`,_=ut(t[nn],we,n,r,s,i,k,`${ee}/${gr(Y)}`);_.valid?c[nn]=me[nn]=!0:(xe=s,Q.push({instanceLocation:a,keyword:"patternProperties",keywordLocation:ee,error:`Property "${nn}" matches pattern "${Y}" but does not match associated schema.`},..._.errors))}}}if(!xe&&W!==void 0){const ee=`${o}/additionalProperties`;for(const Y in t){if(me[Y])continue;const Ie=`${a}/${gr(Y)}`,we=ut(t[Y],W,n,r,s,i,Ie,ee);we.valid?c[Y]=!0:(xe=s,Q.push({instanceLocation:a,keyword:"additionalProperties",keywordLocation:ee,error:`Property "${Y}" does not match additional properties schema.`},...we.errors))}}else if(!xe&&ne!==void 0){const ee=`${o}/unevaluatedProperties`;for(const Y in t)if(!c[Y]){const Ie=`${a}/${gr(Y)}`,we=ut(t[Y],ne,n,r,s,i,Ie,ee);we.valid?c[Y]=!0:Q.push({instanceLocation:a,keyword:"unevaluatedProperties",keywordLocation:ee,error:`Property "${Y}" does not match unevaluated properties schema.`},...we.errors)}}}else if(u==="array"){F!==void 0&&t.length>F&&Q.push({instanceLocation:a,keyword:"maxItems",keywordLocation:`${o}/maxItems`,error:`Array has too many items (${t.length} > ${F}).`}),x!==void 0&&t.length<x&&Q.push({instanceLocation:a,keyword:"minItems",keywordLocation:`${o}/minItems`,error:`Array has too few items (${t.length} < ${x}).`});const ke=t.length;let me=0,xe=!1;if(ye!==void 0){const ee=`${o}/prefixItems`,Y=Math.min(ye.length,ke);for(;me<Y;me++){const Ie=ut(t[me],ye[me],n,r,s,i,`${a}/${me}`,`${ee}/${me}`);if(c[me]=!0,!Ie.valid&&(xe=s,Q.push({instanceLocation:a,keyword:"prefixItems",keywordLocation:ee,error:"Items did not match schema."},...Ie.errors),xe))break}}if(Ne!==void 0){const ee=`${o}/items`;if(Array.isArray(Ne)){const Y=Math.min(Ne.length,ke);for(;me<Y;me++){const Ie=ut(t[me],Ne[me],n,r,s,i,`${a}/${me}`,`${ee}/${me}`);if(c[me]=!0,!Ie.valid&&(xe=s,Q.push({instanceLocation:a,keyword:"items",keywordLocation:ee,error:"Items did not match schema."},...Ie.errors),xe))break}}else for(;me<ke;me++){const Y=ut(t[me],Ne,n,r,s,i,`${a}/${me}`,ee);if(c[me]=!0,!Y.valid&&(xe=s,Q.push({instanceLocation:a,keyword:"items",keywordLocation:ee,error:"Items did not match schema."},...Y.errors),xe))break}if(!xe&&K!==void 0){const Y=`${o}/additionalItems`;for(;me<ke;me++){const Ie=ut(t[me],K,n,r,s,i,`${a}/${me}`,Y);c[me]=!0,Ie.valid||(xe=s,Q.push({instanceLocation:a,keyword:"additionalItems",keywordLocation:Y,error:"Items did not match additional items schema."},...Ie.errors))}}}if(de!==void 0)if(ke===0&&X===void 0)Q.push({instanceLocation:a,keyword:"contains",keywordLocation:`${o}/contains`,error:"Array is empty. It must contain at least one item matching the schema."});else if(X!==void 0&&ke<X)Q.push({instanceLocation:a,keyword:"minContains",keywordLocation:`${o}/minContains`,error:`Array has less items (${ke}) than minContains (${X}).`});else{const ee=`${o}/contains`,Y=Q.length;let Ie=0;for(let we=0;we<ke;we++){const nn=ut(t[we],de,n,r,s,i,`${a}/${we}`,ee);nn.valid?(c[we]=!0,Ie++):Q.push(...nn.errors)}Ie>=(X||0)&&(Q.length=Y),X===void 0&&C===void 0&&Ie===0?Q.splice(Y,0,{instanceLocation:a,keyword:"contains",keywordLocation:ee,error:"Array does not contain item matching schema."}):X!==void 0&&Ie<X?Q.push({instanceLocation:a,keyword:"minContains",keywordLocation:`${o}/minContains`,error:`Array must contain at least ${X} items matching schema. Only ${Ie} items were found.`}):C!==void 0&&Ie>C&&Q.push({instanceLocation:a,keyword:"maxContains",keywordLocation:`${o}/maxContains`,error:`Array may contain at most ${C} items matching schema. ${Ie} items were found.`})}if(!xe&&re!==void 0){const ee=`${o}/unevaluatedItems`;for(me;me<ke;me++){if(c[me])continue;const Y=ut(t[me],re,n,r,s,i,`${a}/${me}`,ee);c[me]=!0,Y.valid||Q.push({instanceLocation:a,keyword:"unevaluatedItems",keywordLocation:ee,error:"Items did not match unevaluated items schema."},...Y.errors)}}if(N)for(let ee=0;ee<ke;ee++){const Y=t[ee],Ie=typeof Y=="object"&&Y!==null;for(let we=0;we<ke;we++){if(ee===we)continue;const nn=t[we];(Y===nn||Ie&&(typeof nn=="object"&&nn!==null)&&Ei(Y,nn))&&(Q.push({instanceLocation:a,keyword:"uniqueItems",keywordLocation:`${o}/uniqueItems`,error:`Duplicate items at indexes ${ee} and ${we}.`}),ee=Number.MAX_SAFE_INTEGER,we=Number.MAX_SAFE_INTEGER)}}}else if(u==="number"){if(n==="4"?(Oe!==void 0&&(Ke===!0&&t<=Oe||t<Oe)&&Q.push({instanceLocation:a,keyword:"minimum",keywordLocation:`${o}/minimum`,error:`${t} is less than ${Ke?"or equal to ":""} ${Oe}.`}),Me!==void 0&&(ot===!0&&t>=Me||t>Me)&&Q.push({instanceLocation:a,keyword:"maximum",keywordLocation:`${o}/maximum`,error:`${t} is greater than ${ot?"or equal to ":""} ${Me}.`})):(Oe!==void 0&&t<Oe&&Q.push({instanceLocation:a,keyword:"minimum",keywordLocation:`${o}/minimum`,error:`${t} is less than ${Oe}.`}),Me!==void 0&&t>Me&&Q.push({instanceLocation:a,keyword:"maximum",keywordLocation:`${o}/maximum`,error:`${t} is greater than ${Me}.`}),Ke!==void 0&&t<=Ke&&Q.push({instanceLocation:a,keyword:"exclusiveMinimum",keywordLocation:`${o}/exclusiveMinimum`,error:`${t} is less than ${Ke}.`}),ot!==void 0&&t>=ot&&Q.push({instanceLocation:a,keyword:"exclusiveMaximum",keywordLocation:`${o}/exclusiveMaximum`,error:`${t} is greater than or equal to ${ot}.`})),yt!==void 0){const ke=t%yt;Math.abs(0-ke)>=11920929e-14&&Math.abs(yt-ke)>=11920929e-14&&Q.push({instanceLocation:a,keyword:"multipleOf",keywordLocation:`${o}/multipleOf`,error:`${t} is not a multiple of ${yt}.`})}}else if(u==="string"){const ke=qt===void 0&&Qe===void 0?0:SM(t);qt!==void 0&&ke<qt&&Q.push({instanceLocation:a,keyword:"minLength",keywordLocation:`${o}/minLength`,error:`String is too short (${ke} < ${qt}).`}),Qe!==void 0&&ke>Qe&&Q.push({instanceLocation:a,keyword:"maxLength",keywordLocation:`${o}/maxLength`,error:`String is too long (${ke} > ${Qe}).`}),Bt!==void 0&&!new RegExp(Bt,"u").test(t)&&Q.push({instanceLocation:a,keyword:"pattern",keywordLocation:`${o}/pattern`,error:"String does not match pattern."}),M!==void 0&&Xy[M]&&!Xy[M](t)&&Q.push({instanceLocation:a,keyword:"format",keywordLocation:`${o}/format`,error:`String does not match format "${M}".`})}return{valid:Q.length===0,errors:Q}}class lm{constructor(e,n="2019-09",r=!0){p(this,"schema");p(this,"draft");p(this,"shortCircuit");p(this,"lookup");this.schema=e,this.draft=n,this.shortCircuit=r,this.lookup=Ms(e)}validate(e){return ut(e,this.schema,this.draft,this.lookup,this.shortCircuit)}addSchema(e,n){n&&(e={...e,$id:n}),Ms(e,this.lookup)}}var p0={};Se(p0,{Validator:()=>lm,deepCompareStrict:()=>Ei,toJsonSchema:()=>bt,validatesOnlyStrings:()=>lo});function bt(t,e){if(it(t)){const n=Qb(t,!0);if(Vr(n)){const r=Wl(n,!0);return nf(r,e)}else return nf(t,e)}return Ct(t)?JP(t):t}function lo(t){if(!t||typeof t!="object"||Object.keys(t).length===0||Array.isArray(t))return!1;if("type"in t)return typeof t.type=="string"?t.type==="string":Array.isArray(t.type)?t.type.every(e=>e==="string"):!1;if("enum"in t)return Array.isArray(t.enum)&&t.enum.length>0&&t.enum.every(e=>typeof e=="string");if("const"in t)return typeof t.const=="string";if("allOf"in t&&Array.isArray(t.allOf))return t.allOf.some(e=>lo(e));if("anyOf"in t&&Array.isArray(t.anyOf)||"oneOf"in t&&Array.isArray(t.oneOf)){const e="anyOf"in t?t.anyOf:t.oneOf;return e.length>0&&e.every(n=>lo(n))}if("not"in t)return!1;if("$ref"in t&&typeof t.$ref=="string"){const e=t.$ref,n=Ms(t);return n[e]?lo(n[e]):!1}return!1}var m0={};Se(m0,{Graph:()=>Mo});function xM(t,e){if(t!==void 0&&!wi(t))return t;if(Jp(e))try{let n=e.getName();return n=n.startsWith("Runnable")?n.slice(8):n,n}catch{return e.getName()}else return e.name??"UnknownSchema"}function kM(t){return Jp(t.data)?{type:"runnable",data:{id:t.data.lc_id,name:t.data.getName()}}:{type:"schema",data:{...bt(t.data.schema),title:t.data.name}}}var Mo=class g0{constructor(e){p(this,"nodes",{});p(this,"edges",[]);this.nodes=(e==null?void 0:e.nodes)??this.nodes,this.edges=(e==null?void 0:e.edges)??this.edges}toJSON(){const e={};return Object.values(this.nodes).forEach((n,r)=>{e[n.id]=wi(n.id)?r:n.id}),{nodes:Object.values(this.nodes).map(n=>({id:e[n.id],...kM(n)})),edges:this.edges.map(n=>{const r={source:e[n.source],target:e[n.target]};return typeof n.data<"u"&&(r.data=n.data),typeof n.conditional<"u"&&(r.conditional=n.conditional),r})}}addNode(e,n,r){if(n!==void 0&&this.nodes[n]!==void 0)throw new Error(`Node with id ${n} already exists`);const s=n??vr(),i={id:s,data:e,name:xM(n,e),metadata:r};return this.nodes[s]=i,i}removeNode(e){delete this.nodes[e.id],this.edges=this.edges.filter(n=>n.source!==e.id&&n.target!==e.id)}addEdge(e,n,r,s){if(this.nodes[e.id]===void 0)throw new Error(`Source node ${e.id} not in graph`);if(this.nodes[n.id]===void 0)throw new Error(`Target node ${n.id} not in graph`);const i={source:e.id,target:n.id,data:r,conditional:s};return this.edges.push(i),i}firstNode(){return Yy(this)}lastNode(){return Qy(this)}extend(e,n=""){let r=n;Object.values(e.nodes).map(l=>l.id).every(wi)&&(r="");const i=l=>r?`${r}:${l}`:l;Object.entries(e.nodes).forEach(([l,u])=>{this.nodes[i(l)]={...u,id:i(l)}});const a=e.edges.map(l=>({...l,source:i(l.source),target:i(l.target)}));this.edges=[...this.edges,...a];const o=e.firstNode(),c=e.lastNode();return[o?{id:i(o.id),data:o.data}:void 0,c?{id:i(c.id),data:c.data}:void 0]}trimFirstNode(){const e=this.firstNode();e&&Yy(this,[e.id])&&this.removeNode(e)}trimLastNode(){const e=this.lastNode();e&&Qy(this,[e.id])&&this.removeNode(e)}reid(){const e=Object.fromEntries(Object.values(this.nodes).map(s=>[s.id,s.name])),n=new Map;Object.values(e).forEach(s=>{n.set(s,(n.get(s)||0)+1)});const r=s=>{const i=e[s];return wi(s)&&n.get(i)===1?i:s};return new g0({nodes:Object.fromEntries(Object.entries(this.nodes).map(([s,i])=>[r(s),{...i,id:r(s)}])),edges:this.edges.map(s=>({...s,source:r(s.source),target:r(s.target)}))})}drawMermaid(e){const{withStyles:n,curveStyle:r,nodeColors:s={default:"fill:#f2f0ff,line-height:1.2",first:"fill-opacity:0",last:"fill:#bfb6fc"},wrapLabelNWords:i}=e??{},a=this.reid(),o=a.firstNode(),c=a.lastNode();return jN(a.nodes,a.edges,{firstNode:o==null?void 0:o.id,lastNode:c==null?void 0:c.id,withStyles:n,curveStyle:r,nodeColors:s,wrapLabelNWords:i})}async drawMermaidPng(e){const n=this.drawMermaid(e);return DN(n,{backgroundColor:e==null?void 0:e.backgroundColor})}};function Yy(t,e=[]){const n=new Set(t.edges.filter(s=>!e.includes(s.source)).map(s=>s.target)),r=[];for(const s of Object.values(t.nodes))!e.includes(s.id)&&!n.has(s.id)&&r.push(s);return r.length===1?r[0]:void 0}function Qy(t,e=[]){const n=new Set(t.edges.filter(s=>!e.includes(s.target)).map(s=>s.source)),r=[];for(const s of Object.values(t.nodes))!e.includes(s.id)&&!n.has(s.id)&&r.push(s);return r.length===1?r[0]:void 0}function IM(t){const e=new TextEncoder,n=new ReadableStream({async start(r){for await(const s of t)r.enqueue(e.encode(`event: data
data: ${JSON.stringify(s)}

`));r.enqueue(e.encode(`event: end

`)),r.close()}});return hn.fromReadableStream(n)}function e_(t){return typeof t=="object"&&t!==null&&typeof t[Symbol.iterator]=="function"&&typeof t.next=="function"}const AM=t=>t!=null&&typeof t=="object"&&"next"in t&&typeof t.next=="function";function _f(t){return typeof t=="object"&&t!==null&&typeof t[Symbol.asyncIterator]=="function"}function*t_(t,e){for(;;){const{value:n,done:r}=Ft.runWithConfig(ps(t),e.next.bind(e),!0);if(r)break;yield n}}async function*wf(t,e){const n=e[Symbol.asyncIterator]();for(;;){const{value:r,done:s}=await Ft.runWithConfig(ps(t),n.next.bind(e),!0);if(s)break;yield r}}function Dt(t,e){return t&&!Array.isArray(t)&&!(t instanceof Date)&&typeof t=="object"?t:{[e]:t}}var Fe=class extends cr{constructor(){super(...arguments);p(this,"lc_runnable",!0);p(this,"name")}getName(e){const n=this.name??this.constructor.lc_name()??this.constructor.name;return e?`${n}${e}`:n}withRetry(e){return new um({bound:this,kwargs:{},config:{},maxAttemptNumber:e==null?void 0:e.stopAfterAttempt,...e})}withConfig(e){return new cn({bound:this,config:e,kwargs:{}})}withFallbacks(e){const n=Array.isArray(e)?e:e.fallbacks;return new E0({runnable:this,fallbacks:n})}_getOptionsList(e,n=0){if(Array.isArray(e)&&e.length!==n)throw new Error(`Passed "options" must be an array with the same length as the inputs, but got ${e.length} options for ${n} inputs`);if(Array.isArray(e))return e.map(Ze);if(n>1&&!Array.isArray(e)&&e.runId){console.warn("Provided runId will be used only for the first element of the batch.");const r=Object.fromEntries(Object.entries(e).filter(([s])=>s!=="runId"));return Array.from({length:n},(s,i)=>Ze(i===0?e:r))}return Array.from({length:n},()=>Ze(e))}async batch(e,n,r){var c;const s=this._getOptionsList(n??{},e.length),i=((c=s[0])==null?void 0:c.maxConcurrency)??(r==null?void 0:r.maxConcurrency),a=new sc({maxConcurrency:i,onFailedAttempt:l=>{throw l}}),o=e.map((l,u)=>a.call(async()=>{try{return await this.invoke(l,s[u])}catch(d){if(r!=null&&r.returnExceptions)return d;throw d}}));return Promise.all(o)}async*_streamIterator(e,n){yield this.invoke(e,n)}async stream(e,n){const r=Ze(n),s=new Ys({generator:this._streamIterator(e,r),config:r});return await s.setup,hn.fromAsyncGenerator(s)}_separateRunnableConfigFromCallOptions(e){let n;e===void 0?n=Ze(e):n=Ze({callbacks:e.callbacks,tags:e.tags,metadata:e.metadata,runName:e.runName,configurable:e.configurable,recursionLimit:e.recursionLimit,maxConcurrency:e.maxConcurrency,runId:e.runId,timeout:e.timeout,signal:e.signal});const r={...e};return delete r.callbacks,delete r.tags,delete r.metadata,delete r.runName,delete r.configurable,delete r.recursionLimit,delete r.maxConcurrency,delete r.runId,delete r.timeout,delete r.signal,[n,r]}async _callWithConfig(e,n,r){const s=Ze(r),i=await On(s),a=await(i==null?void 0:i.handleChainStart(this.toJSON(),Dt(n,"input"),s.runId,s==null?void 0:s.runType,void 0,void 0,(s==null?void 0:s.runName)??this.getName()));delete s.runId;let o;try{const c=e.call(this,n,s,a);o=await Hr(c,r==null?void 0:r.signal)}catch(c){throw await(a==null?void 0:a.handleChainError(c)),c}return await(a==null?void 0:a.handleChainEnd(Dt(o,"output"))),o}async _batchWithConfig(e,n,r,s){var l;const i=this._getOptionsList(r??{},n.length),a=await Promise.all(i.map(On)),o=await Promise.all(a.map(async(u,d)=>{const h=await(u==null?void 0:u.handleChainStart(this.toJSON(),Dt(n[d],"input"),i[d].runId,i[d].runType,void 0,void 0,i[d].runName??this.getName()));return delete i[d].runId,h}));let c;try{const u=e.call(this,n,i,o,s);c=await Hr(u,(l=i==null?void 0:i[0])==null?void 0:l.signal)}catch(u){throw await Promise.all(o.map(d=>d==null?void 0:d.handleChainError(u))),u}return await Promise.all(o.map(u=>u==null?void 0:u.handleChainEnd(Dt(c,"output")))),c}_concatOutputChunks(e,n){return Hs(e,n)}async*_transformStreamWithConfig(e,n,r){let s,i=!0,a,o=!0;const c=Ze(r),l=await On(c),u=this;async function*d(){for await(const f of e){if(i)if(s===void 0)s=f;else try{s=u._concatOutputChunks(s,f)}catch{s=void 0,i=!1}yield f}}let h;try{const f=await lb(n.bind(this),d(),async()=>l==null?void 0:l.handleChainStart(this.toJSON(),{input:""},c.runId,c.runType,void 0,void 0,c.runName??this.getName(),void 0,{lc_defers_inputs:!0}),r==null?void 0:r.signal,c);delete c.runId,h=f.setup;const m=h==null?void 0:h.handlers.find(D1);let g=f.output;m!==void 0&&h!==void 0&&(g=m.tapOutputIterable(h.runId,g));const w=h==null?void 0:h.handlers.find(pb);w!==void 0&&h!==void 0&&(g=w.tapOutputIterable(h.runId,g));for await(const b of g)if(yield b,o)if(a===void 0)a=b;else try{a=this._concatOutputChunks(a,b)}catch{a=void 0,o=!1}}catch(f){throw await(h==null?void 0:h.handleChainError(f,void 0,void 0,void 0,{inputs:Dt(s,"input")})),f}await(h==null?void 0:h.handleChainEnd(a??{},void 0,void 0,void 0,{inputs:Dt(s,"input")}))}getGraph(e){const n=new Mo,r=n.addNode({name:`${this.getName()}Input`,schema:Ea()}),s=n.addNode(this),i=n.addNode({name:`${this.getName()}Output`,schema:Ea()});return n.addEdge(r,s),n.addEdge(s,i),n}pipe(e){return new Jn({first:this,last:Qt(e)})}pick(e){return this.pipe(new T0(e))}assign(e){return this.pipe(new dm(new Na({steps:e})))}async*transform(e,n){let r;for await(const s of e)r===void 0?r=s:r=this._concatOutputChunks(r,s);yield*this._streamIterator(r,Ze(n))}async*streamLog(e,n,r){const s=new Qh({...r,autoClose:!1,_schemaFormat:"original"}),i=Ze(n);yield*this._streamLog(e,s,i)}async*_streamLog(e,n,r){const{callbacks:s}=r;if(s===void 0)r.callbacks=[n];else if(Array.isArray(s))r.callbacks=s.concat([n]);else{const c=s.copy();c.addHandler(n,!0),r.callbacks=c}const i=this.stream(e,r);async function a(){try{const c=await i;for await(const l of c){const u=new ts({ops:[{op:"add",path:"/streamed_output/-",value:l}]});await n.writer.write(u)}}finally{await n.writer.close()}}const o=a();try{for await(const c of n)yield c}finally{await o}}streamEvents(e,n,r){let s;if(n.version==="v1")s=this._streamEventsV1(e,n,r);else if(n.version==="v2")s=this._streamEventsV2(e,n,r);else throw new Error('Only versions "v1" and "v2" of the schema are currently supported.');return n.encoding==="text/event-stream"?IM(s):hn.fromAsyncGenerator(s)}async*_streamEventsV2(e,n,r){var m;const s=new U1({...r,autoClose:!1}),i=Ze(n),a=i.runId??vr();i.runId=a;const o=i.callbacks;if(o===void 0)i.callbacks=[s];else if(Array.isArray(o))i.callbacks=o.concat(s);else{const g=o.copy();g.addHandler(s,!0),i.callbacks=g}const c=new AbortController,l=this;async function u(){let g,w=null;try{n!=null&&n.signal?"any"in AbortSignal?g=AbortSignal.any([c.signal,n.signal]):(g=n.signal,w=()=>{c.abort()},n.signal.addEventListener("abort",w,{once:!0})):g=c.signal;const b=await l.stream(e,{...i,signal:g}),y=s.tapOutputIterable(a,b);for await(const v of y)if(c.signal.aborted)break}finally{await s.finish(),g&&w&&g.removeEventListener("abort",w)}}const d=u();let h=!1,f;try{for await(const g of s){if(!h){g.data.input=e,h=!0,f=g.run_id,yield g;continue}g.run_id===f&&g.event.endsWith("_end")&&(m=g.data)!=null&&m.input&&delete g.data.input,yield g}}finally{c.abort(),await d}}async*_streamEventsV1(e,n,r){let s,i=!1;const a=Ze(n),o=a.tags??[],c=a.metadata??{},l=a.runName??this.getName(),u=new Qh({...r,autoClose:!1,_schemaFormat:"streaming_events"}),d=new K1({...r}),h=this._streamLog(e,u,a);for await(const m of h){if(s?s=s.concat(m):s=qp.fromRunLogPatch(m),s.state===void 0)throw new Error('Internal error: "streamEvents" state is missing. Please open a bug report.');if(!i){i=!0;const y={...s.state},v={run_id:y.id,event:`on_${y.type}_start`,name:l,tags:o,metadata:c,data:{input:e}};d.includeEvent(v,y.type)&&(yield v)}const g=m.ops.filter(y=>y.path.startsWith("/logs/")).map(y=>y.path.split("/")[2]),w=[...new Set(g)];for(const y of w){let v,T={};const A=s.state.logs[y];if(A.end_time===void 0?A.streamed_output.length>0?v="stream":v="start":v="end",v==="start")A.inputs!==void 0&&(T.input=A.inputs);else if(v==="end")A.inputs!==void 0&&(T.input=A.inputs),T.output=A.final_output;else if(v==="stream"){const I=A.streamed_output.length;if(I!==1)throw new Error(`Expected exactly one chunk of streamed output, got ${I} instead. Encountered in: "${A.name}"`);T={chunk:A.streamed_output[0]},A.streamed_output=[]}yield{event:`on_${A.type}_${v}`,name:A.name,run_id:A.id,tags:A.tags,metadata:A.metadata,data:T}}const{state:b}=s;if(b.streamed_output.length>0){const y=b.streamed_output.length;if(y!==1)throw new Error(`Expected exactly one chunk of streamed output, got ${y} instead. Encountered in: "${b.name}"`);const v={chunk:b.streamed_output[0]};b.streamed_output=[];const T={event:`on_${b.type}_stream`,run_id:b.id,tags:o,metadata:c,name:l,data:v};d.includeEvent(T,b.type)&&(yield T)}}const f=s==null?void 0:s.state;if(f!==void 0){const m={event:`on_${f.type}_end`,name:l,run_id:f.id,tags:o,metadata:c,data:{output:f.final_output}};d.includeEvent(m,f.type)&&(yield m)}}static isRunnable(e){return Jp(e)}withListeners({onStart:e,onEnd:n,onError:r}){return new cn({bound:this,config:{},configFactories:[s=>({callbacks:[new wb({config:s,onStart:e,onEnd:n,onError:r})]})]})}asTool(e){return NM(this,e)}},cn=class y0 extends Fe{constructor(n){super(n);p(this,"lc_namespace",["langchain_core","runnables"]);p(this,"lc_serializable",!0);p(this,"bound");p(this,"config");p(this,"kwargs");p(this,"configFactories");this.bound=n.bound,this.kwargs=n.kwargs,this.config=n.config,this.configFactories=n.configFactories}static lc_name(){return"RunnableBinding"}getName(n){return this.bound.getName(n)}async _mergeConfig(...n){const r=Zn(this.config,...n);return Zn(r,...this.configFactories?await Promise.all(this.configFactories.map(async s=>await s(r))):[])}withConfig(n){return new this.constructor({bound:this.bound,kwargs:this.kwargs,config:{...this.config,...n}})}withRetry(n){return new um({bound:this.bound,kwargs:this.kwargs,config:this.config,maxAttemptNumber:n==null?void 0:n.stopAfterAttempt,...n})}async invoke(n,r){return this.bound.invoke(n,await this._mergeConfig(r,this.kwargs))}async batch(n,r,s){const i=Array.isArray(r)?await Promise.all(r.map(async a=>this._mergeConfig(Ze(a),this.kwargs))):await this._mergeConfig(Ze(r),this.kwargs);return this.bound.batch(n,i,s)}_concatOutputChunks(n,r){return this.bound._concatOutputChunks(n,r)}async*_streamIterator(n,r){yield*this.bound._streamIterator(n,await this._mergeConfig(Ze(r),this.kwargs))}async stream(n,r){return this.bound.stream(n,await this._mergeConfig(Ze(r),this.kwargs))}async*transform(n,r){yield*this.bound.transform(n,await this._mergeConfig(Ze(r),this.kwargs))}streamEvents(n,r,s){const i=this,a=async function*(){yield*i.bound.streamEvents(n,{...await i._mergeConfig(Ze(r),i.kwargs),version:r.version},s)};return hn.fromAsyncGenerator(a())}static isRunnableBinding(n){return n.bound&&Fe.isRunnable(n.bound)}withListeners({onStart:n,onEnd:r,onError:s}){return new y0({bound:this.bound,kwargs:this.kwargs,config:this.config,configFactories:[i=>({callbacks:[new wb({config:i,onStart:n,onEnd:r,onError:s})]})]})}},CM=class _0 extends Fe{constructor(n){super(n);p(this,"lc_serializable",!0);p(this,"lc_namespace",["langchain_core","runnables"]);p(this,"bound");this.bound=n.bound}static lc_name(){return"RunnableEach"}async invoke(n,r){return this._callWithConfig(this._invoke.bind(this),n,r)}async _invoke(n,r,s){return this.bound.batch(n,Xe(r,{callbacks:s==null?void 0:s.getChild()}))}withListeners({onStart:n,onEnd:r,onError:s}){return new _0({bound:this.bound.withListeners({onStart:n,onEnd:r,onError:s})})}},um=class extends cn{constructor(e){super(e);p(this,"lc_namespace",["langchain_core","runnables"]);p(this,"maxAttemptNumber",3);p(this,"onFailedAttempt",()=>{});this.maxAttemptNumber=e.maxAttemptNumber??this.maxAttemptNumber,this.onFailedAttempt=e.onFailedAttempt??this.onFailedAttempt}static lc_name(){return"RunnableRetry"}_patchConfigForRetry(e,n,r){const s=e>1?`retry:attempt:${e}`:void 0;return Xe(n,{callbacks:r==null?void 0:r.getChild(s)})}async _invoke(e,n,r){return ef(s=>super.invoke(e,this._patchConfigForRetry(s,n,r)),{onFailedAttempt:({error:s})=>this.onFailedAttempt(s,e),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}async invoke(e,n){return this._callWithConfig(this._invoke.bind(this),e,n)}async _batch(e,n,r,s){const i={};try{await ef(async a=>{const o=e.map((h,f)=>f).filter(h=>i[h.toString()]===void 0||i[h.toString()]instanceof Error),c=o.map(h=>e[h]),l=o.map(h=>this._patchConfigForRetry(a,n==null?void 0:n[h],r==null?void 0:r[h])),u=await super.batch(c,l,{...s,returnExceptions:!0});let d;for(let h=0;h<u.length;h+=1){const f=u[h],m=o[h];f instanceof Error&&d===void 0&&(d=f,d.input=c[h]),i[m.toString()]=f}if(d)throw d;return u},{onFailedAttempt:({error:a})=>this.onFailedAttempt(a,a.input),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}catch(a){if((s==null?void 0:s.returnExceptions)!==!0)throw a}return Object.keys(i).sort((a,o)=>parseInt(a,10)-parseInt(o,10)).map(a=>i[parseInt(a,10)])}async batch(e,n,r){return this._batchWithConfig(this._batch.bind(this),e,n,r)}},Jn=class Va extends Fe{constructor(n){super(n);p(this,"first");p(this,"middle",[]);p(this,"last");p(this,"omitSequenceTags",!1);p(this,"lc_serializable",!0);p(this,"lc_namespace",["langchain_core","runnables"]);this.first=n.first,this.middle=n.middle??this.middle,this.last=n.last,this.name=n.name,this.omitSequenceTags=n.omitSequenceTags??this.omitSequenceTags}static lc_name(){return"RunnableSequence"}get steps(){return[this.first,...this.middle,this.last]}async invoke(n,r){var l;const s=Ze(r),i=await On(s),a=await(i==null?void 0:i.handleChainStart(this.toJSON(),Dt(n,"input"),s.runId,void 0,void 0,void 0,s==null?void 0:s.runName));delete s.runId;let o=n,c;try{const u=[this.first,...this.middle];for(let d=0;d<u.length;d+=1){const f=u[d].invoke(o,Xe(s,{callbacks:a==null?void 0:a.getChild(this.omitSequenceTags?void 0:`seq:step:${d+1}`)}));o=await Hr(f,r==null?void 0:r.signal)}if((l=r==null?void 0:r.signal)!=null&&l.aborted)throw So(r.signal);c=await this.last.invoke(o,Xe(s,{callbacks:a==null?void 0:a.getChild(this.omitSequenceTags?void 0:`seq:step:${this.steps.length}`)}))}catch(u){throw await(a==null?void 0:a.handleChainError(u)),u}return await(a==null?void 0:a.handleChainEnd(Dt(c,"output"))),c}async batch(n,r,s){var l;const i=this._getOptionsList(r??{},n.length),a=await Promise.all(i.map(On)),o=await Promise.all(a.map(async(u,d)=>{const h=await(u==null?void 0:u.handleChainStart(this.toJSON(),Dt(n[d],"input"),i[d].runId,void 0,void 0,void 0,i[d].runName));return delete i[d].runId,h}));let c=n;try{for(let u=0;u<this.steps.length;u+=1){const h=this.steps[u].batch(c,o.map((f,m)=>{const g=f==null?void 0:f.getChild(this.omitSequenceTags?void 0:`seq:step:${u+1}`);return Xe(i[m],{callbacks:g})}),s);c=await Hr(h,(l=i[0])==null?void 0:l.signal)}}catch(u){throw await Promise.all(o.map(d=>d==null?void 0:d.handleChainError(u))),u}return await Promise.all(o.map(u=>u==null?void 0:u.handleChainEnd(Dt(c,"output")))),c}_concatOutputChunks(n,r){return this.last._concatOutputChunks(n,r)}async*_streamIterator(n,r){var h;const s=await On(r),{runId:i,...a}=r??{},o=await(s==null?void 0:s.handleChainStart(this.toJSON(),Dt(n,"input"),i,void 0,void 0,void 0,a==null?void 0:a.runName)),c=[this.first,...this.middle,this.last];let l=!0,u;async function*d(){yield n}try{let f=c[0].transform(d(),Xe(a,{callbacks:o==null?void 0:o.getChild(this.omitSequenceTags?void 0:"seq:step:1")}));for(let m=1;m<c.length;m+=1)f=await c[m].transform(f,Xe(a,{callbacks:o==null?void 0:o.getChild(this.omitSequenceTags?void 0:`seq:step:${m+1}`)}));for await(const m of f)if((h=r==null?void 0:r.signal)==null||h.throwIfAborted(),yield m,l)if(u===void 0)u=m;else try{u=this._concatOutputChunks(u,m)}catch{u=void 0,l=!1}}catch(f){throw await(o==null?void 0:o.handleChainError(f)),f}await(o==null?void 0:o.handleChainEnd(Dt(u,"output")))}getGraph(n){const r=new Mo;let s=null;return this.steps.forEach((i,a)=>{const o=i.getGraph(n);a!==0&&o.trimFirstNode(),a!==this.steps.length-1&&o.trimLastNode(),r.extend(o);const c=o.firstNode();if(!c)throw new Error(`Runnable ${i} has no first node`);s&&r.addEdge(s,c),s=o.lastNode()}),r}pipe(n){return Va.isRunnableSequence(n)?new Va({first:this.first,middle:this.middle.concat([this.last,n.first,...n.middle]),last:n.last,name:this.name??n.name}):new Va({first:this.first,middle:[...this.middle,this.last],last:Qt(n),name:this.name})}static isRunnableSequence(n){return Array.isArray(n.middle)&&Fe.isRunnable(n)}static from([n,...r],s){let i={};return typeof s=="string"?i.name=s:s!==void 0&&(i=s),new Va({...i,first:Qt(n),middle:r.slice(0,-1).map(Qt),last:Qt(r[r.length-1])})}},Na=class w0 extends Fe{constructor(n){super(n);p(this,"lc_namespace",["langchain_core","runnables"]);p(this,"lc_serializable",!0);p(this,"steps");this.steps={};for(const[r,s]of Object.entries(n.steps))this.steps[r]=Qt(s)}static lc_name(){return"RunnableMap"}getStepsKeys(){return Object.keys(this.steps)}static from(n){return new w0({steps:n})}async invoke(n,r){const s=Ze(r),i=await On(s),a=await(i==null?void 0:i.handleChainStart(this.toJSON(),{input:n},s.runId,void 0,void 0,void 0,s==null?void 0:s.runName));delete s.runId;const o={};try{const c=Object.entries(this.steps).map(async([l,u])=>{o[l]=await u.invoke(n,Xe(s,{callbacks:a==null?void 0:a.getChild(`map:key:${l}`)}))});await Hr(Promise.all(c),r==null?void 0:r.signal)}catch(c){throw await(a==null?void 0:a.handleChainError(c)),c}return await(a==null?void 0:a.handleChainEnd(o)),o}async*_transform(n,r,s){const i={...this.steps},a=Hp(n,Object.keys(i).length),o=new Map(Object.entries(i).map(([c,l],u)=>{const d=l.transform(a[u],Xe(s,{callbacks:r==null?void 0:r.getChild(`map:key:${c}`)}));return[c,d.next().then(h=>({key:c,gen:d,result:h}))]}));for(;o.size;){const c=Promise.race(o.values()),{key:l,result:u,gen:d}=await Hr(c,s==null?void 0:s.signal);o.delete(l),u.done||(yield{[l]:u.value},o.set(l,d.next().then(h=>({key:l,gen:d,result:h}))))}}transform(n,r){return this._transformStreamWithConfig(n,this._transform.bind(this),r)}async stream(n,r){async function*s(){yield n}const i=Ze(r),a=new Ys({generator:this.transform(s(),i),config:i});return await a.setup,hn.fromAsyncGenerator(a)}},OM=class v0 extends Fe{constructor(n){super(n);p(this,"lc_serializable",!1);p(this,"lc_namespace",["langchain_core","runnables"]);p(this,"func");if(!Wp(n.func))throw new Error("RunnableTraceable requires a function that is wrapped in traceable higher-order function");this.func=n.func}async invoke(n,r){const[s]=this._getOptionsList(r??{},1),i=await On(s),a=this.func(Xe(s,{callbacks:i}),n);return Hr(a,s==null?void 0:s.signal)}async*_streamIterator(n,r){var a,o;const[s]=this._getOptionsList(r??{},1),i=await this.invoke(n,r);if(_f(i)){for await(const c of i)(a=s==null?void 0:s.signal)==null||a.throwIfAborted(),yield c;return}if(AM(i)){for(;;){(o=s==null?void 0:s.signal)==null||o.throwIfAborted();const c=i.next();if(c.done)break;yield c.value}return}yield i}static from(n){return new v0({func:n})}};function $M(t){if(Wp(t))throw new Error("RunnableLambda requires a function that is not wrapped in traceable higher-order function. This shouldn't happen.")}var Kn=class b0 extends Fe{constructor(n){if(Wp(n.func))return OM.from(n.func);super(n);p(this,"lc_namespace",["langchain_core","runnables"]);p(this,"func");$M(n.func),this.func=n.func}static lc_name(){return"RunnableLambda"}static from(n){return new b0({func:n})}async _invoke(n,r,s){return new Promise((i,a)=>{const o=Xe(r,{callbacks:s==null?void 0:s.getChild(),recursionLimit:((r==null?void 0:r.recursionLimit)??Wd)-1});Ft.runWithConfig(ps(o),async()=>{var c,l;try{let u=await this.func(n,{...o});if(u&&Fe.isRunnable(u)){if((r==null?void 0:r.recursionLimit)===0)throw new Error("Recursion limit reached.");u=await u.invoke(n,{...o,recursionLimit:(o.recursionLimit??Wd)-1})}else if(_f(u)){let d;for await(const h of wf(o,u))if((c=r==null?void 0:r.signal)==null||c.throwIfAborted(),d===void 0)d=h;else try{d=this._concatOutputChunks(d,h)}catch{d=h}u=d}else if(e_(u)){let d;for(const h of t_(o,u))if((l=r==null?void 0:r.signal)==null||l.throwIfAborted(),d===void 0)d=h;else try{d=this._concatOutputChunks(d,h)}catch{d=h}u=d}i(u)}catch(u){a(u)}})})}async invoke(n,r){return this._callWithConfig(this._invoke.bind(this),n,r)}async*_transform(n,r,s){var c,l;let i;for await(const u of n)if(i===void 0)i=u;else try{i=this._concatOutputChunks(i,u)}catch{i=u}const a=Xe(s,{callbacks:r==null?void 0:r.getChild(),recursionLimit:((s==null?void 0:s.recursionLimit)??Wd)-1}),o=await new Promise((u,d)=>{Ft.runWithConfig(ps(a),async()=>{try{const h=await this.func(i,{...a,config:a});u(h)}catch(h){d(h)}})});if(o&&Fe.isRunnable(o)){if((s==null?void 0:s.recursionLimit)===0)throw new Error("Recursion limit reached.");const u=await o.stream(i,a);for await(const d of u)yield d}else if(_f(o))for await(const u of wf(a,o))(c=s==null?void 0:s.signal)==null||c.throwIfAborted(),yield u;else if(e_(o))for(const u of t_(a,o))(l=s==null?void 0:s.signal)==null||l.throwIfAborted(),yield u;else yield o}transform(n,r){return this._transformStreamWithConfig(n,this._transform.bind(this),r)}async stream(n,r){async function*s(){yield n}const i=Ze(r),a=new Ys({generator:this.transform(s(),i),config:i});return await a.setup,hn.fromAsyncGenerator(a)}},RM=class extends Na{},E0=class extends Fe{constructor(e){super(e);p(this,"lc_namespace",["langchain_core","runnables"]);p(this,"lc_serializable",!0);p(this,"runnable");p(this,"fallbacks");this.runnable=e.runnable,this.fallbacks=e.fallbacks}static lc_name(){return"RunnableWithFallbacks"}*runnables(){yield this.runnable;for(const e of this.fallbacks)yield e}async invoke(e,n){const r=Ze(n),s=await On(r),{runId:i,...a}=r,o=await(s==null?void 0:s.handleChainStart(this.toJSON(),Dt(e,"input"),i,void 0,void 0,void 0,a==null?void 0:a.runName)),c=Xe(a,{callbacks:o==null?void 0:o.getChild()});return await Ft.runWithConfig(c,async()=>{var d;let u;for(const h of this.runnables()){(d=r==null?void 0:r.signal)==null||d.throwIfAborted();try{const f=await h.invoke(e,c);return await(o==null?void 0:o.handleChainEnd(Dt(f,"output"))),f}catch(f){u===void 0&&(u=f)}}throw u===void 0?new Error("No error stored at end of fallback."):(await(o==null?void 0:o.handleChainError(u)),u)})}async*_streamIterator(e,n){var d;const r=Ze(n),s=await On(r),{runId:i,...a}=r,o=await(s==null?void 0:s.handleChainStart(this.toJSON(),Dt(e,"input"),i,void 0,void 0,void 0,a==null?void 0:a.runName));let c,l;for(const h of this.runnables()){(d=r==null?void 0:r.signal)==null||d.throwIfAborted();const f=Xe(a,{callbacks:o==null?void 0:o.getChild()});try{const m=await h.stream(e,f);l=wf(f,m);break}catch(m){c===void 0&&(c=m)}}if(l===void 0){const h=c??new Error("No error stored at end of fallback.");throw await(o==null?void 0:o.handleChainError(h)),h}let u;try{for await(const h of l){yield h;try{u=u===void 0?u:this._concatOutputChunks(u,h)}catch{u=void 0}}}catch(h){throw await(o==null?void 0:o.handleChainError(h)),h}await(o==null?void 0:o.handleChainEnd(Dt(u,"output")))}async batch(e,n,r){var c;if(r!=null&&r.returnExceptions)throw new Error("Not implemented.");const s=this._getOptionsList(n??{},e.length),i=await Promise.all(s.map(l=>On(l))),a=await Promise.all(i.map(async(l,u)=>{const d=await(l==null?void 0:l.handleChainStart(this.toJSON(),Dt(e[u],"input"),s[u].runId,void 0,void 0,void 0,s[u].runName));return delete s[u].runId,d}));let o;for(const l of this.runnables()){(c=s[0].signal)==null||c.throwIfAborted();try{const u=await l.batch(e,a.map((d,h)=>Xe(s[h],{callbacks:d==null?void 0:d.getChild()})),r);return await Promise.all(a.map((d,h)=>d==null?void 0:d.handleChainEnd(Dt(u[h],"output")))),u}catch(u){o===void 0&&(o=u)}}throw o?(await Promise.all(a.map(l=>l==null?void 0:l.handleChainError(o))),o):new Error("No error stored at end of fallbacks.")}};function Qt(t){if(typeof t=="function")return new Kn({func:t});if(Fe.isRunnable(t))return t;if(!Array.isArray(t)&&typeof t=="object"){const e={};for(const[n,r]of Object.entries(t))e[n]=Qt(r);return new Na({steps:e})}else throw new Error(`Expected a Runnable, function or object.
Instead got an unsupported type.`)}var dm=class extends Fe{constructor(e){e instanceof Na&&(e={mapper:e});super(e);p(this,"lc_namespace",["langchain_core","runnables"]);p(this,"lc_serializable",!0);p(this,"mapper");this.mapper=e.mapper}static lc_name(){return"RunnableAssign"}async invoke(e,n){const r=await this.mapper.invoke(e,n);return{...e,...r}}async*_transform(e,n,r){const s=this.mapper.getStepsKeys(),[i,a]=Hp(e),o=this.mapper.transform(a,Xe(r,{callbacks:n==null?void 0:n.getChild()})),c=o.next();for await(const l of i){if(typeof l!="object"||Array.isArray(l))throw new Error(`RunnableAssign can only be used with objects as input, got ${typeof l}`);const u=Object.fromEntries(Object.entries(l).filter(([d])=>!s.includes(d)));Object.keys(u).length>0&&(yield u)}yield(await c).value;for await(const l of o)yield l}transform(e,n){return this._transformStreamWithConfig(e,this._transform.bind(this),n)}async stream(e,n){async function*r(){yield e}const s=Ze(n),i=new Ys({generator:this.transform(r(),s),config:s});return await i.setup,hn.fromAsyncGenerator(i)}},T0=class extends Fe{constructor(e){(typeof e=="string"||Array.isArray(e))&&(e={keys:e});super(e);p(this,"lc_namespace",["langchain_core","runnables"]);p(this,"lc_serializable",!0);p(this,"keys");this.keys=e.keys}static lc_name(){return"RunnablePick"}async _pick(e){if(typeof this.keys=="string")return e[this.keys];{const n=this.keys.map(r=>[r,e[r]]).filter(r=>r[1]!==void 0);return n.length===0?void 0:Object.fromEntries(n)}}async invoke(e,n){return this._callWithConfig(this._pick.bind(this),e,n)}async*_transform(e){for await(const n of e){const r=await this._pick(n);r!==void 0&&(yield r)}}transform(e,n){return this._transformStreamWithConfig(e,this._transform.bind(this),n)}async stream(e,n){async function*r(){yield e}const s=Ze(n),i=new Ys({generator:this.transform(r(),s),config:s});return await i.setup,hn.fromAsyncGenerator(i)}},vf=class extends cn{constructor(e){const n=Jn.from([Kn.from(async r=>{let s;if(so(r))try{s=await Zu(this.schema,r.args)}catch{throw new bo("Received tool input did not match expected schema",JSON.stringify(r.args))}else s=r;return s}).withConfig({runName:`${e.name}:parse_input`}),e.bound]).withConfig({runName:e.name});super({bound:n,config:e.config??{}});p(this,"name");p(this,"description");p(this,"schema");this.name=e.name,this.description=e.description,this.schema=e.schema}static lc_name(){return"RunnableToolLike"}};function NM(t,e){const n=e.name??t.getName(),r=e.description??ki(e.schema);return im(e.schema)?new vf({name:n,description:r,schema:Ve({input:Ue()}).transform(s=>s.input),bound:t}):new vf({name:n,description:r,schema:e.schema,bound:t})}const Ql=(t,e)=>{const n=[...new Set(e==null?void 0:e.map(s=>{if(typeof s=="string")return s;const i=new s({});if(!("getType"in i)||typeof i.getType!="function")throw new Error("Invalid type provided.");return i.getType()}))],r=t.getType();return n.some(s=>s===r)};function S0(t,e){return Array.isArray(t)?n_(t,e):Kn.from(n=>n_(n,t))}function n_(t,e={}){const{includeNames:n,excludeNames:r,includeTypes:s,excludeTypes:i,includeIds:a,excludeIds:o}=e,c=[];for(const l of t)if(!(r&&l.name&&r.includes(l.name))){{if(i&&Ql(l,i))continue;if(o&&l.id&&o.includes(l.id))continue}s||a||n?(n&&l.name&&n.some(u=>u===l.name)||s&&Ql(l,s)||a&&l.id&&a.some(u=>u===l.id))&&c.push(l):c.push(l)}return c}function PM(t){return Array.isArray(t)?r_(t):Kn.from(r_)}function r_(t){if(!t.length)return[];const e=[];for(const n of t){const r=n,s=e.pop();if(!s)e.push(r);else if(r.getType()==="tool"||r.getType()!==s.getType())e.push(s,r);else{const i=Dl(s),a=Dl(r),o=i.concat(a);typeof i.content=="string"&&typeof a.content=="string"&&(o.content=`${i.content}
${a.content}`),e.push(LM(o))}}return e}function hm(t,e){if(Array.isArray(t)){const n=t;if(!e)throw new Error("Options parameter is required when providing messages.");return s_(n,e)}else{const n=t;return Kn.from(r=>s_(r,n)).withConfig({runName:"trim_messages"})}}async function s_(t,e){const{maxTokens:n,tokenCounter:r,strategy:s="last",allowPartial:i=!1,endOn:a,startOn:o,includeSystem:c=!1,textSplitter:l}=e;if(o&&s==="first")throw new Error("`startOn` should only be specified if `strategy` is 'last'.");if(c&&s==="first")throw new Error("`includeSystem` should only be specified if `strategy` is 'last'.");let u;"getNumTokens"in r?u=async h=>(await Promise.all(h.map(m=>r.getNumTokens(m.content)))).reduce((m,g)=>m+g,0):u=async h=>r(h);let d=k0;if(l&&("splitText"in l?d=l.splitText:d=async h=>l(h)),s==="first")return x0(t,{maxTokens:n,tokenCounter:u,textSplitter:d,partialStrategy:i?"first":void 0,endOn:a});if(s==="last")return MM(t,{maxTokens:n,tokenCounter:u,textSplitter:d,allowPartial:i,includeSystem:c,startOn:o,endOn:a});throw new Error(`Unrecognized strategy: '${s}'. Must be one of 'first' or 'last'.`)}async function x0(t,e){const{maxTokens:n,tokenCounter:r,textSplitter:s,partialStrategy:i,endOn:a}=e;let o=[...t],c=0;for(let l=0;l<o.length;l+=1){const u=l>0?o.slice(0,-l):o;if(await r(u)<=n){c=o.length-l;break}}if(c<o.length&&i){let l=!1;if(Array.isArray(o[c].content)){const u=o[c];if(typeof u.content=="string")throw new Error("Expected content to be an array.");const d=u.content.length,h=i==="last"?[...u.content].reverse():u.content;for(let f=1;f<=d;f+=1){const m=i==="first"?h.slice(0,f):h.slice(-f),g=Object.fromEntries(Object.entries(u).filter(([y])=>y!=="type"&&!y.startsWith("lc_"))),w=fm(u.getType(),{...g,content:m}),b=[...o.slice(0,c),w];if(await r(b)<=n)o=b,c+=1,l=!0;else break}l&&i==="last"&&(u.content=[...h].reverse())}if(!l){const u=o[c];let d;if(Array.isArray(u.content)&&u.content.some(h=>typeof h=="string"||h.type==="text")){const h=u.content.find(f=>f.type==="text"&&f.text);d=h==null?void 0:h.text}else typeof u.content=="string"&&(d=u.content);if(d){const h=await s(d),f=h.length;i==="last"&&h.reverse();for(let m=0;m<f-1;m+=1)if(h.pop(),u.content=h.join(""),await r([...o.slice(0,c),u])<=n){i==="last"&&(u.content=[...h].reverse().join("")),o=[...o.slice(0,c),u],c+=1;break}}}}if(a){const l=Array.isArray(a)?a:[a];for(;c>0&&!Ql(o[c-1],l);)c-=1}return o.slice(0,c)}async function MM(t,e){var u;const{allowPartial:n=!1,includeSystem:r=!1,endOn:s,startOn:i,...a}=e;let o=t.map(d=>{const h=Object.fromEntries(Object.entries(d).filter(([f])=>f!=="type"&&!f.startsWith("lc_")));return fm(d.getType(),h,vo(d))});if(s){const d=Array.isArray(s)?s:[s];for(;o.length>0&&!Ql(o[o.length-1],d);)o=o.slice(0,-1)}const c=r&&((u=o[0])==null?void 0:u.getType())==="system";let l=c?o.slice(0,1).concat(o.slice(1).reverse()):o.reverse();return l=await x0(l,{...a,partialStrategy:n?"last":void 0,endOn:i}),c?[l[0],...l.slice(1).reverse()]:l.reverse()}const i_={human:{message:ht,messageChunk:Ca},ai:{message:le,messageChunk:dn},system:{message:kt,messageChunk:fs},developer:{message:kt,messageChunk:fs},tool:{message:Pe,messageChunk:Aa},function:{message:Cu,messageChunk:ec},generic:{message:vs,messageChunk:Qo},remove:{message:Us,messageChunk:Us}};function fm(t,e,n){var i;let r,s;switch(t){case"human":n?r=new Ca(e):s=new ht(e);break;case"ai":if(n){let a={...e};"tool_calls"in a&&(a={...a,tool_call_chunks:(i=a.tool_calls)==null?void 0:i.map(o=>({...o,type:"tool_call_chunk",index:void 0,args:JSON.stringify(o.args)}))}),r=new dn(a)}else s=new le(e);break;case"system":n?r=new fs(e):s=new kt(e);break;case"developer":n?r=new fs({...e,additional_kwargs:{...e.additional_kwargs,__openai_role__:"developer"}}):s=new kt({...e,additional_kwargs:{...e.additional_kwargs,__openai_role__:"developer"}});break;case"tool":if("tool_call_id"in e)n?r=new Aa(e):s=new Pe(e);else throw new Error("Can not convert ToolMessage to ToolMessageChunk if 'tool_call_id' field is not defined.");break;case"function":if(n)r=new ec(e);else{if(!e.name)throw new Error("FunctionMessage must have a 'name' field");s=new Cu(e)}break;case"generic":if("role"in e)n?r=new Qo(e):s=new vs(e);else throw new Error("Can not convert ChatMessage to ChatMessageChunk if 'role' field is not defined.");break;default:throw new Error(`Unrecognized message type ${t}`)}if(n&&r)return r;if(s)return s;throw new Error(`Unrecognized message type ${t}`)}function LM(t){const e=t.getType();let n;const r=Object.fromEntries(Object.entries(t).filter(([s])=>!["type","tool_call_chunks"].includes(s)&&!s.startsWith("lc_")));if(e in i_&&(n=fm(e,r)),!n)throw new Error(`Unrecognized message chunk class ${e}. Supported classes are ${Object.keys(i_)}`);return n}function k0(t){const e=t.split(`
`);return Promise.resolve([...e.slice(0,-1).map(n=>`${n}
`),e[e.length-1]])}const jM=["tool_call","tool_call_chunk","invalid_tool_call","server_tool_call","server_tool_call_chunk","server_tool_call_result"],DM=["image","video","audio","text-plain","file"],UM=["text","reasoning",...jM,...DM];var I0={};Se(I0,{AIMessage:()=>le,AIMessageChunk:()=>dn,BaseMessage:()=>Cn,BaseMessageChunk:()=>ws,ChatMessage:()=>vs,ChatMessageChunk:()=>Qo,FunctionMessage:()=>Cu,FunctionMessageChunk:()=>ec,HumanMessage:()=>ht,HumanMessageChunk:()=>Ca,KNOWN_BLOCK_TYPES:()=>UM,RemoveMessage:()=>Us,SystemMessage:()=>kt,SystemMessageChunk:()=>fs,ToolMessage:()=>Pe,ToolMessageChunk:()=>Aa,_isMessageFieldWithRole:()=>Yw,_mergeDicts:()=>un,_mergeLists:()=>Yo,_mergeObj:()=>Kw,_mergeStatus:()=>Jw,coerceMessageLikeToMessage:()=>Zr,collapseToolCallChunks:()=>cv,convertToChunk:()=>Dl,convertToOpenAIImageBlock:()=>Uw,convertToProviderContentBlock:()=>Sp,defaultTextSplitter:()=>k0,defaultToolCallParser:()=>Op,filterMessages:()=>S0,getBufferString:()=>Pp,iife:()=>ov,isAIMessage:()=>Ru,isAIMessageChunk:()=>Uh,isBase64ContentBlock:()=>Tp,isBaseMessage:()=>Yt,isBaseMessageChunk:()=>vo,isChatMessage:()=>FI,isChatMessageChunk:()=>BI,isDataContentBlock:()=>Gr,isDirectToolOutput:()=>Cp,isFunctionMessage:()=>zI,isFunctionMessageChunk:()=>ZI,isHumanMessage:()=>VI,isHumanMessageChunk:()=>GI,isIDContentBlock:()=>Dw,isMessage:()=>Fw,isOpenAIToolCallArray:()=>jI,isPlainTextContentBlock:()=>oI,isSystemMessage:()=>WI,isSystemMessageChunk:()=>HI,isToolMessage:()=>$p,isToolMessageChunk:()=>nv,isURLContentBlock:()=>Ep,mapChatMessagesToStoredMessages:()=>pA,mapStoredMessageToChatMessage:()=>Mp,mapStoredMessagesToChatMessages:()=>fA,mergeContent:()=>hs,mergeMessageRuns:()=>PM,mergeResponseMetadata:()=>Qw,mergeUsageMetadata:()=>Ap,parseBase64DataUrl:()=>_o,parseMimeType:()=>jh,trimMessages:()=>hm});function Uc(t,e){return t.lc_error_code=e,t.message=`${t.message}

Troubleshooting URL: https://docs.langchain.com/oss/javascript/langchain/errors/${e}/
`,t}function Ae(t,e,n,r,s){if(typeof e=="function"?t!==e||!0:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return e.set(t,n),n}function L(t,e,n,r){if(n==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?t!==e||!r:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return n==="m"?r:n==="a"?r.call(t):r?r.value:e.get(t)}let A0=function(){const{crypto:t}=globalThis;if(t!=null&&t.randomUUID)return A0=t.randomUUID.bind(t),t.randomUUID();const e=new Uint8Array(1),n=t?()=>t.getRandomValues(e)[0]:()=>Math.random()*255&255;return"10000000-1000-4000-8000-100000000000".replace(/[018]/g,r=>(+r^n()&15>>+r/4).toString(16))};function bf(t){return typeof t=="object"&&t!==null&&("name"in t&&t.name==="AbortError"||"message"in t&&String(t.message).includes("FetchRequestCanceledException"))}const Ef=t=>{if(t instanceof Error)return t;if(typeof t=="object"&&t!==null){try{if(Object.prototype.toString.call(t)==="[object Error]"){const e=new Error(t.message,t.cause?{cause:t.cause}:{});return t.stack&&(e.stack=t.stack),t.cause&&!e.cause&&(e.cause=t.cause),t.name&&(e.name=t.name),e}}catch{}try{return new Error(JSON.stringify(t))}catch{}}return new Error(t)};class be extends Error{}class tn extends be{constructor(e,n,r,s){super(`${tn.makeMessage(e,n,r)}`),this.status=e,this.headers=s,this.requestID=s==null?void 0:s.get("x-request-id"),this.error=n;const i=n;this.code=i==null?void 0:i.code,this.param=i==null?void 0:i.param,this.type=i==null?void 0:i.type}static makeMessage(e,n,r){const s=n!=null&&n.message?typeof n.message=="string"?n.message:JSON.stringify(n.message):n?JSON.stringify(n):r;return e&&s?`${e} ${s}`:e?`${e} status code (no body)`:s||"(no status code or body)"}static generate(e,n,r,s){if(!e||!s)return new Hu({message:r,cause:Ef(n)});const i=n==null?void 0:n.error;return e===400?new C0(e,i,r,s):e===401?new O0(e,i,r,s):e===403?new $0(e,i,r,s):e===404?new R0(e,i,r,s):e===409?new N0(e,i,r,s):e===422?new P0(e,i,r,s):e===429?new M0(e,i,r,s):e>=500?new L0(e,i,r,s):new tn(e,i,r,s)}}class Vn extends tn{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0)}}class Hu extends tn{constructor({message:e,cause:n}){super(void 0,void 0,e||"Connection error.",void 0),n&&(this.cause=n)}}class qu extends Hu{constructor({message:e}={}){super({message:e??"Request timed out."})}}class C0 extends tn{}class O0 extends tn{}class $0 extends tn{}class R0 extends tn{}class N0 extends tn{}class P0 extends tn{}class M0 extends tn{}class L0 extends tn{}class j0 extends be{constructor(){super("Could not parse response content as the length limit was reached")}}class D0 extends be{constructor(){super("Could not parse response content as the request was rejected by the content filter")}}class Ga extends Error{constructor(e){super(e)}}const FM=/^[a-z][a-z0-9+.-]*:/i,BM=t=>FM.test(t);let xn=t=>(xn=Array.isArray,xn(t)),a_=xn;function U0(t){return typeof t!="object"?{}:t??{}}function zM(t){if(!t)return!0;for(const e in t)return!1;return!0}function ZM(t,e){return Object.prototype.hasOwnProperty.call(t,e)}function eh(t){return t!=null&&typeof t=="object"&&!Array.isArray(t)}const VM=(t,e)=>{if(typeof e!="number"||!Number.isInteger(e))throw new be(`${t} must be an integer`);if(e<0)throw new be(`${t} must be a positive integer`);return e},GM=t=>{try{return JSON.parse(t)}catch{return}},lc=t=>new Promise(e=>setTimeout(e,t)),Ji="6.15.0",WM=()=>typeof window<"u"&&typeof window.document<"u"&&typeof navigator<"u";function HM(){return typeof Deno<"u"&&Deno.build!=null?"deno":typeof EdgeRuntime<"u"?"edge":Object.prototype.toString.call(typeof globalThis.process<"u"?globalThis.process:0)==="[object process]"?"node":"unknown"}const qM=()=>{var n;const t=HM();if(t==="deno")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Ji,"X-Stainless-OS":c_(Deno.build.os),"X-Stainless-Arch":o_(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":typeof Deno.version=="string"?Deno.version:((n=Deno.version)==null?void 0:n.deno)??"unknown"};if(typeof EdgeRuntime<"u")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Ji,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":globalThis.process.version};if(t==="node")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Ji,"X-Stainless-OS":c_(globalThis.process.platform??"unknown"),"X-Stainless-Arch":o_(globalThis.process.arch??"unknown"),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":globalThis.process.version??"unknown"};const e=JM();return e?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Ji,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${e.browser}`,"X-Stainless-Runtime-Version":e.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Ji,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}};function JM(){if(typeof navigator>"u"||!navigator)return null;const t=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(const{key:e,pattern:n}of t){const r=n.exec(navigator.userAgent);if(r){const s=r[1]||0,i=r[2]||0,a=r[3]||0;return{browser:e,version:`${s}.${i}.${a}`}}}return null}const o_=t=>t==="x32"?"x32":t==="x86_64"||t==="x64"?"x64":t==="arm"?"arm":t==="aarch64"||t==="arm64"?"arm64":t?`other:${t}`:"unknown",c_=t=>(t=t.toLowerCase(),t.includes("ios")?"iOS":t==="android"?"Android":t==="darwin"?"MacOS":t==="win32"?"Windows":t==="freebsd"?"FreeBSD":t==="openbsd"?"OpenBSD":t==="linux"?"Linux":t?`Other:${t}`:"Unknown");let l_;const KM=()=>l_??(l_=qM());function XM(){if(typeof fetch<"u")return fetch;throw new Error("`fetch` is not defined as a global; Either pass `fetch` to the client, `new OpenAI({ fetch })` or polyfill the global, `globalThis.fetch = fetch`")}function F0(...t){const e=globalThis.ReadableStream;if(typeof e>"u")throw new Error("`ReadableStream` is not defined as a global; You will need to polyfill it, `globalThis.ReadableStream = ReadableStream`");return new e(...t)}function B0(t){let e=Symbol.asyncIterator in t?t[Symbol.asyncIterator]():t[Symbol.iterator]();return F0({start(){},async pull(n){const{done:r,value:s}=await e.next();r?n.close():n.enqueue(s)},async cancel(){var n;await((n=e.return)==null?void 0:n.call(e))}})}function z0(t){if(t[Symbol.asyncIterator])return t;const e=t.getReader();return{async next(){try{const n=await e.read();return n!=null&&n.done&&e.releaseLock(),n}catch(n){throw e.releaseLock(),n}},async return(){const n=e.cancel();return e.releaseLock(),await n,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}async function YM(t){var r,s;if(t===null||typeof t!="object")return;if(t[Symbol.asyncIterator]){await((s=(r=t[Symbol.asyncIterator]()).return)==null?void 0:s.call(r));return}const e=t.getReader(),n=e.cancel();e.releaseLock(),await n}const QM=({headers:t,body:e})=>({bodyHeaders:{"content-type":"application/json"},body:JSON.stringify(e)}),Z0="RFC3986",V0=t=>String(t),u_={RFC1738:t=>String(t).replace(/%20/g,"+"),RFC3986:V0},eL="RFC1738";let Tf=(t,e)=>(Tf=Object.hasOwn??Function.prototype.call.bind(Object.prototype.hasOwnProperty),Tf(t,e));const Or=(()=>{const t=[];for(let e=0;e<256;++e)t.push("%"+((e<16?"0":"")+e.toString(16)).toUpperCase());return t})(),th=1024,tL=(t,e,n,r,s)=>{if(t.length===0)return t;let i=t;if(typeof t=="symbol"?i=Symbol.prototype.toString.call(t):typeof t!="string"&&(i=String(t)),n==="iso-8859-1")return escape(i).replace(/%u[0-9a-f]{4}/gi,function(o){return"%26%23"+parseInt(o.slice(2),16)+"%3B"});let a="";for(let o=0;o<i.length;o+=th){const c=i.length>=th?i.slice(o,o+th):i,l=[];for(let u=0;u<c.length;++u){let d=c.charCodeAt(u);if(d===45||d===46||d===95||d===126||d>=48&&d<=57||d>=65&&d<=90||d>=97&&d<=122||s===eL&&(d===40||d===41)){l[l.length]=c.charAt(u);continue}if(d<128){l[l.length]=Or[d];continue}if(d<2048){l[l.length]=Or[192|d>>6]+Or[128|d&63];continue}if(d<55296||d>=57344){l[l.length]=Or[224|d>>12]+Or[128|d>>6&63]+Or[128|d&63];continue}u+=1,d=65536+((d&1023)<<10|c.charCodeAt(u)&1023),l[l.length]=Or[240|d>>18]+Or[128|d>>12&63]+Or[128|d>>6&63]+Or[128|d&63]}a+=l.join("")}return a};function nL(t){return!t||typeof t!="object"?!1:!!(t.constructor&&t.constructor.isBuffer&&t.constructor.isBuffer(t))}function d_(t,e){if(xn(t)){const n=[];for(let r=0;r<t.length;r+=1)n.push(e(t[r]));return n}return e(t)}const G0={brackets(t){return String(t)+"[]"},comma:"comma",indices(t,e){return String(t)+"["+e+"]"},repeat(t){return String(t)}},W0=function(t,e){Array.prototype.push.apply(t,xn(e)?e:[e])};let h_;const jt={addQueryPrefix:!1,allowDots:!1,allowEmptyArrays:!1,arrayFormat:"indices",charset:"utf-8",charsetSentinel:!1,delimiter:"&",encode:!0,encodeDotInKeys:!1,encoder:tL,encodeValuesOnly:!1,format:Z0,formatter:V0,indices:!1,serializeDate(t){return(h_??(h_=Function.prototype.call.bind(Date.prototype.toISOString)))(t)},skipNulls:!1,strictNullHandling:!1};function rL(t){return typeof t=="string"||typeof t=="number"||typeof t=="boolean"||typeof t=="symbol"||typeof t=="bigint"}const nh={};function H0(t,e,n,r,s,i,a,o,c,l,u,d,h,f,m,g,w,b){let y=t,v=b,T=0,A=!1;for(;(v=v.get(nh))!==void 0&&!A;){const j=v.get(t);if(T+=1,typeof j<"u"){if(j===T)throw new RangeError("Cyclic object value");A=!0}typeof v.get(nh)>"u"&&(T=0)}if(typeof l=="function"?y=l(e,y):y instanceof Date?y=h==null?void 0:h(y):n==="comma"&&xn(y)&&(y=d_(y,function(j){return j instanceof Date?h==null?void 0:h(j):j})),y===null){if(i)return c&&!g?c(e,jt.encoder,w,"key",f):e;y=""}if(rL(y)||nL(y)){if(c){const j=g?e:c(e,jt.encoder,w,"key",f);return[(m==null?void 0:m(j))+"="+(m==null?void 0:m(c(y,jt.encoder,w,"value",f)))]}return[(m==null?void 0:m(e))+"="+(m==null?void 0:m(String(y)))]}const I=[];if(typeof y>"u")return I;let $;if(n==="comma"&&xn(y))g&&c&&(y=d_(y,c)),$=[{value:y.length>0?y.join(",")||null:void 0}];else if(xn(l))$=l;else{const j=Object.keys(y);$=u?j.sort(u):j}const S=o?String(e).replace(/\./g,"%2E"):String(e),M=r&&xn(y)&&y.length===1?S+"[]":S;if(s&&xn(y)&&y.length===0)return M+"[]";for(let j=0;j<$.length;++j){const P=$[j],W=typeof P=="object"&&typeof P.value<"u"?P.value:y[P];if(a&&W===null)continue;const ne=d&&o?P.replace(/\./g,"%2E"):P,B=xn(y)?typeof n=="function"?n(M,ne):M:M+(d?"."+ne:"["+ne+"]");b.set(t,T);const V=new WeakMap;V.set(nh,b),W0(I,H0(W,B,n,r,s,i,a,o,n==="comma"&&g&&xn(y)?null:c,l,u,d,h,f,m,g,w,V))}return I}function sL(t=jt){if(typeof t.allowEmptyArrays<"u"&&typeof t.allowEmptyArrays!="boolean")throw new TypeError("`allowEmptyArrays` option can only be `true` or `false`, when provided");if(typeof t.encodeDotInKeys<"u"&&typeof t.encodeDotInKeys!="boolean")throw new TypeError("`encodeDotInKeys` option can only be `true` or `false`, when provided");if(t.encoder!==null&&typeof t.encoder<"u"&&typeof t.encoder!="function")throw new TypeError("Encoder has to be a function.");const e=t.charset||jt.charset;if(typeof t.charset<"u"&&t.charset!=="utf-8"&&t.charset!=="iso-8859-1")throw new TypeError("The charset option must be either utf-8, iso-8859-1, or undefined");let n=Z0;if(typeof t.format<"u"){if(!Tf(u_,t.format))throw new TypeError("Unknown format option provided.");n=t.format}const r=u_[n];let s=jt.filter;(typeof t.filter=="function"||xn(t.filter))&&(s=t.filter);let i;if(t.arrayFormat&&t.arrayFormat in G0?i=t.arrayFormat:"indices"in t?i=t.indices?"indices":"repeat":i=jt.arrayFormat,"commaRoundTrip"in t&&typeof t.commaRoundTrip!="boolean")throw new TypeError("`commaRoundTrip` must be a boolean, or absent");const a=typeof t.allowDots>"u"?t.encodeDotInKeys?!0:jt.allowDots:!!t.allowDots;return{addQueryPrefix:typeof t.addQueryPrefix=="boolean"?t.addQueryPrefix:jt.addQueryPrefix,allowDots:a,allowEmptyArrays:typeof t.allowEmptyArrays=="boolean"?!!t.allowEmptyArrays:jt.allowEmptyArrays,arrayFormat:i,charset:e,charsetSentinel:typeof t.charsetSentinel=="boolean"?t.charsetSentinel:jt.charsetSentinel,commaRoundTrip:!!t.commaRoundTrip,delimiter:typeof t.delimiter>"u"?jt.delimiter:t.delimiter,encode:typeof t.encode=="boolean"?t.encode:jt.encode,encodeDotInKeys:typeof t.encodeDotInKeys=="boolean"?t.encodeDotInKeys:jt.encodeDotInKeys,encoder:typeof t.encoder=="function"?t.encoder:jt.encoder,encodeValuesOnly:typeof t.encodeValuesOnly=="boolean"?t.encodeValuesOnly:jt.encodeValuesOnly,filter:s,format:n,formatter:r,serializeDate:typeof t.serializeDate=="function"?t.serializeDate:jt.serializeDate,skipNulls:typeof t.skipNulls=="boolean"?t.skipNulls:jt.skipNulls,sort:typeof t.sort=="function"?t.sort:null,strictNullHandling:typeof t.strictNullHandling=="boolean"?t.strictNullHandling:jt.strictNullHandling}}function iL(t,e={}){let n=t;const r=sL(e);let s,i;typeof r.filter=="function"?(i=r.filter,n=i("",n)):xn(r.filter)&&(i=r.filter,s=i);const a=[];if(typeof n!="object"||n===null)return"";const o=G0[r.arrayFormat],c=o==="comma"&&r.commaRoundTrip;s||(s=Object.keys(n)),r.sort&&s.sort(r.sort);const l=new WeakMap;for(let h=0;h<s.length;++h){const f=s[h];r.skipNulls&&n[f]===null||W0(a,H0(n[f],f,o,c,r.allowEmptyArrays,r.strictNullHandling,r.skipNulls,r.encodeDotInKeys,r.encode?r.encoder:null,r.filter,r.sort,r.allowDots,r.serializeDate,r.format,r.formatter,r.encodeValuesOnly,r.charset,l))}const u=a.join(r.delimiter);let d=r.addQueryPrefix===!0?"?":"";return r.charsetSentinel&&(r.charset==="iso-8859-1"?d+="utf8=%26%2310003%3B&":d+="utf8=%E2%9C%93&"),u.length>0?d+u:""}function aL(t){let e=0;for(const s of t)e+=s.length;const n=new Uint8Array(e);let r=0;for(const s of t)n.set(s,r),r+=s.length;return n}let f_;function pm(t){let e;return(f_??(e=new globalThis.TextEncoder,f_=e.encode.bind(e)))(t)}let p_;function m_(t){let e;return(p_??(e=new globalThis.TextDecoder,p_=e.decode.bind(e)))(t)}var jn,Dn;class Ju{constructor(){jn.set(this,void 0),Dn.set(this,void 0),Ae(this,jn,new Uint8Array),Ae(this,Dn,null)}decode(e){if(e==null)return[];const n=e instanceof ArrayBuffer?new Uint8Array(e):typeof e=="string"?pm(e):e;Ae(this,jn,aL([L(this,jn,"f"),n]));const r=[];let s;for(;(s=oL(L(this,jn,"f"),L(this,Dn,"f")))!=null;){if(s.carriage&&L(this,Dn,"f")==null){Ae(this,Dn,s.index);continue}if(L(this,Dn,"f")!=null&&(s.index!==L(this,Dn,"f")+1||s.carriage)){r.push(m_(L(this,jn,"f").subarray(0,L(this,Dn,"f")-1))),Ae(this,jn,L(this,jn,"f").subarray(L(this,Dn,"f"))),Ae(this,Dn,null);continue}const i=L(this,Dn,"f")!==null?s.preceding-1:s.preceding,a=m_(L(this,jn,"f").subarray(0,i));r.push(a),Ae(this,jn,L(this,jn,"f").subarray(s.index)),Ae(this,Dn,null)}return r}flush(){return L(this,jn,"f").length?this.decode(`
`):[]}}jn=new WeakMap,Dn=new WeakMap;Ju.NEWLINE_CHARS=new Set([`
`,"\r"]);Ju.NEWLINE_REGEXP=/\r\n|[\n\r]/g;function oL(t,e){for(let s=e??0;s<t.length;s++){if(t[s]===10)return{preceding:s,index:s+1,carriage:!1};if(t[s]===13)return{preceding:s,index:s+1,carriage:!0}}return null}function cL(t){for(let r=0;r<t.length-1;r++){if(t[r]===10&&t[r+1]===10||t[r]===13&&t[r+1]===13)return r+2;if(t[r]===13&&t[r+1]===10&&r+3<t.length&&t[r+2]===13&&t[r+3]===10)return r+4}return-1}const eu={off:0,error:200,warn:300,info:400,debug:500},g_=(t,e,n)=>{if(t){if(ZM(eu,t))return t;Kt(n).warn(`${e} was set to ${JSON.stringify(t)}, expected one of ${JSON.stringify(Object.keys(eu))}`)}};function Wa(){}function Fc(t,e,n){return!e||eu[t]>eu[n]?Wa:e[t].bind(e)}const lL={error:Wa,warn:Wa,info:Wa,debug:Wa};let y_=new WeakMap;function Kt(t){const e=t.logger,n=t.logLevel??"off";if(!e)return lL;const r=y_.get(e);if(r&&r[0]===n)return r[1];const s={error:Fc("error",e,n),warn:Fc("warn",e,n),info:Fc("info",e,n),debug:Fc("debug",e,n)};return y_.set(e,[n,s]),s}const si=t=>(t.options&&(t.options={...t.options},delete t.options.headers),t.headers&&(t.headers=Object.fromEntries((t.headers instanceof Headers?[...t.headers]:Object.entries(t.headers)).map(([e,n])=>[e,e.toLowerCase()==="authorization"||e.toLowerCase()==="cookie"||e.toLowerCase()==="set-cookie"?"***":n]))),"retryOfRequestLogID"in t&&(t.retryOfRequestLogID&&(t.retryOf=t.retryOfRequestLogID),delete t.retryOfRequestLogID),t);var Da;class Fr{constructor(e,n,r){this.iterator=e,Da.set(this,void 0),this.controller=n,Ae(this,Da,r)}static fromSSEResponse(e,n,r){let s=!1;const i=r?Kt(r):console;async function*a(){if(s)throw new be("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");s=!0;let o=!1;try{for await(const c of uL(e,n))if(!o){if(c.data.startsWith("[DONE]")){o=!0;continue}if(c.event===null||!c.event.startsWith("thread.")){let l;try{l=JSON.parse(c.data)}catch(u){throw i.error("Could not parse message into JSON:",c.data),i.error("From chunk:",c.raw),u}if(l&&l.error)throw new tn(void 0,l.error,void 0,e.headers);yield l}else{let l;try{l=JSON.parse(c.data)}catch(u){throw console.error("Could not parse message into JSON:",c.data),console.error("From chunk:",c.raw),u}if(c.event=="error")throw new tn(void 0,l.error,l.message,void 0);yield{event:c.event,data:l}}}o=!0}catch(c){if(bf(c))return;throw c}finally{o||n.abort()}}return new Fr(a,n,r)}static fromReadableStream(e,n,r){let s=!1;async function*i(){const o=new Ju,c=z0(e);for await(const l of c)for(const u of o.decode(l))yield u;for(const l of o.flush())yield l}async function*a(){if(s)throw new be("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");s=!0;let o=!1;try{for await(const c of i())o||c&&(yield JSON.parse(c));o=!0}catch(c){if(bf(c))return;throw c}finally{o||n.abort()}}return new Fr(a,n,r)}[(Da=new WeakMap,Symbol.asyncIterator)](){return this.iterator()}tee(){const e=[],n=[],r=this.iterator(),s=i=>({next:()=>{if(i.length===0){const a=r.next();e.push(a),n.push(a)}return i.shift()}});return[new Fr(()=>s(e),this.controller,L(this,Da,"f")),new Fr(()=>s(n),this.controller,L(this,Da,"f"))]}toReadableStream(){const e=this;let n;return F0({async start(){n=e[Symbol.asyncIterator]()},async pull(r){try{const{value:s,done:i}=await n.next();if(i)return r.close();const a=pm(JSON.stringify(s)+`
`);r.enqueue(a)}catch(s){r.error(s)}},async cancel(){var r;await((r=n.return)==null?void 0:r.call(n))}})}}async function*uL(t,e){if(!t.body)throw e.abort(),typeof globalThis.navigator<"u"&&globalThis.navigator.product==="ReactNative"?new be("The default react-native fetch implementation does not support streaming. Please use expo/fetch: https://docs.expo.dev/versions/latest/sdk/expo/#expofetch-api"):new be("Attempted to iterate over a response with no body");const n=new hL,r=new Ju,s=z0(t.body);for await(const i of dL(s))for(const a of r.decode(i)){const o=n.decode(a);o&&(yield o)}for(const i of r.flush()){const a=n.decode(i);a&&(yield a)}}async function*dL(t){let e=new Uint8Array;for await(const n of t){if(n==null)continue;const r=n instanceof ArrayBuffer?new Uint8Array(n):typeof n=="string"?pm(n):n;let s=new Uint8Array(e.length+r.length);s.set(e),s.set(r,e.length),e=s;let i;for(;(i=cL(e))!==-1;)yield e.slice(0,i),e=e.slice(i)}e.length>0&&(yield e)}class hL{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;const i={event:this.event,data:this.data.join(`
`),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],i}if(this.chunks.push(e),e.startsWith(":"))return null;let[n,r,s]=fL(e,":");return s.startsWith(" ")&&(s=s.substring(1)),n==="event"?this.event=s:n==="data"&&this.data.push(s),null}}function fL(t,e){const n=t.indexOf(e);return n!==-1?[t.substring(0,n),e,t.substring(n+e.length)]:[t,"",""]}async function q0(t,e){const{response:n,requestLogID:r,retryOfRequestLogID:s,startTime:i}=e,a=await(async()=>{var d;if(e.options.stream)return Kt(t).debug("response",n.status,n.url,n.headers,n.body),e.options.__streamClass?e.options.__streamClass.fromSSEResponse(n,e.controller,t):Fr.fromSSEResponse(n,e.controller,t);if(n.status===204)return null;if(e.options.__binaryResponse)return n;const o=n.headers.get("content-type"),c=(d=o==null?void 0:o.split(";")[0])==null?void 0:d.trim();if((c==null?void 0:c.includes("application/json"))||(c==null?void 0:c.endsWith("+json"))){const h=await n.json();return J0(h,n)}return await n.text()})();return Kt(t).debug(`[${r}] response parsed`,si({retryOfRequestLogID:s,url:n.url,status:n.status,body:a,durationMs:Date.now()-i})),a}function J0(t,e){return!t||typeof t!="object"||Array.isArray(t)?t:Object.defineProperty(t,"_request_id",{value:e.headers.get("x-request-id"),enumerable:!1})}var Ha;class Ku extends Promise{constructor(e,n,r=q0){super(s=>{s(null)}),this.responsePromise=n,this.parseResponse=r,Ha.set(this,void 0),Ae(this,Ha,e)}_thenUnwrap(e){return new Ku(L(this,Ha,"f"),this.responsePromise,async(n,r)=>J0(e(await this.parseResponse(n,r),r),r.response))}asResponse(){return this.responsePromise.then(e=>e.response)}async withResponse(){const[e,n]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:n,request_id:n.headers.get("x-request-id")}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(e=>this.parseResponse(L(this,Ha,"f"),e))),this.parsedPromise}then(e,n){return this.parse().then(e,n)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}}Ha=new WeakMap;var Bc;class mm{constructor(e,n,r,s){Bc.set(this,void 0),Ae(this,Bc,e),this.options=s,this.response=n,this.body=r}hasNextPage(){return this.getPaginatedItems().length?this.nextPageRequestOptions()!=null:!1}async getNextPage(){const e=this.nextPageRequestOptions();if(!e)throw new be("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");return await L(this,Bc,"f").requestAPIList(this.constructor,e)}async*iterPages(){let e=this;for(yield e;e.hasNextPage();)e=await e.getNextPage(),yield e}async*[(Bc=new WeakMap,Symbol.asyncIterator)](){for await(const e of this.iterPages())for(const n of e.getPaginatedItems())yield n}}class pL extends Ku{constructor(e,n,r){super(e,n,async(s,i)=>new r(s,i.response,await q0(s,i),i.options))}async*[Symbol.asyncIterator](){const e=await this;for await(const n of e)yield n}}class Xu extends mm{constructor(e,n,r,s){super(e,n,r,s),this.data=r.data||[],this.object=r.object}getPaginatedItems(){return this.data??[]}nextPageRequestOptions(){return null}}class Pt extends mm{constructor(e,n,r,s){super(e,n,r,s),this.data=r.data||[],this.has_more=r.has_more||!1}getPaginatedItems(){return this.data??[]}hasNextPage(){return this.has_more===!1?!1:super.hasNextPage()}nextPageRequestOptions(){var r;const e=this.getPaginatedItems(),n=(r=e[e.length-1])==null?void 0:r.id;return n?{...this.options,query:{...U0(this.options.query),after:n}}:null}}class tu extends mm{constructor(e,n,r,s){super(e,n,r,s),this.data=r.data||[],this.has_more=r.has_more||!1,this.last_id=r.last_id||""}getPaginatedItems(){return this.data??[]}hasNextPage(){return this.has_more===!1?!1:super.hasNextPage()}nextPageRequestOptions(){const e=this.last_id;return e?{...this.options,query:{...U0(this.options.query),after:e}}:null}}const K0=()=>{var t;if(typeof File>"u"){const{process:e}=globalThis,n=typeof((t=e==null?void 0:e.versions)==null?void 0:t.node)=="string"&&parseInt(e.versions.node.split("."))<20;throw new Error("`File` is not defined as a global, which is required for file uploads."+(n?" Update to Node 20 LTS or newer, or set `globalThis.File` to `import('node:buffer').File`.":""))}};function uo(t,e,n){return K0(),new File(t,e??"unknown_file",n)}function ol(t){return(typeof t=="object"&&t!==null&&("name"in t&&t.name&&String(t.name)||"url"in t&&t.url&&String(t.url)||"filename"in t&&t.filename&&String(t.filename)||"path"in t&&t.path&&String(t.path))||"").split(/[\\/]/).pop()||void 0}const gm=t=>t!=null&&typeof t=="object"&&typeof t[Symbol.asyncIterator]=="function",__=async(t,e)=>Sf(t.body)?{...t,body:await X0(t.body,e)}:t,Ai=async(t,e)=>({...t,body:await X0(t.body,e)}),w_=new WeakMap;function mL(t){const e=typeof t=="function"?t:t.fetch,n=w_.get(e);if(n)return n;const r=(async()=>{try{const s="Response"in e?e.Response:(await e("data:,")).constructor,i=new FormData;return i.toString()!==await new s(i).text()}catch{return!0}})();return w_.set(e,r),r}const X0=async(t,e)=>{if(!await mL(e))throw new TypeError("The provided fetch function does not support file uploads with the current global FormData class.");const n=new FormData;return await Promise.all(Object.entries(t||{}).map(([r,s])=>xf(n,r,s))),n},Y0=t=>t instanceof Blob&&"name"in t,gL=t=>typeof t=="object"&&t!==null&&(t instanceof Response||gm(t)||Y0(t)),Sf=t=>{if(gL(t))return!0;if(Array.isArray(t))return t.some(Sf);if(t&&typeof t=="object"){for(const e in t)if(Sf(t[e]))return!0}return!1},xf=async(t,e,n)=>{if(n!==void 0){if(n==null)throw new TypeError(`Received null for "${e}"; to pass null in FormData, you must use the string 'null'`);if(typeof n=="string"||typeof n=="number"||typeof n=="boolean")t.append(e,String(n));else if(n instanceof Response)t.append(e,uo([await n.blob()],ol(n)));else if(gm(n))t.append(e,uo([await new Response(B0(n)).blob()],ol(n)));else if(Y0(n))t.append(e,n,ol(n));else if(Array.isArray(n))await Promise.all(n.map(r=>xf(t,e+"[]",r)));else if(typeof n=="object")await Promise.all(Object.entries(n).map(([r,s])=>xf(t,`${e}[${r}]`,s)));else throw new TypeError(`Invalid value given to form, expected a string, number, boolean, object, Array, File or Blob but got ${n} instead`)}},Q0=t=>t!=null&&typeof t=="object"&&typeof t.size=="number"&&typeof t.type=="string"&&typeof t.text=="function"&&typeof t.slice=="function"&&typeof t.arrayBuffer=="function",yL=t=>t!=null&&typeof t=="object"&&typeof t.name=="string"&&typeof t.lastModified=="number"&&Q0(t),_L=t=>t!=null&&typeof t=="object"&&typeof t.url=="string"&&typeof t.blob=="function";async function wL(t,e,n){if(K0(),t=await t,yL(t))return t instanceof File?t:uo([await t.arrayBuffer()],t.name);if(_L(t)){const s=await t.blob();return e||(e=new URL(t.url).pathname.split(/[\\/]/).pop()),uo(await kf(s),e,n)}const r=await kf(t);if(e||(e=ol(t)),!(n!=null&&n.type)){const s=r.find(i=>typeof i=="object"&&"type"in i&&i.type);typeof s=="string"&&(n={...n,type:s})}return uo(r,e,n)}async function kf(t){var n;let e=[];if(typeof t=="string"||ArrayBuffer.isView(t)||t instanceof ArrayBuffer)e.push(t);else if(Q0(t))e.push(t instanceof Blob?t:await t.arrayBuffer());else if(gm(t))for await(const r of t)e.push(...await kf(r));else{const r=(n=t==null?void 0:t.constructor)==null?void 0:n.name;throw new Error(`Unexpected data type: ${typeof t}${r?`; constructor: ${r}`:""}${vL(t)}`)}return e}function vL(t){return typeof t!="object"||t===null?"":`; props: [${Object.getOwnPropertyNames(t).map(n=>`"${n}"`).join(", ")}]`}class _e{constructor(e){this._client=e}}function eE(t){return t.replace(/[^A-Za-z0-9\-._~!$&'()*+,;=:@]+/g,encodeURIComponent)}const v_=Object.freeze(Object.create(null)),bL=(t=eE)=>function(n,...r){if(n.length===1)return n[0];let s=!1;const i=[],a=n.reduce((u,d,h)=>{var g;/[?#]/.test(d)&&(s=!0);const f=r[h];let m=(s?encodeURIComponent:t)(""+f);return h!==r.length&&(f==null||typeof f=="object"&&f.toString===((g=Object.getPrototypeOf(Object.getPrototypeOf(f.hasOwnProperty??v_)??v_))==null?void 0:g.toString))&&(m=f+"",i.push({start:u.length+d.length,length:m.length,error:`Value of type ${Object.prototype.toString.call(f).slice(8,-1)} is not a valid path parameter`})),u+d+(h===r.length?"":m)},""),o=a.split(/[?#]/,1)[0],c=new RegExp("(?<=^|\\/)(?:\\.|%2e){1,2}(?=\\/|$)","gi");let l;for(;(l=c.exec(o))!==null;)i.push({start:l.index,length:l[0].length,error:`Value "${l[0]}" can't be safely passed as a path parameter`});if(i.sort((u,d)=>u.start-d.start),i.length>0){let u=0;const d=i.reduce((h,f)=>{const m=" ".repeat(f.start-u),g="^".repeat(f.length);return u=f.start+f.length,h+m+g},"");throw new be(`Path parameters result in path with invalid segments:
${i.map(h=>h.error).join(`
`)}
${a}
${d}`)}return a},G=bL(eE);let tE=class extends _e{list(e,n={},r){return this._client.getAPIList(G`/chat/completions/${e}/messages`,Pt,{query:n,...r})}};function nu(t){return t!==void 0&&"function"in t&&t.function!==void 0}function EL(t,e){const n={...t};return Object.defineProperties(n,{$brand:{value:"auto-parseable-response-format",enumerable:!1},$parseRaw:{value:e,enumerable:!1}}),n}function ym(t){return(t==null?void 0:t.$brand)==="auto-parseable-response-format"}function uc(t){return(t==null?void 0:t.$brand)==="auto-parseable-tool"}function TL(t,e){return!e||!nE(e)?{...t,choices:t.choices.map(n=>(rE(n.message.tool_calls),{...n,message:{...n.message,parsed:null,...n.message.tool_calls?{tool_calls:n.message.tool_calls}:void 0}}))}:_m(t,e)}function _m(t,e){const n=t.choices.map(r=>{var s;if(r.finish_reason==="length")throw new j0;if(r.finish_reason==="content_filter")throw new D0;return rE(r.message.tool_calls),{...r,message:{...r.message,...r.message.tool_calls?{tool_calls:((s=r.message.tool_calls)==null?void 0:s.map(i=>xL(e,i)))??void 0}:void 0,parsed:r.message.content&&!r.message.refusal?SL(e,r.message.content):null}}});return{...t,choices:n}}function SL(t,e){var n,r;return((n=t.response_format)==null?void 0:n.type)!=="json_schema"?null:((r=t.response_format)==null?void 0:r.type)==="json_schema"?"$parseRaw"in t.response_format?t.response_format.$parseRaw(e):JSON.parse(e):null}function xL(t,e){var r;const n=(r=t.tools)==null?void 0:r.find(s=>{var i;return nu(s)&&((i=s.function)==null?void 0:i.name)===e.function.name});return{...e,function:{...e.function,parsed_arguments:uc(n)?n.$parseRaw(e.function.arguments):n!=null&&n.function.strict?JSON.parse(e.function.arguments):null}}}function kL(t,e){var r;if(!t||!("tools"in t)||!t.tools)return!1;const n=(r=t.tools)==null?void 0:r.find(s=>{var i;return nu(s)&&((i=s.function)==null?void 0:i.name)===e.function.name});return nu(n)&&(uc(n)||(n==null?void 0:n.function.strict)||!1)}function nE(t){var e;return ym(t.response_format)?!0:((e=t.tools)==null?void 0:e.some(n=>uc(n)||n.type==="function"&&n.function.strict===!0))??!1}function rE(t){for(const e of t||[])if(e.type!=="function")throw new be(`Currently only \`function\` tool calls are supported; Received \`${e.type}\``)}function IL(t){for(const e of t??[]){if(e.type!=="function")throw new be(`Currently only \`function\` tool types support auto-parsing; Received \`${e.type}\``);if(e.function.strict!==!0)throw new be(`The \`${e.function.name}\` tool is not marked with \`strict: true\`. Only strict function tools can be auto-parsed`)}}const ru=t=>(t==null?void 0:t.role)==="assistant",sE=t=>(t==null?void 0:t.role)==="tool";var If,cl,ll,qa,Ja,ul,Ka,Qr,Xa,su,iu,Ki,iE;class wm{constructor(){If.add(this),this.controller=new AbortController,cl.set(this,void 0),ll.set(this,()=>{}),qa.set(this,()=>{}),Ja.set(this,void 0),ul.set(this,()=>{}),Ka.set(this,()=>{}),Qr.set(this,{}),Xa.set(this,!1),su.set(this,!1),iu.set(this,!1),Ki.set(this,!1),Ae(this,cl,new Promise((e,n)=>{Ae(this,ll,e,"f"),Ae(this,qa,n,"f")})),Ae(this,Ja,new Promise((e,n)=>{Ae(this,ul,e,"f"),Ae(this,Ka,n,"f")})),L(this,cl,"f").catch(()=>{}),L(this,Ja,"f").catch(()=>{})}_run(e){setTimeout(()=>{e().then(()=>{this._emitFinal(),this._emit("end")},L(this,If,"m",iE).bind(this))},0)}_connected(){this.ended||(L(this,ll,"f").call(this),this._emit("connect"))}get ended(){return L(this,Xa,"f")}get errored(){return L(this,su,"f")}get aborted(){return L(this,iu,"f")}abort(){this.controller.abort()}on(e,n){return(L(this,Qr,"f")[e]||(L(this,Qr,"f")[e]=[])).push({listener:n}),this}off(e,n){const r=L(this,Qr,"f")[e];if(!r)return this;const s=r.findIndex(i=>i.listener===n);return s>=0&&r.splice(s,1),this}once(e,n){return(L(this,Qr,"f")[e]||(L(this,Qr,"f")[e]=[])).push({listener:n,once:!0}),this}emitted(e){return new Promise((n,r)=>{Ae(this,Ki,!0),e!=="error"&&this.once("error",r),this.once(e,n)})}async done(){Ae(this,Ki,!0),await L(this,Ja,"f")}_emit(e,...n){if(L(this,Xa,"f"))return;e==="end"&&(Ae(this,Xa,!0),L(this,ul,"f").call(this));const r=L(this,Qr,"f")[e];if(r&&(L(this,Qr,"f")[e]=r.filter(s=>!s.once),r.forEach(({listener:s})=>s(...n))),e==="abort"){const s=n[0];!L(this,Ki,"f")&&!(r!=null&&r.length)&&Promise.reject(s),L(this,qa,"f").call(this,s),L(this,Ka,"f").call(this,s),this._emit("end");return}if(e==="error"){const s=n[0];!L(this,Ki,"f")&&!(r!=null&&r.length)&&Promise.reject(s),L(this,qa,"f").call(this,s),L(this,Ka,"f").call(this,s),this._emit("end")}}_emitFinal(){}}cl=new WeakMap,ll=new WeakMap,qa=new WeakMap,Ja=new WeakMap,ul=new WeakMap,Ka=new WeakMap,Qr=new WeakMap,Xa=new WeakMap,su=new WeakMap,iu=new WeakMap,Ki=new WeakMap,If=new WeakSet,iE=function(e){if(Ae(this,su,!0),e instanceof Error&&e.name==="AbortError"&&(e=new Vn),e instanceof Vn)return Ae(this,iu,!0),this._emit("abort",e);if(e instanceof be)return this._emit("error",e);if(e instanceof Error){const n=new be(e.message);return n.cause=e,this._emit("error",n)}return this._emit("error",new be(String(e)))};function AL(t){return typeof t.parse=="function"}var gn,Af,au,Cf,Of,$f,aE,oE;const CL=10;class cE extends wm{constructor(){super(...arguments),gn.add(this),this._chatCompletions=[],this.messages=[]}_addChatCompletion(e){var r;this._chatCompletions.push(e),this._emit("chatCompletion",e);const n=(r=e.choices[0])==null?void 0:r.message;return n&&this._addMessage(n),e}_addMessage(e,n=!0){if("content"in e||(e.content=null),this.messages.push(e),n){if(this._emit("message",e),sE(e)&&e.content)this._emit("functionToolCallResult",e.content);else if(ru(e)&&e.tool_calls)for(const r of e.tool_calls)r.type==="function"&&this._emit("functionToolCall",r.function)}}async finalChatCompletion(){await this.done();const e=this._chatCompletions[this._chatCompletions.length-1];if(!e)throw new be("stream ended without producing a ChatCompletion");return e}async finalContent(){return await this.done(),L(this,gn,"m",Af).call(this)}async finalMessage(){return await this.done(),L(this,gn,"m",au).call(this)}async finalFunctionToolCall(){return await this.done(),L(this,gn,"m",Cf).call(this)}async finalFunctionToolCallResult(){return await this.done(),L(this,gn,"m",Of).call(this)}async totalUsage(){return await this.done(),L(this,gn,"m",$f).call(this)}allChatCompletions(){return[...this._chatCompletions]}_emitFinal(){const e=this._chatCompletions[this._chatCompletions.length-1];e&&this._emit("finalChatCompletion",e);const n=L(this,gn,"m",au).call(this);n&&this._emit("finalMessage",n);const r=L(this,gn,"m",Af).call(this);r&&this._emit("finalContent",r);const s=L(this,gn,"m",Cf).call(this);s&&this._emit("finalFunctionToolCall",s);const i=L(this,gn,"m",Of).call(this);i!=null&&this._emit("finalFunctionToolCallResult",i),this._chatCompletions.some(a=>a.usage)&&this._emit("totalUsage",L(this,gn,"m",$f).call(this))}async _createChatCompletion(e,n,r){const s=r==null?void 0:r.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),L(this,gn,"m",aE).call(this,n);const i=await e.chat.completions.create({...n,stream:!1},{...r,signal:this.controller.signal});return this._connected(),this._addChatCompletion(_m(i,n))}async _runChatCompletion(e,n,r){for(const s of n.messages)this._addMessage(s,!1);return await this._createChatCompletion(e,n,r)}async _runTools(e,n,r){var f,m,g;const s="tool",{tool_choice:i="auto",stream:a,...o}=n,c=typeof i!="string"&&i.type==="function"&&((f=i==null?void 0:i.function)==null?void 0:f.name),{maxChatCompletions:l=CL}=r||{},u=n.tools.map(w=>{if(uc(w)){if(!w.$callback)throw new be("Tool given to `.runTools()` that does not have an associated function");return{type:"function",function:{function:w.$callback,name:w.function.name,description:w.function.description||"",parameters:w.function.parameters,parse:w.$parseRaw,strict:!0}}}return w}),d={};for(const w of u)w.type==="function"&&(d[w.function.name||w.function.function.name]=w.function);const h="tools"in n?u.map(w=>w.type==="function"?{type:"function",function:{name:w.function.name||w.function.function.name,parameters:w.function.parameters,description:w.function.description,strict:w.function.strict}}:w):void 0;for(const w of n.messages)this._addMessage(w,!1);for(let w=0;w<l;++w){const y=(m=(await this._createChatCompletion(e,{...o,tool_choice:i,tools:h,messages:[...this.messages]},r)).choices[0])==null?void 0:m.message;if(!y)throw new be("missing message in ChatCompletion response");if(!((g=y.tool_calls)!=null&&g.length))return;for(const v of y.tool_calls){if(v.type!=="function")continue;const T=v.id,{name:A,arguments:I}=v.function,$=d[A];if($){if(c&&c!==A){const P=`Invalid tool_call: ${JSON.stringify(A)}. ${JSON.stringify(c)} requested. Please try again`;this._addMessage({role:s,tool_call_id:T,content:P});continue}}else{const P=`Invalid tool_call: ${JSON.stringify(A)}. Available options are: ${Object.keys(d).map(W=>JSON.stringify(W)).join(", ")}. Please try again`;this._addMessage({role:s,tool_call_id:T,content:P});continue}let S;try{S=AL($)?await $.parse(I):I}catch(P){const W=P instanceof Error?P.message:String(P);this._addMessage({role:s,tool_call_id:T,content:W});continue}const M=await $.function(S,this),j=L(this,gn,"m",oE).call(this,M);if(this._addMessage({role:s,tool_call_id:T,content:j}),c)return}}}}gn=new WeakSet,Af=function(){return L(this,gn,"m",au).call(this).content??null},au=function(){let e=this.messages.length;for(;e-- >0;){const n=this.messages[e];if(ru(n))return{...n,content:n.content??null,refusal:n.refusal??null}}throw new be("stream ended without producing a ChatCompletionMessage with role=assistant")},Cf=function(){var e,n;for(let r=this.messages.length-1;r>=0;r--){const s=this.messages[r];if(ru(s)&&((e=s==null?void 0:s.tool_calls)!=null&&e.length))return(n=s.tool_calls.filter(i=>i.type==="function").at(-1))==null?void 0:n.function}},Of=function(){for(let e=this.messages.length-1;e>=0;e--){const n=this.messages[e];if(sE(n)&&n.content!=null&&typeof n.content=="string"&&this.messages.some(r=>{var s;return r.role==="assistant"&&((s=r.tool_calls)==null?void 0:s.some(i=>i.type==="function"&&i.id===n.tool_call_id))}))return n.content}},$f=function(){const e={completion_tokens:0,prompt_tokens:0,total_tokens:0};for(const{usage:n}of this._chatCompletions)n&&(e.completion_tokens+=n.completion_tokens,e.prompt_tokens+=n.prompt_tokens,e.total_tokens+=n.total_tokens);return e},aE=function(e){if(e.n!=null&&e.n>1)throw new be("ChatCompletion convenience helpers only support n=1 at this time. To use n>1, please use chat.completions.create() directly.")},oE=function(e){return typeof e=="string"?e:e===void 0?"undefined":JSON.stringify(e)};class vm extends cE{static runTools(e,n,r){const s=new vm,i={...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"runTools"}};return s._run(()=>s._runTools(e,n,i)),s}_addMessage(e,n=!0){super._addMessage(e,n),ru(e)&&e.content&&this._emit("content",e.content)}}const lE=1,uE=2,dE=4,hE=8,fE=16,pE=32,mE=64,gE=128,yE=256,_E=gE|yE,wE=fE|pE|_E|mE,vE=lE|uE|wE,bE=dE|hE,OL=vE|bE,Zt={STR:lE,NUM:uE,ARR:dE,OBJ:hE,NULL:fE,BOOL:pE,NAN:mE,INFINITY:gE,MINUS_INFINITY:yE,INF:_E,SPECIAL:wE,ATOM:vE,COLLECTION:bE,ALL:OL};class $L extends Error{}class RL extends Error{}function NL(t,e=Zt.ALL){if(typeof t!="string")throw new TypeError(`expecting str, got ${typeof t}`);if(!t.trim())throw new Error(`${t} is empty`);return PL(t.trim(),e)}const PL=(t,e)=>{const n=t.length;let r=0;const s=h=>{throw new $L(`${h} at position ${r}`)},i=h=>{throw new RL(`${h} at position ${r}`)},a=()=>(d(),r>=n&&s("Unexpected end of input"),t[r]==='"'?o():t[r]==="{"?c():t[r]==="["?l():t.substring(r,r+4)==="null"||Zt.NULL&e&&n-r<4&&"null".startsWith(t.substring(r))?(r+=4,null):t.substring(r,r+4)==="true"||Zt.BOOL&e&&n-r<4&&"true".startsWith(t.substring(r))?(r+=4,!0):t.substring(r,r+5)==="false"||Zt.BOOL&e&&n-r<5&&"false".startsWith(t.substring(r))?(r+=5,!1):t.substring(r,r+8)==="Infinity"||Zt.INFINITY&e&&n-r<8&&"Infinity".startsWith(t.substring(r))?(r+=8,1/0):t.substring(r,r+9)==="-Infinity"||Zt.MINUS_INFINITY&e&&1<n-r&&n-r<9&&"-Infinity".startsWith(t.substring(r))?(r+=9,-1/0):t.substring(r,r+3)==="NaN"||Zt.NAN&e&&n-r<3&&"NaN".startsWith(t.substring(r))?(r+=3,NaN):u()),o=()=>{const h=r;let f=!1;for(r++;r<n&&(t[r]!=='"'||f&&t[r-1]==="\\");)f=t[r]==="\\"?!f:!1,r++;if(t.charAt(r)=='"')try{return JSON.parse(t.substring(h,++r-Number(f)))}catch(m){i(String(m))}else if(Zt.STR&e)try{return JSON.parse(t.substring(h,r-Number(f))+'"')}catch{return JSON.parse(t.substring(h,t.lastIndexOf("\\"))+'"')}s("Unterminated string literal")},c=()=>{r++,d();const h={};try{for(;t[r]!=="}";){if(d(),r>=n&&Zt.OBJ&e)return h;const f=o();d(),r++;try{const m=a();Object.defineProperty(h,f,{value:m,writable:!0,enumerable:!0,configurable:!0})}catch(m){if(Zt.OBJ&e)return h;throw m}d(),t[r]===","&&r++}}catch{if(Zt.OBJ&e)return h;s("Expected '}' at end of object")}return r++,h},l=()=>{r++;const h=[];try{for(;t[r]!=="]";)h.push(a()),d(),t[r]===","&&r++}catch{if(Zt.ARR&e)return h;s("Expected ']' at end of array")}return r++,h},u=()=>{if(r===0){t==="-"&&Zt.NUM&e&&s("Not sure what '-' is");try{return JSON.parse(t)}catch(f){if(Zt.NUM&e)try{return t[t.length-1]==="."?JSON.parse(t.substring(0,t.lastIndexOf("."))):JSON.parse(t.substring(0,t.lastIndexOf("e")))}catch{}i(String(f))}}const h=r;for(t[r]==="-"&&r++;t[r]&&!",]}".includes(t[r]);)r++;r==n&&!(Zt.NUM&e)&&s("Unterminated number literal");try{return JSON.parse(t.substring(h,r))}catch{t.substring(h,r)==="-"&&Zt.NUM&e&&s("Not sure what '-' is");try{return JSON.parse(t.substring(h,t.lastIndexOf("e")))}catch(m){i(String(m))}}},d=()=>{for(;r<n&&` 
\r	`.includes(t[r]);)r++};return a()},b_=t=>NL(t,Zt.ALL^Zt.NUM);var Mt,Kr,Fi,ks,rh,zc,sh,ih,ah,Zc,oh,E_;class Lo extends cE{constructor(e){super(),Mt.add(this),Kr.set(this,void 0),Fi.set(this,void 0),ks.set(this,void 0),Ae(this,Kr,e),Ae(this,Fi,[])}get currentChatCompletionSnapshot(){return L(this,ks,"f")}static fromReadableStream(e){const n=new Lo(null);return n._run(()=>n._fromReadableStream(e)),n}static createChatCompletion(e,n,r){const s=new Lo(n);return s._run(()=>s._runChatCompletion(e,{...n,stream:!0},{...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"stream"}})),s}async _createChatCompletion(e,n,r){var a;super._createChatCompletion;const s=r==null?void 0:r.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),L(this,Mt,"m",rh).call(this);const i=await e.chat.completions.create({...n,stream:!0},{...r,signal:this.controller.signal});this._connected();for await(const o of i)L(this,Mt,"m",sh).call(this,o);if((a=i.controller.signal)!=null&&a.aborted)throw new Vn;return this._addChatCompletion(L(this,Mt,"m",Zc).call(this))}async _fromReadableStream(e,n){var a;const r=n==null?void 0:n.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),L(this,Mt,"m",rh).call(this),this._connected();const s=Fr.fromReadableStream(e,this.controller);let i;for await(const o of s)i&&i!==o.id&&this._addChatCompletion(L(this,Mt,"m",Zc).call(this)),L(this,Mt,"m",sh).call(this,o),i=o.id;if((a=s.controller.signal)!=null&&a.aborted)throw new Vn;return this._addChatCompletion(L(this,Mt,"m",Zc).call(this))}[(Kr=new WeakMap,Fi=new WeakMap,ks=new WeakMap,Mt=new WeakSet,rh=function(){this.ended||Ae(this,ks,void 0)},zc=function(n){let r=L(this,Fi,"f")[n.index];return r||(r={content_done:!1,refusal_done:!1,logprobs_content_done:!1,logprobs_refusal_done:!1,done_tool_calls:new Set,current_tool_call_index:null},L(this,Fi,"f")[n.index]=r,r)},sh=function(n){var s,i,a,o,c,l,u,d,h,f,m,g,w,b,y;if(this.ended)return;const r=L(this,Mt,"m",E_).call(this,n);this._emit("chunk",n,r);for(const v of n.choices){const T=r.choices[v.index];v.delta.content!=null&&((s=T.message)==null?void 0:s.role)==="assistant"&&((i=T.message)!=null&&i.content)&&(this._emit("content",v.delta.content,T.message.content),this._emit("content.delta",{delta:v.delta.content,snapshot:T.message.content,parsed:T.message.parsed})),v.delta.refusal!=null&&((a=T.message)==null?void 0:a.role)==="assistant"&&((o=T.message)!=null&&o.refusal)&&this._emit("refusal.delta",{delta:v.delta.refusal,snapshot:T.message.refusal}),((c=v.logprobs)==null?void 0:c.content)!=null&&((l=T.message)==null?void 0:l.role)==="assistant"&&this._emit("logprobs.content.delta",{content:(u=v.logprobs)==null?void 0:u.content,snapshot:((d=T.logprobs)==null?void 0:d.content)??[]}),((h=v.logprobs)==null?void 0:h.refusal)!=null&&((f=T.message)==null?void 0:f.role)==="assistant"&&this._emit("logprobs.refusal.delta",{refusal:(m=v.logprobs)==null?void 0:m.refusal,snapshot:((g=T.logprobs)==null?void 0:g.refusal)??[]});const A=L(this,Mt,"m",zc).call(this,T);T.finish_reason&&(L(this,Mt,"m",ah).call(this,T),A.current_tool_call_index!=null&&L(this,Mt,"m",ih).call(this,T,A.current_tool_call_index));for(const I of v.delta.tool_calls??[])A.current_tool_call_index!==I.index&&(L(this,Mt,"m",ah).call(this,T),A.current_tool_call_index!=null&&L(this,Mt,"m",ih).call(this,T,A.current_tool_call_index)),A.current_tool_call_index=I.index;for(const I of v.delta.tool_calls??[]){const $=(w=T.message.tool_calls)==null?void 0:w[I.index];$!=null&&$.type&&(($==null?void 0:$.type)==="function"?this._emit("tool_calls.function.arguments.delta",{name:(b=$.function)==null?void 0:b.name,index:I.index,arguments:$.function.arguments,parsed_arguments:$.function.parsed_arguments,arguments_delta:((y=I.function)==null?void 0:y.arguments)??""}):($==null||$.type,void 0))}}},ih=function(n,r){var a,o,c;if(L(this,Mt,"m",zc).call(this,n).done_tool_calls.has(r))return;const i=(a=n.message.tool_calls)==null?void 0:a[r];if(!i)throw new Error("no tool call snapshot");if(!i.type)throw new Error("tool call snapshot missing `type`");if(i.type==="function"){const l=(c=(o=L(this,Kr,"f"))==null?void 0:o.tools)==null?void 0:c.find(u=>nu(u)&&u.function.name===i.function.name);this._emit("tool_calls.function.arguments.done",{name:i.function.name,index:r,arguments:i.function.arguments,parsed_arguments:uc(l)?l.$parseRaw(i.function.arguments):l!=null&&l.function.strict?JSON.parse(i.function.arguments):null})}else i.type},ah=function(n){var s,i;const r=L(this,Mt,"m",zc).call(this,n);if(n.message.content&&!r.content_done){r.content_done=!0;const a=L(this,Mt,"m",oh).call(this);this._emit("content.done",{content:n.message.content,parsed:a?a.$parseRaw(n.message.content):null})}n.message.refusal&&!r.refusal_done&&(r.refusal_done=!0,this._emit("refusal.done",{refusal:n.message.refusal})),(s=n.logprobs)!=null&&s.content&&!r.logprobs_content_done&&(r.logprobs_content_done=!0,this._emit("logprobs.content.done",{content:n.logprobs.content})),(i=n.logprobs)!=null&&i.refusal&&!r.logprobs_refusal_done&&(r.logprobs_refusal_done=!0,this._emit("logprobs.refusal.done",{refusal:n.logprobs.refusal}))},Zc=function(){if(this.ended)throw new be("stream has ended, this shouldn't happen");const n=L(this,ks,"f");if(!n)throw new be("request ended without sending any chunks");return Ae(this,ks,void 0),Ae(this,Fi,[]),ML(n,L(this,Kr,"f"))},oh=function(){var r;const n=(r=L(this,Kr,"f"))==null?void 0:r.response_format;return ym(n)?n:null},E_=function(n){var r,s,i,a;let o=L(this,ks,"f");const{choices:c,...l}=n;o?Object.assign(o,l):o=Ae(this,ks,{...l,choices:[]});for(const{delta:u,finish_reason:d,index:h,logprobs:f=null,...m}of n.choices){let g=o.choices[h];if(g||(g=o.choices[h]={finish_reason:d,index:h,message:{},logprobs:f,...m}),f)if(!g.logprobs)g.logprobs=Object.assign({},f);else{const{content:I,refusal:$,...S}=f;Object.assign(g.logprobs,S),I&&((r=g.logprobs).content??(r.content=[]),g.logprobs.content.push(...I)),$&&((s=g.logprobs).refusal??(s.refusal=[]),g.logprobs.refusal.push(...$))}if(d&&(g.finish_reason=d,L(this,Kr,"f")&&nE(L(this,Kr,"f")))){if(d==="length")throw new j0;if(d==="content_filter")throw new D0}if(Object.assign(g,m),!u)continue;const{content:w,refusal:b,function_call:y,role:v,tool_calls:T,...A}=u;if(Object.assign(g.message,A),b&&(g.message.refusal=(g.message.refusal||"")+b),v&&(g.message.role=v),y&&(g.message.function_call?(y.name&&(g.message.function_call.name=y.name),y.arguments&&((i=g.message.function_call).arguments??(i.arguments=""),g.message.function_call.arguments+=y.arguments)):g.message.function_call=y),w&&(g.message.content=(g.message.content||"")+w,!g.message.refusal&&L(this,Mt,"m",oh).call(this)&&(g.message.parsed=b_(g.message.content))),T){g.message.tool_calls||(g.message.tool_calls=[]);for(const{index:I,id:$,type:S,function:M,...j}of T){const P=(a=g.message.tool_calls)[I]??(a[I]={});Object.assign(P,j),$&&(P.id=$),S&&(P.type=S),M&&(P.function??(P.function={name:M.name??"",arguments:""})),M!=null&&M.name&&(P.function.name=M.name),M!=null&&M.arguments&&(P.function.arguments+=M.arguments,kL(L(this,Kr,"f"),P)&&(P.function.parsed_arguments=b_(P.function.arguments)))}}}return o},Symbol.asyncIterator)](){const e=[],n=[];let r=!1;return this.on("chunk",s=>{const i=n.shift();i?i.resolve(s):e.push(s)}),this.on("end",()=>{r=!0;for(const s of n)s.resolve(void 0);n.length=0}),this.on("abort",s=>{r=!0;for(const i of n)i.reject(s);n.length=0}),this.on("error",s=>{r=!0;for(const i of n)i.reject(s);n.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:r?{value:void 0,done:!0}:new Promise((i,a)=>n.push({resolve:i,reject:a})).then(i=>i?{value:i,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new Fr(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}}function ML(t,e){const{id:n,choices:r,created:s,model:i,system_fingerprint:a,...o}=t,c={...o,id:n,choices:r.map(({message:l,finish_reason:u,index:d,logprobs:h,...f})=>{if(!u)throw new be(`missing finish_reason for choice ${d}`);const{content:m=null,function_call:g,tool_calls:w,...b}=l,y=l.role;if(!y)throw new be(`missing role for choice ${d}`);if(g){const{arguments:v,name:T}=g;if(v==null)throw new be(`missing function_call.arguments for choice ${d}`);if(!T)throw new be(`missing function_call.name for choice ${d}`);return{...f,message:{content:m,function_call:{arguments:v,name:T},role:y,refusal:l.refusal??null},finish_reason:u,index:d,logprobs:h}}return w?{...f,index:d,finish_reason:u,logprobs:h,message:{...b,role:y,content:m,refusal:l.refusal??null,tool_calls:w.map((v,T)=>{const{function:A,type:I,id:$,...S}=v,{arguments:M,name:j,...P}=A||{};if($==null)throw new be(`missing choices[${d}].tool_calls[${T}].id
${Vc(t)}`);if(I==null)throw new be(`missing choices[${d}].tool_calls[${T}].type
${Vc(t)}`);if(j==null)throw new be(`missing choices[${d}].tool_calls[${T}].function.name
${Vc(t)}`);if(M==null)throw new be(`missing choices[${d}].tool_calls[${T}].function.arguments
${Vc(t)}`);return{...S,id:$,type:I,function:{...P,name:j,arguments:M}}})}}:{...f,message:{...b,content:m,role:y,refusal:l.refusal??null},finish_reason:u,index:d,logprobs:h}}),created:s,model:i,object:"chat.completion",...a?{system_fingerprint:a}:{}};return TL(c,e)}function Vc(t){return JSON.stringify(t)}class ou extends Lo{static fromReadableStream(e){const n=new ou(null);return n._run(()=>n._fromReadableStream(e)),n}static runTools(e,n,r){const s=new ou(n),i={...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"runTools"}};return s._run(()=>s._runTools(e,n,i)),s}}let bm=class extends _e{constructor(){super(...arguments),this.messages=new tE(this._client)}create(e,n){return this._client.post("/chat/completions",{body:e,...n,stream:e.stream??!1})}retrieve(e,n){return this._client.get(G`/chat/completions/${e}`,n)}update(e,n,r){return this._client.post(G`/chat/completions/${e}`,{body:n,...r})}list(e={},n){return this._client.getAPIList("/chat/completions",Pt,{query:e,...n})}delete(e,n){return this._client.delete(G`/chat/completions/${e}`,n)}parse(e,n){return IL(e.tools),this._client.chat.completions.create(e,{...n,headers:{...n==null?void 0:n.headers,"X-Stainless-Helper-Method":"chat.completions.parse"}})._thenUnwrap(r=>_m(r,e))}runTools(e,n){return e.stream?ou.runTools(this._client,e,n):vm.runTools(this._client,e,n)}stream(e,n){return Lo.createChatCompletion(this._client,e,n)}};bm.Messages=tE;class Em extends _e{constructor(){super(...arguments),this.completions=new bm(this._client)}}Em.Completions=bm;const EE=Symbol("brand.privateNullableHeaders");function*LL(t){if(!t)return;if(EE in t){const{values:r,nulls:s}=t;yield*r.entries();for(const i of s)yield[i,null];return}let e=!1,n;t instanceof Headers?n=t.entries():a_(t)?n=t:(e=!0,n=Object.entries(t??{}));for(let r of n){const s=r[0];if(typeof s!="string")throw new TypeError("expected header name to be a string");const i=a_(r[1])?r[1]:[r[1]];let a=!1;for(const o of i)o!==void 0&&(e&&!a&&(a=!0,yield[s,null]),yield[s,o])}}const ce=t=>{const e=new Headers,n=new Set;for(const r of t){const s=new Set;for(const[i,a]of LL(r)){const o=i.toLowerCase();s.has(o)||(e.delete(i),s.add(o)),a===null?(e.delete(i),n.add(o)):(e.append(i,a),n.delete(o))}}return{[EE]:!0,values:e,nulls:n}};class TE extends _e{create(e,n){return this._client.post("/audio/speech",{body:e,...n,headers:ce([{Accept:"application/octet-stream"},n==null?void 0:n.headers]),__binaryResponse:!0})}}class SE extends _e{create(e,n){return this._client.post("/audio/transcriptions",Ai({body:e,...n,stream:e.stream??!1,__metadata:{model:e.model}},this._client))}}class xE extends _e{create(e,n){return this._client.post("/audio/translations",Ai({body:e,...n,__metadata:{model:e.model}},this._client))}}class dc extends _e{constructor(){super(...arguments),this.transcriptions=new SE(this._client),this.translations=new xE(this._client),this.speech=new TE(this._client)}}dc.Transcriptions=SE;dc.Translations=xE;dc.Speech=TE;class kE extends _e{create(e,n){return this._client.post("/batches",{body:e,...n})}retrieve(e,n){return this._client.get(G`/batches/${e}`,n)}list(e={},n){return this._client.getAPIList("/batches",Pt,{query:e,...n})}cancel(e,n){return this._client.post(G`/batches/${e}/cancel`,n)}}class IE extends _e{create(e,n){return this._client.post("/assistants",{body:e,...n,headers:ce([{"OpenAI-Beta":"assistants=v2"},n==null?void 0:n.headers])})}retrieve(e,n){return this._client.get(G`/assistants/${e}`,{...n,headers:ce([{"OpenAI-Beta":"assistants=v2"},n==null?void 0:n.headers])})}update(e,n,r){return this._client.post(G`/assistants/${e}`,{body:n,...r,headers:ce([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}list(e={},n){return this._client.getAPIList("/assistants",Pt,{query:e,...n,headers:ce([{"OpenAI-Beta":"assistants=v2"},n==null?void 0:n.headers])})}delete(e,n){return this._client.delete(G`/assistants/${e}`,{...n,headers:ce([{"OpenAI-Beta":"assistants=v2"},n==null?void 0:n.headers])})}}let AE=class extends _e{create(e,n){return this._client.post("/realtime/sessions",{body:e,...n,headers:ce([{"OpenAI-Beta":"assistants=v2"},n==null?void 0:n.headers])})}};class CE extends _e{create(e,n){return this._client.post("/realtime/transcription_sessions",{body:e,...n,headers:ce([{"OpenAI-Beta":"assistants=v2"},n==null?void 0:n.headers])})}}let Yu=class extends _e{constructor(){super(...arguments),this.sessions=new AE(this._client),this.transcriptionSessions=new CE(this._client)}};Yu.Sessions=AE;Yu.TranscriptionSessions=CE;class OE extends _e{create(e,n){return this._client.post("/chatkit/sessions",{body:e,...n,headers:ce([{"OpenAI-Beta":"chatkit_beta=v1"},n==null?void 0:n.headers])})}cancel(e,n){return this._client.post(G`/chatkit/sessions/${e}/cancel`,{...n,headers:ce([{"OpenAI-Beta":"chatkit_beta=v1"},n==null?void 0:n.headers])})}}let $E=class extends _e{retrieve(e,n){return this._client.get(G`/chatkit/threads/${e}`,{...n,headers:ce([{"OpenAI-Beta":"chatkit_beta=v1"},n==null?void 0:n.headers])})}list(e={},n){return this._client.getAPIList("/chatkit/threads",tu,{query:e,...n,headers:ce([{"OpenAI-Beta":"chatkit_beta=v1"},n==null?void 0:n.headers])})}delete(e,n){return this._client.delete(G`/chatkit/threads/${e}`,{...n,headers:ce([{"OpenAI-Beta":"chatkit_beta=v1"},n==null?void 0:n.headers])})}listItems(e,n={},r){return this._client.getAPIList(G`/chatkit/threads/${e}/items`,tu,{query:n,...r,headers:ce([{"OpenAI-Beta":"chatkit_beta=v1"},r==null?void 0:r.headers])})}};class Qu extends _e{constructor(){super(...arguments),this.sessions=new OE(this._client),this.threads=new $E(this._client)}}Qu.Sessions=OE;Qu.Threads=$E;class RE extends _e{create(e,n,r){return this._client.post(G`/threads/${e}/messages`,{body:n,...r,headers:ce([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}retrieve(e,n,r){const{thread_id:s}=n;return this._client.get(G`/threads/${s}/messages/${e}`,{...r,headers:ce([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}update(e,n,r){const{thread_id:s,...i}=n;return this._client.post(G`/threads/${s}/messages/${e}`,{body:i,...r,headers:ce([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}list(e,n={},r){return this._client.getAPIList(G`/threads/${e}/messages`,Pt,{query:n,...r,headers:ce([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}delete(e,n,r){const{thread_id:s}=n;return this._client.delete(G`/threads/${s}/messages/${e}`,{...r,headers:ce([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}}class NE extends _e{retrieve(e,n,r){const{thread_id:s,run_id:i,...a}=n;return this._client.get(G`/threads/${s}/runs/${i}/steps/${e}`,{query:a,...r,headers:ce([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}list(e,n,r){const{thread_id:s,...i}=n;return this._client.getAPIList(G`/threads/${s}/runs/${e}/steps`,Pt,{query:i,...r,headers:ce([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}}const jL=t=>{if(typeof Fs<"u"){const e=Fs.from(t,"base64");return Array.from(new Float32Array(e.buffer,e.byteOffset,e.length/Float32Array.BYTES_PER_ELEMENT))}else{const e=atob(t),n=e.length,r=new Uint8Array(n);for(let s=0;s<n;s++)r[s]=e.charCodeAt(s);return Array.from(new Float32Array(r.buffer))}};var ch={};const Bi=t=>{var e,n,r,s;if(typeof globalThis.process<"u")return((e=ch==null?void 0:ch[t])==null?void 0:e.trim())??void 0;if(typeof globalThis.Deno<"u")return(s=(r=(n=globalThis.Deno.env)==null?void 0:n.get)==null?void 0:r.call(n,t))==null?void 0:s.trim()};var Xt,fi,Rf,Pr,dl,_r,pi,ea,ci,cu,Un,hl,fl,ho,Ya,Qa,T_,S_,x_,k_,I_,A_,C_;class fo extends wm{constructor(){super(...arguments),Xt.add(this),Rf.set(this,[]),Pr.set(this,{}),dl.set(this,{}),_r.set(this,void 0),pi.set(this,void 0),ea.set(this,void 0),ci.set(this,void 0),cu.set(this,void 0),Un.set(this,void 0),hl.set(this,void 0),fl.set(this,void 0),ho.set(this,void 0)}[(Rf=new WeakMap,Pr=new WeakMap,dl=new WeakMap,_r=new WeakMap,pi=new WeakMap,ea=new WeakMap,ci=new WeakMap,cu=new WeakMap,Un=new WeakMap,hl=new WeakMap,fl=new WeakMap,ho=new WeakMap,Xt=new WeakSet,Symbol.asyncIterator)](){const e=[],n=[];let r=!1;return this.on("event",s=>{const i=n.shift();i?i.resolve(s):e.push(s)}),this.on("end",()=>{r=!0;for(const s of n)s.resolve(void 0);n.length=0}),this.on("abort",s=>{r=!0;for(const i of n)i.reject(s);n.length=0}),this.on("error",s=>{r=!0;for(const i of n)i.reject(s);n.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:r?{value:void 0,done:!0}:new Promise((i,a)=>n.push({resolve:i,reject:a})).then(i=>i?{value:i,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}static fromReadableStream(e){const n=new fi;return n._run(()=>n._fromReadableStream(e)),n}async _fromReadableStream(e,n){var i;const r=n==null?void 0:n.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),this._connected();const s=Fr.fromReadableStream(e,this.controller);for await(const a of s)L(this,Xt,"m",Ya).call(this,a);if((i=s.controller.signal)!=null&&i.aborted)throw new Vn;return this._addRun(L(this,Xt,"m",Qa).call(this))}toReadableStream(){return new Fr(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}static createToolAssistantStream(e,n,r,s){const i=new fi;return i._run(()=>i._runToolAssistantStream(e,n,r,{...s,headers:{...s==null?void 0:s.headers,"X-Stainless-Helper-Method":"stream"}})),i}async _createToolAssistantStream(e,n,r,s){var c;const i=s==null?void 0:s.signal;i&&(i.aborted&&this.controller.abort(),i.addEventListener("abort",()=>this.controller.abort()));const a={...r,stream:!0},o=await e.submitToolOutputs(n,a,{...s,signal:this.controller.signal});this._connected();for await(const l of o)L(this,Xt,"m",Ya).call(this,l);if((c=o.controller.signal)!=null&&c.aborted)throw new Vn;return this._addRun(L(this,Xt,"m",Qa).call(this))}static createThreadAssistantStream(e,n,r){const s=new fi;return s._run(()=>s._threadAssistantStream(e,n,{...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"stream"}})),s}static createAssistantStream(e,n,r,s){const i=new fi;return i._run(()=>i._runAssistantStream(e,n,r,{...s,headers:{...s==null?void 0:s.headers,"X-Stainless-Helper-Method":"stream"}})),i}currentEvent(){return L(this,hl,"f")}currentRun(){return L(this,fl,"f")}currentMessageSnapshot(){return L(this,_r,"f")}currentRunStepSnapshot(){return L(this,ho,"f")}async finalRunSteps(){return await this.done(),Object.values(L(this,Pr,"f"))}async finalMessages(){return await this.done(),Object.values(L(this,dl,"f"))}async finalRun(){if(await this.done(),!L(this,pi,"f"))throw Error("Final run was not received.");return L(this,pi,"f")}async _createThreadAssistantStream(e,n,r){var o;const s=r==null?void 0:r.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort()));const i={...n,stream:!0},a=await e.createAndRun(i,{...r,signal:this.controller.signal});this._connected();for await(const c of a)L(this,Xt,"m",Ya).call(this,c);if((o=a.controller.signal)!=null&&o.aborted)throw new Vn;return this._addRun(L(this,Xt,"m",Qa).call(this))}async _createAssistantStream(e,n,r,s){var c;const i=s==null?void 0:s.signal;i&&(i.aborted&&this.controller.abort(),i.addEventListener("abort",()=>this.controller.abort()));const a={...r,stream:!0},o=await e.create(n,a,{...s,signal:this.controller.signal});this._connected();for await(const l of o)L(this,Xt,"m",Ya).call(this,l);if((c=o.controller.signal)!=null&&c.aborted)throw new Vn;return this._addRun(L(this,Xt,"m",Qa).call(this))}static accumulateDelta(e,n){for(const[r,s]of Object.entries(n)){if(!e.hasOwnProperty(r)){e[r]=s;continue}let i=e[r];if(i==null){e[r]=s;continue}if(r==="index"||r==="type"){e[r]=s;continue}if(typeof i=="string"&&typeof s=="string")i+=s;else if(typeof i=="number"&&typeof s=="number")i+=s;else if(eh(i)&&eh(s))i=this.accumulateDelta(i,s);else if(Array.isArray(i)&&Array.isArray(s)){if(i.every(a=>typeof a=="string"||typeof a=="number")){i.push(...s);continue}for(const a of s){if(!eh(a))throw new Error(`Expected array delta entry to be an object but got: ${a}`);const o=a.index;if(o==null)throw console.error(a),new Error("Expected array delta entry to have an `index` property");if(typeof o!="number")throw new Error(`Expected array delta entry \`index\` property to be a number but got ${o}`);const c=i[o];c==null?i.push(a):i[o]=this.accumulateDelta(c,a)}continue}else throw Error(`Unhandled record type: ${r}, deltaValue: ${s}, accValue: ${i}`);e[r]=i}return e}_addRun(e){return e}async _threadAssistantStream(e,n,r){return await this._createThreadAssistantStream(n,e,r)}async _runAssistantStream(e,n,r,s){return await this._createAssistantStream(n,e,r,s)}async _runToolAssistantStream(e,n,r,s){return await this._createToolAssistantStream(n,e,r,s)}}fi=fo,Ya=function(e){if(!this.ended)switch(Ae(this,hl,e),L(this,Xt,"m",x_).call(this,e),e.event){case"thread.created":break;case"thread.run.created":case"thread.run.queued":case"thread.run.in_progress":case"thread.run.requires_action":case"thread.run.completed":case"thread.run.incomplete":case"thread.run.failed":case"thread.run.cancelling":case"thread.run.cancelled":case"thread.run.expired":L(this,Xt,"m",C_).call(this,e);break;case"thread.run.step.created":case"thread.run.step.in_progress":case"thread.run.step.delta":case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":L(this,Xt,"m",S_).call(this,e);break;case"thread.message.created":case"thread.message.in_progress":case"thread.message.delta":case"thread.message.completed":case"thread.message.incomplete":L(this,Xt,"m",T_).call(this,e);break;case"error":throw new Error("Encountered an error event in event processing - errors should be processed earlier")}},Qa=function(){if(this.ended)throw new be("stream has ended, this shouldn't happen");if(!L(this,pi,"f"))throw Error("Final run has not been received");return L(this,pi,"f")},T_=function(e){const[n,r]=L(this,Xt,"m",I_).call(this,e,L(this,_r,"f"));Ae(this,_r,n),L(this,dl,"f")[n.id]=n;for(const s of r){const i=n.content[s.index];(i==null?void 0:i.type)=="text"&&this._emit("textCreated",i.text)}switch(e.event){case"thread.message.created":this._emit("messageCreated",e.data);break;case"thread.message.in_progress":break;case"thread.message.delta":if(this._emit("messageDelta",e.data.delta,n),e.data.delta.content)for(const s of e.data.delta.content){if(s.type=="text"&&s.text){let i=s.text,a=n.content[s.index];if(a&&a.type=="text")this._emit("textDelta",i,a.text);else throw Error("The snapshot associated with this text delta is not text or missing")}if(s.index!=L(this,ea,"f")){if(L(this,ci,"f"))switch(L(this,ci,"f").type){case"text":this._emit("textDone",L(this,ci,"f").text,L(this,_r,"f"));break;case"image_file":this._emit("imageFileDone",L(this,ci,"f").image_file,L(this,_r,"f"));break}Ae(this,ea,s.index)}Ae(this,ci,n.content[s.index])}break;case"thread.message.completed":case"thread.message.incomplete":if(L(this,ea,"f")!==void 0){const s=e.data.content[L(this,ea,"f")];if(s)switch(s.type){case"image_file":this._emit("imageFileDone",s.image_file,L(this,_r,"f"));break;case"text":this._emit("textDone",s.text,L(this,_r,"f"));break}}L(this,_r,"f")&&this._emit("messageDone",e.data),Ae(this,_r,void 0)}},S_=function(e){const n=L(this,Xt,"m",k_).call(this,e);switch(Ae(this,ho,n),e.event){case"thread.run.step.created":this._emit("runStepCreated",e.data);break;case"thread.run.step.delta":const r=e.data.delta;if(r.step_details&&r.step_details.type=="tool_calls"&&r.step_details.tool_calls&&n.step_details.type=="tool_calls")for(const i of r.step_details.tool_calls)i.index==L(this,cu,"f")?this._emit("toolCallDelta",i,n.step_details.tool_calls[i.index]):(L(this,Un,"f")&&this._emit("toolCallDone",L(this,Un,"f")),Ae(this,cu,i.index),Ae(this,Un,n.step_details.tool_calls[i.index]),L(this,Un,"f")&&this._emit("toolCallCreated",L(this,Un,"f")));this._emit("runStepDelta",e.data.delta,n);break;case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":Ae(this,ho,void 0),e.data.step_details.type=="tool_calls"&&L(this,Un,"f")&&(this._emit("toolCallDone",L(this,Un,"f")),Ae(this,Un,void 0)),this._emit("runStepDone",e.data,n);break}},x_=function(e){L(this,Rf,"f").push(e),this._emit("event",e)},k_=function(e){switch(e.event){case"thread.run.step.created":return L(this,Pr,"f")[e.data.id]=e.data,e.data;case"thread.run.step.delta":let n=L(this,Pr,"f")[e.data.id];if(!n)throw Error("Received a RunStepDelta before creation of a snapshot");let r=e.data;if(r.delta){const s=fi.accumulateDelta(n,r.delta);L(this,Pr,"f")[e.data.id]=s}return L(this,Pr,"f")[e.data.id];case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":case"thread.run.step.in_progress":L(this,Pr,"f")[e.data.id]=e.data;break}if(L(this,Pr,"f")[e.data.id])return L(this,Pr,"f")[e.data.id];throw new Error("No snapshot available")},I_=function(e,n){let r=[];switch(e.event){case"thread.message.created":return[e.data,r];case"thread.message.delta":if(!n)throw Error("Received a delta with no existing snapshot (there should be one from message creation)");let s=e.data;if(s.delta.content)for(const i of s.delta.content)if(i.index in n.content){let a=n.content[i.index];n.content[i.index]=L(this,Xt,"m",A_).call(this,i,a)}else n.content[i.index]=i,r.push(i);return[n,r];case"thread.message.in_progress":case"thread.message.completed":case"thread.message.incomplete":if(n)return[n,r];throw Error("Received thread message event with no existing snapshot")}throw Error("Tried to accumulate a non-message event")},A_=function(e,n){return fi.accumulateDelta(n,e)},C_=function(e){switch(Ae(this,fl,e.data),e.event){case"thread.run.created":break;case"thread.run.queued":break;case"thread.run.in_progress":break;case"thread.run.requires_action":case"thread.run.cancelled":case"thread.run.failed":case"thread.run.completed":case"thread.run.expired":case"thread.run.incomplete":Ae(this,pi,e.data),L(this,Un,"f")&&(this._emit("toolCallDone",L(this,Un,"f")),Ae(this,Un,void 0));break}};let Tm=class extends _e{constructor(){super(...arguments),this.steps=new NE(this._client)}create(e,n,r){const{include:s,...i}=n;return this._client.post(G`/threads/${e}/runs`,{query:{include:s},body:i,...r,headers:ce([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers]),stream:n.stream??!1})}retrieve(e,n,r){const{thread_id:s}=n;return this._client.get(G`/threads/${s}/runs/${e}`,{...r,headers:ce([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}update(e,n,r){const{thread_id:s,...i}=n;return this._client.post(G`/threads/${s}/runs/${e}`,{body:i,...r,headers:ce([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}list(e,n={},r){return this._client.getAPIList(G`/threads/${e}/runs`,Pt,{query:n,...r,headers:ce([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}cancel(e,n,r){const{thread_id:s}=n;return this._client.post(G`/threads/${s}/runs/${e}/cancel`,{...r,headers:ce([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}async createAndPoll(e,n,r){const s=await this.create(e,n,r);return await this.poll(s.id,{thread_id:e},r)}createAndStream(e,n,r){return fo.createAssistantStream(e,this._client.beta.threads.runs,n,r)}async poll(e,n,r){var i;const s=ce([r==null?void 0:r.headers,{"X-Stainless-Poll-Helper":"true","X-Stainless-Custom-Poll-Interval":((i=r==null?void 0:r.pollIntervalMs)==null?void 0:i.toString())??void 0}]);for(;;){const{data:a,response:o}=await this.retrieve(e,n,{...r,headers:{...r==null?void 0:r.headers,...s}}).withResponse();switch(a.status){case"queued":case"in_progress":case"cancelling":let c=5e3;if(r!=null&&r.pollIntervalMs)c=r.pollIntervalMs;else{const l=o.headers.get("openai-poll-after-ms");if(l){const u=parseInt(l);isNaN(u)||(c=u)}}await lc(c);break;case"requires_action":case"incomplete":case"cancelled":case"completed":case"failed":case"expired":return a}}}stream(e,n,r){return fo.createAssistantStream(e,this._client.beta.threads.runs,n,r)}submitToolOutputs(e,n,r){const{thread_id:s,...i}=n;return this._client.post(G`/threads/${s}/runs/${e}/submit_tool_outputs`,{body:i,...r,headers:ce([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers]),stream:n.stream??!1})}async submitToolOutputsAndPoll(e,n,r){const s=await this.submitToolOutputs(e,n,r);return await this.poll(s.id,n,r)}submitToolOutputsStream(e,n,r){return fo.createToolAssistantStream(e,this._client.beta.threads.runs,n,r)}};Tm.Steps=NE;class ed extends _e{constructor(){super(...arguments),this.runs=new Tm(this._client),this.messages=new RE(this._client)}create(e={},n){return this._client.post("/threads",{body:e,...n,headers:ce([{"OpenAI-Beta":"assistants=v2"},n==null?void 0:n.headers])})}retrieve(e,n){return this._client.get(G`/threads/${e}`,{...n,headers:ce([{"OpenAI-Beta":"assistants=v2"},n==null?void 0:n.headers])})}update(e,n,r){return this._client.post(G`/threads/${e}`,{body:n,...r,headers:ce([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}delete(e,n){return this._client.delete(G`/threads/${e}`,{...n,headers:ce([{"OpenAI-Beta":"assistants=v2"},n==null?void 0:n.headers])})}createAndRun(e,n){return this._client.post("/threads/runs",{body:e,...n,headers:ce([{"OpenAI-Beta":"assistants=v2"},n==null?void 0:n.headers]),stream:e.stream??!1})}async createAndRunPoll(e,n){const r=await this.createAndRun(e,n);return await this.runs.poll(r.id,{thread_id:r.thread_id},n)}createAndRunStream(e,n){return fo.createThreadAssistantStream(e,this._client.beta.threads,n)}}ed.Runs=Tm;ed.Messages=RE;class Pa extends _e{constructor(){super(...arguments),this.realtime=new Yu(this._client),this.chatkit=new Qu(this._client),this.assistants=new IE(this._client),this.threads=new ed(this._client)}}Pa.Realtime=Yu;Pa.ChatKit=Qu;Pa.Assistants=IE;Pa.Threads=ed;class PE extends _e{create(e,n){return this._client.post("/completions",{body:e,...n,stream:e.stream??!1})}}class ME extends _e{retrieve(e,n,r){const{container_id:s}=n;return this._client.get(G`/containers/${s}/files/${e}/content`,{...r,headers:ce([{Accept:"application/binary"},r==null?void 0:r.headers]),__binaryResponse:!0})}}let Sm=class extends _e{constructor(){super(...arguments),this.content=new ME(this._client)}create(e,n,r){return this._client.post(G`/containers/${e}/files`,Ai({body:n,...r},this._client))}retrieve(e,n,r){const{container_id:s}=n;return this._client.get(G`/containers/${s}/files/${e}`,r)}list(e,n={},r){return this._client.getAPIList(G`/containers/${e}/files`,Pt,{query:n,...r})}delete(e,n,r){const{container_id:s}=n;return this._client.delete(G`/containers/${s}/files/${e}`,{...r,headers:ce([{Accept:"*/*"},r==null?void 0:r.headers])})}};Sm.Content=ME;class xm extends _e{constructor(){super(...arguments),this.files=new Sm(this._client)}create(e,n){return this._client.post("/containers",{body:e,...n})}retrieve(e,n){return this._client.get(G`/containers/${e}`,n)}list(e={},n){return this._client.getAPIList("/containers",Pt,{query:e,...n})}delete(e,n){return this._client.delete(G`/containers/${e}`,{...n,headers:ce([{Accept:"*/*"},n==null?void 0:n.headers])})}}xm.Files=Sm;class LE extends _e{create(e,n,r){const{include:s,...i}=n;return this._client.post(G`/conversations/${e}/items`,{query:{include:s},body:i,...r})}retrieve(e,n,r){const{conversation_id:s,...i}=n;return this._client.get(G`/conversations/${s}/items/${e}`,{query:i,...r})}list(e,n={},r){return this._client.getAPIList(G`/conversations/${e}/items`,tu,{query:n,...r})}delete(e,n,r){const{conversation_id:s}=n;return this._client.delete(G`/conversations/${s}/items/${e}`,r)}}class km extends _e{constructor(){super(...arguments),this.items=new LE(this._client)}create(e={},n){return this._client.post("/conversations",{body:e,...n})}retrieve(e,n){return this._client.get(G`/conversations/${e}`,n)}update(e,n,r){return this._client.post(G`/conversations/${e}`,{body:n,...r})}delete(e,n){return this._client.delete(G`/conversations/${e}`,n)}}km.Items=LE;let jE=class extends _e{create(e,n){const r=!!e.encoding_format;let s=r?e.encoding_format:"base64";r&&Kt(this._client).debug("embeddings/user defined encoding_format:",e.encoding_format);const i=this._client.post("/embeddings",{body:{...e,encoding_format:s},...n});return r?i:(Kt(this._client).debug("embeddings/decoding base64 embeddings from base64"),i._thenUnwrap(a=>(a&&a.data&&a.data.forEach(o=>{const c=o.embedding;o.embedding=jL(c)}),a)))}};class DE extends _e{retrieve(e,n,r){const{eval_id:s,run_id:i}=n;return this._client.get(G`/evals/${s}/runs/${i}/output_items/${e}`,r)}list(e,n,r){const{eval_id:s,...i}=n;return this._client.getAPIList(G`/evals/${s}/runs/${e}/output_items`,Pt,{query:i,...r})}}class Im extends _e{constructor(){super(...arguments),this.outputItems=new DE(this._client)}create(e,n,r){return this._client.post(G`/evals/${e}/runs`,{body:n,...r})}retrieve(e,n,r){const{eval_id:s}=n;return this._client.get(G`/evals/${s}/runs/${e}`,r)}list(e,n={},r){return this._client.getAPIList(G`/evals/${e}/runs`,Pt,{query:n,...r})}delete(e,n,r){const{eval_id:s}=n;return this._client.delete(G`/evals/${s}/runs/${e}`,r)}cancel(e,n,r){const{eval_id:s}=n;return this._client.post(G`/evals/${s}/runs/${e}`,r)}}Im.OutputItems=DE;class Am extends _e{constructor(){super(...arguments),this.runs=new Im(this._client)}create(e,n){return this._client.post("/evals",{body:e,...n})}retrieve(e,n){return this._client.get(G`/evals/${e}`,n)}update(e,n,r){return this._client.post(G`/evals/${e}`,{body:n,...r})}list(e={},n){return this._client.getAPIList("/evals",Pt,{query:e,...n})}delete(e,n){return this._client.delete(G`/evals/${e}`,n)}}Am.Runs=Im;let UE=class extends _e{create(e,n){return this._client.post("/files",Ai({body:e,...n},this._client))}retrieve(e,n){return this._client.get(G`/files/${e}`,n)}list(e={},n){return this._client.getAPIList("/files",Pt,{query:e,...n})}delete(e,n){return this._client.delete(G`/files/${e}`,n)}content(e,n){return this._client.get(G`/files/${e}/content`,{...n,headers:ce([{Accept:"application/binary"},n==null?void 0:n.headers]),__binaryResponse:!0})}async waitForProcessing(e,{pollInterval:n=5e3,maxWait:r=30*60*1e3}={}){const s=new Set(["processed","error","deleted"]),i=Date.now();let a=await this.retrieve(e);for(;!a.status||!s.has(a.status);)if(await lc(n),a=await this.retrieve(e),Date.now()-i>r)throw new qu({message:`Giving up on waiting for file ${e} to finish processing after ${r} milliseconds.`});return a}};class FE extends _e{}let BE=class extends _e{run(e,n){return this._client.post("/fine_tuning/alpha/graders/run",{body:e,...n})}validate(e,n){return this._client.post("/fine_tuning/alpha/graders/validate",{body:e,...n})}};class Cm extends _e{constructor(){super(...arguments),this.graders=new BE(this._client)}}Cm.Graders=BE;class zE extends _e{create(e,n,r){return this._client.getAPIList(G`/fine_tuning/checkpoints/${e}/permissions`,Xu,{body:n,method:"post",...r})}retrieve(e,n={},r){return this._client.get(G`/fine_tuning/checkpoints/${e}/permissions`,{query:n,...r})}delete(e,n,r){const{fine_tuned_model_checkpoint:s}=n;return this._client.delete(G`/fine_tuning/checkpoints/${s}/permissions/${e}`,r)}}let Om=class extends _e{constructor(){super(...arguments),this.permissions=new zE(this._client)}};Om.Permissions=zE;class ZE extends _e{list(e,n={},r){return this._client.getAPIList(G`/fine_tuning/jobs/${e}/checkpoints`,Pt,{query:n,...r})}}class $m extends _e{constructor(){super(...arguments),this.checkpoints=new ZE(this._client)}create(e,n){return this._client.post("/fine_tuning/jobs",{body:e,...n})}retrieve(e,n){return this._client.get(G`/fine_tuning/jobs/${e}`,n)}list(e={},n){return this._client.getAPIList("/fine_tuning/jobs",Pt,{query:e,...n})}cancel(e,n){return this._client.post(G`/fine_tuning/jobs/${e}/cancel`,n)}listEvents(e,n={},r){return this._client.getAPIList(G`/fine_tuning/jobs/${e}/events`,Pt,{query:n,...r})}pause(e,n){return this._client.post(G`/fine_tuning/jobs/${e}/pause`,n)}resume(e,n){return this._client.post(G`/fine_tuning/jobs/${e}/resume`,n)}}$m.Checkpoints=ZE;class Ma extends _e{constructor(){super(...arguments),this.methods=new FE(this._client),this.jobs=new $m(this._client),this.checkpoints=new Om(this._client),this.alpha=new Cm(this._client)}}Ma.Methods=FE;Ma.Jobs=$m;Ma.Checkpoints=Om;Ma.Alpha=Cm;class VE extends _e{}class Rm extends _e{constructor(){super(...arguments),this.graderModels=new VE(this._client)}}Rm.GraderModels=VE;class GE extends _e{createVariation(e,n){return this._client.post("/images/variations",Ai({body:e,...n},this._client))}edit(e,n){return this._client.post("/images/edits",Ai({body:e,...n,stream:e.stream??!1},this._client))}generate(e,n){return this._client.post("/images/generations",{body:e,...n,stream:e.stream??!1})}}class WE extends _e{retrieve(e,n){return this._client.get(G`/models/${e}`,n)}list(e){return this._client.getAPIList("/models",Xu,e)}delete(e,n){return this._client.delete(G`/models/${e}`,n)}}class HE extends _e{create(e,n){return this._client.post("/moderations",{body:e,...n})}}class qE extends _e{accept(e,n,r){return this._client.post(G`/realtime/calls/${e}/accept`,{body:n,...r,headers:ce([{Accept:"*/*"},r==null?void 0:r.headers])})}hangup(e,n){return this._client.post(G`/realtime/calls/${e}/hangup`,{...n,headers:ce([{Accept:"*/*"},n==null?void 0:n.headers])})}refer(e,n,r){return this._client.post(G`/realtime/calls/${e}/refer`,{body:n,...r,headers:ce([{Accept:"*/*"},r==null?void 0:r.headers])})}reject(e,n={},r){return this._client.post(G`/realtime/calls/${e}/reject`,{body:n,...r,headers:ce([{Accept:"*/*"},r==null?void 0:r.headers])})}}class JE extends _e{create(e,n){return this._client.post("/realtime/client_secrets",{body:e,...n})}}class td extends _e{constructor(){super(...arguments),this.clientSecrets=new JE(this._client),this.calls=new qE(this._client)}}td.ClientSecrets=JE;td.Calls=qE;function DL(t,e){return!e||!FL(e)?{...t,output_parsed:null,output:t.output.map(n=>n.type==="function_call"?{...n,parsed_arguments:null}:n.type==="message"?{...n,content:n.content.map(r=>({...r,parsed:null}))}:n)}:KE(t,e)}function KE(t,e){const n=t.output.map(s=>{if(s.type==="function_call")return{...s,parsed_arguments:ZL(e,s)};if(s.type==="message"){const i=s.content.map(a=>a.type==="output_text"?{...a,parsed:UL(e,a.text)}:a);return{...s,content:i}}return s}),r=Object.assign({},t,{output:n});return Object.getOwnPropertyDescriptor(t,"output_text")||Nf(r),Object.defineProperty(r,"output_parsed",{enumerable:!0,get(){for(const s of r.output)if(s.type==="message"){for(const i of s.content)if(i.type==="output_text"&&i.parsed!==null)return i.parsed}return null}}),r}function UL(t,e){var n,r,s,i;return((r=(n=t.text)==null?void 0:n.format)==null?void 0:r.type)!=="json_schema"?null:"$parseRaw"in((s=t.text)==null?void 0:s.format)?((i=t.text)==null?void 0:i.format).$parseRaw(e):JSON.parse(e)}function FL(t){var e;return!!ym((e=t.text)==null?void 0:e.format)}function BL(t){return(t==null?void 0:t.$brand)==="auto-parseable-tool"}function zL(t,e){return t.find(n=>n.type==="function"&&n.name===e)}function ZL(t,e){const n=zL(t.tools??[],e.name);return{...e,...e,parsed_arguments:BL(n)?n.$parseRaw(e.arguments):n!=null&&n.strict?JSON.parse(e.arguments):null}}function Nf(t){const e=[];for(const n of t.output)if(n.type==="message")for(const r of n.content)r.type==="output_text"&&e.push(r.text);t.output_text=e.join("")}var zi,Gc,Is,Wc,O_,$_,R_,N_;class Nm extends wm{constructor(e){super(),zi.add(this),Gc.set(this,void 0),Is.set(this,void 0),Wc.set(this,void 0),Ae(this,Gc,e)}static createResponse(e,n,r){const s=new Nm(n);return s._run(()=>s._createOrRetrieveResponse(e,n,{...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"stream"}})),s}async _createOrRetrieveResponse(e,n,r){var o;const s=r==null?void 0:r.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),L(this,zi,"m",O_).call(this);let i,a=null;"response_id"in n?(i=await e.responses.retrieve(n.response_id,{stream:!0},{...r,signal:this.controller.signal,stream:!0}),a=n.starting_after??null):i=await e.responses.create({...n,stream:!0},{...r,signal:this.controller.signal}),this._connected();for await(const c of i)L(this,zi,"m",$_).call(this,c,a);if((o=i.controller.signal)!=null&&o.aborted)throw new Vn;return L(this,zi,"m",R_).call(this)}[(Gc=new WeakMap,Is=new WeakMap,Wc=new WeakMap,zi=new WeakSet,O_=function(){this.ended||Ae(this,Is,void 0)},$_=function(n,r){if(this.ended)return;const s=(a,o)=>{(r==null||o.sequence_number>r)&&this._emit(a,o)},i=L(this,zi,"m",N_).call(this,n);switch(s("event",n),n.type){case"response.output_text.delta":{const a=i.output[n.output_index];if(!a)throw new be(`missing output at index ${n.output_index}`);if(a.type==="message"){const o=a.content[n.content_index];if(!o)throw new be(`missing content at index ${n.content_index}`);if(o.type!=="output_text")throw new be(`expected content to be 'output_text', got ${o.type}`);s("response.output_text.delta",{...n,snapshot:o.text})}break}case"response.function_call_arguments.delta":{const a=i.output[n.output_index];if(!a)throw new be(`missing output at index ${n.output_index}`);a.type==="function_call"&&s("response.function_call_arguments.delta",{...n,snapshot:a.arguments});break}default:s(n.type,n);break}},R_=function(){if(this.ended)throw new be("stream has ended, this shouldn't happen");const n=L(this,Is,"f");if(!n)throw new be("request ended without sending any events");Ae(this,Is,void 0);const r=VL(n,L(this,Gc,"f"));return Ae(this,Wc,r),r},N_=function(n){var s;let r=L(this,Is,"f");if(!r){if(n.type!=="response.created")throw new be(`When snapshot hasn't been set yet, expected 'response.created' event, got ${n.type}`);return r=Ae(this,Is,n.response),r}switch(n.type){case"response.output_item.added":{r.output.push(n.item);break}case"response.content_part.added":{const i=r.output[n.output_index];if(!i)throw new be(`missing output at index ${n.output_index}`);const a=i.type,o=n.part;a==="message"&&o.type!=="reasoning_text"?i.content.push(o):a==="reasoning"&&o.type==="reasoning_text"&&(i.content||(i.content=[]),i.content.push(o));break}case"response.output_text.delta":{const i=r.output[n.output_index];if(!i)throw new be(`missing output at index ${n.output_index}`);if(i.type==="message"){const a=i.content[n.content_index];if(!a)throw new be(`missing content at index ${n.content_index}`);if(a.type!=="output_text")throw new be(`expected content to be 'output_text', got ${a.type}`);a.text+=n.delta}break}case"response.function_call_arguments.delta":{const i=r.output[n.output_index];if(!i)throw new be(`missing output at index ${n.output_index}`);i.type==="function_call"&&(i.arguments+=n.delta);break}case"response.reasoning_text.delta":{const i=r.output[n.output_index];if(!i)throw new be(`missing output at index ${n.output_index}`);if(i.type==="reasoning"){const a=(s=i.content)==null?void 0:s[n.content_index];if(!a)throw new be(`missing content at index ${n.content_index}`);if(a.type!=="reasoning_text")throw new be(`expected content to be 'reasoning_text', got ${a.type}`);a.text+=n.delta}break}case"response.completed":{Ae(this,Is,n.response);break}}return r},Symbol.asyncIterator)](){const e=[],n=[];let r=!1;return this.on("event",s=>{const i=n.shift();i?i.resolve(s):e.push(s)}),this.on("end",()=>{r=!0;for(const s of n)s.resolve(void 0);n.length=0}),this.on("abort",s=>{r=!0;for(const i of n)i.reject(s);n.length=0}),this.on("error",s=>{r=!0;for(const i of n)i.reject(s);n.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:r?{value:void 0,done:!0}:new Promise((i,a)=>n.push({resolve:i,reject:a})).then(i=>i?{value:i,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}async finalResponse(){await this.done();const e=L(this,Wc,"f");if(!e)throw new be("stream ended without producing a ChatCompletion");return e}}function VL(t,e){return DL(t,e)}class XE extends _e{list(e,n={},r){return this._client.getAPIList(G`/responses/${e}/input_items`,Pt,{query:n,...r})}}class YE extends _e{count(e={},n){return this._client.post("/responses/input_tokens",{body:e,...n})}}class nd extends _e{constructor(){super(...arguments),this.inputItems=new XE(this._client),this.inputTokens=new YE(this._client)}create(e,n){return this._client.post("/responses",{body:e,...n,stream:e.stream??!1})._thenUnwrap(r=>("object"in r&&r.object==="response"&&Nf(r),r))}retrieve(e,n={},r){return this._client.get(G`/responses/${e}`,{query:n,...r,stream:(n==null?void 0:n.stream)??!1})._thenUnwrap(s=>("object"in s&&s.object==="response"&&Nf(s),s))}delete(e,n){return this._client.delete(G`/responses/${e}`,{...n,headers:ce([{Accept:"*/*"},n==null?void 0:n.headers])})}parse(e,n){return this._client.responses.create(e,n)._thenUnwrap(r=>KE(r,e))}stream(e,n){return Nm.createResponse(this._client,e,n)}cancel(e,n){return this._client.post(G`/responses/${e}/cancel`,n)}compact(e,n){return this._client.post("/responses/compact",{body:e,...n})}}nd.InputItems=XE;nd.InputTokens=YE;class QE extends _e{create(e,n,r){return this._client.post(G`/uploads/${e}/parts`,Ai({body:n,...r},this._client))}}class Pm extends _e{constructor(){super(...arguments),this.parts=new QE(this._client)}create(e,n){return this._client.post("/uploads",{body:e,...n})}cancel(e,n){return this._client.post(G`/uploads/${e}/cancel`,n)}complete(e,n,r){return this._client.post(G`/uploads/${e}/complete`,{body:n,...r})}}Pm.Parts=QE;const GL=async t=>{const e=await Promise.allSettled(t),n=e.filter(s=>s.status==="rejected");if(n.length){for(const s of n)console.error(s.reason);throw new Error(`${n.length} promise(s) failed - see the above errors`)}const r=[];for(const s of e)s.status==="fulfilled"&&r.push(s.value);return r};class eT extends _e{create(e,n,r){return this._client.post(G`/vector_stores/${e}/file_batches`,{body:n,...r,headers:ce([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}retrieve(e,n,r){const{vector_store_id:s}=n;return this._client.get(G`/vector_stores/${s}/file_batches/${e}`,{...r,headers:ce([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}cancel(e,n,r){const{vector_store_id:s}=n;return this._client.post(G`/vector_stores/${s}/file_batches/${e}/cancel`,{...r,headers:ce([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}async createAndPoll(e,n,r){const s=await this.create(e,n);return await this.poll(e,s.id,r)}listFiles(e,n,r){const{vector_store_id:s,...i}=n;return this._client.getAPIList(G`/vector_stores/${s}/file_batches/${e}/files`,Pt,{query:i,...r,headers:ce([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}async poll(e,n,r){var i;const s=ce([r==null?void 0:r.headers,{"X-Stainless-Poll-Helper":"true","X-Stainless-Custom-Poll-Interval":((i=r==null?void 0:r.pollIntervalMs)==null?void 0:i.toString())??void 0}]);for(;;){const{data:a,response:o}=await this.retrieve(n,{vector_store_id:e},{...r,headers:s}).withResponse();switch(a.status){case"in_progress":let c=5e3;if(r!=null&&r.pollIntervalMs)c=r.pollIntervalMs;else{const l=o.headers.get("openai-poll-after-ms");if(l){const u=parseInt(l);isNaN(u)||(c=u)}}await lc(c);break;case"failed":case"cancelled":case"completed":return a}}}async uploadAndPoll(e,{files:n,fileIds:r=[]},s){if(n==null||n.length==0)throw new Error("No `files` provided to process. If you've already uploaded files you should use `.createAndPoll()` instead");const i=(s==null?void 0:s.maxConcurrency)??5,a=Math.min(i,n.length),o=this._client,c=n.values(),l=[...r];async function u(h){for(let f of h){const m=await o.files.create({file:f,purpose:"assistants"},s);l.push(m.id)}}const d=Array(a).fill(c).map(u);return await GL(d),await this.createAndPoll(e,{file_ids:l})}}class tT extends _e{create(e,n,r){return this._client.post(G`/vector_stores/${e}/files`,{body:n,...r,headers:ce([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}retrieve(e,n,r){const{vector_store_id:s}=n;return this._client.get(G`/vector_stores/${s}/files/${e}`,{...r,headers:ce([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}update(e,n,r){const{vector_store_id:s,...i}=n;return this._client.post(G`/vector_stores/${s}/files/${e}`,{body:i,...r,headers:ce([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}list(e,n={},r){return this._client.getAPIList(G`/vector_stores/${e}/files`,Pt,{query:n,...r,headers:ce([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}delete(e,n,r){const{vector_store_id:s}=n;return this._client.delete(G`/vector_stores/${s}/files/${e}`,{...r,headers:ce([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}async createAndPoll(e,n,r){const s=await this.create(e,n,r);return await this.poll(e,s.id,r)}async poll(e,n,r){var i;const s=ce([r==null?void 0:r.headers,{"X-Stainless-Poll-Helper":"true","X-Stainless-Custom-Poll-Interval":((i=r==null?void 0:r.pollIntervalMs)==null?void 0:i.toString())??void 0}]);for(;;){const a=await this.retrieve(n,{vector_store_id:e},{...r,headers:s}).withResponse(),o=a.data;switch(o.status){case"in_progress":let c=5e3;if(r!=null&&r.pollIntervalMs)c=r.pollIntervalMs;else{const l=a.response.headers.get("openai-poll-after-ms");if(l){const u=parseInt(l);isNaN(u)||(c=u)}}await lc(c);break;case"failed":case"completed":return o}}}async upload(e,n,r){const s=await this._client.files.create({file:n,purpose:"assistants"},r);return this.create(e,{file_id:s.id},r)}async uploadAndPoll(e,n,r){const s=await this.upload(e,n,r);return await this.poll(e,s.id,r)}content(e,n,r){const{vector_store_id:s}=n;return this._client.getAPIList(G`/vector_stores/${s}/files/${e}/content`,Xu,{...r,headers:ce([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}}class rd extends _e{constructor(){super(...arguments),this.files=new tT(this._client),this.fileBatches=new eT(this._client)}create(e,n){return this._client.post("/vector_stores",{body:e,...n,headers:ce([{"OpenAI-Beta":"assistants=v2"},n==null?void 0:n.headers])})}retrieve(e,n){return this._client.get(G`/vector_stores/${e}`,{...n,headers:ce([{"OpenAI-Beta":"assistants=v2"},n==null?void 0:n.headers])})}update(e,n,r){return this._client.post(G`/vector_stores/${e}`,{body:n,...r,headers:ce([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}list(e={},n){return this._client.getAPIList("/vector_stores",Pt,{query:e,...n,headers:ce([{"OpenAI-Beta":"assistants=v2"},n==null?void 0:n.headers])})}delete(e,n){return this._client.delete(G`/vector_stores/${e}`,{...n,headers:ce([{"OpenAI-Beta":"assistants=v2"},n==null?void 0:n.headers])})}search(e,n,r){return this._client.getAPIList(G`/vector_stores/${e}/search`,Xu,{body:n,method:"post",...r,headers:ce([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}}rd.Files=tT;rd.FileBatches=eT;class nT extends _e{create(e,n){return this._client.post("/videos",__({body:e,...n},this._client))}retrieve(e,n){return this._client.get(G`/videos/${e}`,n)}list(e={},n){return this._client.getAPIList("/videos",tu,{query:e,...n})}delete(e,n){return this._client.delete(G`/videos/${e}`,n)}downloadContent(e,n={},r){return this._client.get(G`/videos/${e}/content`,{query:n,...r,headers:ce([{Accept:"application/binary"},r==null?void 0:r.headers]),__binaryResponse:!0})}remix(e,n,r){return this._client.post(G`/videos/${e}/remix`,__({body:n,...r},this._client))}}var Xi,rT,pl;class sT extends _e{constructor(){super(...arguments),Xi.add(this)}async unwrap(e,n,r=this._client.webhookSecret,s=300){return await this.verifySignature(e,n,r,s),JSON.parse(e)}async verifySignature(e,n,r=this._client.webhookSecret,s=300){if(typeof crypto>"u"||typeof crypto.subtle.importKey!="function"||typeof crypto.subtle.verify!="function")throw new Error("Webhook signature verification is only supported when the `crypto` global is defined");L(this,Xi,"m",rT).call(this,r);const i=ce([n]).values,a=L(this,Xi,"m",pl).call(this,i,"webhook-signature"),o=L(this,Xi,"m",pl).call(this,i,"webhook-timestamp"),c=L(this,Xi,"m",pl).call(this,i,"webhook-id"),l=parseInt(o,10);if(isNaN(l))throw new Ga("Invalid webhook timestamp format");const u=Math.floor(Date.now()/1e3);if(u-l>s)throw new Ga("Webhook timestamp is too old");if(l>u+s)throw new Ga("Webhook timestamp is too new");const d=a.split(" ").map(g=>g.startsWith("v1,")?g.substring(3):g),h=r.startsWith("whsec_")?Fs.from(r.replace("whsec_",""),"base64"):Fs.from(r,"utf-8"),f=c?`${c}.${o}.${e}`:`${o}.${e}`,m=await crypto.subtle.importKey("raw",h,{name:"HMAC",hash:"SHA-256"},!1,["verify"]);for(const g of d)try{const w=Fs.from(g,"base64");if(await crypto.subtle.verify("HMAC",m,w,new TextEncoder().encode(f)))return}catch{continue}throw new Ga("The given webhook signature does not match the expected signature")}}Xi=new WeakSet,rT=function(e){if(typeof e!="string"||e.length===0)throw new Error("The webhook secret must either be set using the env var, OPENAI_WEBHOOK_SECRET, on the client class, OpenAI({ webhookSecret: '123' }), or passed to this function")},pl=function(e,n){if(!e)throw new Error("Headers are required");const r=e.get(n);if(r==null)throw new Error(`Missing required header: ${n}`);return r};var Pf,Mm,ml,iT;class De{constructor({baseURL:e=Bi("OPENAI_BASE_URL"),apiKey:n=Bi("OPENAI_API_KEY"),organization:r=Bi("OPENAI_ORG_ID")??null,project:s=Bi("OPENAI_PROJECT_ID")??null,webhookSecret:i=Bi("OPENAI_WEBHOOK_SECRET")??null,...a}={}){if(Pf.add(this),ml.set(this,void 0),this.completions=new PE(this),this.chat=new Em(this),this.embeddings=new jE(this),this.files=new UE(this),this.images=new GE(this),this.audio=new dc(this),this.moderations=new HE(this),this.models=new WE(this),this.fineTuning=new Ma(this),this.graders=new Rm(this),this.vectorStores=new rd(this),this.webhooks=new sT(this),this.beta=new Pa(this),this.batches=new kE(this),this.uploads=new Pm(this),this.responses=new nd(this),this.realtime=new td(this),this.conversations=new km(this),this.evals=new Am(this),this.containers=new xm(this),this.videos=new nT(this),n===void 0)throw new be("Missing credentials. Please pass an `apiKey`, or set the `OPENAI_API_KEY` environment variable.");const o={apiKey:n,organization:r,project:s,webhookSecret:i,...a,baseURL:e||"https://api.openai.com/v1"};if(!o.dangerouslyAllowBrowser&&WM())throw new be(`It looks like you're running in a browser-like environment.

This is disabled by default, as it risks exposing your secret API credentials to attackers.
If you understand the risks and have appropriate mitigations in place,
you can set the \`dangerouslyAllowBrowser\` option to \`true\`, e.g.,

new OpenAI({ apiKey, dangerouslyAllowBrowser: true });

https://help.openai.com/en/articles/5112595-best-practices-for-api-key-safety
`);this.baseURL=o.baseURL,this.timeout=o.timeout??Mm.DEFAULT_TIMEOUT,this.logger=o.logger??console;const c="warn";this.logLevel=c,this.logLevel=g_(o.logLevel,"ClientOptions.logLevel",this)??g_(Bi("OPENAI_LOG"),"process.env['OPENAI_LOG']",this)??c,this.fetchOptions=o.fetchOptions,this.maxRetries=o.maxRetries??2,this.fetch=o.fetch??XM(),Ae(this,ml,QM),this._options=o,this.apiKey=typeof n=="string"?n:"Missing Key",this.organization=r,this.project=s,this.webhookSecret=i}withOptions(e){return new this.constructor({...this._options,baseURL:this.baseURL,maxRetries:this.maxRetries,timeout:this.timeout,logger:this.logger,logLevel:this.logLevel,fetch:this.fetch,fetchOptions:this.fetchOptions,apiKey:this.apiKey,organization:this.organization,project:this.project,webhookSecret:this.webhookSecret,...e})}defaultQuery(){return this._options.defaultQuery}validateHeaders({values:e,nulls:n}){}async authHeaders(e){return ce([{Authorization:`Bearer ${this.apiKey}`}])}stringifyQuery(e){return iL(e,{arrayFormat:"brackets"})}getUserAgent(){return`${this.constructor.name}/JS ${Ji}`}defaultIdempotencyKey(){return`stainless-node-retry-${A0()}`}makeStatusError(e,n,r,s){return tn.generate(e,n,r,s)}async _callApiKey(){const e=this._options.apiKey;if(typeof e!="function")return!1;let n;try{n=await e()}catch(r){throw r instanceof be?r:new be(`Failed to get token from 'apiKey' function: ${r.message}`,{cause:r})}if(typeof n!="string"||!n)throw new be(`Expected 'apiKey' function argument to return a string but it returned ${n}`);return this.apiKey=n,!0}buildURL(e,n,r){const s=!L(this,Pf,"m",iT).call(this)&&r||this.baseURL,i=BM(e)?new URL(e):new URL(s+(s.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),a=this.defaultQuery();return zM(a)||(n={...a,...n}),typeof n=="object"&&n&&!Array.isArray(n)&&(i.search=this.stringifyQuery(n)),i.toString()}async prepareOptions(e){await this._callApiKey()}async prepareRequest(e,{url:n,options:r}){}get(e,n){return this.methodRequest("get",e,n)}post(e,n){return this.methodRequest("post",e,n)}patch(e,n){return this.methodRequest("patch",e,n)}put(e,n){return this.methodRequest("put",e,n)}delete(e,n){return this.methodRequest("delete",e,n)}methodRequest(e,n,r){return this.request(Promise.resolve(r).then(s=>({method:e,path:n,...s})))}request(e,n=null){return new Ku(this,this.makeRequest(e,n,void 0))}async makeRequest(e,n,r){var b,y;const s=await e,i=s.maxRetries??this.maxRetries;n==null&&(n=i),await this.prepareOptions(s);const{req:a,url:o,timeout:c}=await this.buildRequest(s,{retryCount:i-n});await this.prepareRequest(a,{url:o,options:s});const l="log_"+(Math.random()*(1<<24)|0).toString(16).padStart(6,"0"),u=r===void 0?"":`, retryOf: ${r}`,d=Date.now();if(Kt(this).debug(`[${l}] sending request`,si({retryOfRequestLogID:r,method:s.method,url:o,options:s,headers:a.headers})),(b=s.signal)!=null&&b.aborted)throw new Vn;const h=new AbortController,f=await this.fetchWithTimeout(o,a,c,h).catch(Ef),m=Date.now();if(f instanceof globalThis.Error){const v=`retrying, ${n} attempts remaining`;if((y=s.signal)!=null&&y.aborted)throw new Vn;const T=bf(f)||/timed? ?out/i.test(String(f)+("cause"in f?String(f.cause):""));if(n)return Kt(this).info(`[${l}] connection ${T?"timed out":"failed"} - ${v}`),Kt(this).debug(`[${l}] connection ${T?"timed out":"failed"} (${v})`,si({retryOfRequestLogID:r,url:o,durationMs:m-d,message:f.message})),this.retryRequest(s,n,r??l);throw Kt(this).info(`[${l}] connection ${T?"timed out":"failed"} - error; no more retries left`),Kt(this).debug(`[${l}] connection ${T?"timed out":"failed"} (error; no more retries left)`,si({retryOfRequestLogID:r,url:o,durationMs:m-d,message:f.message})),T?new qu:new Hu({cause:f})}const g=[...f.headers.entries()].filter(([v])=>v==="x-request-id").map(([v,T])=>", "+v+": "+JSON.stringify(T)).join(""),w=`[${l}${u}${g}] ${a.method} ${o} ${f.ok?"succeeded":"failed"} with status ${f.status} in ${m-d}ms`;if(!f.ok){const v=await this.shouldRetry(f);if(n&&v){const M=`retrying, ${n} attempts remaining`;return await YM(f.body),Kt(this).info(`${w} - ${M}`),Kt(this).debug(`[${l}] response error (${M})`,si({retryOfRequestLogID:r,url:f.url,status:f.status,headers:f.headers,durationMs:m-d})),this.retryRequest(s,n,r??l,f.headers)}const T=v?"error; no more retries left":"error; not retryable";Kt(this).info(`${w} - ${T}`);const A=await f.text().catch(M=>Ef(M).message),I=GM(A),$=I?void 0:A;throw Kt(this).debug(`[${l}] response error (${T})`,si({retryOfRequestLogID:r,url:f.url,status:f.status,headers:f.headers,message:$,durationMs:Date.now()-d})),this.makeStatusError(f.status,I,$,f.headers)}return Kt(this).info(w),Kt(this).debug(`[${l}] response start`,si({retryOfRequestLogID:r,url:f.url,status:f.status,headers:f.headers,durationMs:m-d})),{response:f,options:s,controller:h,requestLogID:l,retryOfRequestLogID:r,startTime:d}}getAPIList(e,n,r){return this.requestAPIList(n,{method:"get",path:e,...r})}requestAPIList(e,n){const r=this.makeRequest(n,null,void 0);return new pL(this,r,e)}async fetchWithTimeout(e,n,r,s){const{signal:i,method:a,...o}=n||{};i&&i.addEventListener("abort",()=>s.abort());const c=setTimeout(()=>s.abort(),r),l=globalThis.ReadableStream&&o.body instanceof globalThis.ReadableStream||typeof o.body=="object"&&o.body!==null&&Symbol.asyncIterator in o.body,u={signal:s.signal,...l?{duplex:"half"}:{},method:"GET",...o};a&&(u.method=a.toUpperCase());try{return await this.fetch.call(void 0,e,u)}finally{clearTimeout(c)}}async shouldRetry(e){const n=e.headers.get("x-should-retry");return n==="true"?!0:n==="false"?!1:e.status===408||e.status===409||e.status===429||e.status>=500}async retryRequest(e,n,r,s){let i;const a=s==null?void 0:s.get("retry-after-ms");if(a){const c=parseFloat(a);Number.isNaN(c)||(i=c)}const o=s==null?void 0:s.get("retry-after");if(o&&!i){const c=parseFloat(o);Number.isNaN(c)?i=Date.parse(o)-Date.now():i=c*1e3}if(!(i&&0<=i&&i<60*1e3)){const c=e.maxRetries??this.maxRetries;i=this.calculateDefaultRetryTimeoutMillis(n,c)}return await lc(i),this.makeRequest(e,n-1,r)}calculateDefaultRetryTimeoutMillis(e,n){const i=n-e,a=Math.min(.5*Math.pow(2,i),8),o=1-Math.random()*.25;return a*o*1e3}async buildRequest(e,{retryCount:n=0}={}){const r={...e},{method:s,path:i,query:a,defaultBaseURL:o}=r,c=this.buildURL(i,a,o);"timeout"in r&&VM("timeout",r.timeout),r.timeout=r.timeout??this.timeout;const{bodyHeaders:l,body:u}=this.buildBody({options:r}),d=await this.buildHeaders({options:e,method:s,bodyHeaders:l,retryCount:n});return{req:{method:s,headers:d,...r.signal&&{signal:r.signal},...globalThis.ReadableStream&&u instanceof globalThis.ReadableStream&&{duplex:"half"},...u&&{body:u},...this.fetchOptions??{},...r.fetchOptions??{}},url:c,timeout:r.timeout}}async buildHeaders({options:e,method:n,bodyHeaders:r,retryCount:s}){let i={};this.idempotencyHeader&&n!=="get"&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),i[this.idempotencyHeader]=e.idempotencyKey);const a=ce([i,{Accept:"application/json","User-Agent":this.getUserAgent(),"X-Stainless-Retry-Count":String(s),...e.timeout?{"X-Stainless-Timeout":String(Math.trunc(e.timeout/1e3))}:{},...KM(),"OpenAI-Organization":this.organization,"OpenAI-Project":this.project},await this.authHeaders(e),this._options.defaultHeaders,r,e.headers]);return this.validateHeaders(a),a.values}buildBody({options:{body:e,headers:n}}){if(!e)return{bodyHeaders:void 0,body:void 0};const r=ce([n]);return ArrayBuffer.isView(e)||e instanceof ArrayBuffer||e instanceof DataView||typeof e=="string"&&r.values.has("content-type")||globalThis.Blob&&e instanceof globalThis.Blob||e instanceof FormData||e instanceof URLSearchParams||globalThis.ReadableStream&&e instanceof globalThis.ReadableStream?{bodyHeaders:void 0,body:e}:typeof e=="object"&&(Symbol.asyncIterator in e||Symbol.iterator in e&&"next"in e&&typeof e.next=="function")?{bodyHeaders:void 0,body:B0(e)}:L(this,ml,"f").call(this,{body:e,headers:r})}}Mm=De,ml=new WeakMap,Pf=new WeakSet,iT=function(){return this.baseURL!=="https://api.openai.com/v1"};De.OpenAI=Mm;De.DEFAULT_TIMEOUT=6e5;De.OpenAIError=be;De.APIError=tn;De.APIConnectionError=Hu;De.APIConnectionTimeoutError=qu;De.APIUserAbortError=Vn;De.NotFoundError=R0;De.ConflictError=N0;De.RateLimitError=M0;De.BadRequestError=C0;De.AuthenticationError=O0;De.InternalServerError=L0;De.PermissionDeniedError=$0;De.UnprocessableEntityError=P0;De.InvalidWebhookSignatureError=Ga;De.toFile=wL;De.Completions=PE;De.Chat=Em;De.Embeddings=jE;De.Files=UE;De.Images=GE;De.Audio=dc;De.Moderations=HE;De.Models=WE;De.FineTuning=Ma;De.Graders=Rm;De.VectorStores=rd;De.Webhooks=sT;De.Beta=Pa;De.Batches=kE;De.Uploads=Pm;De.Responses=nd;De.Realtime=td;De.Conversations=km;De.Evals=Am;De.Containers=xm;De.Videos=nT;function Lm(t){if(!t||typeof t!="object")return t;let e;return t.constructor.name===qu.name&&"message"in t&&typeof t.message=="string"?(e=new Error(t.message),e.name="TimeoutError"):t.constructor.name===Vn.name&&"message"in t&&typeof t.message=="string"?(e=new Error(t.message),e.name="AbortError"):"status"in t&&t.status===400&&"message"in t&&typeof t.message=="string"&&t.message.includes("tool_calls")?e=Uc(t,"INVALID_TOOL_RESULTS"):"status"in t&&t.status===401?e=Uc(t,"MODEL_AUTHENTICATION"):"status"in t&&t.status===429?e=Uc(t,"MODEL_RATE_LIMIT"):"status"in t&&t.status===404?e=Uc(t,"MODEL_NOT_FOUND"):e=t,e}const Ti=t=>t();function hc(t){return t?!!(/^o\d/.test(t??"")||t.startsWith("gpt-5")&&!t.startsWith("gpt-5-chat")):!1}function WL(t){return t.role!=="system"&&t.role!=="developer"&&t.role!=="assistant"&&t.role!=="user"&&t.role!=="function"&&t.role!=="tool"&&console.warn(`Unknown message role: ${t.role}`),t.role}function lu(t){var n,r,s;const e=((n=t.metadata)==null?void 0:n.filename)??((r=t.metadata)==null?void 0:r.name)??((s=t.metadata)==null?void 0:s.title);if(!e)throw new Error("a filename or name or title is needed via meta-data for OpenAI when working with multimodal blocks");return e}function fc(t){const e=t._getType();switch(e){case"system":return"system";case"ai":return"assistant";case"human":return"user";case"function":return"function";case"tool":return"tool";case"generic":if(!vs.isInstance(t))throw new Error("Invalid generic chat message");return WL(t);default:throw new Error(`Unknown message type: ${e}`)}}function HL(t){return t.includes("gpt-5.2-pro")}function qL(t){const{azureOpenAIApiDeploymentName:e,azureOpenAIApiInstanceName:n,azureOpenAIApiKey:r,azureOpenAIBasePath:s,baseURL:i,azureADTokenProvider:a,azureOpenAIEndpoint:o}=t;if((r||a)&&s&&e)return`${s}/${e}`;if((r||a)&&o&&e)return`${o}/openai/deployments/${e}`;if(r||a){if(!n)throw new Error("azureOpenAIApiInstanceName is required when using azureOpenAIApiKey");if(!e)throw new Error("azureOpenAIApiDeploymentName is a required parameter when using azureOpenAIApiKey");return`https://${n}.openai.azure.com/openai/deployments/${e}`}return i}function P_(t){return typeof Headers<"u"&&t!==null&&typeof t=="object"&&Object.prototype.toString.call(t)==="[object Headers]"}function JL(t){const e=Ti(()=>{if(P_(t))return t;if(Array.isArray(t))return new Headers(t);if(typeof t=="object"&&t!==null&&"values"in t&&P_(t.values))return t.values;if(typeof t=="object"&&t!==null){const n=Object.entries(t).filter(([,r])=>typeof r=="string").map(([r,s])=>[r,s]);return new Headers(n)}return new Headers});return Object.fromEntries(e.entries())}function KL(){let t=Lp();return(t==="node"||t==="deno")&&(t=`(${t}/${Gn.version}; ${Gn.platform}; ${Gn.arch})`),t}function XL(t,e=!1,n="1.0.0"){const r=JL(t),s=KL(),i=`langchainjs${e?"-azure":""}-openai`;return{...r,"User-Agent":r["User-Agent"]?`${i}/${n} (${s})${r["User-Agent"]}`:`${i}/${n} (${s})`}}function jm(t){return t!==void 0&&Array.isArray(t.lc_namespace)}function Dm(t){return t!==void 0&&Fe.isRunnable(t)&&"lc_name"in t.constructor&&typeof t.constructor.lc_name=="function"&&t.constructor.lc_name()==="RunnableToolLike"}function Um(t){return!!t&&typeof t=="object"&&"name"in t&&"schema"in t&&(ar(t.schema)||t.schema!=null&&typeof t.schema=="object"&&"type"in t.schema&&typeof t.schema.type=="string"&&["null","boolean","object","array","number","string"].includes(t.schema.type))}function sd(t){return Um(t)||Dm(t)||jm(t)}var aT={};Se(aT,{convertToOpenAIFunction:()=>oT,convertToOpenAITool:()=>cT,isLangChainTool:()=>sd,isRunnableToolLike:()=>Dm,isStructuredTool:()=>jm,isStructuredToolParams:()=>Um});function oT(t,e){const n=typeof e=="number"?void 0:e;return{name:t.name,description:t.description,parameters:bt(t.schema),...(n==null?void 0:n.strict)!==void 0?{strict:n.strict}:{}}}function cT(t,e){const n=typeof e=="number"?void 0:e;let r;return sd(t)?r={type:"function",function:oT(t)}:r=t,(n==null?void 0:n.strict)!==void 0&&(r.function.strict=n.strict),r}var lT={};Se(lT,{extendInteropZodObject:()=>Yb,getInteropZodDefaultGetter:()=>Wu,getInteropZodObjectShape:()=>ya,getSchemaDescription:()=>ki,interopParse:()=>cs,interopParseAsync:()=>Zu,interopSafeParse:()=>Jb,interopSafeParseAsync:()=>sm,interopZodObjectMakeFieldsOptional:()=>e0,interopZodObjectPartial:()=>Gu,interopZodObjectPassthrough:()=>rf,interopZodObjectStrict:()=>Wl,interopZodTransformInputSchema:()=>Qb,isInteropZodError:()=>t0,isInteropZodLiteral:()=>$N,isInteropZodObject:()=>In,isInteropZodSchema:()=>ar,isShapelessZodSchema:()=>RN,isSimpleStringZodSchema:()=>im,isZodArrayV4:()=>Vu,isZodLiteralV3:()=>Hb,isZodLiteralV4:()=>qb,isZodNullableV4:()=>Xb,isZodObjectV3:()=>am,isZodObjectV4:()=>Vr,isZodOptionalV4:()=>Kb,isZodSchema:()=>ON,isZodSchemaV3:()=>Ct,isZodSchemaV4:()=>it});function YL(t,e){let n;return sd(t)?n=cT(t):n=t,(e==null?void 0:e.strict)!==void 0&&(n.function.strict=e.strict),n}function QL(t){return t.anyOf!==void 0&&Array.isArray(t.anyOf)}function e2(t){const e=["namespace functions {",""];for(const n of t)n.description&&e.push(`// ${n.description}`),Object.keys(n.parameters.properties??{}).length>0?(e.push(`type ${n.name} = (_: {`),e.push(uT(n.parameters,0)),e.push("}) => any;")):e.push(`type ${n.name} = () => any;`),e.push("");return e.push("} // namespace functions"),e.join(`
`)}function uT(t,e){var r;const n=[];for(const[s,i]of Object.entries(t.properties??{}))i.description&&e<2&&n.push(`// ${i.description}`),(r=t.required)!=null&&r.includes(s)?n.push(`${s}: ${uu(i,e)},`):n.push(`${s}?: ${uu(i,e)},`);return n.map(s=>" ".repeat(e)+s).join(`
`)}function uu(t,e){if(QL(t))return t.anyOf.map(n=>uu(n,e)).join(" | ");switch(t.type){case"string":return t.enum?t.enum.map(n=>`"${n}"`).join(" | "):"string";case"number":return t.enum?t.enum.map(n=>`${n}`).join(" | "):"number";case"integer":return t.enum?t.enum.map(n=>`${n}`).join(" | "):"number";case"boolean":return"boolean";case"null":return"null";case"object":return["{",uT(t,e+2),"}"].join(`
`);case"array":return t.items?`${uu(t.items,e)}[]`:"any[]";default:return""}}function dT(t){if(t)return t==="any"||t==="required"?"required":t==="auto"?"auto":t==="none"?"none":typeof t=="string"?{type:"function",function:{name:t}}:t}function Fm(t){return"type"in t&&t.type!=="function"}function t2(t){return typeof t=="object"&&t!==null&&"extras"in t&&typeof t.extras=="object"&&t.extras!==null&&"providerToolDefinition"in t.extras&&typeof t.extras.providerToolDefinition=="object"&&t.extras.providerToolDefinition!==null}function n2(t){return t!=null&&typeof t=="object"&&"type"in t&&t.type!=="function"}function du(t){return typeof t=="object"&&t!==null&&"metadata"in t&&typeof t.metadata=="object"&&t.metadata!==null&&"customTool"in t.metadata&&typeof t.metadata.customTool=="object"&&t.metadata.customTool!==null}function hT(t){return"type"in t&&t.type==="custom"&&"custom"in t&&typeof t.custom=="object"&&t.custom!==null}function r2(t){if(t.type==="custom_tool_call")return{...t,type:"tool_call",call_id:t.id,id:t.call_id,name:t.name,isCustomTool:!0,args:{input:t.input}}}function s2(t){if(t.type==="computer_call")return{...t,type:"tool_call",call_id:t.id,id:t.call_id,name:"computer_use",isComputerTool:!0,args:{action:t.action}}}function i2(t){return typeof t=="object"&&t!==null&&"type"in t&&t.type==="tool_call"&&"isComputerTool"in t&&t.isComputerTool===!0}function a2(t){return typeof t=="object"&&t!==null&&"type"in t&&t.type==="tool_call"&&"isCustomTool"in t&&t.isCustomTool===!0}function o2(t){const e=()=>{if(t.custom.format){if(t.custom.format.type==="grammar")return{type:"grammar",definition:t.custom.format.grammar.definition,syntax:t.custom.format.grammar.syntax};if(t.custom.format.type==="text")return{type:"text"}}};return{type:"custom",name:t.custom.name,description:t.custom.description,format:e()}}function c2(t){const e=()=>{if(t.format){if(t.format.type==="grammar")return{type:"grammar",grammar:{definition:t.format.definition,syntax:t.format.syntax}};if(t.format.type==="text")return{type:"text"}}};return{type:"custom",custom:{name:t.name,description:t.description,format:e()}}}const l2=z("ZodISODateTime",(t,e)=>{uR.init(t,e),gt.init(t,e)});function u2(t){return dN(l2,t)}const d2=z("ZodISODate",(t,e)=>{dR.init(t,e),gt.init(t,e)});function h2(t){return hN(d2,t)}const f2=z("ZodISOTime",(t,e)=>{hR.init(t,e),gt.init(t,e)});function p2(t){return fN(f2,t)}const m2=z("ZodISODuration",(t,e)=>{fR.init(t,e),gt.init(t,e)});function g2(t){return pN(m2,t)}const y2=(t,e)=>{kb.init(t,e),t.name="ZodError",Object.defineProperties(t,{format:{value:n=>l$(t,n)},flatten:{value:n=>c$(t,n)},addIssue:{value:n=>t.issues.push(n)},addIssues:{value:n=>t.issues.push(...n)},isEmpty:{get(){return t.issues.length===0}}})},id=z("ZodError",y2,{Parent:Error}),_2=Ib(id),w2=Ab(id),v2=Ob(id),b2=$b(id),Tt=z("ZodType",(t,e)=>(ft.init(t,e),t.def=e,Object.defineProperty(t,"_def",{value:e}),t.check=(...n)=>t.clone({...e,checks:[...e.checks??[],...n.map(r=>typeof r=="function"?{_zod:{check:r,def:{check:"custom"},onattach:[]}}:r)]}),t.clone=(n,r)=>on(t,n,r),t.brand=()=>t,t.register=(n,r)=>(n.add(t,r),t),t.parse=(n,r)=>_2(t,n,r,{callee:t.parse}),t.safeParse=(n,r)=>v2(t,n,r),t.parseAsync=async(n,r)=>w2(t,n,r,{callee:t.parseAsync}),t.safeParseAsync=async(n,r)=>b2(t,n,r),t.spa=t.safeParseAsync,t.refine=(n,r)=>t.check(mj(n,r)),t.superRefine=n=>t.check(gj(n)),t.overwrite=n=>t.check(ac(n)),t.optional=()=>D_(t),t.nullable=()=>U_(t),t.nullish=()=>D_(U_(t)),t.nonoptional=n=>oj(t,n),t.array=()=>pc(t),t.or=n=>H2([t,n]),t.and=n=>K2(t,n),t.transform=n=>F_(t,tj(n)),t.default=n=>sj(t,n),t.prefault=n=>aj(t,n),t.catch=n=>lj(t,n),t.pipe=n=>F_(t,n),t.readonly=()=>hj(t),t.describe=n=>{const r=t.clone();return Wt.add(r,{description:n}),r},Object.defineProperty(t,"description",{get(){var n;return(n=Wt.get(t))==null?void 0:n.description},configurable:!0}),t.meta=(...n)=>{if(n.length===0)return Wt.get(t);const r=t.clone();return Wt.add(r,n[0]),r},t.isOptional=()=>t.safeParse(void 0).success,t.isNullable=()=>t.safeParse(null).success,t)),fT=z("_ZodString",(t,e)=>{tm.init(t,e),Tt.init(t,e);const n=t._zod.bag;t.format=n.format??null,t.minLength=n.minimum??null,t.maxLength=n.maximum??null,t.regex=(...r)=>t.check(_N(...r)),t.includes=(...r)=>t.check(bN(...r)),t.startsWith=(...r)=>t.check(EN(...r)),t.endsWith=(...r)=>t.check(TN(...r)),t.min=(...r)=>t.check(Gl(...r)),t.max=(...r)=>t.check(Gb(...r)),t.length=(...r)=>t.check(Wb(...r)),t.nonempty=(...r)=>t.check(Gl(1,...r)),t.lowercase=r=>t.check(wN(r)),t.uppercase=r=>t.check(vN(r)),t.trim=()=>t.check(xN()),t.normalize=(...r)=>t.check(SN(...r)),t.toLowerCase=()=>t.check(kN()),t.toUpperCase=()=>t.check(IN())}),E2=z("ZodString",(t,e)=>{tm.init(t,e),fT.init(t,e),t.email=n=>t.check(VR(T2,n)),t.url=n=>t.check(JR(S2,n)),t.jwt=n=>t.check(uN(U2,n)),t.emoji=n=>t.check(KR(x2,n)),t.guid=n=>t.check(Ry(M_,n)),t.uuid=n=>t.check(GR(Hc,n)),t.uuidv4=n=>t.check(WR(Hc,n)),t.uuidv6=n=>t.check(HR(Hc,n)),t.uuidv7=n=>t.check(qR(Hc,n)),t.nanoid=n=>t.check(XR(k2,n)),t.guid=n=>t.check(Ry(M_,n)),t.cuid=n=>t.check(YR(I2,n)),t.cuid2=n=>t.check(QR(A2,n)),t.ulid=n=>t.check(eN(C2,n)),t.base64=n=>t.check(oN(L2,n)),t.base64url=n=>t.check(cN(j2,n)),t.xid=n=>t.check(tN(O2,n)),t.ksuid=n=>t.check(nN($2,n)),t.ipv4=n=>t.check(rN(R2,n)),t.ipv6=n=>t.check(sN(N2,n)),t.cidrv4=n=>t.check(iN(P2,n)),t.cidrv6=n=>t.check(aN(M2,n)),t.e164=n=>t.check(lN(D2,n)),t.datetime=n=>t.check(u2(n)),t.date=n=>t.check(h2(n)),t.time=n=>t.check(p2(n)),t.duration=n=>t.check(g2(n))});function zn(t){return ZR(E2,t)}const gt=z("ZodStringFormat",(t,e)=>{pt.init(t,e),fT.init(t,e)}),T2=z("ZodEmail",(t,e)=>{tR.init(t,e),gt.init(t,e)}),M_=z("ZodGUID",(t,e)=>{Q$.init(t,e),gt.init(t,e)}),Hc=z("ZodUUID",(t,e)=>{eR.init(t,e),gt.init(t,e)}),S2=z("ZodURL",(t,e)=>{nR.init(t,e),gt.init(t,e)}),x2=z("ZodEmoji",(t,e)=>{rR.init(t,e),gt.init(t,e)}),k2=z("ZodNanoID",(t,e)=>{sR.init(t,e),gt.init(t,e)}),I2=z("ZodCUID",(t,e)=>{iR.init(t,e),gt.init(t,e)}),A2=z("ZodCUID2",(t,e)=>{aR.init(t,e),gt.init(t,e)}),C2=z("ZodULID",(t,e)=>{oR.init(t,e),gt.init(t,e)}),O2=z("ZodXID",(t,e)=>{cR.init(t,e),gt.init(t,e)}),$2=z("ZodKSUID",(t,e)=>{lR.init(t,e),gt.init(t,e)}),R2=z("ZodIPv4",(t,e)=>{pR.init(t,e),gt.init(t,e)}),N2=z("ZodIPv6",(t,e)=>{mR.init(t,e),gt.init(t,e)}),P2=z("ZodCIDRv4",(t,e)=>{gR.init(t,e),gt.init(t,e)}),M2=z("ZodCIDRv6",(t,e)=>{yR.init(t,e),gt.init(t,e)}),L2=z("ZodBase64",(t,e)=>{_R.init(t,e),gt.init(t,e)}),j2=z("ZodBase64URL",(t,e)=>{vR.init(t,e),gt.init(t,e)}),D2=z("ZodE164",(t,e)=>{bR.init(t,e),gt.init(t,e)}),U2=z("ZodJWT",(t,e)=>{TR.init(t,e),gt.init(t,e)}),pT=z("ZodNumber",(t,e)=>{Ub.init(t,e),Tt.init(t,e),t.gt=(r,s)=>t.check(Py(r,s)),t.gte=(r,s)=>t.check(Jd(r,s)),t.min=(r,s)=>t.check(Jd(r,s)),t.lt=(r,s)=>t.check(Ny(r,s)),t.lte=(r,s)=>t.check(qd(r,s)),t.max=(r,s)=>t.check(qd(r,s)),t.int=r=>t.check(L_(r)),t.safe=r=>t.check(L_(r)),t.positive=r=>t.check(Py(0,r)),t.nonnegative=r=>t.check(Jd(0,r)),t.negative=r=>t.check(Ny(0,r)),t.nonpositive=r=>t.check(qd(0,r)),t.multipleOf=(r,s)=>t.check(My(r,s)),t.step=(r,s)=>t.check(My(r,s)),t.finite=()=>t;const n=t._zod.bag;t.minValue=Math.max(n.minimum??Number.NEGATIVE_INFINITY,n.exclusiveMinimum??Number.NEGATIVE_INFINITY)??null,t.maxValue=Math.min(n.maximum??Number.POSITIVE_INFINITY,n.exclusiveMaximum??Number.POSITIVE_INFINITY)??null,t.isInt=(n.format??"").includes("int")||Number.isSafeInteger(n.multipleOf??.5),t.isFinite=!0,t.format=n.format??null});function ln(t){return mN(pT,t)}const F2=z("ZodNumberFormat",(t,e)=>{SR.init(t,e),pT.init(t,e)});function L_(t){return gN(F2,t)}const B2=z("ZodAny",(t,e)=>{xR.init(t,e),Tt.init(t,e)});function qc(){return yN(B2)}const z2=z("ZodUnknown",(t,e)=>{Fb.init(t,e),Tt.init(t,e)});function j_(){return Zb(z2)}const Z2=z("ZodNever",(t,e)=>{Bb.init(t,e),Tt.init(t,e)});function V2(t){return Vb(Z2,t)}const G2=z("ZodArray",(t,e)=>{kR.init(t,e),Tt.init(t,e),t.element=e.element,t.min=(n,r)=>t.check(Gl(n,r)),t.nonempty=n=>t.check(Gl(1,n)),t.max=(n,r)=>t.check(Gb(n,r)),t.length=(n,r)=>t.check(Wb(n,r)),t.unwrap=()=>t.element});function pc(t,e){return AN(G2,t,e)}const W2=z("ZodObject",(t,e)=>{IR.init(t,e),Tt.init(t,e),ct(t,"shape",()=>e.shape),t.keyof=()=>zm(Object.keys(t._zod.def.shape)),t.catchall=n=>t.clone({...t._zod.def,catchall:n}),t.passthrough=()=>t.clone({...t._zod.def,catchall:j_()}),t.loose=()=>t.clone({...t._zod.def,catchall:j_()}),t.strict=()=>t.clone({...t._zod.def,catchall:V2()}),t.strip=()=>t.clone({...t._zod.def,catchall:void 0}),t.extend=n=>Tb(t,n),t.merge=n=>a$(t,n),t.pick=n=>s$(t,n),t.omit=n=>i$(t,n),t.partial=(...n)=>Sb(gT,t,n[0]),t.required=(...n)=>o$(yT,t,n[0])});function fn(t,e){const n={type:"object",get shape(){return Qp(this,"shape",{...t}),this.shape},...Te(e)};return new W2(n)}const mT=z("ZodUnion",(t,e)=>{zb.init(t,e),Tt.init(t,e),t.options=e.options});function H2(t,e){return new mT({type:"union",options:t,...Te(e)})}const q2=z("ZodDiscriminatedUnion",(t,e)=>{mT.init(t,e),AR.init(t,e)});function Bm(t,e,n){return new q2({type:"union",options:e,discriminator:t,...Te(n)})}const J2=z("ZodIntersection",(t,e)=>{CR.init(t,e),Tt.init(t,e)});function K2(t,e){return new J2({type:"intersection",left:t,right:e})}const X2=z("ZodRecord",(t,e)=>{OR.init(t,e),Tt.init(t,e),t.keyType=e.keyType,t.valueType=e.valueType});function Y2(t,e,n){return new X2({type:"record",keyType:t,valueType:e,...Te(n)})}const Mf=z("ZodEnum",(t,e)=>{$R.init(t,e),Tt.init(t,e),t.enum=e.entries,t.options=Object.values(e.entries);const n=new Set(Object.keys(e.entries));t.extract=(r,s)=>{const i={};for(const a of r)if(n.has(a))i[a]=e.entries[a];else throw new Error(`Key ${a} not found in enum`);return new Mf({...e,checks:[],...Te(s),entries:i})},t.exclude=(r,s)=>{const i={...e.entries};for(const a of r)if(n.has(a))delete i[a];else throw new Error(`Key ${a} not found in enum`);return new Mf({...e,checks:[],...Te(s),entries:i})}});function zm(t,e){const n=Array.isArray(t)?Object.fromEntries(t.map(r=>[r,r])):t;return new Mf({type:"enum",entries:n,...Te(e)})}const Q2=z("ZodLiteral",(t,e)=>{RR.init(t,e),Tt.init(t,e),t.values=new Set(e.values),Object.defineProperty(t,"value",{get(){if(e.values.length>1)throw new Error("This schema contains multiple valid literal values. Use `.values` instead.");return e.values[0]}})});function Yn(t,e){return new Q2({type:"literal",values:Array.isArray(t)?t:[t],...Te(e)})}const ej=z("ZodTransform",(t,e)=>{NR.init(t,e),Tt.init(t,e),t._zod.parse=(n,r)=>{n.addIssue=i=>{if(typeof i=="string")n.issues.push(Ao(i,n.value,e));else{const a=i;a.fatal&&(a.continue=!1),a.code??(a.code="custom"),a.input??(a.input=n.value),a.inst??(a.inst=t),a.continue??(a.continue=!0),n.issues.push(Ao(a))}};const s=e.transform(n.value,n);return s instanceof Promise?s.then(i=>(n.value=i,n)):(n.value=s,n)}});function tj(t){return new ej({type:"transform",transform:t})}const gT=z("ZodOptional",(t,e)=>{nm.init(t,e),Tt.init(t,e),t.unwrap=()=>t._zod.def.innerType});function D_(t){return new gT({type:"optional",innerType:t})}const nj=z("ZodNullable",(t,e)=>{PR.init(t,e),Tt.init(t,e),t.unwrap=()=>t._zod.def.innerType});function U_(t){return new nj({type:"nullable",innerType:t})}const rj=z("ZodDefault",(t,e)=>{MR.init(t,e),Tt.init(t,e),t.unwrap=()=>t._zod.def.innerType,t.removeDefault=t.unwrap});function sj(t,e){return new rj({type:"default",innerType:t,get defaultValue(){return typeof e=="function"?e():e}})}const ij=z("ZodPrefault",(t,e)=>{LR.init(t,e),Tt.init(t,e),t.unwrap=()=>t._zod.def.innerType});function aj(t,e){return new ij({type:"prefault",innerType:t,get defaultValue(){return typeof e=="function"?e():e}})}const yT=z("ZodNonOptional",(t,e)=>{jR.init(t,e),Tt.init(t,e),t.unwrap=()=>t._zod.def.innerType});function oj(t,e){return new yT({type:"nonoptional",innerType:t,...Te(e)})}const cj=z("ZodCatch",(t,e)=>{DR.init(t,e),Tt.init(t,e),t.unwrap=()=>t._zod.def.innerType,t.removeCatch=t.unwrap});function lj(t,e){return new cj({type:"catch",innerType:t,catchValue:typeof e=="function"?e:()=>e})}const uj=z("ZodPipe",(t,e)=>{UR.init(t,e),Tt.init(t,e),t.in=e.in,t.out=e.out});function F_(t,e){return new uj({type:"pipe",in:t,out:e})}const dj=z("ZodReadonly",(t,e)=>{FR.init(t,e),Tt.init(t,e)});function hj(t){return new dj({type:"readonly",innerType:t})}const fj=z("ZodCustom",(t,e)=>{BR.init(t,e),Tt.init(t,e)});function pj(t){const e=new Mn({check:"custom"});return e._zod.check=t,e}function mj(t,e={}){return CN(fj,t,e)}function gj(t){const e=pj(n=>(n.addIssue=r=>{if(typeof r=="string")n.issues.push(Ao(r,n.value,e._zod.def));else{const s=r;s.fatal&&(s.continue=!1),s.code??(s.code="custom"),s.input??(s.input=n.value),s.inst??(s.inst=e),s.continue??(s.continue=!e._zod.def.abort),n.issues.push(Ao(s))}},t(n.value,n)));return e}const yj=Symbol("Let zodToJsonSchema decide on which parser to use"),B_={name:void 0,$refStrategy:"root",effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",nullableStrategy:"from-target",removeAdditionalStrategy:"passthrough",definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref"},_j=t=>typeof t=="string"?{...B_,basePath:["#"],definitions:{},name:t}:{...B_,basePath:["#"],definitions:{},...t},Lf=t=>"_def"in t?t._def:t;function wj(t){if(!t)return!0;for(const e in t)return!1;return!0}const vj=t=>{const e=_j(t),n=e.name!==void 0?[...e.basePath,e.definitionPath,e.name]:e.basePath;return{...e,currentPath:n,propertyPath:void 0,seenRefs:new Set,seen:new Map(Object.entries(e.definitions).map(([r,s])=>[Lf(s),{def:Lf(s),path:[...e.basePath,e.definitionPath,r],jsonSchema:void 0}]))}};function _T(t,e,n,r){r!=null&&r.errorMessages&&n&&(t.errorMessage={...t.errorMessage,[e]:n})}function nt(t,e,n,r,s){t[e]=n,_T(t,e,r,s)}function bj(){return{}}function Ej(t,e){var r,s;const n={type:"array"};return((s=(r=t.type)==null?void 0:r._def)==null?void 0:s.typeName)!==U.ZodAny&&(n.items=Je(t.type._def,{...e,currentPath:[...e.currentPath,"items"]})),t.minLength&&nt(n,"minItems",t.minLength.value,t.minLength.message,e),t.maxLength&&nt(n,"maxItems",t.maxLength.value,t.maxLength.message,e),t.exactLength&&(nt(n,"minItems",t.exactLength.value,t.exactLength.message,e),nt(n,"maxItems",t.exactLength.value,t.exactLength.message,e)),n}function Tj(t,e){const n={type:"integer",format:"int64"};if(!t.checks)return n;for(const r of t.checks)switch(r.kind){case"min":e.target==="jsonSchema7"?r.inclusive?nt(n,"minimum",r.value,r.message,e):nt(n,"exclusiveMinimum",r.value,r.message,e):(r.inclusive||(n.exclusiveMinimum=!0),nt(n,"minimum",r.value,r.message,e));break;case"max":e.target==="jsonSchema7"?r.inclusive?nt(n,"maximum",r.value,r.message,e):nt(n,"exclusiveMaximum",r.value,r.message,e):(r.inclusive||(n.exclusiveMaximum=!0),nt(n,"maximum",r.value,r.message,e));break;case"multipleOf":nt(n,"multipleOf",r.value,r.message,e);break}return n}function Sj(){return{type:"boolean"}}function xj(t,e){return Je(t.type._def,e)}const kj=(t,e)=>Je(t.innerType._def,e);function wT(t,e,n){const r=n??e.dateStrategy;if(Array.isArray(r))return{anyOf:r.map((s,i)=>wT(t,e,s))};switch(r){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":return Ij(t,e)}}const Ij=(t,e)=>{const n={type:"integer",format:"unix-time"};if(e.target==="openApi3")return n;for(const r of t.checks)switch(r.kind){case"min":nt(n,"minimum",r.value,r.message,e);break;case"max":nt(n,"maximum",r.value,r.message,e);break}return n};function Aj(t,e){return{...Je(t.innerType._def,e),default:t.defaultValue()}}function Cj(t,e,n){return e.effectStrategy==="input"?Je(t.schema._def,e,n):{}}function Oj(t){return{type:"string",enum:[...t.values]}}const $j=t=>"type"in t&&t.type==="string"?!1:"allOf"in t;function Rj(t,e){const n=[Je(t.left._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),Je(t.right._def,{...e,currentPath:[...e.currentPath,"allOf","1"]})].filter(i=>!!i);let r=e.target==="jsonSchema2019-09"?{unevaluatedProperties:!1}:void 0;const s=[];return n.forEach(i=>{if($j(i))s.push(...i.allOf),i.unevaluatedProperties===void 0&&(r=void 0);else{let a=i;if("additionalProperties"in i&&i.additionalProperties===!1){const{additionalProperties:o,...c}=i;a=c}else r=void 0;s.push(a)}}),s.length?{allOf:s,...r}:void 0}function Nj(t,e){const n=typeof t.value;return n!=="bigint"&&n!=="number"&&n!=="boolean"&&n!=="string"?{type:Array.isArray(t.value)?"array":"object"}:e.target==="openApi3"?{type:n==="bigint"?"integer":n,enum:[t.value]}:{type:n==="bigint"?"integer":n,const:t.value}}let lh;const ti={cuid:/^[cC][^\s-]{8,}$/,cuid2:/^[0-9a-z]+$/,ulid:/^[0-9A-HJKMNP-TV-Z]{26}$/,email:/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,emoji:()=>(lh===void 0&&(lh=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),lh),base64:/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,nanoid:/^[a-zA-Z0-9_-]{21}$/};function vT(t,e){const n={type:"string"};function r(s){return e.patternStrategy==="escape"?Pj(s):s}if(t.checks)for(const s of t.checks)switch(s.kind){case"min":nt(n,"minLength",typeof n.minLength=="number"?Math.max(n.minLength,s.value):s.value,s.message,e);break;case"max":nt(n,"maxLength",typeof n.maxLength=="number"?Math.min(n.maxLength,s.value):s.value,s.message,e);break;case"email":switch(e.emailStrategy){case"format:email":hr(n,"email",s.message,e);break;case"format:idn-email":hr(n,"idn-email",s.message,e);break;case"pattern:zod":fr(n,ti.email,s.message,e);break}break;case"url":hr(n,"uri",s.message,e);break;case"uuid":hr(n,"uuid",s.message,e);break;case"regex":fr(n,s.regex,s.message,e);break;case"cuid":fr(n,ti.cuid,s.message,e);break;case"cuid2":fr(n,ti.cuid2,s.message,e);break;case"startsWith":fr(n,RegExp(`^${r(s.value)}`),s.message,e);break;case"endsWith":fr(n,RegExp(`${r(s.value)}$`),s.message,e);break;case"datetime":hr(n,"date-time",s.message,e);break;case"date":hr(n,"date",s.message,e);break;case"time":hr(n,"time",s.message,e);break;case"duration":hr(n,"duration",s.message,e);break;case"length":nt(n,"minLength",typeof n.minLength=="number"?Math.max(n.minLength,s.value):s.value,s.message,e),nt(n,"maxLength",typeof n.maxLength=="number"?Math.min(n.maxLength,s.value):s.value,s.message,e);break;case"includes":{fr(n,RegExp(r(s.value)),s.message,e);break}case"ip":{s.version!=="v6"&&hr(n,"ipv4",s.message,e),s.version!=="v4"&&hr(n,"ipv6",s.message,e);break}case"emoji":fr(n,ti.emoji,s.message,e);break;case"ulid":{fr(n,ti.ulid,s.message,e);break}case"base64":{switch(e.base64Strategy){case"format:binary":{hr(n,"binary",s.message,e);break}case"contentEncoding:base64":{nt(n,"contentEncoding","base64",s.message,e);break}case"pattern:zod":{fr(n,ti.base64,s.message,e);break}}break}case"nanoid":fr(n,ti.nanoid,s.message,e)}return n}const Pj=t=>Array.from(t).map(e=>/[a-zA-Z0-9]/.test(e)?e:`\\${e}`).join(""),hr=(t,e,n,r)=>{var s;t.format||(s=t.anyOf)!=null&&s.some(i=>i.format)?(t.anyOf||(t.anyOf=[]),t.format&&(t.anyOf.push({format:t.format,...t.errorMessage&&r.errorMessages&&{errorMessage:{format:t.errorMessage.format}}}),delete t.format,t.errorMessage&&(delete t.errorMessage.format,Object.keys(t.errorMessage).length===0&&delete t.errorMessage)),t.anyOf.push({format:e,...n&&r.errorMessages&&{errorMessage:{format:n}}})):nt(t,"format",e,n,r)},fr=(t,e,n,r)=>{var s;t.pattern||(s=t.allOf)!=null&&s.some(i=>i.pattern)?(t.allOf||(t.allOf=[]),t.pattern&&(t.allOf.push({pattern:t.pattern,...t.errorMessage&&r.errorMessages&&{errorMessage:{pattern:t.errorMessage.pattern}}}),delete t.pattern,t.errorMessage&&(delete t.errorMessage.pattern,Object.keys(t.errorMessage).length===0&&delete t.errorMessage)),t.allOf.push({pattern:z_(e,r),...n&&r.errorMessages&&{errorMessage:{pattern:n}}})):nt(t,"pattern",z_(e,r),n,r)},z_=(t,e)=>{var l;const n=typeof t=="function"?t():t;if(!e.applyRegexFlags||!n.flags)return n.source;const r={i:n.flags.includes("i"),m:n.flags.includes("m"),s:n.flags.includes("s")},s=r.i?n.source.toLowerCase():n.source;let i="",a=!1,o=!1,c=!1;for(let u=0;u<s.length;u++){if(a){i+=s[u],a=!1;continue}if(r.i){if(o){if(s[u].match(/[a-z]/)){c?(i+=s[u],i+=`${s[u-2]}-${s[u]}`.toUpperCase(),c=!1):s[u+1]==="-"&&((l=s[u+2])!=null&&l.match(/[a-z]/))?(i+=s[u],c=!0):i+=`${s[u]}${s[u].toUpperCase()}`;continue}}else if(s[u].match(/[a-z]/)){i+=`[${s[u]}${s[u].toUpperCase()}]`;continue}}if(r.m){if(s[u]==="^"){i+=`(^|(?<=[\r
]))`;continue}else if(s[u]==="$"){i+=`($|(?=[\r
]))`;continue}}if(r.s&&s[u]==="."){i+=o?`${s[u]}\r
`:`[${s[u]}\r
]`;continue}i+=s[u],s[u]==="\\"?a=!0:o&&s[u]==="]"?o=!1:!o&&s[u]==="["&&(o=!0)}try{const u=new RegExp(i)}catch{return console.warn(`Could not convert regex pattern at ${e.currentPath.join("/")} to a flag-independent form! Falling back to the flag-ignorant source`),n.source}return i};function bT(t,e){var r,s,i,a;if(e.target==="openApi3"&&((r=t.keyType)==null?void 0:r._def.typeName)===U.ZodEnum)return{type:"object",required:t.keyType._def.values,properties:t.keyType._def.values.reduce((o,c)=>({...o,[c]:Je(t.valueType._def,{...e,currentPath:[...e.currentPath,"properties",c]})??{}}),{}),additionalProperties:!1};const n={type:"object",additionalProperties:Je(t.valueType._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??{}};if(e.target==="openApi3")return n;if(((s=t.keyType)==null?void 0:s._def.typeName)===U.ZodString&&((i=t.keyType._def.checks)!=null&&i.length)){const o=Object.entries(vT(t.keyType._def,e)).reduce((c,[l,u])=>l==="type"?c:{...c,[l]:u},{});return{...n,propertyNames:o}}else if(((a=t.keyType)==null?void 0:a._def.typeName)===U.ZodEnum)return{...n,propertyNames:{enum:t.keyType._def.values}};return n}function Mj(t,e){if(e.mapStrategy==="record")return bT(t,e);const n=Je(t.keyType._def,{...e,currentPath:[...e.currentPath,"items","items","0"]})||{},r=Je(t.valueType._def,{...e,currentPath:[...e.currentPath,"items","items","1"]})||{};return{type:"array",maxItems:125,items:{type:"array",items:[n,r],minItems:2,maxItems:2}}}function Lj(t){const e=t.values,r=Object.keys(t.values).filter(i=>typeof e[e[i]]!="number").map(i=>e[i]),s=Array.from(new Set(r.map(i=>typeof i)));return{type:s.length===1?s[0]==="string"?"string":"number":["string","number"],enum:r}}function jj(){return{not:{}}}function Dj(t){return t.target==="openApi3"?{enum:["null"],nullable:!0}:{type:"null"}}const hu={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"};function Uj(t,e){if(e.target==="openApi3")return Z_(t,e);const n=t.options instanceof Map?Array.from(t.options.values()):t.options;if(n.every(r=>r._def.typeName in hu&&(!r._def.checks||!r._def.checks.length))){const r=n.reduce((s,i)=>{const a=hu[i._def.typeName];return a&&!s.includes(a)?[...s,a]:s},[]);return{type:r.length>1?r:r[0]}}else if(n.every(r=>r._def.typeName==="ZodLiteral"&&!r.description)){const r=n.reduce((s,i)=>{const a=typeof i._def.value;switch(a){case"string":case"number":case"boolean":return[...s,a];case"bigint":return[...s,"integer"];case"object":if(i._def.value===null)return[...s,"null"];case"symbol":case"undefined":case"function":default:return s}},[]);if(r.length===n.length){const s=r.filter((i,a,o)=>o.indexOf(i)===a);return{type:s.length>1?s:s[0],enum:n.reduce((i,a)=>i.includes(a._def.value)?i:[...i,a._def.value],[])}}}else if(n.every(r=>r._def.typeName==="ZodEnum"))return{type:"string",enum:n.reduce((r,s)=>[...r,...s._def.values.filter(i=>!r.includes(i))],[])};return Z_(t,e)}const Z_=(t,e)=>{const n=(t.options instanceof Map?Array.from(t.options.values()):t.options).map((r,s)=>Je(r._def,{...e,currentPath:[...e.currentPath,"anyOf",`${s}`]})).filter(r=>!!r&&(!e.strictUnions||typeof r=="object"&&Object.keys(r).length>0));return n.length?{anyOf:n}:void 0};function Fj(t,e){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(t.innerType._def.typeName)&&(!t.innerType._def.checks||!t.innerType._def.checks.length))return e.target==="openApi3"||e.nullableStrategy==="property"?{type:hu[t.innerType._def.typeName],nullable:!0}:{type:[hu[t.innerType._def.typeName],"null"]};if(e.target==="openApi3"){const r=Je(t.innerType._def,{...e,currentPath:[...e.currentPath]});return r&&"$ref"in r?{allOf:[r],nullable:!0}:r&&{...r,nullable:!0}}const n=Je(t.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","0"]});return n&&{anyOf:[n,{type:"null"}]}}function Bj(t,e){const n={type:"number"};if(!t.checks)return n;for(const r of t.checks)switch(r.kind){case"int":n.type="integer",_T(n,"type",r.message,e);break;case"min":e.target==="jsonSchema7"?r.inclusive?nt(n,"minimum",r.value,r.message,e):nt(n,"exclusiveMinimum",r.value,r.message,e):(r.inclusive||(n.exclusiveMinimum=!0),nt(n,"minimum",r.value,r.message,e));break;case"max":e.target==="jsonSchema7"?r.inclusive?nt(n,"maximum",r.value,r.message,e):nt(n,"exclusiveMaximum",r.value,r.message,e):(r.inclusive||(n.exclusiveMaximum=!0),nt(n,"maximum",r.value,r.message,e));break;case"multipleOf":nt(n,"multipleOf",r.value,r.message,e);break}return n}function zj(t,e){return e.removeAdditionalStrategy==="strict"?t.catchall._def.typeName==="ZodNever"?t.unknownKeys!=="strict":Je(t.catchall._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??!0:t.catchall._def.typeName==="ZodNever"?t.unknownKeys==="passthrough":Je(t.catchall._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??!0}function Zj(t,e){const n={type:"object",...Object.entries(t.shape()).reduce((r,[s,i])=>{var c;if(i===void 0||i._def===void 0)return r;const a=[...e.currentPath,"properties",s],o=Je(i._def,{...e,currentPath:a,propertyPath:a});if(o===void 0)return r;if(e.openaiStrictMode&&i.isOptional()&&!i.isNullable()&&typeof((c=i._def)==null?void 0:c.defaultValue)>"u")throw new Error(`Zod field at \`${a.join("/")}\` uses \`.optional()\` without \`.nullable()\` which is not supported by the API. See: https://platform.openai.com/docs/guides/structured-outputs?api-mode=responses#all-fields-must-be-required`);return{properties:{...r.properties,[s]:o},required:i.isOptional()&&!e.openaiStrictMode?r.required:[...r.required,s]}},{properties:{},required:[]}),additionalProperties:zj(t,e)};return n.required.length||delete n.required,n}const Vj=(t,e)=>{if(e.propertyPath&&e.currentPath.slice(0,e.propertyPath.length).toString()===e.propertyPath.toString())return Je(t.innerType._def,{...e,currentPath:e.currentPath});const n=Je(t.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","1"]});return n?{anyOf:[{not:{}},n]}:{}},Gj=(t,e)=>{if(e.pipeStrategy==="input")return Je(t.in._def,e);if(e.pipeStrategy==="output")return Je(t.out._def,e);const n=Je(t.in._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),r=Je(t.out._def,{...e,currentPath:[...e.currentPath,"allOf",n?"1":"0"]});return{allOf:[n,r].filter(s=>s!==void 0)}};function Wj(t,e){return Je(t.type._def,e)}function Hj(t,e){const r={type:"array",uniqueItems:!0,items:Je(t.valueType._def,{...e,currentPath:[...e.currentPath,"items"]})};return t.minSize&&nt(r,"minItems",t.minSize.value,t.minSize.message,e),t.maxSize&&nt(r,"maxItems",t.maxSize.value,t.maxSize.message,e),r}function qj(t,e){return t.rest?{type:"array",minItems:t.items.length,items:t.items.map((n,r)=>Je(n._def,{...e,currentPath:[...e.currentPath,"items",`${r}`]})).reduce((n,r)=>r===void 0?n:[...n,r],[]),additionalItems:Je(t.rest._def,{...e,currentPath:[...e.currentPath,"additionalItems"]})}:{type:"array",minItems:t.items.length,maxItems:t.items.length,items:t.items.map((n,r)=>Je(n._def,{...e,currentPath:[...e.currentPath,"items",`${r}`]})).reduce((n,r)=>r===void 0?n:[...n,r],[])}}function Jj(){return{not:{}}}function Kj(){return{}}const Xj=(t,e)=>Je(t.innerType._def,e);function Je(t,e,n=!1){var a;const r=e.seen.get(t);if(e.override){const o=(a=e.override)==null?void 0:a.call(e,t,e,r,n);if(o!==yj)return o}if(r&&!n){const o=Yj(r,e);if(o!==void 0)return"$ref"in o&&e.seenRefs.add(o.$ref),o}const s={def:t,path:e.currentPath,jsonSchema:void 0};e.seen.set(t,s);const i=eD(t,t.typeName,e,n);return i&&tD(t,e,i),s.jsonSchema=i,i}const Yj=(t,e)=>{switch(e.$refStrategy){case"root":return{$ref:t.path.join("/")};case"extract-to-root":const n=t.path.slice(e.basePath.length+1).join("_");return n!==e.name&&e.nameStrategy==="duplicate-ref"&&(e.definitions[n]=t.def),{$ref:[...e.basePath,e.definitionPath,n].join("/")};case"relative":return{$ref:Qj(e.currentPath,t.path)};case"none":case"seen":return t.path.length<e.currentPath.length&&t.path.every((r,s)=>e.currentPath[s]===r)?(console.warn(`Recursive reference detected at ${e.currentPath.join("/")}! Defaulting to any`),{}):e.$refStrategy==="seen"?{}:void 0}},Qj=(t,e)=>{let n=0;for(;n<t.length&&n<e.length&&t[n]===e[n];n++);return[(t.length-n).toString(),...e.slice(n)].join("/")},eD=(t,e,n,r)=>{switch(e){case U.ZodString:return vT(t,n);case U.ZodNumber:return Bj(t,n);case U.ZodObject:return Zj(t,n);case U.ZodBigInt:return Tj(t,n);case U.ZodBoolean:return Sj();case U.ZodDate:return wT(t,n);case U.ZodUndefined:return Jj();case U.ZodNull:return Dj(n);case U.ZodArray:return Ej(t,n);case U.ZodUnion:case U.ZodDiscriminatedUnion:return Uj(t,n);case U.ZodIntersection:return Rj(t,n);case U.ZodTuple:return qj(t,n);case U.ZodRecord:return bT(t,n);case U.ZodLiteral:return Nj(t,n);case U.ZodEnum:return Oj(t);case U.ZodNativeEnum:return Lj(t);case U.ZodNullable:return Fj(t,n);case U.ZodOptional:return Vj(t,n);case U.ZodMap:return Mj(t,n);case U.ZodSet:return Hj(t,n);case U.ZodLazy:return Je(t.getter()._def,n);case U.ZodPromise:return Wj(t,n);case U.ZodNaN:case U.ZodNever:return jj();case U.ZodEffects:return Cj(t,n,r);case U.ZodAny:return bj();case U.ZodUnknown:return Kj();case U.ZodDefault:return Aj(t,n);case U.ZodBranded:return xj(t,n);case U.ZodReadonly:return Xj(t,n);case U.ZodCatch:return kj(t,n);case U.ZodPipeline:return Gj(t,n);case U.ZodFunction:case U.ZodVoid:case U.ZodSymbol:return;default:return(s=>{})()}},tD=(t,e,n)=>(t.description&&(n.description=t.description,e.markdownDescription&&(n.markdownDescription=t.description)),n),nD=(t,e)=>{const n=vj(e),r=typeof e=="string"?e:(e==null?void 0:e.nameStrategy)==="title"||e==null?void 0:e.name,s=Je(t._def,r===void 0?n:{...n,currentPath:[...n.basePath,n.definitionPath,r]},!1)??{},i=typeof e=="object"&&e.name!==void 0&&e.nameStrategy==="title"?e.name:void 0;i!==void 0&&(s.title=i);const a=(()=>{if(wj(n.definitions))return;const c={},l=new Set;for(let u=0;u<500;u++){const d=Object.entries(n.definitions).filter(([h])=>!l.has(h));if(d.length===0)break;for(const[h,f]of d)c[h]=Je(Lf(f),{...n,currentPath:[...n.basePath,n.definitionPath,h]},!0)??{},l.add(h)}return c})(),o=r===void 0?a?{...s,[n.definitionPath]:a}:s:n.nameStrategy==="duplicate-ref"?{...s,...a||n.seenRefs.size?{[n.definitionPath]:{...a,...n.seenRefs.size?{[r]:s}:void 0}}:void 0}:{$ref:[...n.$refStrategy==="relative"?[]:n.basePath,n.definitionPath,r].join("/"),[n.definitionPath]:{...a,[r]:s}};return n.target==="jsonSchema7"?o.$schema="http://json-schema.org/draft-07/schema#":n.target==="jsonSchema2019-09"&&(o.$schema="https://json-schema.org/draft/2019-09/schema#"),o};function rD(t){if(t.type!=="object")throw new Error(`Root schema must have type: 'object' but got type: ${t.type?`'${t.type}'`:"undefined"}`);const e=structuredClone(t);return es(e,[],e)}function jf(t){if(typeof t=="boolean")return!1;if(t.type==="null")return!0;for(const e of t.oneOf??[])if(jf(e))return!0;for(const e of t.anyOf??[])if(jf(e))return!0;return!1}function es(t,e,n){if(typeof t=="boolean")throw new TypeError(`Expected object schema but got boolean; path=${e.join("/")}`);if(!ii(t))throw new TypeError(`Expected ${JSON.stringify(t)} to be an object; path=${e.join("/")}`);const r=t.$defs;if(ii(r))for(const[h,f]of Object.entries(r))es(f,[...e,"$defs",h],n);const s=t.definitions;if(ii(s))for(const[h,f]of Object.entries(s))es(f,[...e,"definitions",h],n);t.type==="object"&&!("additionalProperties"in t)&&(t.additionalProperties=!1);const a=t.required??[],o=t.properties;if(ii(o)){for(const[h,f]of Object.entries(o))if(!jf(f)&&!a.includes(h))throw new Error(`Zod field at \`${[...e,"properties",h].join("/")}\` uses \`.optional()\` without \`.nullable()\` which is not supported by the API. See: https://platform.openai.com/docs/guides/structured-outputs?api-mode=responses#all-fields-must-be-required`);t.required=Object.keys(o),t.properties=Object.fromEntries(Object.entries(o).map(([h,f])=>[h,es(f,[...e,"properties",h],n)]))}const c=t.items;ii(c)&&(t.items=es(c,[...e,"items"],n));const l=t.anyOf;Array.isArray(l)&&(t.anyOf=l.map((h,f)=>es(h,[...e,"anyOf",String(f)],n)));const u=t.allOf;if(Array.isArray(u))if(u.length===1){const h=es(u[0],[...e,"allOf","0"],n);Object.assign(t,h),delete t.allOf}else t.allOf=u.map((h,f)=>es(h,[...e,"allOf",String(f)],n));t.default===null&&delete t.default;const d=t.$ref;if(d&&iD(t,1)){if(typeof d!="string")throw new TypeError(`Received non-string $ref - ${d}; path=${e.join("/")}`);const h=sD(n,d);if(typeof h=="boolean")throw new Error(`Expected \`$ref: ${d}\` to resolve to an object schema but got boolean`);if(!ii(h))throw new Error(`Expected \`$ref: ${d}\` to resolve to an object but got ${JSON.stringify(h)}`);return Object.assign(t,{...h,...t}),delete t.$ref,es(t,e,n)}return t}function sD(t,e){if(!e.startsWith("#/"))throw new Error(`Unexpected $ref format ${JSON.stringify(e)}; Does not start with #/`);const n=e.slice(2).split("/");let r=t;for(const s of n){if(!ii(r))throw new Error(`encountered non-object entry while resolving ${e} - ${JSON.stringify(r)}`);const i=r[s];if(i===void 0)throw new Error(`Key ${s} not found while resolving ${e}`);r=i}return r}function ii(t){return typeof t=="object"&&t!==null&&!Array.isArray(t)}function iD(t,e){let n=0;for(const r in t)if(n++,n>e)return!0;return!1}function aD(t,e){return nD(t,{openaiStrictMode:!0,name:e.name,nameStrategy:"duplicate-ref",$refStrategy:"extract-to-root",nullableStrategy:"property"})}function oD(t){return rD(nf(t,{target:"draft-7"}))}function cD(t){return"_zod"in t}function lD(t,e,n){return EL({type:"json_schema",json_schema:{...n,name:e,strict:!0,schema:cD(t)?oD(t):aD(t,{name:e})}},r=>t.parse(JSON.parse(r)))}const V_=["jsonSchema","functionCalling","jsonMode"];function uD(t,e){if(typeof e<"u"&&!V_.includes(e))throw new Error(`Invalid method: ${e}. Supported methods are: ${V_.join(", ")}`);const n=!t.startsWith("gpt-3")&&!t.startsWith("gpt-4-")&&t!=="gpt-4";if(n&&!e)return"jsonSchema";if(!n&&e==="jsonSchema")throw new Error(`JSON Schema is not supported for model "${t}". Please use a different method, e.g. "functionCalling" or "jsonMode".`);return e??"functionCalling"}function dD(t,e){const n={...t};return Object.defineProperties(n,{$brand:{value:"auto-parseable-response-format",enumerable:!1},$parseRaw:{value:e,enumerable:!1}}),n}function hD(t,e,n){if(Ct(t))return lD(t,e,n);if(it(t))return dD({type:"json_schema",json_schema:{...n,name:e,strict:!0,schema:bt(t,{cycles:"ref",reused:"ref",override(r){r.jsonSchema.title=e}})}},r=>Bu(t,JSON.parse(r)));throw new Error("Unsupported schema response format")}function fD(t,e){if(e&&typeof e=="object"&&"images"in e&&Array.isArray(e.images)){const n=e.images.filter(r=>{var s;return typeof((s=r==null?void 0:r.image_url)==null?void 0:s.url)=="string"}).map(r=>({type:"image",url:r.image_url.url}));return[{type:"text",text:t},...n]}return t}const pD={"gpt-4.1-nano":{maxInputTokens:1047576,imageInputs:!0,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:32768,reasoningOutput:!1,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"text-embedding-3-small":{maxInputTokens:8191,imageInputs:!1,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:1536,reasoningOutput:!1,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!1,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"gpt-4":{maxInputTokens:8192,imageInputs:!1,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:8192,reasoningOutput:!1,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"o1-pro":{maxInputTokens:2e5,imageInputs:!0,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:1e5,reasoningOutput:!0,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"gpt-4o-2024-05-13":{maxInputTokens:128e3,imageInputs:!0,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:4096,reasoningOutput:!1,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"gpt-4o-2024-08-06":{maxInputTokens:128e3,imageInputs:!0,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:16384,reasoningOutput:!1,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"gpt-4.1-mini":{maxInputTokens:1047576,imageInputs:!0,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:32768,reasoningOutput:!1,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"o3-deep-research":{maxInputTokens:2e5,imageInputs:!0,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:1e5,reasoningOutput:!0,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"gpt-3.5-turbo":{maxInputTokens:16385,imageInputs:!1,audioInputs:!1,pdfInputs:!1,videoInputs:!1,maxOutputTokens:4096,reasoningOutput:!1,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!1,structuredOutput:!1,imageUrlInputs:!1,pdfToolMessage:!1,imageToolMessage:!1,toolChoice:!0},"text-embedding-3-large":{maxInputTokens:8191,imageInputs:!1,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:3072,reasoningOutput:!1,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!1,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"gpt-4-turbo":{maxInputTokens:128e3,imageInputs:!0,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:4096,reasoningOutput:!1,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"o1-preview":{maxInputTokens:128e3,imageInputs:!1,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:32768,reasoningOutput:!0,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!1,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"o3-mini":{maxInputTokens:2e5,imageInputs:!1,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:1e5,reasoningOutput:!0,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"codex-mini-latest":{maxInputTokens:2e5,imageInputs:!1,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:1e5,reasoningOutput:!0,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"gpt-5-nano":{maxInputTokens:4e5,imageInputs:!0,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:128e3,reasoningOutput:!0,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"gpt-5-codex":{maxInputTokens:4e5,imageInputs:!0,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:128e3,reasoningOutput:!0,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"gpt-4o":{maxInputTokens:128e3,imageInputs:!0,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:16384,reasoningOutput:!1,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"gpt-4.1":{maxInputTokens:1047576,imageInputs:!0,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:32768,reasoningOutput:!1,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"o4-mini":{maxInputTokens:2e5,imageInputs:!0,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:1e5,reasoningOutput:!0,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},o1:{maxInputTokens:2e5,imageInputs:!0,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:1e5,reasoningOutput:!0,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"gpt-5-mini":{maxInputTokens:4e5,imageInputs:!0,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:128e3,reasoningOutput:!0,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"o1-mini":{maxInputTokens:128e3,imageInputs:!1,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:65536,reasoningOutput:!0,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!1,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"text-embedding-ada-002":{maxInputTokens:8192,imageInputs:!1,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:1536,reasoningOutput:!1,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!1,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"o3-pro":{maxInputTokens:2e5,imageInputs:!0,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:1e5,reasoningOutput:!0,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"gpt-4o-2024-11-20":{maxInputTokens:128e3,imageInputs:!0,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:16384,reasoningOutput:!1,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},o3:{maxInputTokens:2e5,imageInputs:!0,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:1e5,reasoningOutput:!0,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"o4-mini-deep-research":{maxInputTokens:2e5,imageInputs:!0,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:1e5,reasoningOutput:!0,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"gpt-5-chat-latest":{maxInputTokens:4e5,imageInputs:!0,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:128e3,reasoningOutput:!0,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!1,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"gpt-4o-mini":{maxInputTokens:128e3,imageInputs:!0,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:16384,reasoningOutput:!1,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"gpt-5":{maxInputTokens:4e5,imageInputs:!0,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:128e3,reasoningOutput:!0,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"gpt-5-pro":{maxInputTokens:4e5,imageInputs:!0,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:272e3,reasoningOutput:!0,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0}};var mD=pD,ET={};Se(ET,{BasePromptValue:()=>ad,ChatPromptValue:()=>Vm,ImagePromptValue:()=>TT,StringPromptValue:()=>Zm});var ad=class extends cr{},Zm=class extends ad{constructor(e){super({value:e});p(this,"lc_namespace",["langchain_core","prompt_values"]);p(this,"lc_serializable",!0);p(this,"value");this.value=e}static lc_name(){return"StringPromptValue"}toString(){return this.value}toChatMessages(){return[new ht(this.value)]}},Vm=class extends ad{constructor(e){Array.isArray(e)&&(e={messages:e});super(e);p(this,"lc_namespace",["langchain_core","prompt_values"]);p(this,"lc_serializable",!0);p(this,"messages");this.messages=e.messages}static lc_name(){return"ChatPromptValue"}toString(){return Pp(this.messages)}toChatMessages(){return this.messages}},TT=class extends ad{constructor(e){"imageUrl"in e||(e={imageUrl:e});super(e);p(this,"lc_namespace",["langchain_core","prompt_values"]);p(this,"lc_serializable",!0);p(this,"imageUrl");p(this,"value");this.imageUrl=e.imageUrl}static lc_name(){return"ImagePromptValue"}toString(){return this.imageUrl.url}toChatMessages(){return[new ht({content:[{type:"image_url",image_url:{detail:this.imageUrl.detail,url:this.imageUrl.url}}]})]}},ue="0123456789abcdef".split(""),gD=[-2147483648,8388608,32768,128],pr=[24,16,8,0],Jc=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298],zt=[];function kr(t,e){e?(zt[0]=zt[16]=zt[1]=zt[2]=zt[3]=zt[4]=zt[5]=zt[6]=zt[7]=zt[8]=zt[9]=zt[10]=zt[11]=zt[12]=zt[13]=zt[14]=zt[15]=0,this.blocks=zt):this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],t?(this.h0=3238371032,this.h1=914150663,this.h2=812702999,this.h3=4144912697,this.h4=4290775857,this.h5=1750603025,this.h6=1694076839,this.h7=3204075428):(this.h0=1779033703,this.h1=3144134277,this.h2=1013904242,this.h3=2773480762,this.h4=1359893119,this.h5=2600822924,this.h6=528734635,this.h7=1541459225),this.block=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0,this.is224=t}kr.prototype.update=function(t){if(!this.finalized){var e,n=typeof t;if(n!=="string"){if(n==="object"){if(t===null)throw new Error(ERROR);if(ARRAY_BUFFER&&t.constructor===ArrayBuffer)t=new Uint8Array(t);else if(!Array.isArray(t)&&(!ARRAY_BUFFER||!ArrayBuffer.isView(t)))throw new Error(ERROR)}else throw new Error(ERROR);e=!0}for(var r,s=0,i,a=t.length,o=this.blocks;s<a;){if(this.hashed&&(this.hashed=!1,o[0]=this.block,this.block=o[16]=o[1]=o[2]=o[3]=o[4]=o[5]=o[6]=o[7]=o[8]=o[9]=o[10]=o[11]=o[12]=o[13]=o[14]=o[15]=0),e)for(i=this.start;s<a&&i<64;++s)o[i>>>2]|=t[s]<<pr[i++&3];else for(i=this.start;s<a&&i<64;++s)r=t.charCodeAt(s),r<128?o[i>>>2]|=r<<pr[i++&3]:r<2048?(o[i>>>2]|=(192|r>>>6)<<pr[i++&3],o[i>>>2]|=(128|r&63)<<pr[i++&3]):r<55296||r>=57344?(o[i>>>2]|=(224|r>>>12)<<pr[i++&3],o[i>>>2]|=(128|r>>>6&63)<<pr[i++&3],o[i>>>2]|=(128|r&63)<<pr[i++&3]):(r=65536+((r&1023)<<10|t.charCodeAt(++s)&1023),o[i>>>2]|=(240|r>>>18)<<pr[i++&3],o[i>>>2]|=(128|r>>>12&63)<<pr[i++&3],o[i>>>2]|=(128|r>>>6&63)<<pr[i++&3],o[i>>>2]|=(128|r&63)<<pr[i++&3]);this.lastByteIndex=i,this.bytes+=i-this.start,i>=64?(this.block=o[16],this.start=i-64,this.hash(),this.hashed=!0):this.start=i}return this.bytes>4294967295&&(this.hBytes+=this.bytes/4294967296<<0,this.bytes=this.bytes%4294967296),this}};kr.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var t=this.blocks,e=this.lastByteIndex;t[16]=this.block,t[e>>>2]|=gD[e&3],this.block=t[16],e>=56&&(this.hashed||this.hash(),t[0]=this.block,t[16]=t[1]=t[2]=t[3]=t[4]=t[5]=t[6]=t[7]=t[8]=t[9]=t[10]=t[11]=t[12]=t[13]=t[14]=t[15]=0),t[14]=this.hBytes<<3|this.bytes>>>29,t[15]=this.bytes<<3,this.hash()}};kr.prototype.hash=function(){var t=this.h0,e=this.h1,n=this.h2,r=this.h3,s=this.h4,i=this.h5,a=this.h6,o=this.h7,c=this.blocks,l,u,d,h,f,m,g,w,b,y,v;for(l=16;l<64;++l)f=c[l-15],u=(f>>>7|f<<25)^(f>>>18|f<<14)^f>>>3,f=c[l-2],d=(f>>>17|f<<15)^(f>>>19|f<<13)^f>>>10,c[l]=c[l-16]+u+c[l-7]+d<<0;for(v=e&n,l=0;l<64;l+=4)this.first?(this.is224?(w=300032,f=c[0]-1413257819,o=f-150054599<<0,r=f+24177077<<0):(w=704751109,f=c[0]-210244248,o=f-1521486534<<0,r=f+143694565<<0),this.first=!1):(u=(t>>>2|t<<30)^(t>>>13|t<<19)^(t>>>22|t<<10),d=(s>>>6|s<<26)^(s>>>11|s<<21)^(s>>>25|s<<7),w=t&e,h=w^t&n^v,g=s&i^~s&a,f=o+d+g+Jc[l]+c[l],m=u+h,o=r+f<<0,r=f+m<<0),u=(r>>>2|r<<30)^(r>>>13|r<<19)^(r>>>22|r<<10),d=(o>>>6|o<<26)^(o>>>11|o<<21)^(o>>>25|o<<7),b=r&t,h=b^r&e^w,g=a&o^~a&s,f=i+d+g+Jc[l+1]+c[l+1],m=u+h,a=n+f<<0,n=f+m<<0,u=(n>>>2|n<<30)^(n>>>13|n<<19)^(n>>>22|n<<10),d=(a>>>6|a<<26)^(a>>>11|a<<21)^(a>>>25|a<<7),y=n&r,h=y^n&t^b,g=i&a^~i&o,f=s+d+g+Jc[l+2]+c[l+2],m=u+h,i=e+f<<0,e=f+m<<0,u=(e>>>2|e<<30)^(e>>>13|e<<19)^(e>>>22|e<<10),d=(i>>>6|i<<26)^(i>>>11|i<<21)^(i>>>25|i<<7),v=e&n,h=v^e&r^y,g=i&a^~i&o,f=s+d+g+Jc[l+3]+c[l+3],m=u+h,s=t+f<<0,t=f+m<<0,this.chromeBugWorkAround=!0;this.h0=this.h0+t<<0,this.h1=this.h1+e<<0,this.h2=this.h2+n<<0,this.h3=this.h3+r<<0,this.h4=this.h4+s<<0,this.h5=this.h5+i<<0,this.h6=this.h6+a<<0,this.h7=this.h7+o<<0};kr.prototype.hex=function(){this.finalize();var t=this.h0,e=this.h1,n=this.h2,r=this.h3,s=this.h4,i=this.h5,a=this.h6,o=this.h7,c=ue[t>>>28&15]+ue[t>>>24&15]+ue[t>>>20&15]+ue[t>>>16&15]+ue[t>>>12&15]+ue[t>>>8&15]+ue[t>>>4&15]+ue[t&15]+ue[e>>>28&15]+ue[e>>>24&15]+ue[e>>>20&15]+ue[e>>>16&15]+ue[e>>>12&15]+ue[e>>>8&15]+ue[e>>>4&15]+ue[e&15]+ue[n>>>28&15]+ue[n>>>24&15]+ue[n>>>20&15]+ue[n>>>16&15]+ue[n>>>12&15]+ue[n>>>8&15]+ue[n>>>4&15]+ue[n&15]+ue[r>>>28&15]+ue[r>>>24&15]+ue[r>>>20&15]+ue[r>>>16&15]+ue[r>>>12&15]+ue[r>>>8&15]+ue[r>>>4&15]+ue[r&15]+ue[s>>>28&15]+ue[s>>>24&15]+ue[s>>>20&15]+ue[s>>>16&15]+ue[s>>>12&15]+ue[s>>>8&15]+ue[s>>>4&15]+ue[s&15]+ue[i>>>28&15]+ue[i>>>24&15]+ue[i>>>20&15]+ue[i>>>16&15]+ue[i>>>12&15]+ue[i>>>8&15]+ue[i>>>4&15]+ue[i&15]+ue[a>>>28&15]+ue[a>>>24&15]+ue[a>>>20&15]+ue[a>>>16&15]+ue[a>>>12&15]+ue[a>>>8&15]+ue[a>>>4&15]+ue[a&15];return this.is224||(c+=ue[o>>>28&15]+ue[o>>>24&15]+ue[o>>>20&15]+ue[o>>>16&15]+ue[o>>>12&15]+ue[o>>>8&15]+ue[o>>>4&15]+ue[o&15]),c};kr.prototype.toString=kr.prototype.hex;kr.prototype.digest=function(){this.finalize();var t=this.h0,e=this.h1,n=this.h2,r=this.h3,s=this.h4,i=this.h5,a=this.h6,o=this.h7,c=[t>>>24&255,t>>>16&255,t>>>8&255,t&255,e>>>24&255,e>>>16&255,e>>>8&255,e&255,n>>>24&255,n>>>16&255,n>>>8&255,n&255,r>>>24&255,r>>>16&255,r>>>8&255,r&255,s>>>24&255,s>>>16&255,s>>>8&255,s&255,i>>>24&255,i>>>16&255,i>>>8&255,i&255,a>>>24&255,a>>>16&255,a>>>8&255,a&255];return this.is224||c.push(o>>>24&255,o>>>16&255,o>>>8&255,o&255),c};kr.prototype.array=kr.prototype.digest;kr.prototype.arrayBuffer=function(){this.finalize();var t=new ArrayBuffer(this.is224?28:32),e=new DataView(t);return e.setUint32(0,this.h0),e.setUint32(4,this.h1),e.setUint32(8,this.h2),e.setUint32(12,this.h3),e.setUint32(16,this.h4),e.setUint32(20,this.h5),e.setUint32(24,this.h6),this.is224||e.setUint32(28,this.h7),t};const od=(...t)=>new kr(!1,!0).update(t.join("")).hex();var ST={};Se(ST,{sha256:()=>od});var xT={};Se(xT,{BaseCache:()=>IT,InMemoryCache:()=>AT,defaultHashKeyEncoder:()=>kT,deserializeStoredGeneration:()=>yD,serializeGeneration:()=>_D});const kT=(...t)=>od(t.join("_"));function yD(t){return t.message!==void 0?{text:t.text,message:Mp(t.message)}:{text:t.text}}function _D(t){const e={text:t.text};return t.message!==void 0&&(e.message=t.message.toDict()),e}var IT=class{constructor(){p(this,"keyEncoder",kT)}makeDefaultKeyEncoder(e){this.keyEncoder=e}};const wD=new Map;var AT=class CT extends IT{constructor(n){super();p(this,"cache");this.cache=n??new Map}lookup(n,r){return Promise.resolve(this.cache.get(this.keyEncoder(n,r))??null)}async update(n,r,s){this.cache.set(this.keyEncoder(n,r),s)}static global(){return new CT(wD)}},cd={};cd.byteLength=ED;cd.toByteArray=SD;cd.fromByteArray=ID;var jr=[],tr=[],vD=typeof Uint8Array<"u"?Uint8Array:Array,uh="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(var Zi=0,bD=uh.length;Zi<bD;++Zi)jr[Zi]=uh[Zi],tr[uh.charCodeAt(Zi)]=Zi;tr[45]=62;tr[95]=63;function OT(t){var e=t.length;if(e%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var n=t.indexOf("=");n===-1&&(n=e);var r=n===e?0:4-n%4;return[n,r]}function ED(t){var e=OT(t),n=e[0],r=e[1];return(n+r)*3/4-r}function TD(t,e,n){return(e+n)*3/4-n}function SD(t){var e,n=OT(t),r=n[0],s=n[1],i=new vD(TD(t,r,s)),a=0,o=s>0?r-4:r,c;for(c=0;c<o;c+=4)e=tr[t.charCodeAt(c)]<<18|tr[t.charCodeAt(c+1)]<<12|tr[t.charCodeAt(c+2)]<<6|tr[t.charCodeAt(c+3)],i[a++]=e>>16&255,i[a++]=e>>8&255,i[a++]=e&255;return s===2&&(e=tr[t.charCodeAt(c)]<<2|tr[t.charCodeAt(c+1)]>>4,i[a++]=e&255),s===1&&(e=tr[t.charCodeAt(c)]<<10|tr[t.charCodeAt(c+1)]<<4|tr[t.charCodeAt(c+2)]>>2,i[a++]=e>>8&255,i[a++]=e&255),i}function xD(t){return jr[t>>18&63]+jr[t>>12&63]+jr[t>>6&63]+jr[t&63]}function kD(t,e,n){for(var r,s=[],i=e;i<n;i+=3)r=(t[i]<<16&16711680)+(t[i+1]<<8&65280)+(t[i+2]&255),s.push(xD(r));return s.join("")}function ID(t){for(var e,n=t.length,r=n%3,s=[],i=16383,a=0,o=n-r;a<o;a+=i)s.push(kD(t,a,a+i>o?o:a+i));return r===1?(e=t[n-1],s.push(jr[e>>2]+jr[e<<4&63]+"==")):r===2&&(e=(t[n-2]<<8)+t[n-1],s.push(jr[e>>10]+jr[e>>4&63]+jr[e<<2&63]+"=")),s.join("")}var AD=Object.defineProperty,CD=(t,e,n)=>e in t?AD(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,OD=(t,e,n)=>(CD(t,e+"",n),n);function $D(t,e){let n=Array.from({length:t.length},(r,s)=>({start:s,end:s+1}));for(;n.length>1;){let r=null;for(let s=0;s<n.length-1;s++){const i=t.slice(n[s].start,n[s+1].end),a=e.get(i.join(","));a!=null&&(r==null||a<r[0])&&(r=[a,s])}if(r!=null){const s=r[1];n[s]={start:n[s].start,end:n[s+1].end},n.splice(s+1,1)}else break}return n}function RD(t,e){return t.length===1?[e.get(t.join(","))]:$D(t,e).map(n=>e.get(t.slice(n.start,n.end).join(","))).filter(n=>n!=null)}function ND(t){return t.replace(/[\\^$*+?.()|[\]{}]/g,"\\$&")}var Df=class{constructor(t,e){p(this,"specialTokens");p(this,"inverseSpecialTokens");p(this,"patStr");p(this,"textEncoder",new TextEncoder);p(this,"textDecoder",new TextDecoder("utf-8"));p(this,"rankMap",new Map);p(this,"textMap",new Map);this.patStr=t.pat_str;const n=t.bpe_ranks.split(`
`).filter(Boolean).reduce((r,s)=>{const[i,a,...o]=s.split(" "),c=Number.parseInt(a,10);return o.forEach((l,u)=>r[l]=c+u),r},{});for(const[r,s]of Object.entries(n)){const i=cd.toByteArray(r);this.rankMap.set(i.join(","),s),this.textMap.set(s,i)}this.specialTokens={...t.special_tokens,...e},this.inverseSpecialTokens=Object.entries(this.specialTokens).reduce((r,[s,i])=>(r[i]=this.textEncoder.encode(s),r),{})}encode(t,e=[],n="all"){const r=new RegExp(this.patStr,"ug"),s=Df.specialTokenRegex(Object.keys(this.specialTokens)),i=[],a=new Set(e==="all"?Object.keys(this.specialTokens):e),o=new Set(n==="all"?Object.keys(this.specialTokens).filter(l=>!a.has(l)):n);if(o.size>0){const l=Df.specialTokenRegex([...o]),u=t.match(l);if(u!=null)throw new Error(`The text contains a special token that is not allowed: ${u[0]}`)}let c=0;for(;;){let l=null,u=c;for(;s.lastIndex=u,l=s.exec(t),!(l==null||a.has(l[0]));)u=l.index+1;const d=(l==null?void 0:l.index)??t.length;for(const f of t.substring(c,d).matchAll(r)){const m=this.textEncoder.encode(f[0]),g=this.rankMap.get(m.join(","));if(g!=null){i.push(g);continue}i.push(...RD(m,this.rankMap))}if(l==null)break;let h=this.specialTokens[l[0]];i.push(h),c=l.index+l[0].length}return i}decode(t){const e=[];let n=0;for(let i=0;i<t.length;++i){const a=t[i],o=this.textMap.get(a)??this.inverseSpecialTokens[a];o!=null&&(e.push(o),n+=o.length)}const r=new Uint8Array(n);let s=0;for(const i of e)r.set(i,s),s+=i.length;return this.textDecoder.decode(r)}},$T=Df;OD($T,"specialTokenRegex",t=>new RegExp(t.map(e=>ND(e)).join("|"),"g"));function PD(t){switch(t){case"gpt2":return"gpt2";case"code-cushman-001":case"code-cushman-002":case"code-davinci-001":case"code-davinci-002":case"cushman-codex":case"davinci-codex":case"davinci-002":case"text-davinci-002":case"text-davinci-003":return"p50k_base";case"code-davinci-edit-001":case"text-davinci-edit-001":return"p50k_edit";case"ada":case"babbage":case"babbage-002":case"code-search-ada-code-001":case"code-search-babbage-code-001":case"curie":case"davinci":case"text-ada-001":case"text-babbage-001":case"text-curie-001":case"text-davinci-001":case"text-search-ada-doc-001":case"text-search-babbage-doc-001":case"text-search-curie-doc-001":case"text-search-davinci-doc-001":case"text-similarity-ada-001":case"text-similarity-babbage-001":case"text-similarity-curie-001":case"text-similarity-davinci-001":return"r50k_base";case"gpt-3.5-turbo-instruct-0914":case"gpt-3.5-turbo-instruct":case"gpt-3.5-turbo-16k-0613":case"gpt-3.5-turbo-16k":case"gpt-3.5-turbo-0613":case"gpt-3.5-turbo-0301":case"gpt-3.5-turbo":case"gpt-4-32k-0613":case"gpt-4-32k-0314":case"gpt-4-32k":case"gpt-4-0613":case"gpt-4-0314":case"gpt-4":case"gpt-3.5-turbo-1106":case"gpt-35-turbo":case"gpt-4-1106-preview":case"gpt-4-vision-preview":case"gpt-3.5-turbo-0125":case"gpt-4-turbo":case"gpt-4-turbo-2024-04-09":case"gpt-4-turbo-preview":case"gpt-4-0125-preview":case"text-embedding-ada-002":case"text-embedding-3-small":case"text-embedding-3-large":return"cl100k_base";case"gpt-4o":case"gpt-4o-2024-05-13":case"gpt-4o-2024-08-06":case"gpt-4o-2024-11-20":case"gpt-4o-mini-2024-07-18":case"gpt-4o-mini":case"gpt-4o-search-preview":case"gpt-4o-search-preview-2025-03-11":case"gpt-4o-mini-search-preview":case"gpt-4o-mini-search-preview-2025-03-11":case"gpt-4o-audio-preview":case"gpt-4o-audio-preview-2024-12-17":case"gpt-4o-audio-preview-2024-10-01":case"gpt-4o-mini-audio-preview":case"gpt-4o-mini-audio-preview-2024-12-17":case"o1":case"o1-2024-12-17":case"o1-mini":case"o1-mini-2024-09-12":case"o1-preview":case"o1-preview-2024-09-12":case"o1-pro":case"o1-pro-2025-03-19":case"o3":case"o3-2025-04-16":case"o3-mini":case"o3-mini-2025-01-31":case"o4-mini":case"o4-mini-2025-04-16":case"chatgpt-4o-latest":case"gpt-4o-realtime":case"gpt-4o-realtime-preview-2024-10-01":case"gpt-4o-realtime-preview-2024-12-17":case"gpt-4o-mini-realtime-preview":case"gpt-4o-mini-realtime-preview-2024-12-17":case"gpt-4.1":case"gpt-4.1-2025-04-14":case"gpt-4.1-mini":case"gpt-4.1-mini-2025-04-14":case"gpt-4.1-nano":case"gpt-4.1-nano-2025-04-14":case"gpt-4.5-preview":case"gpt-4.5-preview-2025-02-27":case"gpt-5":case"gpt-5-2025-08-07":case"gpt-5-nano":case"gpt-5-nano-2025-08-07":case"gpt-5-mini":case"gpt-5-mini-2025-08-07":case"gpt-5-chat-latest":return"o200k_base";default:throw new Error("Unknown model")}}var RT={};Se(RT,{encodingForModel:()=>Gm,getEncoding:()=>NT});const Kc={},MD=new sc({});async function NT(t){return t in Kc||(Kc[t]=MD.fetch(`https://tiktoken.pages.dev/js/${t}.json`).then(e=>e.json()).then(e=>new $T(e)).catch(e=>{throw delete Kc[t],e})),await Kc[t]}async function Gm(t){return NT(PD(t))}var PT={};Se(PT,{BaseLangChain:()=>Hm,BaseLanguageModel:()=>ud,calculateMaxTokens:()=>jD,getEmbeddingContextSize:()=>LD,getModelContextSize:()=>fu,getModelNameForTiktoken:()=>ld,isOpenAITool:()=>Wm});const ld=t=>t.startsWith("gpt-5")?"gpt-5":t.startsWith("gpt-3.5-turbo-16k")?"gpt-3.5-turbo-16k":t.startsWith("gpt-3.5-turbo-")?"gpt-3.5-turbo":t.startsWith("gpt-4-32k")?"gpt-4-32k":t.startsWith("gpt-4-")?"gpt-4":t.startsWith("gpt-4o")?"gpt-4o":t,LD=t=>{switch(t){case"text-embedding-ada-002":return 8191;default:return 2046}},fu=t=>{switch(ld(t)){case"gpt-5":case"gpt-5-turbo":case"gpt-5-turbo-preview":return 4e5;case"gpt-4o":case"gpt-4o-mini":case"gpt-4o-2024-05-13":case"gpt-4o-2024-08-06":return 128e3;case"gpt-4-turbo":case"gpt-4-turbo-preview":case"gpt-4-turbo-2024-04-09":case"gpt-4-0125-preview":case"gpt-4-1106-preview":return 128e3;case"gpt-4-32k":case"gpt-4-32k-0314":case"gpt-4-32k-0613":return 32768;case"gpt-4":case"gpt-4-0314":case"gpt-4-0613":return 8192;case"gpt-3.5-turbo-16k":case"gpt-3.5-turbo-16k-0613":return 16384;case"gpt-3.5-turbo":case"gpt-3.5-turbo-0301":case"gpt-3.5-turbo-0613":case"gpt-3.5-turbo-1106":case"gpt-3.5-turbo-0125":return 4096;case"text-davinci-003":case"text-davinci-002":return 4097;case"text-davinci-001":return 2049;case"text-curie-001":case"text-babbage-001":case"text-ada-001":return 2048;case"code-davinci-002":case"code-davinci-001":return 8e3;case"code-cushman-001":return 2048;case"claude-3-5-sonnet-20241022":case"claude-3-5-sonnet-20240620":case"claude-3-opus-20240229":case"claude-3-sonnet-20240229":case"claude-3-haiku-20240307":case"claude-2.1":return 2e5;case"claude-2.0":case"claude-instant-1.2":return 1e5;case"gemini-1.5-pro":case"gemini-1.5-pro-latest":case"gemini-1.5-flash":case"gemini-1.5-flash-latest":return 1e6;case"gemini-pro":case"gemini-pro-vision":return 32768;default:return 4097}};function Wm(t){return typeof t!="object"||!t?!1:!!("type"in t&&t.type==="function"&&"function"in t&&typeof t.function=="object"&&t.function&&"name"in t.function&&"parameters"in t.function)}const jD=async({prompt:t,modelName:e})=>{let n;try{n=(await Gm(ld(e))).encode(t).length}catch{console.warn("Failed to calculate number of tokens, falling back to approximate count"),n=Math.ceil(t.length/4)}return fu(e)-n},DD=()=>!1;var Hm=class extends Fe{constructor(e){super(e);p(this,"verbose");p(this,"callbacks");p(this,"tags");p(this,"metadata");this.verbose=e.verbose??DD(),this.callbacks=e.callbacks,this.tags=e.tags??[],this.metadata=e.metadata??{}}get lc_attributes(){return{callbacks:void 0,verbose:void 0}}},ud=class extends Hm{constructor({callbacks:e,callbackManager:n,...r}){const{cache:s,...i}=r;super({callbacks:e??n,...i});p(this,"caller");p(this,"cache");p(this,"_encoding");typeof s=="object"?this.cache=s:s?this.cache=AT.global():this.cache=void 0,this.caller=new sc(r??{})}get callKeys(){return["stop","timeout","signal","tags","metadata","callbacks"]}async getNumTokens(e){let n;typeof e=="string"?n=e:n=e.map(s=>typeof s=="string"?s:s.type==="text"&&"text"in s?s.text:"").join("");let r=Math.ceil(n.length/4);if(!this._encoding)try{this._encoding=await Gm("modelName"in this?ld(this.modelName):"gpt2")}catch(s){console.warn("Failed to calculate number of tokens, falling back to approximate count",s)}if(this._encoding)try{r=this._encoding.encode(n).length}catch(s){console.warn("Failed to calculate number of tokens, falling back to approximate count",s)}return r}static _convertInputToPromptValue(e){return typeof e=="string"?new Zm(e):Array.isArray(e)?new Vm(e.map(Zr)):e}_identifyingParams(){return{}}_getSerializedCacheKeyParametersForCall({config:e,...n}){const r={...this._identifyingParams(),...n,_type:this._llmType(),_model:this._modelType()};return Object.entries(r).filter(([a,o])=>o!==void 0).map(([a,o])=>`${a}:${JSON.stringify(o)}`).sort().join(",")}serialize(){return{...this._identifyingParams(),_type:this._llmType(),_model:this._modelType()}}static async deserialize(e){throw new Error("Use .toJSON() instead")}get profile(){return{}}},Ci=class extends Fe{constructor(e){super(e);p(this,"lc_namespace",["langchain_core","runnables"]);p(this,"lc_serializable",!0);p(this,"func");e&&(this.func=e.func)}static lc_name(){return"RunnablePassthrough"}async invoke(e,n){const r=Ze(n);return this.func&&await this.func(e,r),this._callWithConfig(s=>Promise.resolve(s),e,r)}async*transform(e,n){const r=Ze(n);let s,i=!0;for await(const a of this._transformStreamWithConfig(e,o=>o,r))if(yield a,i)if(s===void 0)s=a;else try{s=Hs(s,a)}catch{s=void 0,i=!1}this.func&&s!==void 0&&await this.func(s,r)}static assign(e){return new dm(new Na({steps:e}))}};const UD=t=>t();function dh(t){const e=t.constructor;return new e({...t,content:t.contentBlocks,response_metadata:{...t.response_metadata,output_version:"v1"}})}var MT={};Se(MT,{BaseChatModel:()=>Qs,SimpleChatModel:()=>FD});function hh(t){const e=[];for(const n of t){let r=n;if(Array.isArray(n.content))for(let s=0;s<n.content.length;s++){const i=n.content[s];(Ep(i)||Tp(i))&&r===n&&(r=new n.constructor({...r,content:[...n.content.slice(0,s),Uw(i),...n.content.slice(s+1)]}))}e.push(r)}return e}var Qs=class ai extends ud{constructor(n){super(n);p(this,"lc_namespace",["langchain","chat_models",this._llmType()]);p(this,"disableStreaming",!1);p(this,"outputVersion");this.outputVersion=UD(()=>{const r=n.outputVersion??Sr("LC_OUTPUT_VERSION");return r&&["v0","v1"].includes(r)?r:"v0"})}get callKeys(){return[...super.callKeys,"outputVersion"]}_separateRunnableConfigFromCallOptionsCompat(n){const[r,s]=super._separateRunnableConfigFromCallOptions(n);return s.signal=r.signal,[r,s]}async invoke(n,r){const s=ai._convertInputToPromptValue(n);return(await this.generatePrompt([s],r,r==null?void 0:r.callbacks)).generations[0][0].message}async*_streamResponseChunks(n,r,s){throw new Error("Not implemented.")}async*_streamIterator(n,r){var s;if(this._streamResponseChunks===ai.prototype._streamResponseChunks||this.disableStreaming)yield this.invoke(n,r);else{const a=ai._convertInputToPromptValue(n).toChatMessages(),[o,c]=this._separateRunnableConfigFromCallOptionsCompat(r),l={...o.metadata,...this.getLsParams(c)},u=await wn.configure(o.callbacks,this.callbacks,o.tags,this.tags,l,this.metadata,{verbose:this.verbose}),d={options:c,invocation_params:this==null?void 0:this.invocationParams(c),batch_size:1},h=c.outputVersion??this.outputVersion,f=await(u==null?void 0:u.handleChatModelStart(this.toJSON(),[hh(a)],o.runId,void 0,d,void 0,void 0,o.runName));let m,g;try{for await(const w of this._streamResponseChunks(a,c,f==null?void 0:f[0])){if(w.message.id==null){const b=(s=f==null?void 0:f.at(0))==null?void 0:s.runId;b!=null&&w.message._updateId(`run-${b}`)}w.message.response_metadata={...w.generationInfo,...w.message.response_metadata},h==="v1"?yield dh(w.message):yield w.message,m?m=m.concat(w):m=w,Uh(w.message)&&w.message.usage_metadata!==void 0&&(g={tokenUsage:{promptTokens:w.message.usage_metadata.input_tokens,completionTokens:w.message.usage_metadata.output_tokens,totalTokens:w.message.usage_metadata.total_tokens}})}}catch(w){throw await Promise.all((f??[]).map(b=>b==null?void 0:b.handleLLMError(w))),w}await Promise.all((f??[]).map(w=>w==null?void 0:w.handleLLMEnd({generations:[[m]],llmOutput:g})))}}getLsParams(n){const r=this.getName().startsWith("Chat")?this.getName().replace("Chat",""):this.getName();return{ls_model_type:"chat",ls_stop:n.stop,ls_provider:r}}async _generateUncached(n,r,s,i){var f,m;const a=n.map(g=>g.map(Zr));let o;if(i!==void 0&&i.length===a.length)o=i;else{const g={...s.metadata,...this.getLsParams(r)},w=await wn.configure(s.callbacks,this.callbacks,s.tags,this.tags,g,this.metadata,{verbose:this.verbose}),b={options:r,invocation_params:this==null?void 0:this.invocationParams(r),batch_size:1};o=await(w==null?void 0:w.handleChatModelStart(this.toJSON(),a.map(hh),s.runId,void 0,b,void 0,void 0,s.runName))}const c=r.outputVersion??this.outputVersion,l=[],u=[];if(!!(o!=null&&o[0].handlers.find(Dp))&&!this.disableStreaming&&a.length===1&&this._streamResponseChunks!==ai.prototype._streamResponseChunks)try{const g=await this._streamResponseChunks(a[0],r,o==null?void 0:o[0]);let w,b;for await(const y of g){if(y.message.id==null){const v=(f=o==null?void 0:o.at(0))==null?void 0:f.runId;v!=null&&y.message._updateId(`run-${v}`)}w===void 0?w=y:w=Hs(w,y),Uh(y.message)&&y.message.usage_metadata!==void 0&&(b={tokenUsage:{promptTokens:y.message.usage_metadata.input_tokens,completionTokens:y.message.usage_metadata.output_tokens,totalTokens:y.message.usage_metadata.total_tokens}})}if(w===void 0)throw new Error("Received empty response from chat model call.");l.push([w]),await(o==null?void 0:o[0].handleLLMEnd({generations:l,llmOutput:b}))}catch(g){throw await(o==null?void 0:o[0].handleLLMError(g)),g}else{const g=await Promise.allSettled(a.map(async(w,b)=>{const y=await this._generate(w,{...r,promptIndex:b},o==null?void 0:o[b]);if(c==="v1")for(const v of y.generations)v.message=dh(v.message);return y}));await Promise.all(g.map(async(w,b)=>{var y,v,T;if(w.status==="fulfilled"){const A=w.value;for(const I of A.generations){if(I.message.id==null){const $=(y=o==null?void 0:o.at(0))==null?void 0:y.runId;$!=null&&I.message._updateId(`run-${$}`)}I.message.response_metadata={...I.generationInfo,...I.message.response_metadata}}return A.generations.length===1&&(A.generations[0].message.response_metadata={...A.llmOutput,...A.generations[0].message.response_metadata}),l[b]=A.generations,u[b]=A.llmOutput,(v=o==null?void 0:o[b])==null?void 0:v.handleLLMEnd({generations:[A.generations],llmOutput:A.llmOutput})}else return await((T=o==null?void 0:o[b])==null?void 0:T.handleLLMError(w.reason)),Promise.reject(w.reason)}))}const h={generations:l,llmOutput:u.length?(m=this._combineLLMOutput)==null?void 0:m.call(this,...u):void 0};return Object.defineProperty(h,ko,{value:o?{runIds:o==null?void 0:o.map(g=>g.runId)}:void 0,configurable:!0}),h}async _generateCached({messages:n,cache:r,llmStringKey:s,parsedOptions:i,handledOptions:a}){const o=n.map(y=>y.map(Zr)),c={...a.metadata,...this.getLsParams(i)},l=await wn.configure(a.callbacks,this.callbacks,a.tags,this.tags,c,this.metadata,{verbose:this.verbose}),u={options:i,invocation_params:this==null?void 0:this.invocationParams(i),batch_size:1},d=await(l==null?void 0:l.handleChatModelStart(this.toJSON(),o.map(hh),a.runId,void 0,u,void 0,void 0,a.runName)),h=[],m=(await Promise.allSettled(o.map(async(y,v)=>{const T=ai._convertInputToPromptValue(y).toString(),A=await r.lookup(T,s);return A==null&&h.push(v),A}))).map((y,v)=>({result:y,runManager:d==null?void 0:d[v]})).filter(({result:y})=>y.status==="fulfilled"&&y.value!=null||y.status==="rejected"),g=i.outputVersion??this.outputVersion,w=[];await Promise.all(m.map(async({result:y,runManager:v},T)=>{if(y.status==="fulfilled"){const A=y.value;return w[T]=A.map(I=>("message"in I&&Yt(I.message)&&Ru(I.message)&&(I.message.usage_metadata={input_tokens:0,output_tokens:0,total_tokens:0},g==="v1"&&(I.message=dh(I.message))),I.generationInfo={...I.generationInfo,tokenUsage:{}},I)),A.length&&await(v==null?void 0:v.handleLLMNewToken(A[0].text)),v==null?void 0:v.handleLLMEnd({generations:[A]},void 0,void 0,void 0,{cached:!0})}else return await(v==null?void 0:v.handleLLMError(y.reason,void 0,void 0,void 0,{cached:!0})),Promise.reject(y.reason)}));const b={generations:w,missingPromptIndices:h,startedRunManagers:d};return Object.defineProperty(b,ko,{value:d?{runIds:d==null?void 0:d.map(y=>y.runId)}:void 0,configurable:!0}),b}async generate(n,r,s){let i;Array.isArray(r)?i={stop:r}:i=r;const a=n.map(g=>g.map(Zr)),[o,c]=this._separateRunnableConfigFromCallOptionsCompat(i);if(o.callbacks=o.callbacks??s,!this.cache)return this._generateUncached(a,c,o);const{cache:l}=this,u=this._getSerializedCacheKeyParametersForCall(c),{generations:d,missingPromptIndices:h,startedRunManagers:f}=await this._generateCached({messages:a,cache:l,llmStringKey:u,parsedOptions:c,handledOptions:o});let m={};if(h.length>0){const g=await this._generateUncached(h.map(w=>a[w]),c,o,f!==void 0?h.map(w=>f==null?void 0:f[w]):void 0);await Promise.all(g.generations.map(async(w,b)=>{const y=h[b];d[y]=w;const v=ai._convertInputToPromptValue(a[y]).toString();return l.update(v,u,w)})),m=g.llmOutput??{}}return{generations:d,llmOutput:m}}invocationParams(n){return{}}_modelType(){return"base_chat_model"}async generatePrompt(n,r,s){const i=n.map(a=>a.toChatMessages());return this.generate(i,r,s)}withStructuredOutput(n,r){if(typeof this.bindTools!="function")throw new Error('Chat model must implement ".bindTools()" to use withStructuredOutput.');if(r!=null&&r.strict)throw new Error('"strict" mode is not supported for this model by default.');const s=n,i=r==null?void 0:r.name,a=ki(s)??"A function available to call.",o=r==null?void 0:r.method,c=r==null?void 0:r.includeRaw;if(o==="jsonMode")throw new Error('Base withStructuredOutput implementation only supports "functionCalling" as a method.');let l=i??"extract",u;ar(s)?u=[{type:"function",function:{name:l,description:a,parameters:bt(s)}}]:("name"in s&&(l=s.name),u=[{type:"function",function:{name:l,description:a,parameters:s}}]);const d=this.bindTools(u),h=Kn.from(w=>{if(!dn.isInstance(w))throw new Error("Input is not an AIMessageChunk.");if(!w.tool_calls||w.tool_calls.length===0)throw new Error("No tool calls found in the response.");const b=w.tool_calls.find(y=>y.name===l);if(!b)throw new Error(`No tool call found with name ${l}.`);return b.args});if(!c)return d.pipe(h).withConfig({runName:"StructuredOutput"});const f=Ci.assign({parsed:(w,b)=>h.invoke(w.raw,b)}),m=Ci.assign({parsed:()=>null}),g=f.withFallbacks({fallbacks:[m]});return Jn.from([{raw:d},g]).withConfig({runName:"StructuredOutputRunnable"})}},FD=class extends Qs{async _generate(t,e,n){const r=await this._call(t,e,n),s=new le(r);if(typeof s.content!="string")throw new Error("Cannot generate with a simple chat model when output is not a string.");return{generations:[{text:s.content,message:s}]}}},BD=class extends Fe{constructor(e){super(e);p(this,"lc_namespace",["langchain_core","runnables"]);p(this,"lc_serializable",!0);p(this,"runnables");this.runnables=e.runnables}static lc_name(){return"RouterRunnable"}async invoke(e,n){const{key:r,input:s}=e,i=this.runnables[r];if(i===void 0)throw new Error(`No runnable associated with key "${r}".`);return i.invoke(s,Ze(n))}async batch(e,n,r){var h;const s=e.map(f=>f.key),i=e.map(f=>f.input);if(s.find(f=>this.runnables[f]===void 0)!==void 0)throw new Error("One or more keys do not have a corresponding runnable.");const o=s.map(f=>this.runnables[f]),c=this._getOptionsList(n??{},e.length),l=((h=c[0])==null?void 0:h.maxConcurrency)??(r==null?void 0:r.maxConcurrency),u=l&&l>0?l:e.length,d=[];for(let f=0;f<i.length;f+=u){const m=i.slice(f,f+u).map((w,b)=>o[b].invoke(w,c[b])),g=await Promise.all(m);d.push(g)}return d.flat()}async stream(e,n){const{key:r,input:s}=e,i=this.runnables[r];if(i===void 0)throw new Error(`No runnable associated with key "${r}".`);return i.stream(s,n)}},zD=class extends Fe{constructor(e){super(e);p(this,"lc_namespace",["langchain_core","runnables"]);p(this,"lc_serializable",!0);p(this,"default");p(this,"branches");this.branches=e.branches,this.default=e.default}static lc_name(){return"RunnableBranch"}static from(e){if(e.length<1)throw new Error("RunnableBranch requires at least one branch");const r=e.slice(0,-1).map(([i,a])=>[Qt(i),Qt(a)]),s=Qt(e[e.length-1]);return new this({branches:r,default:s})}async _invoke(e,n,r){let s;for(let i=0;i<this.branches.length;i+=1){const[a,o]=this.branches[i];if(await a.invoke(e,Xe(n,{callbacks:r==null?void 0:r.getChild(`condition:${i+1}`)}))){s=await o.invoke(e,Xe(n,{callbacks:r==null?void 0:r.getChild(`branch:${i+1}`)}));break}}return s||(s=await this.default.invoke(e,Xe(n,{callbacks:r==null?void 0:r.getChild("branch:default")}))),s}async invoke(e,n={}){return this._callWithConfig(this._invoke,e,n)}async*_streamIterator(e,n){const r=await On(n),s=await(r==null?void 0:r.handleChainStart(this.toJSON(),Dt(e,"input"),n==null?void 0:n.runId,void 0,void 0,void 0,n==null?void 0:n.runName));let i,a=!0,o;try{for(let c=0;c<this.branches.length;c+=1){const[l,u]=this.branches[c];if(await l.invoke(e,Xe(n,{callbacks:s==null?void 0:s.getChild(`condition:${c+1}`)}))){o=await u.stream(e,Xe(n,{callbacks:s==null?void 0:s.getChild(`branch:${c+1}`)}));for await(const h of o)if(yield h,a)if(i===void 0)i=h;else try{i=Hs(i,h)}catch{i=void 0,a=!1}break}}if(o===void 0){o=await this.default.stream(e,Xe(n,{callbacks:s==null?void 0:s.getChild("branch:default")}));for await(const c of o)if(yield c,a)if(i===void 0)i=c;else try{i=Hs(i,c)}catch{i=void 0,a=!1}}}catch(c){throw await(s==null?void 0:s.handleChainError(c)),c}await(s==null?void 0:s.handleChainEnd(i??{}))}},ZD=class extends cn{constructor(e){let n=Kn.from((a,o)=>this._enterHistory(a,o??{})).withConfig({runName:"loadHistory"});const r=e.historyMessagesKey??e.inputMessagesKey;r&&(n=Ci.assign({[r]:n}).withConfig({runName:"insertHistory"}));const s=n.pipe(e.runnable.withListeners({onEnd:(a,o)=>this._exitHistory(a,o??{})})).withConfig({runName:"RunnableWithMessageHistory"}),i=e.config??{};super({...e,config:i,bound:s});p(this,"runnable");p(this,"inputMessagesKey");p(this,"outputMessagesKey");p(this,"historyMessagesKey");p(this,"getMessageHistory");this.runnable=e.runnable,this.getMessageHistory=e.getMessageHistory,this.inputMessagesKey=e.inputMessagesKey,this.outputMessagesKey=e.outputMessagesKey,this.historyMessagesKey=e.historyMessagesKey}_getInputMessages(e){let n;if(typeof e=="object"&&!Array.isArray(e)&&!Yt(e)){let r;this.inputMessagesKey?r=this.inputMessagesKey:Object.keys(e).length===1?r=Object.keys(e)[0]:r="input",Array.isArray(e[r])&&Array.isArray(e[r][0])?n=e[r][0]:n=e[r]}else n=e;if(typeof n=="string")return[new ht(n)];if(Array.isArray(n))return n;if(Yt(n))return[n];throw new Error(`Expected a string, BaseMessage, or array of BaseMessages.
Got ${JSON.stringify(n,null,2)}`)}_getOutputMessages(e){let n;if(!Array.isArray(e)&&!Yt(e)&&typeof e!="string"){let r;this.outputMessagesKey!==void 0?r=this.outputMessagesKey:Object.keys(e).length===1?r=Object.keys(e)[0]:r="output",e.generations!==void 0?n=e.generations[0][0].message:n=e[r]}else n=e;if(typeof n=="string")return[new le(n)];if(Array.isArray(n))return n;if(Yt(n))return[n];throw new Error(`Expected a string, BaseMessage, or array of BaseMessages. Received: ${JSON.stringify(n,null,2)}`)}async _enterHistory(e,n){var i;const s=await((i=n==null?void 0:n.configurable)==null?void 0:i.messageHistory).getMessages();return this.historyMessagesKey===void 0?s.concat(this._getInputMessages(e)):s}async _exitHistory(e,n){var c;const r=(c=n.configurable)==null?void 0:c.messageHistory;let s;Array.isArray(e.inputs)&&Array.isArray(e.inputs[0])?s=e.inputs[0]:s=e.inputs;let i=this._getInputMessages(s);if(this.historyMessagesKey===void 0){const l=await r.getMessages();i=i.slice(l.length)}const a=e.outputs;if(!a)throw new Error(`Output values from 'Run' undefined. Run: ${JSON.stringify(e,null,2)}`);const o=this._getOutputMessages(a);await r.addMessages([...i,...o])}async _mergeConfig(...e){const n=await super._mergeConfig(...e);if(!n.configurable||!n.configurable.sessionId){const s={[this.inputMessagesKey??"input"]:"foo"},i={configurable:{sessionId:"123"}};throw new Error(`sessionId is required. Pass it in as part of the config argument to .invoke() or .stream()
eg. chain.invoke(${JSON.stringify(s)}, ${JSON.stringify(i)})`)}const{sessionId:r}=n.configurable;return n.configurable.messageHistory=await this.getMessageHistory(r),n}},LT={};Se(LT,{RouterRunnable:()=>BD,Runnable:()=>Fe,RunnableAssign:()=>dm,RunnableBinding:()=>cn,RunnableBranch:()=>zD,RunnableEach:()=>CM,RunnableLambda:()=>Kn,RunnableMap:()=>Na,RunnableParallel:()=>RM,RunnablePassthrough:()=>Ci,RunnablePick:()=>T0,RunnableRetry:()=>um,RunnableSequence:()=>Jn,RunnableToolLike:()=>vf,RunnableWithFallbacks:()=>E0,RunnableWithMessageHistory:()=>ZD,_coerceToRunnable:()=>Qt,ensureConfig:()=>Ze,getCallbackManagerForConfig:()=>On,mergeConfigs:()=>Zn,patchConfig:()=>Xe,pickRunnableConfigKeys:()=>ps,raceWithSignal:()=>Hr});var dd=class extends Fe{parseResultWithPrompt(t,e,n){return this.parseResult(t,n)}_baseMessageToString(t){return typeof t.content=="string"?t.content:this._baseMessageContentToString(t.content)}_baseMessageContentToString(t){return JSON.stringify(t)}async invoke(t,e){return typeof t=="string"?this._callWithConfig(async(n,r)=>this.parseResult([{text:n}],r==null?void 0:r.callbacks),t,{...e,runType:"parser"}):this._callWithConfig(async(n,r)=>this.parseResult([{message:n,text:this._baseMessageToString(n)}],r==null?void 0:r.callbacks),t,{...e,runType:"parser"})}},mc=class extends dd{parseResult(t,e){return this.parse(t[0].text,e)}async parseWithPrompt(t,e,n){return this.parse(t,n)}_type(){throw new Error("_type not implemented")}},ls=class extends Error{constructor(e,n,r,s=!1){super(e);p(this,"llmOutput");p(this,"observation");p(this,"sendToLLM");if(this.llmOutput=n,this.observation=r,this.sendToLLM=s,s&&(r===void 0||n===void 0))throw new Error("Arguments 'observation' & 'llmOutput' are required if 'sendToLlm' is true");Ou(this,"OUTPUT_PARSING_FAILURE")}},gc=class extends mc{async*_transform(t){for await(const e of t)typeof e=="string"?yield this.parseResult([{text:e}]):yield this.parseResult([{message:e,text:this._baseMessageToString(e)}])}async*transform(t,e){yield*this._transformStreamWithConfig(t,this._transform.bind(this),{...e,runType:"parser"})}},yc=class extends gc{constructor(e){super(e);p(this,"diff",!1);this.diff=(e==null?void 0:e.diff)??this.diff}async*_transform(e){let n,r;for await(const s of e){if(typeof s!="string"&&typeof s.content!="string")throw new Error("Cannot handle non-string output.");let i;if(vo(s)){if(typeof s.content!="string")throw new Error("Cannot handle non-string message output.");i=new ms({message:s,text:s.content})}else if(Yt(s)){if(typeof s.content!="string")throw new Error("Cannot handle non-string message output.");i=new ms({message:Dl(s),text:s.content})}else i=new ga({text:s});r===void 0?r=i:r=r.concat(i);const a=await this.parsePartialResult([r]);a!=null&&!Ei(a,n)&&(this.diff?yield this._diff(n,a):yield a,n=a)}}getFormatInstructions(){return""}},jT={};Se(jT,{applyPatch:()=>ma,compare:()=>Du});var Uf=class extends yc{constructor(){super(...arguments);p(this,"lc_namespace",["langchain_core","output_parsers"]);p(this,"lc_serializable",!0)}static lc_name(){return"JsonOutputParser"}_concatOutputChunks(e,n){return this.diff?super._concatOutputChunks(e,n):n}_diff(e,n){if(n)return e?Du(e,n):[{op:"replace",path:"",value:n}]}async parsePartialResult(e){return Dh(e[0].text)}async parse(e){return Dh(e,JSON.parse)}getFormatInstructions(){return""}},VD=class extends gc{constructor(){super(...arguments);p(this,"lc_namespace",["langchain_core","output_parsers","bytes"]);p(this,"lc_serializable",!0);p(this,"textEncoder",new TextEncoder)}static lc_name(){return"BytesOutputParser"}parse(e){return Promise.resolve(this.textEncoder.encode(e))}getFormatInstructions(){return""}},_c=class extends gc{constructor(){super(...arguments);p(this,"re")}async*_transform(e){let n="";for await(const r of e)if(typeof r=="string"?n+=r:n+=r.content,this.re){const s=[...n.matchAll(this.re)];if(s.length>1){let i=0;for(const a of s.slice(0,-1))yield[a[1]],i+=(a.index??0)+a[0].length;n=n.slice(i)}}else{const s=await this.parse(n);if(s.length>1){for(const i of s.slice(0,-1))yield[i];n=s[s.length-1]}}for(const r of await this.parse(n))yield[r]}},GD=class extends _c{constructor(){super(...arguments);p(this,"lc_namespace",["langchain_core","output_parsers","list"]);p(this,"lc_serializable",!0)}static lc_name(){return"CommaSeparatedListOutputParser"}async parse(e){try{return e.trim().split(",").map(n=>n.trim())}catch{throw new ls(`Could not parse output: ${e}`,e)}}getFormatInstructions(){return"Your response should be a list of comma separated values, eg: `foo, bar, baz`"}},WD=class extends _c{constructor({length:e,separator:n}){super(...arguments);p(this,"lc_namespace",["langchain_core","output_parsers","list"]);p(this,"length");p(this,"separator");this.length=e,this.separator=n||","}async parse(e){try{const n=e.trim().split(this.separator).map(r=>r.trim());if(this.length!==void 0&&n.length!==this.length)throw new ls(`Incorrect number of items. Expected ${this.length}, got ${n.length}.`);return n}catch(n){throw Object.getPrototypeOf(n)===ls.prototype?n:new ls(`Could not parse output: ${e}`)}}getFormatInstructions(){return`Your response should be a list of ${this.length===void 0?"":`${this.length} `}items separated by "${this.separator}" (eg: \`foo${this.separator} bar${this.separator} baz\`)`}},HD=class extends _c{constructor(){super(...arguments);p(this,"lc_namespace",["langchain_core","output_parsers","list"]);p(this,"lc_serializable",!0);p(this,"re",/\d+\.\s([^\n]+)/g)}static lc_name(){return"NumberedListOutputParser"}getFormatInstructions(){return`Your response should be a numbered list with each item on a new line. For example: 

1. foo

2. bar

3. baz`}async parse(e){return[...e.matchAll(this.re)??[]].map(n=>n[1])}},qD=class extends _c{constructor(){super(...arguments);p(this,"lc_namespace",["langchain_core","output_parsers","list"]);p(this,"lc_serializable",!0);p(this,"re",/^\s*[-*]\s([^\n]+)$/gm)}static lc_name(){return"NumberedListOutputParser"}getFormatInstructions(){return`Your response should be a numbered list with each item on a new line. For example: 

1. foo

2. bar

3. baz`}async parse(e){return[...e.matchAll(this.re)??[]].map(n=>n[1])}},JD=class extends gc{constructor(){super(...arguments);p(this,"lc_namespace",["langchain_core","output_parsers","string"]);p(this,"lc_serializable",!0)}static lc_name(){return"StrOutputParser"}parse(e){return Promise.resolve(e)}getFormatInstructions(){return""}_textContentToString(e){return e.text}_imageUrlContentToString(e){throw new Error('Cannot coerce a multimodal "image_url" message part into a string.')}_messageContentToString(e){switch(e.type){case"text":case"text_delta":if("text"in e)return this._textContentToString(e);break;case"image_url":if("image_url"in e)return this._imageUrlContentToString(e);break;default:throw new Error(`Cannot coerce "${e.type}" message part into a string.`)}throw new Error(`Invalid content type: ${e.type}`)}_baseMessageContentToString(e){return e.reduce((n,r)=>n+this._messageContentToString(r),"")}},pu=class extends mc{constructor(e){super(e);p(this,"lc_namespace",["langchain","output_parsers","structured"]);this.schema=e}static lc_name(){return"StructuredOutputParser"}toJSON(){return this.toJSONNotImplemented()}static fromZodSchema(e){return new this(e)}static fromNamesAndDescriptions(e){const n=Ve(Object.fromEntries(Object.entries(e).map(([r,s])=>[r,Ue().describe(s)])));return new this(n)}getFormatInstructions(){return`You must format your output as a JSON value that adheres to a given "JSON Schema" instance.

"JSON Schema" is a declarative language that allows you to annotate and validate JSON documents.

For example, the example "JSON Schema" instance {{"properties": {{"foo": {{"description": "a list of test words", "type": "array", "items": {{"type": "string"}}}}}}, "required": ["foo"]}}
would match an object with one required property, "foo". The "type" property specifies "foo" must be an "array", and the "description" property semantically describes it as "a list of test words". The items within "foo" must be strings.
Thus, the object {{"foo": ["bar", "baz"]}} is a well-formatted instance of this example "JSON Schema". The object {{"properties": {{"foo": ["bar", "baz"]}}}} is not well-formatted.

Your output will be parsed and type-checked according to the provided schema instance, so make sure all fields in your output match the schema exactly and there are no trailing commas!

Here is the JSON Schema instance your output must adhere to. Include the enclosing markdown codeblock:
\`\`\`json
${JSON.stringify(bt(this.schema))}
\`\`\`
`}async parse(e){var n,r;try{const s=e.trim(),a=(((n=s.match(/^```(?:json)?\s*([\s\S]*?)```/))==null?void 0:n[1])||((r=s.match(/```json\s*([\s\S]*?)```/))==null?void 0:r[1])||s).replace(/"([^"\\]*(\\.[^"\\]*)*)"/g,(o,c)=>`"${c.replace(/\n/g,"\\n")}"`).replace(/\n/g,"");return await Zu(this.schema,JSON.parse(a))}catch(s){throw new ls(`Failed to parse. Text: "${e}". Error: ${s}`,e)}}},DT=class extends pu{static lc_name(){return"JsonMarkdownStructuredOutputParser"}getFormatInstructions(t){const e=(t==null?void 0:t.interpolationDepth)??1;if(e<1)throw new Error("f string interpolation depth must be at least 1");return`Return a markdown code snippet with a JSON object formatted to look like:
\`\`\`json
${this._schemaToInstruction(bt(this.schema)).replaceAll("{","{".repeat(e)).replaceAll("}","}".repeat(e))}
\`\`\``}_schemaToInstruction(t,e=2){const n=t;if("type"in n){let r=!1,s;if(Array.isArray(n.type)){const o=n.type.findIndex(c=>c==="null");o!==-1&&(r=!0,n.type.splice(o,1)),s=n.type.join(" | ")}else s=n.type;if(n.type==="object"&&n.properties){const o=n.description?` // ${n.description}`:"";return`{
${Object.entries(n.properties).map(([l,u])=>{var h;const d=(h=n.required)!=null&&h.includes(l)?"":" (optional)";return`${" ".repeat(e)}"${l}": ${this._schemaToInstruction(u,e+2)}${d}`}).join(`
`)}
${" ".repeat(e-2)}}${o}`}if(n.type==="array"&&n.items){const o=n.description?` // ${n.description}`:"";return`array[
${" ".repeat(e)}${this._schemaToInstruction(n.items,e+2)}
${" ".repeat(e-2)}] ${o}`}const i=r?" (nullable)":"",a=n.description?` // ${n.description}`:"";return`${s}${a}${i}`}if("anyOf"in n)return n.anyOf.map(r=>this._schemaToInstruction(r,e)).join(`
${" ".repeat(e-2)}`);throw new Error("unsupported schema type")}static fromZodSchema(t){return new this(t)}static fromNamesAndDescriptions(t){const e=Ve(Object.fromEntries(Object.entries(t).map(([n,r])=>[n,Ue().describe(r)])));return new this(e)}},KD=class extends mc{constructor({inputSchema:e}){super(...arguments);p(this,"structuredInputParser");this.structuredInputParser=new DT(e)}async parse(e){let n;try{n=await this.structuredInputParser.parse(e)}catch(r){throw new ls(`Failed to parse. Text: "${e}". Error: ${r}`,e)}return this.outputProcessor(n)}getFormatInstructions(){return this.structuredInputParser.getFormatInstructions()}};const XD=function(){const t={};t.parser=function(C,x){return new n(C,x)},t.SAXParser=n,t.SAXStream=l,t.createStream=c,t.MAX_BUFFER_LENGTH=64*1024;const e=["comment","sgmlDecl","textNode","tagName","doctype","procInstName","procInstBody","entity","attribName","attribValue","cdata","script"];t.EVENTS=["text","processinginstruction","sgmldeclaration","doctype","comment","opentagstart","attribute","opentag","closetag","opencdata","cdata","closecdata","error","end","ready","script","opennamespace","closenamespace"];function n(C,x){if(!(this instanceof n))return new n(C,x);var F=this;s(F),F.q=F.c="",F.bufferCheckPosition=t.MAX_BUFFER_LENGTH,F.opt=x||{},F.opt.lowercase=F.opt.lowercase||F.opt.lowercasetags,F.looseCase=F.opt.lowercase?"toLowerCase":"toUpperCase",F.tags=[],F.closed=F.closedRoot=F.sawRoot=!1,F.tag=F.error=null,F.strict=!!C,F.noscript=!!(C||F.opt.noscript),F.state=S.BEGIN,F.strictEntities=F.opt.strictEntities,F.ENTITIES=F.strictEntities?Object.create(t.XML_ENTITIES):Object.create(t.ENTITIES),F.attribList=[],F.opt.xmlns&&(F.ns=Object.create(m)),F.trackPosition=F.opt.position!==!1,F.trackPosition&&(F.position=F.line=F.column=0),j(F,"onready")}Object.create||(Object.create=function(C){function x(){}x.prototype=C;var F=new x;return F}),Object.keys||(Object.keys=function(C){var x=[];for(var F in C)C.hasOwnProperty(F)&&x.push(F);return x});function r(C){for(var x=Math.max(t.MAX_BUFFER_LENGTH,10),F=0,N=0,Oe=e.length;N<Oe;N++){var Me=C[e[N]].length;if(Me>x)switch(e[N]){case"textNode":W(C);break;case"cdata":P(C,"oncdata",C.cdata),C.cdata="";break;case"script":P(C,"onscript",C.script),C.script="";break;default:B(C,"Max buffer length exceeded: "+e[N])}F=Math.max(F,Me)}var Ke=t.MAX_BUFFER_LENGTH-F;C.bufferCheckPosition=Ke+C.position}function s(C){for(var x=0,F=e.length;x<F;x++)C[e[x]]=""}function i(C){W(C),C.cdata!==""&&(P(C,"oncdata",C.cdata),C.cdata=""),C.script!==""&&(P(C,"onscript",C.script),C.script="")}n.prototype={end:function(){V(this)},write:X,resume:function(){return this.error=null,this},close:function(){return this.write(null)},flush:function(){i(this)}};var a=ReadableStream;a||(a=function(){});var o=t.EVENTS.filter(function(C){return C!=="error"&&C!=="end"});function c(C,x){return new l(C,x)}function l(C,x){if(!(this instanceof l))return new l(C,x);a.apply(this),this._parser=new n(C,x),this.writable=!0,this.readable=!0;var F=this;this._parser.onend=function(){F.emit("end")},this._parser.onerror=function(N){F.emit("error",N),F._parser.error=null},this._decoder=null,o.forEach(function(N){Object.defineProperty(F,"on"+N,{get:function(){return F._parser["on"+N]},set:function(Oe){if(!Oe)return F.removeAllListeners(N),F._parser["on"+N]=Oe,Oe;F.on(N,Oe)},enumerable:!0,configurable:!1})})}l.prototype=Object.create(a.prototype,{constructor:{value:l}}),l.prototype.write=function(C){return this._parser.write(C.toString()),this.emit("data",C),!0},l.prototype.end=function(C){return C&&C.length&&this.write(C),this._parser.end(),!0},l.prototype.on=function(C,x){var F=this;return!F._parser["on"+C]&&o.indexOf(C)!==-1&&(F._parser["on"+C]=function(){var N=arguments.length===1?[arguments[0]]:Array.apply(null,arguments);N.splice(0,0,C),F.emit.apply(F,N)}),a.prototype.on.call(F,C,x)};var u="[CDATA[",d="DOCTYPE",h="http://www.w3.org/XML/1998/namespace",f="http://www.w3.org/2000/xmlns/",m={xml:h,xmlns:f},g=/[:_A-Za-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD]/,w=/[:_A-Za-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\u00B7\u0300-\u036F\u203F-\u2040.\d-]/,b=/[#:_A-Za-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD]/,y=/[#:_A-Za-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\u00B7\u0300-\u036F\u203F-\u2040.\d-]/;function v(C){return C===" "||C===`
`||C==="\r"||C==="	"}function T(C){return C==='"'||C==="'"}function A(C){return C===">"||v(C)}function I(C,x){return C.test(x)}function $(C,x){return!I(C,x)}var S=0;t.STATE={BEGIN:S++,BEGIN_WHITESPACE:S++,TEXT:S++,TEXT_ENTITY:S++,OPEN_WAKA:S++,SGML_DECL:S++,SGML_DECL_QUOTED:S++,DOCTYPE:S++,DOCTYPE_QUOTED:S++,DOCTYPE_DTD:S++,DOCTYPE_DTD_QUOTED:S++,COMMENT_STARTING:S++,COMMENT:S++,COMMENT_ENDING:S++,COMMENT_ENDED:S++,CDATA:S++,CDATA_ENDING:S++,CDATA_ENDING_2:S++,PROC_INST:S++,PROC_INST_BODY:S++,PROC_INST_ENDING:S++,OPEN_TAG:S++,OPEN_TAG_SLASH:S++,ATTRIB:S++,ATTRIB_NAME:S++,ATTRIB_NAME_SAW_WHITE:S++,ATTRIB_VALUE:S++,ATTRIB_VALUE_QUOTED:S++,ATTRIB_VALUE_CLOSED:S++,ATTRIB_VALUE_UNQUOTED:S++,ATTRIB_VALUE_ENTITY_Q:S++,ATTRIB_VALUE_ENTITY_U:S++,CLOSE_TAG:S++,CLOSE_TAG_SAW_WHITE:S++,SCRIPT:S++,SCRIPT_ENDING:S++},t.XML_ENTITIES={amp:"&",gt:">",lt:"<",quot:'"',apos:"'"},t.ENTITIES={amp:"&",gt:">",lt:"<",quot:'"',apos:"'",AElig:198,Aacute:193,Acirc:194,Agrave:192,Aring:197,Atilde:195,Auml:196,Ccedil:199,ETH:208,Eacute:201,Ecirc:202,Egrave:200,Euml:203,Iacute:205,Icirc:206,Igrave:204,Iuml:207,Ntilde:209,Oacute:211,Ocirc:212,Ograve:210,Oslash:216,Otilde:213,Ouml:214,THORN:222,Uacute:218,Ucirc:219,Ugrave:217,Uuml:220,Yacute:221,aacute:225,acirc:226,aelig:230,agrave:224,aring:229,atilde:227,auml:228,ccedil:231,eacute:233,ecirc:234,egrave:232,eth:240,euml:235,iacute:237,icirc:238,igrave:236,iuml:239,ntilde:241,oacute:243,ocirc:244,ograve:242,oslash:248,otilde:245,ouml:246,szlig:223,thorn:254,uacute:250,ucirc:251,ugrave:249,uuml:252,yacute:253,yuml:255,copy:169,reg:174,nbsp:160,iexcl:161,cent:162,pound:163,curren:164,yen:165,brvbar:166,sect:167,uml:168,ordf:170,laquo:171,not:172,shy:173,macr:175,deg:176,plusmn:177,sup1:185,sup2:178,sup3:179,acute:180,micro:181,para:182,middot:183,cedil:184,ordm:186,raquo:187,frac14:188,frac12:189,frac34:190,iquest:191,times:215,divide:247,OElig:338,oelig:339,Scaron:352,scaron:353,Yuml:376,fnof:402,circ:710,tilde:732,Alpha:913,Beta:914,Gamma:915,Delta:916,Epsilon:917,Zeta:918,Eta:919,Theta:920,Iota:921,Kappa:922,Lambda:923,Mu:924,Nu:925,Xi:926,Omicron:927,Pi:928,Rho:929,Sigma:931,Tau:932,Upsilon:933,Phi:934,Chi:935,Psi:936,Omega:937,alpha:945,beta:946,gamma:947,delta:948,epsilon:949,zeta:950,eta:951,theta:952,iota:953,kappa:954,lambda:955,mu:956,nu:957,xi:958,omicron:959,pi:960,rho:961,sigmaf:962,sigma:963,tau:964,upsilon:965,phi:966,chi:967,psi:968,omega:969,thetasym:977,upsih:978,piv:982,ensp:8194,emsp:8195,thinsp:8201,zwnj:8204,zwj:8205,lrm:8206,rlm:8207,ndash:8211,mdash:8212,lsquo:8216,rsquo:8217,sbquo:8218,ldquo:8220,rdquo:8221,bdquo:8222,dagger:8224,Dagger:8225,bull:8226,hellip:8230,permil:8240,prime:8242,Prime:8243,lsaquo:8249,rsaquo:8250,oline:8254,frasl:8260,euro:8364,image:8465,weierp:8472,real:8476,trade:8482,alefsym:8501,larr:8592,uarr:8593,rarr:8594,darr:8595,harr:8596,crarr:8629,lArr:8656,uArr:8657,rArr:8658,dArr:8659,hArr:8660,forall:8704,part:8706,exist:8707,empty:8709,nabla:8711,isin:8712,notin:8713,ni:8715,prod:8719,sum:8721,minus:8722,lowast:8727,radic:8730,prop:8733,infin:8734,ang:8736,and:8743,or:8744,cap:8745,cup:8746,int:8747,there4:8756,sim:8764,cong:8773,asymp:8776,ne:8800,equiv:8801,le:8804,ge:8805,sub:8834,sup:8835,nsub:8836,sube:8838,supe:8839,oplus:8853,otimes:8855,perp:8869,sdot:8901,lceil:8968,rceil:8969,lfloor:8970,rfloor:8971,lang:9001,rang:9002,loz:9674,spades:9824,clubs:9827,hearts:9829,diams:9830},Object.keys(t.ENTITIES).forEach(function(C){var x=t.ENTITIES[C],F=typeof x=="number"?String.fromCharCode(x):x;t.ENTITIES[C]=F});for(var M in t.STATE)t.STATE[t.STATE[M]]=M;S=t.STATE;function j(C,x,F){C[x]&&C[x](F)}function P(C,x,F){C.textNode&&W(C),j(C,x,F)}function W(C){C.textNode=ne(C.opt,C.textNode),C.textNode&&j(C,"ontext",C.textNode),C.textNode=""}function ne(C,x){return C.trim&&(x=x.trim()),C.normalize&&(x=x.replace(/\s+/g," ")),x}function B(C,x){return W(C),C.trackPosition&&(x+=`
Line: `+C.line+`
Column: `+C.column+`
Char: `+C.c),x=new Error(x),C.error=x,j(C,"onerror",x),C}function V(C){return C.sawRoot&&!C.closedRoot&&H(C,"Unclosed root tag"),C.state!==S.BEGIN&&C.state!==S.BEGIN_WHITESPACE&&C.state!==S.TEXT&&B(C,"Unexpected end"),W(C),C.c="",C.closed=!0,j(C,"onend"),n.call(C,C.strict,C.opt),C}function H(C,x){if(typeof C!="object"||!(C instanceof n))throw new Error("bad call to strictFail");C.strict&&B(C,x)}function oe(C){C.strict||(C.tagName=C.tagName[C.looseCase]());var x=C.tags[C.tags.length-1]||C,F=C.tag={name:C.tagName,attributes:{}};C.opt.xmlns&&(F.ns=x.ns),C.attribList.length=0,P(C,"onopentagstart",F)}function fe(C,x){var F=C.indexOf(":"),N=F<0?["",C]:C.split(":"),Oe=N[0],Me=N[1];return x&&C==="xmlns"&&(Oe="xmlns",Me=""),{prefix:Oe,local:Me}}function se(C){if(C.strict||(C.attribName=C.attribName[C.looseCase]()),C.attribList.indexOf(C.attribName)!==-1||C.tag.attributes.hasOwnProperty(C.attribName)){C.attribName=C.attribValue="";return}if(C.opt.xmlns){var x=fe(C.attribName,!0),F=x.prefix,N=x.local;if(F==="xmlns")if(N==="xml"&&C.attribValue!==h)H(C,"xml: prefix must be bound to "+h+`
Actual: `+C.attribValue);else if(N==="xmlns"&&C.attribValue!==f)H(C,"xmlns: prefix must be bound to "+f+`
Actual: `+C.attribValue);else{var Oe=C.tag,Me=C.tags[C.tags.length-1]||C;Oe.ns===Me.ns&&(Oe.ns=Object.create(Me.ns)),Oe.ns[N]=C.attribValue}C.attribList.push([C.attribName,C.attribValue])}else C.tag.attributes[C.attribName]=C.attribValue,P(C,"onattribute",{name:C.attribName,value:C.attribValue});C.attribName=C.attribValue=""}function ye(C,x){if(C.opt.xmlns){var F=C.tag,N=fe(C.tagName);F.prefix=N.prefix,F.local=N.local,F.uri=F.ns[N.prefix]||"",F.prefix&&!F.uri&&(H(C,"Unbound namespace prefix: "+JSON.stringify(C.tagName)),F.uri=N.prefix);var Oe=C.tags[C.tags.length-1]||C;F.ns&&Oe.ns!==F.ns&&Object.keys(F.ns).forEach(function(Jr){P(C,"onopennamespace",{prefix:Jr,uri:F.ns[Jr]})});for(var Me=0,Ke=C.attribList.length;Me<Ke;Me++){var ot=C.attribList[Me],yt=ot[0],qt=ot[1],Qe=fe(yt,!0),Bt=Qe.prefix,Ts=Qe.local,ji=Bt===""?"":F.ns[Bt]||"",Q={name:yt,value:qt,prefix:Bt,local:Ts,uri:ji};Bt&&Bt!=="xmlns"&&!ji&&(H(C,"Unbound namespace prefix: "+JSON.stringify(Bt)),Q.uri=Bt),C.tag.attributes[yt]=Q,P(C,"onattribute",Q)}C.attribList.length=0}C.tag.isSelfClosing=!!x,C.sawRoot=!0,C.tags.push(C.tag),P(C,"onopentag",C.tag),x||(!C.noscript&&C.tagName.toLowerCase()==="script"?C.state=S.SCRIPT:C.state=S.TEXT,C.tag=null,C.tagName=""),C.attribName=C.attribValue="",C.attribList.length=0}function Ne(C){if(!C.tagName){H(C,"Weird empty close tag."),C.textNode+="</>",C.state=S.TEXT;return}if(C.script){if(C.tagName!=="script"){C.script+="</"+C.tagName+">",C.tagName="",C.state=S.SCRIPT;return}P(C,"onscript",C.script),C.script=""}var x=C.tags.length,F=C.tagName;C.strict||(F=F[C.looseCase]());for(var N=F;x--;){var Oe=C.tags[x];if(Oe.name!==N)H(C,"Unexpected close tag");else break}if(x<0){H(C,"Unmatched closing tag: "+C.tagName),C.textNode+="</"+C.tagName+">",C.state=S.TEXT;return}C.tagName=F;for(var Me=C.tags.length;Me-- >x;){var Ke=C.tag=C.tags.pop();C.tagName=C.tag.name,P(C,"onclosetag",C.tagName);var ot={};for(var yt in Ke.ns)ot[yt]=Ke.ns[yt];var qt=C.tags[C.tags.length-1]||C;C.opt.xmlns&&Ke.ns!==qt.ns&&Object.keys(Ke.ns).forEach(function(Qe){var Bt=Ke.ns[Qe];P(C,"onclosenamespace",{prefix:Qe,uri:Bt})})}x===0&&(C.closedRoot=!0),C.tagName=C.attribValue=C.attribName="",C.attribList.length=0,C.state=S.TEXT}function K(C){var x=C.entity,F=x.toLowerCase(),N,Oe="";return C.ENTITIES[x]?C.ENTITIES[x]:C.ENTITIES[F]?C.ENTITIES[F]:(x=F,x.charAt(0)==="#"&&(x.charAt(1)==="x"?(x=x.slice(2),N=parseInt(x,16),Oe=N.toString(16)):(x=x.slice(1),N=parseInt(x,10),Oe=N.toString(10))),x=x.replace(/^0+/,""),isNaN(N)||Oe.toLowerCase()!==x?(H(C,"Invalid character entity"),"&"+C.entity+";"):String.fromCodePoint(N))}function re(C,x){x==="<"?(C.state=S.OPEN_WAKA,C.startTagPosition=C.position):v(x)||(H(C,"Non-whitespace before first tag."),C.textNode=x,C.state=S.TEXT)}function de(C,x){var F="";return x<C.length&&(F=C.charAt(x)),F}function X(C){var x=this;if(this.error)throw this.error;if(x.closed)return B(x,"Cannot write after close. Assign an onready handler.");if(C===null)return V(x);typeof C=="object"&&(C=C.toString());for(var F=0,N="";N=de(C,F++),x.c=N,!!N;)switch(x.trackPosition&&(x.position++,N===`
`?(x.line++,x.column=0):x.column++),x.state){case S.BEGIN:if(x.state=S.BEGIN_WHITESPACE,N==="\uFEFF")continue;re(x,N);continue;case S.BEGIN_WHITESPACE:re(x,N);continue;case S.TEXT:if(x.sawRoot&&!x.closedRoot){for(var Oe=F-1;N&&N!=="<"&&N!=="&";)N=de(C,F++),N&&x.trackPosition&&(x.position++,N===`
`?(x.line++,x.column=0):x.column++);x.textNode+=C.substring(Oe,F-1)}N==="<"&&!(x.sawRoot&&x.closedRoot&&!x.strict)?(x.state=S.OPEN_WAKA,x.startTagPosition=x.position):(!v(N)&&(!x.sawRoot||x.closedRoot)&&H(x,"Text data outside of root node."),N==="&"?x.state=S.TEXT_ENTITY:x.textNode+=N);continue;case S.SCRIPT:N==="<"?x.state=S.SCRIPT_ENDING:x.script+=N;continue;case S.SCRIPT_ENDING:N==="/"?x.state=S.CLOSE_TAG:(x.script+="<"+N,x.state=S.SCRIPT);continue;case S.OPEN_WAKA:if(N==="!")x.state=S.SGML_DECL,x.sgmlDecl="";else if(!v(N))if(I(g,N))x.state=S.OPEN_TAG,x.tagName=N;else if(N==="/")x.state=S.CLOSE_TAG,x.tagName="";else if(N==="?")x.state=S.PROC_INST,x.procInstName=x.procInstBody="";else{if(H(x,"Unencoded <"),x.startTagPosition+1<x.position){var Me=x.position-x.startTagPosition;N=new Array(Me).join(" ")+N}x.textNode+="<"+N,x.state=S.TEXT}continue;case S.SGML_DECL:(x.sgmlDecl+N).toUpperCase()===u?(P(x,"onopencdata"),x.state=S.CDATA,x.sgmlDecl="",x.cdata=""):x.sgmlDecl+N==="--"?(x.state=S.COMMENT,x.comment="",x.sgmlDecl=""):(x.sgmlDecl+N).toUpperCase()===d?(x.state=S.DOCTYPE,(x.doctype||x.sawRoot)&&H(x,"Inappropriately located doctype declaration"),x.doctype="",x.sgmlDecl=""):N===">"?(P(x,"onsgmldeclaration",x.sgmlDecl),x.sgmlDecl="",x.state=S.TEXT):(T(N)&&(x.state=S.SGML_DECL_QUOTED),x.sgmlDecl+=N);continue;case S.SGML_DECL_QUOTED:N===x.q&&(x.state=S.SGML_DECL,x.q=""),x.sgmlDecl+=N;continue;case S.DOCTYPE:N===">"?(x.state=S.TEXT,P(x,"ondoctype",x.doctype),x.doctype=!0):(x.doctype+=N,N==="["?x.state=S.DOCTYPE_DTD:T(N)&&(x.state=S.DOCTYPE_QUOTED,x.q=N));continue;case S.DOCTYPE_QUOTED:x.doctype+=N,N===x.q&&(x.q="",x.state=S.DOCTYPE);continue;case S.DOCTYPE_DTD:x.doctype+=N,N==="]"?x.state=S.DOCTYPE:T(N)&&(x.state=S.DOCTYPE_DTD_QUOTED,x.q=N);continue;case S.DOCTYPE_DTD_QUOTED:x.doctype+=N,N===x.q&&(x.state=S.DOCTYPE_DTD,x.q="");continue;case S.COMMENT:N==="-"?x.state=S.COMMENT_ENDING:x.comment+=N;continue;case S.COMMENT_ENDING:N==="-"?(x.state=S.COMMENT_ENDED,x.comment=ne(x.opt,x.comment),x.comment&&P(x,"oncomment",x.comment),x.comment=""):(x.comment+="-"+N,x.state=S.COMMENT);continue;case S.COMMENT_ENDED:N!==">"?(H(x,"Malformed comment"),x.comment+="--"+N,x.state=S.COMMENT):x.state=S.TEXT;continue;case S.CDATA:N==="]"?x.state=S.CDATA_ENDING:x.cdata+=N;continue;case S.CDATA_ENDING:N==="]"?x.state=S.CDATA_ENDING_2:(x.cdata+="]"+N,x.state=S.CDATA);continue;case S.CDATA_ENDING_2:N===">"?(x.cdata&&P(x,"oncdata",x.cdata),P(x,"onclosecdata"),x.cdata="",x.state=S.TEXT):N==="]"?x.cdata+="]":(x.cdata+="]]"+N,x.state=S.CDATA);continue;case S.PROC_INST:N==="?"?x.state=S.PROC_INST_ENDING:v(N)?x.state=S.PROC_INST_BODY:x.procInstName+=N;continue;case S.PROC_INST_BODY:if(!x.procInstBody&&v(N))continue;N==="?"?x.state=S.PROC_INST_ENDING:x.procInstBody+=N;continue;case S.PROC_INST_ENDING:N===">"?(P(x,"onprocessinginstruction",{name:x.procInstName,body:x.procInstBody}),x.procInstName=x.procInstBody="",x.state=S.TEXT):(x.procInstBody+="?"+N,x.state=S.PROC_INST_BODY);continue;case S.OPEN_TAG:I(w,N)?x.tagName+=N:(oe(x),N===">"?ye(x):N==="/"?x.state=S.OPEN_TAG_SLASH:(v(N)||H(x,"Invalid character in tag name"),x.state=S.ATTRIB));continue;case S.OPEN_TAG_SLASH:N===">"?(ye(x,!0),Ne(x)):(H(x,"Forward-slash in opening tag not followed by >"),x.state=S.ATTRIB);continue;case S.ATTRIB:if(v(N))continue;N===">"?ye(x):N==="/"?x.state=S.OPEN_TAG_SLASH:I(g,N)?(x.attribName=N,x.attribValue="",x.state=S.ATTRIB_NAME):H(x,"Invalid attribute name");continue;case S.ATTRIB_NAME:N==="="?x.state=S.ATTRIB_VALUE:N===">"?(H(x,"Attribute without value"),x.attribValue=x.attribName,se(x),ye(x)):v(N)?x.state=S.ATTRIB_NAME_SAW_WHITE:I(w,N)?x.attribName+=N:H(x,"Invalid attribute name");continue;case S.ATTRIB_NAME_SAW_WHITE:if(N==="=")x.state=S.ATTRIB_VALUE;else{if(v(N))continue;H(x,"Attribute without value"),x.tag.attributes[x.attribName]="",x.attribValue="",P(x,"onattribute",{name:x.attribName,value:""}),x.attribName="",N===">"?ye(x):I(g,N)?(x.attribName=N,x.state=S.ATTRIB_NAME):(H(x,"Invalid attribute name"),x.state=S.ATTRIB)}continue;case S.ATTRIB_VALUE:if(v(N))continue;T(N)?(x.q=N,x.state=S.ATTRIB_VALUE_QUOTED):(H(x,"Unquoted attribute value"),x.state=S.ATTRIB_VALUE_UNQUOTED,x.attribValue=N);continue;case S.ATTRIB_VALUE_QUOTED:if(N!==x.q){N==="&"?x.state=S.ATTRIB_VALUE_ENTITY_Q:x.attribValue+=N;continue}se(x),x.q="",x.state=S.ATTRIB_VALUE_CLOSED;continue;case S.ATTRIB_VALUE_CLOSED:v(N)?x.state=S.ATTRIB:N===">"?ye(x):N==="/"?x.state=S.OPEN_TAG_SLASH:I(g,N)?(H(x,"No whitespace between attributes"),x.attribName=N,x.attribValue="",x.state=S.ATTRIB_NAME):H(x,"Invalid attribute name");continue;case S.ATTRIB_VALUE_UNQUOTED:if(!A(N)){N==="&"?x.state=S.ATTRIB_VALUE_ENTITY_U:x.attribValue+=N;continue}se(x),N===">"?ye(x):x.state=S.ATTRIB;continue;case S.CLOSE_TAG:if(x.tagName)N===">"?Ne(x):I(w,N)?x.tagName+=N:x.script?(x.script+="</"+x.tagName,x.tagName="",x.state=S.SCRIPT):(v(N)||H(x,"Invalid tagname in closing tag"),x.state=S.CLOSE_TAG_SAW_WHITE);else{if(v(N))continue;$(g,N)?x.script?(x.script+="</"+N,x.state=S.SCRIPT):H(x,"Invalid tagname in closing tag."):x.tagName=N}continue;case S.CLOSE_TAG_SAW_WHITE:if(v(N))continue;N===">"?Ne(x):H(x,"Invalid characters in closing tag");continue;case S.TEXT_ENTITY:case S.ATTRIB_VALUE_ENTITY_Q:case S.ATTRIB_VALUE_ENTITY_U:var Ke,ot;switch(x.state){case S.TEXT_ENTITY:Ke=S.TEXT,ot="textNode";break;case S.ATTRIB_VALUE_ENTITY_Q:Ke=S.ATTRIB_VALUE_QUOTED,ot="attribValue";break;case S.ATTRIB_VALUE_ENTITY_U:Ke=S.ATTRIB_VALUE_UNQUOTED,ot="attribValue";break}if(N===";")if(x.opt.unparsedEntities){var yt=K(x);x.entity="",x.state=Ke,x.write(yt)}else x[ot]+=K(x),x.entity="",x.state=Ke;else I(x.entity.length?y:b,N)?x.entity+=N:(H(x,"Invalid character in entity name"),x[ot]+="&"+x.entity+N,x.entity="",x.state=Ke);continue;default:throw new Error(x,"Unknown state: "+x.state)}return x.position>=x.bufferCheckPosition&&r(x),x}/*! http://mths.be/fromcodepoint v0.1.0 by @mathias */return String.fromCodePoint||function(){var C=String.fromCharCode,x=Math.floor,F=function(){var N=16384,Oe=[],Me,Ke,ot=-1,yt=arguments.length;if(!yt)return"";for(var qt="";++ot<yt;){var Qe=Number(arguments[ot]);if(!isFinite(Qe)||Qe<0||Qe>1114111||x(Qe)!==Qe)throw RangeError("Invalid code point: "+Qe);Qe<=65535?Oe.push(Qe):(Qe-=65536,Me=(Qe>>10)+55296,Ke=Qe%1024+56320,Oe.push(Me,Ke)),(ot+1===yt||Oe.length>N)&&(qt+=C.apply(null,Oe),Oe.length=0)}return qt};Object.defineProperty?Object.defineProperty(String,"fromCodePoint",{value:F,configurable:!0,writable:!0}):String.fromCodePoint=F}(),t},YD=XD(),Ff=`The output should be formatted as a XML file.
1. Output should conform to the tags below. 
2. If tags are not given, make them on your own.
3. Remember to always open and close all the tags.

As an example, for the tags ["foo", "bar", "baz"]:
1. String "<foo>
   <bar>
      <baz></baz>
   </bar>
</foo>" is a well-formatted instance of the schema. 
2. String "<foo>
   <bar>
   </foo>" is a badly-formatted instance.
3. String "<foo>
   <tag>
   </tag>
</foo>" is a badly-formatted instance.

Here are the output tags:
\`\`\`
{tags}
\`\`\``;var QD=class extends yc{constructor(e){super(e);p(this,"tags");p(this,"lc_namespace",["langchain_core","output_parsers"]);p(this,"lc_serializable",!0);this.tags=e==null?void 0:e.tags}static lc_name(){return"XMLOutputParser"}_diff(e,n){if(n)return e?Du(e,n):[{op:"replace",path:"",value:n}]}async parsePartialResult(e){return Bf(e[0].text)}async parse(e){return Bf(e)}getFormatInstructions(){var n;return!!(this.tags&&this.tags.length>0)?Ff.replace("{tags}",((n=this.tags)==null?void 0:n.join(", "))??""):Ff}};const eU=t=>t.split(`
`).map(e=>e.replace(/^\s+/,"")).join(`
`).trim(),UT=t=>{if(Object.keys(t).length===0)return{};const e={};return t.children.length>0?(e[t.name]=t.children.map(UT),e):(e[t.name]=t.text??void 0,e)};function Bf(t){const e=eU(t),n=YD.parser(!0);let r={};const s=[];n.onopentag=o=>{const c={name:o.name,attributes:o.attributes,children:[],text:"",isSelfClosing:o.isSelfClosing};s.length>0?s[s.length-1].children.push(c):r=c,o.isSelfClosing||s.push(c)},n.onclosetag=()=>{if(s.length>0){const o=s.pop();s.length===0&&o&&(r=o)}},n.ontext=o=>{if(s.length>0){const c=s[s.length-1];c.text+=o}},n.onattribute=o=>{if(s.length>0){const c=s[s.length-1];c.attributes[o.name]=o.value}};const i=/```(xml)?(.*)```/s.exec(e),a=i?i[2]:e;return n.write(a).close(),r&&r.name==="?xml"&&(r=r.children[0]),UT(r)}var FT={};Se(FT,{AsymmetricStructuredOutputParser:()=>KD,BaseCumulativeTransformOutputParser:()=>yc,BaseLLMOutputParser:()=>dd,BaseOutputParser:()=>mc,BaseTransformOutputParser:()=>gc,BytesOutputParser:()=>VD,CommaSeparatedListOutputParser:()=>GD,CustomListOutputParser:()=>WD,JsonMarkdownStructuredOutputParser:()=>DT,JsonOutputParser:()=>Uf,ListOutputParser:()=>_c,MarkdownListOutputParser:()=>qD,NumberedListOutputParser:()=>HD,OutputParserException:()=>ls,StringOutputParser:()=>JD,StructuredOutputParser:()=>pu,XMLOutputParser:()=>QD,XML_FORMAT_INSTRUCTIONS:()=>Ff,parseJsonMarkdown:()=>Dh,parsePartialJson:()=>fa,parseXMLMarkdown:()=>Bf});function hd(t,e){if(t.function===void 0)return;let n;if(e!=null&&e.partial)try{n=fa(t.function.arguments??"{}")}catch{return}else try{n=JSON.parse(t.function.arguments)}catch(s){throw new ls([`Function "${t.function.name}" arguments:`,"",t.function.arguments,"","are not valid JSON.",`Error: ${s.message}`].join(`
`))}const r={name:t.function.name,args:n,type:"tool_call"};return e!=null&&e.returnId&&(r.id=t.id),r}function BT(t){if(t.id===void 0)throw new Error('All OpenAI tool calls must have an "id" field.');return{id:t.id,type:"function",function:{name:t.name,arguments:JSON.stringify(t.args)}}}function po(t,e){var n,r;return{name:(n=t.function)==null?void 0:n.name,args:(r=t.function)==null?void 0:r.arguments,id:t.id,error:e,type:"invalid_tool_call"}}var zT=class extends yc{constructor(e){super(e);p(this,"returnId",!1);p(this,"lc_namespace",["langchain","output_parsers","openai_tools"]);p(this,"lc_serializable",!0);this.returnId=(e==null?void 0:e.returnId)??this.returnId}static lc_name(){return"JsonOutputToolsParser"}_diff(){throw new Error("Not supported.")}async parse(){throw new Error("Not implemented.")}async parseResult(e){return await this.parsePartialResult(e,!1)}async parsePartialResult(e,n=!0){var a;const r=e[0].message;let s;if(Ru(r)&&((a=r.tool_calls)!=null&&a.length)?s=r.tool_calls.map(o=>{const{id:c,...l}=o;return this.returnId?{id:c,...l}:l}):r.additional_kwargs.tool_calls!==void 0&&(s=JSON.parse(JSON.stringify(r.additional_kwargs.tool_calls)).map(c=>hd(c,{returnId:this.returnId,partial:n}))),!s)return[];const i=[];for(const o of s)if(o!==void 0){const c={type:o.name,args:o.args,id:o.id};i.push(c)}return i}},zf=class extends zT{constructor(e){super(e);p(this,"lc_namespace",["langchain","output_parsers","openai_tools"]);p(this,"lc_serializable",!0);p(this,"returnId",!1);p(this,"keyName");p(this,"returnSingle",!1);p(this,"zodSchema");this.keyName=e.keyName,this.returnSingle=e.returnSingle??this.returnSingle,this.zodSchema=e.zodSchema}static lc_name(){return"JsonOutputKeyToolsParser"}async _validateResult(e){var r;if(this.zodSchema===void 0)return e;const n=await sm(this.zodSchema,e);if(n.success)return n.data;throw new ls(`Failed to parse. Text: "${JSON.stringify(e,null,2)}". Error: ${JSON.stringify((r=n.error)==null?void 0:r.issues)}`,JSON.stringify(e,null,2))}async parsePartialResult(e){const r=(await super.parsePartialResult(e)).filter(i=>i.type===this.keyName);let s=r;if(r.length)return this.returnId||(s=r.map(i=>i.args)),this.returnSingle?s[0]:s}async parseResult(e){const r=(await super.parsePartialResult(e,!1)).filter(a=>a.type===this.keyName);let s=r;return r.length?(this.returnId||(s=r.map(a=>a.args)),this.returnSingle?this._validateResult(s[0]):await Promise.all(s.map(a=>this._validateResult(a)))):void 0}},ZT={};Se(ZT,{JsonOutputKeyToolsParser:()=>zf,JsonOutputToolsParser:()=>zT,convertLangChainToolCallToOpenAI:()=>BT,makeInvalidToolCall:()=>po,parseToolCall:()=>hd});var qm=class extends Qs{constructor(e){var r,s,i,a;super(e??{});p(this,"temperature");p(this,"topP");p(this,"frequencyPenalty");p(this,"presencePenalty");p(this,"n");p(this,"logitBias");p(this,"model","gpt-3.5-turbo");p(this,"modelKwargs");p(this,"stop");p(this,"stopSequences");p(this,"user");p(this,"timeout");p(this,"streaming",!1);p(this,"streamUsage",!0);p(this,"maxTokens");p(this,"logprobs");p(this,"topLogprobs");p(this,"apiKey");p(this,"organization");p(this,"__includeRawResponse");p(this,"client");p(this,"clientConfig");p(this,"supportsStrictToolCalling");p(this,"audio");p(this,"modalities");p(this,"reasoning");p(this,"zdrEnabled");p(this,"service_tier");p(this,"promptCacheKey");p(this,"promptCacheRetention");p(this,"verbosity");p(this,"defaultOptions");p(this,"lc_serializable",!0);const n=typeof((r=e==null?void 0:e.configuration)==null?void 0:r.apiKey)=="string"||typeof((s=e==null?void 0:e.configuration)==null?void 0:s.apiKey)=="function"?(i=e==null?void 0:e.configuration)==null?void 0:i.apiKey:void 0;this.apiKey=(e==null?void 0:e.apiKey)??n??Sr("OPENAI_API_KEY"),this.organization=((a=e==null?void 0:e.configuration)==null?void 0:a.organization)??Sr("OPENAI_ORGANIZATION"),this.model=(e==null?void 0:e.model)??(e==null?void 0:e.modelName)??this.model,this.modelKwargs=(e==null?void 0:e.modelKwargs)??{},this.timeout=e==null?void 0:e.timeout,this.temperature=(e==null?void 0:e.temperature)??this.temperature,this.topP=(e==null?void 0:e.topP)??this.topP,this.frequencyPenalty=(e==null?void 0:e.frequencyPenalty)??this.frequencyPenalty,this.presencePenalty=(e==null?void 0:e.presencePenalty)??this.presencePenalty,this.logprobs=e==null?void 0:e.logprobs,this.topLogprobs=e==null?void 0:e.topLogprobs,this.n=(e==null?void 0:e.n)??this.n,this.logitBias=e==null?void 0:e.logitBias,this.stop=(e==null?void 0:e.stopSequences)??(e==null?void 0:e.stop),this.stopSequences=this.stop,this.user=e==null?void 0:e.user,this.__includeRawResponse=e==null?void 0:e.__includeRawResponse,this.audio=e==null?void 0:e.audio,this.modalities=e==null?void 0:e.modalities,this.reasoning=e==null?void 0:e.reasoning,this.maxTokens=(e==null?void 0:e.maxCompletionTokens)??(e==null?void 0:e.maxTokens),this.promptCacheKey=(e==null?void 0:e.promptCacheKey)??this.promptCacheKey,this.promptCacheRetention=(e==null?void 0:e.promptCacheRetention)??this.promptCacheRetention,this.verbosity=(e==null?void 0:e.verbosity)??this.verbosity,this.disableStreaming=(e==null?void 0:e.disableStreaming)===!0,this.streaming=(e==null?void 0:e.streaming)===!0,this.disableStreaming&&(this.streaming=!1),(e==null?void 0:e.streaming)===!1&&(this.disableStreaming=!0),this.streamUsage=(e==null?void 0:e.streamUsage)??this.streamUsage,this.disableStreaming&&(this.streamUsage=!1),this.clientConfig={apiKey:this.apiKey,organization:this.organization,dangerouslyAllowBrowser:!0,...e==null?void 0:e.configuration},(e==null?void 0:e.supportsStrictToolCalling)!==void 0&&(this.supportsStrictToolCalling=e.supportsStrictToolCalling),(e==null?void 0:e.service_tier)!==void 0&&(this.service_tier=e.service_tier),this.zdrEnabled=(e==null?void 0:e.zdrEnabled)??!1}_llmType(){return"openai"}static lc_name(){return"ChatOpenAI"}get callKeys(){return[...super.callKeys,"options","function_call","functions","tools","tool_choice","promptIndex","response_format","seed","reasoning","service_tier"]}get lc_secrets(){return{apiKey:"OPENAI_API_KEY",organization:"OPENAI_ORGANIZATION"}}get lc_aliases(){return{apiKey:"openai_api_key",modelName:"model"}}get lc_serializable_keys(){return["configuration","logprobs","topLogprobs","prefixMessages","supportsStrictToolCalling","modalities","audio","temperature","maxTokens","topP","frequencyPenalty","presencePenalty","n","logitBias","user","streaming","streamUsage","model","modelName","modelKwargs","stop","stopSequences","timeout","apiKey","cache","maxConcurrency","maxRetries","verbose","callbacks","tags","metadata","disableStreaming","zdrEnabled","reasoning","promptCacheKey","promptCacheRetention","verbosity"]}getLsParams(e){const n=this.invocationParams(e);return{ls_provider:"openai",ls_model_name:this.model,ls_model_type:"chat",ls_temperature:n.temperature??void 0,ls_max_tokens:n.max_tokens??void 0,ls_stop:e.stop}}_identifyingParams(){return{model_name:this.model,...this.invocationParams(),...this.clientConfig}}identifyingParams(){return this._identifyingParams()}_getReasoningParams(e){if(!hc(this.model))return;let n;return this.reasoning!==void 0&&(n={...n,...this.reasoning}),(e==null?void 0:e.reasoning)!==void 0&&(n={...n,...e.reasoning}),n}_getResponseFormat(e){return e&&e.type==="json_schema"&&e.json_schema.schema&&ar(e.json_schema.schema)?hD(e.json_schema.schema,e.json_schema.name,{description:e.json_schema.description}):e}_combineCallOptions(e){return{...this.defaultOptions,...e??{}}}_getClientOptions(e){if(!this.client){const r={baseURL:this.clientConfig.baseURL},s=qL(r),i={...this.clientConfig,baseURL:s,timeout:this.timeout,maxRetries:0};i.baseURL||delete i.baseURL,i.defaultHeaders=XL(i.defaultHeaders),this.client=new De(i)}return{...this.clientConfig,...e}}_convertChatOpenAIToolToCompletionsTool(e,n){return du(e)?c2(e.metadata.customTool):Wm(e)?(n==null?void 0:n.strict)!==void 0?{...e,function:{...e.function,strict:n.strict}}:e:YL(e,n)}bindTools(e,n){let r;return(n==null?void 0:n.strict)!==void 0?r=n.strict:this.supportsStrictToolCalling!==void 0&&(r=this.supportsStrictToolCalling),this.withConfig({tools:e.map(s=>Fm(s)||du(s)?s:t2(s)?s.extras.providerToolDefinition:this._convertChatOpenAIToolToCompletionsTool(s,{strict:r})),...n})}async stream(e,n){return super.stream(e,this._combineCallOptions(n))}async invoke(e,n){return super.invoke(e,this._combineCallOptions(n))}_combineLLMOutput(...e){return e.reduce((n,r)=>(r&&r.tokenUsage&&(n.tokenUsage.completionTokens+=r.tokenUsage.completionTokens??0,n.tokenUsage.promptTokens+=r.tokenUsage.promptTokens??0,n.tokenUsage.totalTokens+=r.tokenUsage.totalTokens??0),n),{tokenUsage:{completionTokens:0,promptTokens:0,totalTokens:0}})}async getNumTokensFromMessages(e){let n=0,r=0,s=0;this.model==="gpt-3.5-turbo-0301"?(r=4,s=-1):(r=3,s=1);const i=await Promise.all(e.map(async a=>{var h,f,m,g,w,b;const o=await this.getNumTokens(a.content),c=await this.getNumTokens(fc(a)),l=a.name!==void 0?s+await this.getNumTokens(a.name):0;let u=o+r+c+l;const d=a;if(d._getType()==="function"&&(u-=2),(h=d.additional_kwargs)!=null&&h.function_call&&(u+=3),(f=d==null?void 0:d.additional_kwargs.function_call)!=null&&f.name&&(u+=await this.getNumTokens((m=d.additional_kwargs.function_call)==null?void 0:m.name)),(g=d.additional_kwargs.function_call)!=null&&g.arguments)try{u+=await this.getNumTokens(JSON.stringify(JSON.parse((w=d.additional_kwargs.function_call)==null?void 0:w.arguments)))}catch(y){console.error("Error parsing function arguments",y,JSON.stringify(d.additional_kwargs.function_call)),u+=await this.getNumTokens((b=d.additional_kwargs.function_call)==null?void 0:b.arguments)}return n+=u,u}));return n+=3,{totalCount:n,countPerMessage:i}}async _getNumTokensFromGenerations(e){return(await Promise.all(e.map(async r=>{var s;return(s=r.message.additional_kwargs)!=null&&s.function_call?(await this.getNumTokensFromMessages([r.message])).countPerMessage[0]:await this.getNumTokens(r.message.content)}))).reduce((r,s)=>r+s,0)}async _getEstimatedTokenCountFromPrompt(e,n,r){let s=(await this.getNumTokensFromMessages(e)).totalCount;if(n&&r!=="auto"){const i=e2(n);s+=await this.getNumTokens(i),s+=9}return n&&e.find(i=>i._getType()==="system")&&(s-=4),r==="none"?s+=1:typeof r=="object"&&(s+=await this.getNumTokens(r.name)+4),s}async moderateContent(e,n){const r=this._getClientOptions(n==null?void 0:n.options),s=(n==null?void 0:n.model)??"omni-moderation-latest",i={input:e,model:s};return this.caller.call(async()=>{try{return await this.client.moderations.create(i,r)}catch(a){throw Lm(a)}})}get profile(){return mD[this.model]??{}}_getStructuredOutputMethod(e){const n={...e};if(!this.model.startsWith("gpt-3")&&!this.model.startsWith("gpt-4-")&&this.model!=="gpt-4"){if((n==null?void 0:n.method)===void 0)return"jsonSchema"}else n.method==="jsonSchema"&&console.warn(`[WARNING]: JSON Schema is not supported for model "${this.model}". Falling back to tool calling.`);return n.method}withStructuredOutput(e,n){let r,s;const{schema:i,name:a,includeRaw:o}={...n,schema:e};if((n==null?void 0:n.strict)!==void 0&&n.method==="jsonMode")throw new Error("Argument `strict` is only supported for `method` = 'function_calling'");const c=uD(this.model,n==null?void 0:n.method);if(c==="jsonMode"){ar(i)?s=pu.fromZodSchema(i):s=new Uf;const h=bt(i);r=this.withConfig({outputVersion:"v0",response_format:{type:"json_object"},ls_structured_output_format:{kwargs:{method:"json_mode"},schema:{title:a??"extract",...h}}})}else if(c==="jsonSchema"){const h={name:a??"extract",description:ki(i),schema:i,strict:n==null?void 0:n.strict},f=bt(h.schema);if(r=this.withConfig({outputVersion:"v0",response_format:{type:"json_schema",json_schema:h},ls_structured_output_format:{kwargs:{method:"json_schema"},schema:{title:h.name,description:h.description,...f}}}),ar(i)){const m=pu.fromZodSchema(i);s=Kn.from(g=>"parsed"in g.additional_kwargs?g.additional_kwargs.parsed:m)}else s=new Uf}else{let h=a??"extract";if(ar(i)){const f=bt(i);r=this.withConfig({outputVersion:"v0",tools:[{type:"function",function:{name:h,description:f.description,parameters:f}}],tool_choice:{type:"function",function:{name:h}},ls_structured_output_format:{kwargs:{method:"function_calling"},schema:{title:h,...f}},...(n==null?void 0:n.strict)!==void 0?{strict:n.strict}:{}}),s=new zf({returnSingle:!0,keyName:h,zodSchema:i})}else{let f;typeof i.name=="string"&&typeof i.parameters=="object"&&i.parameters!=null?(f=i,h=i.name):(h=i.title??h,f={name:h,description:i.description??"",parameters:i});const m=bt(i);r=this.withConfig({outputVersion:"v0",tools:[{type:"function",function:f}],tool_choice:{type:"function",function:{name:h}},ls_structured_output_format:{kwargs:{method:"function_calling"},schema:{title:h,...m}},...(n==null?void 0:n.strict)!==void 0?{strict:n.strict}:{}}),s=new zf({returnSingle:!0,keyName:h})}}if(!o)return r.pipe(s);const l=Ci.assign({parsed:(h,f)=>s.invoke(h.raw,f)}),u=Ci.assign({parsed:()=>null}),d=l.withFallbacks({fallbacks:[u]});return Jn.from([{raw:r},d])}};const VT={providerName:"ChatOpenAI",fromStandardTextBlock(t){return{type:"text",text:t.text}},fromStandardImageBlock(t){var e,n;if(t.source_type==="url")return{type:"image_url",image_url:{url:t.url,...(e=t.metadata)!=null&&e.detail?{detail:t.metadata.detail}:{}}};if(t.source_type==="base64")return{type:"image_url",image_url:{url:`data:${t.mime_type??""};base64,${t.data}`,...(n=t.metadata)!=null&&n.detail?{detail:t.metadata.detail}:{}}};throw new Error(`Image content blocks with source_type ${t.source_type} are not supported for ChatOpenAI`)},fromStandardAudioBlock(t){if(t.source_type==="url"){const e=_o({dataUrl:t.url});if(!e)throw new Error(`URL audio blocks with source_type ${t.source_type} must be formatted as a data URL for ChatOpenAI`);const n=e.mime_type||t.mime_type||"";let r;try{r=jh(n)}catch{throw new Error(`Audio blocks with source_type ${t.source_type} must have mime type of audio/wav or audio/mp3`)}if(r.type!=="audio"||r.subtype!=="wav"&&r.subtype!=="mp3")throw new Error(`Audio blocks with source_type ${t.source_type} must have mime type of audio/wav or audio/mp3`);return{type:"input_audio",input_audio:{format:r.subtype,data:e.data}}}if(t.source_type==="base64"){let e;try{e=jh(t.mime_type??"")}catch{throw new Error(`Audio blocks with source_type ${t.source_type} must have mime type of audio/wav or audio/mp3`)}if(e.type!=="audio"||e.subtype!=="wav"&&e.subtype!=="mp3")throw new Error(`Audio blocks with source_type ${t.source_type} must have mime type of audio/wav or audio/mp3`);return{type:"input_audio",input_audio:{format:e.subtype,data:t.data}}}throw new Error(`Audio content blocks with source_type ${t.source_type} are not supported for ChatOpenAI`)},fromStandardFileBlock(t){var e,n,r,s,i;if(t.source_type==="url"){const a=_o({dataUrl:t.url}),o=lu(t);if(!a)throw new Error(`URL file blocks with source_type ${t.source_type} must be formatted as a data URL for ChatOpenAI`);return{type:"file",file:{file_data:t.url,...(e=t.metadata)!=null&&e.filename||(n=t.metadata)!=null&&n.name?{filename:o}:{}}}}if(t.source_type==="base64"){const a=lu(t);return{type:"file",file:{file_data:`data:${t.mime_type??""};base64,${t.data}`,...(r=t.metadata)!=null&&r.filename||(s=t.metadata)!=null&&s.name||(i=t.metadata)!=null&&i.title?{filename:a}:{}}}}if(t.source_type==="id")return{type:"file",file:{file_id:t.id}};throw new Error(`File content blocks with source_type ${t.source_type} are not supported for ChatOpenAI`)}},tU=({message:t,rawResponse:e,includeRawResponse:n})=>{var s,i;const r=t.tool_calls;switch(t.role){case"assistant":{const a=[],o=[];for(const d of r??[])try{a.push(hd(d,{returnId:!0}))}catch(h){o.push(po(d,h.message))}const c={function_call:t.function_call,tool_calls:r};n!==void 0&&(c.__raw_response=e);const l={model_provider:"openai",model_name:e.model,...e.system_fingerprint?{usage:{...e.usage},system_fingerprint:e.system_fingerprint}:{}};t.audio&&(c.audio=t.audio);const u=fD(t.content||"",(i=(s=e.choices)==null?void 0:s[0])==null?void 0:i.message);return new le({content:u,tool_calls:a,invalid_tool_calls:o,additional_kwargs:c,response_metadata:l,id:e.id})}default:return new vs(t.content||"",t.role??"unknown")}},nU=({delta:t,rawResponse:e,includeRawResponse:n,defaultRole:r})=>{var c,l;const s=t.role??r,i=t.content??"";let a;t.function_call?a={function_call:t.function_call}:t.tool_calls?a={tool_calls:t.tool_calls}:a={},n&&(a.__raw_response=e),t.audio&&(a.audio={...t.audio,index:e.choices[0].index});const o={model_provider:"openai",usage:{...e.usage}};if(s==="user")return new Ca({content:i,response_metadata:o});if(s==="assistant"){const u=[];if(Array.isArray(t.tool_calls))for(const d of t.tool_calls)u.push({name:(c=d.function)==null?void 0:c.name,args:(l=d.function)==null?void 0:l.arguments,id:d.id,index:d.index,type:"tool_call_chunk"});return new dn({content:i,tool_call_chunks:u,additional_kwargs:a,id:e.id,response_metadata:o})}else return s==="system"?new fs({content:i,response_metadata:o}):s==="developer"?new fs({content:i,response_metadata:o,additional_kwargs:{__openai_role__:"developer"}}):s==="function"?new ec({content:i,additional_kwargs:a,name:t.name,response_metadata:o}):s==="tool"?new Aa({content:i,additional_kwargs:a,tool_call_id:t.tool_call_id,response_metadata:o}):new Qo({content:i,role:s,response_metadata:o})},rU=t=>{if(t.type==="image"){if(t.url)return{type:"image_url",image_url:{url:t.url}};if(t.data)return{type:"image_url",image_url:{url:`data:${t.mimeType};base64,${t.data}`}}}if(t.type==="audio"&&t.data){const e=ov(()=>{const[,n]=t.mimeType.split("/");return n==="wav"||n==="mp3"?n:"wav"});return{type:"input_audio",input_audio:{data:t.data.toString(),format:e}}}if(t.type==="file"){if(t.data){const e=lu(t);return{type:"file",file:{file_data:`data:${t.mimeType};base64,${t.data}`,filename:e}}}if(t.fileId)return{type:"file",file:{file_id:t.fileId}}}},sU=({message:t,model:e})=>{let n=fc(t);if(n==="system"&&hc(e)&&(n="developer"),n==="developer")return{role:"developer",content:t.contentBlocks.filter(s=>s.type==="text")};if(n==="system")return{role:"system",content:t.contentBlocks.filter(s=>s.type==="text")};if(n==="assistant")return{role:"assistant",content:t.contentBlocks.filter(s=>s.type==="text")};if(n==="tool"&&Pe.isInstance(t))return{role:"tool",tool_call_id:t.tool_call_id,content:t.contentBlocks.filter(s=>s.type==="text")};if(n==="function")return{role:"function",name:t.name??"",content:t.contentBlocks.filter(s=>s.type==="text").join("")};function*r(s){for(const i of s){i.type==="text"&&(yield{type:"text",text:i.text});const a=rU(i);a&&(yield a)}}return{role:"user",content:Array.from(r(t.contentBlocks))}},G_=({messages:t,model:e})=>t.flatMap(n=>{var a,o;if("output_version"in n.response_metadata&&((a=n.response_metadata)==null?void 0:a.output_version)==="v1")return sU({message:n});let r=fc(n);r==="system"&&hc(e)&&(r="developer");const s=typeof n.content=="string"?n.content:n.content.map(c=>Gr(c)?Sp(c,VT):c),i={role:r,content:s};if(n.name!=null&&(i.name=n.name),n.additional_kwargs.function_call!=null&&(i.function_call=n.additional_kwargs.function_call),le.isInstance(n)&&((o=n.tool_calls)!=null&&o.length)?i.tool_calls=n.tool_calls.map(BT):(n.additional_kwargs.tool_calls!=null&&(i.tool_calls=n.additional_kwargs.tool_calls),Pe.isInstance(n)&&n.tool_call_id!=null&&(i.tool_call_id=n.tool_call_id)),n.additional_kwargs.audio&&typeof n.additional_kwargs.audio=="object"&&"id"in n.additional_kwargs.audio){const c={role:"assistant",audio:{id:n.additional_kwargs.audio.id}};return[i,c]}return i});var iU=class extends qm{invocationParams(t,e){var a;let n;(t==null?void 0:t.strict)!==void 0?n=t.strict:this.supportsStrictToolCalling!==void 0&&(n=this.supportsStrictToolCalling);let r={};(t==null?void 0:t.stream_options)!==void 0?r={stream_options:t.stream_options}:this.streamUsage&&(this.streaming||e!=null&&e.streaming)&&(r={stream_options:{include_usage:!0}});const s={model:this.model,temperature:this.temperature,top_p:this.topP,frequency_penalty:this.frequencyPenalty,presence_penalty:this.presencePenalty,logprobs:this.logprobs,top_logprobs:this.topLogprobs,n:this.n,logit_bias:this.logitBias,stop:(t==null?void 0:t.stop)??this.stopSequences,user:this.user,stream:this.streaming,functions:t==null?void 0:t.functions,function_call:t==null?void 0:t.function_call,tools:(a=t==null?void 0:t.tools)!=null&&a.length?t.tools.map(o=>this._convertChatOpenAIToolToCompletionsTool(o,{strict:n})):void 0,tool_choice:dT(t==null?void 0:t.tool_choice),response_format:this._getResponseFormat(t==null?void 0:t.response_format),seed:t==null?void 0:t.seed,...r,parallel_tool_calls:t==null?void 0:t.parallel_tool_calls,...this.audio||t!=null&&t.audio?{audio:this.audio||(t==null?void 0:t.audio)}:{},...this.modalities||t!=null&&t.modalities?{modalities:this.modalities||(t==null?void 0:t.modalities)}:{},...this.modelKwargs,prompt_cache_key:(t==null?void 0:t.promptCacheKey)??this.promptCacheKey,prompt_cache_retention:(t==null?void 0:t.promptCacheRetention)??this.promptCacheRetention,verbosity:(t==null?void 0:t.verbosity)??this.verbosity};(t==null?void 0:t.prediction)!==void 0&&(s.prediction=t.prediction),this.service_tier!==void 0&&(s.service_tier=this.service_tier),(t==null?void 0:t.service_tier)!==void 0&&(s.service_tier=t.service_tier);const i=this._getReasoningParams(t);return i!==void 0&&i.effort!==void 0&&(s.reasoning_effort=i.effort),hc(s.model)?s.max_completion_tokens=this.maxTokens===-1?void 0:this.maxTokens:s.max_tokens=this.maxTokens===-1?void 0:this.maxTokens,s}async _generate(t,e,n){var a,o;const r={},s=this.invocationParams(e),i=G_({messages:t,model:this.model});if(s.stream){const c=this._streamResponseChunks(t,e,n),l={};for await(const g of c){g.message.response_metadata={...g.generationInfo,...g.message.response_metadata};const w=((a=g.generationInfo)==null?void 0:a.completion)??0;l[w]===void 0?l[w]=g:l[w]=l[w].concat(g)}const u=Object.entries(l).sort(([g],[w])=>parseInt(g,10)-parseInt(w,10)).map(([g,w])=>w),{functions:d,function_call:h}=this.invocationParams(e),f=await this._getEstimatedTokenCountFromPrompt(t,d,h),m=await this._getNumTokensFromGenerations(u);return r.input_tokens=f,r.output_tokens=m,r.total_tokens=f+m,{generations:u,llmOutput:{estimatedTokenUsage:{promptTokens:r.input_tokens,completionTokens:r.output_tokens,totalTokens:r.total_tokens}}}}else{const c=await this.completionWithRetry({...s,stream:!1,messages:i},{signal:e==null?void 0:e.signal,...e==null?void 0:e.options}),{completion_tokens:l,prompt_tokens:u,total_tokens:d,prompt_tokens_details:h,completion_tokens_details:f}=(c==null?void 0:c.usage)??{};l&&(r.output_tokens=(r.output_tokens??0)+l),u&&(r.input_tokens=(r.input_tokens??0)+u),d&&(r.total_tokens=(r.total_tokens??0)+d),((h==null?void 0:h.audio_tokens)!==null||(h==null?void 0:h.cached_tokens)!==null)&&(r.input_token_details={...(h==null?void 0:h.audio_tokens)!==null&&{audio:h==null?void 0:h.audio_tokens},...(h==null?void 0:h.cached_tokens)!==null&&{cache_read:h==null?void 0:h.cached_tokens}}),((f==null?void 0:f.audio_tokens)!==null||(f==null?void 0:f.reasoning_tokens)!==null)&&(r.output_token_details={...(f==null?void 0:f.audio_tokens)!==null&&{audio:f==null?void 0:f.audio_tokens},...(f==null?void 0:f.reasoning_tokens)!==null&&{reasoning:f==null?void 0:f.reasoning_tokens}});const m=[];for(const g of(c==null?void 0:c.choices)??[]){const b={text:((o=g.message)==null?void 0:o.content)??"",message:this._convertCompletionsMessageToBaseMessage(g.message??{role:"assistant"},c)};b.generationInfo={...g.finish_reason?{finish_reason:g.finish_reason}:{},...g.logprobs?{logprobs:g.logprobs}:{}},Ru(b.message)&&(b.message.usage_metadata=r),b.message=new le(Object.fromEntries(Object.entries(b.message).filter(([y])=>!y.startsWith("lc_")))),m.push(b)}return{generations:m,llmOutput:{tokenUsage:{promptTokens:r.input_tokens,completionTokens:r.output_tokens,totalTokens:r.total_tokens}}}}}async*_streamResponseChunks(t,e,n){var c,l,u,d,h,f,m,g,w,b;const r=G_({messages:t,model:this.model}),s={...this.invocationParams(e,{streaming:!0}),messages:r,stream:!0};let i;const a=await this.completionWithRetry(s,e);let o;for await(const y of a){const v=(c=y==null?void 0:y.choices)==null?void 0:c[0];if(y.usage&&(o=y.usage),!v)continue;const{delta:T}=v;if(!T)continue;const A=this._convertCompletionsDeltaToBaseMessageChunk(T,y,i);i=T.role??i;const I={prompt:e.promptIndex??0,completion:v.index??0};if(typeof A.content!="string"){console.log("[WARNING]: Received non-string content from OpenAI. This is currently not supported.");continue}const $={...I};v.finish_reason!=null&&($.finish_reason=v.finish_reason,$.system_fingerprint=y.system_fingerprint,$.model_name=y.model,$.service_tier=y.service_tier),this.logprobs&&($.logprobs=v.logprobs);const S=new ms({message:A,text:A.content,generationInfo:$});yield S,await(n==null?void 0:n.handleLLMNewToken(S.text??"",I,void 0,void 0,void 0,{chunk:S}))}if(o){const y={...((l=o.prompt_tokens_details)==null?void 0:l.audio_tokens)!==null&&{audio:(u=o.prompt_tokens_details)==null?void 0:u.audio_tokens},...((d=o.prompt_tokens_details)==null?void 0:d.cached_tokens)!==null&&{cache_read:(h=o.prompt_tokens_details)==null?void 0:h.cached_tokens}},v={...((f=o.completion_tokens_details)==null?void 0:f.audio_tokens)!==null&&{audio:(m=o.completion_tokens_details)==null?void 0:m.audio_tokens},...((g=o.completion_tokens_details)==null?void 0:g.reasoning_tokens)!==null&&{reasoning:(w=o.completion_tokens_details)==null?void 0:w.reasoning_tokens}};yield new ms({message:new dn({content:"",response_metadata:{usage:{...o}},usage_metadata:{input_tokens:o.prompt_tokens,output_tokens:o.completion_tokens,total_tokens:o.total_tokens,...Object.keys(y).length>0&&{input_token_details:y},...Object.keys(v).length>0&&{output_token_details:v}}}),text:""})}if((b=e.signal)!=null&&b.aborted)throw new Error("AbortError")}async completionWithRetry(t,e){const n=this._getClientOptions(e),r=t.response_format&&t.response_format.type==="json_schema";return this.caller.call(async()=>{try{return r&&!t.stream?await this.client.chat.completions.parse(t,n):await this.client.chat.completions.create(t,n)}catch(s){throw Lm(s)}})}_convertCompletionsDeltaToBaseMessageChunk(t,e,n){return nU({delta:t,rawResponse:e,includeRawResponse:this.__includeRawResponse,defaultRole:n})}_convertCompletionsMessageToBaseMessage(t,e){return tU({message:t,rawResponse:e,includeRawResponse:this.__includeRawResponse})}};const ta="__openai_function_call_ids__",GT=t=>{var r,s,i,a;const e={...((r=t==null?void 0:t.input_tokens_details)==null?void 0:r.cached_tokens)!=null&&{cache_read:(s=t==null?void 0:t.input_tokens_details)==null?void 0:s.cached_tokens}},n={...((i=t==null?void 0:t.output_tokens_details)==null?void 0:i.reasoning_tokens)!=null&&{reasoning:(a=t==null?void 0:t.output_tokens_details)==null?void 0:a.reasoning_tokens}};return{input_tokens:(t==null?void 0:t.input_tokens)??0,output_tokens:(t==null?void 0:t.output_tokens)??0,total_tokens:(t==null?void 0:t.total_tokens)??0,input_token_details:e,output_token_details:n}},WT=t=>{if(t.error){const o=new Error(t.error.message);throw o.name=t.error.code,o}let e;const n=[],r=[],s=[],i={model_provider:"openai",model:t.model,created_at:t.created_at,id:t.id,incomplete_details:t.incomplete_details,metadata:t.metadata,object:t.object,status:t.status,user:t.user,service_tier:t.service_tier,model_name:t.model},a={};for(const o of t.output)if(o.type==="message")e=o.id,n.push(...o.content.flatMap(c=>c.type==="output_text"?("parsed"in c&&c.parsed!=null&&(a.parsed=c.parsed),{type:"text",text:c.text,annotations:c.annotations}):c.type==="refusal"?(a.refusal=c.refusal,[]):c));else if(o.type==="function_call"){const c={function:{name:o.name,arguments:o.arguments},id:o.call_id};try{r.push(hd(c,{returnId:!0}))}catch(l){let u;typeof l=="object"&&l!=null&&"message"in l&&typeof l.message=="string"&&(u=l.message),s.push(po(c,u))}a[ta]??(a[ta]={}),o.id&&(a[ta][o.call_id]=o.id)}else if(o.type==="reasoning")a.reasoning=o;else if(o.type==="custom_tool_call"){const c=r2(o);c?r.push(c):s.push(po(o,"Malformed custom tool call"))}else if(o.type==="computer_call"){const c=s2(o);c?r.push(c):s.push(po(o,"Malformed computer call"))}else a.tool_outputs??(a.tool_outputs=[]),a.tool_outputs.push(o);return new le({id:e,content:n,tool_calls:r,invalid_tool_calls:s,usage_metadata:GT(t.usage),additional_kwargs:a,response_metadata:i})},aU=t=>{const e=(t.summary.length>1?t.summary.reduce((n,r)=>{const s=n[n.length-1];return s.index===r.index?s.text+=r.text:n.push(r),n},[{...t.summary[0]}]):t.summary).map(n=>Object.fromEntries(Object.entries(n).filter(([r])=>r!=="index")));return{...t,summary:e}},oU=t=>{var c,l;const e=[];let n={},r;const s=[],i={model_provider:"openai"},a={};let o;if(t.type==="response.output_text.delta")e.push({type:"text",text:t.delta,index:t.content_index});else if(t.type==="response.output_text.annotation.added")e.push({type:"text",text:"",annotations:[t.annotation],index:t.content_index});else if(t.type==="response.output_item.added"&&t.item.type==="message")o=t.item.id;else if(t.type==="response.output_item.added"&&t.item.type==="function_call")s.push({type:"tool_call_chunk",name:t.item.name,args:t.item.arguments,id:t.item.call_id,index:t.output_index}),a[ta]={[t.item.call_id]:t.item.id};else if(t.type==="response.output_item.done"&&t.item.type==="computer_call")s.push({type:"tool_call_chunk",name:"computer_use",args:JSON.stringify({action:t.item.action}),id:t.item.call_id,index:t.output_index}),a.tool_outputs=[t.item];else if(t.type==="response.output_item.done"&&["web_search_call","file_search_call","code_interpreter_call","mcp_call","mcp_list_tools","mcp_approval_request","image_generation_call","custom_tool_call"].includes(t.item.type))a.tool_outputs=[t.item];else if(t.type==="response.created")i.id=t.response.id,i.model_name=t.response.model,i.model=t.response.model;else if(t.type==="response.completed"){const u=WT(t.response);r=GT(t.response.usage),((l=(c=t.response.text)==null?void 0:c.format)==null?void 0:l.type)==="json_schema"&&(a.parsed??(a.parsed=JSON.parse(u.text)));for(const[d,h]of Object.entries(t.response))d!=="id"&&(i[d]=h)}else if(t.type==="response.function_call_arguments.delta"||t.type==="response.custom_tool_call_input.delta")s.push({type:"tool_call_chunk",args:t.delta,index:t.output_index});else if(t.type==="response.web_search_call.completed"||t.type==="response.file_search_call.completed")n={tool_outputs:{id:t.item_id,type:t.type.replace("response.","").replace(".completed",""),status:"completed"}};else if(t.type==="response.refusal.done")a.refusal=t.refusal;else if(t.type==="response.output_item.added"&&"item"in t&&t.item.type==="reasoning"){const u=t.item.summary?t.item.summary.map((d,h)=>({...d,index:h})):void 0;a.reasoning={id:t.item.id,type:t.item.type,...u?{summary:u}:{}}}else if(t.type==="response.reasoning_summary_part.added")a.reasoning={type:"reasoning",summary:[{...t.part,index:t.summary_index}]};else if(t.type==="response.reasoning_summary_text.delta")a.reasoning={type:"reasoning",summary:[{text:t.delta,type:"summary_text",index:t.summary_index}]};else return t.type==="response.image_generation_call.partial_image",null;return new ms({text:e.map(u=>u.text).join(""),message:new dn({id:o,content:e,tool_call_chunks:s,usage_metadata:r,additional_kwargs:a,response_metadata:i}),generationInfo:n})},cU=t=>{var r;const e=le.isInstance(t)&&((r=t.response_metadata)==null?void 0:r.model_provider)==="openai";function*n(){const s=Ti(()=>{try{const y=fc(t);return y==="system"||y==="developer"||y==="assistant"||y==="user"?y:"assistant"}catch{return"assistant"}});let i;const a=new Set,o=new Set,c=new Map,l=new Map;function*u(){if(!i)return;const y=i.content;(typeof y=="string"&&y.length>0||Array.isArray(y)&&y.length>0)&&(yield i),i=void 0}const d=y=>{i||(i={type:"message",role:s,content:[]}),typeof i.content=="string"?i.content=i.content.length>0?[{type:"input_text",text:i.content},...y]:[...y]:i.content.push(...y)},h=y=>{if(typeof y=="string")return y;try{return JSON.stringify(y??{})}catch{return"{}"}},f=y=>{const v=Ti(()=>{var A;const T=(A=y.metadata)==null?void 0:A.detail;return T==="low"||T==="high"||T==="auto"?T:"auto"});if(y.fileId)return{type:"input_image",detail:v,file_id:y.fileId};if(y.url)return{type:"input_image",detail:v,image_url:y.url};if(y.data){const T=typeof y.data=="string"?y.data:Fs.from(y.data).toString("base64"),A=y.mimeType??"image/png";return{type:"input_image",detail:v,image_url:`data:${A};base64,${T}`}}},m=y=>{const v=lu(y);if(y.fileId&&typeof v=="string")return{type:"input_file",file_id:y.fileId,...v?{filename:v}:{}};if(y.url&&typeof v=="string")return{type:"input_file",file_url:y.url,...v?{filename:v}:{}};if(y.data&&typeof v=="string"){const T=typeof y.data=="string"?y.data:Fs.from(y.data).toString("base64");return{type:"input_file",file_data:`data:${y.mimeType??"application/octet-stream"};base64,${T}`,...v?{filename:v}:{}}}},g=y=>{const v=Ti(()=>{if(Array.isArray(y.summary)){const I=y.summary,$=(I==null?void 0:I.map(S=>S==null?void 0:S.text).filter(S=>typeof S=="string"))??[];if($.length>0)return $}return y.reasoning?[y.reasoning]:[]}),T=v.length>0?v.map(I=>({type:"summary_text",text:I})):[{type:"summary_text",text:""}],A={type:"reasoning",id:y.id??"",summary:T};return y.reasoning&&(A.content=[{type:"reasoning_text",text:y.reasoning}]),A},w=y=>({type:"function_call",name:y.name??"",call_id:y.id??"",arguments:h(y.args)}),b=y=>{const v=h(y.output),T=y.status==="success"?"completed":y.status==="error"?"incomplete":void 0;return{type:"function_call_output",call_id:y.toolCallId??"",output:v,...T?{status:T}:{}}};for(const y of t.contentBlocks)if(y.type==="text")d([{type:"input_text",text:y.text}]);else if(y.type!=="invalid_tool_call"){if(y.type==="reasoning")yield*u(),yield g(y);else if(y.type==="tool_call"){yield*u();const v=y.id??"";v&&(a.add(v),c.delete(v)),yield w(y)}else if(y.type==="tool_call_chunk"){if(y.id){const v=c.get(y.id)??{name:y.name,args:[]};y.name&&(v.name=y.name),y.args&&v.args.push(y.args),c.set(y.id,v)}}else if(y.type==="server_tool_call"){yield*u();const v=y.id??"";v&&(o.add(v),l.delete(v)),yield w(y)}else if(y.type==="server_tool_call_chunk"){if(y.id){const v=l.get(y.id)??{name:y.name,args:[]};y.name&&(v.name=y.name),y.args&&v.args.push(y.args),l.set(y.id,v)}}else if(y.type==="server_tool_call_result")yield*u(),yield b(y);else if(y.type!=="audio")if(y.type==="file"){const v=m(y);v&&d([v])}else if(y.type==="image"){const v=f(y);v&&d([v])}else if(y.type==="video"){const v=m(y);v&&d([v])}else y.type==="text-plain"?y.text&&d([{type:"input_text",text:y.text}]):y.type==="non_standard"&&e&&(yield*u(),yield y.value)}yield*u();for(const[y,v]of c){if(!y||a.has(y))continue;const T=v.args.join("");!v.name&&!T||(yield{type:"function_call",call_id:y,name:v.name??"",arguments:T})}for(const[y,v]of l){if(!y||o.has(y))continue;const T=v.args.join("");!v.name&&!T||(yield{type:"function_call",call_id:y,name:v.name??"",arguments:T})}}return Array.from(n())},W_=({messages:t,zdrEnabled:e,model:n})=>t.flatMap(r=>{var o,c,l,u;const s=r.response_metadata;if((s==null?void 0:s.output_version)==="v1")return cU(r);const i=r.additional_kwargs;let a=fc(r);if(a==="system"&&hc(n)&&(a="developer"),a==="function")throw new Error("Function messages are not supported in Responses API");if(a==="tool"){const d=r;return(i==null?void 0:i.type)==="computer_call_output"?{type:"computer_call_output",output:(()=>{if(typeof d.content=="string")return{type:"input_image",image_url:d.content};if(Array.isArray(d.content)){const f=d.content.find(w=>w.type==="input_image");if(f)return f;const m=d.content.find(w=>w.type==="computer_screenshot");if(m)return m;const g=d.content.find(w=>w.type==="image_url");if(g)return{type:"input_image",image_url:typeof g.image_url=="string"?g.image_url:g.image_url.url}}throw new Error("Invalid computer call output")})(),call_id:d.tool_call_id}:(o=d.additional_kwargs)!=null&&o.customTool?{type:"custom_tool_call_output",call_id:d.tool_call_id,output:d.content}:{type:"function_call_output",call_id:d.tool_call_id,id:(c=d.id)!=null&&c.startsWith("fc_")?d.id:void 0,output:typeof d.content!="string"?JSON.stringify(d.content):d.content}}if(a==="assistant"){if(!e&&(s==null?void 0:s.output)!=null&&Array.isArray(s==null?void 0:s.output)&&(s==null?void 0:s.output.length)>0&&(s!=null&&s.output.every(w=>"type"in w)))return s==null?void 0:s.output;const d=[];if(i!=null&&i.reasoning&&!e){const w=aU(i.reasoning);d.push(w)}let{content:h}=r;i!=null&&i.refusal&&(typeof h=="string"&&(h=[{type:"output_text",text:h,annotations:[]}]),h=[...h,{type:"refusal",refusal:i.refusal}]),(typeof h=="string"||h.length>0)&&d.push({type:"message",role:"assistant",...r.id&&!e&&r.id.startsWith("msg_")?{id:r.id}:{},content:Ti(()=>typeof h=="string"?h:h.flatMap(w=>w.type==="text"?{type:"output_text",text:w.text,annotations:w.annotations??[]}:w.type==="output_text"||w.type==="refusal"?w:[]))});const f=i==null?void 0:i[ta];le.isInstance(r)&&((l=r.tool_calls)!=null&&l.length)?d.push(...r.tool_calls.map(w=>a2(w)?{type:"custom_tool_call",id:w.call_id,call_id:w.id??"",input:w.args.input,name:w.name}:i2(w)?{type:"computer_call",id:w.call_id,call_id:w.id??"",action:w.args.action}:{type:"function_call",name:w.name,arguments:JSON.stringify(w.args),call_id:w.id,...e?{}:{id:f==null?void 0:f[w.id]}})):i!=null&&i.tool_calls&&d.push(...i.tool_calls.map(w=>({type:"function_call",name:w.function.name,call_id:w.id,arguments:w.function.arguments,...e?{}:{id:f==null?void 0:f[w.id]}})));const m=(u=s==null?void 0:s.output)!=null&&u.length?s==null?void 0:s.output:i.tool_outputs,g=["computer_call","mcp_call","code_interpreter_call","image_generation_call"];if(m!=null){const w=m,b=w==null?void 0:w.filter(y=>g.includes(y.type));b.length>0&&d.push(...b)}return d}if(a==="user"||a==="system"||a==="developer"){if(typeof r.content=="string")return{type:"message",role:a,content:r.content};const d=[],h=r.content.flatMap(f=>{if(f.type==="mcp_approval_response"&&d.push({type:"mcp_approval_response",approval_request_id:f.approval_request_id,approve:f.approve}),Gr(f))return Sp(f,VT);if(f.type==="text")return{type:"input_text",text:f.text};if(f.type==="image_url"){const m=Ti(()=>{if(typeof f.image_url=="string")return f.image_url;if(typeof f.image_url=="object"&&f.image_url!==null&&"url"in f.image_url)return f.image_url.url}),g=Ti(()=>{if(typeof f.image_url=="string")return"auto";if(typeof f.image_url=="object"&&f.image_url!==null&&"detail"in f.image_url)return f.image_url.detail});return{type:"input_image",image_url:m,detail:g}}return f.type==="input_text"||f.type==="input_image"||f.type==="input_file"?f:[]});return h.length>0&&d.push({type:"message",role:a,content:h}),d}return console.warn(`Unsupported role found when converting to OpenAI Responses API: ${a}`),[]});var lU=class extends qm{invocationParams(t){var s;let e;(t==null?void 0:t.strict)!==void 0&&(e=t.strict),e===void 0&&this.supportsStrictToolCalling!==void 0&&(e=this.supportsStrictToolCalling);const n={model:this.model,temperature:this.temperature,top_p:this.topP,user:this.user,stream:this.streaming,previous_response_id:t==null?void 0:t.previous_response_id,truncation:t==null?void 0:t.truncation,include:t==null?void 0:t.include,tools:(s=t==null?void 0:t.tools)!=null&&s.length?this._reduceChatOpenAITools(t.tools,{stream:this.streaming,strict:e}):void 0,tool_choice:n2(t==null?void 0:t.tool_choice)?t==null?void 0:t.tool_choice:(()=>{const i=dT(t==null?void 0:t.tool_choice);if(typeof i=="object"&&"type"in i){if(i.type==="function")return{type:"function",name:i.function.name};if(i.type==="allowed_tools")return{type:"allowed_tools",mode:i.allowed_tools.mode,tools:i.allowed_tools.tools};if(i.type==="custom")return{type:"custom",name:i.custom.name}}})(),text:(()=>{if(t!=null&&t.text)return t.text;const i=this._getResponseFormat(t==null?void 0:t.response_format);return(i==null?void 0:i.type)==="json_schema"?i.json_schema.schema!=null?{format:{type:"json_schema",schema:i.json_schema.schema,description:i.json_schema.description,name:i.json_schema.name,strict:i.json_schema.strict},verbosity:t==null?void 0:t.verbosity}:void 0:{format:i,verbosity:t==null?void 0:t.verbosity}})(),parallel_tool_calls:t==null?void 0:t.parallel_tool_calls,max_output_tokens:this.maxTokens===-1?void 0:this.maxTokens,prompt_cache_key:(t==null?void 0:t.promptCacheKey)??this.promptCacheKey,prompt_cache_retention:(t==null?void 0:t.promptCacheRetention)??this.promptCacheRetention,...this.zdrEnabled?{store:!1}:{},...this.modelKwargs},r=this._getReasoningParams(t);return r!==void 0&&(n.reasoning=r),n}async _generate(t,e){var r;const n=this.invocationParams(e);if(n.stream){const s=this._streamResponseChunks(t,e);let i;for await(const a of s)a.message.response_metadata={...a.generationInfo,...a.message.response_metadata},i=(i==null?void 0:i.concat(a))??a;return{generations:i?[i]:[],llmOutput:{estimatedTokenUsage:(r=i==null?void 0:i.message)==null?void 0:r.usage_metadata}}}else{const s=await this.completionWithRetry({input:W_({messages:t,zdrEnabled:this.zdrEnabled??!1,model:this.model}),...n,stream:!1},{signal:e==null?void 0:e.signal,...e==null?void 0:e.options});return{generations:[{text:s.output_text,message:WT(s)}],llmOutput:{id:s.id,estimatedTokenUsage:s.usage?{promptTokens:s.usage.input_tokens,completionTokens:s.usage.output_tokens,totalTokens:s.usage.total_tokens}:void 0}}}}async*_streamResponseChunks(t,e,n){const r=await this.completionWithRetry({...this.invocationParams(e),input:W_({messages:t,zdrEnabled:this.zdrEnabled??!1,model:this.model}),stream:!0},e);for await(const s of r){const i=oU(s);i!=null&&(yield i,await(n==null?void 0:n.handleLLMNewToken(i.text||"",{prompt:e.promptIndex??0,completion:0},void 0,void 0,void 0,{chunk:i})))}}async completionWithRetry(t,e){return this.caller.call(async()=>{var r,s;const n=this._getClientOptions(e);try{return((s=(r=t.text)==null?void 0:r.format)==null?void 0:s.type)==="json_schema"&&!t.stream?await this.client.responses.parse(t,n):await this.client.responses.create(t,n)}catch(i){throw Lm(i)}})}_reduceChatOpenAITools(t,e){const n=[];for(const r of t)if(Fm(r))r.type==="image_generation"&&(e!=null&&e.stream)&&(r.partial_images=1),n.push(r);else if(du(r)){const s=r.metadata.customTool;n.push({type:"custom",name:s.name,description:s.description,format:s.format})}else Wm(r)?n.push({type:"function",name:r.function.name,parameters:r.function.parameters,description:r.function.description,strict:(e==null?void 0:e.strict)??null}):hT(r)&&n.push(o2(r));return n}},HT=class qT extends qm{constructor(n){super(n);p(this,"useResponsesApi",!1);p(this,"responses");p(this,"completions");this.fields=n,this.useResponsesApi=(n==null?void 0:n.useResponsesApi)??!1,this.responses=(n==null?void 0:n.responses)??new lU(n),this.completions=(n==null?void 0:n.completions)??new iU(n)}get lc_serializable_keys(){return[...super.lc_serializable_keys,"useResponsesApi"]}get callKeys(){return[...super.callKeys,"useResponsesApi"]}_useResponsesApi(n){var a,o,c,l,u;const r=(a=n==null?void 0:n.tools)==null?void 0:a.some(Fm),s=(n==null?void 0:n.previous_response_id)!=null||(n==null?void 0:n.text)!=null||(n==null?void 0:n.truncation)!=null||(n==null?void 0:n.include)!=null||((o=n==null?void 0:n.reasoning)==null?void 0:o.summary)!=null||((c=this.reasoning)==null?void 0:c.summary)!=null,i=((l=n==null?void 0:n.tools)==null?void 0:l.some(hT))||((u=n==null?void 0:n.tools)==null?void 0:u.some(du));return this.useResponsesApi||r||s||i||HL(this.model)}getLsParams(n){const r=this._combineCallOptions(n);return this._useResponsesApi(n)?this.responses.getLsParams(r):this.completions.getLsParams(r)}invocationParams(n){const r=this._combineCallOptions(n);return this._useResponsesApi(n)?this.responses.invocationParams(r):this.completions.invocationParams(r)}async _generate(n,r,s){return this._useResponsesApi(r)?this.responses._generate(n,r):this.completions._generate(n,r,s)}async*_streamResponseChunks(n,r,s){if(this._useResponsesApi(r)){yield*this.responses._streamResponseChunks(n,this._combineCallOptions(r),s);return}yield*this.completions._streamResponseChunks(n,this._combineCallOptions(r),s)}withConfig(n){const r=new qT(this.fields);return r.defaultOptions={...this.defaultOptions,...n},r}},JT={};Se(JT,{BaseLLM:()=>KT,LLM:()=>Jm});var KT=class eo extends ud{constructor(){super(...arguments);p(this,"lc_namespace",["langchain","llms",this._llmType()])}async invoke(n,r){const s=eo._convertInputToPromptValue(n);return(await this.generatePrompt([s],r,r==null?void 0:r.callbacks)).generations[0][0].text}async*_streamResponseChunks(n,r,s){throw new Error("Not implemented.")}_separateRunnableConfigFromCallOptionsCompat(n){const[r,s]=super._separateRunnableConfigFromCallOptions(n);return s.signal=r.signal,[r,s]}async*_streamIterator(n,r){if(this._streamResponseChunks===eo.prototype._streamResponseChunks)yield this.invoke(n,r);else{const s=eo._convertInputToPromptValue(n),[i,a]=this._separateRunnableConfigFromCallOptionsCompat(r),o=await wn.configure(i.callbacks,this.callbacks,i.tags,this.tags,i.metadata,this.metadata,{verbose:this.verbose}),c={options:a,invocation_params:this==null?void 0:this.invocationParams(a),batch_size:1},l=await(o==null?void 0:o.handleLLMStart(this.toJSON(),[s.toString()],i.runId,void 0,c,void 0,void 0,i.runName));let u=new ga({text:""});try{for await(const d of this._streamResponseChunks(s.toString(),a,l==null?void 0:l[0]))u?u=u.concat(d):u=d,typeof d.text=="string"&&(yield d.text)}catch(d){throw await Promise.all((l??[]).map(h=>h==null?void 0:h.handleLLMError(d))),d}await Promise.all((l??[]).map(d=>d==null?void 0:d.handleLLMEnd({generations:[[u]]})))}}async generatePrompt(n,r,s){const i=n.map(a=>a.toString());return this.generate(i,r,s)}invocationParams(n){return{}}_flattenLLMResult(n){const r=[];for(let s=0;s<n.generations.length;s+=1){const i=n.generations[s];if(s===0)r.push({generations:[i],llmOutput:n.llmOutput});else{const a=n.llmOutput?{...n.llmOutput,tokenUsage:{}}:void 0;r.push({generations:[i],llmOutput:a})}}return r}async _generateUncached(n,r,s,i){let a;if(i!==void 0&&i.length===n.length)a=i;else{const u=await wn.configure(s.callbacks,this.callbacks,s.tags,this.tags,s.metadata,this.metadata,{verbose:this.verbose}),d={options:r,invocation_params:this==null?void 0:this.invocationParams(r),batch_size:n.length};a=await(u==null?void 0:u.handleLLMStart(this.toJSON(),n,s.runId,void 0,d,void 0,void 0,s==null?void 0:s.runName))}const o=!!(a!=null&&a[0].handlers.find(Dp));let c;if(o&&n.length===1&&this._streamResponseChunks!==eo.prototype._streamResponseChunks)try{const u=await this._streamResponseChunks(n[0],r,a==null?void 0:a[0]);let d;for await(const h of u)d===void 0?d=h:d=Hs(d,h);if(d===void 0)throw new Error("Received empty response from chat model call.");c={generations:[[d]],llmOutput:{}},await(a==null?void 0:a[0].handleLLMEnd(c))}catch(u){throw await(a==null?void 0:a[0].handleLLMError(u)),u}else{try{c=await this._generate(n,r,a==null?void 0:a[0])}catch(d){throw await Promise.all((a??[]).map(h=>h==null?void 0:h.handleLLMError(d))),d}const u=this._flattenLLMResult(c);await Promise.all((a??[]).map((d,h)=>d==null?void 0:d.handleLLMEnd(u[h])))}const l=(a==null?void 0:a.map(u=>u.runId))||void 0;return Object.defineProperty(c,ko,{value:l?{runIds:l}:void 0,configurable:!0}),c}async _generateCached({prompts:n,cache:r,llmStringKey:s,parsedOptions:i,handledOptions:a,runId:o}){const c=await wn.configure(a.callbacks,this.callbacks,a.tags,this.tags,a.metadata,this.metadata,{verbose:this.verbose}),l={options:i,invocation_params:this==null?void 0:this.invocationParams(i),batch_size:n.length},u=await(c==null?void 0:c.handleLLMStart(this.toJSON(),n,o,void 0,l,void 0,void 0,a==null?void 0:a.runName)),d=[],f=(await Promise.allSettled(n.map(async(w,b)=>{const y=await r.lookup(w,s);return y==null&&d.push(b),y}))).map((w,b)=>({result:w,runManager:u==null?void 0:u[b]})).filter(({result:w})=>w.status==="fulfilled"&&w.value!=null||w.status==="rejected"),m=[];await Promise.all(f.map(async({result:w,runManager:b},y)=>{if(w.status==="fulfilled"){const v=w.value;return m[y]=v.map(T=>(T.generationInfo={...T.generationInfo,tokenUsage:{}},T)),v.length&&await(b==null?void 0:b.handleLLMNewToken(v[0].text)),b==null?void 0:b.handleLLMEnd({generations:[v]},void 0,void 0,void 0,{cached:!0})}else return await(b==null?void 0:b.handleLLMError(w.reason,void 0,void 0,void 0,{cached:!0})),Promise.reject(w.reason)}));const g={generations:m,missingPromptIndices:d,startedRunManagers:u};return Object.defineProperty(g,ko,{value:u?{runIds:u==null?void 0:u.map(w=>w.runId)}:void 0,configurable:!0}),g}async generate(n,r,s){if(!Array.isArray(n))throw new Error("Argument 'prompts' is expected to be a string[]");let i;Array.isArray(r)?i={stop:r}:i=r;const[a,o]=this._separateRunnableConfigFromCallOptionsCompat(i);if(a.callbacks=a.callbacks??s,!this.cache)return this._generateUncached(n,o,a);const{cache:c}=this,l=this._getSerializedCacheKeyParametersForCall(o),{generations:u,missingPromptIndices:d,startedRunManagers:h}=await this._generateCached({prompts:n,cache:c,llmStringKey:l,parsedOptions:o,handledOptions:a,runId:a.runId});let f={};if(d.length>0){const m=await this._generateUncached(d.map(g=>n[g]),o,a,h!==void 0?d.map(g=>h==null?void 0:h[g]):void 0);await Promise.all(m.generations.map(async(g,w)=>{const b=d[w];return u[b]=g,c.update(n[b],l,g)})),f=m.llmOutput??{}}return{generations:u,llmOutput:f}}_identifyingParams(){return{}}_modelType(){return"base_llm"}},Jm=class extends KT{async _generate(t,e,n){return{generations:await Promise.all(t.map((s,i)=>this._call(s,{...e,promptIndex:i},n).then(a=>[{text:a}])))}}},XT={};Se(XT,{chunkArray:()=>uU});const uU=(t,e)=>t.reduce((n,r,s)=>{const i=Math.floor(s/e),a=n[i]||[];return n[i]=a.concat([r]),n},[]);var YT={};Se(YT,{Embeddings:()=>Km});var Km=class{constructor(t){p(this,"caller");this.caller=new sc(t??{})}},QT={};Se(QT,{BaseToolkit:()=>dU,DynamicStructuredTool:()=>Qm,DynamicTool:()=>Ym,StructuredTool:()=>wc,Tool:()=>Xm,ToolInputParsingException:()=>bo,isLangChainTool:()=>sd,isRunnableToolLike:()=>Dm,isStructuredTool:()=>jm,isStructuredToolParams:()=>Um,tool:()=>fd});var wc=class extends Hm{constructor(e){super(e??{});p(this,"extras");p(this,"returnDirect",!1);p(this,"verboseParsingErrors",!1);p(this,"responseFormat","content");p(this,"defaultConfig");this.verboseParsingErrors=(e==null?void 0:e.verboseParsingErrors)??this.verboseParsingErrors,this.responseFormat=(e==null?void 0:e.responseFormat)??this.responseFormat,this.defaultConfig=(e==null?void 0:e.defaultConfig)??this.defaultConfig,this.metadata=(e==null?void 0:e.metadata)??this.metadata,this.extras=(e==null?void 0:e.extras)??this.extras}get lc_namespace(){return["langchain","tools"]}async invoke(e,n){let r,s=Ze(Zn(this.defaultConfig,n));return so(e)?(r=e.args,s={...s,toolCall:e}):r=e,this.call(r,s)}async call(e,n,r){const s=so(e)?e.args:e;let i;if(ar(this.schema))try{i=await Zu(this.schema,s)}catch(m){let g="Received tool input did not match expected schema";throw this.verboseParsingErrors&&(g=`${g}
Details: ${m.message}`),t0(m)&&(g=`${g}

${Fu(m)}`),new bo(g,JSON.stringify(e))}else{const m=ut(s,this.schema);if(!m.valid){let g="Received tool input did not match expected schema";throw this.verboseParsingErrors&&(g=`${g}
Details: ${m.errors.map(w=>`${w.keywordLocation}: ${w.error}`).join(`
`)}`),new bo(g,JSON.stringify(e))}i=s}const a=nc(n),o=wn.configure(a.callbacks,this.callbacks,a.tags||r,this.tags,a.metadata,this.metadata,{verbose:this.verbose}),c=await(o==null?void 0:o.handleToolStart(this.toJSON(),typeof e=="string"?e:JSON.stringify(e),a.runId,void 0,void 0,void 0,a.runName));delete a.runId;let l;try{l=await this._call(i,c,a)}catch(m){throw await(c==null?void 0:c.handleToolError(m)),m}let u,d;if(this.responseFormat==="content_and_artifact")if(Array.isArray(l)&&l.length===2)[u,d]=l;else throw new Error(`Tool response format is "content_and_artifact" but the output was not a two-tuple.
Result: ${JSON.stringify(l)}`);else u=l;let h;so(e)&&(h=e.id),!h&&qI(a)&&(h=a.toolCall.id);const f=hU({content:u,artifact:d,toolCallId:h,name:this.name,metadata:this.metadata});return await(c==null?void 0:c.handleToolEnd(f)),f}},Xm=class extends wc{constructor(e){super(e);p(this,"schema",Ve({input:Ue().optional()}).transform(e=>e.input))}call(e,n){const r=typeof e=="string"||e==null?{input:e}:e;return super.call(r,n)}},Ym=class extends Xm{constructor(e){super(e);p(this,"name");p(this,"description");p(this,"func");this.name=e.name,this.description=e.description,this.func=e.func,this.returnDirect=e.returnDirect??this.returnDirect}static lc_name(){return"DynamicTool"}async call(e,n){const r=nc(n);return r.runName===void 0&&(r.runName=this.name),super.call(e,r)}async _call(e,n,r){return this.func(e,n,r)}},Qm=class extends wc{constructor(e){super(e);p(this,"name");p(this,"description");p(this,"func");p(this,"schema");this.name=e.name,this.description=e.description,this.func=e.func,this.returnDirect=e.returnDirect??this.returnDirect,this.schema=e.schema}static lc_name(){return"DynamicStructuredTool"}async call(e,n,r){const s=nc(n);return s.runName===void 0&&(s.runName=this.name),super.call(e,s,r)}_call(e,n,r){return this.func(e,n,r)}},dU=class{getTools(){return this.tools}};function fd(t,e){var a;const n=im(e.schema),r=lo(e.schema);if(!e.schema||n||r)return new Ym({...e,description:e.description??((a=e.schema)==null?void 0:a.description)??`${e.name} tool`,func:async(o,c,l)=>new Promise((u,d)=>{const h=Xe(l,{callbacks:c==null?void 0:c.getChild()});Ft.runWithConfig(ps(h),async()=>{try{u(t(o,h))}catch(f){d(f)}})})});const s=e.schema,i=e.description??e.schema.description??`${e.name} tool`;return new Qm({...e,description:i,schema:s,func:async(o,c,l)=>new Promise((u,d)=>{let h;const f=()=>{l!=null&&l.signal&&h&&l.signal.removeEventListener("abort",h)};l!=null&&l.signal&&(h=()=>{f(),d(So(l.signal))},l.signal.addEventListener("abort",h));const m=Xe(l,{callbacks:c==null?void 0:c.getChild()});Ft.runWithConfig(ps(m),async()=>{var g;try{const w=await t(o,m);if((g=l==null?void 0:l.signal)!=null&&g.aborted){f();return}f(),u(w)}catch(w){f(),d(w)}})})})}function hU(t){const{content:e,artifact:n,toolCallId:r,metadata:s}=t;return r&&!Cp(e)?typeof e=="string"||Array.isArray(e)&&e.every(i=>typeof i=="object")?new Pe({status:"success",content:e,artifact:n,tool_call_id:r,name:t.name,metadata:s}):new Pe({status:"success",content:fU(e),artifact:n,tool_call_id:r,name:t.name,metadata:s}):e}function fU(t){try{return JSON.stringify(t,null,2)??""}catch{return`${t}`}}const pU=fn({type:Yn("screenshot")}),mU=fn({type:Yn("click"),x:ln(),y:ln(),button:zm(["left","right","wheel","back","forward"]).default("left")}),gU=fn({type:Yn("double_click"),x:ln(),y:ln(),button:zm(["left","right","wheel","back","forward"]).default("left")}),yU=fn({type:Yn("drag"),path:pc(fn({x:ln(),y:ln()}))}),_U=fn({type:Yn("keypress"),keys:pc(zn())}),wU=fn({type:Yn("move"),x:ln(),y:ln()}),vU=fn({type:Yn("scroll"),x:ln(),y:ln(),scroll_x:ln(),scroll_y:ln()}),bU=fn({type:Yn("type"),text:zn()}),EU=fn({type:Yn("wait"),duration:ln().optional()}),TU=Bm("type",[pU,mU,gU,yU,_U,wU,vU,bU,EU]);fn({action:TU});const SU=fn({type:Yn("exec"),command:pc(zn()),env:Y2(zn(),zn()).optional(),working_directory:zn().optional(),timeout_ms:ln().optional(),user:zn().optional()});Bm("type",[SU]);fn({commands:pc(zn()).describe("Array of shell commands to execute"),timeout_ms:ln().optional().describe("Optional timeout in milliseconds for the commands"),max_output_length:ln().optional().describe("Optional maximum number of characters to return from each command")});const xU=fn({type:Yn("create_file"),path:zn(),diff:zn()}),kU=fn({type:Yn("update_file"),path:zn(),diff:zn()}),IU=fn({type:Yn("delete_file"),path:zn()});Bm("type",[xU,kU,IU]);function AU(t,e){const[n,r]=t.length>e.length?[t,e]:[e,t];if(!n.length)return 1;const s=new Set(n);return[...r].filter(a=>s.has(a)).length/n.length}function CU(t,e){const n=new Set(t.toLowerCase().match(/[a-z0-9']+/gi)||[]),r=new Set(e.toLowerCase().match(/[a-z0-9']+/gi)||[]),s=new Set([...n].filter(a=>r.has(a))),i=new Set([...n,...r]);return i.size?s.size/i.size:0}function OU(t,e){return!t||!e?0:.7*AU(t,e)+.3*CU(t,e)}function eS(t){const e=t.split(/\s+/).join(" ").trim(),n=e.match(/^\[[^\]]+\]\s*(.*)$/);return n?n[1].trim():e}function tS(t,e,n=!1){const r=t.length,s=e.length;if(r===0)return[];const{GAP_PENALTY:i,TAIL_GUARD_SIZE:a,LENGTH_TOLERANCE:o}=nI,c=Array(r+1).fill(null).map(()=>Array(s+1).fill(-1/0)),l=Array(r+1).fill(null).map(()=>Array(s+1).fill(null));c[0][0]=0;for(let m=1;m<=r;m++)c[m][0]=c[m-1][0]+i,l[m][0]="O";for(let m=1;m<=s;m++)c[0][m]=c[0][m-1]+i,l[0][m]="R";for(let m=1;m<=r;m++){const g=t[m-1].text;for(let w=1;w<=s;w++){const b=e[w-1];let y=c[m-1][w-1]+OU(g,b),v="M";const T=c[m-1][w]+i;T>y&&(y=T,v="O");const A=c[m][w-1]+i;A>y&&(y=A,v="R"),c[m][w]=y,l[m][w]=v}}const u=Array(r).fill(null);let d=r,h=s;for(;d>0||h>0;){const m=l[d][h];if(m==="M"&&d>0&&h>0)u[d-1]=h-1,d--,h--;else if(m==="O"&&d>0)u[d-1]=null,d--;else if(m==="R"&&h>0)h--;else if(d>0)u[d-1]=null,d--;else if(h>0)h--;else break}const f=n?r-a:r+1;return t.map((m,g)=>{const w=u[g];let b=w!==null&&w>=0&&w<s?e[w]:m.text;if(g>=f&&b){const y=m.text.length||1;Math.abs(b.length-y)/y>o&&(b=m.text)}return{text:b||m.text,startTime:m.startTime,endTime:m.endTime}})}function nS(t,e){const n=[],r=t.length;let s=0;for(;s<r;){const i=Math.min(s+e,r);n.push([s,i]),s=i}return n}function $U(t,e,n,r){let s=t.split(n);const i=nS(e,r);for(;s.length<i.length;)s.push("");const a=[];for(let o=0;o<i.length;o++){const[c,l]=i[o],u=s[o],d=e.slice(c,l),f=u.trim().split(`
`).filter(g=>g.trim()).map(g=>g.split(/\s+/).join(" ")).map(eS).filter(g=>g);f.length!==d.length&&console.warn(`Parser chunk ${o+1}/${i.length} warning: expected ${d.length} lines, got ${f.length}`);const m=tS(d,f,!0);a.push(...m)}return a}function RU(t,e){const n=t.replace(/\r\n?/g,`
`).trim().split(`
`).map(eS).filter(r=>r.trim().length>0);return n.length!==e.length&&console.warn(`Parser warning: Expected ${e.length} lines, got ${n.length} lines`),tS(e,n,!1)}function NU(t,e,n,r){return t?t.includes(n)?$U(t,e,n,r):RU(t,e):[]}const PU=`You are correcting segments of a YouTube video transcript. These segments could be from anywhere in the video (beginning, middle, or end). Use the video title and description for context.

CRITICAL CONSTRAINTS:
- Only fix typos and grammar. Do NOT change meaning or structure.
- PRESERVE ALL NEWLINES: each line is a distinct transcript segment.
- Do NOT add, remove, or merge lines. Keep the same number of lines.
- MAINTAIN SIMILAR LINE LENGTHS: Each output line should be approximately the same character count as its corresponding input line (10% tolerance). Do NOT expand short lines into long paragraphs. Do NOT condense long lines significantly. Keep each line concise.
- If a sentence is broken across lines, keep it broken the same way.
- PRESERVE THE ORIGINAL LANGUAGE: output must be in the same language as the input transcript.
- Focus on minimal corrections: fix typos, correct grammar errors, but keep expansions/additions to an absolute minimum.

EXAMPLES OF CORRECT BEHAVIOR:

Input:
up to 900. From 900 up to 1,100.
If you sold at the reasonable
valuations, when the gains that already
been had, you missed out big time. I 

Output:
up to $900. From $900 up to $1,100.
If you sold at the reasonable
valuations, when the gains that already
had been had, you missed out big time. I`;function MU(t){return t.split(/\s+/).join(" ")}function LU(t,e){return[`Video Title: ${t||""}`,`Video Description: ${e||""}`,"","Transcript Chunk:"].join(`
`)}function jU(t,e){return new HT({model:e,apiKey:t,configuration:{baseURL:jw.OPENROUTER_BASE_URL,defaultHeaders:{"HTTP-Referer":chrome.runtime.getURL(""),"X-Title":"Better YouTube"}},temperature:0})}function DU(t){const e=t==null?void 0:t.content;return typeof e=="string"?e:Array.isArray(e)?e.map(n=>typeof n=="string"?n:(n==null?void 0:n.text)||"").join(""):e!=null?String(e):""}async function UU(t,e,n,r,s,i=Ll.MODEL_REFINER){if(!t.length)return[];const a=jU(r,i),o=LU(e,n),c=nS(t,Sc.MAX_SEGMENTS_PER_CHUNK),l=[],u=[];for(let m=0;m<c.length;m++){const[g,w]=c[m],b=t.slice(g,w),y=b.map(v=>MU(v.text)).join(`
`);l.push([new kt({content:PU}),new ht({content:`${o}
${y}`})]),u.push({chunkIdx:m+1,expectedLineCount:b.length})}const d=await a.batch(l),h=[];for(let m=0;m<d.length;m++){const{chunkIdx:g,expectedLineCount:w}=u[m],y=DU(d[m]).trim().split(`
`);y.length!==w&&console.warn(`Line count mismatch in chunk ${g}: expected ${w}, got ${y.length}`),h.push(...y,Sc.CHUNK_SENTINEL)}const f=h.join(`
`);return NU(f,t,Sc.CHUNK_SENTINEL,Sc.MAX_SEGMENTS_PER_CHUNK)}var vc=class extends Fe{constructor(e){super(e);p(this,"lc_serializable",!0);p(this,"lc_namespace",["langchain_core","prompts",this._getPromptType()]);p(this,"inputVariables");p(this,"outputParser");p(this,"partialVariables");p(this,"metadata");p(this,"tags");const{inputVariables:n}=e;if(n.includes("stop"))throw new Error("Cannot have an input variable named 'stop', as it is used internally, please rename.");Object.assign(this,e)}get lc_attributes(){return{partialVariables:void 0}}async mergePartialAndUserVariables(e){const n=this.partialVariables??{},r={};for(const[i,a]of Object.entries(n))typeof a=="string"?r[i]=a:r[i]=await a();return{...r,...e}}async invoke(e,n){const r={...this.metadata,...n==null?void 0:n.metadata},s=[...this.tags??[],...(n==null?void 0:n.tags)??[]];return this._callWithConfig(i=>this.formatPromptValue(i),e,{...n,tags:s,metadata:r,runType:"prompt"})}},jo=class extends vc{async formatPromptValue(t){const e=await this.format(t);return new Zm(e)}};/*!
 * mustache.js - Logic-less {{mustache}} templates with JavaScript
 * http://github.com/janl/mustache.js
 */var FU=Object.prototype.toString,La=Array.isArray||function(e){return FU.call(e)==="[object Array]"};function eg(t){return typeof t=="function"}function BU(t){return La(t)?"array":typeof t}function fh(t){return t.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")}function H_(t,e){return t!=null&&typeof t=="object"&&e in t}function zU(t,e){return t!=null&&typeof t!="object"&&t.hasOwnProperty&&t.hasOwnProperty(e)}var ZU=RegExp.prototype.test;function VU(t,e){return ZU.call(t,e)}var GU=/\S/;function WU(t){return!VU(GU,t)}var HU={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"};function qU(t){return String(t).replace(/[&<>"'`=\/]/g,function(n){return HU[n]})}var JU=/\s*/,KU=/\s+/,q_=/\s*=/,XU=/\s*\}/,YU=/#|\^|\/|>|\{|&|=|!/;function QU(t,e){if(!t)return[];var n=!1,r=[],s=[],i=[],a=!1,o=!1,c="",l=0;function u(){if(a&&!o)for(;i.length;)delete s[i.pop()];else i=[];a=!1,o=!1}var d,h,f;function m(S){if(typeof S=="string"&&(S=S.split(KU,2)),!La(S)||S.length!==2)throw new Error("Invalid tags: "+S);d=new RegExp(fh(S[0])+"\\s*"),h=new RegExp("\\s*"+fh(S[1])),f=new RegExp("\\s*"+fh("}"+S[1]))}m(e||Pn.tags);for(var g=new bc(t),w,b,y,v,T,A;!g.eos();){if(w=g.pos,y=g.scanUntil(d),y)for(var I=0,$=y.length;I<$;++I)v=y.charAt(I),WU(v)?(i.push(s.length),c+=v):(o=!0,n=!0,c+=" "),s.push(["text",v,w,w+1]),w+=1,v===`
`&&(u(),c="",l=0,n=!1);if(!g.scan(d))break;if(a=!0,b=g.scan(YU)||"name",g.scan(JU),b==="="?(y=g.scanUntil(q_),g.scan(q_),g.scanUntil(h)):b==="{"?(y=g.scanUntil(f),g.scan(XU),g.scanUntil(h),b="&"):y=g.scanUntil(h),!g.scan(h))throw new Error("Unclosed tag at "+g.pos);if(b==">"?T=[b,y,w,g.pos,c,l,n]:T=[b,y,w,g.pos],l++,s.push(T),b==="#"||b==="^")r.push(T);else if(b==="/"){if(A=r.pop(),!A)throw new Error('Unopened section "'+y+'" at '+w);if(A[1]!==y)throw new Error('Unclosed section "'+A[1]+'" at '+w)}else b==="name"||b==="{"||b==="&"?o=!0:b==="="&&m(y)}if(u(),A=r.pop(),A)throw new Error('Unclosed section "'+A[1]+'" at '+g.pos);return t4(e4(s))}function e4(t){for(var e=[],n,r,s=0,i=t.length;s<i;++s)n=t[s],n&&(n[0]==="text"&&r&&r[0]==="text"?(r[1]+=n[1],r[3]=n[3]):(e.push(n),r=n));return e}function t4(t){for(var e=[],n=e,r=[],s,i,a=0,o=t.length;a<o;++a)switch(s=t[a],s[0]){case"#":case"^":n.push(s),r.push(s),n=s[4]=[];break;case"/":i=r.pop(),i[5]=s[2],n=r.length>0?r[r.length-1][4]:e;break;default:n.push(s)}return e}function bc(t){this.string=t,this.tail=t,this.pos=0}bc.prototype.eos=function(){return this.tail===""};bc.prototype.scan=function(e){var n=this.tail.match(e);if(!n||n.index!==0)return"";var r=n[0];return this.tail=this.tail.substring(r.length),this.pos+=r.length,r};bc.prototype.scanUntil=function(e){var n=this.tail.search(e),r;switch(n){case-1:r=this.tail,this.tail="";break;case 0:r="";break;default:r=this.tail.substring(0,n),this.tail=this.tail.substring(n)}return this.pos+=r.length,r};function Ta(t,e){this.view=t,this.cache={".":this.view},this.parent=e}Ta.prototype.push=function(e){return new Ta(e,this)};Ta.prototype.lookup=function(e){var n=this.cache,r;if(n.hasOwnProperty(e))r=n[e];else{for(var s=this,i,a,o,c=!1;s;){if(e.indexOf(".")>0)for(i=s.view,a=e.split("."),o=0;i!=null&&o<a.length;)o===a.length-1&&(c=H_(i,a[o])||zU(i,a[o])),i=i[a[o++]];else i=s.view[e],c=H_(s.view,e);if(c){r=i;break}s=s.parent}n[e]=r}return eg(r)&&(r=r.call(this.view)),r};function bn(){this.templateCache={_cache:{},set:function(e,n){this._cache[e]=n},get:function(e){return this._cache[e]},clear:function(){this._cache={}}}}bn.prototype.clearCache=function(){typeof this.templateCache<"u"&&this.templateCache.clear()};bn.prototype.parse=function(e,n){var r=this.templateCache,s=e+":"+(n||Pn.tags).join(":"),i=typeof r<"u",a=i?r.get(s):void 0;return a==null&&(a=QU(e,n),i&&r.set(s,a)),a};bn.prototype.render=function(e,n,r,s){var i=this.getConfigTags(s),a=this.parse(e,i),o=n instanceof Ta?n:new Ta(n,void 0);return this.renderTokens(a,o,r,e,s)};bn.prototype.renderTokens=function(e,n,r,s,i){for(var a="",o,c,l,u=0,d=e.length;u<d;++u)l=void 0,o=e[u],c=o[0],c==="#"?l=this.renderSection(o,n,r,s,i):c==="^"?l=this.renderInverted(o,n,r,s,i):c===">"?l=this.renderPartial(o,n,r,i):c==="&"?l=this.unescapedValue(o,n):c==="name"?l=this.escapedValue(o,n,i):c==="text"&&(l=this.rawValue(o)),l!==void 0&&(a+=l);return a};bn.prototype.renderSection=function(e,n,r,s,i){var a=this,o="",c=n.lookup(e[1]);function l(h){return a.render(h,n,r,i)}if(c){if(La(c))for(var u=0,d=c.length;u<d;++u)o+=this.renderTokens(e[4],n.push(c[u]),r,s,i);else if(typeof c=="object"||typeof c=="string"||typeof c=="number")o+=this.renderTokens(e[4],n.push(c),r,s,i);else if(eg(c)){if(typeof s!="string")throw new Error("Cannot use higher-order sections without the original template");c=c.call(n.view,s.slice(e[3],e[5]),l),c!=null&&(o+=c)}else o+=this.renderTokens(e[4],n,r,s,i);return o}};bn.prototype.renderInverted=function(e,n,r,s,i){var a=n.lookup(e[1]);if(!a||La(a)&&a.length===0)return this.renderTokens(e[4],n,r,s,i)};bn.prototype.indentPartial=function(e,n,r){for(var s=n.replace(/[^ \t]/g,""),i=e.split(`
`),a=0;a<i.length;a++)i[a].length&&(a>0||!r)&&(i[a]=s+i[a]);return i.join(`
`)};bn.prototype.renderPartial=function(e,n,r,s){if(r){var i=this.getConfigTags(s),a=eg(r)?r(e[1]):r[e[1]];if(a!=null){var o=e[6],c=e[5],l=e[4],u=a;c==0&&l&&(u=this.indentPartial(a,l,o));var d=this.parse(u,i);return this.renderTokens(d,n,r,u,s)}}};bn.prototype.unescapedValue=function(e,n){var r=n.lookup(e[1]);if(r!=null)return r};bn.prototype.escapedValue=function(e,n,r){var s=this.getConfigEscape(r)||Pn.escape,i=n.lookup(e[1]);if(i!=null)return typeof i=="number"&&s===Pn.escape?String(i):s(i)};bn.prototype.rawValue=function(e){return e[1]};bn.prototype.getConfigTags=function(e){return La(e)?e:e&&typeof e=="object"?e.tags:void 0};bn.prototype.getConfigEscape=function(e){if(e&&typeof e=="object"&&!La(e))return e.escape};var Pn={name:"mustache.js",version:"4.2.0",tags:["{{","}}"],clearCache:void 0,escape:void 0,parse:void 0,render:void 0,Scanner:void 0,Context:void 0,Writer:void 0,set templateCache(t){Do.templateCache=t},get templateCache(){return Do.templateCache}},Do=new bn;Pn.clearCache=function(){return Do.clearCache()};Pn.parse=function(e,n){return Do.parse(e,n)};Pn.render=function(e,n,r,s){if(typeof e!="string")throw new TypeError('Invalid template! Template should be a "string" but "'+BU(e)+'" was given as the first argument for mustache#render(template, view, partials)');return Do.render(e,n,r,s)};Pn.escape=qU;Pn.Scanner=bc;Pn.Context=Ta;Pn.Writer=bn;function rS(){Pn.escape=t=>t}const Uo=t=>{const e=t.split(""),n=[],r=(i,a)=>{for(let o=a;o<e.length;o+=1)if(i.includes(e[o]))return o;return-1};let s=0;for(;s<e.length;)if(e[s]==="{"&&s+1<e.length&&e[s+1]==="{")n.push({type:"literal",text:"{"}),s+=2;else if(e[s]==="}"&&s+1<e.length&&e[s+1]==="}")n.push({type:"literal",text:"}"}),s+=2;else if(e[s]==="{"){const i=r("}",s);if(i<0)throw new Error("Unclosed '{' in template.");n.push({type:"variable",name:e.slice(s+1,i).join("")}),s=i+1}else{if(e[s]==="}")throw new Error("Single '}' in template.");{const i=r("{}",s),a=(i<0?e.slice(s):e.slice(s,i)).join("");n.push({type:"literal",text:a}),s=i<0?e.length:i}}return n},sS=(t,e=[])=>{const n=[];for(const r of t)if(r[0]==="name"){const s=r[1].includes(".")?r[1].split(".")[0]:r[1];n.push({type:"variable",name:s})}else if(["#","&","^",">"].includes(r[0])){if(n.push({type:"variable",name:r[1]}),r[0]==="#"&&r.length>4&&Array.isArray(r[4])){const s=[...e,r[1]],i=sS(r[4],s);n.push(...i)}}else n.push({type:"literal",text:r[1]});return n},mu=t=>{rS();const e=Pn.parse(t);return sS(e)},iS=(t,e)=>Uo(t).reduce((n,r)=>{if(r.type==="variable"){if(r.name in e){const s=typeof e[r.name]=="string"?e[r.name]:JSON.stringify(e[r.name]);return n+s}throw new Error(`(f-string) Missing value for input ${r.name}`)}return n+r.text},""),aS=(t,e)=>(rS(),Pn.render(t,e)),gu={"f-string":iS,mustache:aS},oS={"f-string":Uo,mustache:mu},Tr=(t,e,n)=>{try{return gu[e](t,n)}catch(r){throw Ou(r,"INVALID_PROMPT_INPUT")}},yu=(t,e)=>oS[e](t),Ec=(t,e,n)=>{if(!(e in gu)){const r=Object.keys(gu);throw new Error(`Invalid template format. Got \`${e}\`;
                         should be one of ${r}`)}try{const r=n.reduce((s,i)=>(s[i]="foo",s),{});Array.isArray(t)?t.forEach(s=>{if(s.type==="text"&&"text"in s&&typeof s.text=="string")Tr(s.text,e,r);else if(s.type==="image_url"){if(typeof s.image_url=="string")Tr(s.image_url,e,r);else if(typeof s.image_url=="object"&&s.image_url!==null&&"url"in s.image_url&&typeof s.image_url.url=="string"){const i=s.image_url.url;Tr(i,e,r)}}else throw new Error(`Invalid message template received. ${JSON.stringify(s,null,2)}`)}):Tr(t,e,r)}catch(r){throw new Error(`Invalid prompt schema: ${r.message}`)}};var Vs=class to extends jo{constructor(n){super(n);p(this,"template");p(this,"templateFormat","f-string");p(this,"validateTemplate",!0);p(this,"additionalContentFields");if(n.templateFormat==="mustache"&&n.validateTemplate===void 0&&(this.validateTemplate=!1),Object.assign(this,n),this.validateTemplate){if(this.templateFormat==="mustache")throw new Error("Mustache templates cannot be validated.");let r=this.inputVariables;this.partialVariables&&(r=r.concat(Object.keys(this.partialVariables))),Ec(this.template,this.templateFormat,r)}}static lc_name(){return"PromptTemplate"}_getPromptType(){return"prompt"}async format(n){const r=await this.mergePartialAndUserVariables(n);return Tr(this.template,this.templateFormat,r)}static fromExamples(n,r,s,i=`

`,a=""){const o=[a,...n,r].join(i);return new to({inputVariables:s,template:o})}static fromTemplate(n,r){const{templateFormat:s="f-string",...i}=r??{},a=new Set;return yu(n,s).forEach(o=>{o.type==="variable"&&a.add(o.name)}),new to({inputVariables:[...a],templateFormat:s,template:n,...i})}async partial(n){const r=this.inputVariables.filter(a=>!(a in n)),s={...this.partialVariables??{},...n},i={...this,inputVariables:r,partialVariables:s};return new to(i)}serialize(){if(this.outputParser!==void 0)throw new Error("Cannot serialize a prompt template with an output parser");return{_type:this._getPromptType(),input_variables:this.inputVariables,template:this.template,template_format:this.templateFormat}}static async deserialize(n){if(!n.template)throw new Error("Prompt template must have a template");return new to({inputVariables:n.input_variables,template:n.template,templateFormat:n.template_format})}},gl=class cS extends vc{constructor(n){super(n);p(this,"lc_namespace",["langchain_core","prompts","image"]);p(this,"template");p(this,"templateFormat","f-string");p(this,"validateTemplate",!0);p(this,"additionalContentFields");if(this.template=n.template,this.templateFormat=n.templateFormat??this.templateFormat,this.validateTemplate=n.validateTemplate??this.validateTemplate,this.additionalContentFields=n.additionalContentFields,this.validateTemplate){let r=this.inputVariables;this.partialVariables&&(r=r.concat(Object.keys(this.partialVariables))),Ec([{type:"image_url",image_url:this.template}],this.templateFormat,r)}}static lc_name(){return"ImagePromptTemplate"}_getPromptType(){return"prompt"}async partial(n){const r=this.inputVariables.filter(a=>!(a in n)),s={...this.partialVariables??{},...n},i={...this,inputVariables:r,partialVariables:s};return new cS(i)}async format(n){const r={};for(const[o,c]of Object.entries(this.template))typeof c=="string"?r[o]=Tr(c,this.templateFormat,n):r[o]=c;const s=n.url||r.url,i=n.detail||r.detail;if(!s)throw new Error("Must provide either an image URL.");if(typeof s!="string")throw new Error("url must be a string.");const a={url:s};return i&&(a.detail=i),a}async formatPromptValue(n){const r=await this.format(n);return new TT(r)}},Zf=class extends Fe{constructor(e){const n=e.templateFormat??"f-string",r=Vf(e.template,n);super({inputVariables:r,...e});p(this,"lc_namespace",["langchain_core","prompts","dict"]);p(this,"lc_serializable",!0);p(this,"template");p(this,"templateFormat");p(this,"inputVariables");this.template=e.template,this.templateFormat=n,this.inputVariables=r}static lc_name(){return"DictPromptTemplate"}async format(e){return Gf(this.template,e,this.templateFormat)}async invoke(e){return await this._callWithConfig(this.format.bind(this),e,{runType:"prompt"})}};function Vf(t,e){const n=[];for(const r of Object.values(t))if(typeof r=="string")yu(r,e).forEach(s=>{s.type==="variable"&&n.push(s.name)});else if(Array.isArray(r))for(const s of r)typeof s=="string"?yu(s,e).forEach(i=>{i.type==="variable"&&n.push(i.name)}):typeof s=="object"&&n.push(...Vf(s,e));else typeof r=="object"&&r!==null&&n.push(...Vf(r,e));return Array.from(new Set(n))}function Gf(t,e,n){const r={};for(const[s,i]of Object.entries(t))if(typeof i=="string")r[s]=Tr(i,n,e);else if(Array.isArray(i)){const a=[];for(const o of i)typeof o=="string"?a.push(Tr(o,n,e)):typeof o=="object"&&a.push(Gf(o,e,n));r[s]=a}else typeof i=="object"&&i!==null?r[s]=Gf(i,e,n):r[s]=i;return r}var pd=class extends Fe{constructor(){super(...arguments);p(this,"lc_namespace",["langchain_core","prompts","chat"]);p(this,"lc_serializable",!0)}async invoke(e,n){return this._callWithConfig(r=>this.formatMessages(r),e,{...n,runType:"prompt"})}},Wf=class extends pd{constructor(e){typeof e=="string"&&(e={variableName:e});super(e);p(this,"variableName");p(this,"optional");this.variableName=e.variableName,this.optional=e.optional??!1}static lc_name(){return"MessagesPlaceholder"}get inputVariables(){return[this.variableName]}async formatMessages(e){const n=e[this.variableName];if(this.optional&&!n)return[];if(!n){const s=new Error(`Field "${this.variableName}" in prompt uses a MessagesPlaceholder, which expects an array of BaseMessages as an input value. Received: undefined`);throw s.name="InputFormatError",s}let r;try{Array.isArray(n)?r=n.map(Zr):r=[Zr(n)]}catch(s){const i=typeof n=="string"?n:JSON.stringify(n,null,2),a=new Error([`Field "${this.variableName}" in prompt uses a MessagesPlaceholder, which expects an array of BaseMessages or coerceable values as input.`,`Received value: ${i}`,`Additional message: ${s.message}`].join(`

`));throw a.name="InputFormatError",a.lc_error_code=s.lc_error_code,a}return r}},lS=class extends pd{constructor(e){"prompt"in e||(e={prompt:e});super(e);p(this,"prompt");this.prompt=e.prompt}get inputVariables(){return this.prompt.inputVariables}async formatMessages(e){return[await this.format(e)]}},tg=class extends vc{constructor(t){super(t)}async format(t){return(await this.formatPromptValue(t)).toString()}async formatPromptValue(t){const e=await this.formatMessages(t);return new Vm(e)}},uS=class extends lS{constructor(e,n){"prompt"in e||(e={prompt:e,role:n});super(e);p(this,"role");this.role=e.role}static lc_name(){return"ChatMessagePromptTemplate"}async format(e){return new vs(await this.prompt.format(e),this.role)}static fromTemplate(e,n,r){return new this(Vs.fromTemplate(e,{templateFormat:r==null?void 0:r.templateFormat}),n)}};function n4(t){return t===null||typeof t!="object"||Array.isArray(t)?!1:Object.keys(t).length===1&&"text"in t&&typeof t.text=="string"}function r4(t){return t===null||typeof t!="object"||Array.isArray(t)?!1:"image_url"in t&&(typeof t.image_url=="string"||typeof t.image_url=="object"&&t.image_url!==null&&"url"in t.image_url&&typeof t.image_url.url=="string")}var ng=class extends pd{constructor(e,n){"prompt"in e||(e={prompt:e});super(e);p(this,"lc_namespace",["langchain_core","prompts","chat"]);p(this,"lc_serializable",!0);p(this,"inputVariables",[]);p(this,"additionalOptions",{});p(this,"prompt");p(this,"messageClass");p(this,"chatMessageClass");if(this.prompt=e.prompt,Array.isArray(this.prompt)){let r=[];this.prompt.forEach(s=>{"inputVariables"in s&&(r=r.concat(s.inputVariables))}),this.inputVariables=r}else this.inputVariables=this.prompt.inputVariables;this.additionalOptions=n??this.additionalOptions}static _messageClass(){throw new Error("Can not invoke _messageClass from inside _StringImageMessagePromptTemplate")}createMessage(e){const n=this.constructor;if(n._messageClass()){const r=n._messageClass();return new r({content:e})}else if(n.chatMessageClass){const r=n.chatMessageClass();return new r({content:e,role:this.getRoleFromMessageClass(r.lc_name())})}else throw new Error("No message class defined")}getRoleFromMessageClass(e){switch(e){case"HumanMessage":return"human";case"AIMessage":return"ai";case"SystemMessage":return"system";case"ChatMessage":return"chat";default:throw new Error("Invalid message class name")}}static fromTemplate(e,n){if(typeof e=="string")return new this(Vs.fromTemplate(e,n));const r=[];for(const s of e)if(typeof s=="string")r.push(Vs.fromTemplate(s,n));else if(s!==null)if(n4(s)){let i="";typeof s.text=="string"&&(i=s.text??"");const a={...n,additionalContentFields:s};r.push(Vs.fromTemplate(i,a))}else if(r4(s)){let i=s.image_url??"",a,o=[];if(typeof i=="string"){let c;(n==null?void 0:n.templateFormat)==="mustache"?c=mu(i):c=Uo(i);const l=c.flatMap(u=>u.type==="variable"?[u.name]:[]);if(((l==null?void 0:l.length)??0)>0){if(l.length>1)throw new Error(`Only one format variable allowed per image template.
Got: ${l}
From: ${i}`);o=[l[0]]}else o=[];i={url:i},a=new gl({template:i,inputVariables:o,templateFormat:n==null?void 0:n.templateFormat,additionalContentFields:s})}else if(typeof i=="object"){if("url"in i){let c;(n==null?void 0:n.templateFormat)==="mustache"?c=mu(i.url):c=Uo(i.url),o=c.flatMap(l=>l.type==="variable"?[l.name]:[])}else o=[];a=new gl({template:i,inputVariables:o,templateFormat:n==null?void 0:n.templateFormat,additionalContentFields:s})}else throw new Error("Invalid image template");r.push(a)}else typeof s=="object"&&r.push(new Zf({template:s,templateFormat:n==null?void 0:n.templateFormat}));return new this({prompt:r,additionalOptions:n})}async format(e){if(this.prompt instanceof jo){const n=await this.prompt.format(e);return this.createMessage(n)}else{const n=[];for(const r of this.prompt){let s={};if(!("inputVariables"in r))throw new Error(`Prompt ${r} does not have inputVariables defined.`);for(const i of r.inputVariables)s||(s={[i]:e[i]}),s={...s,[i]:e[i]};if(r instanceof jo){const i=await r.format(s);let a;"additionalContentFields"in r&&(a=r.additionalContentFields),i!==""&&n.push({...a,type:"text",text:i})}else if(r instanceof gl){const i=await r.format(s);let a;"additionalContentFields"in r&&(a=r.additionalContentFields),n.push({...a,type:"image_url",image_url:i})}else if(r instanceof Zf){const i=await r.format(s);let a;"additionalContentFields"in r&&(a=r.additionalContentFields),n.push({...a,...i})}}return this.createMessage(n)}}async formatMessages(e){return[await this.format(e)]}},rg=class extends ng{static _messageClass(){return ht}static lc_name(){return"HumanMessagePromptTemplate"}},dS=class extends ng{static _messageClass(){return le}static lc_name(){return"AIMessagePromptTemplate"}},hS=class extends ng{static _messageClass(){return kt}static lc_name(){return"SystemMessagePromptTemplate"}};function s4(t){return typeof t.formatMessages=="function"}function i4(t,e){if(s4(t)||Yt(t))return t;if(Array.isArray(t)&&t[0]==="placeholder"){const s=t[1];if((e==null?void 0:e.templateFormat)==="mustache"&&typeof s=="string"&&s.slice(0,2)==="{{"&&s.slice(-2)==="}}"){const i=s.slice(2,-2);return new Wf({variableName:i,optional:!0})}else if(typeof s=="string"&&s[0]==="{"&&s[s.length-1]==="}"){const i=s.slice(1,-1);return new Wf({variableName:i,optional:!0})}throw new Error(`Invalid placeholder template for format ${(e==null?void 0:e.templateFormat)??'"f-string"'}: "${t[1]}". Expected a variable name surrounded by ${(e==null?void 0:e.templateFormat)==="mustache"?"double":"single"} curly braces.`)}const n=Zr(t);let r;if(typeof n.content=="string"?r=n.content:r=n.content.map(s=>"text"in s?{...s,text:s.text}:"image_url"in s?{...s,image_url:s.image_url}:s),n._getType()==="human")return rg.fromTemplate(r,e);if(n._getType()==="ai")return dS.fromTemplate(r,e);if(n._getType()==="system")return hS.fromTemplate(r,e);if(vs.isInstance(n))return uS.fromTemplate(n.content,n.role,e);throw new Error(`Could not coerce message prompt template from input. Received message type: "${n._getType()}".`)}function a4(t){return t.constructor.lc_name()==="MessagesPlaceholder"}var Oi=class yl extends tg{constructor(n){super(n);p(this,"promptMessages");p(this,"validateTemplate",!0);p(this,"templateFormat","f-string");if(n.templateFormat==="mustache"&&n.validateTemplate===void 0&&(this.validateTemplate=!1),Object.assign(this,n),this.validateTemplate){const r=new Set;for(const c of this.promptMessages)if(!(c instanceof Cn))for(const l of c.inputVariables)r.add(l);const s=this.inputVariables,i=new Set(this.partialVariables?s.concat(Object.keys(this.partialVariables)):s),a=new Set([...i].filter(c=>!r.has(c)));if(a.size>0)throw new Error(`Input variables \`${[...a]}\` are not used in any of the prompt messages.`);const o=new Set([...r].filter(c=>!i.has(c)));if(o.size>0)throw new Error(`Input variables \`${[...o]}\` are used in prompt messages but not in the prompt template.`)}}static lc_name(){return"ChatPromptTemplate"}get lc_aliases(){return{promptMessages:"messages"}}_getPromptType(){return"chat"}async _parseImagePrompts(n,r){if(typeof n.content=="string")return n;const s=await Promise.all(n.content.map(async i=>{if(i.type!=="image_url")return i;let a="";typeof i.image_url=="string"?a=i.image_url:typeof i.image_url=="object"&&i.image_url!==null&&"url"in i.image_url&&typeof i.image_url.url=="string"&&(a=i.image_url.url);const c=await Vs.fromTemplate(a,{templateFormat:this.templateFormat}).format(r);return typeof i.image_url=="object"&&i.image_url!==null&&"url"in i.image_url?i.image_url.url=c:i.image_url=c,i}));return n.content=s,n}async formatMessages(n){const r=await this.mergePartialAndUserVariables(n);let s=[];for(const i of this.promptMessages)if(i instanceof Cn)s.push(await this._parseImagePrompts(i,r));else{let a;this.templateFormat==="mustache"?a={...r}:a=i.inputVariables.reduce((c,l)=>{if(!(l in r)&&!(a4(i)&&i.optional))throw Ou(new Error(`Missing value for input variable \`${l.toString()}\``),"INVALID_PROMPT_INPUT");return c[l]=r[l],c},{});const o=await i.formatMessages(a);s=s.concat(o)}return s}async partial(n){const r=this.inputVariables.filter(a=>!(a in n)),s={...this.partialVariables??{},...n},i={...this,inputVariables:r,partialVariables:s};return new yl(i)}static fromTemplate(n,r){const s=Vs.fromTemplate(n,r),i=new rg({prompt:s});return this.fromMessages([i])}static fromMessages(n,r){const s=n.reduce((o,c)=>o.concat(c instanceof yl?c.promptMessages:[i4(c,r)]),[]),i=n.reduce((o,c)=>c instanceof yl?Object.assign(o,c.partialVariables):o,Object.create(null)),a=new Set;for(const o of s)if(!(o instanceof Cn))for(const c of o.inputVariables)c in i||a.add(c);return new this({...r,inputVariables:[...a],promptMessages:s,partialVariables:i,templateFormat:r==null?void 0:r.templateFormat})}},o4=class Hf extends jo{constructor(n){super(n);p(this,"lc_serializable",!1);p(this,"examples");p(this,"exampleSelector");p(this,"examplePrompt");p(this,"suffix","");p(this,"exampleSeparator",`

`);p(this,"prefix","");p(this,"templateFormat","f-string");p(this,"validateTemplate",!0);if(Object.assign(this,n),this.examples!==void 0&&this.exampleSelector!==void 0)throw new Error("Only one of 'examples' and 'example_selector' should be provided");if(this.examples===void 0&&this.exampleSelector===void 0)throw new Error("One of 'examples' and 'example_selector' should be provided");if(this.validateTemplate){let r=this.inputVariables;this.partialVariables&&(r=r.concat(Object.keys(this.partialVariables))),Ec(this.prefix+this.suffix,this.templateFormat,r)}}_getPromptType(){return"few_shot"}static lc_name(){return"FewShotPromptTemplate"}async getExamples(n){if(this.examples!==void 0)return this.examples;if(this.exampleSelector!==void 0)return this.exampleSelector.selectExamples(n);throw new Error("One of 'examples' and 'example_selector' should be provided")}async partial(n){const r=this.inputVariables.filter(a=>!(a in n)),s={...this.partialVariables??{},...n},i={...this,inputVariables:r,partialVariables:s};return new Hf(i)}async format(n){const r=await this.mergePartialAndUserVariables(n),s=await this.getExamples(r),i=await Promise.all(s.map(o=>this.examplePrompt.format(o))),a=[this.prefix,...i,this.suffix].join(this.exampleSeparator);return Tr(a,this.templateFormat,r)}serialize(){if(this.exampleSelector||!this.examples)throw new Error("Serializing an example selector is not currently supported");if(this.outputParser!==void 0)throw new Error("Serializing an output parser is not currently supported");return{_type:this._getPromptType(),input_variables:this.inputVariables,example_prompt:this.examplePrompt.serialize(),example_separator:this.exampleSeparator,suffix:this.suffix,prefix:this.prefix,template_format:this.templateFormat,examples:this.examples}}static async deserialize(n){const{example_prompt:r}=n;if(!r)throw new Error("Missing example prompt");const s=await Vs.deserialize(r);let i;if(Array.isArray(n.examples))i=n.examples;else throw new Error("Invalid examples format. Only list or string are supported.");return new Hf({inputVariables:n.input_variables,examplePrompt:s,examples:i,exampleSeparator:n.example_separator,prefix:n.prefix,suffix:n.suffix,templateFormat:n.template_format})}},c4=class fS extends tg{constructor(n){super(n);p(this,"lc_serializable",!0);p(this,"examples");p(this,"exampleSelector");p(this,"examplePrompt");p(this,"suffix","");p(this,"exampleSeparator",`

`);p(this,"prefix","");p(this,"templateFormat","f-string");p(this,"validateTemplate",!0);if(this.examples=n.examples,this.examplePrompt=n.examplePrompt,this.exampleSeparator=n.exampleSeparator??`

`,this.exampleSelector=n.exampleSelector,this.prefix=n.prefix??"",this.suffix=n.suffix??"",this.templateFormat=n.templateFormat??"f-string",this.validateTemplate=n.validateTemplate??!0,this.examples!==void 0&&this.exampleSelector!==void 0)throw new Error("Only one of 'examples' and 'example_selector' should be provided");if(this.examples===void 0&&this.exampleSelector===void 0)throw new Error("One of 'examples' and 'example_selector' should be provided");if(this.validateTemplate){let r=this.inputVariables;this.partialVariables&&(r=r.concat(Object.keys(this.partialVariables))),Ec(this.prefix+this.suffix,this.templateFormat,r)}}_getPromptType(){return"few_shot_chat"}static lc_name(){return"FewShotChatMessagePromptTemplate"}async getExamples(n){if(this.examples!==void 0)return this.examples;if(this.exampleSelector!==void 0)return this.exampleSelector.selectExamples(n);throw new Error("One of 'examples' and 'example_selector' should be provided")}async formatMessages(n){const r=await this.mergePartialAndUserVariables(n);let s=await this.getExamples(r);s=s.map(a=>{const o={};return this.examplePrompt.inputVariables.forEach(c=>{o[c]=a[c]}),o});const i=[];for(const a of s){const o=await this.examplePrompt.formatMessages(a);i.push(...o)}return i}async format(n){const r=await this.mergePartialAndUserVariables(n),s=await this.getExamples(r),a=(await Promise.all(s.map(c=>this.examplePrompt.formatMessages(c)))).flat().map(c=>c.content),o=[this.prefix,...a,this.suffix].join(this.exampleSeparator);return Tr(o,this.templateFormat,r)}async partial(n){const r=this.inputVariables.filter(a=>!(a in n)),s={...this.partialVariables??{},...n},i={...this,inputVariables:r,partialVariables:s};return new fS(i)}},l4=class _l extends vc{constructor(n){super({...n,inputVariables:[]});p(this,"pipelinePrompts");p(this,"finalPrompt");this.pipelinePrompts=n.pipelinePrompts,this.finalPrompt=n.finalPrompt,this.inputVariables=this.computeInputValues()}static lc_name(){return"PipelinePromptTemplate"}computeInputValues(){const n=this.pipelinePrompts.map(s=>s.name),r=this.pipelinePrompts.map(s=>s.prompt.inputVariables.filter(i=>!n.includes(i))).flat();return[...new Set(r)]}static extractRequiredInputValues(n,r){return r.reduce((s,i)=>(s[i]=n[i],s),{})}async formatPipelinePrompts(n){const r=await this.mergePartialAndUserVariables(n);for(const{name:s,prompt:i}of this.pipelinePrompts){const a=_l.extractRequiredInputValues(r,i.inputVariables);i instanceof Oi?r[s]=await i.formatMessages(a):r[s]=await i.format(a)}return _l.extractRequiredInputValues(r,this.finalPrompt.inputVariables)}async formatPromptValue(n){return this.finalPrompt.formatPromptValue(await this.formatPipelinePrompts(n))}async format(n){return this.finalPrompt.format(await this.formatPipelinePrompts(n))}async partial(n){const r={...this};return r.inputVariables=this.inputVariables.filter(s=>!(s in n)),r.partialVariables={...this.partialVariables??{},...n},new _l(r)}serialize(){throw new Error("Not implemented.")}_getPromptType(){return"pipeline"}};function J_(t){return typeof t=="object"&&t!=null&&"withStructuredOutput"in t&&typeof t.withStructuredOutput=="function"}function u4(t){return typeof t=="object"&&t!=null&&"lc_id"in t&&Array.isArray(t.lc_id)&&t.lc_id.join("/")==="langchain_core/runnables/RunnableBinding"}var d4=class pS extends Oi{constructor(n){super(n);p(this,"schema");p(this,"method");p(this,"lc_namespace",["langchain_core","prompts","structured"]);this.schema=n.schema,this.method=n.method}get lc_aliases(){return{...super.lc_aliases,schema:"schema_"}}pipe(n){if(J_(n))return super.pipe(n.withStructuredOutput(this.schema));if(u4(n)&&J_(n.bound))return super.pipe(new cn({bound:n.bound.withStructuredOutput(this.schema,...this.method?[{method:this.method}]:[]),kwargs:n.kwargs??{},config:n.config,configFactories:n.configFactories}));throw new Error('Structured prompts need to be piped to a language model that supports the "withStructuredOutput()" method.')}static fromMessagesAndSchema(n,r,s){return pS.fromMessages(n,{schema:r,method:s})}},mS={};Se(mS,{AIMessagePromptTemplate:()=>dS,BaseChatPromptTemplate:()=>tg,BaseMessagePromptTemplate:()=>pd,BaseMessageStringPromptTemplate:()=>lS,BasePromptTemplate:()=>vc,BaseStringPromptTemplate:()=>jo,ChatMessagePromptTemplate:()=>uS,ChatPromptTemplate:()=>Oi,DEFAULT_FORMATTER_MAPPING:()=>gu,DEFAULT_PARSER_MAPPING:()=>oS,DictPromptTemplate:()=>Zf,FewShotChatMessagePromptTemplate:()=>c4,FewShotPromptTemplate:()=>o4,HumanMessagePromptTemplate:()=>rg,ImagePromptTemplate:()=>gl,MessagesPlaceholder:()=>Wf,PipelinePromptTemplate:()=>l4,PromptTemplate:()=>Vs,StructuredPrompt:()=>d4,SystemMessagePromptTemplate:()=>hS,checkValidTemplate:()=>Ec,interpolateFString:()=>iS,interpolateMustache:()=>aS,parseFString:()=>Uo,parseMustache:()=>mu,parseTemplate:()=>yu,renderTemplate:()=>Tr});var Pi=class extends Error{constructor(e,n){let r=e??"";n!=null&&n.lc_error_code&&(r=`${r}

Troubleshooting URL: https://docs.langchain.com/oss/javascript/langgraph/${n.lc_error_code}/
`);super(r);p(this,"lc_error_code");this.lc_error_code=n==null?void 0:n.lc_error_code}},gS=class extends Pi{get is_bubble_up(){return!0}},h4=class extends Pi{constructor(t,e){super(t,e),this.name="GraphRecursionError"}static get unminifiable_name(){return"GraphRecursionError"}},wl=class extends Pi{constructor(t,e){super(t,e),this.name="GraphValueError"}static get unminifiable_name(){return"GraphValueError"}},ca=class extends gS{constructor(e,n){super(JSON.stringify(e,null,2),n);p(this,"interrupts");this.name="GraphInterrupt",this.interrupts=e??[]}static get unminifiable_name(){return"GraphInterrupt"}},yS=class extends ca{constructor(t,e){super([{value:t}],e),this.name="NodeInterrupt"}static get unminifiable_name(){return"NodeInterrupt"}},_S=class extends gS{constructor(e){super();p(this,"command");this.name="ParentCommand",this.command=e}static get unminifiable_name(){return"ParentCommand"}};function f4(t){return t!==void 0&&t.name===_S.unminifiable_name}function vl(t){return t!==void 0&&t.is_bubble_up===!0}function mi(t){return t!==void 0&&[ca.unminifiable_name,yS.unminifiable_name].includes(t.name)}var K_=class extends Pi{constructor(t,e){super(t,e),this.name="EmptyInputError"}static get unminifiable_name(){return"EmptyInputError"}},en=class extends Pi{constructor(t,e){super(t,e),this.name="EmptyChannelError"}static get unminifiable_name(){return"EmptyChannelError"}},dt=class extends Pi{constructor(t,e){super(t,e),this.name="InvalidUpdateError"}static get unminifiable_name(){return"InvalidUpdateError"}},p4=class extends Pi{constructor(t,e){super(t,e),this.name="UnreachableNodeError"}static get unminifiable_name(){return"UnreachableNodeError"}};function wS(t){return MA({clockseq:t})}function na(t,e){const n=e.replace(/-/g,"").match(/.{2}/g).map(r=>parseInt(r,16));return Ps(t,new Uint8Array(n))}const m4="__error__",bl="__scheduled__",g4="__interrupt__",y4="__resume__";var X_="[...]",_4="[Circular]",_u=[],ra=[];function w4(){return{depthLimit:Number.MAX_SAFE_INTEGER,edgesLimit:Number.MAX_SAFE_INTEGER}}function v4(t,e,n,r){typeof r>"u"&&(r=w4()),qf(t,"",0,[],void 0,0,r);var s;try{ra.length===0?s=JSON.stringify(t,e,n):s=JSON.stringify(t,b4(e),n)}catch{return JSON.stringify("[unable to serialize, circular reference is too complex to analyze]")}finally{for(;_u.length!==0;){var i=_u.pop();i.length===4?Object.defineProperty(i[0],i[1],i[3]):i[0][i[1]]=i[2]}}return s}function ph(t,e,n,r){var s=Object.getOwnPropertyDescriptor(r,n);s.get!==void 0?s.configurable?(Object.defineProperty(r,n,{value:t}),_u.push([r,n,e,s])):ra.push([e,n,t]):(r[n]=t,_u.push([r,n,e]))}function qf(t,e,n,r,s,i,a){i+=1;var o;if(typeof t=="object"&&t!==null){for(o=0;o<r.length;o++)if(r[o]===t){ph(_4,t,e,s);return}if(typeof a.depthLimit<"u"&&i>a.depthLimit){ph(X_,t,e,s);return}if(typeof a.edgesLimit<"u"&&n+1>a.edgesLimit){ph(X_,t,e,s);return}if(r.push(t),Array.isArray(t))for(o=0;o<t.length;o++)qf(t[o],o,o,r,t,i,a);else{var c=Object.keys(t);for(o=0;o<c.length;o++){var l=c[o];qf(t[l],l,o,r,t,i,a)}}r.pop()}}function b4(t){return t=typeof t<"u"?t:function(e,n){return n},function(e,n){if(ra.length>0)for(var r=0;r<ra.length;r++){var s=ra[r];if(s[1]===e&&s[0]===n){n=s[2],ra.splice(r,1);break}}return t.call(this,e,n)}}const E4=[];var T4={},vS={};Se(vS,{BaseChatMessageHistory:()=>bS,BaseListChatMessageHistory:()=>sg,InMemoryChatMessageHistory:()=>S4});var bS=class extends cr{async addMessages(t){for(const e of t)await this.addMessage(e)}},sg=class extends cr{addUserMessage(t){return this.addMessage(new ht(t))}addAIMessage(t){return this.addMessage(new le(t))}async addMessages(t){for(const e of t)await this.addMessage(e)}clear(){throw new Error("Not implemented.")}},S4=class extends sg{constructor(e){super(...arguments);p(this,"lc_namespace",["langchain","stores","message","in_memory"]);p(this,"messages",[]);this.messages=e??[]}async getMessages(){return this.messages}async addMessage(e){this.messages.push(e)}async clear(){this.messages=[]}},x4={},ES={};Se(ES,{BaseMemory:()=>k4,getInputValue:()=>I4,getOutputValue:()=>A4,getPromptInputKey:()=>C4});var k4=class{};const TS=(t,e)=>{if(e!==void 0)return t[e];const n=Object.keys(t);if(n.length===1)return t[n[0]]},I4=(t,e)=>{const n=TS(t,e);if(!n){const r=Object.keys(t);throw new Error(`input values have ${r.length} keys, you must specify an input key or pass only 1 key as input`)}return n},A4=(t,e)=>{const n=TS(t,e);if(!n&&n!==""){const r=Object.keys(t);throw new Error(`output values have ${r.length} keys, you must specify an output key or pass only 1 key as output`)}return n};function C4(t,e){const n=Object.keys(t).filter(r=>!e.includes(r)&&r!=="stop");if(n.length!==1)throw new Error(`One input key expected, but got ${n.length}`);return n[0]}var SS={};Se(SS,{BaseStore:()=>xS,InMemoryStore:()=>kS});var xS=class extends cr{},kS=class extends xS{constructor(){super(...arguments);p(this,"lc_namespace",["langchain","storage"]);p(this,"store",{})}async mget(e){return e.map(n=>this.store[n])}async mset(e){for(const[n,r]of e)this.store[n]=r}async mdelete(e){for(const n of e)delete this.store[n]}async*yieldKeys(e){const n=Object.keys(this.store);for(const r of n)(e===void 0||r.startsWith(e))&&(yield r)}},IS={};Se(IS,{BaseRetriever:()=>ig});var ig=class extends Fe{constructor(e){super(e);p(this,"callbacks");p(this,"tags");p(this,"metadata");p(this,"verbose");this.callbacks=e==null?void 0:e.callbacks,this.tags=(e==null?void 0:e.tags)??[],this.metadata=(e==null?void 0:e.metadata)??{},this.verbose=(e==null?void 0:e.verbose)??!1}_getRelevantDocuments(e,n){throw new Error("Not implemented!")}async invoke(e,n){const r=Ze(nc(n)),s=await wn.configure(r.callbacks,this.callbacks,r.tags,this.tags,r.metadata,this.metadata,{verbose:this.verbose}),i=await(s==null?void 0:s.handleRetrieverStart(this.toJSON(),e,r.runId,void 0,void 0,void 0,r.runName));try{const a=await this._getRelevantDocuments(e,i);return await(i==null?void 0:i.handleRetrieverEnd(a)),a}catch(a){throw await(i==null?void 0:i.handleRetrieverError(a)),a}}},AS={};Se(AS,{SaveableVectorStore:()=>O4,VectorStore:()=>ag,VectorStoreRetriever:()=>El});var El=class extends ig{constructor(e){super(e);p(this,"vectorStore");p(this,"k",4);p(this,"searchType","similarity");p(this,"searchKwargs");p(this,"filter");this.vectorStore=e.vectorStore,this.k=e.k??this.k,this.searchType=e.searchType??this.searchType,this.filter=e.filter,e.searchType==="mmr"&&(this.searchKwargs=e.searchKwargs)}static lc_name(){return"VectorStoreRetriever"}get lc_namespace(){return["langchain_core","vectorstores"]}_vectorstoreType(){return this.vectorStore._vectorstoreType()}async _getRelevantDocuments(e,n){if(this.searchType==="mmr"){if(typeof this.vectorStore.maxMarginalRelevanceSearch!="function")throw new Error(`The vector store backing this retriever, ${this._vectorstoreType()} does not support max marginal relevance search.`);return this.vectorStore.maxMarginalRelevanceSearch(e,{k:this.k,filter:this.filter,...this.searchKwargs},n==null?void 0:n.getChild("vectorstore"))}return this.vectorStore.similaritySearch(e,this.k,this.filter,n==null?void 0:n.getChild("vectorstore"))}async addDocuments(e,n){return this.vectorStore.addDocuments(e,n)}},ag=class extends cr{constructor(e,n){super(n);p(this,"lc_namespace",["langchain","vectorstores",this._vectorstoreType()]);p(this,"embeddings");this.embeddings=e}async delete(e){throw new Error("Not implemented.")}async similaritySearch(e,n=4,r=void 0,s=void 0){return(await this.similaritySearchVectorWithScore(await this.embeddings.embedQuery(e),n,r)).map(a=>a[0])}async similaritySearchWithScore(e,n=4,r=void 0,s=void 0){return this.similaritySearchVectorWithScore(await this.embeddings.embedQuery(e),n,r)}static fromTexts(e,n,r,s){throw new Error("the Langchain vectorstore implementation you are using forgot to override this, please report a bug")}static fromDocuments(e,n,r){throw new Error("the Langchain vectorstore implementation you are using forgot to override this, please report a bug")}asRetriever(e,n,r,s,i,a){if(typeof e=="number")return new El({vectorStore:this,k:e,filter:n,tags:[...s??[],this._vectorstoreType()],metadata:i,verbose:a,callbacks:r});{const o={vectorStore:this,k:e==null?void 0:e.k,filter:e==null?void 0:e.filter,tags:[...(e==null?void 0:e.tags)??[],this._vectorstoreType()],metadata:e==null?void 0:e.metadata,verbose:e==null?void 0:e.verbose,callbacks:e==null?void 0:e.callbacks,searchType:e==null?void 0:e.searchType};return(e==null?void 0:e.searchType)==="mmr"?new El({...o,searchKwargs:e.searchKwargs}):new El({...o})}}},O4=class extends ag{static load(t,e){throw new Error("Not implemented")}},CS={};Se(CS,{BaseDocumentLoader:()=>OS});var OS=class{},$S={};Se($S,{LangSmithLoader:()=>$4});var $4=class extends OS{constructor(e){super();p(this,"datasetId");p(this,"datasetName");p(this,"exampleIds");p(this,"asOf");p(this,"splits");p(this,"inlineS3Urls");p(this,"offset");p(this,"limit");p(this,"metadata");p(this,"filter");p(this,"contentKey");p(this,"formatContent");p(this,"client");if(e.client&&e.clientConfig)throw new Error("client and clientConfig cannot both be provided.");this.client=e.client??new pa(e==null?void 0:e.clientConfig),this.contentKey=e.contentKey?e.contentKey.split("."):[],this.formatContent=e.formatContent??R4,this.datasetId=e.datasetId,this.datasetName=e.datasetName,this.exampleIds=e.exampleIds,this.asOf=e.asOf,this.splits=e.splits,this.inlineS3Urls=e.inlineS3Urls,this.offset=e.offset,this.limit=e.limit,this.metadata=e.metadata,this.filter=e.filter}async load(){const e=[];for await(const n of this.client.listExamples({datasetId:this.datasetId,datasetName:this.datasetName,exampleIds:this.exampleIds,asOf:this.asOf,splits:this.splits,inlineS3Urls:this.inlineS3Urls,offset:this.offset,limit:this.limit,metadata:this.metadata,filter:this.filter})){let r=n.inputs;for(const a of this.contentKey)r=r[a];const s=this.formatContent(r),i=n;["created_at","modified_at"].forEach(a=>{a in i&&typeof i[a]=="object"&&(i[a]=i[a].toString())}),e.push({pageContent:s,metadata:i})}return e}};function R4(t){if(typeof t=="string")return t;try{return JSON.stringify(t,null,2)}catch{return String(t)}}var us=class{constructor(t){p(this,"pageContent");p(this,"metadata");p(this,"id");this.pageContent=t.pageContent!==void 0?t.pageContent.toString():"",this.metadata=t.metadata??{},this.id=t.id}},RS=class extends Fe{constructor(){super(...arguments);p(this,"lc_namespace",["langchain_core","documents","transformers"])}invoke(e,n){return this.transformDocuments(e)}},N4=class extends RS{async transformDocuments(t){const e=[];for(const n of t){const r=await this._transformDocument(n);e.push(r)}return e}},NS={};Se(NS,{BaseDocumentTransformer:()=>RS,Document:()=>us,MappingDocumentTransformer:()=>N4});var og=class extends cr{constructor(){super(...arguments);p(this,"lc_namespace",["langchain_core","example_selectors","base"])}},PS=class{async getPromptAsync(t,e){return this.getPrompt(t).partial((e==null?void 0:e.partialVariables)??{})}},P4=class extends PS{constructor(e,n=[]){super();p(this,"defaultPrompt");p(this,"conditionals");this.defaultPrompt=e,this.conditionals=n}getPrompt(e){for(const[n,r]of this.conditionals)if(n(e))return r;return this.defaultPrompt}};function M4(t){return t._modelType()==="base_llm"}function L4(t){return t._modelType()==="base_chat_model"}function Y_(t){return t.split(/\n| /).length}var j4=class MS extends og{constructor(n){super(n);p(this,"examples",[]);p(this,"examplePrompt");p(this,"getTextLength",Y_);p(this,"maxLength",2048);p(this,"exampleTextLengths",[]);this.examplePrompt=n.examplePrompt,this.maxLength=n.maxLength??2048,this.getTextLength=n.getTextLength??Y_}async addExample(n){this.examples.push(n);const r=await this.examplePrompt.format(n);this.exampleTextLengths.push(this.getTextLength(r))}async calculateExampleTextLengths(n,r){if(n.length>0)return n;const{examples:s,examplePrompt:i}=r;return(await Promise.all(s.map(o=>i.format(o)))).map(o=>this.getTextLength(o))}async selectExamples(n){const r=Object.values(n).join(" ");let s=this.maxLength-this.getTextLength(r),i=0;const a=[];for(;s>0&&i<this.examples.length;){const o=s-this.exampleTextLengths[i];if(o<0)break;a.push(this.examples[i]),s=o,i+=1}return a}static async fromExamples(n,r){const s=new MS(r);return await Promise.all(n.map(i=>s.addExample(i))),s}};function mh(t){return Object.keys(t).sort().map(e=>t[e])}var D4=class LS extends og{constructor(n){super(n);p(this,"vectorStoreRetriever");p(this,"exampleKeys");p(this,"inputKeys");if(this.exampleKeys=n.exampleKeys,this.inputKeys=n.inputKeys,n.vectorStore!==void 0)this.vectorStoreRetriever=n.vectorStore.asRetriever({k:n.k??4,filter:n.filter});else if(n.vectorStoreRetriever)this.vectorStoreRetriever=n.vectorStoreRetriever;else throw new Error('You must specify one of "vectorStore" and "vectorStoreRetriever".')}async addExample(n){const r=this.inputKeys??Object.keys(n),s=mh(r.reduce((i,a)=>({...i,[a]:n[a]}),{})).join(" ");await this.vectorStoreRetriever.addDocuments([new us({pageContent:s,metadata:n})])}async selectExamples(n){const r=this.inputKeys??Object.keys(n),s=mh(r.reduce((o,c)=>({...o,[c]:n[c]}),{})).join(" "),a=(await this.vectorStoreRetriever.invoke(s)).map(o=>o.metadata);return this.exampleKeys?a.map(o=>this.exampleKeys.reduce((c,l)=>({...c,[l]:o[l]}),{})):a}static async fromExamples(n,r,s,i={}){const a=i.inputKeys??null,o=n.map(l=>mh(a?a.reduce((u,d)=>({...u,[d]:l[d]}),{}):l).join(" ")),c=await s.fromTexts(o,n,r,i);return new LS({vectorStore:c,k:i.k??4,exampleKeys:i.exampleKeys,inputKeys:i.inputKeys})}},jS={};Se(jS,{BaseExampleSelector:()=>og,BasePromptSelector:()=>PS,ConditionalPromptSelector:()=>P4,LengthBasedExampleSelector:()=>j4,SemanticSimilarityExampleSelector:()=>D4,isChatModel:()=>L4,isLLM:()=>M4});const Jf="10f90ea3-90a4-4962-bf75-83a0f3c1c62a";var U4=class extends cr{constructor(){super(...arguments);p(this,"lc_namespace",["langchain","recordmanagers"])}},DS=class{constructor(t){p(this,"uid");p(this,"hash_");p(this,"contentHash");p(this,"metadataHash");p(this,"pageContent");p(this,"metadata");p(this,"keyEncoder",od);this.uid=t.uid,this.pageContent=t.pageContent,this.metadata=t.metadata}makeDefaultKeyEncoder(t){this.keyEncoder=t}calculateHashes(){const t=["hash_","content_hash","metadata_hash"];for(const n of t)if(n in this.metadata)throw new Error(`Metadata cannot contain key ${n} as it is reserved for internal use. Restricted keys: [${t.join(", ")}]`);const e=this._hashStringToUUID(this.pageContent);try{const n=this._hashNestedDictToUUID(this.metadata);this.contentHash=e,this.metadataHash=n}catch(n){throw new Error(`Failed to hash metadata: ${n}. Please use a dict that can be serialized using json.`)}this.hash_=this._hashStringToUUID(this.contentHash+this.metadataHash),this.uid||(this.uid=this.hash_)}toDocument(){return new us({pageContent:this.pageContent,metadata:this.metadata})}static fromDocument(t,e){const n=new this({pageContent:t.pageContent,metadata:t.metadata,uid:e||t.uid});return n.calculateHashes(),n}_hashStringToUUID(t){const e=this.keyEncoder(t);return Ps(e,Jf)}_hashNestedDictToUUID(t){const e=JSON.stringify(t,Object.keys(t).sort()),n=this.keyEncoder(e);return Ps(n,Jf)}};function US(t,e){const n=[];let r=[];return e.forEach(s=>{r.push(s),r.length>=t&&(n.push(r),r=[])}),r.length>0&&n.push(r),n}function FS(t){const e=new Set,n=[];for(const r of t){if(!r.hash_)throw new Error("Hashed document does not have a hash");e.has(r.hash_)||(e.add(r.hash_),n.push(r))}return n}function BS(t){if(t===null)return e=>null;if(typeof t=="string")return e=>e.metadata[t];if(typeof t=="function")return t;throw new Error(`sourceIdKey should be null, a string or a function, got ${typeof t}`)}const zS=t=>"load"in t&&typeof t.load=="function"&&"loadAndSplit"in t&&typeof t.loadAndSplit=="function";async function F4(t){const{docsSource:e,recordManager:n,vectorStore:r,options:s}=t,{batchSize:i=100,cleanup:a,sourceIdKey:o,cleanupBatchSize:c=1e3,forceUpdate:l=!1}=s??{};if(a==="incremental"&&!o)throw new Error("sourceIdKey is required when cleanup mode is incremental. Please provide through 'options.sourceIdKey'.");const u=zS(e)?await e.load():e,d=BS(o??null),h=await n.getTime();let f=0,m=0,g=0,w=0;const b=US(i??100,u);for(const y of b){const v=FS(y.map(j=>DS.fromDocument(j))),T=v.map(j=>d(j));a==="incremental"&&v.forEach((j,P)=>{if(T[P]===null)throw new Error("sourceIdKey must be provided when cleanup is incremental")});const A=await n.exists(v.map(j=>j.uid)),I=[],$=[],S=[],M=new Set;if(v.forEach((j,P)=>{if(A[P])if(l)M.add(j.uid);else{S.push(j.uid);return}I.push(j.uid),$.push(j.toDocument())}),S.length>0&&(await n.update(S,{timeAtLeast:h}),w+=S.length),$.length>0&&(await r.addDocuments($,{ids:I}),f+=$.length-M.size,g+=M.size),await n.update(v.map(j=>j.uid),{timeAtLeast:h,groupIds:T}),a==="incremental"){T.forEach(P=>{if(!P)throw new Error("Source id cannot be null")});const j=await n.listKeys({before:h,groupIds:T});j.length>0&&(await r.delete({ids:j}),await n.deleteKeys(j),m+=j.length)}}if(a==="full"){let y=await n.listKeys({before:h,limit:c});for(;y.length>0;)await r.delete({ids:y}),await n.deleteKeys(y),m+=y.length,y=await n.listKeys({before:h,limit:c})}return{numAdded:f,numDeleted:m,numUpdated:g,numSkipped:w}}var ZS={};Se(ZS,{RecordManager:()=>U4,UUIDV5_NAMESPACE:()=>Jf,_HashedDocument:()=>DS,_batch:()=>US,_deduplicateInOrder:()=>FS,_getSourceIdAssigner:()=>BS,_isBaseDocumentLoader:()=>zS,index:()=>F4});var B4={},VS={};Se(VS,{BaseDocumentCompressor:()=>z4});var z4=class{static isBaseDocumentCompressor(t){return(t==null?void 0:t.compressDocuments)!==void 0}},Z4={},GS={};Se(GS,{RunCollectorCallbackHandler:()=>V4});var V4=class extends Es{constructor({exampleId:e}={}){super({_awaitHandler:!0});p(this,"name","run_collector");p(this,"exampleId");p(this,"tracedRuns");this.exampleId=e,this.tracedRuns=[]}async persistRun(e){const n={...e};n.reference_example_id=this.exampleId,this.tracedRuns.push(n)}},WS={};Se(WS,{context:()=>HS});function HS(t,...e){const n=t.raw;let r="";for(let s=0;s<n.length;s++){const i=n[s].replace(/\\\n[ \t]*/g,"").replace(/\\`/g,"`").replace(/\\\$/g,"$").replace(/\\\{/g,"{");if(r+=i,s<e.length){const a=G4(e[s],r);r+=typeof a=="string"?a:JSON.stringify(a)}}return r=W4(r),r=r.trim(),r=r.replace(/\\n/g,`
`),r}function G4(t,e){if(typeof t!="string"||!t.includes(`
`))return t;const r=e.slice(e.lastIndexOf(`
`)+1).match(/^(\s+)/);if(r){const s=r[1];return t.replace(/\n/g,`
${s}`)}return t}function W4(t){const e=t.split(`
`);let n=null;for(const r of e){const s=r.match(/^(\s+)\S+/);if(s){const i=s[1].length;n===null?n=i:n=Math.min(n,i)}}return n===null?t:e.map(r=>r[0]===" "||r[0]==="	"?r.slice(n):r).join(`
`)}var qS=class extends dd{constructor(e){super();p(this,"lc_namespace",["langchain","output_parsers","openai_functions"]);p(this,"lc_serializable",!0);p(this,"argsOnly",!0);this.argsOnly=(e==null?void 0:e.argsOnly)??this.argsOnly}static lc_name(){return"OutputFunctionsParser"}async parseResult(e){if("message"in e[0]){const r=e[0].message.additional_kwargs.function_call;if(!r)throw new Error(`No function_call in message ${JSON.stringify(e)}`);if(!r.arguments)throw new Error(`No arguments in function_call ${JSON.stringify(e)}`);return this.argsOnly?r.arguments:JSON.stringify(r)}else throw new Error(`No message in generations ${JSON.stringify(e)}`)}},JS=class extends yc{constructor(e){super(e);p(this,"lc_namespace",["langchain","output_parsers","openai_functions"]);p(this,"lc_serializable",!0);p(this,"outputParser");p(this,"argsOnly",!0);this.argsOnly=(e==null?void 0:e.argsOnly)??this.argsOnly,this.outputParser=new qS(e)}static lc_name(){return"JsonOutputFunctionsParser"}_diff(e,n){return n?Du(e??{},n):void 0}async parsePartialResult(e){const n=e[0];if(!n.message)return;const{message:r}=n,s=r.additional_kwargs.function_call;if(s)return this.argsOnly?fa(s.arguments):{...s,arguments:fa(s.arguments)}}async parseResult(e){const n=await this.outputParser.parseResult(e);if(!n)throw new Error(`No result from "OutputFunctionsParser" ${JSON.stringify(e)}`);return this.parse(n)}async parse(e){const n=JSON.parse(e);return this.argsOnly||(n.arguments=JSON.parse(n.arguments)),n}getFormatInstructions(){return""}},H4=class extends dd{constructor(e){super(e);p(this,"lc_namespace",["langchain","output_parsers","openai_functions"]);p(this,"lc_serializable",!0);p(this,"outputParser",new JS);p(this,"attrName");this.attrName=e.attrName}static lc_name(){return"JsonKeyOutputFunctionsParser"}get lc_aliases(){return{attrName:"key_name"}}async parseResult(e){return(await this.outputParser.parseResult(e))[this.attrName]}},KS={};Se(KS,{JsonKeyOutputFunctionsParser:()=>H4,JsonOutputFunctionsParser:()=>JS,OutputFunctionsParser:()=>qS});const Ls={and:"and",or:"or",not:"not"},Ge={eq:"eq",ne:"ne",lt:"lt",gt:"gt",lte:"lte",gte:"gte"};var XS=class{},cg=class{accept(t){if(this.exprName==="Operation")return t.visitOperation(this);if(this.exprName==="Comparison")return t.visitComparison(this);if(this.exprName==="StructuredQuery")return t.visitStructuredQuery(this);throw new Error("Unknown Expression type")}},lg=class extends cg{},q4=class extends lg{constructor(e,n,r){super();p(this,"exprName","Comparison");this.comparator=e,this.attribute=n,this.value=r}},J4=class extends lg{constructor(e,n){super();p(this,"exprName","Operation");this.operator=e,this.args=n}},K4=class extends cg{constructor(e,n){super();p(this,"exprName","StructuredQuery");this.query=e,this.filter=n}};function YS(t){return t&&typeof t=="object"&&!Array.isArray(t)}function br(t){return t?typeof t=="string"&&t.length>0||typeof t=="function"?!1:YS(t)&&Object.keys(t).length===0:!0}function QS(t){if(typeof t=="number")return t%1===0;if(typeof t=="string"){const e=parseInt(t,10);return!Number.isNaN(e)&&e%1===0&&e.toString()===t}return!1}function ex(t){if(typeof t=="number")return t%1!==0;if(typeof t=="string"){const e=parseFloat(t);return!Number.isNaN(e)&&e%1!==0&&e.toString()===t}return!1}function tx(t){return typeof t=="string"&&(Number.isNaN(parseFloat(t))||parseFloat(t).toString()!==t)}function nx(t){return typeof t=="boolean"}function ug(t){let e;if(tx(t))e=t;else if(QS(t))e=parseInt(t,10);else if(ex(t))e=parseFloat(t);else if(nx(t))e=!!t;else throw new Error("Unsupported value type");return e}var dg=class extends XS{},X4=class extends dg{constructor(e){super();p(this,"allowedOperators");p(this,"allowedComparators");this.allowedOperators=(e==null?void 0:e.allowedOperators)??[Ls.and,Ls.or],this.allowedComparators=(e==null?void 0:e.allowedComparators)??[Ge.eq,Ge.ne,Ge.gt,Ge.gte,Ge.lt,Ge.lte]}formatFunction(e){if(e in Ge){if(this.allowedComparators.length>0&&this.allowedComparators.indexOf(e)===-1)throw new Error(`Comparator ${e} not allowed. Allowed comparators: ${this.allowedComparators.join(", ")}`)}else if(e in Ls){if(this.allowedOperators.length>0&&this.allowedOperators.indexOf(e)===-1)throw new Error(`Operator ${e} not allowed. Allowed operators: ${this.allowedOperators.join(", ")}`)}else throw new Error("Unknown comparator or operator");return`$${e}`}visitOperation(e){var r;const n=(r=e.args)==null?void 0:r.map(s=>s.accept(this));return{[this.formatFunction(e.operator)]:n}}visitComparison(e){return{[e.attribute]:{[this.formatFunction(e.comparator)]:ug(e.value)}}}visitStructuredQuery(e){let n={};return e.filter&&(n={filter:e.filter.accept(this)}),n}mergeFilters(e,n,r="and",s=!1){if(!(br(e)&&br(n))){if(br(e)||r==="replace")return br(n)?void 0:n;if(br(n))return s?e:r==="and"?void 0:e;if(r==="and")return{$and:[e,n]};if(r==="or")return{$or:[e,n]};throw new Error("Unknown merge type")}}},Y4=class extends dg{constructor(){super(...arguments);p(this,"allowedOperators",[Ls.and,Ls.or]);p(this,"allowedComparators",[Ge.eq,Ge.ne,Ge.gt,Ge.gte,Ge.lt,Ge.lte])}formatFunction(){throw new Error("Not implemented")}getAllowedComparatorsForType(e){switch(e){case"string":return[Ge.eq,Ge.ne,Ge.gt,Ge.gte,Ge.lt,Ge.lte];case"number":return[Ge.eq,Ge.ne,Ge.gt,Ge.gte,Ge.lt,Ge.lte];case"boolean":return[Ge.eq,Ge.ne];default:throw new Error(`Unsupported data type: ${e}`)}}getComparatorFunction(e){switch(e){case Ge.eq:return(n,r)=>n===r;case Ge.ne:return(n,r)=>n!==r;case Ge.gt:return(n,r)=>n>r;case Ge.gte:return(n,r)=>n>=r;case Ge.lt:return(n,r)=>n<r;case Ge.lte:return(n,r)=>n<=r;default:throw new Error("Unknown comparator")}}getOperatorFunction(e){switch(e){case Ls.and:return(n,r)=>n&&r;case Ls.or:return(n,r)=>n||r;default:throw new Error("Unknown operator")}}visitOperation(e){const{operator:n,args:r}=e;if(this.allowedOperators.includes(n)){const s=this.getOperatorFunction(n);return i=>r?r.reduce((a,o)=>{const c=o.accept(this);if(typeof c=="function")return s(a,c(i));throw new Error("Filter is not a function")},!0):!0}else throw new Error("Operator not allowed")}visitComparison(e){const{comparator:n,attribute:r,value:s}=e,i=[Ge.ne];if(this.allowedComparators.includes(n)){if(!this.getAllowedComparatorsForType(typeof s).includes(n))throw new Error(`'${n}' comparator not allowed to be used with ${typeof s}`);const a=this.getComparatorFunction(n);return o=>{const c=o.metadata[r];return c===void 0?!!i.includes(n):a(c,ug(s))}}else throw new Error("Comparator not allowed")}visitStructuredQuery(e){var r;if(!e.filter)return{};const n=(r=e.filter)==null?void 0:r.accept(this);if(typeof n!="function")throw new Error("Structured query filter is not a function");return{filter:n}}mergeFilters(e,n,r="and"){if(!(br(e)&&br(n))){if(br(e)||r==="replace")return br(n)?void 0:n;if(br(n))return r==="and"?void 0:e;if(r==="and")return s=>e(s)&&n(s);if(r==="or")return s=>e(s)||n(s);throw new Error("Unknown merge type")}}},rx={};Se(rx,{BaseTranslator:()=>dg,BasicTranslator:()=>X4,Comparators:()=>Ge,Comparison:()=>q4,Expression:()=>cg,FilterDirective:()=>lg,FunctionalTranslator:()=>Y4,Operation:()=>J4,Operators:()=>Ls,StructuredQuery:()=>K4,Visitor:()=>XS,castValue:()=>ug,isBoolean:()=>nx,isFilterEmpty:()=>br,isFloat:()=>ex,isInt:()=>QS,isObject:()=>YS,isString:()=>tx});var Q4=class extends Qs{_combineLLMOutput(){return[]}_llmType(){return"fake"}async _generate(t,e,n){var s;if((s=e==null?void 0:e.stop)!=null&&s.length)return{generations:[{message:new le(e.stop[0]),text:e.stop[0]}]};const r=t.map(i=>typeof i.content=="string"?i.content:JSON.stringify(i.content,null,2)).join(`
`);return await(n==null?void 0:n.handleLLMNewToken(r)),{generations:[{message:new le(r),text:r}],llmOutput:{}}}},eF=class sx extends Qs{constructor({sleep:n=50,responses:r=[],chunks:s=[],toolStyle:i="openai",thrownErrorString:a,...o}){super(o);p(this,"sleep",50);p(this,"responses",[]);p(this,"chunks",[]);p(this,"toolStyle","openai");p(this,"thrownErrorString");p(this,"tools",[]);this.sleep=n,this.responses=r,this.chunks=s,this.toolStyle=i,this.thrownErrorString=a}_llmType(){return"fake"}bindTools(n){const r=[...this.tools,...n],s=r.map(o=>{switch(this.toolStyle){case"openai":return{type:"function",function:{name:o.name,description:o.description,parameters:bt(o.schema)}};case"anthropic":return{name:o.name,description:o.description,input_schema:bt(o.schema)};case"bedrock":return{toolSpec:{name:o.name,description:o.description,inputSchema:bt(o.schema)}};case"google":return{name:o.name,description:o.description,parameters:bt(o.schema)};default:throw new Error(`Unsupported tool style: ${this.toolStyle}`)}}),i=this.toolStyle==="google"?[{functionDeclarations:s}]:s,a=new sx({sleep:this.sleep,responses:this.responses,chunks:this.chunks,toolStyle:this.toolStyle,thrownErrorString:this.thrownErrorString});return a.tools=r,a.withConfig({tools:i})}async _generate(n,r,s){var o,c,l,u;if(this.thrownErrorString)throw new Error(this.thrownErrorString);const i=((c=(o=this.responses)==null?void 0:o[0])==null?void 0:c.content)??n[0].content??"";return{generations:[{text:"",message:new le({content:i,tool_calls:(u=(l=this.chunks)==null?void 0:l[0])==null?void 0:u.tool_calls})}]}}async*_streamResponseChunks(n,r,s){var o,c,l,u,d;if(this.thrownErrorString)throw new Error(this.thrownErrorString);if((o=this.chunks)!=null&&o.length){for(const h of this.chunks){const f=new ms({message:new dn({content:h.content,tool_calls:h.tool_calls,additional_kwargs:h.additional_kwargs??{}}),text:((c=h.content)==null?void 0:c.toString())??""});if((l=r.signal)!=null&&l.aborted)break;yield f,await(s==null?void 0:s.handleLLMNewToken(h.content,void 0,void 0,void 0,void 0,{chunk:f}))}return}const i=((u=this.responses)==null?void 0:u[0])??new le(typeof n[0].content=="string"?n[0].content:""),a=typeof i.content=="string"?i.content:"";for(const h of a){await new Promise(m=>setTimeout(m,this.sleep));const f=new ms({message:new dn({content:h}),text:h});if((d=r.signal)!=null&&d.aborted)break;yield f,await(s==null?void 0:s.handleLLMNewToken(h,void 0,void 0,void 0,void 0,{chunk:f}))}}},tF=class ix extends Qs{constructor(n){super(n);p(this,"lc_serializable",!0);p(this,"responses");p(this,"i",0);p(this,"sleep");p(this,"emitCustomEvent",!1);p(this,"generationInfo");p(this,"tools",[]);p(this,"toolStyle","openai");const{responses:r,sleep:s,emitCustomEvent:i,generationInfo:a}=n;this.responses=r,this.sleep=s,this.emitCustomEvent=i??this.emitCustomEvent,this.generationInfo=a}static lc_name(){return"FakeListChatModel"}_combineLLMOutput(){return[]}_llmType(){return"fake-list"}async _generate(n,r,s){var i;if(await this._sleepIfRequested(),r!=null&&r.thrownErrorString)throw new Error(r.thrownErrorString);if(this.emitCustomEvent&&await(s==null?void 0:s.handleCustomEvent("some_test_event",{someval:!0})),(i=r==null?void 0:r.stop)!=null&&i.length)return{generations:[this._formatGeneration(r.stop[0])]};{const a=this._currentResponse();return this._incrementResponse(),{generations:[this._formatGeneration(a)],llmOutput:{}}}}_formatGeneration(n){return{message:new le(n),text:n}}async*_streamResponseChunks(n,r,s){var o;const i=this._currentResponse();this._incrementResponse(),this.emitCustomEvent&&await(s==null?void 0:s.handleCustomEvent("some_test_event",{someval:!0}));const a=[...i];for(let c=0;c<a.length;c++){const l=a[c],u=c===a.length-1;if(await this._sleepIfRequested(),r!=null&&r.thrownErrorString)throw new Error(r.thrownErrorString);const d=this._createResponseChunk(l,u?this.generationInfo:void 0);if((o=r.signal)!=null&&o.aborted)break;yield d,s==null||s.handleLLMNewToken(l)}}async _sleepIfRequested(){this.sleep!==void 0&&await this._sleep()}async _sleep(){return new Promise(n=>{setTimeout(()=>n(),this.sleep)})}_createResponseChunk(n,r){return new ms({message:new dn({content:n}),text:n,generationInfo:r})}_currentResponse(){return this.responses[this.i]}_incrementResponse(){this.i<this.responses.length-1?this.i+=1:this.i=0}bindTools(n){const r=[...this.tools,...n],s=r.map(o=>{switch(this.toolStyle){case"openai":return{type:"function",function:{name:o.name,description:o.description,parameters:bt(o.schema)}};case"anthropic":return{name:o.name,description:o.description,input_schema:bt(o.schema)};case"bedrock":return{toolSpec:{name:o.name,description:o.description,inputSchema:bt(o.schema)}};case"google":return{name:o.name,description:o.description,parameters:bt(o.schema)};default:throw new Error(`Unsupported tool style: ${this.toolStyle}`)}}),i=this.toolStyle==="google"?[{functionDeclarations:s}]:s,a=new ix({responses:this.responses,sleep:this.sleep,emitCustomEvent:this.emitCustomEvent,generationInfo:this.generationInfo});return a.tools=r,a.toolStyle=this.toolStyle,a.i=this.i,a.withConfig({tools:i})}withStructuredOutput(n,r){return Kn.from(async s=>{var a,o;const i=await this.invoke(s);if((o=(a=i.tool_calls)==null?void 0:a[0])!=null&&o.args)return i.tool_calls[0].args;if(typeof i.content=="string")return JSON.parse(i.content);throw new Error("No structured output found")})}},nF=class extends Km{constructor(e){super(e??{});p(this,"vectorSize");this.vectorSize=(e==null?void 0:e.vectorSize)??4}async embedDocuments(e){return Promise.all(e.map(n=>this.embedQuery(n)))}async embedQuery(e){let n=e;n=n.toLowerCase().replaceAll(/[^a-z ]/g,"");const r=n.length%this.vectorSize,s=r===0?0:this.vectorSize-r,i=n.length+s;n=n.padEnd(i," ");const a=n.length/this.vectorSize,o=[];for(let l=0;l<n.length;l+=a)o.push(n.slice(l,l+a));return o.map(l=>{let u=0;for(let h=0;h<l.length;h+=1)u+=l===" "?0:l.charCodeAt(h);return u%26/26})}},rF=class extends Km{constructor(t){super(t??{})}embedDocuments(t){return Promise.resolve(t.map(()=>[.1,.2,.3,.4]))}embedQuery(t){return Promise.resolve([.1,.2,.3,.4])}},sF=class extends Jm{constructor(e){super(e);p(this,"response");p(this,"thrownErrorString");this.response=e.response,this.thrownErrorString=e.thrownErrorString}_llmType(){return"fake"}async _call(e,n,r){if(this.thrownErrorString)throw new Error(this.thrownErrorString);const s=this.response??e;return await(r==null?void 0:r.handleLLMNewToken(s)),s}},iF=class extends Jm{constructor(e){super(e);p(this,"sleep",50);p(this,"responses");p(this,"thrownErrorString");this.sleep=e.sleep??this.sleep,this.responses=e.responses,this.thrownErrorString=e.thrownErrorString}_llmType(){return"fake"}async _call(e){var r,s;if(this.thrownErrorString)throw new Error(this.thrownErrorString);const n=(r=this.responses)==null?void 0:r[0];return this.responses=(s=this.responses)==null?void 0:s.slice(1),n??e}async*_streamResponseChunks(e,n,r){var i,a;if(this.thrownErrorString)throw new Error(this.thrownErrorString);const s=(i=this.responses)==null?void 0:i[0];this.responses=(a=this.responses)==null?void 0:a.slice(1);for(const o of s??e)await new Promise(c=>setTimeout(c,this.sleep)),yield{text:o,generationInfo:{}},await(r==null?void 0:r.handleLLMNewToken(o))}},aF=class extends bS{constructor(){super();p(this,"lc_namespace",["langchain_core","message","fake"]);p(this,"messages",[])}async getMessages(){return this.messages}async addMessage(e){this.messages.push(e)}async addUserMessage(e){this.messages.push(new ht(e))}async addAIMessage(e){this.messages.push(new le(e))}async clear(){this.messages=[]}},oF=class extends sg{constructor(){super();p(this,"lc_namespace",["langchain_core","message","fake"]);p(this,"messages",[])}async addMessage(e){this.messages.push(e)}async getMessages(){return this.messages}},cF=class extends Es{constructor(){super();p(this,"name","fake_tracer");p(this,"runs",[])}persistRun(e){return this.runs.push(e),Promise.resolve()}},lF=class extends mc{constructor(){super(...arguments);p(this,"lc_namespace",["tests","fake"])}getFormatInstructions(){return""}async parse(e){return e.split(",").map(n=>n.trim())}},uF=class extends ig{constructor(e){super();p(this,"lc_namespace",["test","fake"]);p(this,"output",[new us({pageContent:"foo"}),new us({pageContent:"bar"})]);this.output=(e==null?void 0:e.output)??this.output}async _getRelevantDocuments(e){return this.output}},dF=class extends Fe{constructor(e){super(e);p(this,"lc_namespace",["tests","fake"]);p(this,"returnOptions");this.returnOptions=e.returnOptions}async invoke(e,n){return this.returnOptions?n??{}:{input:e}}},hF=class extends wc{constructor(e){super(e);p(this,"name");p(this,"description");p(this,"schema");this.name=e.name,this.description=e.description,this.schema=e.schema}async _call(e,n){return JSON.stringify(e)}},fF=class extends Es{constructor(){super();p(this,"runPromiseResolver");p(this,"runPromise");p(this,"name","single_run_extractor");this.runPromise=new Promise(e=>{this.runPromiseResolver=e})}async persistRun(e){this.runPromiseResolver(e)}async extract(){return this.runPromise}};function ax(t,e){let n=0,r=0,s=0;for(let i=0;i<t.length;i++)n+=t[i]*e[i],r+=t[i]*t[i],s+=e[i]*e[i];return n/(Math.sqrt(r)*Math.sqrt(s))}var pF=class ox extends ag{constructor(n,{similarity:r,...s}={}){super(n,s);p(this,"memoryVectors",[]);p(this,"similarity");this.similarity=r??ax}_vectorstoreType(){return"memory"}async addDocuments(n){const r=n.map(({pageContent:s})=>s);return this.addVectors(await this.embeddings.embedDocuments(r),n)}async addVectors(n,r){const s=n.map((i,a)=>({content:r[a].pageContent,embedding:i,metadata:r[a].metadata}));this.memoryVectors=this.memoryVectors.concat(s)}async similaritySearchVectorWithScore(n,r,s){const i=l=>{if(!s)return!0;const u=new us({metadata:l.metadata,pageContent:l.content});return s(u)},a=this.memoryVectors.filter(i);return a.map((l,u)=>({similarity:this.similarity(n,l.embedding),index:u})).sort((l,u)=>l.similarity>u.similarity?-1:0).slice(0,r).map(l=>[new us({metadata:a[l.index].metadata,pageContent:a[l.index].content}),l.similarity])}static async fromTexts(n,r,s,i){const a=[];for(let o=0;o<n.length;o+=1){const c=Array.isArray(r)?r[o]:r,l=new us({pageContent:n[o],metadata:c});a.push(l)}return ox.fromDocuments(a,s,i)}static async fromDocuments(n,r,s){const i=new this(r,s);return await i.addDocuments(n),i}static async fromExistingIndex(n,r){return new this(n,r)}},cx={};Se(cx,{FakeChatMessageHistory:()=>aF,FakeChatModel:()=>Q4,FakeEmbeddings:()=>rF,FakeLLM:()=>sF,FakeListChatMessageHistory:()=>oF,FakeListChatModel:()=>tF,FakeRetriever:()=>uF,FakeRunnable:()=>dF,FakeSplitIntoListParser:()=>lF,FakeStreamingChatModel:()=>eF,FakeStreamingLLM:()=>iF,FakeTool:()=>hF,FakeTracer:()=>cF,FakeVectorStore:()=>pF,SingleRunExtractor:()=>fF,SyntheticEmbeddings:()=>nF});var lx={};Se(lx,{EventStreamContentType:()=>mF,convertEventStreamToIterableReadableDataStream:()=>yF,getBytes:()=>ux,getLines:()=>dx,getMessages:()=>hx});const mF="text/event-stream";async function ux(t,e){if(t instanceof ReadableStream){const n=t.getReader();for(;;){const r=await n.read();if(r.done){e(new Uint8Array,!0);break}e(r.value)}}else try{for await(const n of t)e(new Uint8Array(n));e(new Uint8Array,!0)}catch(n){throw new Error(["Parsing event source stream failed.","Ensure your implementation of fetch returns a web or Node readable stream.",`Error: ${n.message}`].join(`
`))}}var sa=function(t){return t[t.NewLine=10]="NewLine",t[t.CarriageReturn=13]="CarriageReturn",t[t.Space=32]="Space",t[t.Colon=58]="Colon",t}(sa||{});function dx(t){let e,n,r,s=!1;return function(a,o){if(o){t(a,0,!0);return}e===void 0?(e=a,n=0,r=-1):e=gF(e,a);const c=e.length;let l=0;for(;n<c;){s&&(e[n]===sa.NewLine&&(l=++n),s=!1);let u=-1;for(;n<c&&u===-1;++n)switch(e[n]){case sa.Colon:r===-1&&(r=n-l);break;case sa.CarriageReturn:s=!0;case sa.NewLine:u=n;break}if(u===-1)break;t(e.subarray(l,u),r),l=n,r=-1}l===c?e=void 0:l!==0&&(e=e.subarray(l),n-=l)}}function hx(t,e,n){let r=gh();const s=new TextDecoder;return function(a,o,c){if(c){_F(r)||(t==null||t(r),r=gh());return}if(a.length===0)t==null||t(r),r=gh();else if(o>0){const l=s.decode(a.subarray(0,o)),u=o+(a[o+1]===sa.Space?2:1),d=s.decode(a.subarray(u));switch(l){case"data":r.data=r.data?r.data+`
`+d:d;break;case"event":r.event=d;break;case"id":e==null||e(r.id=d);break;case"retry":{const h=parseInt(d,10);Number.isNaN(h)||n==null||n(r.retry=h);break}}}}}function gF(t,e){const n=new Uint8Array(t.length+e.length);return n.set(t),n.set(e,t.length),n}function gh(){return{data:"",event:"",id:"",retry:void 0}}function yF(t,e){const n=new ReadableStream({async start(r){const s=hx(a=>{if(a.event==="error")throw new Error(a.data??"Unspecified event streaming error.");a.event==="metadata"?e==null||e(a):a.data&&r.enqueue(a.data)});await ux(t,dx((a,o,c)=>{s(a,o,c),c&&r.close()}))}});return hn.fromReadableStream(n)}function _F(t){return t.data===""&&t.event===""&&t.id===""&&t.retry===void 0}var wF={};function vF(t,e){let n=0;for(let r=0;r<t.length;r++)n+=t[r]*e[r];return n}function bF(t,e){let n=0;for(let r=0;r<t.length;r++)n+=(t[r]-e[r])*(t[r]-e[r]);return n}function EF(t,e){return Math.sqrt(bF(t,e))}var fx={};Se(fx,{cosineSimilarity:()=>Kf,euclideanDistance:()=>xF,innerProduct:()=>SF,matrixFunc:()=>md,maximalMarginalRelevance:()=>kF,normalize:()=>TF});function md(t,e,n){if(t.length===0||t[0].length===0||e.length===0||e[0].length===0)return[[]];if(t[0].length!==e[0].length)throw new Error(`Number of columns in X and Y must be the same. X has shape ${[t.length,t[0].length]} and Y has shape ${[e.length,e[0].length]}.`);return t.map(r=>e.map(s=>n(r,s)).map(s=>Number.isNaN(s)?0:s))}function TF(t,e=!1){const n=IF(t);return t.map(r=>r.map(s=>e?1-s/n:s/n))}function Kf(t,e){return md(t,e,ax)}function SF(t,e){return md(t,e,vF)}function xF(t,e){return md(t,e,EF)}function kF(t,e,n=.5,r=4){if(Math.min(r,e.length)<=0)return[];const s=Array.isArray(t[0])?t:[t],i=Kf(s,e)[0],a=px(i).maxIndex,o=[e[a]],c=[a];for(;c.length<Math.min(r,e.length);){let l=-1/0,u=-1;const d=Kf(e,o);i.forEach((h,f)=>{if(c.includes(f))return;const m=Math.max(...d[f]),g=n*h-(1-n)*m;g>l&&(l=g,u=f)}),o.push(e[u]),c.push(u)}return c}function px(t){if(t.length===0)return{maxIndex:-1,maxValue:NaN};let e=t[0],n=0;for(let r=1;r<t.length;r+=1)t[r]>e&&(n=r,e=t[r]);return{maxIndex:n,maxValue:e}}function IF(t){return t.reduce((e,n)=>Math.max(e,px(n).maxValue),0)}var mx={};Se(mx,{agents:()=>T4,caches:()=>xT,callbacks__base:()=>bv,callbacks__manager:()=>tb,callbacks__promises:()=>Qv,chat_history:()=>vS,document_loaders__base:()=>CS,document_loaders__langsmith:()=>$S,documents:()=>NS,embeddings:()=>YT,example_selectors:()=>jS,index:()=>x4,indexing:()=>ZS,language_models__base:()=>PT,language_models__chat_models:()=>MT,language_models__llms:()=>JT,language_models__profile:()=>B4,load__serializable:()=>Gw,memory:()=>ES,messages:()=>I0,messages__tool:()=>tv,output_parsers:()=>FT,output_parsers__openai_functions:()=>KS,output_parsers__openai_tools:()=>ZT,outputs:()=>mb,prompt_values:()=>ET,prompts:()=>mS,retrievers:()=>IS,retrievers__document_compressors:()=>VS,runnables:()=>LT,runnables__graph:()=>m0,singletons:()=>ob,stores:()=>SS,structured_query:()=>rx,tools:()=>QT,tracers__base:()=>Hv,tracers__console:()=>Jv,tracers__log_stream:()=>fb,tracers__run_collector:()=>GS,tracers__tracer_langchain:()=>Xv,types__stream:()=>Z4,utils__async_caller:()=>_b,utils__chunk_array:()=>XT,utils__context:()=>WS,utils__env:()=>pv,utils__event_source_parse:()=>lx,utils__format:()=>wF,utils__function_calling:()=>aT,utils__hash:()=>ST,utils__json_patch:()=>jT,utils__json_schema:()=>p0,utils__math:()=>fx,utils__stream:()=>cb,utils__testing:()=>cx,utils__tiktoken:()=>RT,utils__types:()=>lT,vectorstores:()=>AS});function AF(t){const e={};for(let n=t;n&&n.prototype;n=Object.getPrototypeOf(n))Object.assign(e,Reflect.get(n.prototype,"lc_aliases"));return Object.entries(e).reduce((n,[r,s])=>(n[s]=r,n),{})}async function Tl(t){const{optionalImportsMap:e={},optionalImportEntrypoints:n=[],importMap:r={},secretsMap:s={},path:i=["$"]}=this,a=i.join(".");if(typeof t=="object"&&t!==null&&!Array.isArray(t)&&"lc"in t&&"type"in t&&"id"in t&&t.lc===1&&t.type==="secret"){const o=t,[c]=o.id;if(c in s)return s[c];{const l=Sr(c);if(l)return l;throw new Error(`Missing key "${c}" for ${a} in load(secretsMap={})`)}}else if(typeof t=="object"&&t!==null&&!Array.isArray(t)&&"lc"in t&&"type"in t&&"id"in t&&t.lc===1&&t.type==="not_implemented"){const c=JSON.stringify(t);throw new Error(`Trying to load an object that doesn't implement serialization: ${a} -> ${c}`)}else if(typeof t=="object"&&t!==null&&!Array.isArray(t)&&"lc"in t&&"type"in t&&"id"in t&&"kwargs"in t&&t.lc===1){const o=t,c=JSON.stringify(o),[l,...u]=o.id.slice().reverse(),d=u.reverse(),h={langchain_core:mx,langchain:r};let f=null;const m=[d.join("/")];d[0]==="langchain_community"&&m.push(["langchain",...d.slice(1)].join("/"));const g=m.find(y=>y in e);if(E4.concat(n).includes(d.join("/"))||g)if(g!==void 0)f=await e[g];else throw new Error(`Missing key "${d.join("/")}" for ${a} in load(optionalImportsMap={})`);else{let y;if(d[0]==="langchain"||d[0]==="langchain_core")y=h[d[0]],d.shift();else throw new Error(`Invalid namespace: ${a} -> ${c}`);if(d.length===0)throw new Error(`Invalid namespace: ${a} -> ${c}`);let v;do{if(v=d.join("__"),v in y)break;d.pop()}while(d.length>0);v in y&&(f=y[v])}if(typeof f!="object"||f===null)throw new Error(`Invalid namespace: ${a} -> ${c}`);const w=f[l]??Object.values(f).find(y=>typeof y=="function"&&Au(y)===l);if(typeof w!="function")throw new Error(`Invalid identifer: ${a} -> ${c}`);const b=await Tl.call({...this,path:[...i,"kwargs"]},o.kwargs);if(o.type==="constructor"){const y=new w(Vw(b,wI,AF(w)));return Object.defineProperty(y.constructor,"name",{value:l}),y}else throw new Error(`Invalid type: ${a} -> ${c}`)}else if(typeof t=="object"&&t!==null)return Array.isArray(t)?Promise.all(t.map((o,c)=>Tl.call({...this,path:[...i,`${c}`]},o))):Object.fromEntries(await Promise.all(Object.entries(t).map(async([o,c])=>[o,await Tl.call({...this,path:[...i,o]},c)])));return t}async function CF(t,e){const n=JSON.parse(t);return Tl.call({...e},n)}function OF(t){return t!==null&&t.lc===1&&t.type==="constructor"&&Array.isArray(t.id)}async function Xf(t){if(t&&typeof t=="object"){if(Array.isArray(t))return await Promise.all(t.map(n=>Xf(n)));{const e={};for(const[n,r]of Object.entries(t))e[n]=await Xf(r);if(e.lc===2&&e.type==="undefined")return;if(e.lc===2&&e.type==="constructor"&&Array.isArray(e.id))try{const n=e.id[e.id.length-1];let r;switch(n){case"Set":r=Set;break;case"Map":r=Map;break;case"RegExp":r=RegExp;break;case"Error":r=Error;break;default:return e}return e.method?r[e.method](...e.args||[]):new r(...e.args||[])}catch{return e}else if(OF(e))return CF(JSON.stringify(e));return e}}return t}function yh(t,e,n,r){return{lc:2,type:"constructor",id:[t.name],method:e??null,args:n??[],kwargs:r??{}}}function $F(t){return t===void 0?{lc:2,type:"undefined"}:t instanceof Set||t instanceof Map?yh(t.constructor,void 0,[Array.from(t)]):t instanceof RegExp?yh(RegExp,void 0,[t.source,t.flags]):t instanceof Error?yh(t.constructor,void 0,[t.message]):(t==null?void 0:t.lg_name)==="Send"?{node:t.node,args:t.args}:t}var RF=class{_dumps(t){return new TextEncoder().encode(v4(t,(n,r)=>$F(r)))}async dumpsTyped(t){return t instanceof Uint8Array?["bytes",t]:["json",this._dumps(t)]}async _loads(t){const e=JSON.parse(t);return Xf(e)}async loadsTyped(t,e){if(t==="bytes")return typeof e=="string"?new TextEncoder().encode(e):e;if(t==="json")return this._loads(typeof e=="string"?e:new TextDecoder().decode(e));throw new Error(`Unknown serialization type: ${t}`)}};function gx(t){if(typeof t!="object"||t===null)return t;const e=Array.isArray(t)?[]:{};for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=gx(t[n]));return e}function yx(){return{v:4,id:wS(-2),ts:new Date().toISOString(),channel_values:{},channel_versions:{},versions_seen:{}}}function wu(t){return{v:t.v,id:t.id,ts:t.ts,channel_values:{...t.channel_values},channel_versions:{...t.channel_versions},versions_seen:gx(t.versions_seen)}}function _x(t,e){return typeof t=="number"&&typeof e=="number"?Math.sign(t-e):String(t).localeCompare(String(e))}function NF(...t){return t.reduce((e,n,r)=>r===0?n:_x(e,n)>=0?e:n)}const PF={[m4]:-1,[bl]:-2,[g4]:-3,[y4]:-4};var Ua=class extends Error{constructor(t){super(t),this.name="InvalidNamespaceError"}};function MF(t){if(t.length===0)throw new Ua("Namespace cannot be empty.");for(const e of t){if(typeof e!="string")throw new Ua(`Invalid namespace label '${e}' found in ${t}. Namespace labels must be strings, but got ${typeof e}.`);if(e.includes("."))throw new Ua(`Invalid namespace label '${e}' found in ${t}. Namespace labels cannot contain periods ('.').`);if(e==="")throw new Ua(`Namespace labels cannot be empty strings. Got ${e} in ${t}`)}if(t[0]==="langgraph")throw new Ua(`Root label for namespace cannot be "langgraph". Got: ${t}`)}var LF=class{async get(t,e){return(await this.batch([{namespace:t,key:e}]))[0]}async search(t,e={}){const{filter:n,limit:r=10,offset:s=0,query:i}=e;return(await this.batch([{namespacePrefix:t,filter:n,limit:r,offset:s,query:i}]))[0]}async put(t,e,n,r){MF(t),await this.batch([{namespace:t,key:e,value:n,index:r}])}async delete(t,e){await this.batch([{namespace:t,key:e,value:null}])}async listNamespaces(t={}){const{prefix:e,suffix:n,maxDepth:r,limit:s=100,offset:i=0}=t,a=[];return e&&a.push({matchType:"prefix",path:e}),n&&a.push({matchType:"suffix",path:n}),(await this.batch([{matchConditions:a.length?a:void 0,maxDepth:r,limit:s,offset:i}]))[0]}start(){}stop(){}};const jF=t=>"lg_name"in t&&t.lg_name==="AsyncBatchedStore"?t.store:t;var DF=class extends LF{constructor(e){super();p(this,"lg_name","AsyncBatchedStore");p(this,"store");p(this,"queue",new Map);p(this,"nextKey",0);p(this,"running",!1);p(this,"processingTask",null);this.store=jF(e)}get isRunning(){return this.running}async batch(e){throw new Error("The `batch` method is not implemented on `AsyncBatchedStore`.\n Instead, it calls the `batch` method on the wrapped store.\n If you are seeing this error, something is wrong.")}async get(e,n){return this.enqueueOperation({namespace:e,key:n})}async search(e,n){const{filter:r,limit:s=10,offset:i=0,query:a}=n||{};return this.enqueueOperation({namespacePrefix:e,filter:r,limit:s,offset:i,query:a})}async put(e,n,r){return this.enqueueOperation({namespace:e,key:n,value:r})}async delete(e,n){return this.enqueueOperation({namespace:e,key:n,value:null})}start(){this.running||(this.running=!0,this.processingTask=this.processBatchQueue())}async stop(){this.running=!1,this.processingTask&&await this.processingTask}enqueueOperation(e){return new Promise((n,r)=>{const s=this.nextKey;this.nextKey+=1,this.queue.set(s,{operation:e,resolve:n,reject:r})})}async processBatchQueue(){for(;this.running;){if(await new Promise(n=>{setTimeout(n,0)}),this.queue.size===0)continue;const e=new Map(this.queue);this.queue.clear();try{const n=Array.from(e.values()).map(({operation:s})=>s),r=await this.store.batch(n);e.forEach(({resolve:s},i)=>{const a=Array.from(e.keys()).indexOf(i);s(r[a])})}catch(n){e.forEach(({reject:r})=>{r(n)})}}}toJSON(){return{queue:this.queue,nextKey:this.nextKey,running:this.running,store:"[LangGraphStore]"}}},UF=class{constructor(t){p(this,"serde",new RF);this.serde=t||this.serde}};function wx(t){return t!=null&&t.lg_is_channel===!0}var Mi=class{constructor(){p(this,"ValueType");p(this,"UpdateType");p(this,"lg_is_channel",!0)}consume(){return!1}finish(){return!1}isAvailable(){try{return this.get(),!0}catch(t){if(t.name===en.unminifiable_name)return!1;throw t}}};const Yf=Symbol.for("LG_IS_ONLY_BASE_CHANNEL");function hg(t){if(t[Yf]===!0)return t;const e={};for(const n in t){if(!Object.prototype.hasOwnProperty.call(t,n))continue;const r=t[n];wx(r)&&(e[n]=r)}return Object.assign(e,{[Yf]:!0}),e}function vu(t,e){const n=hg(t),r={};for(const s in n){if(!Object.prototype.hasOwnProperty.call(n,s))continue;const i=e.channel_values[s];r[s]=n[s].fromCheckpoint(i)}return Object.assign(r,{[Yf]:!0}),r}function li(t,e,n,r){let s;if(e===void 0)s=t.channel_values;else{s={};for(const i in e)if(Object.prototype.hasOwnProperty.call(e,i))try{s[i]=e[i].checkpoint()}catch(a){if(a.name!==en.unminifiable_name)throw a}}return{v:4,id:(r==null?void 0:r.id)??wS(n),ts:new Date().toISOString(),channel_values:s,channel_versions:t.channel_versions,versions_seen:t.versions_seen}}var Qf=class vx extends Mi{constructor(n,r){super();p(this,"lc_graph_name","BinaryOperatorAggregate");p(this,"value");p(this,"operator");p(this,"initialValueFactory");this.operator=n,this.initialValueFactory=r,this.value=r==null?void 0:r()}fromCheckpoint(n){const r=new vx(this.operator,this.initialValueFactory);return typeof n<"u"&&(r.value=n),r}update(n){let r=n;if(!r.length)return!1;this.value===void 0&&([this.value]=r,r=r.slice(1));for(const s of r)this.value!==void 0&&(this.value=this.operator(this.value,s));return!0}get(){if(this.value===void 0)throw new en;return this.value}checkpoint(){if(this.value===void 0)throw new en;return this.value}isAvailable(){return this.value!==void 0}},fg=class bx extends Mi{constructor(n){super();p(this,"lc_graph_name","LastValue");p(this,"value",[]);this.initialValueFactory=n,n&&(this.value=[n()])}fromCheckpoint(n){const r=new bx(this.initialValueFactory);return typeof n<"u"&&(r.value=[n]),r}update(n){if(n.length===0)return!1;if(n.length!==1)throw new dt("LastValue can only receive one value per step.",{lc_error_code:"INVALID_CONCURRENT_GRAPH_UPDATE"});return this.value=[n[n.length-1]],!0}get(){if(this.value.length===0)throw new en;return this.value[0]}checkpoint(){if(this.value.length===0)throw new en;return this.value[0]}isAvailable(){return this.value.length!==0}},FF=class Ex extends Mi{constructor(){super(...arguments);p(this,"lc_graph_name","LastValueAfterFinish");p(this,"value",[]);p(this,"finished",!1)}fromCheckpoint(n){const r=new Ex;if(typeof n<"u"){const[s,i]=n;r.value=[s],r.finished=i}return r}update(n){return n.length===0?!1:(this.finished=!1,this.value=[n[n.length-1]],!0)}get(){if(this.value.length===0||!this.finished)throw new en;return this.value[0]}checkpoint(){if(this.value.length!==0)return[this.value[0],this.finished]}consume(){return this.finished?(this.finished=!1,this.value=[],!0):!1}finish(){return!this.finished&&this.value.length>0?(this.finished=!0,!0):!1}isAvailable(){return this.value.length!==0&&this.finished}},BF=class{constructor(t){p(this,"lc_graph_name","AnnotationRoot");p(this,"spec");this.spec=t}};const ep=function(t){return t?tp(t):new fg};ep.Root=t=>new BF(t);function tp(t){return typeof t=="object"&&t&&"reducer"in t&&t.reducer?new Qf(t.reducer,t.default):typeof t=="object"&&t&&"value"in t&&t.value?new Qf(t.value,t.default):new fg}const et="__start__",ve="__end__",ns="__input__",zF="__copy__",An="__error__",_h="__pregel_ns_writes",Gs="__pregel_send",pg="__pregel_call",Si="__pregel_read",$t="__pregel_checkpointer",$s="__pregel_resuming",mo="__pregel_task_id",bu="__pregel_stream",ZF="__pregel_resume_value",Sl="__pregel_resume_map",Ws="__pregel_scratchpad",xl="__pregel_previous",Tx="__pregel_durability",np="checkpoint_id",Dr="checkpoint_ns",VF="__pregel_node_finished",rr="checkpoint_map",Q_="__pregel_abort_signals",He="__interrupt__",Rn="__resume__",mg="__no_writes__",Sa="__return__",wh="__previous__",Nt="langsmith:hidden",GF="langsmith:nostream",ew="__self__",sr="__pregel_tasks",Bn="__pregel_push",kl="__pregel_pull",ir="00000000-0000-0000-0000-000000000000",WF=[Nt,ns,He,Rn,An,mg,Gs,Si,$t,Tx,bu,$s,mo,pg,ZF,Ws,xl,rr,Dr,np],Ut="|",ds=":",tw=Symbol.for("langgraph.command");var kw,HF=(kw=tw,class{constructor(t){p(this,kw);this[tw]=t}});function rp(t){const e=t;return e!=null&&typeof e.node=="string"&&e.args!==void 0}var yn=class{constructor(t,e){p(this,"lg_name","Send");p(this,"node");p(this,"args");this.node=t,this.args=Fo(e)}toJSON(){return{lg_name:this.lg_name,node:this.node,args:this.args}}};function Xn(t){return t instanceof yn}function Sx(t){return!t||typeof t!="object"||!(He in t)?!1:Array.isArray(t[He])}var Lh,xt=(Lh=class extends HF{constructor(e){super(e);p(this,"lg_name","Command");p(this,"lc_direct_tool_output",!0);p(this,"graph");p(this,"update");p(this,"resume");p(this,"goto",[]);this.resume=e.resume,this.graph=e.graph,this.update=e.update,e.goto&&(this.goto=Array.isArray(e.goto)?Fo(e.goto):[Fo(e.goto)])}_updateAsTuples(){return this.update&&typeof this.update=="object"&&!Array.isArray(this.update)?Object.entries(this.update):Array.isArray(this.update)&&this.update.every(e=>Array.isArray(e)&&e.length===2&&typeof e[0]=="string")?this.update:[["__root__",this.update]]}toJSON(){var n;let e;return typeof this.goto=="string"?e=this.goto:Xn(this.goto)?e=this.goto.toJSON():e=(n=this.goto)==null?void 0:n.map(r=>typeof r=="string"?r:r.toJSON()),{lg_name:this.lg_name,update:this.update,resume:this.resume,goto:e}}},p(Lh,"PARENT","__parent__"),Lh);function Gt(t){return typeof t!="object"||t==null?!1:"lg_name"in t&&t.lg_name==="Command"}function Fo(t,e=new Map){if(t!=null&&typeof t=="object"){if(e.has(t))return e.get(t);let n;if(Array.isArray(t))n=[],e.set(t,n),t.forEach((r,s)=>{n[s]=Fo(r,e)});else if(Gt(t)&&!(t instanceof xt))n=new xt(t),e.set(t,n);else if(rp(t)&&!(t instanceof yn))n=new yn(t.node,t.args),e.set(t,n);else if(Gt(t)||Xn(t))n=t,e.set(t,n);else if("lc_serializable"in t&&t.lc_serializable)n=t,e.set(t,n);else{n={},e.set(t,n);for(const[r,s]of Object.entries(t))n[r]=Fo(s,e)}return n}return t}const qF=["tags","metadata","callbacks","configurable"],JF=["tags","metadata","callbacks","runName","maxConcurrency","recursionLimit","configurable","runId","outputKeys","streamMode","store","writer","interrupt","context","interruptBefore","interruptAfter","checkpointDuring","durability","signal"],KF=25;function xx(...t){const e={tags:[],metadata:{},callbacks:void 0,recursionLimit:KF,configurable:{}},n=Ft.getRunnableConfig();if(n!==void 0){for(const[r,s]of Object.entries(n))if(s!==void 0)if(qF.includes(r)){let i;Array.isArray(s)?i=[...s]:typeof s=="object"?r==="callbacks"&&"copy"in s&&typeof s.copy=="function"?i=s.copy():i={...s}:i=s,e[r]=i}else e[r]=s}for(const r of t)if(r!==void 0)for(const[s,i]of Object.entries(r))i!==void 0&&JF.includes(s)&&(e[s]=i);for(const[r,s]of Object.entries(e.configurable))e.metadata=e.metadata??{},!r.startsWith("__")&&(typeof s=="string"||typeof s=="number"||typeof s=="boolean")&&!(r in e.metadata)&&(e.metadata[r]=s);return e}function XF(){return Ft.getRunnableConfig()}function vh(t){return t.split(Ut).filter(e=>!e.match(/^\d+$/)).map(e=>e.split(ds)[0]).join(Ut)}function YF(t){const e=t.split(Ut);for(;e.length>1&&e[e.length-1].match(/^\d+$/);)e.pop();return e.slice(0,-1).join(Ut)}var Li=class extends Fe{constructor(n){super();p(this,"lc_namespace",["langgraph"]);p(this,"func");p(this,"tags");p(this,"config");p(this,"trace",!0);p(this,"recurse",!0);this.name=n.name??n.func.name,this.func=n.func,this.config=n.tags?{tags:n.tags}:void 0,this.trace=n.trace??this.trace,this.recurse=n.recurse??this.recurse}async _tracedInvoke(n,r,s){return new Promise((i,a)=>{const o=Xe(r,{callbacks:s==null?void 0:s.getChild()});Ft.runWithConfig(o,async()=>{try{const c=await this.func(n,o);i(c)}catch(c){a(c)}})})}async invoke(n,r){let s;const i=xx(r),a=Zn(this.config,i);return this.trace?s=await this._callWithConfig(this._tracedInvoke,n,a):s=await Ft.runWithConfig(a,async()=>this.func(n,a)),Fe.isRunnable(s)&&this.recurse?await Ft.runWithConfig(a,async()=>s.invoke(n,a)):s}};function*As(t,e){if(e===void 0)yield*t;else for(const n of t)yield[e,n]}async function Ns(t){const e=[];for await(const n of await t)e.push(n);return e}function no(t){const e=[];for(const n of t)e.push(n);return e}function Vi(t,e){return t?"configurable"in t?{...t,configurable:{...t.configurable,...e}}:{...t,configurable:e}:{configurable:e}}function QF(t){return typeof t=="object"&&(t==null?void 0:t[Symbol.for("LG_SKIP_WRITE")])!==void 0}const xi={[Symbol.for("LG_PASSTHROUGH")]:!0};function Xc(t){return typeof t=="object"&&(t==null?void 0:t[Symbol.for("LG_PASSTHROUGH")])!==void 0}const bh=Symbol("IS_WRITER");var _n=class sp extends Li{constructor(n,r){const s=`ChannelWrite<${n.map(i=>Xn(i)?i.node:"channel"in i?i.channel:"...").join(",")}>`;super({writes:n,name:s,tags:r,func:async(i,a)=>this._write(i,a??{})});p(this,"writes");this.writes=n}async _write(n,r){const s=this.writes.map(i=>Eh(i)&&Xc(i.value)?{mapper:i.mapper,value:n}:Il(i)&&Xc(i.value)?{channel:i.channel,value:n,skipNone:i.skipNone,mapper:i.mapper}:i);return await sp.doWrite(r,s),n}static async doWrite(n,r){var a;for(const o of r){if(Il(o)){if(o.channel===sr)throw new dt("Cannot write to the reserved channel TASKS");if(Xc(o.value))throw new dt("PASSTHROUGH value must be replaced")}if(Eh(o)&&Xc(o.value))throw new dt("PASSTHROUGH value must be replaced")}const s=[];for(const o of r)if(Xn(o))s.push([sr,o]);else if(Eh(o)){const c=await o.mapper.invoke(o.value,n);c!=null&&c.length>0&&s.push(...c)}else if(Il(o)){const c=o.mapper!==void 0?await o.mapper.invoke(o.value,n):o.value;if(QF(c)||o.skipNone&&c===void 0)continue;s.push([o.channel,c])}else throw new Error(`Invalid write entry: ${JSON.stringify(o)}`);((a=n.configurable)==null?void 0:a[Gs])(s)}static isWriter(n){return n instanceof sp||bh in n&&!!n[bh]}static registerWriter(n){return Object.defineProperty(n,bh,{value:!0})}};function Il(t){return t!==void 0&&typeof t.channel=="string"}function Eh(t){return t!==void 0&&!Il(t)&&Fe.isRunnable(t.mapper)}var eB=class kx extends Li{constructor(n,r,s=!1){super({func:(i,a)=>kx.doRead(a,this.channel,this.fresh,this.mapper)});p(this,"lc_graph_name","ChannelRead");p(this,"channel");p(this,"fresh",!1);p(this,"mapper");this.fresh=s,this.mapper=r,this.channel=n,this.name=Array.isArray(n)?`ChannelRead<${n.join(",")}>`:`ChannelRead<${n}>`}static doRead(n,r,s,i){var o;const a=(o=n.configurable)==null?void 0:o[Si];if(!a)throw new Error("Runnable is not configured with a read function. Make sure to call in the context of a Pregel process");return i?i(a(r,s)):a(r,s)}};const Gi=new Ci;var Bo=class ro extends cn{constructor(n){var w;const{channels:r,triggers:s,mapper:i,writers:a,bound:o,kwargs:c,metadata:l,retryPolicy:u,cachePolicy:d,tags:h,subgraphs:f,ends:m}=n,g=[...(w=n.config)!=null&&w.tags?n.config.tags:[],...h??[]];super({...n,bound:n.bound??Gi,config:{...n.config?n.config:{},tags:g}});p(this,"lc_graph_name","PregelNode");p(this,"channels");p(this,"triggers",[]);p(this,"mapper");p(this,"writers",[]);p(this,"bound",Gi);p(this,"kwargs",{});p(this,"metadata",{});p(this,"tags",[]);p(this,"retryPolicy");p(this,"cachePolicy");p(this,"subgraphs");p(this,"ends");this.channels=r,this.triggers=s,this.mapper=i,this.writers=a??this.writers,this.bound=o??this.bound,this.kwargs=c??this.kwargs,this.metadata=l??this.metadata,this.tags=g,this.retryPolicy=u,this.cachePolicy=d,this.subgraphs=f,this.ends=m}getWriters(){var r;const n=[...this.writers];for(;n.length>1&&n[n.length-1]instanceof _n&&n[n.length-2]instanceof _n;){const s=n.slice(-2),i=s[0].writes.concat(s[1].writes);n[n.length-2]=new _n(i,(r=s[0].config)==null?void 0:r.tags),n.pop()}return n}getNode(){const n=this.getWriters();if(!(this.bound===Gi&&n.length===0))return this.bound===Gi&&n.length===1?n[0]:this.bound===Gi?new Jn({first:n[0],middle:n.slice(1,n.length-1),last:n[n.length-1],omitSequenceTags:!0}):n.length>0?new Jn({first:this.bound,middle:n.slice(0,n.length-1),last:n[n.length-1],omitSequenceTags:!0}):this.bound}join(n){if(!Array.isArray(n))throw new Error("channels must be a list");if(typeof this.channels!="object")throw new Error("all channels must be named when using .join()");return new ro({channels:{...this.channels,...Object.fromEntries(n.map(r=>[r,r]))},triggers:this.triggers,mapper:this.mapper,writers:this.writers,bound:this.bound,kwargs:this.kwargs,config:this.config,retryPolicy:this.retryPolicy,cachePolicy:this.cachePolicy})}pipe(n){return _n.isWriter(n)?new ro({channels:this.channels,triggers:this.triggers,mapper:this.mapper,writers:[...this.writers,n],bound:this.bound,config:this.config,kwargs:this.kwargs,retryPolicy:this.retryPolicy,cachePolicy:this.cachePolicy}):this.bound===Gi?new ro({channels:this.channels,triggers:this.triggers,mapper:this.mapper,writers:this.writers,bound:Qt(n),config:this.config,kwargs:this.kwargs,retryPolicy:this.retryPolicy,cachePolicy:this.cachePolicy}):new ro({channels:this.channels,triggers:this.triggers,mapper:this.mapper,writers:this.writers,bound:this.bound.pipe(n),config:this.config,kwargs:this.kwargs,retryPolicy:this.retryPolicy,cachePolicy:this.cachePolicy})}};function tB(t){return"steps"in t&&Array.isArray(t.steps)}function gg(t){return"lg_is_pregel"in t&&t.lg_is_pregel===!0}function Ix(t){const e=[t];for(const n of e){if(gg(n))return n;tB(n)&&e.push(...n.steps)}}const J=t=>BigInt(t),rt=(t,e=0)=>new DataView(t.buffer,t.byteOffset+e,t.byteLength-e),Ax=J("0x9E3779B1"),Cx=J("0x85EBCA77"),nB=J("0xC2B2AE3D"),Xs=J("0x9E3779B185EBCA87"),$i=J("0xC2B2AE3D27D4EB4F"),Ox=J("0x165667B19E3779F9"),yg=J("0x85EBCA77C2B2AE63"),rB=J("0x27D4EB2F165667C5"),sB=J("0x165667919E3779F9"),iB=J("0x9FB21C651E98DF25"),aB=t=>{const e=t.length;if(e%2!==0)throw new Error("String should have an even number of characters");const n=e/2,r=new Uint8Array(n);let s=0,i=0;for(;i<n;){const a=t.slice(s,s+=2);r[i]=Number.parseInt(a,16),i+=1}return rt(r)},Mr=aB("b8fe6c3923a44bbe7c01812cf721ad1cded46de9839097db7240a4a4b7b3671fcb79e64eccc0e578825ad07dccff7221b8084674f743248ee03590e6813a264c3c2852bb91c300cb88d0658b1b532ea371644897a20df94e3819ef46a9deacd8a8fa763fe39c343ff9dcbbc7c70b4f1d8a51e04bcdb45931c89f7ec9d9787364eac5ac8334d3ebc3c581a0fffa1363eb170ddd51b7f0da49d316552629d4689e2b16be587d47a1fc8ff8b8d17ad031ce45cb3a8f95160428afd7fbcabb4b407e"),la=(J(1)<<J(128))-J(1),je=(J(1)<<J(64))-J(1),Eu=(J(1)<<J(32))-J(1),rs=64,$x=rs/8,oB=8,Yc=4;function xa(t){if(!t)throw new Error("Assert failed")}function cB(t){const e=new DataView(new ArrayBuffer(8));return e.setBigUint64(0,t,!0),e.getBigUint64(0,!1)}function lB(t){let e=t;return e=(e&J(65535))<<J(16)|(e&J(4294901760))>>J(16),e=(e&J(16711935))<<J(8)|(e&J(4278255360))>>J(8),e}function uB(t,e){return(t&Eu)*(e&Eu)&je}function dB(t,e){return(t<<e|t>>J(32)-e)&Eu}function Rx(t,e,n){for(let r=0;r<$x;r+=1){const s=e.getBigUint64(r*8,!0),i=s^n.getBigUint64(r*8,!0);t[r^1]+=s,t[r]+=uB(i,i>>J(32))}return t}function nw(t,e,n,r){for(let s=0;s<r;s+=1)Rx(t,rt(e,s*rs),rt(n,s*8));return t}function hB(t,e){for(let n=0;n<$x;n+=1){const r=e.getBigUint64(n*8,!0);let s=t[n];s=ip(s,J(47)),s^=r,s*=Ax,t[n]=s&je}return t}function Qc(t,e){return Nx(t[0]^e.getBigUint64(0,!0),t[1]^e.getBigUint64(oB,!0))}function rw(t,e,n){let r=n;return r+=Qc(t.slice(0),rt(e,0*Yc)),r+=Qc(t.slice(2),rt(e,4*Yc)),r+=Qc(t.slice(4),rt(e,8*Yc)),r+=Qc(t.slice(6),rt(e,12*Yc)),Br(r&je)}function fB(t,e,n,r,s){let i=t;const a=Math.floor((n.byteLength-rs)/8),o=rs*a,c=Math.floor((e.byteLength-1)/o);for(let l=0;l<c;l+=1)i=nw(i,rt(e,l*o),n,a),i=s(i,rt(n,n.byteLength-rs));{const l=Math.floor((e.byteLength-1-o*c)/rs);i=nw(i,rt(e,c*o),n,l),i=r(i,rt(e,e.byteLength-rs),rt(n,n.byteLength-rs-7))}return i}function pB(t,e){let n=new BigUint64Array([nB,Xs,$i,Ox,yg,Cx,rB,Ax]);xa(t.byteLength>128),n=fB(n,t,e,Rx,hB),xa(n.length*8===64);{const r=rw(n,rt(e,11),J(t.byteLength)*Xs&je);return rw(n,rt(e,e.byteLength-rs-11),~(J(t.byteLength)*$i)&je)<<J(64)|r}}function Nx(t,e){const n=t*e&la;return n&je^n>>J(64)}function sw(t,e,n){return Nx((t.getBigUint64(0,!0)^e.getBigUint64(0,!0)+n)&je,(t.getBigUint64(8,!0)^e.getBigUint64(8,!0)-n)&je)}function Al(t,e,n,r,s){let i=t&je,a=t>>J(64)&je;return i+=sw(e,r,s),i^=n.getBigUint64(0,!0)+n.getBigUint64(8,!0),i&=je,a+=sw(n,rt(r,16),s),a^=e.getBigUint64(0,!0)+e.getBigUint64(8,!0),a&=je,a<<J(64)|i}function Br(t){let e=t;return e^=e>>J(37),e*=sB,e&=je,e^=e>>J(32),e}function Tu(t){let e=t;return e^=e>>J(33),e*=$i,e&=je,e^=e>>J(29),e*=Ox,e&=je,e^=e>>J(32),e}function mB(t,e,n){const r=t.byteLength;xa(r>0&&r<=3);const s=J(t.getUint8(r-1))|J(r<<8)|J(t.getUint8(0)<<16)|J(t.getUint8(r>>1)<<24),i=(J(e.getUint32(0,!0))^J(e.getUint32(4,!0)))+n,a=(s^i)&je,o=(J(e.getUint32(8,!0))^J(e.getUint32(12,!0)))-n,c=(dB(lB(s),J(13))^o)&je;return(Tu(c)&je)<<J(64)|Tu(a)}function ip(t,e){return t^t>>e}function gB(t,e,n){const r=t.byteLength;xa(r>=4&&r<=8);{const s=t.getUint32(0,!0),i=t.getUint32(r-4,!0),a=J(s)|J(i)<<J(32),o=(e.getBigUint64(16,!0)^e.getBigUint64(24,!0))+n&je;let l=(a^o)*(Xs+(J(r)<<J(2)))&la;return l+=(l&je)<<J(65),l&=la,l^=l>>J(67),ip(ip(l&je,J(35))*iB&je,J(28))|Br(l>>J(64))<<J(64)}}function yB(t,e,n){const r=t.byteLength;xa(r>=9&&r<=16);{const s=(e.getBigUint64(32,!0)^e.getBigUint64(40,!0))+n&je,i=(e.getBigUint64(48,!0)^e.getBigUint64(56,!0))-n&je,a=t.getBigUint64(0,!0);let o=t.getBigUint64(r-8,!0),c=(a^o^s)*Xs;const l=(c&je)+(J(r-1)<<J(54));c=c&(la^je)|l,o^=i,c+=o+(o&Eu)*(Cx-J(1))<<J(64),c&=la,c^=cB(c>>J(64));let u=(c&je)*$i;return u+=(c>>J(64))*$i<<J(64),u&=la,Br(u&je)|Br(u>>J(64))<<J(64)}}function _B(t,e){const n=t.byteLength;return xa(n<=16),n>8?yB(t,Mr,e):n>=4?gB(t,Mr,e):n>0?mB(t,Mr,e):Tu(e^Mr.getBigUint64(64,!0)^Mr.getBigUint64(72,!0))|Tu(e^Mr.getBigUint64(80,!0)^Mr.getBigUint64(88,!0))<<J(64)}function ap(t){return~t+J(1)&je}function wB(t,e,n){let r=J(t.byteLength)*Xs&je,s=J(t.byteLength-1)/J(32);for(;s>=0;){const o=Number(s);r=Al(r,rt(t,16*o),rt(t,t.byteLength-16*(o+1)),rt(e,32*o),n),s-=J(1)}let i=r+(r>>J(64))&je;i=Br(i);let a=(r&je)*Xs+(r>>J(64))*yg+(J(t.byteLength)-n&je)*$i;return a&=je,a=ap(Br(a)),i|a<<J(64)}function vB(t,e,n){let r=J(t.byteLength)*Xs&je;for(let a=32;a<160;a+=32)r=Al(r,rt(t,a-32),rt(t,a-16),rt(e,a-32),n);r=Br(r&je)|Br(r>>J(64))<<J(64);for(let a=160;a<=t.byteLength;a+=32)r=Al(r,rt(t,a-32),rt(t,a-16),rt(e,3+a-160),n);r=Al(r,rt(t,t.byteLength-16),rt(t,t.byteLength-32),rt(e,103),ap(n));let s=r+(r>>J(64))&je;s=Br(s);let i=(r&je)*Xs+(r>>J(64))*yg+(J(t.byteLength)-n&je)*$i;return i&=je,i=ap(Br(i)),s|i<<J(64)}function oi(t,e=J(0)){const n=new TextEncoder,r=rt(typeof t=="string"?n.encode(t):t),s=r.byteLength,i=a=>a.toString(16).padStart(32,"0");return s<=16?i(_B(r,e)):s<=128?i(wB(r,Mr,e)):s<=240?i(vB(r,Mr,e)):i(pB(r,Mr))}function Px(t){return/^[0-9a-f]{32}$/.test(t)}function ua(t,e,n=!0,r=!1){try{return t[e].get()}catch(s){if(s.name===en.unminifiable_name){if(r)return s;if(n)return null}throw s}}function Ri(t,e,n=!0){if(Array.isArray(e)){const r={};for(const s of e)try{r[s]=ua(t,s,!n)}catch(i){if(i.name===en.unminifiable_name)continue}return r}else return ua(t,e)}function*bB(t,e){if(t.graph===xt.PARENT)throw new dt("There is no parent graph.");if(t.goto){let n;Array.isArray(t.goto)?n=t.goto:n=[t.goto];for(const r of n)if(Xn(r))yield[ir,sr,r];else if(typeof r=="string")yield[ir,`branch:to:${r}`,"__start__"];else throw new Error(`In Command.send, expected Send or string, got ${typeof r}`)}if(t.resume)if(typeof t.resume=="object"&&Object.keys(t.resume).length&&Object.keys(t.resume).every(Px))for(const[n,r]of Object.entries(t.resume)){const s=e.filter(i=>i[0]===n&&i[1]===Rn).map(i=>i[2]).slice(0,1)??[];s.push(r),yield[n,Rn,s]}else yield[ir,Rn,t.resume];if(t.update){if(typeof t.update!="object"||!t.update)throw new Error("Expected cmd.update to be a dict mapping channel names to update values");if(Array.isArray(t.update))for(const[n,r]of t.update)yield[ir,n,r];else for(const[n,r]of Object.entries(t.update))yield[ir,n,r]}}function*Mx(t,e){if(e!=null)if(Array.isArray(t)&&typeof e=="object"&&!Array.isArray(e))for(const n in e)t.includes(n)&&(yield[n,e[n]]);else{if(Array.isArray(t))throw new Error('Input chunk must be an object when "inputChannels" is an array');yield[t,e]}}function*Th(t,e,n){Array.isArray(t)?(e===!0||e.find(([r,s])=>t.includes(r)))&&(yield Ri(n,t)):(e===!0||e.some(([r,s])=>r===t))&&(yield ua(n,t))}function*EB(t,e,n){const r=e.filter(([o,c])=>{var l;return(o.config===void 0||!((l=o.config.tags)!=null&&l.includes(Nt)))&&c[0][0]!==An&&c[0][0]!==He});if(!r.length)return;let s;r.some(([o])=>o.writes.some(([c,l])=>c===Sa))?s=r.flatMap(([o])=>o.writes.filter(([c,l])=>c===Sa).map(([c,l])=>[o.name,l])):Array.isArray(t)?s=r.flatMap(([o])=>{const{writes:c}=o,l={};for(const[u]of c)t.includes(u)&&(l[u]=(l[u]||0)+1);return Object.values(l).some(u=>u>1)?c.filter(([u])=>t.includes(u)).map(([u,d])=>[o.name,{[u]:d}]):[[o.name,Object.fromEntries(c.filter(([u])=>t.includes(u)))]]}):s=r.flatMap(([o])=>o.writes.filter(([c,l])=>c===t).map(([c,l])=>[o.name,l]));const i={};for(const[o,c]of s)o in i||(i[o]=[]),i[o].push(c);const a={};for(const o in i)if(i[o].length===1){const[c]=i[o];a[o]=c}else a[o]=i[o];n&&(a.__metadata__={cached:n}),yield a}function _g(t){const e=typeof t[et];if(e==="number")return 0;if(e==="string")return"";for(const n in t){if(!Object.prototype.hasOwnProperty.call(t,n))continue;const r=typeof t[n];if(r==="number")return 0;if(r==="string")return"";break}}function Cl(t,e){if(Object.keys(t).length>0){const n=_g(e);return Object.fromEntries(Object.entries(e).filter(([r,s])=>s>(t[r]??n)))}else return e}function TB(t,e){return t&&!Array.isArray(t)&&!(t instanceof Date)&&typeof t=="object"?t:{[e]:t}}function wr(t,e){return t===null?{configurable:e}:(t==null?void 0:t.configurable)===void 0?{...t,configurable:e}:{...t,configurable:{...t.configurable,...e}}}function ni(t,e){var r,s;const n=(e==null?void 0:e.parents)??{};return Object.keys(n).length>0?wr(t,{[rr]:{...n,[((r=t.configurable)==null?void 0:r.checkpoint_ns)??""]:(s=t.configurable)==null?void 0:s.checkpoint_id}}):t}function Su(...t){const e=[...new Set(t.filter(Boolean))];if(e.length===0)return{signal:void 0,dispose:void 0};if(e.length===1)return{signal:e[0],dispose:void 0};const n=new AbortController,r=()=>{var a;const i=(a=e.find(o=>o.aborted))==null?void 0:a.reason;n.abort(i),e.forEach(o=>o.removeEventListener("abort",r))};e.forEach(i=>i.addEventListener("abort",r,{once:!0}));const s=e.find(i=>i.aborted);return s&&n.abort(s.reason),{signal:n.signal,dispose:()=>{e.forEach(i=>i.removeEventListener("abort",r))}}}const SB=(t,e)=>{if(!(!t&&!e))return t?e?Array.isArray(t)&&Array.isArray(e)?[...t,...e]:Array.isArray(t)?[...t,e]:Array.isArray(e)?[t,...e]:[t,e]:t:e};var xB=class{constructor({func:t,name:e,input:n,retry:r,cache:s,callbacks:i}){p(this,"func");p(this,"name");p(this,"input");p(this,"retry");p(this,"cache");p(this,"callbacks");p(this,"__lg_type","call");this.func=t,this.name=e,this.input=n,this.retry=r,this.cache=s,this.callbacks=i}};function kB(t){return typeof t=="object"&&t!==null&&"__lg_type"in t&&t.__lg_type==="call"}function IB(t,e){const n=new Li({func:r=>e(...r),name:t,trace:!1,recurse:!1});return new Jn({name:t,first:n,last:new _n([{channel:Sa,value:xi}],[Nt])})}const AB=t=>t!==void 0?t+1:1;function CB(t,e){if(e==null)return!1;for(const n of t)if(e[n])return!0;return!1}function OB(t){let e;for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e==null?e=t[n]:e=NF(e,t[n]));return e}function el(t,e,n){const r=_g(t.channel_versions),s=t.versions_seen[He]??{};let i=!1;if((t.channel_versions[et]??r)>(s[et]??r))i=!0;else for(const o in t.channel_versions)if(Object.prototype.hasOwnProperty.call(t.channel_versions,o)&&t.channel_versions[o]>(s[o]??r)){i=!0;break}const a=n.some(o=>{var c,l;return e==="*"?!((l=(c=o.config)==null?void 0:c.tags)!=null&&l.includes(Nt)):e.includes(o.name)});return i&&a}function Ol(t,e,n,r,s=!1){let i=new Set;if(Array.isArray(r))i=new Set(r.filter(o=>n.writes.some(([c,l])=>c===o)));else{for(const[o]of n.writes)if(o===r){i=new Set([o]);break}i=i||new Set}let a;if(s&&i.size>0){const o=Object.fromEntries(Object.entries(e).filter(([u,d])=>i.has(u))),c=li(t,o,-1),l=vu(o,c);Fn(wu(c),l,[n],void 0,void 0),a=Ri({...e,...l},r)}else a=Ri(e,r);return a}function Sh(t,e,n){for(const[r,s]of n)if([Bn,sr].includes(r)&&s!=null){if(!Xn(s))throw new dt(`Invalid packet type, expected SendProtocol, got ${JSON.stringify(s)}`);if(!(s.node in e))throw new dt(`Invalid node name "${s.node}" in Send packet`)}t(n)}const $B=new Set([mg,Bn,Rn,He,Sa,An]);function Fn(t,e,n,r,s){var h,f;n.sort((m,g)=>{var y,v;const w=((y=m.path)==null?void 0:y.slice(0,3))||[],b=((v=g.path)==null?void 0:v.slice(0,3))||[];for(let T=0;T<Math.min(w.length,b.length);T+=1){if(w[T]<b[T])return-1;if(w[T]>b[T])return 1}return w.length-b.length});const i=n.some(m=>m.triggers.length>0),a=hg(e);for(const m of n){(h=t.versions_seen)[f=m.name]??(h[f]={});for(const g of m.triggers)g in t.channel_versions&&(t.versions_seen[m.name][g]=t.channel_versions[g])}let o=OB(t.channel_versions);const c=new Set(n.flatMap(m=>m.triggers).filter(m=>!WF.includes(m)));let l=!1;for(const m of c)m in a&&a[m].consume()&&r!==void 0&&(t.channel_versions[m]=r(o),l=!0);const u={};for(const m of n)for(const[g,w]of m.writes)$B.has(g)||g in a&&(u[g]??(u[g]=[]),u[g].push(w));o!=null&&r!=null&&(o=l?r(o):o);const d=new Set;for(const[m,g]of Object.entries(u))if(m in a){const w=a[m];let b;try{b=w.update(g)}catch(y){if(y.name===dt.unminifiable_name){const v=new dt(`Invalid update for channel "${m}" with values ${JSON.stringify(g)}: ${y.message}`);throw v.lc_error_code=y.lc_error_code,v}else throw y}b&&r!==void 0&&(t.channel_versions[m]=r(o),w.isAvailable()&&d.add(m))}if(i)for(const m in a){if(!Object.prototype.hasOwnProperty.call(a,m))continue;const g=a[m];g.isAvailable()&&!d.has(m)&&g.update([])&&r!==void 0&&(t.channel_versions[m]=r(o),g.isAvailable()&&d.add(m))}if(i&&!CB(d,s))for(const m in a){if(!Object.prototype.hasOwnProperty.call(a,m))continue;const g=a[m];g.finish()&&r!==void 0&&(t.channel_versions[m]=r(o),g.isAvailable()&&d.add(m))}return d}function*RB(t,e,n){if(n.updatedChannels!=null&&n.triggerToNodes!=null){const s=new Set;for(const i of n.updatedChannels){const a=n.triggerToNodes[i];for(const o of a??[])s.add(o)}yield*[...s].sort();return}if(!(()=>{for(const s in t.channel_versions)if(t.channel_versions[s]!==null)return!1;return!0})())for(const s in e)Object.prototype.hasOwnProperty.call(e,s)&&(yield s)}function ia(t,e,n,r,s,i,a){const o={},c=r[sr];if(c!=null&&c.isAvailable()){const l=c.get().length;for(let u=0;u<l;u+=1){const d=op([Bn,u],t,e,n,r,s,i,a);d!==void 0&&(o[d.id]=d)}}for(const l of RB(t,n,a)){const u=op([kl,l],t,e,n,r,s,i,a);u!==void 0&&(o[u.id]=u)}return o}function op(t,e,n,r,s,i,a,o){var f,m,g,w;const{step:c,checkpointer:l,manager:u}=o,d=i.configurable??{},h=d.checkpoint_ns??"";if(t[0]===Bn&&kB(t[t.length-1])){const b=t[t.length-1],y=IB(b.name,b.func),v=[Bn],T=h===""?b.name:`${h}${Ut}${b.name}`,A=na(JSON.stringify([T,c.toString(),b.name,Bn,t[1],t[2]]),e.id),I=`${T}${ds}${A}`,$=[...t.slice(0,3),!0],S={langgraph_step:c,langgraph_node:b.name,langgraph_triggers:v,langgraph_path:$,langgraph_checkpoint_ns:I};if(a){const M=[];return{name:b.name,input:b.input,proc:y,writes:M,config:Xe(Zn(i,{metadata:S,store:o.store??i.store}),{runName:b.name,callbacks:u==null?void 0:u.getChild(`graph:step:${c}`),configurable:{[mo]:A,[Gs]:P=>Sh(W=>M.push(...W),r,P),[Si]:(P,W=!1)=>Ol(e,s,{name:b.name,writes:M,triggers:v,path:$},P,W),[$t]:l??d[$t],[rr]:{...d[rr],[h]:e.id},[Ws]:xh({pendingWrites:n??[],taskId:A,currentTaskInput:b.input,resumeMap:(f=i.configurable)==null?void 0:f[Sl],namespaceHash:oi(I)}),[xl]:e.channel_values[wh],checkpoint_id:void 0,checkpoint_ns:I}}),triggers:v,retry_policy:b.retry,cache_key:b.cache?{key:oi((b.cache.keyFunc??JSON.stringify)([b.input])),ns:[_h,b.name??"__dynamic__"],ttl:b.cache.ttl}:void 0,id:A,path:$,writers:[]}}else return{id:A,name:b.name,interrupts:[],path:$}}else if(t[0]===Bn){const b=typeof t[1]=="number"?t[1]:parseInt(t[1],10);if(!((m=s[sr])!=null&&m.isAvailable()))return;const y=s[sr].get();if(b<0||b>=y.length)return;const v=rp(y[b])&&!Xn(y[b])?new yn(y[b].node,y[b].args):y[b];if(!rp(v)){console.warn(`Ignoring invalid packet ${JSON.stringify(v)} in pending sends.`);return}if(!(v.node in r)){console.warn(`Ignoring unknown node name ${v.node} in pending sends.`);return}const T=[Bn],A=h===""?v.node:`${h}${Ut}${v.node}`,I=na(JSON.stringify([A,c.toString(),v.node,Bn,b.toString()]),e.id),$=`${A}${ds}${I}`;let S={langgraph_step:c,langgraph_node:v.node,langgraph_triggers:T,langgraph_path:t.slice(0,3),langgraph_checkpoint_ns:$};if(a){const M=r[v.node],j=M.getNode();if(j!==void 0){M.metadata!==void 0&&(S={...S,...M.metadata});const P=[];return{name:v.node,input:v.args,proc:j,subgraphs:M.subgraphs,writes:P,config:Xe(Zn(i,{metadata:S,tags:M.tags,store:o.store??i.store}),{runName:v.node,callbacks:u==null?void 0:u.getChild(`graph:step:${c}`),configurable:{[mo]:I,[Gs]:W=>Sh(ne=>P.push(...ne),r,W),[Si]:(W,ne=!1)=>Ol(e,s,{name:v.node,writes:P,triggers:T,path:t},W,ne),[$t]:l??d[$t],[rr]:{...d[rr],[h]:e.id},[Ws]:xh({pendingWrites:n??[],taskId:I,currentTaskInput:v.args,resumeMap:(g=i.configurable)==null?void 0:g[Sl],namespaceHash:oi($)}),[xl]:e.channel_values[wh],checkpoint_id:void 0,checkpoint_ns:$}}),triggers:T,retry_policy:M.retryPolicy,cache_key:M.cachePolicy?{key:oi((M.cachePolicy.keyFunc??JSON.stringify)([v.args])),ns:[_h,M.name??"__dynamic__",v.node],ttl:M.cachePolicy.ttl}:void 0,id:I,path:t,writers:M.getWriters()}}}else return{id:I,name:v.node,interrupts:[],path:t}}else if(t[0]===kl){const b=t[1].toString(),y=r[b];if(y===void 0)return;if(n!=null&&n.length){const I=h===""?b:`${h}${Ut}${b}`,$=na(JSON.stringify([I,c.toString(),b,kl,b]),e.id);if(n.some(M=>M[0]===$&&M[1]!==An))return}const v=_g(e.channel_versions);if(v===void 0)return;const T=e.versions_seen[b]??{},A=y.triggers.find(I=>s[I].isAvailable()?(e.channel_versions[I]??v)>(T[I]??v):!1);if(A!==void 0){const I=NB(y,s,a);if(I===void 0)return;const $=h===""?b:`${h}${Ut}${b}`,S=na(JSON.stringify([$,c.toString(),b,kl,[A]]),e.id),M=`${$}${ds}${S}`;let j={langgraph_step:c,langgraph_node:b,langgraph_triggers:[A],langgraph_path:t,langgraph_checkpoint_ns:M};if(a){const P=y.getNode();if(P!==void 0){y.metadata!==void 0&&(j={...j,...y.metadata});const W=[];return{name:b,input:I,proc:P,subgraphs:y.subgraphs,writes:W,config:Xe(Zn(i,{metadata:j,tags:y.tags,store:o.store??i.store}),{runName:b,callbacks:u==null?void 0:u.getChild(`graph:step:${c}`),configurable:{[mo]:S,[Gs]:ne=>Sh(B=>{W.push(...B)},r,ne),[Si]:(ne,B=!1)=>Ol(e,s,{name:b,writes:W,triggers:[A],path:t},ne,B),[$t]:l??d[$t],[rr]:{...d[rr],[h]:e.id},[Ws]:xh({pendingWrites:n??[],taskId:S,currentTaskInput:I,resumeMap:(w=i.configurable)==null?void 0:w[Sl],namespaceHash:oi(M)}),[xl]:e.channel_values[wh],checkpoint_id:void 0,checkpoint_ns:M}}),triggers:[A],retry_policy:y.retryPolicy,cache_key:y.cachePolicy?{key:oi((y.cachePolicy.keyFunc??JSON.stringify)([I])),ns:[_h,y.name??"__dynamic__",b],ttl:y.cachePolicy.ttl}:void 0,id:S,path:t,writers:y.getWriters()}}}else return{id:S,name:b,interrupts:[],path:t}}}}function NB(t,e,n){let r;if(typeof t.channels=="object"&&!Array.isArray(t.channels)){r={};for(const[s,i]of Object.entries(t.channels))if(t.triggers.includes(i))try{r[s]=ua(e,i,!1)}catch(a){if(a.name===en.unminifiable_name)return;throw a}else if(i in e)try{r[s]=ua(e,i,!1)}catch(a){if(a.name===en.unminifiable_name)continue;throw a}}else if(Array.isArray(t.channels)){let s=!1;for(const i of t.channels)try{r=ua(e,i,!1),s=!0;break}catch(a){if(a.name===en.unminifiable_name)continue;throw a}if(!s)return}else throw new Error(`Invalid channels type, expected list or dict, got ${t.channels}`);return n&&t.mapper!==void 0&&(r=t.mapper(r)),r}function xh({pendingWrites:t,taskId:e,currentTaskInput:n,resumeMap:r,namespaceHash:s}){var c;const i=(c=t.find(([l,u])=>l===ir&&u===Rn))==null?void 0:c[2],o={callCounter:0,interruptCounter:-1,resume:(()=>{const l=t.filter(([u,d])=>u===e&&d===Rn).flatMap(([u,d,h])=>h);if(r!=null&&s in r){const u=r[s];l.push(u)}return l})(),nullResume:i,subgraphCounter:0,currentTaskInput:n,consumeNullResume:()=>{if(o.nullResume)return delete o.nullResume,t.splice(t.findIndex(([l,u])=>l===ir&&u===Rn),1),i}};return o}const zo={blue:{start:"\x1B[34m",end:"\x1B[0m"},green:{start:"\x1B[32m",end:"\x1B[0m"},yellow:{start:"\x1B[33;1m",end:"\x1B[0m"}},Zo=(t,e)=>`${t.start}${e}${t.end}`;function*iw(t){var e;for(const{id:n,name:r,input:s,config:i,triggers:a,writes:o}of t){if((e=i==null?void 0:i.tags)!=null&&e.includes(Nt))continue;const c=o.filter(([l,u])=>l===n&&u===He).map(([,l])=>l);yield{id:n,name:r,input:s,triggers:a,interrupts:c}}}function PB(t){return typeof t!="object"||t===null?!1:"$writes"in t&&Array.isArray(t.$writes)}function Lx(t){const e={};for(const[n,r]of t){const s=String(n);if(s in e){const i=PB(e[s])?e[s].$writes:[e[s]];i.push(r),e[s]={$writes:i}}else e[s]=r}return e}function*MB(t,e){var n;for(const[{id:r,name:s,config:i},a]of t)(n=i==null?void 0:i.tags)!=null&&n.includes(Nt)||(yield{id:r,name:s,result:Lx(a.filter(([o])=>Array.isArray(e)?e.includes(o):o===e)),interrupts:a.filter(o=>o[0]===He).map(o=>o[1])})}function*LB(t,e,n,r,s,i,a,o){var d,h,f;function c(m){const g={};return m.callbacks!=null&&(g.callbacks=m.callbacks),m.configurable!=null&&(g.configurable=m.configurable),m.maxConcurrency!=null&&(g.max_concurrency=m.maxConcurrency),m.metadata!=null&&(g.metadata=m.metadata),m.recursionLimit!=null&&(g.recursion_limit=m.recursionLimit),m.runId!=null&&(g.run_id=m.runId),m.runName!=null&&(g.run_name=m.runName),m.tags!=null&&(g.tags=m.tags),g}const l=(d=t.configurable)==null?void 0:d.checkpoint_ns,u={};for(const m of s){if(!((h=m.subgraphs)!=null&&h.length?m.subgraphs:[m.proc]).find(Ix))continue;let w=`${m.name}:${m.id}`;l&&(w=`${l}|${w}`),u[m.id]={configurable:{thread_id:(f=t.configurable)==null?void 0:f.thread_id,checkpoint_ns:w}}}yield{config:c(t),values:Ri(e,n),metadata:r,next:s.map(m=>m.name),tasks:jx(s,i,u,o),parentConfig:a?c(a):void 0}}function jx(t,e,n,r){return t.map(s=>{var l;const i=(l=e.find(([u,d])=>u===s.id&&d===An))==null?void 0:l[2],a=e.filter(([u,d])=>u===s.id&&d===He).map(([,,u])=>u),o=(()=>{var d;if(i||a.length||!e.length)return;const u=e.findIndex(([h,f])=>h===s.id&&f===Sa);if(u>=0)return e[u][2];if(typeof r=="string")return(d=e.find(([h,f])=>h===s.id&&f===r))==null?void 0:d[2];if(Array.isArray(r)){const h=e.filter(([f,m])=>f===s.id&&r.includes(m)).map(([,f,m])=>[f,m]);return h.length?Lx(h):void 0}})();if(i)return{id:s.id,name:s.name,path:s.path,error:i,interrupts:a,result:o};const c=n==null?void 0:n[s.id];return{id:s.id,name:s.name,path:s.path,interrupts:a,...c!==void 0?{state:c}:{},result:o}})}function jB(t,e,n){console.log([`${Zo(zo.blue,`[${t}:checkpoint]`)}`,`\x1B[1m State at the end of step ${t}:\x1B[0m
`,JSON.stringify(Ri(e,n),null,2)].join(""))}function Dx(t,e){const n=e.length;console.log([`${Zo(zo.blue,`[${t}:tasks]`)}`,`\x1B[1m Starting step ${t} with ${n} task${n===1?"":"s"}:\x1B[0m
`,e.map(r=>`- ${Zo(zo.green,String(r.name))} -> ${JSON.stringify(r.input,null,2)}`).join(`
`)].join(""))}function DB(t,e,n){const r={};for(const[s,i]of e)n.includes(s)&&(r[s]||(r[s]=[]),r[s].push(i));console.log([`${Zo(zo.blue,`[${t}:writes]`)}`,`\x1B[1m Finished step ${t} with writes to ${Object.keys(r).length} channel${Object.keys(r).length!==1?"s":""}:\x1B[0m
`,Object.entries(r).map(([s,i])=>`- ${Zo(zo.yellow,s)} -> ${i.map(a=>JSON.stringify(a)).join(", ")}`).join(`
`)].join(""))}var aw=class extends hn{constructor(e,n){const r=e.getReader(),s=n??new AbortController;super({start(i){return a();function a(){return r.read().then(({done:o,value:c})=>{if(o){i.close();return}return i.enqueue(c),a()})}}});p(this,"_abortController");p(this,"_innerReader");this._abortController=s,this._innerReader=r}async cancel(e){this._abortController.abort(e),this._innerReader.releaseLock()}get signal(){return this._abortController.signal}},Ux=class extends hn{constructor(e){let n;const r=new Promise(s=>{n=s});super({start:s=>{n(s)}});p(this,"modes");p(this,"controller");p(this,"passthroughFn");p(this,"_closed",!1);r.then(s=>{this.controller=s}),this.passthroughFn=e.passthroughFn,this.modes=e.modes}get closed(){return this._closed}push(e){var n;(n=this.passthroughFn)==null||n.call(this,e),this.controller.enqueue(e)}close(){try{this.controller.close()}catch{}finally{this._closed=!0}}error(e){this.controller.error(e)}};function UB(t){return JSON.stringify(t,function(e,n){const r=this[e];if(r!=null&&typeof r=="object"&&"toDict"in r&&typeof r.toDict=="function"){const{type:s,data:i}=r.toDict();return{...i,type:s}}return n})}function FB(t){return t instanceof Error?{error:t.name,message:t.message}:{error:"Error",message:JSON.stringify(t)}}function wg(t){return typeof t!="object"||t==null?!1:"configurable"in t&&typeof t.configurable=="object"&&t.configurable!=null}function kh(t){return!wg(t)||!t.configurable.thread_id?null:{thread_id:t.configurable.thread_id,checkpoint_ns:t.configurable.checkpoint_ns||"",checkpoint_id:t.configurable.checkpoint_id||null,checkpoint_map:t.configurable.checkpoint_map||null}}function ow(t){if(wg(t)){const e=Object.fromEntries(Object.entries(t.configurable).filter(([r])=>!r.startsWith("__"))),n={...t,configurable:e};return delete n.callbacks,n}return t}function cw(t){const e={...t,checkpoint:kh(t.config),parent_checkpoint:kh(t.parentConfig),config:ow(t.config),parent_config:ow(t.parentConfig),tasks:t.tasks.map(n=>{if(wg(n.state)){const r=kh(n.state);if(r!=null){const s={...n,checkpoint:r};return delete s.state,s}}return n})};return delete e.parentConfig,e}function BB(t){const e=new TextEncoder;return new ReadableStream({async start(n){const r=s=>{n.enqueue(e.encode(`event: ${s.event}
data: ${UB(s.data)}

`))};try{for await(const s of t){const[i,a,o]=s;let c=o;if(a==="debug"){const u=o;u.type==="checkpoint"&&(c={...u,payload:cw(u.payload)})}a==="checkpoints"&&(c=cw(o));const l=i!=null&&i.length?`${a}|${i.join("|")}`:a;r({event:l,data:c})}}catch(s){r({event:"error",data:FB(s)})}n.close()}})}const tl=Symbol.for("INPUT_DONE"),Ih=Symbol.for("INPUT_RESUMING"),zB=25;function ZB(...t){return new Ux({passthroughFn:e=>{for(const n of t)n.modes.has(e[1])&&n.push(e)},modes:new Set(t.flatMap(e=>Array.from(e.modes)))})}var VB=class extends UF{constructor(e){super();p(this,"cache");p(this,"queue",Promise.resolve());this.cache=e}async get(e){return this.enqueueOperation("get",e)}async set(e){return this.enqueueOperation("set",e)}async clear(e){return this.enqueueOperation("clear",e)}async stop(){await this.queue}enqueueOperation(e,...n){const r=this.queue.then(()=>this.cache[e](...n));return this.queue=r.then(()=>{},()=>{}),r}},GB=class Fx{constructor(e){p(this,"input");p(this,"output");p(this,"config");p(this,"checkpointer");p(this,"checkpointerGetNextVersion");p(this,"channels");p(this,"checkpoint");p(this,"checkpointIdSaved");p(this,"checkpointConfig");p(this,"checkpointMetadata");p(this,"checkpointNamespace");p(this,"checkpointPendingWrites",[]);p(this,"checkpointPreviousVersions");p(this,"step");p(this,"stop");p(this,"durability");p(this,"outputKeys");p(this,"streamKeys");p(this,"nodes");p(this,"skipDoneTasks");p(this,"prevCheckpointConfig");p(this,"updatedChannels");p(this,"status","pending");p(this,"tasks",{});p(this,"stream");p(this,"checkpointerPromises",[]);p(this,"isNested");p(this,"_checkpointerChainedPromise",Promise.resolve());p(this,"store");p(this,"cache");p(this,"manager");p(this,"interruptAfter");p(this,"interruptBefore");p(this,"toInterrupt",[]);p(this,"debug",!1);p(this,"triggerToNodes");this.input=e.input,this.checkpointer=e.checkpointer,this.checkpointer!==void 0?this.checkpointerGetNextVersion=this.checkpointer.getNextVersion.bind(this.checkpointer):this.checkpointerGetNextVersion=AB,this.checkpoint=e.checkpoint,this.checkpointMetadata=e.checkpointMetadata,this.checkpointPreviousVersions=e.checkpointPreviousVersions,this.channels=e.channels,this.checkpointPendingWrites=e.checkpointPendingWrites,this.step=e.step,this.stop=e.stop,this.config=e.config,this.checkpointConfig=e.checkpointConfig,this.isNested=e.isNested,this.manager=e.manager,this.outputKeys=e.outputKeys,this.streamKeys=e.streamKeys,this.nodes=e.nodes,this.skipDoneTasks=e.skipDoneTasks,this.store=e.store,this.cache=e.cache?new VB(e.cache):void 0,this.stream=e.stream,this.checkpointNamespace=e.checkpointNamespace,this.prevCheckpointConfig=e.prevCheckpointConfig,this.interruptAfter=e.interruptAfter,this.interruptBefore=e.interruptBefore,this.durability=e.durability,this.debug=e.debug,this.triggerToNodes=e.triggerToNodes}get isResuming(){var c,l,u,d,h;let e=!1;if(et in this.checkpoint.channel_versions)e=!0;else for(const f in this.checkpoint.channel_versions)if(Object.prototype.hasOwnProperty.call(this.checkpoint.channel_versions,f)){e=!0;break}const r=((c=this.config.configurable)==null?void 0:c[$s])!==void 0&&((l=this.config.configurable)==null?void 0:l[$s]),s=this.input===null||this.input===void 0,i=Gt(this.input)&&this.input.resume!=null,a=this.input===Ih,o=!this.isNested&&((u=this.config.metadata)==null?void 0:u.run_id)!==void 0&&((d=this.checkpointMetadata)==null?void 0:d.run_id)!==void 0&&this.config.metadata.run_id===((h=this.checkpointMetadata)==null?void 0:h.run_id);return e&&(r||s||i||a||o)}static async initialize(e){var v,T,A,I,$,S,M,j,P,W,ne,B;let{config:n,stream:r}=e;r!==void 0&&((v=n.configurable)==null?void 0:v[bu])!==void 0&&(r=ZB(r,n.configurable[bu]));const s=n.configurable?!("checkpoint_id"in n.configurable):!0,i=(T=n.configurable)==null?void 0:T[Ws];n.configurable&&i&&(i.subgraphCounter>0&&(n=wr(n,{[Dr]:[n.configurable[Dr],i.subgraphCounter.toString()].join(Ut)})),i.subgraphCounter+=1);const a=Si in(n.configurable??{});!a&&((A=n.configurable)==null?void 0:A.checkpoint_ns)!==void 0&&((I=n.configurable)==null?void 0:I.checkpoint_ns)!==""&&(n=wr(n,{checkpoint_ns:"",checkpoint_id:void 0}));let o=n;(($=n.configurable)==null?void 0:$[rr])!==void 0&&((j=(S=n.configurable)==null?void 0:S[rr])!=null&&j[(M=n.configurable)==null?void 0:M.checkpoint_ns])&&(o=wr(n,{checkpoint_id:n.configurable[rr][(P=n.configurable)==null?void 0:P.checkpoint_ns]}));const c=((ne=(W=n.configurable)==null?void 0:W.checkpoint_ns)==null?void 0:ne.split(Ut))??[],l=await((B=e.checkpointer)==null?void 0:B.getTuple(o))??{config:n,checkpoint:yx(),metadata:{source:"input",step:-2,parents:{}},pendingWrites:[]};o={...n,...l.config,configurable:{checkpoint_ns:"",...n.configurable,...l.config.configurable}};const u=l.parentConfig,d=wu(l.checkpoint),h={...l.metadata},f=l.pendingWrites??[],m=vu(e.channelSpecs,d),g=(h.step??0)+1,w=g+(n.recursionLimit??zB)+1,b={...d.channel_versions},y=e.store?new DF(e.store):void 0;return y&&await y.start(),new Fx({input:e.input,config:n,checkpointer:e.checkpointer,checkpoint:d,checkpointMetadata:h,checkpointConfig:o,prevCheckpointConfig:u,checkpointNamespace:c,channels:m,isNested:a,manager:e.manager,skipDoneTasks:s,step:g,stop:w,checkpointPreviousVersions:b,checkpointPendingWrites:f,outputKeys:e.outputKeys??[],streamKeys:e.streamKeys??[],nodes:e.nodes,stream:r,store:y,cache:e.cache,interruptAfter:e.interruptAfter,interruptBefore:e.interruptBefore,durability:e.durability,debug:e.debug,triggerToNodes:e.triggerToNodes})}_checkpointerPutAfterPrevious(e){this._checkpointerChainedPromise=this._checkpointerChainedPromise.then(()=>{var n;return(n=this.checkpointer)==null?void 0:n.put(e.config,e.checkpoint,e.metadata,e.newVersions)}),this.checkpointerPromises.push(this._checkpointerChainedPromise)}putWrites(e,n){var a;let r=n;if(r.length===0)return;r.every(([o])=>o in PF)&&(r=Array.from(new Map(r.map(o=>[o[0],o])).values())),this.checkpointPendingWrites=this.checkpointPendingWrites.filter(o=>o[0]!==e);for(const[o,c]of r)this.checkpointPendingWrites.push([e,o,c]);const s=wr(this.checkpointConfig,{[Dr]:((a=this.config.configurable)==null?void 0:a.checkpoint_ns)??"",[np]:this.checkpoint.id});if(this.durability!=="exit"&&this.checkpointer!=null&&this.checkpointerPromises.push(this.checkpointer.putWrites(s,r,e)),this.tasks&&this._outputWrites(e,r),!n.length||!this.cache||!this.tasks)return;const i=this.tasks[e];i==null||i.cache_key==null||n[0][0]===An||n[0][0]===He||this.cache.set([{key:[i.cache_key.ns,i.cache_key.key],value:i.writes,ttl:i.cache_key.ttl}])}_outputWrites(e,n,r=!1){var i,a;const s=this.tasks[e];if(s!==void 0){if(s.config!==void 0&&(s.config.tags??[]).includes(Nt))return;if(n.length>0)if(n[0][0]===He){if(((i=s.path)==null?void 0:i[0])===Bn&&((a=s.path)==null?void 0:a.at(-1))===!0)return;const o=n.filter(c=>c[0]===He).flatMap(c=>c[1]);this._emit([["updates",{[He]:o}],["values",{[He]:o}]])}else n[0][0]!==An&&this._emit(no(As(EB(this.outputKeys,[[s,n]],r),"updates")));r||this._emit(no(As(MB([[s,n]],this.streamKeys),"tasks")))}}async _matchCachedWrites(){if(!this.cache)return[];const e=[],n=([a,o])=>`ns:${a.join(",")}|key:${o}`,r=[],s={};for(const a of Object.values(this.tasks))a.cache_key!=null&&!a.writes.length&&(r.push([a.cache_key.ns,a.cache_key.key]),s[n([a.cache_key.ns,a.cache_key.key])]=a);if(r.length===0)return[];const i=await this.cache.get(r);for(const{key:a,value:o}of i){const c=s[n(a)];c!=null&&(c.writes.push(...o),e.push({task:c,result:o}))}return e}async tick(e){var i,a,o;this.store&&!this.store.isRunning&&await((i=this.store)==null?void 0:i.start());const{inputKeys:n=[]}=e;if(this.status!=="pending")throw new Error(`Cannot tick when status is no longer "pending". Current status: "${this.status}"`);if(![tl,Ih].includes(this.input))await this._first(n);else{if(this.toInterrupt.length>0)throw this.status="interrupt_before",new ca;if(Object.values(this.tasks).every(c=>c.writes.length>0)){const c=Object.values(this.tasks).flatMap(u=>u.writes);this.updatedChannels=Fn(this.checkpoint,this.channels,Object.values(this.tasks),this.checkpointerGetNextVersion,this.triggerToNodes);const l=await Ns(As(Th(this.outputKeys,c,this.channels),"values"));if(this._emit(l),this.checkpointPendingWrites=[],await this._putCheckpoint({source:"loop"}),el(this.checkpoint,this.interruptAfter,Object.values(this.tasks)))throw this.status="interrupt_after",new ca;((a=this.config.configurable)==null?void 0:a[$s])!==void 0&&((o=this.config.configurable)==null||delete o[$s])}else return!1}if(this.step>this.stop)return this.status="out_of_steps",!1;const r=ia(this.checkpoint,this.checkpointPendingWrites,this.nodes,this.channels,this.config,!0,{step:this.step,checkpointer:this.checkpointer,isResuming:this.isResuming,manager:this.manager,store:this.store,stream:this.stream,triggerToNodes:this.triggerToNodes,updatedChannels:this.updatedChannels});if(this.tasks=r,this.checkpointer&&this._emit(await Ns(As(LB(this.checkpointConfig,this.channels,this.streamKeys,this.checkpointMetadata,Object.values(this.tasks),this.checkpointPendingWrites,this.prevCheckpointConfig,this.outputKeys),"checkpoints"))),Object.values(this.tasks).length===0)return this.status="done",!1;if(this.skipDoneTasks&&this.checkpointPendingWrites.length>0){for(const[c,l,u]of this.checkpointPendingWrites){if(l===An||l===He||l===Rn)continue;const d=Object.values(this.tasks).find(h=>h.id===c);d&&d.writes.push([l,u])}for(const c of Object.values(this.tasks))c.writes.length>0&&this._outputWrites(c.id,c.writes,!0)}if(Object.values(this.tasks).every(c=>c.writes.length>0))return this.tick({inputKeys:n});if(el(this.checkpoint,this.interruptBefore,Object.values(this.tasks)))throw this.status="interrupt_before",new ca;const s=await Ns(As(iw(Object.values(this.tasks)),"tasks"));return this._emit(s),!0}async finishAndHandleError(e){this.durability==="exit"&&(!this.isNested||typeof e<"u"||this.checkpointNamespace.every(r=>!r.includes(ds)))&&(this._putCheckpoint(this.checkpointMetadata),this._flushPendingWrites());const n=this._suppressInterrupt(e);return(n||e===void 0)&&(this.output=Ri(this.channels,this.outputKeys)),n&&(this.tasks!==void 0&&this.checkpointPendingWrites.length>0&&Object.values(this.tasks).some(r=>r.writes.length>0)&&(this.updatedChannels=Fn(this.checkpoint,this.channels,Object.values(this.tasks),this.checkpointerGetNextVersion,this.triggerToNodes),this._emit(no(As(Th(this.outputKeys,Object.values(this.tasks).flatMap(r=>r.writes),this.channels),"values")))),mi(e)&&!e.interrupts.length&&this._emit([["updates",{[He]:[]}],["values",{[He]:[]}]])),n}async acceptPush(e,n,r){var a,o;if(((a=this.interruptAfter)==null?void 0:a.length)>0&&el(this.checkpoint,this.interruptAfter,[e])){this.toInterrupt.push(e);return}const s=op([Bn,e.path??[],n,e.id,r],this.checkpoint,this.checkpointPendingWrites,this.nodes,this.channels,e.config??{},!0,{step:this.step,checkpointer:this.checkpointer,manager:this.manager,store:this.store,stream:this.stream});if(!s)return;if(((o=this.interruptBefore)==null?void 0:o.length)>0&&el(this.checkpoint,this.interruptBefore,[s])){this.toInterrupt.push(s);return}this._emit(no(As(iw([s]),"tasks"))),this.debug&&Dx(this.step,[s]),this.tasks[s.id]=s,this.skipDoneTasks&&this._matchWrites({[s.id]:s});const i=await this._matchCachedWrites();for(const{task:c}of i)this._outputWrites(c.id,c.writes,!0);return s}_suppressInterrupt(e){return mi(e)&&!this.isNested}async _first(e){var a;const{configurable:n}=this.config,r=n==null?void 0:n[Ws];if(r&&r.nullResume!==void 0&&this.putWrites(ir,[[Rn,r.nullResume]]),Gt(this.input)){const o=this.input.resume!=null;if(this.input.resume!=null&&typeof this.input.resume=="object"&&Object.keys(this.input.resume).every(Px)&&((a=this.config).configurable??(a.configurable={}),this.config.configurable[Sl]=this.input.resume),o&&this.checkpointer==null)throw new Error("Cannot use Command(resume=...) without checkpointer");const c={};for(const[l,u,d]of bB(this.input,this.checkpointPendingWrites))c[l]??(c[l]=[]),c[l].push([u,d]);if(Object.keys(c).length===0)throw new K_("Received empty Command input");for(const[l,u]of Object.entries(c))this.putWrites(l,u)}const s=(this.checkpointPendingWrites??[]).filter(o=>o[0]===ir).map(o=>o.slice(1));s.length>0&&Fn(this.checkpoint,this.channels,[{name:ns,writes:s,triggers:[]}],this.checkpointerGetNextVersion,this.triggerToNodes);const i=Gt(this.input)&&s.length>0;if(this.isResuming||i){for(const c in this.channels)if(Object.prototype.hasOwnProperty.call(this.channels,c)&&this.checkpoint.channel_versions[c]!==void 0){const l=this.checkpoint.channel_versions[c];this.checkpoint.versions_seen[He]={...this.checkpoint.versions_seen[He],[c]:l}}const o=await Ns(As(Th(this.outputKeys,!0,this.channels),"values"));this._emit(o)}if(this.isResuming)this.input=Ih;else if(i)await this._putCheckpoint({source:"input"}),this.input=tl;else{const o=await Ns(Mx(e,this.input));if(o.length>0){const c=ia(this.checkpoint,this.checkpointPendingWrites,this.nodes,this.channels,this.config,!0,{step:this.step});this.updatedChannels=Fn(this.checkpoint,this.channels,Object.values(c).concat([{name:ns,writes:o,triggers:[]}]),this.checkpointerGetNextVersion,this.triggerToNodes),await this._putCheckpoint({source:"input"}),this.input=tl}else if($s in(this.config.configurable??{}))this.input=tl;else throw new K_(`Received no input writes for ${JSON.stringify(e,null,2)}`)}this.isNested||(this.config=wr(this.config,{[$s]:this.isResuming}))}_emit(e){for(const[n,r]of e)if(this.stream.modes.has(n)&&this.stream.push([this.checkpointNamespace,n,r]),(n==="checkpoints"||n==="tasks")&&this.stream.modes.has("debug")){const s=n==="checkpoints"?this.step-1:this.step,i=new Date().toISOString(),a=n==="checkpoints"?"checkpoint":typeof r=="object"&&r!=null&&"result"in r?"task_result":"task";this.stream.push([this.checkpointNamespace,"debug",{step:s,type:a,timestamp:i,payload:r}])}}_putCheckpoint(e){var i;const n=this.checkpointMetadata===e,r=this.checkpointer!=null&&(this.durability!=="exit"||n),s=a=>{var l,u,d;this.prevCheckpointConfig=(u=(l=this.checkpointConfig)==null?void 0:l.configurable)!=null&&u.checkpoint_id?this.checkpointConfig:void 0,this.checkpointConfig=wr(this.checkpointConfig,{[Dr]:((d=this.config.configurable)==null?void 0:d.checkpoint_ns)??""});const o={...this.checkpoint.channel_versions},c=Cl(this.checkpointPreviousVersions,o);this.checkpointPreviousVersions=o,this._checkpointerPutAfterPrevious({config:{...this.checkpointConfig},checkpoint:wu(a),metadata:{...this.checkpointMetadata},newVersions:c}),this.checkpointConfig={...this.checkpointConfig,configurable:{...this.checkpointConfig.configurable,checkpoint_id:this.checkpoint.id}}};n||(this.checkpointMetadata={...e,step:this.step,parents:((i=this.config.configurable)==null?void 0:i[rr])??{}}),this.checkpoint=li(this.checkpoint,r?this.channels:void 0,this.step,n?{id:this.checkpoint.id}:void 0),r&&s(this.checkpoint),n||(this.step+=1)}_flushPendingWrites(){var r;if(this.checkpointer==null||this.checkpointPendingWrites.length===0)return;const e=wr(this.checkpointConfig,{[Dr]:((r=this.config.configurable)==null?void 0:r.checkpoint_ns)??"",[np]:this.checkpoint.id}),n={};for(const[s,i,a]of this.checkpointPendingWrites)n[s]??(n[s]=[]),n[s].push([i,a]);for(const[s,i]of Object.entries(n))this.checkpointerPromises.push(this.checkpointer.putWrites(e,i,s))}_matchWrites(e){for(const[n,r,s]of this.checkpointPendingWrites){if(r===An||r===He||r===Rn)continue;const i=Object.values(e).find(a=>a.id===n);i&&i.writes.push([r,s])}for(const n of Object.values(e))n.writes.length>0&&this._outputWrites(n.id,n.writes,!0)}};function WB(t){return Yt(t==null?void 0:t.message)}var HB=class extends $a{constructor(e){super();p(this,"name","StreamMessagesHandler");p(this,"streamFn");p(this,"metadatas",{});p(this,"seen",{});p(this,"emittedChatModelRunIds",{});p(this,"stableMessageIdMap",{});p(this,"lc_prefer_streaming",!0);this.streamFn=e}_emit(e,n,r,s=!1){var a;if(s&&n.id!==void 0&&this.seen[n.id]!==void 0)return;let i=n.id;r!=null&&($p(n)?i??(i=`run-${r}-tool-${n.tool_call_id}`):((i==null||i===`run-${r}`)&&(i=this.stableMessageIdMap[r]??i??`run-${r}`),(a=this.stableMessageIdMap)[r]??(a[r]=i))),i!==n.id&&(n.id=i,n.lc_kwargs.id=i),n.id!=null&&(this.seen[n.id]=n),this.streamFn([e[0],"messages",[n,e[1]]])}handleChatModelStart(e,n,r,s,i,a,o,c){o&&(!a||!a.includes(GF)&&!a.includes("nostream"))&&(this.metadatas[r]=[o.langgraph_checkpoint_ns.split("|"),{tags:a,name:c,...o}])}handleLLMNewToken(e,n,r,s,i,a){const o=a==null?void 0:a.chunk;this.emittedChatModelRunIds[r]=!0,this.metadatas[r]!==void 0&&(WB(o)?this._emit(this.metadatas[r],o.message,r):this._emit(this.metadatas[r],new dn({content:e}),r))}handleLLMEnd(e,n){var r,s;if(this.metadatas[n]!==void 0){if(!this.emittedChatModelRunIds[n]){const i=(s=(r=e.generations)==null?void 0:r[0])==null?void 0:s[0];Yt(i==null?void 0:i.message)&&this._emit(this.metadatas[n],i==null?void 0:i.message,n,!0),delete this.emittedChatModelRunIds[n]}delete this.metadatas[n],delete this.stableMessageIdMap[n]}}handleLLMError(e,n){delete this.metadatas[n]}handleChainStart(e,n,r,s,i,a,o,c){if(a!==void 0&&c===a.langgraph_node&&(i===void 0||!i.includes(Nt))&&(this.metadatas[r]=[a.langgraph_checkpoint_ns.split("|"),{tags:i,name:c,...a}],typeof n=="object")){for(const l of Object.values(n))if((Yt(l)||vo(l))&&l.id!==void 0)this.seen[l.id]=l;else if(Array.isArray(l))for(const u of l)(Yt(u)||vo(u))&&u.id!==void 0&&(this.seen[u.id]=u)}}handleChainEnd(e,n){const r=this.metadatas[n];if(delete this.metadatas[n],r!==void 0){if(Yt(e))this._emit(r,e,n,!0);else if(Array.isArray(e))for(const s of e)Yt(s)&&this._emit(r,s,n,!0);else if(e!=null&&typeof e=="object"){for(const s of Object.values(e))if(Yt(s))this._emit(r,s,n,!0);else if(Array.isArray(s))for(const i of s)Yt(i)&&this._emit(r,i,n,!0)}}}handleChainError(e,n){delete this.metadatas[n]}};const qB=500,JB=2,KB=128e3,XB=3,YB=[400,401,402,403,404,405,406,407,409],QB=t=>{var n,r;if(t.message.startsWith("Cancel")||t.message.startsWith("AbortError")||t.name==="AbortError"||t.name==="GraphValueError"||(t==null?void 0:t.code)==="ECONNABORTED")return!1;const e=((n=t==null?void 0:t.response)==null?void 0:n.status)??(t==null?void 0:t.status);return!(e&&YB.includes(+e)||((r=t==null?void 0:t.error)==null?void 0:r.code)==="insufficient_quota")};async function Bx(t,e,n,r){var u;const s=t.retry_policy??e;let i=s!==void 0?s.initialInterval??qB:0,a=0,o,c,{config:l}=t;for(n&&(l=wr(l,n)),l={...l,signal:r};!(r!=null&&r.aborted);){t.writes.splice(0,t.writes.length),o=void 0;try{c=await t.proc.invoke(t.input,l);break}catch(d){if(o=d,o.pregelTaskId=t.id,f4(o)){const g=(u=l==null?void 0:l.configurable)==null?void 0:u.checkpoint_ns,w=o.command;if(w.graph===g){for(const b of t.writers)await b.invoke(w,l);o=void 0;break}else if(w.graph===xt.PARENT){const b=YF(g);o.command=new xt({...o.command,graph:b})}}if(vl(o)||s===void 0||(a+=1,a>=(s.maxAttempts??XB))||!(s.retryOn??QB)(o))break;i=Math.min(s.maxInterval??KB,i*(s.backoffFactor??JB));const f=s.jitter?Math.floor(i+Math.random()*1e3):i;await new Promise(g=>setTimeout(g,f));const m=o.name??o.constructor.unminifiable_name??o.constructor.name;((s==null?void 0:s.logWarning)??!0)&&console.log(`Retrying task "${String(t.name)}" after ${i.toFixed(2)}ms (attempt ${a}) after ${m}: ${o}`),l=wr(l,{[$s]:!0})}}return{task:t,result:c,error:o,signalAborted:r==null?void 0:r.aborted}}const cp=Symbol.for("promiseAdded");function ez(){const t={next:()=>{},wait:Promise.resolve(cp)};function e(n){t.next=()=>{t.wait=new Promise(e),n(cp)}}return t.wait=new Promise(e),t}var tz=class{constructor({loop:t,nodeFinished:e}){p(this,"nodeFinished");p(this,"loop");this.loop=t,this.nodeFinished=e}async tick(t={}){const{timeout:e,retryPolicy:n,onStepWrite:r,maxConcurrency:s}=t,i=new Set;let a;const o=new AbortController,c=o.signal,l=e?AbortSignal.timeout(e):void 0,u=Object.values(this.loop.tasks).filter(m=>m.writes.length===0),{signals:d,disposeCombinedSignal:h}=this._initializeAbortSignals({exceptionSignal:c,stepTimeoutSignal:l,signal:t.signal}),f=this._executeTasksWithRetry(u,{signals:d,retryPolicy:n,maxConcurrency:s});for await(const{task:m,error:g,signalAborted:w}of f)this._commit(m,g),mi(g)||vl(g)&&!mi(a)?a=g:g&&(i.size===0||!w)&&(o.abort(),i.add(g));if(h==null||h(),r==null||r(this.loop.step,Object.values(this.loop.tasks).map(m=>m.writes).flat()),i.size===1)throw Array.from(i)[0];if(i.size>1)throw new AggregateError(Array.from(i),`Multiple errors occurred during superstep ${this.loop.step}. See the "errors" field of this exception for more details.`);if(mi(a)||vl(a)&&this.loop.isNested)throw a}_initializeAbortSignals({exceptionSignal:t,stepTimeoutSignal:e,signal:n}){var l;const r=((l=this.loop.config.configurable)==null?void 0:l[Q_])??{},s=r.externalAbortSignal??n,i=e??r.timeoutAbortSignal,{signal:a,dispose:o}=Su(s,i,t),c={externalAbortSignal:s,timeoutAbortSignal:i,composedAbortSignal:a};return this.loop.config=wr(this.loop.config,{[Q_]:c}),{signals:c,disposeCombinedSignal:o}}async*_executeTasksWithRetry(t,e){var h,f,m;const{retryPolicy:n,maxConcurrency:r,signals:s}=e??{},i=ez(),a={},o={executingTasksMap:a,barrier:i,retryPolicy:n,scheduleTask:async(g,w,b)=>this.loop.acceptPush(g,w,b)};if((h=s==null?void 0:s.composedAbortSignal)!=null&&h.aborted)throw new Error("Abort");let c=0,l;const u=Su(s==null?void 0:s.externalAbortSignal,s==null?void 0:s.timeoutAbortSignal),d=u.signal?new Promise((g,w)=>{var b;l=()=>w(new Error("Abort")),(b=u.signal)==null||b.addEventListener("abort",l,{once:!0})}):void 0;for(;(c===0||Object.keys(a).length>0)&&t.length;){for(;Object.values(a).length<(r??t.length)&&c<t.length;c+=1){const w=t[c];a[w.id]=Bx(w,n,{[pg]:$l==null?void 0:$l.bind(o,this,w)},s==null?void 0:s.composedAbortSignal).catch(b=>{var y;return{task:w,error:b,signalAborted:(y=s==null?void 0:s.composedAbortSignal)==null?void 0:y.aborted}})}const g=await Promise.race([...Object.values(a),...d?[d]:[],i.wait]);g!==cp&&(yield g,l!=null&&((f=u.signal)==null||f.removeEventListener("abort",l),(m=u.dispose)==null||m.call(u)),delete a[g.task.id])}}_commit(t,e){var n;if(e!==void 0)if(mi(e)){if(e.interrupts.length){const r=e.interrupts.map(i=>[He,i]),s=t.writes.filter(i=>i[0]===Rn);s.length&&r.push(...s),this.loop.putWrites(t.id,r)}}else vl(e)&&t.writes.length?this.loop.putWrites(t.id,t.writes):this.loop.putWrites(t.id,[[An,{message:e.message,name:e.name}]]);else this.nodeFinished&&(((n=t.config)==null?void 0:n.tags)==null||!t.config.tags.includes(Nt))&&this.nodeFinished(String(t.name)),t.writes.length===0&&t.writes.push([mg,null]),this.loop.putWrites(t.id,t.writes)}};async function $l(t,e,n,r,s,i={}){var d,h;const a=(h=(d=e.config)==null?void 0:d.configurable)==null?void 0:h[Ws];if(!a)throw new Error(`BUG: No scratchpad found on task ${e.name}__${e.id}`);const o=a.callCounter;a.callCounter+=1;const c=new xB({func:n,name:r,input:s,cache:i.cache,retry:i.retry,callbacks:i.callbacks}),l=await this.scheduleTask(e,o,c);if(!l)return;const u=this.executingTasksMap[l.id];if(u!==void 0)return u;if(l.writes.length>0){const f=l.writes.filter(([g])=>g===Sa),m=l.writes.filter(([g])=>g===An);if(f.length>0){if(f.length===1)return Promise.resolve(f[0][1]);throw new Error(`BUG: multiple returns found for task ${l.name}__${l.id}`)}if(m.length>0){if(m.length===1){const g=m[0][1],w=g instanceof Error?g:new Error(String(g));return Promise.reject(w)}throw new Error(`BUG: multiple errors found for task ${l.name}__${l.id}`)}return}else{const f=Bx(l,i.retry,{[pg]:$l.bind(this,t,l)});return this.executingTasksMap[l.id]=f,this.barrier.next(),f.then(({result:m,error:g})=>g?Promise.reject(g):m)}}var Xr=class extends Error{constructor(t){super(t),this.name="GraphValidationError"}};function nz({nodes:t,channels:e,inputChannels:n,outputChannels:r,streamChannels:s,interruptAfterNodes:i,interruptBeforeNodes:a}){if(!e)throw new Xr("Channels not provided");const o=new Set,c=new Set;for(const[l,u]of Object.entries(t)){if(l===He)throw new Xr(`"Node name ${He} is reserved"`);if(u.constructor===Bo)u.triggers.forEach(d=>o.add(d));else throw new Xr(`Invalid node type ${typeof u}, expected PregelNode`)}for(const l of o)if(!(l in e))throw new Xr(`Subscribed channel '${String(l)}' not in channels`);if(Array.isArray(n)){if(n.every(l=>!o.has(l)))throw new Xr(`None of the input channels ${n} are subscribed to by any node`)}else if(!o.has(n))throw new Xr(`Input channel ${String(n)} is not subscribed to by any node`);Array.isArray(r)?r.forEach(l=>c.add(l)):c.add(r),s&&!Array.isArray(s)?c.add(s):Array.isArray(s)&&s.forEach(l=>c.add(l));for(const l of c)if(!(l in e))throw new Xr(`Output channel '${String(l)}' not in channels`);if(i&&i!=="*"){for(const l of i)if(!(l in t))throw new Xr(`Node ${String(l)} not in nodes`)}if(a&&a!=="*"){for(const l of a)if(!(l in t))throw new Xr(`Node ${String(l)} not in nodes`)}}function lw(t,e){if(Array.isArray(t)){for(const n of t)if(!(n in e))throw new Error(`Key ${String(n)} not found in channels`)}else if(!(t in e))throw new Error(`Key ${String(t)} not found in channels`)}var rz=class zx extends Mi{constructor(n){super();p(this,"lc_graph_name","Topic");p(this,"unique",!1);p(this,"accumulate",!1);p(this,"seen");p(this,"values");this.unique=(n==null?void 0:n.unique)??this.unique,this.accumulate=(n==null?void 0:n.accumulate)??this.accumulate,this.seen=new Set,this.values=[]}fromCheckpoint(n){const r=new zx({unique:this.unique,accumulate:this.accumulate});return typeof n<"u"&&(r.seen=new Set(n[0]),r.values=n[1]),r}update(n){let r=!1;this.accumulate||(r=this.values.length>0,this.values=[]);const s=n.flat();if(s.length>0)if(this.unique)for(const i of s)this.seen.has(i)||(r=!0,this.seen.add(i),this.values.push(i));else r=!0,this.values.push(...s);return r}get(){if(this.values.length===0)throw new en;return this.values}checkpoint(){return[[...this.seen],this.values]}isAvailable(){return this.values.length!==0}};function sz(t){var c,l,u;const e=Ft.getRunnableConfig();if(!e)throw new Error("Called interrupt() outside the context of a graph.");const n=e.configurable;if(!n)throw new Error("No configurable found in config");if(!n[$t])throw new wl("No checkpointer set",{lc_error_code:"MISSING_CHECKPOINTER"});const s=n[Ws];s.interruptCounter+=1;const i=s.interruptCounter;if(s.resume.length>0&&i<s.resume.length)return(c=n[Gs])==null||c.call(n,[[Rn,s.resume]]),s.resume[i];if(s.nullResume!==void 0){if(s.resume.length!==i)throw new Error(`Resume length mismatch: ${s.resume.length} !== ${i}`);const d=s.consumeNullResume();return s.resume.push(d),(l=n[Gs])==null||l.call(n,[[Rn,s.resume]]),d}const a=(u=n[Dr])==null?void 0:u.split(Ut),o=a?oi(a.join(Ut)):void 0;throw new ca([{id:o,value:t}])}var iz=class{static subscribeTo(t,e){const{key:n,tags:r}={key:void 0,tags:void 0,...e??{}};if(Array.isArray(t)&&n!==void 0)throw new Error("Can't specify a key when subscribing to multiple channels");let s;typeof t=="string"?n?s={[n]:t}:s=[t]:s=Object.fromEntries(t.map(a=>[a,a]));const i=Array.isArray(t)?t:[t];return new Bo({channels:s,triggers:i,tags:r})}static writeTo(t,e){const n=[];for(const r of t)n.push({channel:r,value:xi,skipNone:!1});for(const[r,s]of Object.entries(e??{}))Fe.isRunnable(s)||typeof s=="function"?n.push({channel:r,value:xi,skipNone:!0,mapper:Qt(s)}):n.push({channel:r,value:s,skipNone:!1});return new _n(n)}},az=class extends Fe{constructor(){super(...arguments);p(this,"lc_namespace",["langgraph","pregel"])}invoke(e,n){throw new Error("Not implemented")}withConfig(e){return super.withConfig(e)}stream(e,n){return super.stream(e,n)}},oz=class extends az{constructor(e){super(e);p(this,"lc_namespace",["langgraph","pregel"]);p(this,"lg_is_pregel",!0);p(this,"nodes");p(this,"channels");p(this,"inputChannels");p(this,"outputChannels");p(this,"autoValidate",!0);p(this,"streamMode",["values"]);p(this,"streamChannels");p(this,"interruptAfter");p(this,"interruptBefore");p(this,"stepTimeout");p(this,"debug",!1);p(this,"checkpointer");p(this,"retryPolicy");p(this,"config");p(this,"store");p(this,"cache");p(this,"userInterrupt");p(this,"triggerToNodes",{});let{streamMode:n}=e;if(n!=null&&!Array.isArray(n)&&(n=[n]),this.nodes=e.nodes,this.channels=e.channels,sr in this.channels&&"lc_graph_name"in this.channels[sr]&&this.channels[sr].lc_graph_name!=="Topic")throw new Error(`Channel '${sr}' is reserved and cannot be used in the graph.`);this.channels[sr]=new rz({accumulate:!1}),this.autoValidate=e.autoValidate??this.autoValidate,this.streamMode=n??this.streamMode,this.inputChannels=e.inputChannels,this.outputChannels=e.outputChannels,this.streamChannels=e.streamChannels??this.streamChannels,this.interruptAfter=e.interruptAfter,this.interruptBefore=e.interruptBefore,this.stepTimeout=e.stepTimeout??this.stepTimeout,this.debug=e.debug??this.debug,this.checkpointer=e.checkpointer,this.retryPolicy=e.retryPolicy,this.config=e.config,this.store=e.store,this.cache=e.cache,this.name=e.name,this.triggerToNodes=e.triggerToNodes??this.triggerToNodes,this.userInterrupt=e.userInterrupt,this.autoValidate&&this.validate()}static lc_name(){return"LangGraph"}withConfig(e){const n=Zn(this.config,e);return new this.constructor({...this,config:n})}validate(){var e;nz({nodes:this.nodes,channels:this.channels,outputChannels:this.outputChannels,inputChannels:this.inputChannels,streamChannels:this.streamChannels,interruptAfterNodes:this.interruptAfter,interruptBeforeNodes:this.interruptBefore});for(const[n,r]of Object.entries(this.nodes))for(const s of r.triggers)(e=this.triggerToNodes)[s]??(e[s]=[]),this.triggerToNodes[s].push(n);return this}get streamChannelsList(){return Array.isArray(this.streamChannels)?this.streamChannels:this.streamChannels?[this.streamChannels]:Object.keys(this.channels)}get streamChannelsAsIs(){return this.streamChannels?this.streamChannels:Object.keys(this.channels)}async getGraphAsync(e){return this.getGraph(e)}*getSubgraphs(e,n){var r;for(const[s,i]of Object.entries(this.nodes)){if(e!==void 0&&!e.startsWith(s))continue;const a=(r=i.subgraphs)!=null&&r.length?i.subgraphs:[i.bound];for(const o of a){const c=Ix(o);if(c!==void 0){if(s===e){yield[s,c];return}if(e===void 0&&(yield[s,c]),n){let l=e;e!==void 0&&(l=e.slice(s.length+1));for(const[u,d]of c.getSubgraphs(l,n))yield[`${s}${Ut}${u}`,d]}}}}}async*getSubgraphsAsync(e,n){yield*this.getSubgraphs(e,n)}async _prepareStateSnapshot({config:e,saved:n,subgraphCheckpointer:r,applyPendingWrites:s=!1}){var h,f,m,g,w,b,y,v;if(n===void 0)return{values:{},next:[],config:e,tasks:[]};const i=vu(this.channels,n.checkpoint);if((h=n.pendingWrites)!=null&&h.length){const T=n.pendingWrites.filter(([A,I])=>A===ir).map(([A,I,$])=>[String(I),$]);T.length>0&&Fn(n.checkpoint,i,[{name:ns,writes:T,triggers:[]}],void 0,this.triggerToNodes)}const a=Object.values(ia(n.checkpoint,n.pendingWrites,this.nodes,i,n.config,!0,{step:(((f=n.metadata)==null?void 0:f.step)??-1)+1,store:this.store})),o=await Ns(this.getSubgraphsAsync()),c=((m=n.config.configurable)==null?void 0:m.checkpoint_ns)??"",l={};for(const T of a){const A=o.find(([$])=>$===T.name);if(!A)continue;let I=`${String(T.name)}${ds}${T.id}`;if(c&&(I=`${c}${Ut}${I}`),r===void 0){const $={configurable:{thread_id:(g=n.config.configurable)==null?void 0:g.thread_id,checkpoint_ns:I}};l[T.id]=$}else{const $={configurable:{[$t]:r,thread_id:(w=n.config.configurable)==null?void 0:w.thread_id,checkpoint_ns:I}},S=A[1];l[T.id]=await S.getState($,{subgraphs:!0})}}if(s&&((b=n.pendingWrites)!=null&&b.length)){const T=Object.fromEntries(a.map(I=>[I.id,I]));for(const[I,$,S]of n.pendingWrites)[An,He,bl].includes($)||I in T&&T[I].writes.push([String($),S]);const A=a.filter(I=>I.writes.length>0);A.length>0&&Fn(n.checkpoint,i,A,void 0,this.triggerToNodes)}let u=n==null?void 0:n.metadata;u&&((v=(y=n==null?void 0:n.config)==null?void 0:y.configurable)!=null&&v.thread_id)&&(u={...u,thread_id:n.config.configurable.thread_id});const d=a.filter(T=>T.writes.length===0).map(T=>T.name);return{values:Ri(i,this.streamChannelsAsIs),next:d,tasks:jx(a,(n==null?void 0:n.pendingWrites)??[],l,this.streamChannelsAsIs),metadata:u,config:ni(n.config,n.metadata),createdAt:n.checkpoint.ts,parentConfig:n.parentConfig}}async getState(e,n){var c,l,u,d;const r=((c=e.configurable)==null?void 0:c[$t])??this.checkpointer;if(!r)throw new wl("No checkpointer set",{lc_error_code:"MISSING_CHECKPOINTER"});const s=((l=e.configurable)==null?void 0:l.checkpoint_ns)??"";if(s!==""&&((u=e.configurable)==null?void 0:u[$t])===void 0){const h=vh(s);for await(const[f,m]of this.getSubgraphsAsync(h,!0))if(f===h)return await m.getState(Vi(e,{[$t]:r}),{subgraphs:n==null?void 0:n.subgraphs});throw new Error(`Subgraph with namespace "${h}" not found.`)}const i=Zn(this.config,e),a=await r.getTuple(e);return await this._prepareStateSnapshot({config:i,saved:a,subgraphCheckpointer:n!=null&&n.subgraphs?r:void 0,applyPendingWrites:!((d=e.configurable)!=null&&d.checkpoint_id)})}async*getStateHistory(e,n){var a,o,c;const r=((a=e.configurable)==null?void 0:a[$t])??this.checkpointer;if(!r)throw new wl("No checkpointer set",{lc_error_code:"MISSING_CHECKPOINTER"});const s=((o=e.configurable)==null?void 0:o.checkpoint_ns)??"";if(s!==""&&((c=e.configurable)==null?void 0:c[$t])===void 0){const l=vh(s);for await(const[u,d]of this.getSubgraphsAsync(l,!0))if(u===l){yield*d.getStateHistory(Vi(e,{[$t]:r}),n);return}throw new Error(`Subgraph with namespace "${l}" not found.`)}const i=Zn(this.config,e,{configurable:{checkpoint_ns:s}});for await(const l of r.list(i,n))yield this._prepareStateSnapshot({config:l.config,saved:l})}async bulkUpdateState(e,n){var o,c,l;const r=((o=e.configurable)==null?void 0:o[$t])??this.checkpointer;if(!r)throw new wl("No checkpointer set",{lc_error_code:"MISSING_CHECKPOINTER"});if(n.length===0)throw new Error("No supersteps provided");if(n.some(u=>u.updates.length===0))throw new Error("No updates provided");const s=((c=e.configurable)==null?void 0:c.checkpoint_ns)??"";if(s!==""&&((l=e.configurable)==null?void 0:l[$t])===void 0){const u=vh(s);for await(const[,d]of this.getSubgraphsAsync(u,!0))return await d.bulkUpdateState(Vi(e,{[$t]:r}),n);throw new Error(`Subgraph "${u}" not found`)}const i=async(u,d)=>{var P,W,ne,B,V,H,oe,fe,se,ye,Ne;const h=this.config?Zn(this.config,u):u,f=await r.getTuple(h),m=f!==void 0?wu(f.checkpoint):yx(),g={...f==null?void 0:f.checkpoint.channel_versions},w=((P=f==null?void 0:f.metadata)==null?void 0:P.step)??-1;let b=Vi(h,{checkpoint_ns:((W=h.configurable)==null?void 0:W.checkpoint_ns)??""}),y=h.metadata??{};f!=null&&f.config.configurable&&(b=Vi(h,f.config.configurable),y={...f.metadata,...y});const{values:v,asNode:T}=d[0];if(v==null&&T===void 0){if(d.length>1)throw new dt("Cannot create empty checkpoint with multiple updates");const K=await r.put(b,li(m,void 0,w),{source:"update",step:w+1,parents:((ne=f==null?void 0:f.metadata)==null?void 0:ne.parents)??{}},{});return ni(K,f?f.metadata:void 0)}const A=vu(this.channels,m);if(v===null&&T===ve){if(d.length>1)throw new dt("Cannot apply multiple updates when clearing state");if(f){const re=ia(m,f.pendingWrites||[],this.nodes,A,f.config,!0,{step:(((B=f.metadata)==null?void 0:B.step)??-1)+1,checkpointer:r,store:this.store}),de=(f.pendingWrites||[]).filter(X=>X[0]===ir).map(X=>X.slice(1));de.length>0&&Fn(m,A,[{name:ns,writes:de,triggers:[]}],r.getNextVersion.bind(r),this.triggerToNodes);for(const[X,C,x]of f.pendingWrites||[])[An,He,bl].includes(C)||X in re&&re[X].writes.push([C,x]);Fn(m,A,Object.values(re),r.getNextVersion.bind(r),this.triggerToNodes)}const K=await r.put(b,li(m,A,w),{...y,source:"update",step:w+1,parents:((V=f==null?void 0:f.metadata)==null?void 0:V.parents)??{}},Cl(g,m.channel_versions));return ni(K,f?f.metadata:void 0)}if(T===zF){if(d.length>1)throw new dt("Cannot copy checkpoint with multiple updates");if(f==null)throw new dt("Cannot copy a non-existent checkpoint");const K=X=>!Array.isArray(X)||X.length===0?!1:X.every(C=>Array.isArray(C)&&C.length===2),re=li(m,void 0,w),de=await r.put(f.parentConfig??Vi(f.config,{checkpoint_id:void 0}),re,{source:"fork",step:w+1,parents:((H=f.metadata)==null?void 0:H.parents)??{}},{});if(K(v)){const X=ia(re,f.pendingWrites,this.nodes,A,de,!1,{step:w+2}),C=Object.values(X).reduce((F,{name:N,id:Oe})=>(F[N]??(F[N]=[]),F[N].push({id:Oe}),F),{}),x=v.reduce((F,N)=>{var yt,qt;const[Oe,Me]=N;F[Me]??(F[Me]=[]);const Ke=F[Me].length,ot=(qt=(yt=C[Me])==null?void 0:yt[Ke])==null?void 0:qt.id;return F[Me].push({values:Oe,asNode:Me,taskId:ot}),F},{});return i(ni(de,f.metadata),Object.values(x).flat())}return ni(de,f.metadata)}if(T===ns){if(d.length>1)throw new dt("Cannot apply multiple updates when updating as input");const K=await Ns(Mx(this.inputChannels,v));if(K.length===0)throw new dt(`Received no input writes for ${JSON.stringify(this.inputChannels,null,2)}`);Fn(m,A,[{name:ns,writes:K,triggers:[]}],r.getNextVersion.bind(this.checkpointer),this.triggerToNodes);const re=((oe=f==null?void 0:f.metadata)==null?void 0:oe.step)!=null?f.metadata.step+1:-1,de=await r.put(b,li(m,A,re),{source:"input",step:re,parents:((fe=f==null?void 0:f.metadata)==null?void 0:fe.parents)??{}},Cl(g,m.channel_versions));return await r.putWrites(de,K,na(ns,m.id)),ni(de,f?f.metadata:void 0)}if(((se=h.configurable)==null?void 0:se.checkpoint_id)===void 0&&(f==null?void 0:f.pendingWrites)!==void 0&&f.pendingWrites.length>0){const K=ia(m,f.pendingWrites,this.nodes,A,f.config,!0,{store:this.store,checkpointer:this.checkpointer,step:(((ye=f.metadata)==null?void 0:ye.step)??-1)+1}),re=(f.pendingWrites??[]).filter(X=>X[0]===ir).map(X=>X.slice(1));re.length>0&&Fn(f.checkpoint,A,[{name:ns,writes:re,triggers:[]}],void 0,this.triggerToNodes);for(const[X,C,x]of f.pendingWrites)[An,He,bl].includes(C)||K[X]===void 0||K[X].writes.push([C,x]);const de=Object.values(K).filter(X=>X.writes.length>0);de.length>0&&Fn(m,A,de,void 0,this.triggerToNodes)}const I=Object.values(m.versions_seen).map(K=>Object.values(K)).flat().find(K=>!!K),$=[];if(d.length===1){let{values:K,asNode:re,taskId:de}=d[0];if(re===void 0&&Object.keys(this.nodes).length===1)[re]=Object.keys(this.nodes);else if(re===void 0&&I===void 0)typeof this.inputChannels=="string"&&this.nodes[this.inputChannels]!==void 0&&(re=this.inputChannels);else if(re===void 0){const X=Object.entries(m.versions_seen).map(([C,x])=>Object.values(x).map(F=>[F,C])).flat().filter(([C,x])=>x!==He).sort(([C],[x])=>_x(C,x));X&&(X.length===1?re=X[0][1]:X[X.length-1][0]!==X[X.length-2][0]&&(re=X[X.length-1][1]))}if(re===void 0)throw new dt('Ambiguous update, specify "asNode"');$.push({values:K,asNode:re,taskId:de})}else for(const{asNode:K,values:re,taskId:de}of d){if(K==null)throw new dt('"asNode" is required when applying multiple updates');$.push({values:re,asNode:K,taskId:de})}const S=[];for(const{asNode:K,values:re,taskId:de}of $){if(this.nodes[K]===void 0)throw new dt(`Node "${K.toString()}" does not exist`);const X=this.nodes[K].getWriters();if(!X.length)throw new dt(`No writers found for node "${K.toString()}"`);S.push({name:K,input:re,proc:X.length>1?Jn.from(X,{omitSequenceTags:!0}):X[0],writes:[],triggers:[He],id:de??na(He,m.id),writers:[]})}for(const K of S)await K.proc.invoke(K.input,Xe({...h,store:(h==null?void 0:h.store)??this.store},{runName:h.runName??`${this.getName()}UpdateState`,configurable:{[Gs]:re=>K.writes.push(...re),[Si]:(re,de=!1)=>Ol(m,A,K,re,de)}}));for(const K of S){const re=K.writes.filter(de=>de[0]!==Bn);f!==void 0&&re.length>0&&await r.putWrites(b,re,K.id)}Fn(m,A,S,r.getNextVersion.bind(this.checkpointer),this.triggerToNodes);const M=Cl(g,m.channel_versions),j=await r.put(b,li(m,A,w+1),{source:"update",step:w+1,parents:((Ne=f==null?void 0:f.metadata)==null?void 0:Ne.parents)??{}},M);for(const K of S){const re=K.writes.filter(de=>de[0]===Bn);re.length>0&&await r.putWrites(j,re,K.id)}return ni(j,f?f.metadata:void 0)};let a=e;for(const{updates:u}of n)a=await i(a,u);return a}async updateState(e,n,r){return this.bulkUpdateState(e,[{updates:[{values:n,asNode:r}]}])}_defaults(e){var A,I,$;const{debug:n,streamMode:r,inputKeys:s,outputKeys:i,interruptAfter:a,interruptBefore:o,...c}=e;let l=!0;const u=n!==void 0?n:this.debug;let d=i;d===void 0?d=this.streamChannelsAsIs:lw(d,this.channels);let h=s;h===void 0?h=this.inputChannels:lw(h,this.channels);const f=o??this.interruptBefore??[],m=a??this.interruptAfter??[];let g;r!==void 0?(g=Array.isArray(r)?r:[r],l=typeof r=="string"):(((A=e.configurable)==null?void 0:A[mo])!==void 0?g=["values"]:g=this.streamMode,l=!0);let w;if(this.checkpointer===!1)w=void 0;else if(e!==void 0&&((I=e.configurable)==null?void 0:I[$t])!==void 0)w=e.configurable[$t];else{if(this.checkpointer===!0)throw new Error("checkpointer: true cannot be used for root graphs.");w=this.checkpointer}const b=e.store??this.store,y=e.cache??this.cache;if(e.durability!=null&&e.checkpointDuring!=null)throw new Error("Cannot use both `durability` and `checkpointDuring` at the same time.");const v=(()=>{if(e.checkpointDuring!=null)return e.checkpointDuring===!1?"exit":"async"})(),T=e.durability??v??(($=e==null?void 0:e.configurable)==null?void 0:$[Tx])??"async";return[u,g,h,d,c,f,m,w,b,l,y,T]}async stream(e,n){var a;const r=new AbortController,s={recursionLimit:(a=this.config)==null?void 0:a.recursionLimit,...n,signal:Su(n==null?void 0:n.signal,r.signal).signal},i=await super.stream(e,s);return new aw((n==null?void 0:n.encoding)==="text/event-stream"?BB(i):i,r)}streamEvents(e,n,r){var a,o;const s=new AbortController,i={recursionLimit:(a=this.config)==null?void 0:a.recursionLimit,...n,callbacks:SB((o=this.config)==null?void 0:o.callbacks,n==null?void 0:n.callbacks),signal:Su(n==null?void 0:n.signal,s.signal).signal};return new aw(super.streamEvents(e,i,r),s)}async _validateInput(e){return e}async _validateContext(e){return e}async*_streamIterator(e,n){const r="version"in(n??{})?void 0:(n==null?void 0:n.encoding)??void 0,s=n==null?void 0:n.subgraphs,i=xx(this.config,n);if(i.recursionLimit===void 0||i.recursionLimit<1)throw new Error('Passed "recursionLimit" must be at least 1.');if(this.checkpointer!==void 0&&this.checkpointer!==!1&&i.configurable===void 0)throw new Error('Checkpointer requires one or more of the following "configurable" keys: "thread_id", "checkpoint_ns", "checkpoint_id"');const a=await this._validateInput(e),{runId:o,...c}=i,[l,u,,d,h,f,m,g,w,b,y,v]=this._defaults(c);typeof h.context<"u"?h.context=await this._validateContext(h.context):h.configurable=await this._validateContext(h.configurable);const T=new Ux({modes:new Set(u)});if(this.checkpointer===!0){h.configurable??(h.configurable={});const W=h.configurable[Dr]??"";h.configurable[Dr]=W.split(Ut).map(ne=>ne.split(ds)[0]).join(Ut)}if(u.includes("messages")){const W=new HB(B=>T.push(B)),{callbacks:ne}=h;if(ne===void 0)h.callbacks=[W];else if(Array.isArray(ne))h.callbacks=ne.concat(W);else{const B=ne.copy();B.addHandler(W,!0),h.callbacks=B}}h.writer??(h.writer=W=>{var B,V,H;if(!u.includes("custom"))return;const ne=(H=(V=(B=XF())==null?void 0:B.configurable)==null?void 0:V[Dr])==null?void 0:H.split(Ut).slice(0,-1);T.push([ne??[],"custom",W])}),h.interrupt??(h.interrupt=this.userInterrupt??sz);const A=await On(h),I=await(A==null?void 0:A.handleChainStart(this.toJSON(),TB(e,"input"),o,void 0,void 0,void 0,(h==null?void 0:h.runName)??this.getName())),$=hg(this.channels);let S,M;const P=(async()=>{var W,ne,B;try{S=await GB.initialize({input:a,config:h,checkpointer:g,nodes:this.nodes,channelSpecs:$,outputKeys:d,streamKeys:this.streamChannelsAsIs,store:w,cache:y,stream:T,interruptAfter:m,interruptBefore:f,manager:I,debug:this.debug,triggerToNodes:this.triggerToNodes,durability:v});const V=new tz({loop:S,nodeFinished:(W=h.configurable)==null?void 0:W[VF]});n!=null&&n.subgraphs&&(S.config.configurable={...S.config.configurable,[bu]:S.stream}),await this._runLoop({loop:S,runner:V,debug:l,config:h}),v==="sync"&&await Promise.all((S==null?void 0:S.checkpointerPromises)??[])}catch(V){M=V}finally{try{S&&(await((ne=S.store)==null?void 0:ne.stop()),await((B=S.cache)==null?void 0:B.stop())),await Promise.all((S==null?void 0:S.checkpointerPromises)??[])}catch(V){M=M??V}M?T.error(M):T.close()}})();try{for await(const W of T){if(W===void 0)throw new Error("Data structure error.");const[ne,B,V]=W;if(u.includes(B)){if(r==="text/event-stream"){s?yield[ne,B,V]:yield[null,B,V];continue}s&&!b?yield[ne,B,V]:b?s?yield[ne,V]:yield V:yield[B,V]}}}catch(W){throw await(I==null?void 0:I.handleChainError(M)),W}finally{await P}await(I==null?void 0:I.handleChainEnd((S==null?void 0:S.output)??{},o,void 0,void 0,void 0))}async invoke(e,n){const r=(n==null?void 0:n.streamMode)??"values",s={...n,outputKeys:(n==null?void 0:n.outputKeys)??this.outputChannels,streamMode:r,encoding:void 0},i=[],a=await this.stream(e,s),o=[];let c;for await(const l of a)r==="values"?Sx(l)?o.push(l[He]):c=l:i.push(l);if(r==="values"){if(o.length>0){const l=o.flat(1);if(c==null)return{[He]:l};if(typeof c=="object")return{...c,[He]:l}}return c}return i}async _runLoop(e){const{loop:n,runner:r,debug:s,config:i}=e;let a;try{for(;await n.tick({inputKeys:this.inputChannels});){for(const{task:o}of await n._matchCachedWrites())n._outputWrites(o.id,o.writes,!0);s&&jB(n.checkpointMetadata.step,n.channels,this.streamChannelsList),s&&Dx(n.step,Object.values(n.tasks)),await r.tick({timeout:this.stepTimeout,retryPolicy:this.retryPolicy,onStepWrite:(o,c)=>{s&&DB(o,c,this.streamChannelsList)},maxConcurrency:i.maxConcurrency,signal:i.signal})}if(n.status==="out_of_steps")throw new h4([`Recursion limit of ${i.recursionLimit} reached`,"without hitting a stop condition. You can increase the",'limit by setting the "recursionLimit" config key.'].join(" "),{lc_error_code:"GRAPH_RECURSION_LIMIT"})}catch(o){if(a=o,!await n.finishAndHandleError(a))throw o}finally{a===void 0&&await n.finishAndHandleError()}}async clearCache(){var e;await((e=this.cache)==null?void 0:e.clear([]))}},ka=class Zx extends Mi{constructor(n=!0){super();p(this,"lc_graph_name","EphemeralValue");p(this,"guard");p(this,"value",[]);this.guard=n}fromCheckpoint(n){const r=new Zx(this.guard);return typeof n<"u"&&(r.value=[n]),r}update(n){if(n.length===0){const r=this.value.length>0;return this.value=[],r}if(n.length!==1&&this.guard)throw new dt("EphemeralValue can only receive one value per step.");return this.value=[n[n.length-1]],!0}get(){if(this.value.length===0)throw new en;return this.value[0]}checkpoint(){if(this.value.length===0)throw new en;return this.value[0]}isAvailable(){return this.value.length!==0}},Vx=class{constructor(t){p(this,"path");p(this,"ends");Fe.isRunnable(t.path)?this.path=t.path:this.path=Qt(t.path).withConfig({runName:"Branch"}),this.ends=Array.isArray(t.pathMap)?t.pathMap.reduce((e,n)=>(e[n]=n,e),{}):t.pathMap}run(t,e){return _n.registerWriter(new Li({name:"<branch_run>",trace:!1,func:async(n,r)=>{try{return await this._route(n,r,t,e)}catch(s){throw s.name===yS.unminifiable_name&&console.warn(`[WARN]: 'NodeInterrupt' thrown in conditional edge. This is likely a bug in your graph implementation.
NodeInterrupt should only be thrown inside a node, not in edge conditions.`),s}}}))}async _route(t,e,n,r){let s=await this.path.invoke(r?r(e):t,e);Array.isArray(s)||(s=[s]);let i;if(this.ends?i=s.map(o=>Xn(o)?o:this.ends[o]):i=s,i.some(o=>!o))throw new Error("Branch condition returned unknown or null destination");if(i.filter(Xn).some(o=>o.node===ve))throw new dt("Cannot send a packet to the END node");return await n(i,e)??t}},cz=class{constructor(){p(this,"nodes");p(this,"edges");p(this,"branches");p(this,"entryPoint");p(this,"compiled",!1);this.nodes={},this.edges=new Set,this.branches={}}warnIfCompiled(t){this.compiled&&console.warn(t)}get allEdges(){return this.edges}addNode(...t){function e(r){return r.length>=1&&typeof r[0]!="string"}const n=e(t)?Array.isArray(t[0])?t[0]:Object.entries(t[0]):[[t[0],t[1],t[2]]];if(n.length===0)throw new Error("No nodes provided in `addNode`");for(const[r,s,i]of n){for(const o of[Ut,ds])if(r.includes(o))throw new Error(`"${o}" is a reserved character and is not allowed in node names.`);if(this.warnIfCompiled("Adding a node to a graph that has already been compiled. This will not be reflected in the compiled graph."),r in this.nodes)throw new Error(`Node \`${r}\` already present.`);if(r===ve)throw new Error(`Node \`${r}\` is reserved.`);const a=Qt(s);this.nodes[r]={runnable:a,metadata:i==null?void 0:i.metadata,subgraphs:gg(a)?[a]:i==null?void 0:i.subgraphs,ends:i==null?void 0:i.ends}}return this}addEdge(t,e){if(this.warnIfCompiled("Adding an edge to a graph that has already been compiled. This will not be reflected in the compiled graph."),t===ve)throw new Error("END cannot be a start node");if(e===et)throw new Error("START cannot be an end node");if(Array.from(this.edges).some(([n])=>n===t)&&!("channels"in this))throw new Error(`Already found path for ${t}. For multiple edges, use StateGraph.`);return this.edges.add([t,e]),this}addConditionalEdges(t,e,n){var i,a;const r=typeof t=="object"?t:{source:t,path:e,pathMap:n};if(this.warnIfCompiled("Adding an edge to a graph that has already been compiled. This will not be reflected in the compiled graph."),!Fe.isRunnable(r.path)){const o=Array.isArray(r.pathMap)?r.pathMap.join(","):Object.keys(r.pathMap??{}).join(",");r.path=Qt(r.path).withConfig({runName:`Branch<${r.source}${o!==""?`,${o}`:""}>`.slice(0,63)})}const s=r.path.getName()==="RunnableLambda"?"condition":r.path.getName();if(this.branches[r.source]&&this.branches[r.source][s])throw new Error(`Condition \`${s}\` already present for node \`${t}\``);return(i=this.branches)[a=r.source]??(i[a]={}),this.branches[r.source][s]=new Vx(r),this}setEntryPoint(t){return this.warnIfCompiled("Setting the entry point of a graph that has already been compiled. This will not be reflected in the compiled graph."),this.addEdge(et,t)}setFinishPoint(t){return this.warnIfCompiled("Setting a finish point of a graph that has already been compiled. This will not be reflected in the compiled graph."),this.addEdge(t,ve)}compile({checkpointer:t,interruptBefore:e,interruptAfter:n,name:r}={}){this.validate([...Array.isArray(e)?e:[],...Array.isArray(n)?n:[]]);const s=new Gx({builder:this,checkpointer:t,interruptAfter:n,interruptBefore:e,autoValidate:!1,nodes:{},channels:{[et]:new ka,[ve]:new ka},inputChannels:et,outputChannels:ve,streamChannels:[],streamMode:"values",name:r});for(const[i,a]of Object.entries(this.nodes))s.attachNode(i,a);for(const[i,a]of this.edges)s.attachEdge(i,a);for(const[i,a]of Object.entries(this.branches))for(const[o,c]of Object.entries(a))s.attachBranch(i,o,c);return s.validate()}validate(t){const e=new Set([...this.allEdges].map(([r,s])=>r));for(const[r]of Object.entries(this.branches))e.add(r);for(const r of e)if(r!==et&&!(r in this.nodes))throw new Error(`Found edge starting at unknown node \`${r}\``);const n=new Set([...this.allEdges].map(([r,s])=>s));for(const[r,s]of Object.entries(this.branches))for(const i of Object.values(s))if(i.ends!=null)for(const a of Object.values(i.ends))n.add(a);else{n.add(ve);for(const a of Object.keys(this.nodes))a!==r&&n.add(a)}for(const r of Object.values(this.nodes))for(const s of r.ends??[])n.add(s);for(const r of Object.keys(this.nodes))if(!n.has(r))throw new p4([`Node \`${r}\` is not reachable.`,"","If you are returning Command objects from your node,",'make sure you are passing names of potential destination nodes as an "ends" array','into ".addNode(..., { ends: ["node1", "node2"] })".'].join(`
`),{lc_error_code:"UNREACHABLE_NODE"});for(const r of n)if(r!==ve&&!(r in this.nodes))throw new Error(`Found edge ending at unknown node \`${r}\``);if(t){for(const r of t)if(!(r in this.nodes))throw new Error(`Interrupt node \`${r}\` is not present`)}this.compiled=!0}},Gx=class extends oz{constructor({builder:e,...n}){super(n);p(this,"builder");this.builder=e}attachNode(e,n){this.channels[e]=new ka,this.nodes[e]=new Bo({channels:[],triggers:[],metadata:n.metadata,subgraphs:n.subgraphs,ends:n.ends}).pipe(n.runnable).pipe(new _n([{channel:e,value:xi}],[Nt])),this.streamChannels.push(e)}attachEdge(e,n){if(n===ve){if(e===et)throw new Error("Cannot have an edge from START to END");this.nodes[e].writers.push(new _n([{channel:ve,value:xi}],[Nt]))}else this.nodes[n].triggers.push(e),this.nodes[n].channels.push(e)}attachBranch(e,n,r){e===et&&!this.nodes[et]&&(this.nodes[et]=iz.subscribeTo(et,{tags:[Nt]})),this.nodes[e].pipe(r.run(i=>{const a=i.map(o=>Xn(o)?o:{channel:o===ve?ve:`branch:${e}:${n}:${o}`,value:xi});return new _n(a,[Nt])}));const s=r.ends?Object.values(r.ends):Object.keys(this.nodes);for(const i of s)if(i!==ve){const a=`branch:${e}:${n}:${i}`;this.channels[a]=new ka,this.nodes[i].triggers.push(a),this.nodes[i].channels.push(a)}}async getGraphAsync(e){var l,u,d,h;const n=e==null?void 0:e.xray,r=new Mo,s={[et]:r.addNode({schema:qc()},et)},i={};let a={};n&&(a=Object.fromEntries((await Ns(this.getSubgraphsAsync())).filter(f=>uw(f[1]))));function o(f,m,g,w=!1){if(m===ve&&i[ve]===void 0&&(i[ve]=r.addNode({schema:qc()},ve)),s[f]!==void 0){if(i[m]===void 0)throw new Error(`End node ${m} not found!`);return r.addEdge(s[f],i[m],g!==m?g:void 0,w)}}for(const[f,m]of Object.entries(this.builder.nodes)){const g=sn(f),w=m.runnable,b=m.metadata??{};if((l=this.interruptBefore)!=null&&l.includes(f)&&((u=this.interruptAfter)!=null&&u.includes(f))?b.__interrupt="before,after":(d=this.interruptBefore)!=null&&d.includes(f)?b.__interrupt="before":(h=this.interruptAfter)!=null&&h.includes(f)&&(b.__interrupt="after"),n){const y=typeof n=="number"?n-1:n,v=a[f]!==void 0?await a[f].getGraphAsync({...e,xray:y}):w.getGraph(e);if(v.trimFirstNode(),v.trimLastNode(),Object.keys(v.nodes).length>1){let I=function(S){return S?S.lc_runnable:!1},$=function(S,M){if(S!==void 0&&!wi(S))return S;if(I(M))try{let j=M.getName();return j=j.startsWith("Runnable")?j.slice(8):j,j}catch{return M.getName()}else return M.name??"UnknownSchema"};const[T,A]=r.extend(v,g);if(T===void 0)throw new Error(`Could not extend subgraph "${f}" due to missing entrypoint.`);A!==void 0&&(s[g]={name:$(A.id,A.data),...A}),i[g]={name:$(T.id,T.data),...T}}else{const T=r.addNode(w,g,b);s[g]=T,i[g]=T}}else{const y=r.addNode(w,g,b);s[g]=y,i[g]=y}}const c=[...this.builder.allEdges].sort(([f],[m])=>f<m?-1:m>f?1:0);for(const[f,m]of c)o(sn(f),sn(m));for(const[f,m]of Object.entries(this.builder.branches)){const g={...Object.fromEntries(Object.keys(this.builder.nodes).filter(w=>w!==f).map(w=>[sn(w),sn(w)])),[ve]:ve};for(const w of Object.values(m)){let b;w.ends!==void 0?b=w.ends:b=g;for(const[y,v]of Object.entries(b))o(sn(f),sn(v),y,!0)}}for(const[f,m]of Object.entries(this.builder.nodes))if(m.ends!==void 0)for(const g of m.ends)o(sn(f),sn(g),void 0,!0);return r}getGraph(e){var l,u,d,h;const n=e==null?void 0:e.xray,r=new Mo,s={[et]:r.addNode({schema:qc()},et)},i={};let a={};n&&(a=Object.fromEntries(no(this.getSubgraphs()).filter(f=>uw(f[1]))));function o(f,m,g,w=!1){return m===ve&&i[ve]===void 0&&(i[ve]=r.addNode({schema:qc()},ve)),r.addEdge(s[f],i[m],g!==m?g:void 0,w)}for(const[f,m]of Object.entries(this.builder.nodes)){const g=sn(f),w=m.runnable,b=m.metadata??{};if((l=this.interruptBefore)!=null&&l.includes(f)&&((u=this.interruptAfter)!=null&&u.includes(f))?b.__interrupt="before,after":(d=this.interruptBefore)!=null&&d.includes(f)?b.__interrupt="before":(h=this.interruptAfter)!=null&&h.includes(f)&&(b.__interrupt="after"),n){const y=typeof n=="number"?n-1:n,v=a[f]!==void 0?a[f].getGraph({...e,xray:y}):w.getGraph(e);if(v.trimFirstNode(),v.trimLastNode(),Object.keys(v.nodes).length>1){let I=function(S){return S?S.lc_runnable:!1},$=function(S,M){if(S!==void 0&&!wi(S))return S;if(I(M))try{let j=M.getName();return j=j.startsWith("Runnable")?j.slice(8):j,j}catch{return M.getName()}else return M.name??"UnknownSchema"};const[T,A]=r.extend(v,g);if(T===void 0)throw new Error(`Could not extend subgraph "${f}" due to missing entrypoint.`);A!==void 0&&(s[g]={name:$(A.id,A.data),...A}),i[g]={name:$(T.id,T.data),...T}}else{const T=r.addNode(w,g,b);s[g]=T,i[g]=T}}else{const y=r.addNode(w,g,b);s[g]=y,i[g]=y}}const c=[...this.builder.allEdges].sort(([f],[m])=>f<m?-1:m>f?1:0);for(const[f,m]of c)o(sn(f),sn(m));for(const[f,m]of Object.entries(this.builder.branches)){const g={...Object.fromEntries(Object.keys(this.builder.nodes).filter(w=>w!==f).map(w=>[sn(w),sn(w)])),[ve]:ve};for(const w of Object.values(m)){let b;w.ends!==void 0?b=w.ends:b=g;for(const[y,v]of Object.entries(b))o(sn(f),sn(v),y,!0)}}return r}};function uw(t){return typeof t.attachNode=="function"&&typeof t.attachEdge=="function"}function sn(t){return t==="subgraph"?`"${t}"`:t}const gi=(t,e)=>t.size===e.size&&[...t].every(n=>e.has(n));var lz=class Wx extends Mi{constructor(n){super();p(this,"lc_graph_name","NamedBarrierValue");p(this,"names");p(this,"seen");this.names=n,this.seen=new Set}fromCheckpoint(n){const r=new Wx(this.names);return typeof n<"u"&&(r.seen=new Set(n)),r}update(n){let r=!1;for(const s of n)if(this.names.has(s))this.seen.has(s)||(this.seen.add(s),r=!0);else throw new dt(`Value ${JSON.stringify(s)} not in names ${JSON.stringify(this.names)}`);return r}get(){if(!gi(this.names,this.seen))throw new en}checkpoint(){return[...this.seen]}consume(){return this.seen&&this.names&&gi(this.seen,this.names)?(this.seen=new Set,!0):!1}isAvailable(){return!!this.names&&gi(this.names,this.seen)}},uz=class Hx extends Mi{constructor(n){super();p(this,"lc_graph_name","NamedBarrierValueAfterFinish");p(this,"names");p(this,"seen");p(this,"finished");this.names=n,this.seen=new Set,this.finished=!1}fromCheckpoint(n){const r=new Hx(this.names);if(typeof n<"u"){const[s,i]=n;r.seen=new Set(s),r.finished=i}return r}update(n){let r=!1;for(const s of n)if(this.names.has(s)&&!this.seen.has(s))this.seen.add(s),r=!0;else if(!this.names.has(s))throw new dt(`Value ${JSON.stringify(s)} not in names ${JSON.stringify(this.names)}`);return r}get(){if(!this.finished||!gi(this.names,this.seen))throw new en}checkpoint(){return[[...this.seen],this.finished]}consume(){return this.finished&&this.seen&&this.names&&gi(this.seen,this.names)?(this.seen=new Set,this.finished=!1,!0):!1}finish(){return!this.finished&&this.names&&gi(this.names,this.seen)?(this.finished=!0,!0):!1}isAvailable(){return this.finished&&!!this.names&&gi(this.names,this.seen)}};const dz="lg:";var hz=class{constructor(){p(this,"_map",new WeakMap);p(this,"_extensionCache",new Map)}get(t){return this._map.get(t)}extend(t,e){const n=this.get(t);this._map.set(t,e(n))}remove(t){return this._map.delete(t),this}has(t){return this._map.has(t)}getChannelsForSchema(t){const e={},n=ya(t);for(const[r,s]of Object.entries(n)){const i=this.get(s);i!=null&&i.reducer?e[r]=new Qf(i.reducer.fn,i.default):e[r]=new fg(i==null?void 0:i.default)}return e}getExtendedChannelSchemas(t,e){if(Object.keys(e).length===0)return t;const n=Object.entries(e).filter(([,i])=>i===!0).sort(([i],[a])=>i.localeCompare(a)).map(([i,a])=>`${i}:${a}`).join("|"),r=this._extensionCache.get(n)??new WeakMap;if(r.has(t))return r.get(t);let s=t;if(e.withReducerSchema||e.withJsonSchemaExtrasAsDescription){const i=Object.entries(ya(t)).map(([a,o])=>{var u;const c=this.get(o);let l=e.withReducerSchema?((u=c==null?void 0:c.reducer)==null?void 0:u.schema)??o:o;if(e.withJsonSchemaExtrasAsDescription&&(c!=null&&c.jsonSchemaExtra)){const d=ki(l)??ki(o),h=JSON.stringify({...c.jsonSchemaExtra,description:d});l=l.describe(`${dz}${h}`)}return[a,l]});s=Yb(t,Object.fromEntries(i)),Ct(s)&&(s._def.unknownKeys="strip")}return e.asPartial&&(s=Gu(s)),r.set(t,s),this._extensionCache.set(n,r),s}};const Vo=new hz;function xu(t,e){var n;if(e.reducer&&!e.default){const r=Wu(t);r!=null&&(e.default=r)}if(e.reducer){const r=Object.assign(t,{lg_reducer_schema:((n=e.reducer)==null?void 0:n.schema)??t});return Vo.extend(r,()=>e),r}else return Vo.extend(t,()=>e),t}const as="__root__",lp=Symbol.for("langgraph.state.partial");var qx=class extends cz{constructor(e,n){var s,i;super();p(this,"channels",{});p(this,"waitingEdges",new Set);p(this,"_schemaDefinition");p(this,"_schemaRuntimeDefinition");p(this,"_inputDefinition");p(this,"_inputRuntimeDefinition");p(this,"_outputDefinition");p(this,"_outputRuntimeDefinition");p(this,"_schemaDefinitions",new Map);p(this,"_metaRegistry",Vo);p(this,"_configSchema");p(this,"_configRuntimeSchema");p(this,"_interrupt");p(this,"_writer");if(wz(e)){const a=this._metaRegistry.getChannelsForSchema(e.state),o=e.input!=null?this._metaRegistry.getChannelsForSchema(e.input):a,c=e.output!=null?this._metaRegistry.getChannelsForSchema(e.output):a;this._schemaDefinition=a,this._schemaRuntimeDefinition=e.state,this._inputDefinition=o,this._inputRuntimeDefinition=e.input??lp,this._outputDefinition=c,this._outputRuntimeDefinition=e.output??e.state}else if(In(e)){const a=this._metaRegistry.getChannelsForSchema(e);this._schemaDefinition=a,this._schemaRuntimeDefinition=e,this._inputDefinition=a,this._inputRuntimeDefinition=lp,this._outputDefinition=a,this._outputRuntimeDefinition=e}else if(_z(e))this._schemaDefinition=e.input.spec,this._inputDefinition=e.input.spec,this._outputDefinition=e.output.spec;else if(yz(e))this._schemaDefinition=e.stateSchema.spec,this._inputDefinition=((s=e.input)==null?void 0:s.spec)??this._schemaDefinition,this._outputDefinition=((i=e.output)==null?void 0:i.spec)??this._schemaDefinition;else if(mz(e)||dw(e)){const a=dw(e)?e.spec:e;this._schemaDefinition=a}else if(gz(e)){const a=fz(e.channels);this._schemaDefinition=a}else throw new Error("Invalid StateGraph input. Make sure to pass a valid Annotation.Root or Zod schema.");this._inputDefinition??(this._inputDefinition=this._schemaDefinition),this._outputDefinition??(this._outputDefinition=this._schemaDefinition),this._addSchema(this._schemaDefinition),this._addSchema(this._inputDefinition),this._addSchema(this._outputDefinition);function r(a){return typeof a=="object"&&a!=null&&!("spec"in a)&&!In(a)}r(n)?(In(n.context)&&(this._configRuntimeSchema=n.context),this._interrupt=n.interrupt,this._writer=n.writer):In(n)&&(this._configRuntimeSchema=n)}get allEdges(){return new Set([...this.edges,...Array.from(this.waitingEdges).flatMap(([e,n])=>e.map(r=>[r,n]))])}_addSchema(e){if(!this._schemaDefinitions.has(e)){this._schemaDefinitions.set(e,e);for(const[n,r]of Object.entries(e)){let s;if(typeof r=="function"?s=r():s=r,this.channels[n]!==void 0){if(this.channels[n]!==s&&s.lc_graph_name!=="LastValue")throw new Error(`Channel "${n}" already exists with a different type.`)}else this.channels[n]=s}}}addNode(...e){function n(s){return s.length>=1&&typeof s[0]!="string"}const r=n(e)?Array.isArray(e[0])?e[0]:Object.entries(e[0]).map(([s,i])=>[s,i]):[[e[0],e[1],e[2]]];if(r.length===0)throw new Error("No nodes provided in `addNode`");for(const[s,i,a]of r){if(s in this.channels)throw new Error(`${s} is already being used as a state attribute (a.k.a. a channel), cannot also be used as a node name.`);for(const d of[Ut,ds])if(s.includes(d))throw new Error(`"${d}" is a reserved character and is not allowed in node names.`);if(this.warnIfCompiled("Adding a node to a graph that has already been compiled. This will not be reflected in the compiled graph."),s in this.nodes)throw new Error(`Node \`${s}\` already present.`);if(s===ve||s===et)throw new Error(`Node \`${s}\` is reserved.`);let o=this._schemaDefinition;(a==null?void 0:a.input)!==void 0&&(In(a.input)?o=this._metaRegistry.getChannelsForSchema(a.input):a.input.spec!==void 0&&(o=a.input.spec)),o!==void 0&&this._addSchema(o);let c;Fe.isRunnable(i)?c=i:typeof i=="function"?c=new Li({func:i,name:s,trace:!1}):c=Qt(i);let l=a==null?void 0:a.cachePolicy;typeof l=="boolean"&&(l=l?{}:void 0);const u={runnable:c,retryPolicy:a==null?void 0:a.retryPolicy,cachePolicy:l,metadata:a==null?void 0:a.metadata,input:o??this._schemaDefinition,subgraphs:gg(c)?[c]:a==null?void 0:a.subgraphs,ends:a==null?void 0:a.ends,defer:a==null?void 0:a.defer};this.nodes[s]=u}return this}addEdge(e,n){if(typeof e=="string")return super.addEdge(e,n);this.compiled&&console.warn("Adding an edge to a graph that has already been compiled. This will not be reflected in the compiled graph.");for(const r of e){if(r===ve)throw new Error("END cannot be a start node");if(!Object.keys(this.nodes).some(s=>s===r))throw new Error(`Need to add a node named "${r}" first`)}if(n===ve)throw new Error("END cannot be an end node");if(!Object.keys(this.nodes).some(r=>r===n))throw new Error(`Need to add a node named "${n}" first`);return this.waitingEdges.add([e,n]),this}addSequence(e){const n=Array.isArray(e)?e:Object.entries(e);if(n.length===0)throw new Error("Sequence requires at least one node.");let r;for(const[s,i,a]of n){if(s in this.nodes)throw new Error(`Node names must be unique: node with the name "${s}" already exists.`);const o=s;this.addNode(o,i,a),r!=null&&this.addEdge(r,o),r=o}return this}compile({checkpointer:e,store:n,cache:r,interruptBefore:s,interruptAfter:i,name:a,description:o}={}){this.validate([...Array.isArray(s)?s:[],...Array.isArray(i)?i:[]]);const c=Object.keys(this._schemaDefinitions.get(this._outputDefinition)),l=c.length===1&&c[0]===as?as:c,u=Object.keys(this.channels),d=u.length===1&&u[0]===as?as:u,h=this._interrupt,f=new pz({builder:this,checkpointer:e,interruptAfter:i,interruptBefore:s,autoValidate:!1,nodes:{},channels:{...this.channels,[et]:new ka},inputChannels:et,outputChannels:l,streamChannels:d,streamMode:"updates",store:n,cache:r,name:a,description:o,userInterrupt:h});f.attachNode(et);for(const[m,g]of Object.entries(this.nodes))f.attachNode(m,g);f.attachBranch(et,ew,hw(),{withReader:!1});for(const[m]of Object.entries(this.nodes))f.attachBranch(m,ew,hw(),{withReader:!1});for(const[m,g]of this.edges)f.attachEdge(m,g);for(const[m,g]of this.waitingEdges)f.attachEdge(m,g);for(const[m,g]of Object.entries(this.branches))for(const[w,b]of Object.entries(g))f.attachBranch(m,w,b);return f.validate()}};function fz(t){const e={};for(const[n,r]of Object.entries(t))e[n]=tp(r);return e}var pz=class extends Gx{constructor({description:e,...n}){super(n);p(this,"description");p(this,"_metaRegistry",Vo);this.description=e}attachNode(e,n){let r;e===et?r=Object.entries(this.builder._schemaDefinitions.get(this.builder._inputDefinition)).map(([c])=>c):r=Object.keys(this.builder.channels);function s(c){if(Gt(c))return c.graph===xt.PARENT?null:c._updateAsTuples();if(Array.isArray(c)&&c.length>0&&c.some(l=>Gt(l))){const l=[];for(const u of c)if(Gt(u)){if(u.graph===xt.PARENT)continue;l.push(...u._updateAsTuples())}else l.push([as,u]);return l}else if(c!=null)return[[as,c]];return null}const i=e;function a(c){if(c){if(Gt(c))return c.graph===xt.PARENT?null:c._updateAsTuples().filter(([l])=>r.includes(l));if(Array.isArray(c)&&c.length>0&&c.some(Gt)){const l=[];for(const u of c)if(Gt(u)){if(u.graph===xt.PARENT)continue;l.push(...u._updateAsTuples().filter(([d])=>r.includes(d)))}else{const d=a(u);d&&l.push(...d??[])}return l}else{if(typeof c=="object"&&!Array.isArray(c))return Object.entries(c).filter(([l])=>r.includes(l));{const l=Array.isArray(c)?"array":typeof c;throw new dt(`Expected node "${i.toString()}" to return an object or an array containing at least one Command object, received ${l}`,{lc_error_code:"INVALID_GRAPH_NODE_RETURN_VALUE"})}}}else return null}const o=[{value:xi,mapper:new Li({func:r.length&&r[0]===as?s:a,trace:!1,recurse:!1})}];if(e===et)this.nodes[e]=new Bo({tags:[Nt],triggers:[et],channels:[et],writers:[new _n(o,[Nt])]});else{const c=(n==null?void 0:n.input)??this.builder._schemaDefinition,l=Object.fromEntries(Object.keys(this.builder._schemaDefinitions.get(c)).map(h=>[h,h])),u=Object.keys(l).length===1&&as in l,d=`branch:to:${e}`;this.channels[d]=n!=null&&n.defer?new FF:new ka(!1),this.nodes[e]=new Bo({triggers:[d],channels:u?Object.keys(l):l,writers:[new _n(o,[Nt])],mapper:u?void 0:h=>Object.fromEntries(Object.entries(h).filter(([f])=>f in l)),bound:n==null?void 0:n.runnable,metadata:n==null?void 0:n.metadata,retryPolicy:n==null?void 0:n.retryPolicy,cachePolicy:n==null?void 0:n.cachePolicy,subgraphs:n==null?void 0:n.subgraphs,ends:n==null?void 0:n.ends})}}attachEdge(e,n){if(n!==ve){if(typeof e=="string")this.nodes[e].writers.push(new _n([{channel:`branch:to:${n}`,value:null}],[Nt]));else if(Array.isArray(e)){const r=`join:${e.join("+")}:${n}`;this.channels[r]=this.builder.nodes[n].defer?new uz(new Set(e)):new lz(new Set(e)),this.nodes[n].triggers.push(r);for(const s of e)this.nodes[s].writers.push(new _n([{channel:r,value:s}],[Nt]))}}}attachBranch(e,n,r,s={withReader:!0}){const i=async(a,o)=>{const c=a.filter(u=>u!==ve);if(!c.length)return;const l=c.map(u=>Xn(u)?u:{channel:u===ve?u:`branch:to:${u}`,value:e});await _n.doWrite({...o,tags:(o.tags??[]).concat([Nt])},l)};this.nodes[e].writers.push(r.run(i,s.withReader?a=>eB.doRead(a,this.streamChannels??this.outputChannels,!0):void 0))}async _validateInput(e){if(e==null)return e;const n=(()=>{const r=this.builder._inputRuntimeDefinition,s=this.builder._schemaRuntimeDefinition,i=a=>{if(a!=null)return this._metaRegistry.getExtendedChannelSchemas(a,{withReducerSchema:!0})};if(In(r))return i(r);if(r===lp)return Gu(i(s))})();if(Gt(e)){const r=e;return e.update&&n!=null&&(r.update=cs(n,e.update)),r}return n!=null?cs(n,e):e}isInterrupted(e){return Sx(e)}async _validateContext(e){const n=this.builder._configRuntimeSchema;return In(n)&&cs(n,e),e}};function mz(t){return typeof t=="object"&&t!==null&&!Array.isArray(t)&&Object.keys(t).length>0&&Object.values(t).every(e=>typeof e=="function"||wx(e))}function dw(t){return typeof t=="object"&&t!==null&&"lc_graph_name"in t&&t.lc_graph_name==="AnnotationRoot"}function gz(t){return typeof t=="object"&&t!==null&&t.channels!==void 0}function yz(t){return typeof t=="object"&&t!==null&&t.stateSchema!==void 0}function _z(t){return typeof t=="object"&&t!==null&&t.stateSchema===void 0&&t.input!==void 0&&t.output!==void 0}function wz(t){return!(typeof t!="object"||t==null||!("state"in t)||!In(t.state)||"input"in t&&!In(t.input)||"output"in t&&!In(t.output))}function vz(t){if(Xn(t))return[t];const e=[];Gt(t)?e.push(t):Array.isArray(t)&&e.push(...t.filter(Gt));const n=[];for(const r of e){if(r.graph===xt.PARENT)throw new _S(r);Xn(r.goto)||typeof r.goto=="string"?n.push(r.goto):Array.isArray(r.goto)&&n.push(...r.goto)}return n}function hw(){const t=new Li({func:vz,tags:[Nt],trace:!1,recurse:!1,name:"<control_branch>"});return new Vx({path:t})}const Jx="__remove_all__";function Kx(t,e){const n=Array.isArray(t)?t:[t],r=Array.isArray(e)?e:[e],s=n.map(Zr),i=r.map(Zr);for(const u of s)(u.id===null||u.id===void 0)&&(u.id=vr(),u.lc_kwargs.id=u.id);let a;for(let u=0;u<i.length;u+=1){const d=i[u];(d.id===null||d.id===void 0)&&(d.id=vr(),d.lc_kwargs.id=d.id),d.getType()==="remove"&&d.id===Jx&&(a=u)}if(a!=null)return i.slice(a+1);const o=[...s],c=new Map(o.map((u,d)=>[u.id,d])),l=new Set;for(const u of i){const d=c.get(u.id);if(d!==void 0)u.getType()==="remove"?l.add(u.id):(l.delete(u.id),o[d]=u);else{if(u.getType()==="remove")throw new Error(`Attempting to delete a message with an ID that doesn't exist ('${u.id}')`);c.set(u.id,o.length),o.push(u)}}return o.filter(u=>!l.has(u.id))}ep.Root({messages:ep({reducer:Kx,default:()=>[]})});const bz={reducer:{fn:Kx},jsonSchemaExtra:{langgraph_type:"messages"},default:()=>[]},Ez=Ve({messages:xu(Wn(),bz)}),Tz=()=>{throw new Error("interrupt() is not supported in the browser environment.")};var Sz=Object.defineProperty,Xx=(t,e)=>{for(var n in e)Sz(t,n,{get:e[n],enumerable:!0})},xz={};Xx(xz,{ConfigurableModel:()=>up,MODEL_PROVIDER_CONFIG:()=>gd,_inferModelProvider:()=>ek,getChatModelByClassName:()=>Qx,initChatModel:()=>ei});const gd={openai:{package:"@langchain/openai",className:"ChatOpenAI"},anthropic:{package:"@langchain/anthropic",className:"ChatAnthropic"},azure_openai:{package:"@langchain/openai",className:"AzureChatOpenAI"},cohere:{package:"@langchain/cohere",className:"ChatCohere"},"google-vertexai":{package:"@langchain/google-vertexai",className:"ChatVertexAI"},"google-vertexai-web":{package:"@langchain/google-vertexai-web",className:"ChatVertexAI"},"google-genai":{package:"@langchain/google-genai",className:"ChatGoogleGenerativeAI"},ollama:{package:"@langchain/ollama",className:"ChatOllama"},mistralai:{package:"@langchain/mistralai",className:"ChatMistralAI"},mistral:{package:"@langchain/mistralai",className:"ChatMistralAI"},groq:{package:"@langchain/groq",className:"ChatGroq"},cerebras:{package:"@langchain/cerebras",className:"ChatCerebras"},bedrock:{package:"@langchain/aws",className:"ChatBedrockConverse"},deepseek:{package:"@langchain/deepseek",className:"ChatDeepSeek"},xai:{package:"@langchain/xai",className:"ChatXAI"},fireworks:{package:"@langchain/community/chat_models/fireworks",className:"ChatFireworks",hasCircularDependency:!0},together:{package:"@langchain/community/chat_models/togetherai",className:"ChatTogetherAI",hasCircularDependency:!0},perplexity:{package:"@langchain/community/chat_models/perplexity",className:"ChatPerplexity",hasCircularDependency:!0}},Yx=Object.keys(gd);async function Qx(t){var r;const e=Object.entries(gd).find(([,s])=>s.className===t);if(!e)return;const[,n]=e;try{return(await import(n.package))[n.className]}catch(s){const i=s;if("code"in i&&((r=i.code)!=null&&r.toString().includes("ERR_MODULE_NOT_FOUND"))&&"message"in i){const a=i.message.split("Error: Cannot find package '")[1].split("'")[0];throw new Error(`Unable to import ${a}. Please install with \`npm install ${a}\` or \`pnpm install ${a}\``)}throw s}}async function kz(t,e,n={}){const r=e||ek(t);if(!r)throw new Error(`Unable to infer model provider for { model: ${t} }, please specify modelProvider directly.`);const s=gd[r];if(!s){const c=Yx.join(", ");throw new Error(`Unsupported { modelProvider: ${r} }.

Supported model providers are: ${c}`)}const{modelProvider:i,...a}=n,o=await Qx(s.className);return new o({model:t,...a})}function ek(t){return t.startsWith("gpt-3")||t.startsWith("gpt-4")||t.startsWith("gpt-5")||t.startsWith("o1")||t.startsWith("o3")||t.startsWith("o4")?"openai":t.startsWith("claude")?"anthropic":t.startsWith("command")?"cohere":t.startsWith("accounts/fireworks")?"fireworks":t.startsWith("gemini")?"google-vertexai":t.startsWith("amazon.")?"bedrock":t.startsWith("mistral")?"mistralai":t.startsWith("sonar")||t.startsWith("pplx")?"perplexity":void 0}var up=class Rl extends Qs{constructor(n){super(n);p(this,"lc_namespace",["langchain","chat_models"]);p(this,"_defaultConfig",{});p(this,"_configurableFields","any");p(this,"_configPrefix");p(this,"_queuedMethodOperations",{});p(this,"_modelInstanceCache",new Map);p(this,"_profile");p(this,"withStructuredOutput",(n,...r)=>{const s={...this._queuedMethodOperations};return s.withStructuredOutput=[n,...r],new Rl({defaultConfig:this._defaultConfig,configurableFields:this._configurableFields,configPrefix:this._configPrefix,queuedMethodOperations:s})});this._defaultConfig=n.defaultConfig??{},n.configurableFields==="any"?this._configurableFields="any":this._configurableFields=n.configurableFields??["model","modelProvider"],n.configPrefix?this._configPrefix=n.configPrefix.endsWith("_")?n.configPrefix:`${n.configPrefix}_`:this._configPrefix="",this._queuedMethodOperations=n.queuedMethodOperations??this._queuedMethodOperations,this._profile=n.profile??void 0}_llmType(){return"chat_model"}async _getModelInstance(n){const r=JSON.stringify(n??{}),s=this._modelInstanceCache.get(r);if(s)return s;const i={...this._defaultConfig,...this._modelParams(n)};let a=await kz(i.model,i.modelProvider,i);for(const[o,c]of Object.entries(this._queuedMethodOperations))o in a&&typeof a[o]=="function"&&(a=await a[o](...c));return this._modelInstanceCache.set(r,a),a}async _generate(n,r,s){return(await this._getModelInstance(r))._generate(n,r??{},s)}bindTools(n,r){const s={...this._queuedMethodOperations};return s.bindTools=[n,r],new Rl({defaultConfig:this._defaultConfig,configurableFields:this._configurableFields,configPrefix:this._configPrefix,queuedMethodOperations:s})}_modelParams(n){const r=(n==null?void 0:n.configurable)??{};let s={};for(const[i,a]of Object.entries(r))if(i.startsWith(this._configPrefix)){const o=this._removePrefix(i,this._configPrefix);s[o]=a}return this._configurableFields!=="any"&&(s=Object.fromEntries(Object.entries(s).filter(([i])=>this._configurableFields.includes(i)))),s}_removePrefix(n,r){return n.startsWith(r)?n.slice(r.length):n}withConfig(n){const r={...n||{}},s=this._modelParams(r),i=Object.fromEntries(Object.entries(r).filter(([o])=>o!=="configurable"));i.configurable=Object.fromEntries(Object.entries(r.configurable||{}).filter(([o])=>this._configPrefix&&!Object.keys(s).includes(this._removePrefix(o,this._configPrefix))));const a=new Rl({defaultConfig:{...this._defaultConfig,...s},configurableFields:Array.isArray(this._configurableFields)?[...this._configurableFields]:this._configurableFields,configPrefix:this._configPrefix,queuedMethodOperations:this._queuedMethodOperations});return new cn({config:r,bound:a})}async invoke(n,r){const s=await this._getModelInstance(r),i=Ze(r);return s.invoke(n,i)}async stream(n,r){const s=await this._getModelInstance(r),i=new Ys({generator:await s.stream(n,r),config:r});return await i.setup,hn.fromAsyncGenerator(i)}async batch(n,r,s){return super.batch(n,r,s)}async*transform(n,r){const s=await this._getModelInstance(r),i=Ze(r);yield*s.transform(n,i)}async*streamLog(n,r,s){const i=await this._getModelInstance(r),a=Ze(r);yield*i.streamLog(n,a,{...s,_schemaFormat:"original",includeNames:s==null?void 0:s.includeNames,includeTypes:s==null?void 0:s.includeTypes,includeTags:s==null?void 0:s.includeTags,excludeNames:s==null?void 0:s.excludeNames,excludeTypes:s==null?void 0:s.excludeTypes,excludeTags:s==null?void 0:s.excludeTags})}streamEvents(n,r,s){const i=this;async function*a(){const o=await i._getModelInstance(r),c=Ze(r),l=o.streamEvents(n,c,s);for await(const u of l)yield u}return hn.fromAsyncGenerator(a())}get profile(){if(this._profile)return this._profile;const n=JSON.stringify({}),r=this._modelInstanceCache.get(n);return(r==null?void 0:r.profile)??{}}};async function ei(t,e){let{configurableFields:n,configPrefix:r,modelProvider:s,profile:i,...a}={configPrefix:"",...e??{}};if(s===void 0&&(t!=null&&t.includes(":"))){const[u,...d]=t.split(":"),h=d.length===0?[u]:[u,d.join(":")];Yx.includes(h[0])&&([s,t]=h)}let o=Array.isArray(n)?[...n]:n;!t&&o===void 0&&(o=["model","modelProvider"]),r&&o===void 0&&console.warn(`{ configPrefix: ${r} } has been set but no fields are configurable. Set { configurableFields: [...] } to specify the model params that are configurable.`);const c={...a};let l;return o===void 0?l=new up({defaultConfig:{...c,model:t,modelProvider:s},configPrefix:r,profile:i}):(t&&(c.model=t),s&&(c.modelProvider=s),l=new up({defaultConfig:c,configPrefix:r,configurableFields:o,profile:i})),await l._getModelInstance(),l}var dp=class extends Error{constructor(){super("The provided LLM already has bound tools. Please provide an LLM without bound tools to createAgent. The agent will bind the tools provided in the 'tools' parameter.")}},hp=class extends Error{constructor(e){super(`The model has called multiple tools: ${e.join(", ")} to return a structured output. This is not supported. Please provide a single structured output.`);p(this,"toolNames");this.toolNames=e}},tk=class extends Error{constructor(e,n){super(`Failed to parse structured output for tool '${e}':${n.map(r=>`
  - ${r}`).join("")}.`);p(this,"toolName");p(this,"errors");this.toolName=e,this.errors=n}},vg=class extends Error{constructor(e,n){const r=e instanceof Error?e:new Error(String(e)),s=JSON.stringify(n.args);super(`Error invoking tool '${n.name}' with kwargs ${s} with error: ${r.stack}
 Please fix the error and try again.`);p(this,"toolCall");p(this,"toolError");this.toolCall=n,this.toolError=r}};function bg(t){return"invoke"in t&&typeof t.invoke=="function"&&"_streamResponseChunks"in t}function ku(t){return typeof t=="object"&&t!=null&&"_queuedMethodOperations"in t&&"_getModelInstance"in t&&typeof t._getModelInstance=="function"}let Iz=0;var Rs=class fp{constructor(e,n,r){this.schema=e,this.tool=n,this.options=r}get name(){return this.tool.function.name}static fromSchema(e,n){function r(o){return o??`extract-${++Iz}`}if(ar(e)){const o=bt(e),c={type:"function",function:{name:r(),strict:!1,description:o.description??"Tool for extracting structured output from the model's response.",parameters:o}};return new fp(o,c,n)}let s;typeof e.name=="string"&&typeof e.parameters=="object"&&e.parameters!=null?s=e:s={name:r(e.title),description:e.description??"",parameters:e.schema||e};const i=bt(e),a={type:"function",function:s};return new fp(i,a,n)}parse(e){const r=new lm(this.schema).validate(e);if(!r.valid)throw new tk(this.name,r.errors.map(s=>s.error));return e}},js=class nk{constructor(e,n){p(this,"_schemaType");p(this,"schema");p(this,"strict");if("schema"in e&&typeof e.schema=="object"&&e.schema!==null&&!("type"in e)){const r=e;this.schema=r.schema,this.strict=r.strict??!1}else this.schema=e,this.strict=n??!1}static fromSchema(e,n=!1){const r=bt(e);return new nk(r,n)}parse(e){let n;if(typeof e.content=="string")n=e.content;else if(Array.isArray(e.content)){for(const r of e.content)if(typeof r=="object"&&r!==null&&"type"in r&&r.type==="text"&&"text"in r&&typeof r.text=="string"){n=r.text;break}}if(!(!n||n===""))try{const r=JSON.parse(n);return new lm(this.schema).validate(r).valid?r:void 0}catch{}}};function rk(t,e,n){if(!t)return[];if(typeof t=="object"&&t!==null&&"__responseFormatUndefined"in t)return[];if(Array.isArray(t)){if(t.every(s=>s instanceof Rs||s instanceof js))return t;if(t.every(s=>In(s)))return t.map(s=>Rs.fromSchema(s,e));if(t.every(s=>typeof s=="object"&&s!==null&&!In(s)))return t.map(s=>Rs.fromSchema(s,e));throw new Error(`Invalid response format: list contains mixed types.
All items must be either InteropZodObject or plain JSON schema objects.`)}if(t instanceof Rs||t instanceof js)return[t];const r=ik(n);if(In(t))return r?[js.fromSchema(t)]:[Rs.fromSchema(t,e)];if(typeof t=="object"&&t!==null&&"properties"in t)return r?[js.fromSchema(t)]:[Rs.fromSchema(t,e)];throw new Error(`Invalid response format: ${String(t)}`)}function sk(t,e){return rk(t,e)}function Az(t){if(typeof t=="object"&&t!==null&&"schema"in t&&!ar(t)&&!("type"in t)){const{schema:e,strict:n}=t;return js.fromSchema(e,n??!1)}return js.fromSchema(t,!1)}const Cz=["ChatOpenAI","ChatXAI"],fw=["grok","gpt-5","gpt-4.1","gpt-4o","gpt-oss","o3-pro","o3-mini"];function ik(t){if(!t)return!1;if(typeof t=="string"){const n=t.split(":").pop();return fw.some(r=>n.includes(r))}if(ku(t))return ik(t._defaultConfig.model);if(!bg(t))return!1;const e=t.getName();return!!(e==="FakeToolCallingChatModel"||Cz.includes(e)&&("model"in t&&fw.some(n=>typeof t.model=="string"&&t.model.includes(n))||e==="FakeToolCallingModel"&&"structuredResponse"in t))}function Eg(t){let e=0;for(const n of t){let r;typeof n.content=="string"?r=n.content:Array.isArray(n.content)?r=n.content.map(s=>typeof s=="string"?s:s.type==="text"&&"text"in s?s.text:"").join(""):r="",le.isInstance(n)&&Array.isArray(n.tool_calls)&&n.tool_calls.length>0&&(r+=JSON.stringify(n.tool_calls)),Pe.isInstance(n)&&(r+=n.tool_call_id??""),e+=r.length}return Math.ceil(e/4)}function Ds(t){if(!(!t||typeof t=="function"))return t.canJumpTo}function yd(t){return typeof t=="function"?t:t.hook}function ak(t){return new Promise(e=>setTimeout(e,t))}function ok(t,e){const{backoffFactor:n,initialDelayMs:r,maxDelayMs:s,jitter:i}=t;let a;if(n===0?a=r:a=r*n**e,a=Math.min(a,s),i&&a>0){const o=a*.25;a=a+(Math.random()*2-1)*o,a=Math.max(0,a)}return a}const ck=Symbol("AgentMiddleware");function Ht(t){return{[ck]:!0,name:t.name,stateSchema:t.stateSchema,contextSchema:t.contextSchema,wrapToolCall:t.wrapToolCall,wrapModelCall:t.wrapModelCall,beforeAgent:t.beforeAgent,beforeModel:t.beforeModel,afterModel:t.afterModel,afterAgent:t.afterAgent,tools:t.tools??[]}}var Oz=class lk extends Qs{constructor({toolCalls:n=[],toolStyle:r="openai",index:s=0,structuredResponse:i,indexRef:a,...o}={}){super(o);p(this,"toolCalls");p(this,"toolStyle");p(this,"indexRef");p(this,"structuredResponse");p(this,"tools",[]);this.toolCalls=n,this.toolStyle=r,this.indexRef=a??{current:s},this.structuredResponse=i}get index(){return this.indexRef.current}set index(n){this.indexRef.current=n}_llmType(){return"fake-tool-calling"}_combineLLMOutput(){return[]}bindTools(n){const r=new lk({toolCalls:this.toolCalls,toolStyle:this.toolStyle,structuredResponse:this.structuredResponse,indexRef:this.indexRef});return r.tools=[...this.tools,...n],r}withStructuredOutput(n){return new Kn({func:async()=>this.structuredResponse})}async _generate(n,r,s){let a=n[n.length-1].content;n.length>1&&(a=n.map(h=>h.content).filter(Boolean).map(h=>typeof h=="string"?h:typeof h=="object"&&"text"in h?h.text:Array.isArray(h)?h.map(f=>typeof f=="string"?f:typeof f=="object"&&"text"in f?f.text:"").join("-"):JSON.stringify(h)).join("-")),(n.length===1||n.length===2&&n.every(ht.isInstance))&&this.index!==0&&(this.index=0);const c=this.toolCalls[this.index]||[],l=this.index.toString();this.index=(this.index+1)%Math.max(1,this.toolCalls.length);const u=new le({content:a,id:l,tool_calls:c.length>0?c.map(d=>({...d,type:"tool_call"})):void 0});return{generations:[{text:a,message:u}],llmOutput:{}}}};const pp=Symbol.for("langgraph-zod");pp in globalThis||(globalThis[pp]=new WeakSet);function pw(t){const e=globalThis[pp];e.has(t)||(Object.defineProperty(t,"langgraph",{get(){const n=this;return{metadata(r){return xu(n,{jsonSchemaExtra:r})},reducer(r,s){const i=Wu(n);return xu(n,{default:i,reducer:{schema:s,fn:r}})}}}}),e.add(t))}try{pw(Be.prototype),pw(Be.prototype)}catch(t){throw new Error("Failed to extend Zod with LangGraph-related methods. This is most likely a bug, consider opening an issue and/or using `withLangGraph` to augment your Zod schema.",{cause:t})}var $z=class extends rm{constructor(t){super(),this.parent=t,this._map=this.parent._map}add(t,...e){const n=e[0];if(n&&!(n!=null&&n.default)){const r=Wu(t);r!=null&&(n.default=r)}return super.add(t,...e)}};new $z(Vo);function Rz(t=!0,e,n=[]){const r={jumpTo:xr([Ur("model_request"),Ur("tools"),Ur("end"),pP()]).optional()},s=a=>{const o=it(a)?ya(a):a.shape;for(const[c,l]of Object.entries(o))c.startsWith("_")||c in r||(r[c]=it(l)?Ea():l)};e&&("shape"in e||it(e))&&s(e);for(const a of n)a.stateSchema&&s(a.stateSchema);t&&(r.structuredResponse=Ue().optional());const i=xu(Wn(),{jsonSchemaExtra:{langgraph_type:"messages"}});return{state:Ez.extend(r),input:Ve({messages:i,...Object.fromEntries(Object.entries(r).filter(([a])=>!["structuredResponse","jumpTo"].includes(a)))}),output:Ve({messages:i,...Object.fromEntries(Object.entries(r).filter(([a])=>a!=="jumpTo"))})}}const Ah=/<name>(.*?)<\/name>/s,Ch=/<content>(.*?)<\/content>/s;function Nz(t){if(!le.isInstance(t)||dn.isInstance(t)||!t.name)return t;const{name:e}=t;if(typeof t.content=="string")return new le({...t.lc_kwargs,content:`<name>${e}</name><content>${t.content}</content>`,name:void 0});const n=[];let r=0;for(const s of t.content)typeof s=="string"?(r+=1,n.push(`<name>${e}</name><content>${s}</content>`)):typeof s=="object"&&"type"in s&&s.type==="text"?(r+=1,n.push({...s,text:`<name>${e}</name><content>${s.text}</content>`})):n.push(s);return r||n.unshift({type:"text",text:`<name>${e}</name><content></content>`}),new le({...t.lc_kwargs,content:n,name:void 0})}function Pz(t){if(!le.isInstance(t)||!t.content)return t;let e=[],n;if(Array.isArray(t.content))e=t.content.filter(r=>{if(r.type==="text"&&typeof r.text=="string"){const s=r.text.match(Ah),i=r.text.match(Ch);return s&&(!i||i[1]==="")?(n=s[1],!1):!0}return!0}).map(r=>{if(r.type==="text"&&typeof r.text=="string"){const s=r.text.match(Ah),i=r.text.match(Ch);return!s||!i?r:(n=s[1],{...r,text:i[1]})}return r});else{const r=t.content,s=r.match(Ah),i=r.match(Ch);if(!s||!i)return t;n=s[1],e=i[1]}return new le({...Object.keys(t.lc_kwargs??{}).length>0?t.lc_kwargs:t,content:e,name:n})}function ui(t){return Fe.isRunnable(t)}function mw(t){return bg(t)?"bindTools"in t&&typeof t.bindTools=="function":!1}const Oh=(t,e,n={})=>{if(mw(t))return t.bindTools(e,n);if(cn.isRunnableBinding(t)&&mw(t.bound)){const r=t.bound.bindTools(e,n);return cn.isRunnableBinding(r)?new cn({bound:r.bound,config:{...t.config,...r.config},kwargs:{...t.kwargs,...r.kwargs},configFactories:r.configFactories??t.configFactories}):new cn({bound:r,config:t.config,kwargs:t.kwargs,configFactories:t.configFactories})}return null};function uk(t){if(typeof t=="function")return;let e=t;if(Jn.isRunnableSequence(e)&&(e=e.steps.find(n=>cn.isRunnableBinding(n))||e),!ku(e)){if(cn.isRunnableBinding(e)){const n=e.kwargs!=null&&typeof e.kwargs=="object"&&"tools"in e.kwargs&&Array.isArray(e.kwargs.tools)&&e.kwargs.tools.length>0,r=e.config!=null&&typeof e.config=="object"&&"tools"in e.config&&Array.isArray(e.config.tools)&&e.config.tools.length>0;if(n||r)throw new dp}if("tools"in e&&e.tools!==void 0&&Array.isArray(e.tools)&&e.tools.length>0)throw new dp}}function mp(t){return!!(le.isInstance(t)&&t.tool_calls&&t.tool_calls.length>0)}function Mz(t){if(t==null)return new kt("");if(kt.isInstance(t))return t;if(typeof t=="string")return new kt({content:[{type:"text",text:t}]});throw new Error(`Invalid systemPrompt type: expected string or SystemMessage, got ${typeof t}`)}async function Lz(t,e,n={}){const r=Oh(t,e,n);if(r)return r;if(ku(t)){const s=Oh(await t._getModelInstance(),e,n);if(s)return s}if(Jn.isRunnableSequence(t)){const s=t.steps.findIndex(i=>cn.isRunnableBinding(i)||bg(i)||ku(i));if(s>=0){const i=Oh(t.steps[s],e,n);if(i){const a=t.steps.slice();return a.splice(s,1,i),Jn.from(a)}}}throw new Error(`llm ${t} must define bindTools method.`)}function jz(t){if(t.length===0)return;if(t.length===1)return t[0];function e(r,s){return async(i,a)=>r(i,async()=>s(i,async()=>a(i)))}let n=t[t.length-1];for(let r=t.length-2;r>=0;r--)n=e(t[r],n);return n}function Dz(t){const e=t.filter(n=>n.wrapToolCall);if(e.length!==0)return jz(e.map(n=>{const r=n.wrapToolCall;return async(i,a)=>{try{const o=await r({...i,state:{messages:i.state.messages,...n.stateSchema?cs(n.stateSchema,{...i.state}):{}}},a);if(!Pe.isInstance(o)&&!Gt(o))throw new Error(`Invalid response from "wrapToolCall" in middleware "${n.name}": expected ToolMessage or Command, got ${typeof o}`);return o}catch(o){throw o instanceof Error&&!o.message.includes(`middleware "${n.name}"`)&&(o.message=`Error in middleware "${n.name}": ${o.message}`),o}}}))}async function Uz(t,e){var r;const n={};for(const s of t){if(!s.stateSchema)continue;const i=e0(s.stateSchema,c=>c.startsWith("_")),a=await sm(i,e);if(a.success){Object.assign(n,a.data);continue}const o=a.error.issues.filter(c=>c.code==="invalid_type"&&c.message==="Required").map(c=>`  - ${c.path.join(".")}: ${c.message}`).join(`
`);throw new Error(`Middleware "${s.name}" has required state fields that must be initialized:
${o}

To fix this, either:
1. Provide default values in your middleware's state schema using .default():
   stateSchema: z.object({
     myField: z.string().default("default value")
   })

2. Or make the fields optional using .optional():
   stateSchema: z.object({
     myField: z.string().optional()
   })

3. Or ensure you pass these values when invoking the agent:
   agent.invoke({
     messages: [...],
     ${(r=a.error.issues[0])==null?void 0:r.path.join(".")}: "value"
   })`)}return n}function Fz(t){const e={messages:Wn(()=>[]),structuredResponse:Ea().optional()};if(!t)return Ve(e);const{shape:n}=t,r={...e};for(const[s,i]of Object.entries(n))s.startsWith("_")?r[s]=i.optional():r[s]=i;return Ve(r)}function Yr(t){if(t){if(["model_request","tools",ve].includes(t))return t;if(t==="model")return"model_request";if(t==="tools")return"tools";if(t==="end")return ve;throw new Error(`Invalid jump target: ${t}, must be "model", "tools" or "end".`)}}function dk(...t){return AbortSignal.any(t.filter(e=>e!=null&&typeof e=="object"&&"aborted"in e&&typeof e.aborted=="boolean"))}var yi,Iw,Tg=(Iw=class extends Fe{constructor(e){super();p(this,"lc_namespace",["langgraph"]);p(this,"func");p(this,"tags");p(this,"config");p(this,"trace",!0);p(this,"recurse",!0);rn(this,yi);this.name=e.name??e.func.name,this.func=e.func,this.config=e.tags?{tags:e.tags}:void 0,this.recurse=e.recurse??this.recurse}getState(){return he(this,yi)}setState(e){En(this,yi,{...he(this,yi),...e})}async invoke(e,n){const r=Zn(this.config,n),s=await Ft.runWithConfig(r,async()=>this.func(e,r));return Fe.isRunnable(s)&&this.recurse?await Ft.runWithConfig(r,async()=>s.invoke(e,r)):(En(this,yi,s),s)}},yi=new WeakMap,Iw);function Bz(t,e){let n,r;if(e==="inline")n=Nz,r=Pz;else throw new Error(`Invalid agent name mode: ${e}. Needs to be one of: "inline"`);function s(i){return i.map(n)}return Jn.from([Kn.from(s),t,Kn.from(r)])}function zz(t){return le.isInstance(t)||typeof t=="object"&&t!==null&&"structuredResponse"in t&&"messages"in t}const St="model_request";var Ot,qo,an,It,hk,fk,pk,mk,gk,yk,gp,_k,wk,Aw,Zz=(Aw=class extends Tg{constructor(e){super({name:e.name??"model",func:(n,r)=>We(this,It,fk).call(this,n,r)});rn(this,It);rn(this,Ot);rn(this,qo);rn(this,an);En(this,Ot,e),En(this,qo,e.systemMessage)}getState(){const e=super.getState(),n=e&&!(e instanceof xt)?e:{};return{messages:[],...n}}},Ot=new WeakMap,qo=new WeakMap,an=new WeakMap,It=new WeakSet,hk=function(e){if(!he(this,Ot).responseFormat)return;const n=rk(he(this,Ot).responseFormat,void 0,e);return n.every(s=>s instanceof js)?{type:"native",strategy:n[0]}:{type:"tool",tools:n.filter(s=>s instanceof Rs).reduce((s,i)=>(s[i.name]=i,s),{})}},fk=async function(e,n){const r=e.messages.at(-1);if(r&&Pe.isInstance(r)&&r.name&&he(this,Ot).shouldReturnDirect.has(r.name))return{messages:[]};const s=await We(this,It,mk).call(this,e,n);return"structuredResponse"in s?{messages:[...e.messages,...s.messages||[]],structuredResponse:s.structuredResponse}:s instanceof xt?s:(s.name=this.name,s.lc_kwargs.name=this.name,We(this,It,_k).call(this,e,s)?{messages:[new le({content:"Sorry, need more steps to process this request.",name:this.name,id:s.id})]}:{messages:[s]})},pk=function(){if(typeof he(this,Ot).model=="string")return ei(he(this,Ot).model);if(he(this,Ot).model)return he(this,Ot).model;throw new Error("No model option was provided, either via `model` option.")},mk=async function(e,n,r={}){var u;const s=await We(this,It,pk).call(this),i=n,a=async d=>{var T;uk(d.model);const h=We(this,It,hk).call(this,d.model),f=await We(this,It,wk).call(this,d.model,d,h),m=[...he(this,an).text===""?[]:[he(this,an)],...d.messages],g=dk(he(this,Ot).signal,n.signal),w=await Hr(f.invoke(m,{...n,signal:g}),g);if((h==null?void 0:h.type)==="native"){const A=h.strategy.parse(w);return A?{structuredResponse:A,messages:[w]}:w}if(!h||!w.tool_calls)return w;const b=w.tool_calls.filter(A=>A.name in h.tools);if(b.length===0)return w;if(b.length>1)return We(this,It,gk).call(this,w,b,h);const y=h.tools[b[0].name],v=(T=y==null?void 0:y.options)==null?void 0:T.toolMessageContent;return We(this,It,yk).call(this,w,b[0],h,v??r.lastMessage)},o=he(this,Ot).wrapModelCallHookMiddleware??[];let c=a;for(let d=o.length-1;d>=0;d--){const[h,f]=o[d];if(h.wrapModelCall){const m=c,g=h,w=f;c=async b=>{const y=g.contextSchema?cs(g.contextSchema,(i==null?void 0:i.context)||{}):i==null?void 0:i.context,v=Object.freeze({context:y,writer:i.writer,interrupt:i.interrupt,signal:i.signal}),T={...b,state:{...h.stateSchema?cs(Gu(h.stateSchema),e):{},...w(),messages:e.messages},runtime:v},A=async I=>{const $=I.tools??[],S=$.filter(ne=>ui(ne)&&!he(this,Ot).toolClasses.some(B=>B.name===ne.name));if(S.length>0)throw new Error(`You have added a new tool in "wrapModelCall" hook of middleware "${g.name}": ${S.map(ne=>ne.name).join(", ")}. This is not supported.`);const M=$.filter(ne=>ui(ne)&&he(this,Ot).toolClasses.every(B=>B!==ne));if(M.length>0)throw new Error(`You have modified a tool in "wrapModelCall" hook of middleware "${g.name}": ${M.map(ne=>ne.name).join(", ")}. This is not supported.`);let j=I;const P=I.systemPrompt!==he(this,an).text,W=I.systemMessage!==he(this,an);if(P&&W)throw new Error("Cannot change both systemPrompt and systemMessage in the same request.");return P&&(En(this,an,new kt({content:[{type:"text",text:I.systemPrompt}]})),j={...I,systemPrompt:he(this,an).text,systemMessage:he(this,an)}),W&&(En(this,an,new kt({...I.systemMessage})),j={...I,systemPrompt:he(this,an).text,systemMessage:he(this,an)}),m(j)};if(!g.wrapModelCall)return A(T);try{const I=await g.wrapModelCall(T,A);if(!zz(I))throw new Error(`Invalid response from "wrapModelCall" in middleware "${g.name}": expected AIMessage, got ${typeof I}`);return I}catch(I){throw I instanceof Error&&!I.message.includes(`middleware "${g.name}"`)&&(I.message=`Error in middleware "${g.name}": ${I.message}`),I}}}}En(this,an,he(this,qo));const l={model:s,systemPrompt:(u=he(this,an))==null?void 0:u.text,systemMessage:he(this,an),messages:e.messages,tools:he(this,Ot).toolClasses,state:e,runtime:Object.freeze({context:i==null?void 0:i.context,writer:i.writer,interrupt:i.interrupt,signal:i.signal})};return c(l)},gk=function(e,n,r){const s=new hp(n.map(i=>i.name));return We(this,It,gp).call(this,s,e,n[0],r)},yk=function(e,n,r,s){const i=r.tools[n.name];try{const a=i.parse(n.args);return{structuredResponse:a,messages:[e,new Pe({tool_call_id:n.id??"",content:JSON.stringify(a),name:n.name}),new le(s??`Returning structured response: ${JSON.stringify(a)}`)]}}catch(a){return We(this,It,gp).call(this,a,e,n,r)}},gp=async function(e,n,r,s){var o,c;const i=(c=(o=Object.values(s.tools).at(0))==null?void 0:o.options)==null?void 0:c.handleError,a=r.id;if(!a)throw new Error("Tool call ID is required to handle tool output errors. Please provide a tool call ID.");if(i===!1)throw e;if(i===void 0||typeof i=="boolean"&&i||Array.isArray(i)&&i.some(l=>l instanceof hp))return new xt({update:{messages:[n,new Pe({content:e.message,tool_call_id:a})]},goto:St});if(typeof i=="string")return new xt({update:{messages:[n,new Pe({content:i,tool_call_id:a})]},goto:St});if(typeof i=="function"){const l=await i(e);if(typeof l!="string")throw new Error("Error handler must return a string.");return new xt({update:{messages:[n,new Pe({content:l,tool_call_id:a})]},goto:St})}return new xt({update:{messages:[n,new Pe({content:e.message,tool_call_id:a})]},goto:St})},_k=function(e,n){var i;const r=le.isInstance(n)&&((i=n.tool_calls)==null?void 0:i.every(a=>he(this,Ot).shouldReturnDirect.has(a.name))),s="remainingSteps"in e?e.remainingSteps:void 0;return!!(s&&(s<1&&r||s<2&&mp(e.messages.at(-1))))},wk=async function(e,n,r){var u,d,h;const s={},i=Object.values(r&&"tools"in r?r.tools:{}),a=[...(n==null?void 0:n.tools)??he(this,Ot).toolClasses,...i.map(f=>f.tool)],o=(n==null?void 0:n.toolChoice)||(i.length>0?"any":void 0);if((r==null?void 0:r.type)==="native"){const f=((u=n==null?void 0:n.modelSettings)==null?void 0:u.strict)??((d=r==null?void 0:r.strategy)==null?void 0:d.strict)??!0,m={name:((h=r.strategy.schema)==null?void 0:h.name)??"extract",description:ki(r.strategy.schema),schema:r.strategy.schema,strict:f};Object.assign(s,{response_format:{type:"json_schema",json_schema:m},output_format:{type:"json_schema",schema:r.strategy.schema},headers:{"anthropic-beta":"structured-outputs-2025-11-13"},ls_structured_output_format:{kwargs:{method:"json_schema"},schema:r.strategy.schema},strict:f})}const c=await Lz(e,a,{...s,...(n==null?void 0:n.modelSettings)??{},tool_choice:o});return he(this,Ot).includeAgentName==="inline"?Bz(c,he(this,Ot).includeAgentName):c},Aw);const mt="tools",vk=t=>Array.isArray(t)&&t.every(Cn.isInstance),Vz=t=>typeof t=="object"&&t!=null&&"messages"in t&&vk(t.messages),Gz=t=>typeof t=="object"&&t!=null&&"lg_tool_call"in t;function Wz(t,e){return t instanceof vg?new Pe({content:t.message,tool_call_id:e.id,name:e.name}):new Pe({content:`${t}
 Please fix your mistakes.`,tool_call_id:e.id,name:e.name})}var Jo,yp,Cw,Hz=(Cw=class extends Tg{constructor(e,n){const{name:r,tags:s,handleToolErrors:i,signal:a,wrapToolCall:o}=n??{};super({name:r,tags:s,func:(c,l)=>this.run(c,l)});rn(this,Jo);p(this,"tools");p(this,"trace",!1);p(this,"signal");p(this,"handleToolErrors",Wz);p(this,"wrapToolCall");this.options=n,this.tools=e,this.handleToolErrors=i??this.handleToolErrors,this.signal=a,this.wrapToolCall=o}async runTool(e,n,r){const s=async l=>{var h,f;const{toolCall:u}=l,d=this.tools.find(m=>m.name===u.name);if(d===void 0)throw new Error(`Tool "${u.name}" not found.`);try{const m=await d.invoke({...u,type:"tool_call"},{...n,config:n,toolCallId:u.id,state:(f=(h=n.configurable)==null?void 0:h.__pregel_scratchpad)==null?void 0:f.currentTaskInput,signal:dk(this.signal,n.signal)});return Pe.isInstance(m)||Gt(m)?m:new Pe({name:d.name,content:typeof m=="string"?m:JSON.stringify(m),tool_call_id:u.id})}catch(m){throw m instanceof bo?new vg(m,u):m}},i=n,a={context:i==null?void 0:i.context,writer:i==null?void 0:i.writer,interrupt:i==null?void 0:i.interrupt,signal:i==null?void 0:i.signal},o=this.tools.find(l=>l.name===e.name);if(!o)throw new Error(`Tool "${e.name}" not found.`);const c={toolCall:e,tool:o,state:r,runtime:a};if(this.wrapToolCall)try{return await this.wrapToolCall(c,s)}catch(l){return We(this,Jo,yp).call(this,l,e,!0)}try{return await s(c)}catch(l){return We(this,Jo,yp).call(this,l,e,!1)}}async run(e,n){var a;let r;if(Gz(e)){const{lg_tool_call:o,jumpTo:c,...l}=e;r=[await this.runTool(e.lg_tool_call,n,l)]}else{let o;if(vk(e))o=e;else if(Vz(e))o=e.messages;else throw new Error("ToolNode only accepts BaseMessage[] or { messages: BaseMessage[] } as input.");const c=new Set(o.filter(u=>u.getType()==="tool").map(u=>u.tool_call_id));let l;for(let u=o.length-1;u>=0;u-=1){const d=o[u];if(le.isInstance(d)){l=d;break}}if(!le.isInstance(l))throw new Error("ToolNode only accepts AIMessages as input.");r=await Promise.all(((a=l.tool_calls)==null?void 0:a.filter(u=>u.id==null||!c.has(u.id)).map(u=>this.runTool(u,n,e)))??[])}if(!r.some(Gt))return Array.isArray(e)?r:{messages:r};const s=[];let i=null;for(const o of r)Gt(o)?o.graph===xt.PARENT&&Array.isArray(o.goto)&&o.goto.every(c=>qz(c))?i?i.goto.push(...o.goto):i=new xt({graph:xt.PARENT,goto:o.goto}):s.push(o):s.push(Array.isArray(e)?[o]:{messages:[o]});return i&&s.push(i),s}},Jo=new WeakSet,yp=function(e,n,r){var s;if(mi(e)||(s=this.signal)!=null&&s.aborted||r&&this.handleToolErrors!==!0||!this.handleToolErrors)throw e;if(typeof this.handleToolErrors=="function"){const i=this.handleToolErrors(e,n);if(i&&Pe.isInstance(i))return i;throw e}else if(this.handleToolErrors)return new Pe({name:n.name,content:`${e}
 Please fix your mistakes.`,tool_call_id:n.id});throw e},Cw);function qz(t){return t instanceof yn}var Jz=class{},Kz=class{},Ko,Ow,_d=(Ow=class extends Tg{constructor(e,n){super(e);rn(this,Ko);En(this,Ko,n)}async invokeMiddleware(e,n){var l,u,d,h,f;let r={};if(this.middleware.contextSchema){const m=(l=this.middleware.contextSchema)==null?void 0:l.shape;if(m){const g={},w=(n==null?void 0:n.context)||{};for(const b of Object.keys(m))b in w&&(g[b]=w[b]);r=cs(this.middleware.contextSchema,g)}}const s={...he(this,Ko).getState(),...e,messages:e.messages},i={context:r,writer:n==null?void 0:n.writer,interrupt:n==null?void 0:n.interrupt,signal:n==null?void 0:n.signal},a=await this.runHook(s,Object.freeze(Object.assign(new Kz,{...i,context:Object.freeze(Object.assign(new Jz,r))})));if(!a)return{...s,jumpTo:void 0};let o,c;if((u=this.name)!=null&&u.startsWith("BeforeAgentNode_")?(o=Ds(this.middleware.beforeAgent),c="beforeAgent.canJumpTo"):(d=this.name)!=null&&d.startsWith("BeforeModelNode_")?(o=Ds(this.middleware.beforeModel),c="beforeModel.canJumpTo"):(h=this.name)!=null&&h.startsWith("AfterAgentNode_")?(o=Ds(this.middleware.afterAgent),c="afterAgent.canJumpTo"):(f=this.name)!=null&&f.startsWith("AfterModelNode_")&&(o=Ds(this.middleware.afterModel),c="afterModel.canJumpTo"),typeof a.jumpTo=="string"&&!(o!=null&&o.includes(a.jumpTo))){const m=o&&o.length>0?`must be one of: ${o==null?void 0:o.join(", ")}.`:c?`no ${c} defined in middleware ${this.middleware.name}`:"";throw new Error(`Invalid jump target: ${a.jumpTo}, ${m}.`)}if(typeof a=="object"&&"type"in a){if(a.type==="terminate"){if(a.error)throw a.error;return{...s,...a.result||{},jumpTo:a.jumpTo}}throw new Error(`Invalid control action: ${JSON.stringify(a)}`)}return{...s,...a,jumpTo:a.jumpTo}}get nodeOptions(){return{input:Fz(this.middleware.stateSchema)}}},Ko=new WeakMap,Ow),Xz=class extends _d{constructor(e,n){super({name:`BeforeAgentNode_${e.name}`,func:async(r,s)=>this.invokeMiddleware(r,s)},n);p(this,"lc_namespace",["langchain","agents","beforeAgentNodes"]);this.middleware=e}runHook(e,n){return yd(this.middleware.beforeAgent)(e,n)}},Yz=class extends _d{constructor(e,n){super({name:`BeforeModelNode_${e.name}`,func:async(r,s)=>this.invokeMiddleware(r,s)},n);p(this,"lc_namespace",["langchain","agents","beforeModelNodes"]);this.middleware=e}runHook(e,n){return yd(this.middleware.beforeModel)(e,n)}},Qz=class extends _d{constructor(e,n){super({name:`AfterModelNode_${e.name}`,func:async(r,s)=>this.invokeMiddleware(r,s)},n);p(this,"lc_namespace",["langchain","agents","afterModelNodes"]);this.middleware=e}runHook(e,n){return yd(this.middleware.afterModel)(e,n)}},e3=class extends _d{constructor(e,n){super({name:`AfterAgentNode_${e.name}`,func:async(r,s)=>this.invokeMiddleware(r,s)},n);p(this,"lc_namespace",["langchain","agents","afterAgentNodes"]);this.middleware=e}runHook(e,n){return yd(this.middleware.afterAgent)(e,n)}},da,$w,t3=($w=class{constructor(){rn(this,da,new Map)}addNode(t,e){he(this,da).set(t.name,[...he(this,da).get(t.name)??[],e])}getState(t){const n=(he(this,da).get(t)??[]).reduce((r,s)=>({...r,...s.getState()??{}}),{});return delete n.jumpTo,n}},da=new WeakMap,$w),Vt,ha,Xo,nr,Et,_p,bk,Ek,Tk,Nl,Sk,xk,wp,Rw,n3=(Rw=class{constructor(t){rn(this,Et);rn(this,Vt);rn(this,ha,"v2");rn(this,Xo);rn(this,nr,new t3);var A;if(this.options=t,En(this,ha,t.version??he(this,ha)),!t.model)throw new Error("`model` option is required to create an agent.");typeof t.model!="string"&&uk(t.model);const e=((A=this.options.middleware)==null?void 0:A.filter(I=>I.tools).flatMap(I=>I.tools))??[],n=[...t.tools??[],...e],r=new Set(n.filter(ui).filter(I=>"returnDirect"in I&&I.returnDirect).map(I=>I.name)),{state:s,input:i,output:a}=Rz(this.options.responseFormat!==void 0,this.options.stateSchema,this.options.middleware),c=new qx({state:s,input:i,output:a},this.options.contextSchema),l=[],u=[],d=[],h=[],f=[];En(this,Xo,new Zz({model:this.options.model,systemMessage:Mz(this.options.systemPrompt),includeAgentName:this.options.includeAgentName,name:this.options.name,responseFormat:this.options.responseFormat,middleware:this.options.middleware,toolClasses:n,shouldReturnDirect:r,signal:this.options.signal,wrapModelCallHookMiddleware:f}));const m=new Set,g=this.options.middleware??[];for(let I=0;I<g.length;I++){let $,S,M,j;const P=g[I];if(m.has(P.name))throw new Error(`Middleware ${P.name} is defined multiple times`);if(m.add(P.name),P.beforeAgent){$=new Xz(P,{getState:()=>he(this,nr).getState(P.name)}),he(this,nr).addNode(P,$);const W=`${P.name}.before_agent`;l.push({index:I,name:W,allowed:Ds(P.beforeAgent)}),c.addNode(W,$,$.nodeOptions)}if(P.beforeModel){S=new Yz(P,{getState:()=>he(this,nr).getState(P.name)}),he(this,nr).addNode(P,S);const W=`${P.name}.before_model`;u.push({index:I,name:W,allowed:Ds(P.beforeModel)}),c.addNode(W,S,S.nodeOptions)}if(P.afterModel){M=new Qz(P,{getState:()=>he(this,nr).getState(P.name)}),he(this,nr).addNode(P,M);const W=`${P.name}.after_model`;d.push({index:I,name:W,allowed:Ds(P.afterModel)}),c.addNode(W,M,M.nodeOptions)}if(P.afterAgent){j=new e3(P,{getState:()=>he(this,nr).getState(P.name)}),he(this,nr).addNode(P,j);const W=`${P.name}.after_agent`;h.push({index:I,name:W,allowed:Ds(P.afterAgent)}),c.addNode(W,j,j.nodeOptions)}P.wrapModelCall&&f.push([P,()=>he(this,nr).getState(P.name)])}if(c.addNode(St,he(this,Xo)),n.filter(ui).length>0){const I=new Hz(n.filter(ui),{signal:this.options.signal,wrapToolCall:Dz(g)});c.addNode(mt,I)}let w;l.length>0?w=l[0].name:u.length>0?w=u[0].name:w=St;const b=u.length>0?u[0].name:St,y=h.length>0?h[h.length-1].name:ve;c.addEdge(et,w);const v=n.filter(ui);for(let I=0;I<l.length;I++){const $=l[I],S=$.name,j=I===l.length-1?b:l[I+1].name;if($.allowed&&$.allowed.length>0){const P=v.length>0,W=$.allowed.map(B=>Yr(B)).filter(B=>B!==mt||P),ne=Array.from(new Set([j,...W.map(B=>B===ve?y:B)]));c.addConditionalEdges(S,We(this,Et,Sk).call(this,v,j,y),ne)}else c.addEdge(S,j)}for(let I=0;I<u.length;I++){const $=u[I],S=$.name,j=I===u.length-1?St:u[I+1].name;if($.allowed&&$.allowed.length>0){const P=v.length>0,W=$.allowed.map(B=>Yr(B)).filter(B=>B!==mt||P),ne=Array.from(new Set([j,...W]));c.addConditionalEdges(S,We(this,Et,xk).call(this,v,j),ne)}else c.addEdge(S,j)}const T=d.at(-1);if(d.length>0&&T)c.addEdge(St,T.name);else{const $=We(this,Et,_p).call(this,v).map(S=>S===ve?y:S);$.length===1?c.addEdge(St,$[0]):c.addConditionalEdges(St,We(this,Et,Ek).call(this,y),$)}for(let I=d.length-1;I>0;I--){const $=d[I],S=$.name,M=d[I-1].name;if($.allowed&&$.allowed.length>0){const j=v.length>0,P=$.allowed.map(ne=>Yr(ne)).filter(ne=>ne!==mt||j),W=Array.from(new Set([M,...P]));c.addConditionalEdges(S,We(this,Et,Nl).call(this,v,$.allowed,M),W)}else c.addEdge(S,M)}if(d.length>0){const I=d[0],$=I.name,S=We(this,Et,_p).call(this,v,!0).filter(P=>P!==mt||n.filter(ui).length>0),M=!!(I.allowed&&I.allowed.length>0),j=S.map(P=>P===ve?y:P);c.addConditionalEdges($,We(this,Et,Tk).call(this,v,M,y),j)}for(let I=h.length-1;I>0;I--){const $=h[I],S=$.name,M=h[I-1].name;if($.allowed&&$.allowed.length>0){const j=v.length>0,P=$.allowed.map(ne=>Yr(ne)).filter(ne=>ne!==mt||j),W=Array.from(new Set([M,...P]));c.addConditionalEdges(S,We(this,Et,Nl).call(this,v,$.allowed,M),W)}else c.addEdge(S,M)}if(h.length>0){const I=h[0],$=I.name;if(I.allowed&&I.allowed.length>0){const S=v.length>0,M=I.allowed.map(P=>Yr(P)).filter(P=>P!==mt||S),j=Array.from(new Set([ve,...M]));c.addConditionalEdges($,We(this,Et,Nl).call(this,v,I.allowed,ve),j)}else c.addEdge($,ve)}if(v.length>0){const I=b;r.size>0?c.addConditionalEdges(mt,We(this,Et,bk).call(this,r,y),[I,y]):c.addEdge(mt,I)}En(this,Vt,c.compile({checkpointer:this.options.checkpointer,store:this.options.store,name:this.options.name,description:this.options.description}))}get graph(){return he(this,Vt)}async invoke(t,e){const n=await We(this,Et,wp).call(this,t,e);return he(this,Vt).invoke(n,e)}async stream(t,e){const n=await We(this,Et,wp).call(this,t,e);return he(this,Vt).stream(n,e)}async drawMermaidPng(t){const r=await(await(await he(this,Vt).getGraphAsync()).drawMermaidPng(t)).arrayBuffer();return new Uint8Array(r)}async drawMermaid(t){return(await he(this,Vt).getGraphAsync()).drawMermaid(t)}streamEvents(t,e,n){return he(this,Vt).streamEvents(t,{...e,version:(e==null?void 0:e.version)??"v2"},n)}getGraphAsync(t){return he(this,Vt).getGraphAsync(t)}getState(t,e){return he(this,Vt).getState(t,e)}getStateHistory(t,e){return he(this,Vt).getStateHistory(t,e)}getSubgraphs(t,e){return he(this,Vt).getSubgraphs(t,e)}getSubgraphAsync(t,e){return he(this,Vt).getSubgraphsAsync(t,e)}updateState(t,e,n){return he(this,Vt).updateState(t,e,n)}get builder(){return he(this,Vt).builder}},Vt=new WeakMap,ha=new WeakMap,Xo=new WeakMap,nr=new WeakMap,Et=new WeakSet,_p=function(t,e=!1){const n=[];return t.length>0&&n.push(mt),e&&n.push(St),n.push(ve),n},bk=function(t,e){return n=>{const s=n.messages,i=s[s.length-1];return Pe.isInstance(i)&&i.name&&t.has(i.name)?this.options.responseFormat?St:e:St}},Ek=function(t=ve){return e=>{const s=e.messages.at(-1);if(!le.isInstance(s)||!s.tool_calls||s.tool_calls.length===0||s.tool_calls.every(o=>o.name.startsWith("extract-")))return t;if(he(this,ha)==="v1")return mt;const a=s.tool_calls.filter(o=>!o.name.startsWith("extract-"));return a.length===0?t:a.map(o=>new yn(mt,{...e,lg_tool_call:o}))}},Tk=function(t,e,n){const r=!!this.options.responseFormat;return s=>{var m,g;const i=s,a=i.messages,o=a.at(-1);if(le.isInstance(o)&&(!o.tool_calls||o.tool_calls.length===0))return n;if(e&&i.jumpTo)return i.jumpTo===ve?n:i.jumpTo===mt?t.length===0?n:new yn(mt,{...s,jumpTo:void 0}):new yn(St,{...s,jumpTo:void 0});const c=a.filter(Pe.isInstance),l=a.filter(le.isInstance).at(-1),u=(m=l==null?void 0:l.tool_calls)==null?void 0:m.filter(w=>!c.some(b=>b.tool_call_id===w.id));if(u&&u.length>0)return u.map(w=>new yn(mt,{...s,lg_tool_call:w}));const d=(g=l==null?void 0:l.tool_calls)==null?void 0:g.some(w=>w.name.startsWith("extract-"));if(u&&u.length===0&&!d&&r)return St;if(!le.isInstance(o)||!o.tool_calls||o.tool_calls.length===0)return n;const h=o.tool_calls.every(w=>w.name.startsWith("extract-")),f=o.tool_calls.some(w=>!w.name.startsWith("extract-"));return h||!f?n:mt}},Nl=function(t,e,n){const r=new Set(e.map(s=>Yr(s)));return s=>{const i=s;if(i.jumpTo){const a=Yr(i.jumpTo);if(a===ve&&r.has(ve))return ve;if(a===mt&&r.has(mt))return t.length===0?ve:new yn(mt,{...s,jumpTo:void 0});if(a===St&&r.has(St))return new yn(St,{...s,jumpTo:void 0})}return n}},Sk=function(t,e,n){return r=>{const s=r;if(!s.jumpTo)return e;const i=Yr(s.jumpTo);return i===ve?n:i===mt?t.length===0?n:new yn(mt,{...r,jumpTo:void 0}):new yn(St,{...r,jumpTo:void 0})}},xk=function(t,e){return n=>{const r=n;if(!r.jumpTo)return e;const s=Yr(r.jumpTo);return s===ve?ve:s===mt?t.length===0?ve:new yn(mt,{...n,jumpTo:void 0}):new yn(St,{...n,jumpTo:void 0})}},wp=async function(t,e){if(!this.options.middleware||this.options.middleware.length===0||t instanceof xt||!t)return t;const n=await Uz(this.options.middleware,t),s={...(await he(this,Vt).getState(e).catch(()=>({values:{}}))).values,...t};if(!s)return s;for(const[i,a]of Object.entries(n))i in s||(s[i]=a);return s},Rw);function kk(t){return new n3(t)}const r3=cc().args(Wn(),Wn(),Wn()).returns(xr([Ue(),o0(Ue())])),Ik=["approve","edit","reject"],s3=Ii(Ik),i3=Ve({allowedDecisions:$n(s3),description:xr([Ue(),r3]).optional(),argsSchema:Po(Ea()).optional()}),gw=Ve({interruptOn:Po(xr([Zs(),i3])).optional(),descriptionPrefix:Ue().default("Tool execution requires approval")});function a3(t){const e=async(r,s,i,a)=>{const o=r.name,c=r.args,l=s.description;let u;typeof l=="function"?u=await l(r,i,a):l!==void 0?u=l:u=`${t.descriptionPrefix??"Tool execution requires approval"}

Tool: ${o}
Args: ${JSON.stringify(c,null,2)}`;const d={name:o,args:c,description:u},h={actionName:o,allowedDecisions:s.allowedDecisions};return s.argsSchema&&(h.argsSchema=s.argsSchema),{actionRequest:d,reviewConfig:h}},n=(r,s,i)=>{const a=i.allowedDecisions;if(r.type==="approve"&&a.includes("approve"))return{revisedToolCall:s,toolMessage:null};if(r.type==="edit"&&a.includes("edit")){const c=r.editedAction;if(!c||typeof c.name!="string")throw new Error(`Invalid edited action for tool "${s.name}": name must be a string`);if(!c.args||typeof c.args!="object")throw new Error(`Invalid edited action for tool "${s.name}": args must be an object`);return{revisedToolCall:{type:"tool_call",name:c.name,args:c.args,id:s.id},toolMessage:null}}if(r.type==="reject"&&a.includes("reject")){if(r.message!==void 0&&typeof r.message!="string")throw new Error(`Tool call response for "${s.name}" must be a string, got ${typeof r.message}`);const c=r.message??`User rejected the tool call for \`${s.name}\` with id ${s.id}`,l=new Pe({content:c,name:s.name,tool_call_id:s.id,status:"error"});return{revisedToolCall:s,toolMessage:l}}const o=`Unexpected human decision: ${JSON.stringify(r)}. Decision type '${r.type}' is not allowed for tool '${s.name}'. Expected one of ${JSON.stringify(a)} based on the tool's configuration.`;throw new Error(o)};return Ht({name:"HumanInTheLoopMiddleware",contextSchema:gw,afterModel:{canJumpTo:["model"],hook:async(r,s)=>{var b;const i=cs(gw,{...t,...s.context||{}});if(!i)return;const{messages:a}=r;if(!a.length)return;const o=[...a].reverse().find(y=>le.isInstance(y));if(!o||!((b=o.tool_calls)!=null&&b.length)||!i.interruptOn)return;const c={};for(const[y,v]of Object.entries(i.interruptOn))typeof v=="boolean"?v===!0&&(c[y]={allowedDecisions:[...Ik]}):v.allowedDecisions&&(c[y]=v);const l=[],u=[];for(const y of o.tool_calls)y.name in c?l.push(y):u.push(y);if(!l.length)return;for(const y of l){const v=c[y.name],{actionRequest:T,reviewConfig:A}=await e(y,v,r,s)}const h=(await Tz()).decisions;if(!h||!Array.isArray(h))throw new Error("Invalid HITLResponse: decisions must be a non-empty array");if(h.length!==l.length)throw new Error(`Number of human decisions (${h.length}) does not match number of hanging tool calls (${l.length}).`);const f=[...u],m=[],g=h.some(y=>y.type==="reject");for(let y=0;y<h.length;y++){const v=h[y],T=l[y],A=c[T.name],{revisedToolCall:I,toolMessage:$}=n(v,T,A);I&&(!g||v.type==="reject")&&f.push(I),$&&m.push($)}le.isInstance(o)&&(o.tool_calls=f);const w=g?"model":void 0;return{messages:[o,...m],jumpTo:w}}}})}const Pl=`<role>
Context Extraction Assistant
</role>

<primary_objective>
Your sole objective in this task is to extract the highest quality/most relevant context from the conversation history below.
</primary_objective>

<objective_information>
You're nearing the total number of input tokens you can accept, so you must extract the highest quality/most relevant pieces of information from your conversation history.
This context will then overwrite the conversation history presented below. Because of this, ensure the context you extract is only the most important information to your overall goal.
</objective_information>

<instructions>
The conversation history below will be replaced with the context you extract in this step. Because of this, you must do your very best to extract and record all of the most important context from the conversation history.
You want to ensure that you don't repeat any actions you've already completed, so the context you extract from the conversation history should be focused on the most important information to your overall goal.
</instructions>

The user will message you with the full message history you'll be extracting context from, to then replace. Carefully read over it all, and think deeply about what information is most important to your overall goal that should be saved:

With all of this in mind, please carefully read over the entire conversation history, and extract the most important and relevant context to replace it so that you can free up space in the conversation history.
Respond ONLY with the extracted context. Do not include any additional information, or text before or after the extracted context.

<messages>
Messages to summarize:
{messages}
</messages>`,o3="Here is a summary of the conversation to date:",Iu=20,c3=4e3,yw=5,l3=cc().args($n(Wn())).returns(xr([at(),o0(at())])),Ia=Ve({fraction:at().gt(0,"Fraction must be greater than 0").max(1,"Fraction must be less than or equal to 1").optional(),tokens:at().positive("Tokens must be greater than 0").optional(),messages:at().int("Messages must be an integer").positive("Messages must be greater than 0").optional()}).refine(t=>[t.fraction,t.tokens,t.messages].filter(n=>n!==void 0).length>=1,{message:"At least one of fraction, tokens, or messages must be provided"}),Sg=Ve({fraction:at().min(0,"Messages must be non-negative").max(1,"Fraction must be less than or equal to 1").optional(),tokens:at().min(0,"Tokens must be greater than or equal to 0").optional(),messages:at().int("Messages must be an integer").min(0,"Messages must be non-negative").optional()}).refine(t=>[t.fraction,t.tokens,t.messages].filter(n=>n!==void 0).length===1,{message:"Exactly one of fraction, tokens, or messages must be provided"}),_w=Ve({model:Wn(),trigger:xr([Ia,$n(Ia)]).optional(),keep:Sg.optional(),tokenCounter:l3.optional(),summaryPrompt:Ue().default(Pl),trimTokensToSummarize:at().optional(),summaryPrefix:Ue().optional(),maxTokensBeforeSummary:at().optional(),messagesToKeep:at().optional()});function Go(t){if("profile"in t&&typeof t.profile=="object"&&t.profile&&"maxInputTokens"in t.profile&&(typeof t.profile.maxInputTokens=="number"||t.profile.maxInputTokens==null))return t.profile.maxInputTokens??void 0;if("model"in t&&typeof t.model=="string")return fu(t.model);if("modelName"in t&&typeof t.modelName=="string")return fu(t.modelName)}function u3(t){const{data:e,error:n}=Jb(_w,t);if(n)throw new Error(`Invalid summarization middleware options: ${Fu(n)}`);return Ht({name:"SummarizationMiddleware",contextSchema:_w.extend({model:Wn().optional()}),beforeModel:async(r,s)=>{var j,P,W,ne,B,V;let i=e.trigger,a=e.keep;e.maxTokensBeforeSummary!==void 0&&(console.warn("maxTokensBeforeSummary is deprecated. Use `trigger: { tokens: value }` instead."),i===void 0&&(i={tokens:e.maxTokensBeforeSummary})),e.messagesToKeep!==void 0&&(console.warn("messagesToKeep is deprecated. Use `keep: { messages: value }` instead."),(!a||a&&"messages"in a&&a.messages===Iu)&&(a={messages:e.messagesToKeep}));const o=((j=s.context)==null?void 0:j.trigger)!==void 0?s.context.trigger:i,c=((P=s.context)==null?void 0:P.keep)!==void 0?s.context.keep:a??{messages:Iu},l=Sg.parse(c);let u=[];o===void 0?u=[]:Array.isArray(o)?u=o.map(H=>Ia.parse(H)):u=[Ia.parse(o)];const d=u.some(H=>"fraction"in H)||"fraction"in l,h=typeof e.model=="string"?await ei(e.model):e.model;if(d&&!Go(h))throw new Error("Model profile information is required to use fractional token limits. Use absolute token counts instead.");const f=((W=s.context)==null?void 0:W.summaryPrompt)===Pl?e.summaryPrompt??Pl:((ne=s.context)==null?void 0:ne.summaryPrompt)??e.summaryPrompt??Pl,m=s.context.summaryPrefix??e.summaryPrefix??o3,g=((B=s.context)==null?void 0:B.trimTokensToSummarize)!==void 0?s.context.trimTokensToSummarize:e.trimTokensToSummarize??c3;d3(r.messages);const w=((V=s.context)==null?void 0:V.tokenCounter)!==void 0?s.context.tokenCounter:e.tokenCounter??Eg,b=await w(r.messages);if(!await p3(r.messages,b,u,h))return;const{systemPrompt:v,conversationMessages:T}=h3(r.messages),A=await m3(T,l,w,h);if(A<=0)return;const{messagesToSummarize:I,preservedMessages:$}=f3(v,T,A),S=await w3(I,h,f,w,g),M=new ht({content:`${m}

${S}`,id:vr()});return{messages:[new Us({id:Jx}),M,...$]}}})}function d3(t){for(const e of t)e.id||(e.id=vr())}function h3(t){return t.length>0&&kt.isInstance(t[0])?{systemPrompt:t[0],conversationMessages:t.slice(1)}:{conversationMessages:t}}function f3(t,e,n){const r=e.slice(0,n),s=e.slice(n);return t&&r.unshift(t),{messagesToSummarize:r,preservedMessages:s}}async function p3(t,e,n,r){if(n.length===0)return!1;for(const s of n){let i=!0,a=!1;if(s.messages!==void 0&&(a=!0,t.length<s.messages&&(i=!1)),s.tokens!==void 0&&(a=!0,e<s.tokens&&(i=!1)),s.fraction!==void 0){a=!0;const o=Go(r);if(typeof o=="number"){const c=Math.floor(o*s.fraction);e<c&&(i=!1)}else i=!1}if(a&&i)return!0}return!1}async function m3(t,e,n,r){if("tokens"in e||"fraction"in e){const s=await g3(t,e,n,r);return typeof s=="number"?s:ww(t,Iu)}return ww(t,e.messages??Iu)}async function g3(t,e,n,r){if(t.length===0)return 0;let s;if("fraction"in e&&e.fraction!==void 0){const u=Go(r);if(typeof u!="number")return;s=Math.floor(u*e.fraction)}else if("tokens"in e&&e.tokens!==void 0)s=Math.floor(e.tokens);else return;if(s<=0&&(s=1),await n(t)<=s)return 0;let a=0,o=t.length,c=t.length;const l=Math.floor(Math.log2(t.length))+1;for(let u=0;u<l&&!(a>=o);u++){const d=Math.floor((a+o)/2);await n(t.slice(d))<=s?(c=d,o=d):a=d+1}if(c===t.length&&(c=a),c>=t.length){if(t.length===1)return 0;c=t.length-1}for(let u=c;u>=0;u--)if(Ak(t,u))return u;return 0}function ww(t,e){if(t.length<=e)return 0;const n=t.length-e;for(let r=n;r>=0;r--)if(Ak(t,r))return r;return 0}function Ak(t,e){if(e>=t.length)return!0;if(e<t.length&&le.isInstance(t[e])&&mp(t[e]))return!1;const n=Math.max(0,e-yw),r=Math.min(t.length,e+yw);for(let s=n;s<r;s++){if(!mp(t[s]))continue;const i=y3(t[s]);if(_3(t,s,e,i))return!1}return!0}function y3(t){const e=new Set;if(t.tool_calls)for(const n of t.tool_calls){const r=typeof n=="object"&&"id"in n?n.id:null;r&&e.add(r)}return e}function _3(t,e,n,r){for(let s=e+1;s<t.length;s++){const i=t[s];if(Pe.isInstance(i)&&r.has(i.tool_call_id)){const a=e<n,o=s<n;if(a!==o)return!0}}return!1}async function w3(t,e,n,r,s){if(!t.length)return"No previous conversation history.";const i=await v3(t,r,s);if(!i.length)return"Previous conversation was too long to summarize.";try{const a=n.replace("{messages}",JSON.stringify(i,null,2)),c=(await e.invoke(a,{callbacks:[]})).content;return typeof c=="string"?c.trim():Array.isArray(c)?c.map(u=>typeof u=="string"?u:typeof u=="object"&&u!==null&&"text"in u?u.text:"").join("").trim():"Error generating summary: Invalid response format"}catch(a){return`Error generating summary: ${a}`}}async function v3(t,e,n){if(n===void 0)return t;try{return await hm(t,{maxTokens:n,tokenCounter:async r=>e(r),strategy:"last",allowPartial:!0,includeSystem:!0})}catch{return t.slice(-15)}}function b3(t){return Ht({name:"DynamicSystemPromptMiddleware",wrapModelCall:async(e,n)=>{const r=await t(e.state,e.runtime);if(!(typeof r=="string"||kt.isInstance(r)))throw new Error("dynamicSystemPromptMiddleware function must return a string or SystemMessage");return n({...e,systemMessage:e.systemMessage.concat(r)})}})}const E3="Your goal is to select the most relevant tools for answering the user's query.";function T3(t){if(!t||t.length===0)throw new Error("Invalid usage: tools must be non-empty");const e=t.map(r=>Ur(r.name)),n=xr(e);return Ve({tools:$n(n).describe("Tools to use. Place the most relevant tools first.")})}const S3=Ve({model:Ue().or(oc(ud)).optional(),systemPrompt:Ue().optional(),maxTools:at().optional(),alwaysInclude:$n(Ue()).optional()});function x3(t){return Ht({name:"LLMToolSelector",contextSchema:S3,async wrapModelCall(e,n){var o,c;const r=await k3(e,t,e.runtime);if(!r)return n(e);const s=T3(r.availableTools),i=await((c=(o=r.model).withStructuredOutput)==null?void 0:c.call(o,s)),a=await(i==null?void 0:i.invoke([{role:"system",content:r.systemMessage},r.lastUserMessage]));if(!a||typeof a!="object"||!("tools"in a))throw new Error(`Expected object response with tools array, got ${typeof a}`);return n(I3(a,r.availableTools,r.validToolNames,e,t))}})}async function k3(t,e,n){const r=n.context.model??e.model,s=n.context.maxTools??e.maxTools,i=n.context.alwaysInclude??e.alwaysInclude??[],a=n.context.systemPrompt??e.systemPrompt??E3;if(!t.tools||t.tools.length===0)return;const o=t.tools.filter(f=>typeof f=="object"&&"name"in f&&"description"in f&&typeof f.name=="string");if(i.length>0){const f=new Set(o.map(g=>g.name)),m=i.filter(g=>!f.has(g));if(m.length>0)throw new Error(`Tools in alwaysInclude not found in request: ${m.join(", ")}. Available tools: ${Array.from(f).sort().join(", ")}`)}const c=o.filter(f=>!i.includes(f.name));if(c.length===0)return;let l=a;s!==void 0&&(l+=`
IMPORTANT: List the tool names in order of relevance, with the most relevant first. If you exceed the maximum number of tools, only the first ${s} will be used.`);let u;for(const f of t.messages)ht.isInstance(f)&&(u=f);if(!u)throw new Error("No user message found in request messages");const d=r?typeof r=="string"?await ei(r):r:t.model,h=c.map(f=>f.name);return{availableTools:c,systemMessage:l,lastUserMessage:u,model:d,validToolNames:h}}function I3(t,e,n,r,s){const i=s.maxTools,a=s.alwaysInclude??[],o=[],c=[];for(const h of t.tools){if(!n.includes(h)){c.push(h);continue}!o.includes(h)&&(i===void 0||o.length<i)&&o.push(h)}if(c.length>0)throw new Error(`Model selected invalid tools: ${c.join(", ")}`);const l=e.filter(h=>o.includes(h.name)),u=(r.tools??[]).filter(h=>typeof h=="object"&&"name"in h&&typeof h.name=="string"&&a.includes(h.name));l.push(...u);const d=(r.tools??[]).filter(h=>!(typeof h=="object"&&"name"in h&&"description"in h&&typeof h.name=="string"));return{...r,tools:[...l,...d]}}var Ck=class extends Error{constructor(t,e){super(`PII detected: ${t} found ${e.length} occurrence(s)`),this.piiType=t,this.matches=e,this.name="PIIDetectionError"}};const A3=/\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}\b/g,C3=/\b(?:\d{4}[-\s]?){3}\d{4}\b/g,O3=/\b(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\b/g,$3=/\b(?:[0-9A-Fa-f]{2}[:-]){5}(?:[0-9A-Fa-f]{2})\b/g,R3=/(?:https?:\/\/|www\.)[^\s<>"{}|\\^`[\]]+/gi;function N3(t){const e=t.replace(/\D/g,"");let n=0,r=!1;for(let s=e.length-1;s>=0;s--){let i=parseInt(e[s],10);r&&(i*=2,i>9&&(i-=9)),n+=i,r=!r}return n%10===0}function Ni(t){return{text:t[0],start:t.index??0,end:(t.index??0)+t[0].length}}function Ok(t){const e=[],n=new RegExp(A3);let r;for(;(r=n.exec(t))!==null;)e.push(Ni(r));return e}function $k(t){const e=[],n=new RegExp(C3);let r;for(;(r=n.exec(t))!==null;){const s=r[0].replace(/\D/g,"");s.length>=13&&s.length<=19&&N3(s)&&e.push(Ni(r))}return e}function Rk(t){const e=[],n=new RegExp(O3);let r;for(;(r=n.exec(t))!==null;){const i=r[0].split(".");i.length===4&&i.every(a=>{const o=parseInt(a,10);return o>=0&&o<=255})&&e.push(Ni(r))}return e}function Nk(t){const e=[],n=new RegExp($3);let r;for(;(r=n.exec(t))!==null;)e.push(Ni(r));return e}function Pk(t){const e=[],n=new RegExp(R3);let r;for(;(r=n.exec(t))!==null;)e.push(Ni(r));return e}const $h={email:Ok,credit_card:$k,ip:Rk,mac_address:Nk,url:Pk};function Mk(t){let e;if(t.detector)if(typeof t.detector=="string"){const n=new RegExp(t.detector,"g");e=r=>{const s=[];let i;const a=new RegExp(n);for(;(i=a.exec(r))!==null;)s.push(Ni(i));return s}}else t.detector instanceof RegExp?e=n=>{if(!(t.detector instanceof RegExp))throw new Error("Detector is required");const r=[];let s;for(;(s=t.detector.exec(n))!==null;)r.push(Ni(s));return r}:e=t.detector;else{const n=t.piiType;if(!$h[n])throw new Error(`Unknown PII type: ${t.piiType}. Must be one of: ${Object.keys($h).join(", ")}, or provide a custom detector.`);e=$h[n]}return{piiType:t.piiType,strategy:t.strategy,detector:e}}function P3(t,e,n){let r=t;for(let s=e.length-1;s>=0;s--){const i=e[s],a=`[REDACTED_${n.toUpperCase()}]`;r=r.slice(0,i.start)+a+r.slice(i.end)}return r}function M3(t,e,n){let r=t;for(let s=e.length-1;s>=0;s--){const i=e[s],a=i.text;let o;if(n==="credit_card")o=`****-****-****-${a.replace(/\D/g,"").slice(-4)}`;else if(n==="email"){const[c,l]=a.split("@");c&&l?o=`${c[0]}***@${l}`:o="***"}else{const c=Math.min(4,a.length);o=`${"*".repeat(Math.max(0,a.length-c))}${a.slice(-c)}`}r=r.slice(0,i.start)+o+r.slice(i.end)}return r}function L3(t,e,n){let r=t;for(let s=e.length-1;s>=0;s--){const i=e[s],a=od(i.text).slice(0,8),o=`<${n}_hash:${a}>`;r=r.slice(0,i.start)+o+r.slice(i.end)}return r}function Lk(t,e,n,r){if(e.length===0)return t;switch(n){case"block":throw new Ck(r,e);case"redact":return P3(t,e,r);case"mask":return M3(t,e,r);case"hash":return L3(t,e,r);default:throw new Error(`Unknown strategy: ${n}`)}}const j3=Ve({applyToInput:Zs().optional(),applyToOutput:Zs().optional(),applyToToolResults:Zs().optional()});function Rh(t,e){const n=e.detector(t);return n.length===0?{content:t,matches:[]}:{content:Lk(t,n,e.strategy,e.piiType),matches:n}}function D3(t,e={}){const{strategy:n="redact",detector:r}=e,s=Mk({piiType:t,strategy:n,detector:r}),i=`PIIMiddleware[${s.piiType}]`;return Ht({name:i,contextSchema:j3,beforeModel:async(a,o)=>{const c=o.context.applyToInput??e.applyToInput??!0,l=o.context.applyToToolResults??e.applyToToolResults??!1;if(!c&&!l)return;const u=a.messages;if(!u||u.length===0)return;const d=[...u];let h=!1;if(c){let f=null;for(let m=u.length-1;m>=0;m--)if(ht.isInstance(u[m])){f=m;break}if(f!==null){const m=u[f];if(m&&m.content){const g=String(m.content),{content:w,matches:b}=Rh(g,s);b.length>0&&(d[f]=new ht({content:w,id:m.id,name:m.name}),h=!0)}}}if(l){let f=null;for(let m=u.length-1;m>=0;m--)if(le.isInstance(u[m])){f=m;break}if(f!==null)for(let m=f+1;m<u.length;m++){const g=u[m];if(Pe.isInstance(g)){if(!g.content)continue;const w=String(g.content),{content:b,matches:y}=Rh(w,s);y.length>0&&(d[m]=new Pe({content:b,id:g.id,name:g.name,tool_call_id:g.tool_call_id}),h=!0)}}}if(h)return{messages:d}},afterModel:async(a,o)=>{if(!(o.context.applyToOutput??e.applyToOutput??!1))return;const l=a.messages;if(!l||l.length===0)return;let u=null,d=null;for(let b=l.length-1;b>=0;b--)if(le.isInstance(l[b])){d=l[b],u=b;break}if(u===null||!d||!d.content)return;const h=String(d.content),{content:f,matches:m}=Rh(h,s);if(m.length===0)return;const g=new le({content:f,id:d.id,name:d.name,tool_calls:d.tool_calls}),w=[...l];return w[u]=g,{messages:w}}})}const U3=Ve({rules:Po(Ue(),oc(RegExp).describe("Regular expression pattern to match PII")).optional()});function F3(){return Math.random().toString(36).substring(2,11)}function Nh(t,e,n){let r=t;for(const[s,i]of Object.entries(e)){const a=s.toUpperCase().replace(/[^a-zA-Z0-9_-]/g,"");r=r.replace(i,o=>{const c=F3();return n[c]=o,`[REDACTED_${a}_${c}]`})}return r}async function B3(t,e){if(ht.isInstance(t)||Pe.isInstance(t)||kt.isInstance(t)){const n=t.content,r=await Nh(n,e.rules,e.redactionMap);if(r!==n){const s=Object.getPrototypeOf(t).constructor;return new s({...t,content:r})}return t}if(le.isInstance(t)){const n=typeof t.content=="string"?t.content:JSON.stringify(t.content),r=JSON.stringify(t.tool_calls),s=await Nh(n,e.rules,e.redactionMap),i=await Nh(r,e.rules,e.redactionMap);return s!==n||i!==r?new le({...t,content:typeof t.content=="string"?s:JSON.parse(s),tool_calls:JSON.parse(i)}):t}throw new Error(`Unsupported message type: ${t.type}`)}function go(t,e){let n=t;const r=/\[REDACTED_[A-Z_]+_(\w+)\]/g;return n=n.replace(r,(s,i)=>e[i]?e[i]:s),n}function vw(t,e){if(ht.isInstance(t)||Pe.isInstance(t)||kt.isInstance(t)){const n=t.content,r=go(n,e);if(r!==n){const s=Object.getPrototypeOf(t).constructor;return{message:new s({...t,content:r}),changed:!0}}return{message:t,changed:!1}}if(le.isInstance(t)){const n=typeof t.content=="string"?t.content:JSON.stringify(t.content),r=JSON.stringify(t.tool_calls),s=go(n,e),i=go(r,e);return s!==n||i!==r?{message:new le({...t,content:typeof t.content=="string"?s:JSON.parse(s),tool_calls:JSON.parse(i)}),changed:!0}:{message:t,changed:!1}}throw new Error(`Unsupported message type: ${t.type}`)}function z3(t={}){const e={};return console.warn("DEPRECATED: piiRedactionMiddleware is deprecated. Please use piiMiddleware instead, go to https://docs.langchain.com/oss/javascript/langchain/middleware/built-in#pii-detection for more information."),Ht({name:"PIIRedactionMiddleware",contextSchema:U3,wrapModelCall:async(n,r)=>{const s=n.runtime.context.rules??t.rules??{};if(Object.keys(s).length===0)return r(n);const i=await Promise.all(n.state.messages.map(a=>B3(a,{rules:s,redactionMap:e})));return r({...n,messages:i})},afterModel:async n=>{var l,u,d,h,f;if(Object.keys(e).length===0)return;const r=n.messages.at(-1);if(!le.isInstance(r))return;const s=n.messages.at(-2),{message:i,changed:a}=vw(r,e);if(!a)return;let o;if(le.isInstance(r)&&((l=r==null?void 0:r.tool_calls)==null?void 0:l.length)===0&&typeof r.content=="string"&&r.content.startsWith("{")&&r.content.endsWith("}"))try{o=JSON.parse(go(r.content,e))}catch{}if(le.isInstance(s)&&((u=s==null?void 0:s.tool_calls)==null?void 0:u.length)!==0&&((d=s==null?void 0:s.tool_calls)==null?void 0:d.some(m=>m.name.startsWith("extract-")))){const{message:m,changed:g}=vw(s,e),w=(f=(h=s.tool_calls)==null?void 0:h.find(y=>y.name.startsWith("extract-")))==null?void 0:f.args,b=w?JSON.parse(go(JSON.stringify(w),e)):void 0;if(a||g)return{...n,...b?{structuredResponse:b}:{},messages:[new Us({id:s.id}),new Us({id:r.id}),m,i]}}return{...n,...o?{structuredResponse:o}:{},messages:[new Us({id:r.id}),i]}}})}const Z3="[cleared]",V3=1e5,nl=3;var _i,Hn,Dk,Uk,Ml,vp,Nw,jk=(Nw=class{constructor(t={}){rn(this,Hn);rn(this,_i);p(this,"trigger");p(this,"keep");p(this,"clearToolInputs");p(this,"excludeTools");p(this,"placeholder");p(this,"model");p(this,"clearAtLeast");let e=t.trigger;t.triggerTokens!==void 0&&(console.warn("triggerTokens is deprecated. Use `trigger: { tokens: value }` instead."),e===void 0&&(e={tokens:t.triggerTokens}));let n=t.keep;if(t.keepMessages!==void 0&&(console.warn("keepMessages is deprecated. Use `keep: { messages: value }` instead."),n===void 0&&(n={messages:t.keepMessages})),e===void 0&&(e={tokens:V3}),n===void 0&&(n={messages:nl}),Array.isArray(e))En(this,_i,e.map(s=>Ia.parse(s))),this.trigger=he(this,_i);else{const s=Ia.parse(e);En(this,_i,[s]),this.trigger=s}const r=Sg.parse(n);this.keep=r,t.clearAtLeast!==void 0&&console.warn("clearAtLeast is deprecated and will be removed in a future version. It conflicts with the `keep` property. Use `keep: { tokens: value }` or `keep: { messages: value }` instead to control retention."),this.clearAtLeast=t.clearAtLeast??0,this.clearToolInputs=t.clearToolInputs??!1,this.excludeTools=new Set(t.excludeTools??[]),this.placeholder=t.placeholder??Z3}async apply(t){var h,f,m,g,w;const{messages:e,model:n,countTokens:r}=t,s=await r(e),i=[];for(let b=0;b<e.length;b++){const y=e[b];if(Pe.isInstance(y)){const v=We(this,Hn,Ml).call(this,e.slice(0,b),y.tool_call_id);v&&((h=v.tool_calls)!=null&&h.find(A=>A.id===y.tool_call_id))||i.push(b)}}for(let b=i.length-1;b>=0;b--)e.splice(i[b],1);let a=s;if(i.length>0&&(a=await r(e)),!We(this,Hn,Dk).call(this,e,a,n))return;const o=[];for(let b=0;b<e.length;b++){const y=e[b];Pe.isInstance(y)&&o.push({idx:b,msg:y})}if(o.length===0)return;const c=await We(this,Hn,Uk).call(this,o,r,n),l=c>=o.length?[]:c>0?o.slice(0,-c):o;let u=0;const d=[...l];for(const{idx:b,msg:y}of d){const v=(f=y.response_metadata)==null?void 0:f.context_editing;if(v!=null&&v.cleared)continue;const T=We(this,Hn,Ml).call(this,e.slice(0,b),y.tool_call_id);if(!T)continue;const A=(m=T.tool_calls)==null?void 0:m.find(S=>S.id===y.tool_call_id);if(!A)continue;const I=y.name||A.name;if(this.excludeTools.has(I))continue;if(e[b]=new Pe({tool_call_id:y.tool_call_id,content:this.placeholder,name:y.name,artifact:void 0,response_metadata:{...y.response_metadata,context_editing:{cleared:!0,strategy:"clear_tool_uses"}}}),this.clearToolInputs){const S=e.indexOf(T);S>=0&&(e[S]=We(this,Hn,vp).call(this,T,y.tool_call_id))}const $=await r(e);u=Math.max(0,a-$)}if(this.clearAtLeast>0&&u<this.clearAtLeast){const b=c>0&&c<o.length?o.slice(-c):[];for(let y=b.length-1;y>=0&&!(u>=this.clearAtLeast);y--){const{idx:v,msg:T}=b[y],A=(g=T.response_metadata)==null?void 0:g.context_editing;if(A!=null&&A.cleared)continue;const I=We(this,Hn,Ml).call(this,e.slice(0,v),T.tool_call_id);if(!I)continue;const $=(w=I.tool_calls)==null?void 0:w.find(j=>j.id===T.tool_call_id);if(!$)continue;const S=T.name||$.name;if(this.excludeTools.has(S))continue;if(e[v]=new Pe({tool_call_id:T.tool_call_id,content:this.placeholder,name:T.name,artifact:void 0,response_metadata:{...T.response_metadata,context_editing:{cleared:!0,strategy:"clear_tool_uses"}}}),this.clearToolInputs){const j=e.indexOf(I);j>=0&&(e[j]=We(this,Hn,vp).call(this,I,T.tool_call_id))}const M=await r(e);u=Math.max(0,a-M)}}}},_i=new WeakMap,Hn=new WeakSet,Dk=function(t,e,n){for(const r of he(this,_i)){let s=!0,i=!1;if(r.messages!==void 0&&(i=!0,t.length<r.messages&&(s=!1)),r.tokens!==void 0&&(i=!0,e<r.tokens&&(s=!1)),r.fraction!==void 0){if(i=!0,!n)continue;const a=Go(n);if(typeof a=="number"){const o=Math.floor(a*r.fraction);if(o<=0)continue;e<o&&(s=!1)}else continue}if(i&&s)return!0}return!1},Uk=async function(t,e,n){if("messages"in this.keep&&this.keep.messages!==void 0)return this.keep.messages;if("tokens"in this.keep&&this.keep.tokens!==void 0){const r=this.keep.tokens;let s=0,i=0;for(let a=t.length-1;a>=0;a--){const o=t[a],c=await e([o.msg]);if(s+c<=r)s+=c,i++;else break}return i}if("fraction"in this.keep&&this.keep.fraction!==void 0){if(!n)return nl;const r=Go(n);if(typeof r=="number"){const s=Math.floor(r*this.keep.fraction);if(s<=0)return nl;let i=0,a=0;for(let o=t.length-1;o>=0;o--){const c=t[o],l=await e([c.msg]);if(i+l<=s)i+=l,a++;else break}return a}}return nl},Ml=function(t,e){var n;for(let r=t.length-1;r>=0;r--){const s=t[r];if(le.isInstance(s)&&((n=s.tool_calls)==null?void 0:n.some(a=>a.id===e)))return s}return null},vp=function(t,e){var a;const n=(a=t.tool_calls)==null?void 0:a.map(o=>o.id===e?{...o,args:{}}:o),r={...t.response_metadata},s={...r.context_editing},i=new Set(s.cleared_tool_inputs);return i.add(e),s.cleared_tool_inputs=Array.from(i).sort(),r.context_editing=s,new le({content:t.content,tool_calls:n,response_metadata:r,id:t.id,name:t.name,additional_kwargs:t.additional_kwargs})},Nw);function G3(t={}){const e=t.edits??[new jk],n=t.tokenCountMethod??"approx";return Ht({name:"ContextEditingMiddleware",wrapModelCall:async(r,s)=>{if(!r.messages||r.messages.length===0)return s(r);const i=r.systemPrompt?[new kt(r.systemPrompt)]:[],a=n==="approx"?Eg:async o=>{const c=[...i,...o];if("getNumTokensFromMessages"in r.model)return r.model.getNumTokensFromMessages(c).then(({totalCount:l})=>l);throw new Error(`Model "${r.model.getName()}" does not support token counting`)};for(const o of e)await o.apply({messages:r.messages,model:r.model,countTokens:a});return s(r)}})}function W3(t){return t?`Tool call limit exceeded. Do not call '${t}' again.`:"Tool call limit exceeded. Do not make additional tool calls."}const H3=["continue","error","end"],Fk="continue";function Bk(t,e,n,r,s){const i=s?`'${s}' tool`:"Tool",a=[];n!==void 0&&t>n&&a.push(`thread limit exceeded (${t}/${n} calls)`),r!==void 0&&e>r&&a.push(`run limit exceeded (${e}/${r} calls)`);const o=a.join(" and ");return`${i} call limit reached: ${o}.`}const zk=Ii(H3).default(Fk);var Zk=class extends Error{constructor(e,n,r,s,i=void 0){const a=Bk(e,n,r,s,i);super(a);p(this,"threadCount");p(this,"runCount");p(this,"threadLimit");p(this,"runLimit");p(this,"toolName");this.name="ToolCallLimitExceededError",this.threadCount=e,this.runCount=n,this.threadLimit=r,this.runLimit=s,this.toolName=i}};Ve({toolName:Ue().optional(),threadLimit:at().optional(),runLimit:at().optional(),exitBehavior:zk});const q3=Ve({threadToolCallCount:Po(Ue(),at()).default({}),runToolCallCount:Po(Ue(),at()).default({})}),J3="__all__";function K3(t){if(t.threadLimit===void 0&&t.runLimit===void 0)throw new Error("At least one limit must be specified (threadLimit or runLimit)");const e=t.exitBehavior??Fk,n=zk.safeParse(e);if(!n.success)throw new Error(Fu(n.error).slice(2));if(t.threadLimit!==void 0&&t.runLimit!==void 0&&t.runLimit>t.threadLimit)throw new Error(`runLimit (${t.runLimit}) cannot exceed threadLimit (${t.threadLimit}). The run limit should be less than or equal to the thread limit.`);const r=t.toolName?`ToolCallLimitMiddleware[${t.toolName}]`:"ToolCallLimitMiddleware";return Ht({name:r,stateSchema:q3,afterModel:{canJumpTo:["end"],hook:s=>{const i=[...s.messages].reverse().find(le.isInstance);if(!i||!i.tool_calls)return;const a=(T,A)=>t.threadLimit!==void 0&&T+1>t.threadLimit||t.runLimit!==void 0&&A+1>t.runLimit,o=T=>t.toolName===void 0||T.name===t.toolName,c=(T,A,I)=>{const $=[],S=[];let M=A,j=I;for(const P of T)o(P)&&(a(M,j)?S.push(P):($.push(P),M+=1,j+=1));return{allowed:$,blocked:S,finalThreadCount:M,finalRunCount:j+S.length}},l=t.toolName??J3,u={...s.threadToolCallCount??{}},d={...s.runToolCallCount??{}},h=u[l]??0,f=d[l]??0,{allowed:m,blocked:g,finalThreadCount:w,finalRunCount:b}=c(i.tool_calls,h,f);if(u[l]=w,d[l]=b,g.length===0)return m.length>0?{threadToolCallCount:u,runToolCallCount:d}:void 0;if(e==="error"){const T=w+g.length;throw new Zk(T,b,t.threadLimit,t.runLimit,t.toolName)}const y=W3(t.toolName),v=g.map(T=>new Pe({content:y,tool_call_id:T.id,name:T.name,status:"error"}));if(e==="end"){let T=[];if(t.toolName!==void 0?T=i.tool_calls.filter($=>$.name!==t.toolName):new Set(i.tool_calls.map(S=>S.name).filter(Boolean)).size>1&&(T=m.length>0?m:i.tool_calls),T.length>0){const $=Array.from(new Set(T.map(S=>S.name).filter(Boolean))).join(", ");throw new Error(`Cannot end execution with other tool calls pending. Found calls to: ${$}. Use 'continue' or 'error' behavior instead.`)}const A=w+g.length,I=Bk(A,b,t.threadLimit,t.runLimit,t.toolName);return v.push(new le(I)),{threadToolCallCount:u,runToolCallCount:d,jumpTo:"end",messages:v}}return{threadToolCallCount:u,runToolCallCount:d,messages:v}}},afterAgent:()=>({runToolCallCount:{}})})}const X3=`Use this tool to create and manage a structured task list for your current work session. This helps you track progress, organize complex tasks, and demonstrate thoroughness to the user.
It also helps the user understand the progress of the task and overall progress of their requests.
Only use this tool if you think it will be helpful in staying organized. If the user's request is trivial and takes less than 3 steps, it is better to NOT use this tool and just do the taks directly.

## When to Use This Tool
Use this tool in these scenarios:

1. Complex multi-step tasks - When a task requires 3 or more distinct steps or actions
2. Non-trivial and complex tasks - Tasks that require careful planning or multiple operations
3. User explicitly requests todo list - When the user directly asks you to use the todo list
4. User provides multiple tasks - When users provide a list of things to be done (numbered or comma-separated)
5. The plan may need future revisions or updates based on results from the first few steps. Keeping track of this in a list is helpful.

## How to Use This Tool
1. When you start working on a task - Mark it as in_progress BEFORE beginning work.
2. After completing a task - Mark it as completed and add any new follow-up tasks discovered during implementation.
3. You can also update future tasks, such as deleting them if they are no longer necessary, or adding new tasks that are necessary. Don't change previously completed tasks.
4. You can make several updates to the todo list at once. For example, when you complete a task, you can mark the next task you need to start as in_progress.

## When NOT to Use This Tool
It is important to skip using this tool when:
1. There is only a single, straightforward task
2. The task is trivial and tracking it provides no benefit
3. The task can be completed in less than 3 trivial steps
4. The task is purely conversational or informational

## Examples of When to Use the Todo List

<example>
User: I want to add a dark mode toggle to the application settings. Make sure you run the tests and build when you're done!
Assistant: I'll help add a dark mode toggle to your application settings. Let me create a todo list to track this implementation.
*Creates todo list with the following items:*
1. Create dark mode toggle component in Settings page
2. Add dark mode state management (context/store)
3. Implement CSS-in-JS styles for dark theme
4. Update existing components to support theme switching
5. Run tests and build process, addressing any failures or errors that occur
*Begins working on the first task*

<reasoning>
The assistant used the todo list because:
1. Adding dark mode in it of itself is a multi-step feature requiring UI, state management, and styling changes
2. The assistant inferred that tests and build need to pass by adding "Ensure tests and build succeed" as the final task
3. Both of the user's requests are complex and require multiple steps to complete.
</reasoning>
</example>

<example>
User: Help me plan a comprehensive marketing campaign for our new product launch, including social media, email marketing, and press releases.
Assistant: I'll help you plan a comprehensive marketing campaign for your product launch. Let me create a todo list to organize all the components.
*Creates todo list with the following items:*
1. Define target audience and key messaging
2. Create social media content calendar and posting schedule
3. Design email marketing sequence and automation flows
4. Draft press release and identify media contacts
5. Set up tracking and analytics for campaign performance
6. Create visual assets and brand materials
7. Coordinate launch timeline and deliverables
*Begins working on the first task*

<reasoning>
The assistant used the todo list because:
1. Marketing campaign planning involves multiple distinct channels and activities
2. Each component requires careful coordination and planning
3. The systematic approach ensures all aspects of the launch are covered
</reasoning>
</example>

<example>
User: Help me rename the function getCwd to getCurrentWorkingDirectory across my project
Assistant: Let me first search through your codebase to find all occurrences of 'getCwd'.
*Uses search tools to locate all instances of getCwd in the codebase*
Assistant: I've found 15 instances of 'getCwd' across 8 different files. Let me create a todo list to track these changes.
*Creates todo list with specific items for each file that needs updating*

<reasoning>
The assistant used the todo list because:
1. The assistant searched to understand the scope of the task
2. Upon finding multiple occurrences across different files, it determined this was a complex task with multiple steps (>3)
3. The todo list helps ensure every instance is tracked and updated systematically
4. This approach prevents missing any occurrences and maintains consistency.
</reasoning>
</example>

<example>
User: I need help organizing my home office: decluttering the desk, setting up a filing system, organizing digital files, and creating a daily workflow.
Assistant: I'll help you organize your home office systematically. Let me create a todo list to track each area of organization.
*Creates todo list with items like: 1) Sort and declutter desk items, 2) Set up physical filing system for documents, 3) Organize digital files and folders, 4) Create daily workflow and productivity systems, 5) Establish maintenance routines*
Let's start with decluttering your desk space to create a clean foundation for the other organizational systems.

<reasoning>
The assistant used the todo list because:
1. The user provided multiple distinct organizational tasks
2. Each area requires different approaches and careful planning
3. Home organization benefits from systematic, step-by-step completion
4. Progress tracking ensures all areas are addressed thoroughly
</reasoning>
</example>

## Examples of When NOT to Use the Todo List

<example>
User: How do I print 'Hello World' in Python?
Assistant: In Python, you can print "Hello World" with this simple code:

\`\`\`python
print("Hello World")
\`\`\`

This will output the text "Hello World" to the console when executed.</assistant>

<reasoning>
The assistant did not use the todo list because this is a single, trivial task that can be completed in one step. There's no need to track multiple tasks or steps for such a straightforward request.
</reasoning>
</example>

<example>
User: What's the best way to water houseplants?
Assistant: The best way to water houseplants depends on the specific plant type, but here are some general guidelines:

- Check soil moisture by inserting your finger about 1-2 inches into the soil
- Water thoroughly when the top inch feels dry, allowing water to drain from the bottom
- Use room temperature water and water in the morning when possible
- Avoid overwatering, which is more harmful than underwatering for most plants

Different plants have different needs, so it's important to research your specific varieties for optimal care.

<reasoning>
The assistant did not use the todo list because this is an informational request with no actual tasks to complete. The user is simply asking for advice and explanation, not for the assistant to perform multiple steps or activities.
</reasoning>
</example>

<example>
User: Can you add a comment to the calculateTotal function to explain what it does?
Assistant: Sure, let me add a comment to the calculateTotal function to explain what it does.
* Uses the Edit tool to add a comment to the calculateTotal function *

<reasoning>
The assistant did not use the todo list because this is a single, straightforward task confined to one location. Adding a comment doesn't require tracking multiple steps or systematic organization.
</reasoning>
</example>

<example>
User: What time is it in Tokyo right now?
Assistant: I'll check the current time in Tokyo for you.

*Searches for current time in Tokyo*

The current time in Tokyo, Japan is [current time]. Tokyo is in the Japan Standard Time (JST) zone, which is UTC+9.

<reasoning>
The assistant did not use the todo list because this is a single information lookup with immediate results. There are no multiple steps to track or organize, making the todo list unnecessary for this straightforward request.
</reasoning>
</example>

<example>
User: I need to write a function that checks if a number is prime and then test it out.
Assistant: I'll help you write a function that checks if a number is prime and then test it out.
*Writes function that checks if a number is prime*
*Tests the function*

<reasoning>
Even though this is a multi-step task, it is very straightforward and can be completed in two trivial steps (which is less than 3 steps!). Using the todo list here is overkill and wastes time and tokens.
</reasoning>
</example>

<example>
User: I want you to order a pizza from Dominos, order a burger from McDonald's, and order a salad from Subway.
Assistant: I'll help you order a pizza from Dominos, order a burger from McDonald's, and order a salad from Subway.
*Orders a pizza from Dominos*
*Orders a burger from McDonald's*
*Orders a salad from Subway*

<reasoning>
Even though this is a multi-step task, assuming the assistant has the ability to order from these restaurants, it is very straightforward and can be completed in three trivial tool calls. 
Using the todo list here is overkill and wastes time and tokens. These three tool calls should be made in parallel, in fact.
</reasoning>
</example>


## Task States and Management

1. **Task States**: Use these states to track progress:
   - pending: Task not yet started
   - in_progress: Currently working on (you can have multiple tasks in_progress at a time if they are not related to each other and can be run in parallel)
   - completed: Task finished successfully

2. **Task Management**:
   - Update task status in real-time as you work
   - Mark tasks complete IMMEDIATELY after finishing (don't batch completions)
   - Complete current tasks before starting new ones
   - Remove tasks that are no longer relevant from the list entirely
   - IMPORTANT: When you write this todo list, you should mark your first task (or tasks) as in_progress immediately!.
   - IMPORTANT: Unless all tasks are completed, you should always have at least one task in_progress to show the user that you are working on something.

3. **Task Completion Requirements**:
   - ONLY mark a task as completed when you have FULLY accomplished it
   - If you encounter errors, blockers, or cannot finish, keep the task as in_progress
   - When blocked, create a new task describing what needs to be resolved
   - Never mark a task as completed if:
     - There are unresolved issues or errors
     - Work is partial or incomplete
     - You encountered blockers that prevent completion
     - You couldn't find necessary resources or dependencies
     - Quality standards haven't been met

4. **Task Breakdown**:
   - Create specific, actionable items
   - Break complex tasks into smaller, manageable steps
   - Use clear, descriptive task names

Being proactive with task management demonstrates attentiveness and ensures you complete all requirements successfully
Remember: If you only need to make a few tool calls to complete a task, and it is clear what you need to do, it is better to just do the task directly and NOT call this tool at all.`,Vk=`## \`write_todos\`

You have access to the \`write_todos\` tool to help you manage and plan complex objectives. 
Use this tool for complex objectives to ensure that you are tracking each necessary step and giving the user visibility into your progress.
This tool is very helpful for planning complex objectives, and for breaking down these larger complex objectives into smaller steps.

It is critical that you mark todos as completed as soon as you are done with a step. Do not batch up multiple steps before marking them as completed.
For simple objectives that only require a few steps, it is better to just complete the objective directly and NOT use this tool.
Writing todos takes time and tokens, use it when it is helpful for managing complex many-step problems! But not for simple few-step requests.

## Important To-Do List Usage Notes to Remember
- The \`write_todos\` tool should never be called multiple times in parallel.
- Don't be afraid to revise the To-Do list as you go. New information may reveal new tasks that need to be done, or old tasks that are irrelevant.`,Y3=Ii(["pending","in_progress","completed"]).describe("Status of the todo"),Gk=Ve({content:Ue().describe("Content of the todo item"),status:Y3}),Q3=Ve({todos:$n(Gk).default([])});function e9(t){const e=fd(({todos:n},r)=>{var s;return new xt({update:{todos:n,messages:[new Pe({content:`Updated todo list to ${JSON.stringify(n)}`,tool_call_id:(s=r.toolCall)==null?void 0:s.id})]}})},{name:"write_todos",description:(t==null?void 0:t.toolDescription)??X3,schema:Ve({todos:$n(Gk).describe("List of todo items to update")})});return Ht({name:"todoListMiddleware",stateSchema:Q3,tools:[e],wrapModelCall:(n,r)=>r({...n,systemMessage:n.systemMessage.concat(`

${(t==null?void 0:t.systemPrompt)??Vk}`)})})}const t9="end",n9=Ve({threadLimit:at().optional(),runLimit:at().optional(),exitBehavior:Ii(["error","end"]).optional()}),r9=Ve({threadModelCallCount:at().default(0),runModelCallCount:at().default(0)});var bw=class extends Error{constructor({threadLimit:t,runLimit:e,threadCount:n,runCount:r}){const s=[];typeof t=="number"&&typeof n=="number"&&s.push(`thread level call limit reached with ${n} model calls`),typeof e=="number"&&typeof r=="number"&&s.push(`run level call limit reached with ${r} model calls`),super(`Model call limits exceeded${s.length>0?`: ${s.join(", ")}`:""}`),this.name="ModelCallLimitMiddlewareError"}};function s9(t){return Ht({name:"ModelCallLimitMiddleware",contextSchema:n9,stateSchema:r9,beforeModel:{canJumpTo:["end"],hook:(e,n)=>{let r=n.context.exitBehavior??(t==null?void 0:t.exitBehavior)??t9;r==="throw"&&(console.warn("The 'throw' exit behavior is deprecated. Please use 'error' instead."),r="error");const s=n.context.threadLimit??(t==null?void 0:t.threadLimit),i=n.context.runLimit??(t==null?void 0:t.runLimit),a=e.threadModelCallCount,o=e.runModelCallCount;if(typeof s=="number"&&s<=a){const c=new bw({threadLimit:s,threadCount:a});if(r==="end")return{jumpTo:"end",messages:[new le(c.message)]};throw c}if(typeof i=="number"&&i<=o){const c=new bw({runLimit:i,runCount:o});if(r==="end")return{jumpTo:"end",messages:[new le(c.message)]};throw c}return e}},afterModel:e=>({runModelCallCount:e.runModelCallCount+1,threadModelCallCount:e.threadModelCallCount+1}),afterAgent:()=>({runModelCallCount:0})})}function i9(...t){return Ht({name:"modelFallbackMiddleware",wrapModelCall:async(e,n)=>{try{return await n(e)}catch(r){for(let s=0;s<t.length;s++)try{const i=t[s],a=typeof i=="string"?await ei(i):i;return await n({...e,model:a})}catch(i){if(s===t.length-1)throw i}throw r}}})}const Wk=Ve({maxRetries:at().min(0).default(2),retryOn:xr([cc().args(oc(Error)).returns(Zs()),$n(Wn())]).default(()=>()=>!0),backoffFactor:at().min(0).default(2),initialDelayMs:at().min(0).default(1e3),maxDelayMs:at().min(0).default(6e4),jitter:Zs().default(!0)});var Hk=class extends Error{constructor(e){const n=Fu(e).slice(2);super(n);p(this,"cause");this.name="InvalidRetryConfigError",this.cause=e}};const Ew=Ve({onFailure:xr([Ur("error"),Ur("continue"),cc().args(oc(Error)).returns(Ue())]).default("continue")}).merge(Wk);function a9(t={}){const{success:e,error:n,data:r}=Ew.safeParse(t);if(!e)throw new Hk(n);const{maxRetries:s,retryOn:i,onFailure:a,backoffFactor:o,initialDelayMs:c,maxDelayMs:l,jitter:u}=r,d=g=>typeof i=="function"?i(g):i.some(w=>g.constructor===w),h={backoffFactor:o,initialDelayMs:c,maxDelayMs:l,jitter:u},f=(g,w)=>{const b=g.constructor.name;return`Model call failed after ${w} ${w===1?"attempt":"attempts"} with ${b}: ${g.message}`},m=(g,w)=>{if(a==="error")throw g;let b;return typeof a=="function"?b=a(g):b=f(g,w),new le({content:b})};return Ht({name:"modelRetryMiddleware",contextSchema:Ew,wrapModelCall:async(g,w)=>{for(let b=0;b<=s;b++)try{return await w(g)}catch(y){const v=b+1,T=y&&typeof y=="object"&&"message"in y?y:new Error(String(y));if(!d(T))return m(T,v);if(b<s){const A=ok(h,b);A>0&&await ak(A)}else return m(T,v)}throw new Error("Unexpected: retry loop completed without returning")}})}const Tw=Ve({tools:$n(xr([Wn(),Wn(),Ue()])).optional(),onFailure:xr([Ur("error"),Ur("continue"),Ur("raise"),Ur("return_message"),cc().args(oc(Error)).returns(Ue())]).default("continue")}).merge(Wk);function o9(t={}){const{success:e,error:n,data:r}=Tw.safeParse(t);if(!e)throw new Hk(n);const{maxRetries:s,tools:i,retryOn:a,onFailure:o,backoffFactor:c,initialDelayMs:l,maxDelayMs:u,jitter:d}=r;let h=o;o==="raise"?(console.warn(" `onFailure: 'raise'` is deprecated. Use `onFailure: 'error'` instead."),h="error"):o==="return_message"&&(console.warn(" `onFailure: 'return_message'` is deprecated. Use `onFailure: 'continue'` instead."),h="continue");const f=[];for(const v of i??[])if(typeof v=="string")f.push(v);else if("name"in v&&typeof v.name=="string")f.push(v.name);else throw new TypeError("Expected a tool name string or tool instance to be passed to toolRetryMiddleware");const m=v=>f.length===0?!0:f.includes(v),g=v=>typeof a=="function"?a(v):a.some(T=>v instanceof T),w={backoffFactor:c,initialDelayMs:l,maxDelayMs:u,jitter:d},b=(v,T,A)=>{const I=T.constructor.name;return`Tool '${v}' failed after ${A} ${A===1?"attempt":"attempts"} with ${I}`},y=(v,T,A,I)=>{if(h==="error")throw A;let $;return typeof h=="function"?$=h(A):$=b(v,A,I),new Pe({content:$,tool_call_id:T,name:v,status:"error"})};return Ht({name:"toolRetryMiddleware",contextSchema:Tw,wrapToolCall:async(v,T)=>{var $;const A=(($=v.tool)==null?void 0:$.name)??v.toolCall.name;if(!m(A))return T(v);const I=v.toolCall.id??"";for(let S=0;S<=s;S++)try{return await T(v)}catch(M){const j=S+1,P=M&&typeof M=="object"&&"message"in M?M:new Error(String(M));if(!g(P))return y(A,I,P,j);if(S<s){const W=ok(w,S);W>0&&await ak(W)}else return y(A,I,P,j)}throw new Error("Unexpected: retry loop completed without returning")}})}function c9(t={}){let e;const{tools:n,model:r}=t,s=!n||n.length===0,i=new Set;if(!s&&n)for(const c of n)if(typeof c=="string")i.add(c);else{const l=typeof c.name=="string"?c.name:String(c.name);i.add(l)}let a;const o=async()=>typeof r=="object"?r:typeof r=="string"?(a=a??await ei(r,{temperature:1}).catch(c=>(console.error("Error initializing emulator model, using agent model:",c),e)),a):e;return Ht({name:"ToolEmulatorMiddleware",wrapModelCall:async(c,l)=>(e=c.model,l(c)),wrapToolCall:async(c,l)=>{const u=c.toolCall.name;if(!(s||i.has(u)))return l(c);const h=c.toolCall.args,f=c.tool.description||"No description available",m=typeof h=="string"?h:JSON.stringify(h),g=`You are emulating a tool call for testing purposes.

Tool: ${u}
Description: ${f}
Arguments: ${m}

Generate a realistic response that this tool would return given these arguments.
Return ONLY the tool's output, no explanation or preamble. Introduce variation into your responses.`,b=await(await o()).invoke([new ht(g)]),y=typeof b.content=="string"?b.content:JSON.stringify(b.content);return new Pe({content:y,tool_call_id:c.toolCall.id??"",name:u})}})}function l9(t){return!t||typeof t!="object"||t===null||!("client"in t)||!("_getClientOptions"in t)||typeof t._getClientOptions!="function"?!1:(t._getClientOptions(),typeof t.client=="object"&&t.client!==null&&"moderations"in t.client&&typeof t.client.moderations=="object"&&t.client.moderations!==null&&"create"in t.client.moderations&&typeof t.client.moderations.create=="function")}const u9="I'm sorry, but I can't comply with that request. It was flagged for {categories}.";var d9=class extends Error{constructor({content:e,stage:n,result:r,message:s}){super(s);p(this,"content");p(this,"stage");p(this,"result");p(this,"originalMessage");this.name="OpenAIModerationError",this.content=e,this.stage=n,this.result=r,this.originalMessage=s}};function h9(t){const{model:e,moderationModel:n="omni-moderation-latest",checkInput:r=!0,checkOutput:s=!0,checkToolResults:i=!1,exitBehavior:a="end",violationMessage:o}=t;let c;const l=async()=>{if(c)return c;const v=typeof e=="string"?await ei(e):e;if(!v.getName().includes("ChatOpenAI"))throw new Error(`Model must be an OpenAI model to use moderation middleware. Got: ${v.getName()}`);if(!l9(v))throw new Error("Model must support moderation to use moderation middleware.");return c=v,c},u=v=>v.content==null?null:v.text||null,d=(v,T)=>{for(let A=v.length-1;A>=0;A--)if(T.isInstance(v[A]))return A;return null},h=(v,T)=>{const A=[],I=T.categories;for(const[j,P]of Object.entries(I))P&&A.push(j.replace(/_/g," "));const $=A.length>0?A.join(", "):"OpenAI's safety policies",S=o||u9,M=JSON.stringify(T.category_scores,null,2);try{return S.replace("{categories}",$).replace("{category_scores}",M).replace("{original_content}",v)}catch{return S}};function f(v,T){var S;const A=(S=c==null?void 0:c._getClientOptions)==null?void 0:S.call(c),I=(T==null?void 0:T.model)??"omni-moderation-latest",$={input:v,model:I};return c.client.moderations.create($,A)}const m=(v,T,A,I,$)=>{const S=h(I,$);if(a==="error")throw new d9({content:I,stage:A,result:$,message:S});if(a==="end")return{jumpTo:"end",messages:[new le({content:S})]};if(T==null)return;const M=[...v],j=M[T],P=Object.getPrototypeOf(j).constructor;return M[T]=new P({...j,content:S}),{messages:M}},g=async v=>{const T=d(v,ht);if(T==null)return null;const A=v[T],I=u(A);if(!I)return null;await l();const S=(await f(I,{model:n})).results.find(M=>M.flagged);return S?m(v,T,"input",I,S):null},w=async v=>{const T=d(v,le);if(T==null)return null;const A=[...v];let I=!1;for(let $=T+1;$<A.length;$++){const S=A[$];if(!Pe.isInstance(S))continue;const M=u(S);if(!M)continue;await l();const P=(await f(M,{model:n})).results.find(ne=>ne.flagged);if(!P)continue;const W=m(A,$,"tool",M,P);if(W){if("jumpTo"in W)return W;"messages"in W&&(A.splice(0,A.length,...W.messages),I=!0)}}return I?{messages:A}:null},b=async v=>{const T=d(v,le);if(T==null)return null;const A=v[T],I=u(A);if(!I)return null;await l();const S=(await f(I,{model:n})).results.find(M=>M.flagged);return S?m(v,T,"output",I,S):null},y=async v=>{const T=[...v];let A=!1;if(i){const I=await w(T);if(I){if("jumpTo"in I)return I;"messages"in I&&(T.splice(0,T.length,...I.messages),A=!0)}}if(r){const I=await g(T);if(I){if("jumpTo"in I)return I;"messages"in I&&(T.splice(0,T.length,...I.messages),A=!0)}}return A?{messages:T}:null};return Ht({name:"OpenAIModerationMiddleware",beforeModel:{hook:async v=>{if(!r&&!i)return;const T=v.messages||[];if(T.length!==0)return await y(T)??void 0},canJumpTo:["end"]},afterModel:{hook:async v=>{if(!s)return;const T=v.messages||[];if(T.length!==0)return await b(T)??void 0},canJumpTo:["end"]}})}const f9=!0,p9="5m",m9=3,g9="warn",y9=Ve({enableCaching:Zs().optional(),ttl:Ii(["5m","1h"]).optional(),minMessagesToCache:at().optional(),unsupportedModelBehavior:Ii(["ignore","warn","raise"]).optional()});var Sw=class extends Error{constructor(t){super(t),this.name="PromptCachingMiddlewareError"}};function _9(t){return Ht({name:"PromptCachingMiddleware",contextSchema:y9,wrapModelCall:(e,n)=>{var d,h;const r=e.runtime.context.enableCaching??(t==null?void 0:t.enableCaching)??f9,s=e.runtime.context.ttl??(t==null?void 0:t.ttl)??p9,i=e.runtime.context.minMessagesToCache??(t==null?void 0:t.minMessagesToCache)??m9,a=e.runtime.context.unsupportedModelBehavior??(t==null?void 0:t.unsupportedModelBehavior)??g9;if(!r||!e.model)return n(e);if(!(e.model.getName()==="ChatAnthropic"||e.model.getName()==="ConfigurableModel"&&((d=e.model._defaultConfig)==null?void 0:d.modelProvider)==="anthropic")){const f=e.model.getName(),g=`Unsupported model '${e.model.getName()==="ConfigurableModel"?`${f} (${(h=e.model._defaultConfig)==null?void 0:h.modelProvider})`:f}'. Prompt caching requires an Anthropic model`;if(a==="raise")throw new Sw(`${g} (e.g., 'anthropic:claude-4-0-sonnet').`);return a==="warn"&&console.warn(`PromptCachingMiddleware: Skipping caching for ${f}. Consider switching to an Anthropic model for caching benefits.`),n(e)}if(e.state.messages.length+(e.systemPrompt?1:0)<i)return n(e);const l=e.messages.at(-1);if(!l)return n(e);const u=Object.getPrototypeOf(l).constructor;if(Array.isArray(l.content)){const f=new u({...l,content:[...l.content.slice(0,-1),{...l.content.at(-1),cache_control:{type:"ephemeral",ttl:s}}]});return n({...e,messages:[...e.messages.slice(0,-1),f]})}else if(typeof l.content=="string"){const f=new u({...l,content:[{type:"text",text:l.content,cache_control:{type:"ephemeral",ttl:s}}]});return n({...e,messages:[...e.messages.slice(0,-1),f]})}throw new Sw("Last message content is not a string or array")}})}var w9={};Xx(w9,{AIMessage:()=>le,AIMessageChunk:()=>dn,BaseMessage:()=>Cn,BaseMessageChunk:()=>ws,ClearToolUsesEdit:()=>jk,Document:()=>us,DynamicStructuredTool:()=>Qm,DynamicTool:()=>Ym,FakeToolCallingModel:()=>Oz,HumanMessage:()=>ht,HumanMessageChunk:()=>Ca,InMemoryStore:()=>kS,MIDDLEWARE_BRAND:()=>ck,MultipleStructuredOutputsError:()=>hp,MultipleToolsBoundError:()=>dp,PIIDetectionError:()=>Ck,ProviderStrategy:()=>js,StructuredOutputParsingError:()=>tk,StructuredTool:()=>wc,SystemMessage:()=>kt,SystemMessageChunk:()=>fs,TODO_LIST_MIDDLEWARE_SYSTEM_PROMPT:()=>Vk,Tool:()=>Xm,ToolCallLimitExceededError:()=>Zk,ToolInvocationError:()=>vg,ToolMessage:()=>Pe,ToolMessageChunk:()=>Aa,ToolStrategy:()=>Rs,anthropicPromptCachingMiddleware:()=>_9,applyStrategy:()=>Lk,context:()=>HS,contextEditingMiddleware:()=>G3,countTokensApproximately:()=>Eg,createAgent:()=>kk,createMiddleware:()=>Ht,detectCreditCard:()=>$k,detectEmail:()=>Ok,detectIP:()=>Rk,detectMacAddress:()=>Nk,detectUrl:()=>Pk,dynamicSystemPromptMiddleware:()=>b3,filterMessages:()=>S0,humanInTheLoopMiddleware:()=>a3,initChatModel:()=>ei,llmToolSelectorMiddleware:()=>x3,modelCallLimitMiddleware:()=>s9,modelFallbackMiddleware:()=>i9,modelRetryMiddleware:()=>a9,openAIModerationMiddleware:()=>h9,piiMiddleware:()=>D3,piiRedactionMiddleware:()=>z3,providerStrategy:()=>Az,resolveRedactionRule:()=>Mk,summarizationMiddleware:()=>u3,todoListMiddleware:()=>e9,tool:()=>fd,toolCallLimitMiddleware:()=>K3,toolEmulatorMiddleware:()=>c9,toolRetryMiddleware:()=>o9,toolStrategy:()=>sk,trimMessages:()=>hm});const v9=Ve({start_tag:Ue().describe("The starting line tag, e.g., [L10]"),end_tag:Ue().describe("The ending line tag, e.g., [L20]")}),b9=Ve({garbage_ranges:$n(v9).describe("List of line ranges identified as promotional or irrelevant content")});function E9(t){return t.split(/\r?\n/).map((n,r)=>`[L${r+1}] ${n}`).join(`
`)}function T9(t){return t.replace(/^\[L\d+\]\s*/gm,"")}function S9(t,e){const n=t.split(/\r?\n/);if(!n.length||!e.length)return t;const r=new Map;n.forEach((i,a)=>{const o=i.match(/^\[L\d+\]/);o&&r.set(o[0],a)});const s=new Array(n.length).fill(!0);for(const i of e){const a=r.get(i.start_tag),o=r.get(i.end_tag);if(a===void 0||o===void 0)continue;const c=Math.min(a,o),l=Math.max(a,o);for(let u=c;u<=l;u++)s[u]=!1}return n.filter((i,a)=>s[a]).join(`
`)}const qk={auto:"Use the same language as the transcript, or English if the transcript language is unclear",en:"English (US)","zh-TW":"Traditional Chinese ()"};function Ph(t,e=!1){const n=qk[t]||t,r=t==="auto"?n:`Write ALL output in ${n}. Do not use English or any other language.`;return`${e?`

OUTPUT LANGUAGE (REQUIRED): `:"- OUTPUT LANGUAGE (REQUIRED): "}${r}${e?" All text must be in this language.":""}`}class Wo{static buildAnalysisPrompt(e="auto"){return["Create a comprehensive analysis that strictly follows the transcript content.","",Ph(e),"","REQUIREMENTS:","- Every claim must be directly supported by the transcript","- Write in objective, article-like style (avoid 'This video...', 'The speaker...')","- No meta-descriptive language ('This analysis explores', etc.)","- Remove promotional content (speaker intros, calls-to-action)","- Keep only educational content"].join(`
`)}static buildQualityPrompt(){return"Evaluate the analysis. Rate each aspect 'Fail', 'Refine', or 'Pass' with a specific reason."}static buildImprovementPrompt(e="auto"){return["Improve the analysis based on quality feedback while maintaining transcript accuracy.","",Ph(e,!0),"","PRIORITIES:","- All content must be transcript-supported","- Remove promotional content","- Use objective, article-like tone","- No meta-descriptive language"].join(`
`)}static _getLanguageInstruction(e,n=!1){return Ph(e,n)}}p(Wo,"LANGUAGE_DESCRIPTIONS",qk);const x9=jl.SCORE_MAP,k9=jl.MAX_SCORE_PER_ASPECT,_s={MODEL:Ll.MODEL_SUMMARIZER,QUALITY_MODEL:Ll.MODEL_SUMMARIZER,MIN_QUALITY_SCORE:jl.MIN_QUALITY_SCORE,MAX_ITERATIONS:jl.MAX_ITERATIONS};function Tc(t){const e=[t.completeness,t.structure,t.no_garbage,t.meta_language_avoidance,t.useful_keywords,t.correct_language],n=e.reduce((s,i)=>s+x9[i.rate],0),r=e.length*k9;return Math.round(n/r*100)}function Jk(t){return Tc(t)>=_s.MIN_QUALITY_SCORE}function I9(t){const e=Tc(t);console.log(" Quality breakdown:"),console.log(`Completeness: ${t.completeness.rate} - ${t.completeness.reason}`),console.log(`Structure: ${t.structure.rate} - ${t.structure.reason}`),console.log(`No Garbage: ${t.no_garbage.rate} - ${t.no_garbage.reason}`),console.log(`Meta Language Avoidance: ${t.meta_language_avoidance.rate} - ${t.meta_language_avoidance.reason}`),console.log(`Useful Keywords: ${t.useful_keywords.rate} - ${t.useful_keywords.reason}`),console.log(`Correct Language: ${t.correct_language.rate} - ${t.correct_language.reason}`),console.log(`Total Score: ${e}%`),Jk(t)||console.log(`  Quality below threshold (${_s.MIN_QUALITY_SCORE}%), refinement needed`)}const A9=Ve({header:Ue().describe("A descriptive title for the chapter"),summary:Ue().describe("A comprehensive summary of the chapter content"),key_points:$n(Ue()).describe("Important takeaways and insights from this chapter")}),xg=Ve({title:Ue().describe("The main title or topic of the video content"),summary:Ue().describe("A comprehensive summary of the video content"),takeaways:$n(Ue()).min(3).max(8).describe("Key insights and actionable takeaways for the audience"),chapters:$n(A9).describe("Structured breakdown of content into logical chapters"),keywords:$n(Ue()).min(3).max(3).describe("The most relevant keywords in the analysis worthy of highlighting"),target_language:Ue().nullable().describe("The language the content to be translated to")}),Wi=Ve({rate:Ii(["Fail","Refine","Pass"]).describe("Score for the quality aspect (Fail=poor, Refine=adequate, Pass=excellent)"),reason:Ue().describe("Reason for the score")}),Kk=Ve({completeness:Wi.describe("Rate for completeness: The entire transcript has been considered"),structure:Wi.describe("Rate for structure: Summary, takeaways, and key_facts are properly formatted"),no_garbage:Wi.describe("Rate for no_garbage: Promotional and meaningless content are removed"),meta_language_avoidance:Wi.describe("Rate for meta_language_avoidance: No meta-descriptive language like 'This video explains...'"),useful_keywords:Wi.describe("Rate for useful_keywords: Key facts are relevant and useful for understanding"),correct_language:Wi.describe("Rate for correct_language: Output is in the correct target language")}),C9=Ve({transcript:Ue(),analysis_model:Ue().optional(),quality_model:Ue().optional(),target_language:Ue().default("auto"),analysis:xg.nullable().default(null),quality:Kk.nullable().default(null),iteration_count:at().default(0),is_complete:Zs().default(!1),apiKey:Ue().optional(),progressCallback:Ea().optional()});function wd(t,e){return new HT({model:t,apiKey:e,configuration:{baseURL:jw.OPENROUTER_BASE_URL,defaultHeaders:{"HTTP-Referer":chrome.runtime.getURL(""),"X-Title":"Better YouTube"}},temperature:0})}function Xk(t){return fd(async({youtube_url:e})=>{const n=t.transcript_or_url;if(!kg(n)&&(!t.videoId||e.includes(t.videoId)))return n;if(!t.scrapeCreatorsApiKey)return"Error: Scrape Creators API key not provided to the tool.";try{const s=new URL(Pw.SCRAPE_CREATORS);s.searchParams.set("url",e),s.searchParams.set("get_transcript","true");const i=await fetch(s.toString(),{headers:{"x-api-key":t.scrapeCreatorsApiKey,Accept:"application/json"},cache:"no-store"});if(!i.ok)return`Error fetching transcript: ${i.status} ${i.statusText}`;const a=await i.json(),o=a.transcript_only_text??(Array.isArray(a.transcript)?a.transcript.map(c=>c.text).join(" "):"");return o||"Error: No transcript found for this video."}catch(s){return`Error calling scrap API: ${String(s)}`}},{name:"scrap_youtube_tool",description:"Scrape a YouTube video and return the transcript.",schema:Ve({youtube_url:Ue().describe("The YouTube video URL to scrape")})})}const O9="Identify and remove garbage sections such as promotional and meaningless content such as cliche intros, outros, filler, sponsorships, and other irrelevant segments from the transcript. The transcript has line tags like [L1], [L2], etc. Return the ranges of tags that should be removed to clean the transcript.";function $9(t,e){return Ht({name:"garbageFilterMiddleware",wrapToolCall:async(n,r)=>{var d,h;if((((d=n.tool)==null?void 0:d.name)??n.toolCall.name)!=="scrap_youtube_tool")return r(n);const i=await r(n);if(!Pe.isInstance(i)||i.status==="error")return i;const a=typeof i.content=="string"?i.content:"";if(!a.trim()||a.startsWith("Error"))return i;const o=E9(a),l=wd(e,t).withStructuredOutput(b9,{method:"jsonMode"}),u=Oi.fromMessages([["system",O9],["human","{tagged_transcript}"]]);try{const f=await u.pipe(l).invoke({tagged_transcript:o});if((h=f.garbage_ranges)!=null&&h.length){const m=S9(o,f.garbage_ranges);i.content=T9(m),console.log(` Middleware removed ${f.garbage_ranges.length} garbage sections from tool result.`)}}catch(f){console.warn("Garbage filter middleware failed, using raw transcript.",f)}return i}})}async function R9(t){const e=t.apiKey,n=t.progressCallback;t.quality&&t.analysis?n==null||n("Refining analysis based on quality feedback..."):n==null||n(`Generating initial analysis. Transcript length: ${t.transcript.length} characters`);const s=wd(t.analysis_model,e).withStructuredOutput(xg);let i;if(t.quality&&t.analysis){const a=`# Improve this video analysis based on the following feedback:

## Analysis:

${JSON.stringify(t.analysis,null,2)}

## Quality Assessment:

${JSON.stringify(t.quality,null,2)}

Please provide an improved version that addresses the specific issues identified above to improve the overall quality score.`,o=Wo.buildImprovementPrompt(t.target_language||"auto"),l=`${`Original Transcript:
${t.transcript}`}

${a}`;i=Oi.fromMessages([["system",o],["human","{improvement_prompt}"]]);const d=await i.pipe(s).invoke({improvement_prompt:l});return n==null||n("Analysis refined successfully"),{analysis:d,iteration_count:t.iteration_count+1}}else{const a=t.target_language||"auto",o=Wo.buildAnalysisPrompt(a);i=Oi.fromMessages([["system",o],["human","{content}"]]);const l=await i.pipe(s).invoke({content:t.transcript});return n==null||n("Analysis completed"),{analysis:l,iteration_count:t.iteration_count+1}}}async function N9(t){const e=t.apiKey,n=t.progressCallback;n==null||n("Performing quality check..."),n==null||n(`Using model: ${t.quality_model}`);const s=wd(t.quality_model,e).withStructuredOutput(Kk,{method:"jsonMode"}),i=Wo.buildQualityPrompt(),a=JSON.stringify(t.analysis,null,2),l=await Oi.fromMessages([["system",i],["human","{analysis_text}"]]).pipe(s).invoke({analysis_text:a});I9(l);const d=Tc(l)>=_s.MIN_QUALITY_SCORE||t.iteration_count>=_s.MAX_ITERATIONS;return{quality:l,is_complete:d}}function P9(t){if(t.is_complete)return console.log("Workflow complete (is_complete=True)"),ve;const e=t.quality?Tc(t.quality):0;return t.quality&&!Jk(t.quality)&&t.iteration_count<_s.MAX_ITERATIONS?(console.log(`Quality ${e}% below threshold ${_s.MIN_QUALITY_SCORE}%, refining (iteration ${t.iteration_count+1})`),"analysisNode"):(console.log(`Workflow ending (quality: ${e}%, iterations: ${t.iteration_count})`),ve)}function M9(){return new qx(C9).addNode("analysisNode",R9).addNode("qualityNode",N9).addEdge(et,"analysisNode").addEdge("analysisNode","qualityNode").addConditionalEdges("qualityNode",P9,{analysisNode:"analysisNode",[ve]:ve}).compile()}function Yk(t){var n,r,s;const e=[];return t.title&&(e.push(`# ${t.title}`),e.push("")),e.push("## Summary"),e.push(""),e.push(t.summary),e.push(""),(n=t.takeaways)!=null&&n.length&&(e.push("## Key Takeaways"),e.push(""),t.takeaways.forEach(i=>{e.push(`- ${i}`)}),e.push("")),(r=t.chapters)!=null&&r.length&&(e.push("## Chapters"),e.push(""),t.chapters.forEach(i=>{var a;e.push(`### ${i.header}`),e.push(""),e.push(i.summary),e.push(""),(a=i.key_points)!=null&&a.length&&(i.key_points.forEach(o=>{e.push(`- ${o}`)}),e.push(""))})),(s=t.keywords)!=null&&s.length&&(e.push("## Keywords"),e.push(""),e.push(t.keywords.map(i=>`\`${i}\``).join("  ")),e.push("")),e.join(`
`)}function kg(t){return t.includes("youtube.com/watch")||t.includes("youtu.be/")}async function L9(t,e,n){const r=kg(t.transcript_or_url),s=t.analysis_model??_s.MODEL,i=t.refiner_model??Ll.MODEL_REFINER,a=wd(s,e),o=t.target_language??"auto",c=r?[Xk(t)]:[],l=Wo.buildAnalysisPrompt(o),u=r?`Analyze the video at this URL:

${t.transcript_or_url}`:`Analyze this transcript:

${t.transcript_or_url}`,h=await kk({model:a,tools:c,systemPrompt:l,responseFormat:sk(xg),middleware:r?[$9(e,i)]:[]}).invoke({messages:[new ht(u)]});if(!h.structuredResponse)throw new Error("Agent did not return structured response");const f=h.structuredResponse,m=Yk(f);return{analysis:f,quality:null,iteration_count:1,quality_score:0,summary_text:m}}async function j9(t,e,n){if(t.fast_mode)return L9(t,e);const r=M9();let s=t.transcript_or_url;if(kg(s)&&(s=await Xk(t).invoke({youtube_url:t.transcript_or_url}),s.startsWith("Error")))throw new Error(s);const i={transcript:s,analysis_model:t.analysis_model??_s.MODEL,quality_model:t.quality_model??_s.QUALITY_MODEL,target_language:t.target_language??"auto",analysis:null,quality:null,iteration_count:0,is_complete:!1,apiKey:e,progressCallback:n},a=await r.invoke(i),o=a.quality?Tc(a.quality):0,c=Yk(a.analysis);return{analysis:a.analysis,quality:a.quality,iteration_count:a.iteration_count,quality_score:o,summary_text:c}}async function D9(t,e,n,r){if(r)return null;const s=await rI(t);return(s==null?void 0:s.modelUsed)===e&&s.targetLanguage===n?s:null}async function U9(t,e){const n=await Mw(t);chrome.runtime.sendMessage({action:ss.SUMMARY_GENERATED,videoId:t,summary:{analysis:e.analysis,quality:e.quality},videoInfo:n,transcript:null}),console.log(`Returned stored analysis for video: ${t}`)}async function F9(t,e,n){var i;if(e)return console.log(`Using provided transcript for summary of ${t}`),e;const r=n.get(t);if(r!=null&&r.data.transcript_only_text)return console.log(`Using cached transcript for summary of ${t}`),r.data.transcript_only_text;if((i=r==null?void 0:r.data.transcript)!=null&&i.length)return console.log(`Using cached transcript segments for summary of ${t}`),r.data.transcript.map(a=>a.text).join(" ");const s=await sI(t);return s!=null&&s.length?(console.log(`Using stored subtitles for summary of ${t}`),s.map(a=>a.text).join(" ")):(console.log(`No cached transcript for ${t}, will use URL.`),`https://www.youtube.com/watch?v=${t}`)}async function B9(t,e,n,r,s){const i=await Mw(t);if(i)return console.log(`Using stored video info for ${t}`),i;const a=e.get(t);if(a){const c=n(a.data,t);return console.log(`Using cached video info for ${t}`),c}console.log(`No stored/cached video info for ${t}, fetching...`);const o=await r(t,s);if(o){const c=n(o,t);return await Lw(t,c),c}return{url:`https://www.youtube.com/watch?v=${t}`,title:null,thumbnail:null,author:null,duration:null,upload_date:null,view_count:null,like_count:null}}async function z9(t,e,n,r,s,i){await iI(t,e.analysis,s,i,e.quality),chrome.runtime.sendMessage({action:ss.SUMMARY_GENERATED,videoId:t,summary:e,videoInfo:n,transcript:r.startsWith("http")?null:r}),console.log(`Summarization workflow completed for video: ${t}`)}function Z9(t){return t.scrapeCreatorsApiKey?t.openRouterApiKey!==void 0&&!t.openRouterApiKey?{valid:!1,error:yo.OPENROUTER_KEY_MISSING}:{valid:!0}:{valid:!1,error:yo.SCRAPE_KEY_MISSING}}chrome.sidePanel.setPanelBehavior({openPanelOnActionClick:!0}).catch(console.error);const Ho=new Map,Mh=new Map;function Qk(t,e){var n;return{url:t.url||`https://www.youtube.com/watch?v=${e}`,title:t.title||null,thumbnail:t.thumbnail||null,author:((n=t.channel)==null?void 0:n.title)||null,duration:t.durationFormatted||null,upload_date:t.publishDate||null,view_count:t.viewCountInt??null,like_count:t.likeCountInt??null}}async function Ig(t,e,n=2){const r=Ho.get(t);if(r&&Date.now()-r.timestamp<bd.TRANSCRIPT_CACHE_TTL_MS)return console.log("Returning cached transcript for videoId:",t),r.data;if(Mh.has(t))return console.log("Waiting for existing transcript fetch for videoId:",t),Mh.get(t);const s=`https://www.youtube.com/watch?v=${t}`,i=new URL(Pw.SCRAPE_CREATORS);if(i.searchParams.set("url",s),i.searchParams.set("get_transcript","true"),!e||e.trim()==="")return console.error("API key is missing or empty"),null;const a=(async()=>{for(let o=0;o<=n;o++){o>0?(console.log(`Retry attempt ${o} for videoId: ${t}`),await new Promise(u=>setTimeout(u,bd.RETRY_BACKOFF_MULTIPLIER_MS*o))):console.log("Fetching transcript for video:",t);const c=new AbortController,l=setTimeout(()=>c.abort(),bd.SCRAPE_API_TIMEOUT_MS);try{const u=await fetch(i.toString(),{method:"GET",headers:{"x-api-key":e,Accept:"application/json"},cache:"no-store",signal:c.signal});if(clearTimeout(l),!u.ok){const h=await u.text();console.error(`API error response (attempt ${o+1}):`,h);const f=new Error(`Scrape API error: ${u.status} - ${h}`);if(u.status===401||u.status===403||o===n)return null;continue}const d=await u.json();return console.log("Transcript fetched successfully"),Ho.set(t,{data:d,timestamp:Date.now()}),d}catch(u){clearTimeout(l);const d=u instanceof Error?u:new Error(String(u));if(d.name==="AbortError"?console.error(`Fetch transcript timeout after 30s (attempt ${o+1})`):console.error(`Fetch transcript error (attempt ${o+1}):`,d.message),o===n)return null}}return null})();return Mh.set(t,a),a}async function V9(t,e,n){var c;const{videoId:r,scrapeCreatorsApiKey:s}=t;if(!s){n({status:"error",message:yo.SCRAPE_KEY_MISSING});return}console.log(`Scraping video data for ${r}...`);const i=await Ig(r,s);if(!i){n({status:"error",message:"Failed to fetch video data"});return}const a=Qk(i,r);await Lw(r,a);const o=i.transcript_only_text||((c=i.transcript)==null?void 0:c.map(l=>l.text).join(" "))||null;console.log(`Video data scraped and saved for ${r}`),n({status:"success",videoInfo:a,hasTranscript:!!o&&o.length>0}),chrome.runtime.sendMessage({action:ss.SCRAPE_VIDEO_COMPLETED,videoId:r,videoInfo:a,transcript:o})}async function G9(t,e,n){const{videoId:r,scrapeCreatorsApiKey:s,openRouterApiKey:i,modelSelection:a,forceRegenerate:o}=t;if(!s){n({status:"error",message:yo.SCRAPE_KEY_MISSING});return}if(!i){n({status:"error",message:yo.OPENROUTER_KEY_MISSING});return}n({status:"processing"}),(async()=>{var d;o&&Ho.delete(r);const c=await Ig(r,s);if(!((d=c==null?void 0:c.transcript)!=null&&d.length)){console.error("Refinement error: No transcript available");return}const l=c.transcript.map(h=>({text:h.text,startTime:h.startMs,endTime:h.endMs}));console.log(`Starting refinement for video: ${r}`);const u=await UU(l,c.title,c.description,i,void 0,a);e&&chrome.tabs.sendMessage(e,{action:ss.SUBTITLES_GENERATED,videoId:r,subtitles:u}),console.log(`Refinement completed for video: ${r}`)})().catch(c=>console.error("Refinement error:",c))}async function W9(t,e,n){const{videoId:r,transcript:s,scrapeCreatorsApiKey:i,openRouterApiKey:a,modelSelection:o,qualityModel:c,refinerModel:l,targetLanguage:u,fastMode:d,forceRegenerate:h}=t,f=Z9({scrapeCreatorsApiKey:i,openRouterApiKey:a});if(!f.valid){n({status:"error",message:f.error});return}n({status:"processing"});const m=await D9(r,o,u,h);if(m){await U9(r,m);return}const g=await F9(r,s,Ho),w=await B9(r,Ho,Qk,Ig,i);console.log(`Input ready for summary (type: ${g.startsWith("http")?"URL":"Transcript"}). Starting workflow...`);const b=await j9({transcript_or_url:g,videoId:r,scrapeCreatorsApiKey:i,analysis_model:o,quality_model:c||o,refiner_model:l,target_language:u,fast_mode:d},a);await z9(r,b,w,g,o,u)}chrome.runtime.onMessage.addListener((t,e,n)=>{var s;const r=(s=e.tab)==null?void 0:s.id;switch(t.action){case ss.SCRAPE_VIDEO:return V9(t,r,n).catch(i=>{console.error("Scrape video error:",i),n({status:"error",message:String(i)})}),!0;case ss.FETCH_SUBTITLES:return G9(t,r,n),!0;case ss.GENERATE_SUMMARY:return W9(t,r,n).catch(i=>{console.error("Summary error:",i),chrome.runtime.sendMessage({action:ss.SHOW_ERROR,error:String(i)})}),!0;case ss.GET_VIDEO_TITLE:return n({status:"error",message:"Use content script for title"}),!1;default:return!1}});
//# sourceMappingURL=background.js.map
